version: '3.8'

services:
  app:
    # Framework image from GitHub Container Registry
    # Change VERSION in .env to pin to specific version
    image: ghcr.io/an0naman/template:${VERSION:-latest}
    
    # Unique container name for this instance
    container_name: ${APP_NAME:-myapp}
    
    # Watchtower label - enables automatic updates
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    
    # Restart policy
    restart: always
    
    # Network mode - using bridge for CasaOS compatibility
    # Uncomment 'network_mode: host' below if you need full Bluetooth support
    # network_mode: host
    
    # Ports - mapped to allow external access (CasaOS compatible)
    # Comment out if using 'network_mode: host'
    ports:
      - "${PORT:-5001}:${PORT:-5001}"
    
    # Bluetooth device access (for Niimbot printers)
    # Remove if you don't need Bluetooth
    devices:
      - /dev/bus/usb:/dev/bus/usb
    
    # Capabilities for Bluetooth
    # Remove if you don't need Bluetooth
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - NET_RAW
    
    # Privileged mode for full Bluetooth access
    # Set to false if you don't need Bluetooth
    privileged: true
    
    # Volume mounts
    volumes:
      # App data (database)
      - ./data:/app/data
      
      # Uploaded files (logos, attachments, etc.)
      - ./uploads:/app/uploads
      
      # D-Bus for Bluetooth (remove if not needed)
      - /var/run/dbus:/var/run/dbus
      - /run/dbus:/run/dbus
      - /sys/class/bluetooth:/sys/class/bluetooth
    
    # Environment variables
    environment:
      # Flask configuration
      - FLASK_APP=run.py
      - PORT=${PORT:-5001}
      - DEBUG=${DEBUG:-false}
      
      # Network configuration for device discovery
      - NETWORK_RANGE=${NETWORK_RANGE:-192.168.1.0/24}
      
      # D-Bus for Bluetooth
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
      
      # Python configuration
      - PYTHONUNBUFFERED=1
      
      # Optional: AI features
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      
      # Optional: Notifications
      - NTFY_SERVER_URL=${NTFY_SERVER_URL:-https://ntfy.sh}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      - NTFY_AUTH_TOKEN=${NTFY_AUTH_TOKEN:-}
      
      # Optional: Security
      - SECRET_KEY=${SECRET_KEY:-change-this-in-production}
    
    # DNS servers (Google Public DNS + Cloudflare)
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    
    # DNS options to prevent IPv6 timeout issues
    dns_opt:
      - single-request
      - timeout:2
      - attempts:3
    
    # Prefer IPv4 for DNS resolution (fixes Google API connectivity issues)
    sysctls:
      net.ipv6.conf.all.disable_ipv6: "1"
      net.ipv6.conf.default.disable_ipv6: "1"
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:${PORT:-5001}/api/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    
    # Resource limits (optional, adjust as needed)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2.0'
    #       memory: 2G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

  # Watchtower - Automatic updates when new framework versions are released
  watchtower:
    image: containrrr/watchtower
    container_name: ${APP_NAME:-myapp}-watchtower
    restart: always
    
    volumes:
      # Docker socket for managing containers
      - /var/run/docker.sock:/var/run/docker.sock
    
    environment:
      # Check for updates every 5 minutes (300 seconds)
      - WATCHTOWER_POLL_INTERVAL=${WATCHTOWER_POLL_INTERVAL:-300}
      
      # Remove old images after updating
      - WATCHTOWER_CLEANUP=true
      
      # Only update running containers
      - WATCHTOWER_INCLUDE_STOPPED=false
      
      # Only update containers with the watchtower label
      - WATCHTOWER_LABEL_ENABLE=true
      
      # Optional: Send notifications on updates
      - WATCHTOWER_NOTIFICATIONS=${WATCHTOWER_NOTIFICATIONS:-}
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
      
      # Timezone for logs
      - TZ=${TZ:-UTC}
    
    # Only monitor containers with the watchtower label
    command: --label-enable

# Optional: Named volume for data persistence
# volumes:
#   app_data:
#     driver: local

# CasaOS metadata configuration
x-casaos:
  author: self
  category: self
  hostname: ''
  icon: http://homeserver.taile4ced3.ts.net:${PORT:-5001}/api/logo
  index: /
  is_uncontrolled: false
  port_map: '${PORT:-5001}'
  scheme: http
  title:
    custom: ${APP_NAME:-MyApp}
