name: development-environment

services:
  development-environment:
    build:
      context: .
      dockerfile: Dockerfile
    image: template:local
    container_name: development-environment
    restart: always
    network_mode: host
    
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    
    # Bluetooth support for Niimbot printers
    devices:
      - /dev/bus/usb:/dev/bus/usb
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - NET_RAW
    privileged: true
    
    volumes:
      - ./app:/app/app # Mount source code for live updates
      - ./data:/app/data  # Bind mount to use the same data directory
      - ./uploads:/app/uploads  # Persist uploaded files (logos, attachments, etc.)
      - /var/run/dbus:/var/run/dbus
      - /run/dbus:/run/dbus
      - /sys/class/bluetooth:/sys/class/bluetooth
    
    environment:
      - FLASK_APP=run.py
      - PORT=5001
      - NETWORK_RANGE=192.168.68.0/24
      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
      - PYTHONUNBUFFERED=1
      # - GEMINI_API_KEY=${GEMINI_API_KEY}
    
    # DNS servers to fix Google API connectivity issues
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1

    x-casaos:
      envs:
        - container: FLASK_APP
          description:
            en_us: Flask application entry point
        - container: NETWORK_RANGE
          description:
            en_us: Network range for ESP32 device discovery (e.g., 192.168.1.0/24)
        - container: GEMINI_API_KEY
          description:
            en_us: Google Gemini API key for AI features (get from https://makersuite.google.com/app/apikey)
      ports:
        - container: "5001"
          description:
            en_us: Web interface port for project management
      volumes:
        - container: /app/data
          description:
            en_us: Application data directory containing SQLite database and files
        - container: /app/uploads
          description:
            en_us: Uploaded files directory for logos, note attachments and images

  # Watchtower - Automatic container updates
  watchtower:
    image: containrrr/watchtower
    container_name: development-environment-watchtower
    restart: always
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    
    environment:
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_LABEL_ENABLE=true
      - TZ=UTC
    
    command: --label-enable

x-casaos:
  architectures:
    - amd64
    - arm64
  main: development-environment
  author: an0naman
  category: Productivity
  description:
    en_us: "Project management and tracking application with entry management, sensor data monitoring, label printing, and push notifications. Built with Flask and SQLite."
  developer: an0naman
  icon: http://homeserver.taile4ced3.ts.net:5001/api/logo
  tagline:
    en_us: "Complete project management solution"
  title:
    en_us: "Development Environment"
  index: /
  port_map: "5001"

volumes:
  template_db_data:
    driver: local