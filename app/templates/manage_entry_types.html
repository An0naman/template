<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - Manage Entry Types</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}"?">
    <link rel="stylesheet" href="{{ url_for('static', filename='ribbon.css') }}">
    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .container {
            margin-top: 30px;
            background-color: var(--bs-body-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid var(--bs-border-color);
        }
        .content-section {
            position: relative;
            overflow: hidden;
            background: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }
        .content-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
        }
        .form-control, .form-select {
            margin-bottom: 15px;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .action-buttons button {
            margin-right: 5px;
        }
        .btn-blue {
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
            border: none;
            color: white;
        }
        .btn-blue:hover {
            background: linear-gradient(135deg, #0a58ca, #5a359a);
            color: white;
        }
        .bg-blue {
            background-color: #0d6efd !important;
        }
        .text-blue {
            color: #0d6efd !important;
        }
        .table-container {
            background: var(--bs-body-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--bs-border-color);
        }
        .table thead th {
            background: var(--bs-secondary-bg);
            border-bottom: 2px solid var(--bs-primary);
            color: var(--bs-body-color);
            font-weight: 600;
            letter-spacing: 0.3px;
            font-size: 0.9rem;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .status-icon {
            font-size: 1.1em;
        }
        .btn-spacing {
            margin-left: 1rem;
        }
        .sensor-type-checkbox {
            margin-right: 15px;
            margin-bottom: 8px;
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                padding: 20px;
            }
            .modal-dialog {
                margin: 0.5rem;
            }
            .modal-body {
                padding: 1rem;
            }
            .header-actions {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            /* Fix checkbox cascading on mobile */
            .sensor-type-checkbox {
                display: block !important; /* Override form-check-inline */
                width: 100% !important;
                margin-right: 0 !important;
                margin-bottom: 12px;
                padding: 12px;
                background: var(--bs-secondary-bg);
                border-radius: 8px;
                border: 1px solid var(--bs-border-color);
                min-height: 45px; /* Ensure minimum height */
                box-sizing: border-box;
                display: flex !important;
                align-items: center; /* Vertically center content */
            }
            .sensor-type-checkbox .form-check-input {
                margin-right: 12px;
                margin-top: 0; /* Reset margin for flex alignment */
                transform: scale(1.2);
                flex-shrink: 0; /* Prevent checkbox from shrinking */
            }
            .sensor-type-checkbox .form-check-label {
                font-size: 1rem;
                line-height: 1.4;
                cursor: pointer;
                margin: 0; /* Reset margins for flex alignment */
                flex: 1; /* Take remaining space */
                display: flex;
                align-items: center; /* Vertically center text */
            }
            /* Container for sensor types to prevent cascading */
            #sensorTypesContainer {
                max-height: 300px;
                overflow-y: auto;
                padding: 8px;
            }
            /* Note type checkboxes mobile styling */
            .form-check:has(.note-type-checkbox) {
                display: flex !important; /* Use flex for better alignment */
                align-items: center !important; /* Vertically center content */
                width: 100% !important;
                margin-bottom: 12px;
                padding: 12px;
                background: var(--bs-secondary-bg);
                border-radius: 8px;
                border: 1px solid var(--bs-border-color);
                min-height: 45px; /* Ensure minimum height */
                box-sizing: border-box;
            }
            .note-type-checkbox {
                margin-right: 12px;
                margin-top: 0; /* Reset margin for flex alignment */
                transform: scale(1.2);
                flex-shrink: 0; /* Prevent checkbox from shrinking */
            }
            .form-check:has(.note-type-checkbox) .form-check-label {
                font-size: 1rem;
                line-height: 1.4;
                cursor: pointer;
                margin: 0; /* Reset margins for flex alignment */
                flex: 1; /* Take remaining space */
                display: flex;
                align-items: center; /* Vertically center text */
            }
            /* Container for note types to prevent cascading */
            #noteTypesCheckboxes {
                max-height: 300px;
                overflow-y: auto;
                padding: 8px;
            }
            .note-type-checkbox {
                margin-right: 8px;
                transform: scale(1.1);
            }
            .form-check:has(.note-type-checkbox) .form-check-label {
                padding-left: 4px;
                font-size: 0.9rem;
                line-height: 1.4;
            }
            /* Improve form control spacing on mobile */
            .form-control, .form-select {
                margin-bottom: 12px;
                padding: 0.75rem;
            }
            .form-check {
                margin-bottom: 1rem;
                padding: 0.5rem;
            }
            /* Make form sections more spaced on mobile */
            .modal-body .mb-4 {
                margin-bottom: 1.5rem !important;
            }
            .modal-body .mb-3 {
                margin-bottom: 1.25rem !important;
            }
            /* Better button spacing */
            .modal-body .btn {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
            .btn-spacing {
                margin-left: 0;
                margin-top: 0.5rem;
            }
            .table-container {
                font-size: 0.875rem;
            }
            .table th, .table td {
                padding: 0.5rem 0.25rem;
            }
            .action-buttons .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            /* Hide columns 2, 3, 4, 5 on mobile */
            .table th:nth-child(2),
            .table td:nth-child(2),
            .table th:nth-child(3),
            .table td:nth-child(3),
            .table th:nth-child(4),
            .table td:nth-child(4),
            .table th:nth-child(5),
            .table td:nth-child(5) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Universal App Ribbon -->
    {% include 'components/ribbon.html' %}
    
    <div class="container">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1 class="mb-0">{{ project_name }} {{ entry_plural_label }} Types</h1>
            </div>
            <div class="header-actions d-flex align-items-center"><button id="showAddEntryTypeModalBtn" class="btn btn-blue btn-spacing">
                    <i class="fas fa-plus me-1"></i>Add Type
                </button>
            </div>
        </div>

        <div class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-primary">
                    <i class="fas fa-tags me-2"></i>Entry Types
                </h5>
            </div>

            <div class="table-container">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Singular Label</th>
                            <th>Plural Label</th>
                            <th>Description</th>
                            <th>Note Types</th>
                            <th class="text-center">Primary</th>
                            <th class="text-center">Labels</th>
                            <th class="text-center">End Dates</th>
                            {% if get_system_parameters().get('enable_sensors', '1') == '1' %}
                            <th class="text-center">Sensors</th>
                            {% endif %}
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="entryTypesTableBody">
                        {% if entry_types %}
                            {% for type in entry_types %}
                                <tr data-id="{{ type.id }}">
                                    <td><strong>{{ type.name }}</strong></td>
                                    <td>{{ type.singular_label }}</td>
                                    <td>{{ type.plural_label }}</td>
                                    <td>{{ type.description | truncate(50) }}</td>
                                    <td><span class="badge bg-light text-dark">{{ type.note_types | truncate(30) }}</span></td>
                                    <td class="text-center">
                                        {% if type.is_primary %}
                                            <i class="fas fa-star status-icon text-warning" title="Primary Type"></i>
                                        {% else %}
                                            <i class="far fa-star status-icon text-muted" title="Not Primary"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if type.show_labels_section %}
                                            <i class="fas fa-check-circle status-icon text-blue" title="Shows Labels Section"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle status-icon text-muted" title="No Labels Section"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if type.show_end_dates %}
                                            <i class="fas fa-check-circle status-icon text-blue" title="Shows End Date Fields"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle status-icon text-muted" title="No End Date Fields"></i>
                                        {% endif %}
                                    </td>
                                    {% if get_system_parameters().get('enable_sensors', '1') == '1' %}
                                    <td class="text-center">
                                        {% if type.has_sensors %}
                                            <i class="fas fa-thermometer-half status-icon text-success" title="Sensors Enabled"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle status-icon text-muted" title="No Sensors"></i>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    <td class="action-buttons text-center">
                                        <button class="btn btn-sm btn-outline-info manage-states-btn"
                                                data-id="{{ type.id }}"
                                                data-name="{{ type.name }}"
                                                title="Manage States">
                                            <i class="fas fa-list-check"></i>
                                        </button>
                                        <a href="{{ url_for('main.entry_layout_builder', entry_type_id=type.id) }}" 
                                           class="btn btn-sm btn-outline-success ms-1"
                                           title="Configure Layout">
                                            <i class="fas fa-th-large"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-primary edit-entry-type-btn ms-1"
                                                data-id="{{ type.id }}"
                                                data-name="{{ type.name }}"
                                                data-singular="{{ type.singular_label }}"
                                                data-plural="{{ type.plural_label }}"
                                                data-description="{{ type.description }}"
                                                data-note-types="{{ type.note_types }}"
                                                data-is-primary="{{ type.is_primary }}"
                                                data-show-labels-section="{{ type.show_labels_section | default(0, true) }}"
                                                data-show-end-dates="{{ type.show_end_dates | default(0, true) }}"
                                                data-has-sensors="{{ type.has_sensors | default(0, true) }}"
                                                data-enabled-sensor-types="{{ type.enabled_sensor_types | default('', true) }}"
                                                data-custom-chat-prompt="{{ type.custom_chat_prompt | default('', true) }}"
                                                data-diagram-examples='{{ type.diagram_examples | default("[]", true) }}'
                                                title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-entry-type-btn ms-1" 
                                                data-id="{{ type.id }}"
                                                title="Delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block text-muted opacity-50"></i>
                                    No entry types defined yet.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Entry Type Modal -->
    <div class="modal fade" id="entryTypeModal" tabindex="-1" aria-labelledby="entryTypeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryTypeModalLabel">Add/Edit Entry Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="entryTypeForm">
                        <input type="hidden" id="entryTypeId">
                        
                        <!-- Basic Information Section -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle me-2"></i>Basic Information
                            </h6>
                            <div class="mb-3">
                                <label for="name" class="form-label">Internal Name * <small class="text-muted">(auto-generated)</small></label>
                                <input type="text" class="form-control" id="name" required readonly style="background-color: #f8f9fa;"
                                       placeholder="Will be generated from singular label...">
                                <div class="form-text">Automatically generated from singular label (lowercase, no spaces)</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="singularLabel" class="form-label">Singular Label *</label>
                                    <input type="text" class="form-control" id="singularLabel" required 
                                           placeholder="e.g., Fermentation">
                                </div>
                                <div class="col-md-6">
                                    <label for="pluralLabel" class="form-label">Plural Label * <small class="text-muted">(auto-generated)</small></label>
                                    <input type="text" class="form-control" id="pluralLabel" required readonly style="background-color: #f8f9fa;"
                                           placeholder="Will be generated from singular label...">
                                    <div class="form-text">Automatically generated by adding 's' or appropriate plural form</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" rows="2" 
                                          placeholder="Brief description of this entry type..."></textarea>
                            </div>
                        </div>

                        <!-- Features Section -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-cogs me-2"></i>Features & Options
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="isPrimary">
                                        <label class="form-check-label" for="isPrimary">
                                            <strong>Primary Entry Type</strong>
                                        </label>
                                        <div class="form-text">Only one entry type can be primary</div>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="showLabelsSection">
                                        <label class="form-check-label" for="showLabelsSection">
                                            <strong>Enable Labels</strong>
                                        </label>
                                        <div class="form-text">Show labels/tags section for entries</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="showEndDates">
                                        <label class="form-check-label" for="showEndDates">
                                            <strong>Enable End Dates</strong>
                                        </label>
                                        <div class="form-text">Show intended & actual end date fields</div>
                                    </div>
                                    {% if get_system_parameters().get('enable_sensors', '1') == '1' %}
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="hasSensors">
                                        <label class="form-check-label" for="hasSensors">
                                            <strong>Enable Sensors</strong>
                                        </label>
                                        <div class="form-text">Allow sensor data collection for entries</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Sensor Types Section -->
                        {% if get_system_parameters().get('enable_sensors', '1') == '1' %}
                        <div class="mb-4" id="sensorTypesSection" style="display: none;">
                            <h6 class="text-success border-bottom pb-2 mb-3">
                                <i class="fas fa-thermometer-half me-2"></i>Sensor Configuration
                            </h6>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">Enabled Sensor Types</label>
                                    <div class="d-flex gap-2">
                                        <div class="input-group input-group-sm" style="width: 200px;">
                                            <input type="text" class="form-control" id="newSensorTypeInput" 
                                                   placeholder="e.g., Temperature" maxlength="50">
                                            <button class="btn btn-outline-success" type="button" id="addSensorTypeBtn" title="Add new sensor type">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="refreshSensorTypesBtn" title="Refresh sensor types">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="sensorTypesContainer" class="border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-spinner fa-spin"></i> Loading sensor types...
                                    </div>
                                </div>
                                <div class="form-text">
                                    Select which sensor types can be used with this entry type.<br>
                                    <small class="text-muted">Add new sensor types using the input field above.</small>
                                </div>
                                <input type="hidden" id="enabledSensorTypes">
                            </div>
                        </div>
                        {% endif %}

                        <!-- Note Types Section -->
                        <div class="mb-4">
                            <h6 class="text-info border-bottom pb-2 mb-3">
                                <i class="fas fa-sticky-note me-2"></i>Default Note Types
                            </h6>
                            <div id="noteTypesContainer">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Select default note types for this entry type</small>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="refreshNoteTypesBtn">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                                <div id="noteTypesCheckboxes" class="border rounded p-3" style="max-height: 120px; overflow-y: auto;">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-spinner fa-spin"></i> Loading note types...
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="noteTypes">
                        </div>

                        <!-- AI Chat Customization Section -->
                        <div class="mb-4">
                            <h6 class="text-warning border-bottom pb-2 mb-3">
                                <i class="fas fa-robot me-2"></i>AI Chat Assistant Customization
                            </h6>
                            <div class="mb-3">
                                <label for="customChatPrompt" class="form-label">
                                    Custom Chat Prompt Instructions
                                    <small class="text-muted">(Optional)</small>
                                </label>
                                <textarea class="form-control font-monospace" id="customChatPrompt" rows="4" 
                                          placeholder="Add custom instructions to focus the AI chat assistant for this entry type (e.g., 'You are a brewing expert. Focus on fermentation science, temperature control, and yeast behavior. Provide specific gravity calculations when relevant.')"></textarea>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    This will be combined with the base chat prompt to customize the AI assistant's behavior for entries of this type.
                                    Use this to add domain expertise, specific terminology, or focus areas relevant to this entry type.
                                </small>
                            </div>
                        </div>

                        <!-- Diagram Examples Section -->
                        <div class="mb-4">
                            <h6 class="text-warning border-bottom pb-2 mb-3">
                                <i class="fas fa-project-diagram me-2"></i>Diagram Examples for AI
                            </h6>
                            <div class="mb-3">
                                <label class="form-label">
                                    Example Entries with Diagrams
                                    <small class="text-muted">(Optional - teach the AI what good diagrams look like)</small>
                                </label>
                                <div id="diagramExamplesList"></div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addDiagramExample()">
                                    <i class="fas fa-plus me-1"></i>Add Example Entry
                                </button>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Reference existing entries that have good example diagrams. The AI will use these as reference patterns.
                                </small>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-blue w-100">
                            <i class="fas fa-save me-2"></i>Save Entry Type
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage States Modal -->
    <div class="modal fade" id="statesModal" tabindex="-1" aria-labelledby="statesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statesModalLabel">Manage States</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" onclick="openAddStateForm()">
                            <i class="fas fa-plus me-2"></i>Add New State
                        </button>
                    </div>

                    <!-- State Form (Hidden by default) -->
                    <div id="stateFormContainer" style="display: none;" class="mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0" id="stateFormTitle">Add New State</h6>
                            </div>
                            <div class="card-body">
                                <form id="stateForm" onsubmit="event.preventDefault(); saveState();">
                                    <input type="hidden" id="stateId">
                                    
                                    <div class="mb-3">
                                        <label for="stateName" class="form-label">State Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="stateName" required 
                                               placeholder="e.g., Primary Ferment, Racked, Consumed">
                                    </div>

                                    <div class="mb-3">
                                        <label for="stateCategory" class="form-label">Category <span class="text-danger">*</span></label>
                                        <select class="form-select" id="stateCategory" required>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                        <small class="text-muted">Active states represent ongoing entries, Inactive states represent completed/archived entries</small>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="stateColor" class="form-label">Display Color</label>
                                            <input type="color" class="form-control form-control-color" id="stateColor" value="#6c757d">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="stateDisplayOrder" class="form-label">Display Order</label>
                                            <input type="number" class="form-control" id="stateDisplayOrder" value="0" min="0">
                                        </div>
                                    </div>

                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="stateIsDefault">
                                        <label class="form-check-label" for="stateIsDefault">
                                            Set as default state for new entries
                                        </label>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>Save State
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelStateForm()">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- States List -->
                    <div id="statesListContainer">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin"></i> Loading states...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const entryTypeModal = new bootstrap.Modal(document.getElementById('entryTypeModal'));
            const entryTypeForm = document.getElementById('entryTypeForm');
            const entryTypeIdInput = document.getElementById('entryTypeId');
            const nameInput = document.getElementById('name');
            const singularLabelInput = document.getElementById('singularLabel');
            const pluralLabelInput = document.getElementById('pluralLabel');
            const descriptionInput = document.getElementById('description');
            const noteTypesInput = document.getElementById('noteTypes');
            const noteTypesCheckboxes = document.getElementById('noteTypesCheckboxes');
            const refreshNoteTypesBtn = document.getElementById('refreshNoteTypesBtn');
            const isPrimaryInput = document.getElementById('isPrimary');
            const showLabelsSectionInput = document.getElementById('showLabelsSection');
            const showEndDatesInput = document.getElementById('showEndDates');
            const hasSensorsInput = document.getElementById('hasSensors');
            const enabledSensorTypesInput = document.getElementById('enabledSensorTypes');
            const sensorTypesContainer = document.getElementById('sensorTypesContainer');
            const sensorTypesSection = document.getElementById('sensorTypesSection');

            let availableNoteTypes = [];
            let availableSensorTypes = [];

            // Function to generate internal name from singular label
            function generateInternalName(singularLabel) {
                return singularLabel
                    .toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '') // Remove special characters
                    .replace(/\s+/g, '_') // Replace spaces with underscores
                    .replace(/_{2,}/g, '_') // Replace multiple underscores with single
                    .replace(/^_+|_+$/g, ''); // Remove leading/trailing underscores
            }

            // Function to generate plural form from singular
            function generatePluralLabel(singularLabel) {
                if (!singularLabel) return '';
                
                const label = singularLabel.trim();
                
                // Common English pluralization rules
                if (label.endsWith('y') && !label.match(/[aeiou]y$/i)) {
                    return label.slice(0, -1) + 'ies';
                } else if (label.endsWith('s') || label.endsWith('x') || label.endsWith('z') || 
                          label.endsWith('ch') || label.endsWith('sh')) {
                    return label + 'es';
                } else if (label.endsWith('f')) {
                    return label.slice(0, -1) + 'ves';
                } else if (label.endsWith('fe')) {
                    return label.slice(0, -2) + 'ves';
                } else {
                    return label + 's';
                }
            }

            // Auto-generation event listener
            singularLabelInput.addEventListener('input', function() {
                const singularValue = this.value.trim();
                nameInput.value = generateInternalName(singularValue);
                pluralLabelInput.value = generatePluralLabel(singularValue);
            });

            // Load available note types from system parameters
            async function loadNoteTypes() {
                try {
                    noteTypesCheckboxes.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading note types...</div>';
                    
                    const response = await fetch('/api/system_params');
                    const params = await response.json();
                    
                    // Default note types
                    const defaultTypes = ['General', 'Info', 'Important', 'Critical', 'Warning', 'Caution', 'Success', 'Completed'];
                    
                    // Custom note types from system parameters
                    let customTypes = [];
                    if (params.custom_note_types) {
                        const customTypesData = JSON.parse(params.custom_note_types);
                        // Handle both old format (array) and new format (object with custom_types array)
                        if (Array.isArray(customTypesData)) {
                            customTypes = customTypesData.map(type => type.name);
                        } else if (customTypesData.custom_types && Array.isArray(customTypesData.custom_types)) {
                            customTypes = customTypesData.custom_types.map(type => type.name);
                        }
                    }
                    
                    // Combine and deduplicate
                    availableNoteTypes = [...new Set([...defaultTypes, ...customTypes])];
                    
                    console.log('Note types loaded:', availableNoteTypes.length, 'types'); // Debug
                    renderNoteTypesCheckboxes();
                    return Promise.resolve(); // Ensure we return a resolved promise
                } catch (error) {
                    console.error('Error loading note types:', error);
                    noteTypesCheckboxes.innerHTML = '<div class="text-danger text-center py-3"><i class="fas fa-exclamation-triangle"></i> Error loading note types</div>';
                    return Promise.reject(error); // Return a rejected promise on error
                }
            }

            // Load available sensor types
            async function loadSensorTypes() {
                try {
                    const response = await fetch('/api/system_params');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const params = await response.json();
                    
                    // Parse sensor types from system parameters (same as manage_sensors)
                    const sensorTypesString = params.sensor_types || '';
                    availableSensorTypes = sensorTypesString.split(',')
                        .map(type => type.trim())
                        .filter(type => type !== '');
                    
                    renderSensorTypesCheckboxes();
                    
                    // Return a promise that resolves when checkboxes are rendered
                    return new Promise(resolve => {
                        // Small delay to ensure DOM is updated
                        setTimeout(resolve, 50);
                    });
                } catch (error) {
                    console.error('Error loading sensor types:', error);
                    sensorTypesContainer.innerHTML = '<div class="text-danger text-center py-3"><i class="fas fa-exclamation-triangle me-1"></i> Error loading sensor types</div>';
                    throw error;
                }
            }

            // Render sensor types as checkboxes
            function renderSensorTypesCheckboxes() {
                if (availableSensorTypes.length === 0) {
                    sensorTypesContainer.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle me-1"></i> No sensor types available yet. <strong>Add some using the input above</strong>, or <a href="/maintenance/manage_sensor_types">manage sensor types here</a>.</div>';
                    return;
                }

                let checkboxesHtml = '';
                availableSensorTypes.forEach((sensorType, index) => {
                    checkboxesHtml += `
                        <div class="form-check form-check-inline sensor-type-checkbox">
                            <input class="form-check-input sensor-type-input" type="checkbox" 
                                   value="${sensorType}" id="sensorType_${index}">
                            <label class="form-check-label" for="sensorType_${index}">
                                ${sensorType}
                            </label>
                        </div>
                    `;
                });

                sensorTypesContainer.innerHTML = checkboxesHtml;
                
                // Add event listeners to update hidden input
                document.querySelectorAll('.sensor-type-input').forEach(checkbox => {
                    checkbox.addEventListener('change', updateSensorTypesHiddenInput);
                });
            }

            // Update the hidden input with selected sensor types
            function updateSensorTypesHiddenInput() {
                const selectedTypes = [];
                document.querySelectorAll('.sensor-type-input:checked').forEach(checkbox => {
                    selectedTypes.push(checkbox.value);
                });
                const joinedTypes = selectedTypes.join(', ');
                enabledSensorTypesInput.value = joinedTypes;
                console.log('Updated sensor types hidden input:', joinedTypes); // Debug log
            }

            // Set selected sensor types from comma-separated string
            function setSelectedSensorTypes(sensorTypesString) {
                console.log('=== SETTING SENSOR TYPES ===');
                console.log('Raw sensor types string:', sensorTypesString);
                console.log('Type of sensor types string:', typeof sensorTypesString);
                
                // Find all sensor type checkboxes
                const checkboxes = document.querySelectorAll('.sensor-type-input');
                console.log(`Found ${checkboxes.length} sensor type checkboxes`);
                
                if (checkboxes.length === 0) {
                    console.warn('No sensor type checkboxes found - they might not be rendered yet');
                    return;
                }
                
                if (!sensorTypesString || sensorTypesString === 'undefined' || sensorTypesString === 'null') {
                    console.log('No sensor types to set - clearing all checkboxes');
                    // Clear all checkboxes if no sensor types
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                        console.log(`Cleared checkbox: ${checkbox.value}`);
                    });
                    updateSensorTypesHiddenInput();
                    return;
                }
                
                const selectedTypes = sensorTypesString.split(',').map(type => type.trim()).filter(type => type.length > 0);
                console.log('Parsed selected types:', selectedTypes);
                console.log('Available checkboxes and their values:');
                
                checkboxes.forEach(checkbox => {
                    const shouldBeChecked = selectedTypes.includes(checkbox.value);
                    checkbox.checked = shouldBeChecked;
                    console.log(`- Checkbox "${checkbox.value}": expected=${shouldBeChecked}, actual=${checkbox.checked}`);
                });
                
                updateSensorTypesHiddenInput();
                console.log('=== FINISHED SETTING SENSOR TYPES ===');
            }

            // Toggle sensor types section visibility
            function toggleSensorTypesSection() {
                // Check if sensor elements exist (they won't if sensors are globally disabled)
                if (!hasSensorsInput || !sensorTypesSection) return;
                
                if (hasSensorsInput.checked) {
                    sensorTypesSection.style.display = 'block';
                    if (availableSensorTypes.length === 0) {
                        loadSensorTypes();
                    } else {
                        // If sensor types are already loaded, just render the checkboxes
                        renderSensorTypesCheckboxes();
                    }
                } else {
                    sensorTypesSection.style.display = 'none';
                    // Clear selections when hiding
                    document.querySelectorAll('.sensor-type-input').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    if (enabledSensorTypesInput) {
                        enabledSensorTypesInput.value = '';
                    }
                }
            }

            // Render note types as checkboxes
            function renderNoteTypesCheckboxes() {
                if (availableNoteTypes.length === 0) {
                    noteTypesCheckboxes.innerHTML = '<div class="text-muted text-center py-3">No note types available. Create some in Notes Configuration.</div>';
                    return;
                }

                let checkboxesHtml = '';
                availableNoteTypes.forEach((noteType, index) => {
                    checkboxesHtml += `
                        <div class="form-check mb-2">
                            <input class="form-check-input note-type-checkbox" type="checkbox" 
                                   value="${noteType}" id="noteType_${index}">
                            <label class="form-check-label" for="noteType_${index}">
                                ${noteType}
                            </label>
                        </div>
                    `;
                });

                noteTypesCheckboxes.innerHTML = checkboxesHtml;
                
                // Add event listeners to update hidden input
                document.querySelectorAll('.note-type-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateNoteTypesHiddenInput);
                });
            }

            // Update the hidden input with selected note types
            function updateNoteTypesHiddenInput() {
                const selectedTypes = [];
                document.querySelectorAll('.note-type-checkbox:checked').forEach(checkbox => {
                    selectedTypes.push(checkbox.value);
                });
                noteTypesInput.value = selectedTypes.join(', ');
            }

            // Set selected note types from comma-separated string
            function setSelectedNoteTypes(noteTypesString) {
                console.log('Setting note types:', noteTypesString); // Debug
                const selectedTypes = noteTypesString ? noteTypesString.split(',').map(type => type.trim()) : [];
                console.log('Parsed note types:', selectedTypes); // Debug
                
                const checkboxes = document.querySelectorAll('.note-type-checkbox');
                console.log('Found note type checkboxes:', checkboxes.length); // Debug
                
                checkboxes.forEach(checkbox => {
                    const isSelected = selectedTypes.includes(checkbox.value);
                    checkbox.checked = isSelected;
                    console.log(`Checkbox ${checkbox.value}: ${isSelected ? 'checked' : 'unchecked'}`); // Debug
                });
                
                updateNoteTypesHiddenInput();
            }

            // Refresh note types button
            refreshNoteTypesBtn.addEventListener('click', loadNoteTypes);

            // Sensor checkbox event listener (only if sensor elements exist)
            if (hasSensorsInput) {
                hasSensorsInput.addEventListener('change', toggleSensorTypesSection);
            }

            // Add sensor type functionality (only if elements exist)
            const addSensorTypeBtn = document.getElementById('addSensorTypeBtn');
            if (addSensorTypeBtn) {
                addSensorTypeBtn.addEventListener('click', async function() {
                const newSensorTypeInput = document.getElementById('newSensorTypeInput');
                const newSensorType = newSensorTypeInput.value.trim();
                
                if (!newSensorType) {
                    alert('Please enter a sensor type name');
                    return;
                }
                
                try {
                    // Get current system parameters
                    const response = await fetch('/api/system_params');
                    const params = await response.json();
                    
                    // Get existing sensor types
                    const existingSensorTypes = params.sensor_types ? 
                        params.sensor_types.split(',').map(type => type.trim()).filter(type => type !== '') : [];
                    
                    // Check if sensor type already exists
                    if (existingSensorTypes.includes(newSensorType)) {
                        alert(`Sensor type "${newSensorType}" already exists`);
                        return;
                    }
                    
                    // Add the new sensor type
                    const updatedSensorTypes = [...existingSensorTypes, newSensorType];
                    const newSensorTypesString = updatedSensorTypes.join(', ');
                    
                    // Update sensor types
                    const updateResponse = await fetch('/api/system_params', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sensor_types: newSensorTypesString
                        })
                    });
                    
                    if (updateResponse.ok) {
                        // Clear the input
                        newSensorTypeInput.value = '';
                        
                        // Reload sensor types to show the new one
                        await loadSensorTypes();
                        
                        // Auto-check the newly added sensor type
                        setTimeout(() => {
                            const newCheckbox = document.querySelector(`input[value="${newSensorType}"]`);
                            if (newCheckbox) {
                                newCheckbox.checked = true;
                                updateSensorTypesHiddenInput();
                            }
                        }, 100);
                        
                        console.log(`Sensor type "${newSensorType}" added successfully`);
                    } else {
                        alert('Failed to add sensor type');
                    }
                } catch (error) {
                    console.error('Error adding sensor type:', error);
                    alert('Error adding sensor type');
                }
                });
            }

            // Allow Enter key to add sensor type (only if elements exist)
            const newSensorTypeInput = document.getElementById('newSensorTypeInput');
            if (newSensorTypeInput && addSensorTypeBtn) {
                newSensorTypeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addSensorTypeBtn.click();
                    }
                });
            }

            // Refresh sensor types button (only if it exists)
            const refreshSensorTypesBtn = document.getElementById('refreshSensorTypesBtn');
            if (refreshSensorTypesBtn) {
                refreshSensorTypesBtn.addEventListener('click', function() {
                    loadSensorTypes();
                });
            }

            // Load note types on page load
            loadNoteTypes();

            // Load sensor types on page load (only if sensors are enabled globally)
            if (sensorTypesContainer) {
                loadSensorTypes().catch(error => {
                    console.warn('Failed to preload sensor types:', error);
                });
            }

            // Show Add Modal
            document.getElementById('showAddEntryTypeModalBtn').addEventListener('click', function() {
                // Reset form for adding new
                entryTypeIdInput.value = '';
                entryTypeForm.reset();
                nameInput.readOnly = true; // Keep readonly for auto-generation
                pluralLabelInput.readOnly = true; // Keep readonly for auto-generation
                nameInput.value = ''; // Clear auto-generated fields
                pluralLabelInput.value = '';
                document.getElementById('entryTypeModalLabel').textContent = 'Add New Entry Type';
                
                // Hide sensor section by default (if it exists)
                if (sensorTypesSection) {
                    sensorTypesSection.style.display = 'none';
                }
                
                // Reset diagram examples
                diagramExamples = [];
                renderDiagramExamples();
                console.log('[Entry Type Add] Reset diagram examples to empty');
                
                // Reset custom chat prompt
                document.getElementById('customChatPrompt').value = '';
                
                // Set default note type selection (General)
                setTimeout(() => {
                    setSelectedNoteTypes('General');
                }, 100);
                
                entryTypeModal.show();
            });

            // Handle Edit Buttons
            document.querySelectorAll('.edit-entry-type-btn').forEach(button => {
                button.addEventListener('click', function() {
                    console.log('=== EDIT ENTRY TYPE DEBUG ===');
                    console.log('All dataset properties:', this.dataset);
                    console.log('Raw data attributes:', {
                        id: this.dataset.id,
                        hasSensors: this.dataset.hasSensors,
                        enabledSensorTypes: this.dataset.enabledSensorTypes,
                        name: this.dataset.name
                    });
                    console.log('enabled_sensor_types vs enabledSensorTypes:', {
                        camelCase: this.dataset.enabledSensorTypes,
                        original: this.getAttribute('data-enabled-sensor-types')
                    });
                    
                    document.getElementById('entryTypeModalLabel').textContent = 'Edit Entry Type';
                    entryTypeIdInput.value = this.dataset.id;
                    nameInput.value = this.dataset.name;
                    singularLabelInput.value = this.dataset.singular;
                    pluralLabelInput.value = this.dataset.plural;
                    descriptionInput.value = this.dataset.description;
                    isPrimaryInput.checked = (this.dataset.isPrimary === '1');
                    showLabelsSectionInput.checked = (this.dataset.showLabelsSection === '1');
                    showEndDatesInput.checked = (this.dataset.showEndDates === '1');
                    
                    // Handle sensor inputs only if they exist (sensors may be globally disabled)
                    if (hasSensorsInput) {
                        hasSensorsInput.checked = (this.dataset.hasSensors === '1');
                        nameInput.readOnly = true; // Name is not editable for existing entries
                        pluralLabelInput.readOnly = false; // Allow editing plural for existing entries
                        
                        console.log('Sensors enabled:', hasSensorsInput.checked);
                        console.log('Available sensor types count:', availableSensorTypes.length);
                        
                        // Handle sensor section visibility and data
                        if (hasSensorsInput.checked && sensorTypesSection) {
                            sensorTypesSection.style.display = 'block';
                            const sensorTypesToSet = this.dataset.enabledSensorTypes || '';
                            console.log('Edit mode - Sensor types to set:', sensorTypesToSet); // Debug
                            
                            // Since sensor types are now preloaded, we just need to ensure checkboxes are rendered
                            if (availableSensorTypes.length > 0) {
                                // Sensor types already loaded, render checkboxes and set selections
                                renderSensorTypesCheckboxes();
                                setTimeout(() => {
                                    console.log('Checkboxes rendered, setting selections...'); // Debug
                                    setSelectedSensorTypes(sensorTypesToSet);
                                }, 100);
                            } else {
                                console.warn('No sensor types available - they may not have loaded yet');
                                // Fallback: try to load sensor types again
                                loadSensorTypes().then(() => {
                                    console.log('Sensor types loaded as fallback, setting selections...'); // Debug
                                    setSelectedSensorTypes(sensorTypesToSet);
                                }).catch(error => {
                                    console.error('Failed to load sensor types as fallback:', error);
                                });
                            }
                        } else if (sensorTypesSection) {
                            sensorTypesSection.style.display = 'none';
                        }
                    }
                    
                    // Set note types selection - ensure note types are loaded first
                    if (availableNoteTypes.length === 0) {
                        // Note types not loaded yet, load them first
                        loadNoteTypes().then(() => {
                            setTimeout(() => {
                                setSelectedNoteTypes(this.dataset.noteTypes);
                            }, 100);
                        });
                    } else {
                        // Note types already loaded
                        setTimeout(() => {
                            setSelectedNoteTypes(this.dataset.noteTypes);
                        }, 100);
                    }
                    
                    // Set custom chat prompt
                    const customChatPrompt = this.dataset.customChatPrompt || '';
                    document.getElementById('customChatPrompt').value = customChatPrompt;
                    console.log('[Entry Type Edit] Loaded custom_chat_prompt:', customChatPrompt);
                    
                    // Load diagram examples
                    try {
                        const examplesData = this.dataset.diagramExamples || '[]';
                        console.log('[Entry Type Edit] Raw diagram_examples from dataset:', examplesData);
                        diagramExamples = JSON.parse(examplesData);
                        console.log('[Entry Type Edit] Parsed diagram examples:', diagramExamples);
                        renderDiagramExamples();
                    } catch (e) {
                        console.error('[Entry Type Edit] Error parsing diagram examples:', e);
                        diagramExamples = [];
                        renderDiagramExamples();
                    }
                    
                    entryTypeModal.show();
                });
            });

            // Handle Form Submission (Add/Edit)
            // Diagram Examples Management
            let diagramExamples = [];
            let availableEntries = [];

            async function loadEntriesWithDiagrams() {
                try {
                    const response = await fetch('/api/entries?has_diagram=1');
                    const entries = await response.json();
                    availableEntries = entries;
                } catch (error) {
                    console.error('Error loading entries with diagrams:', error);
                    availableEntries = [];
                }
            }

            function renderDiagramExamples() {
                const container = document.getElementById('diagramExamplesList');
                if (diagramExamples.length === 0) {
                    container.innerHTML = '<div class="text-muted small"><i class="fas fa-info-circle me-1"></i>No examples added yet</div>';
                    return;
                }
                
                container.innerHTML = diagramExamples.map((example, index) => `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">Example ${index + 1}</h6>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDiagramExample(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small mb-1">Entry ID:</label>
                                <input type="number" class="form-control form-control-sm" value="${example.entry_id || ''}" 
                                       onchange="updateDiagramExample(${index}, 'entry_id', this.value)" 
                                       placeholder="Enter entry ID with diagram">
                                <small class="text-muted">The ID of an entry that has a good example diagram</small>
                            </div>
                            <div>
                                <label class="form-label small mb-1">When to use this pattern:</label>
                                <textarea class="form-control form-control-sm" rows="2" 
                                          onchange="updateDiagramExample(${index}, 'description', this.value)"
                                          placeholder="Describe when this diagram pattern should be used (e.g., 'Use for showing component connections')">${example.description || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            window.addDiagramExample = function() {
                diagramExamples.push({ entry_id: '', description: '' });
                renderDiagramExamples();
            };

            window.removeDiagramExample = function(index) {
                diagramExamples.splice(index, 1);
                renderDiagramExamples();
            };

            window.updateDiagramExample = function(index, field, value) {
                diagramExamples[index][field] = value;
            };

            // Load entries on page load
            loadEntriesWithDiagrams();

            entryTypeForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const id = entryTypeIdInput.value;
                const method = id ? 'PATCH' : 'POST';
                const url = id ? `/api/entry_types/${id}` : '/api/entry_types';

                const data = {
                    name: nameInput.value,
                    singular_label: singularLabelInput.value,
                    plural_label: pluralLabelInput.value,
                    description: descriptionInput.value,
                    note_types: noteTypesInput.value,
                    is_primary: isPrimaryInput.checked ? 1 : 0,
                    show_labels_section: showLabelsSectionInput.checked ? 1 : 0,
                    show_end_dates: showEndDatesInput.checked ? 1 : 0,
                    has_sensors: hasSensorsInput ? (hasSensorsInput.checked ? 1 : 0) : 0,
                    enabled_sensor_types: enabledSensorTypesInput ? enabledSensorTypesInput.value : '',
                    custom_chat_prompt: document.getElementById('customChatPrompt').value.trim(),
                    diagram_examples: JSON.stringify(diagramExamples.filter(ex => ex.entry_id && ex.entry_id.toString().trim() !== ''))
                };

                console.log('[Entry Type Save] Saving data:', {
                    method: method,
                    url: url,
                    custom_chat_prompt_length: data.custom_chat_prompt.length,
                    diagram_examples_raw: diagramExamples,
                    diagram_examples_filtered: diagramExamples.filter(ex => ex.entry_id && ex.entry_id.toString().trim() !== ''),
                    diagram_examples_json: data.diagram_examples
                });

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        entryTypeModal.hide();
                        window.location.reload(); // Reload page to show updated list
                    } else if (data.error) {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                });
            });

            // Handle Delete Buttons
            document.querySelectorAll('.delete-entry-type-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const entryTypeId = this.dataset.id;
                    if (confirm(`Are you sure you want to delete this Entry Type? This will fail if there are any entries or relationship definitions linked to it.`)) {
                        fetch(`/api/entry_types/${entryTypeId}`, {
                            method: 'DELETE',
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                window.location.reload();
                            } else if (data.error) {
                                alert('Error: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An unexpected error occurred during deletion.');
                        });
                    }
                });
            });

            // Handle Manage States Buttons
            document.querySelectorAll('.manage-states-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const entryTypeId = this.dataset.id;
                    const entryTypeName = this.dataset.name;
                    openStatesModal(entryTypeId, entryTypeName);
                });
            });
        });

        // States Management Functions
        let currentEntryTypeId = null;
        let currentStates = [];

        function openStatesModal(entryTypeId, entryTypeName) {
            currentEntryTypeId = entryTypeId;
            document.getElementById('statesModalLabel').textContent = `Manage States for ${entryTypeName}`;
            loadStates(entryTypeId);
            const statesModal = new bootstrap.Modal(document.getElementById('statesModal'));
            statesModal.show();
        }

        function loadStates(entryTypeId) {
            fetch(`/api/entry_types/${entryTypeId}/states`)
                .then(response => response.json())
                .then(states => {
                    currentStates = states;
                    renderStates(states);
                })
                .catch(error => {
                    console.error('Error loading states:', error);
                    alert('Error loading states.');
                });
        }

        function renderStates(states) {
            const container = document.getElementById('statesListContainer');
            if (states.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">No states defined yet.</p>';
                return;
            }

            let html = '<div class="list-group">';
            states.forEach(state => {
                const categoryBadge = state.category === 'active' 
                    ? '<span class="badge bg-success">Active</span>' 
                    : '<span class="badge bg-secondary">Inactive</span>';
                const defaultBadge = state.is_default 
                    ? '<span class="badge bg-primary ms-1">Default</span>' 
                    : '';
                
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="color-preview" style="background-color: ${state.color}; width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ddd;"></div>
                            <div>
                                <strong>${state.name}</strong>
                                <div class="small">
                                    ${categoryBadge}
                                    ${defaultBadge}
                                </div>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editState(${state.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteState(${state.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function openAddStateForm() {
            document.getElementById('stateFormTitle').textContent = 'Add New State';
            document.getElementById('stateForm').reset();
            document.getElementById('stateId').value = '';
            document.getElementById('stateFormContainer').style.display = 'block';
        }

        function editState(stateId) {
            const state = currentStates.find(s => s.id === stateId);
            if (!state) return;

            document.getElementById('stateFormTitle').textContent = 'Edit State';
            document.getElementById('stateId').value = state.id;
            document.getElementById('stateName').value = state.name;
            document.getElementById('stateCategory').value = state.category;
            document.getElementById('stateColor').value = state.color;
            document.getElementById('stateDisplayOrder').value = state.display_order;
            document.getElementById('stateIsDefault').checked = state.is_default;
            document.getElementById('stateFormContainer').style.display = 'block';
        }

        function cancelStateForm() {
            document.getElementById('stateFormContainer').style.display = 'none';
            document.getElementById('stateForm').reset();
        }

        function saveState() {
            const stateId = document.getElementById('stateId').value;
            const name = document.getElementById('stateName').value.trim();
            const category = document.getElementById('stateCategory').value;
            const color = document.getElementById('stateColor').value;
            const displayOrder = document.getElementById('stateDisplayOrder').value;
            const isDefault = document.getElementById('stateIsDefault').checked;

            if (!name || !category) {
                alert('Name and category are required.');
                return;
            }

            const data = {
                name: name,
                category: category,
                color: color,
                display_order: parseInt(displayOrder),
                is_default: isDefault
            };

            const url = stateId 
                ? `/api/entry_types/${currentEntryTypeId}/states/${stateId}`
                : `/api/entry_types/${currentEntryTypeId}/states`;
            const method = stateId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message || data.state_id) {
                    cancelStateForm();
                    loadStates(currentEntryTypeId);
                } else if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred.');
            });
        }

        function deleteState(stateId) {
            if (!confirm('Are you sure you want to delete this state?')) {
                return;
            }

            fetch(`/api/entry_types/${currentEntryTypeId}/states/${stateId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    loadStates(currentEntryTypeId);
                } else if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred.');
            });
        }
    </script>

    <!-- About Modal -->
    {% include 'components/about_modal.html' %}
</body>
</html>
