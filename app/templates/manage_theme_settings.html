<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - System Theme</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ribbon.css') }}">
    
    <!-- Dynamic Theme CSS -->
    <style id="theme-styles">
        {{ theme_css|safe }}
    </style>
    
    <style>
        :root {
            --content-spacing: 1.5rem;
            --border-radius: 0.75rem;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --transition-base: all 0.2s ease;
        }

        body {
            background-color: var(--theme-bg-body, var(--bs-body-bg));
            color: var(--theme-text, var(--bs-body-color));
            font-family: var(--bs-font-sans-serif);
            line-height: 1.6;
        }

        .main-container {
            margin: 2rem 0;
        }

        .settings-container {
            background-color: var(--theme-bg-card, var(--bs-body-bg));
            color: var(--theme-text, var(--bs-body-color));
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: var(--content-spacing);
            margin-bottom: 2rem;
        }

        .settings-section {
            background: var(--theme-bg-surface, var(--bs-secondary-bg));
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            padding: var(--content-spacing);
            margin-bottom: var(--content-spacing);
            box-shadow: var(--shadow-sm);
            transition: var(--transition-base);
        }

        .settings-section:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .preview-container {
            background: var(--theme-bg-card, var(--bs-body-bg));
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            padding: var(--content-spacing);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 2rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .theme-section {
            background: var(--section-bg, var(--theme-bg-surface, var(--bs-secondary-bg)));
            border: var(--section-border, 1px solid var(--theme-border, var(--bs-border-color)));
            border-radius: var(--section-border-radius, var(--border-radius));
            border-image: var(--section-border-image, none);
            padding: var(--section-padding, var(--content-spacing));
            margin-bottom: var(--section-margin-bottom, var(--content-spacing));
            box-shadow: var(--section-shadow, var(--shadow-sm));
            border-left: 4px solid var(--theme-primary, var(--bs-primary));
            transition: var(--transition-base);
            position: relative;
        }

        .theme-section:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .section-header {
            border-bottom: 1px solid var(--theme-border, var(--bs-border-color));
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            color: var(--theme-text, var(--bs-body-color));
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: var(--theme-primary, var(--bs-primary));
        }

        .section-content {
            padding: 0;
        }

        /* Form controls with proper theming */
        .form-control, .form-select {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            border-color: var(--theme-border, var(--bs-border-color)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            border-color: var(--theme-primary, var(--bs-primary)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
            box-shadow: 0 0 0 0.25rem rgba(var(--theme-primary-rgb, 13, 110, 253), 0.25) !important;
        }

        /* Theme selection cards */
        .theme-card {
            border: 2px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition-base);
            background: var(--theme-bg-card, var(--bs-body-bg));
            height: 100%;
        }

        .theme-card:hover {
            border-color: var(--theme-primary, var(--bs-primary));
            box-shadow: 0 2px 8px rgba(var(--theme-primary-rgb, 13, 110, 253), 0.15);
        }

        .theme-card.selected {
            border-color: var(--theme-primary, var(--bs-primary));
            background: rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1);
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid var(--theme-border, var(--bs-border-color));
            display: inline-block;
            margin-right: 0.5rem;
        }

        /* Toggle switch styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--theme-border, #ccc);
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--theme-bg-card, white);
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--theme-primary, var(--bs-primary));
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Action buttons */
        .btn-theme-primary {
            background: linear-gradient(135deg, var(--theme-primary, #6f42c1), var(--theme-danger, #d63384));
            border: none;
            color: white;
        }

        .btn-theme-primary:hover {
            background: linear-gradient(135deg, var(--theme-primary-hover, #5a3399), var(--theme-danger, #b02a5a));
            color: white;
        }

        /* Responsive layout */
        @media (max-width: 768px) {
            .preview-container {
                position: static;
                max-height: none;
                margin-top: 2rem;
            }
        }

        /* Preview section effects */
        .effect-glow {
            box-shadow: 0 0 20px rgba(var(--theme-primary-rgb, 13, 110, 253), 0.3);
        }

        .effect-gradient {
            background: linear-gradient(135deg, 
                var(--theme-bg-surface, var(--bs-secondary-bg)) 0%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.05) 100%);
        }

        .pattern-diagonal-lines {
            background-image: linear-gradient(45deg, 
                transparent 0%, 
                transparent 35%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 35%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 65%, 
                transparent 65%);
            background-size: 20px 20px;
        }

        .pattern-dots {
            background-image: radial-gradient(circle, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.15) 1px, transparent 1px);
            background-size: 15px 15px;
        }

        .pattern-grid {
            background-image: 
                linear-gradient(rgba(var(--theme-border-rgb, 222, 226, 230), 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(var(--theme-border-rgb, 222, 226, 230), 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .pattern-zigzag {
            background-image: linear-gradient(135deg, 
                transparent 0%, 
                transparent 25%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 50%, 
                transparent 50%, 
                transparent 75%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 75%);
            background-size: 25px 25px;
        }

        .pattern-crosshatch {
            background-image: 
                linear-gradient(45deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, transparent 25%);
            background-size: 30px 30px;
        }

        .pattern-waves {
            background-image: 
                radial-gradient(ellipse 50px 20px at 50% 0%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1), transparent),
                radial-gradient(ellipse 50px 20px at 50% 100%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1), transparent);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }

        .pattern-honeycomb {
            background-image: 
                radial-gradient(circle at 10px 10px, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 2px, transparent 2px),
                radial-gradient(circle at 30px 30px, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 2px, transparent 2px);
            background-size: 40px 40px;
        }

        .pattern-checkers {
            background-image: 
                linear-gradient(45deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.08) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.08) 25%, transparent 25%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .pattern-triangles {
            background-image: 
                linear-gradient(60deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 50%, transparent 50%),
                linear-gradient(-60deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 50%, transparent 50%);
            background-size: 30px 26px;
        }

        .pattern-stars {
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.2), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.15), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1), transparent);
            background-size: 100px 100px;
        }

        .pattern-circuit {
            background-image: 
                linear-gradient(90deg, rgba(var(--theme-border-rgb, 222, 226, 230), 0.2) 1px, transparent 1px),
                linear-gradient(rgba(var(--theme-border-rgb, 222, 226, 230), 0.2) 1px, transparent 1px),
                radial-gradient(circle at 20px 20px, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.15) 2px, transparent 2px);
            background-size: 40px 40px, 40px 40px, 40px 40px;
        }

        .pattern-noise {
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.05) 1px, transparent 1px),
                radial-gradient(circle at 75% 25%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.08) 1px, transparent 1px),
                radial-gradient(circle at 25% 75%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.06) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.04) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* FULL EMOJI LIBRARY FOR CORNER DECORATIONS */
        .decoration-leaf::before { content: "ðŸƒ"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-tree::before { content: "ðŸŒ²"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-flower::before { content: "ðŸŒ¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-sun::before { content: "â˜€ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-moon::before { content: "ðŸŒ™"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-star::before { content: "â­"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-diamond::before { content: "ðŸ’Ž"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-shield::before { content: "ðŸ›¡ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-sword::before { content: "âš”ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-gem::before { content: "ðŸ’ "; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-gear::before { content: "âš™ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-lightning::before { content: "âš¡"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-circuit::before { content: "ðŸ”Œ"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-code::before { content: "ðŸ“‹"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-data::before { content: "ðŸ’¾"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* EXPANDED EMOJI LIBRARY - Nature & Weather */
        .decoration-fire::before { content: "ðŸ”¥"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-rainbow::before { content: "ðŸŒˆ"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-cloud::before { content: "â˜ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-snow::before { content: "â„ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-cactus::before { content: "ðŸŒµ"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-rose::before { content: "ðŸŒ¹"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-mushroom::before { content: "ðŸ„"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Animals */
        .decoration-cat::before { content: "ðŸ±"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-dog::before { content: "ðŸ¶"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-fox::before { content: "ðŸ¦Š"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-butterfly::before { content: "ðŸ¦‹"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-bee::before { content: "ðŸ"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-owl::before { content: "ðŸ¦‰"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Objects & Tools */
        .decoration-rocket::before { content: "ðŸš€"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-robot::before { content: "ðŸ¤–"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-key::before { content: "ðŸ”‘"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-lock::before { content: "ðŸ”’"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-crown::before { content: "ðŸ‘‘"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-trophy::before { content: "ðŸ†"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-medal::before { content: "ðŸ…"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Food & Drink */
        .decoration-coffee::before { content: "â˜•"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-pizza::before { content: "ðŸ•"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-cake::before { content: "ðŸŽ‚"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-donut::before { content: "ï¿½"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Symbols & Shapes */
        .decoration-heart::before { content: "â¤ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-peace::before { content: "â˜®ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-yin-yang::before { content: "â˜¯ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-infinity::before { content: "â™¾ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-check::before { content: "âœ…"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-warning::before { content: "âš ï¸"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Music & Art */
        .decoration-music::before { content: "ðŸŽµ"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-palette::before { content: "ðŸŽ¨"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-camera::before { content: "ðŸ“·"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Sports & Activities */
        .decoration-soccer::before { content: "âš½"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-basketball::before { content: "ðŸ€"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-target::before { content: "ðŸŽ¯"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Tech & Gaming */
        .decoration-computer::before { content: "ðŸ’»"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-phone::before { content: "ðŸ“±"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-gamepad::before { content: "ðŸŽ®"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-wifi::before { content: "ðŸ“¶"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-battery::before { content: "ðŸ”‹"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Faces & Expressions */
        .decoration-smile::before { content: "ðŸ˜Š"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-cool::before { content: "ðŸ˜Ž"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-thinking::before { content: "ðŸ¤”"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-party::before { content: "ðŸ¥³"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Mystical & Magic */
        .decoration-crystal::before { content: "ðŸ”®"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-magic::before { content: "âœ¨"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-wizard::before { content: "ðŸ§™"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-unicorn::before { content: "ðŸ¦„"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }
        .decoration-dragon::before { content: "ðŸ‰"; position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0.5; }

        /* Status message styling */
        .status-message {
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        /* Collapsible sections */
        .collapsible-section {
            transition: max-height 0.3s ease;
            overflow: hidden;
        }

        .collapsible-section.collapsed .collapsible-content {
            max-height: 0;
            padding: 0;
            margin: 0;
            border: none;
            overflow: hidden;
        }

        .collapsible-section .collapsible-content {
            max-height: none;
            transition: max-height 0.3s ease;
        }

        /* Color input groups */
        .color-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .color-input-group .form-control[type="color"] {
            width: 50px;
            height: 38px;
            padding: 2px;
            border-radius: 0.375rem 0 0 0.375rem;
        }

        .color-input-group .form-control[type="text"] {
            border-radius: 0 0.375rem 0.375rem 0;
            border-left: none;
        }

        /* Bootstrap Component Overrides to ensure theme colors are used */
        .btn-primary {
            background-color: var(--theme-primary, var(--bs-primary)) !important;
            border-color: var(--theme-primary, var(--bs-primary)) !important;
            color: white !important;
        }

        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--theme-primary-hover, var(--theme-primary-darker)) !important;
            border-color: var(--theme-primary-hover, var(--theme-primary-darker)) !important;
        }

        .btn-outline-primary {
            color: var(--theme-primary, var(--bs-primary)) !important;
            border-color: var(--theme-primary, var(--bs-primary)) !important;
        }

        .btn-outline-primary:hover, .btn-outline-primary:focus {
            background-color: var(--theme-primary, var(--bs-primary)) !important;
            border-color: var(--theme-primary, var(--bs-primary)) !important;
            color: white !important;
        }

        .btn-secondary {
            background-color: var(--theme-secondary, var(--bs-secondary)) !important;
            border-color: var(--theme-secondary, var(--bs-secondary)) !important;
        }

        .btn-outline-secondary {
            color: var(--theme-secondary, var(--bs-secondary)) !important;
            border-color: var(--theme-secondary, var(--bs-secondary)) !important;
        }

        .btn-outline-secondary:hover, .btn-outline-secondary:focus {
            background-color: var(--theme-secondary, var(--bs-secondary)) !important;
            border-color: var(--theme-secondary, var(--bs-secondary)) !important;
        }

        .btn-success {
            background-color: var(--theme-success, var(--bs-success)) !important;
            border-color: var(--theme-success, var(--bs-success)) !important;
        }

        .btn-outline-danger {
            color: var(--theme-danger, var(--bs-danger)) !important;
            border-color: var(--theme-danger, var(--bs-danger)) !important;
        }

        .btn-outline-danger:hover, .btn-outline-danger:focus {
            background-color: var(--theme-danger, var(--bs-danger)) !important;
            border-color: var(--theme-danger, var(--bs-danger)) !important;
        }

        /* Badge overrides */
        .badge.bg-primary {
            background-color: var(--theme-primary, var(--bs-primary)) !important;
            color: white !important;
        }

        .badge.bg-secondary {
            background-color: var(--theme-secondary, var(--bs-secondary)) !important;
            color: white !important;
        }

        .badge.bg-success {
            background-color: var(--theme-success, var(--bs-success)) !important;
            color: white !important;
        }

        .badge.bg-warning {
            background-color: var(--theme-warning, var(--bs-warning)) !important;
            color: black !important;
        }

        .badge.bg-danger {
            background-color: var(--theme-danger, var(--bs-danger)) !important;
            color: white !important;
        }

        .badge.bg-info {
            background-color: var(--theme-info, var(--bs-info)) !important;
            color: white !important;
        }

        /* Alert overrides */
        .alert-primary {
            background-color: var(--theme-primary-subtle, rgba(var(--theme-primary-rgb), 0.1)) !important;
            border-color: var(--theme-primary-border, rgba(var(--theme-primary-rgb), 0.2)) !important;
            color: var(--theme-primary-darker, var(--theme-primary)) !important;
        }

        .alert-success {
            background-color: var(--theme-success-subtle, rgba(var(--theme-success-rgb), 0.1)) !important;
            border-color: var(--theme-success-border, rgba(var(--theme-success-rgb), 0.2)) !important;
            color: var(--theme-success-darker, var(--theme-success)) !important;
        }

        .alert-warning {
            background-color: var(--theme-warning-subtle, rgba(var(--theme-warning-rgb), 0.1)) !important;
            border-color: var(--theme-warning-border, rgba(var(--theme-warning-rgb), 0.2)) !important;
            color: var(--theme-warning-darker, var(--theme-warning)) !important;
        }

        .alert-danger {
            background-color: var(--theme-danger-subtle, rgba(var(--theme-danger-rgb), 0.1)) !important;
            border-color: var(--theme-danger-border, rgba(var(--theme-danger-rgb), 0.2)) !important;
            color: var(--theme-danger-darker, var(--theme-danger)) !important;
        }

        /* Table overrides */
        .table-striped > tbody > tr:nth-of-type(odd) > td {
            background-color: var(--theme-bg-surface, var(--bs-tertiary-bg)) !important;
        }

        .table {
            color: var(--theme-text, var(--bs-body-color)) !important;
        }

        .table th {
            border-color: var(--theme-border, var(--bs-border-color)) !important;
            background-color: var(--theme-bg-surface, var(--bs-tertiary-bg)) !important;
        }

        .table td {
            border-color: var(--theme-border, var(--bs-border-color)) !important;
        }

        /* AI Chat Interface Styles */
        .ai-chat-container {
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            background: var(--theme-bg-surface, var(--bs-tertiary-bg));
            padding: 1rem;
        }

        .ai-chat-messages {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            padding: 1rem;
            background: var(--theme-bg-card, var(--bs-body-bg));
        }

        .ai-message {
            display: flex;
            margin-bottom: 1rem;
            opacity: 0;
            animation: fadeInUp 0.3s ease forwards;
        }

        .ai-message:last-child {
            margin-bottom: 0;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        .ai-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }

        .ai-message.assistant .ai-message-avatar {
            background: var(--theme-primary, var(--bs-primary));
            margin-right: 0.75rem;
        }

        .ai-message.user .ai-message-avatar {
            background: var(--theme-secondary, var(--bs-secondary));
            margin-left: 0.75rem;
        }

        .ai-message-content {
            background: var(--theme-bg-surface, var(--bs-tertiary-bg));
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            max-width: 80%;
            word-wrap: break-word;
        }

        .ai-message.user .ai-message-content {
            background: var(--theme-primary, var(--bs-primary));
            color: white;
            border-color: var(--theme-primary, var(--bs-primary));
        }

        .ai-message-content p:last-child {
            margin-bottom: 0;
        }

        .ai-message-content ul {
            margin-bottom: 0.5rem;
            padding-left: 1.2rem;
        }

        .ai-chat-input-container {
            margin-top: 1rem;
        }

        /* Quick Action Buttons */
        .btn-outline-primary.btn-sm {
            padding: 0.5rem 0.75rem;
            text-align: left;
            transition: all 0.2s ease;
            border: 1px solid var(--theme-primary, var(--bs-primary));
            color: var(--theme-primary, var(--bs-primary));
        }

        .btn-outline-primary.btn-sm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: var(--theme-primary, var(--bs-primary));
            color: white;
        }

        .btn-outline-primary.btn-sm i {
            opacity: 0.8;
        }

        .btn-outline-primary.btn-sm .small {
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1.2;
            margin-top: 0.15rem;
        }

        .ai-theme-preview {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            background: var(--theme-bg-card, var(--bs-body-bg));
        }

        .ai-theme-preview.show {
            display: block;
            animation: fadeInUp 0.3s ease forwards;
        }

        .ai-color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .ai-color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 0.25rem;
            border: 1px solid var(--theme-border, var(--bs-border-color));
            cursor: pointer;
            transition: var(--transition-base);
            position: relative;
        }

        .ai-color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .ai-color-swatch .color-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            white-space: nowrap;
            color: var(--theme-text-secondary, var(--bs-secondary-color));
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading animation for AI generation */
        .ai-generating {
            position: relative;
        }

        .ai-generating::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--theme-border, var(--bs-border-color));
            border-top: 2px solid var(--theme-primary, var(--bs-primary));
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Universal App Ribbon -->
    {% include 'components/ribbon.html' %}
    
    <div class="container-fluid main-container">
        <div class="row">
            <!-- Settings Panel -->
            <div class="col-lg-7">
                <div class="settings-container">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="mb-0">System Theme</h1>
                            <p class="text-muted mb-0">Configure application theme and visual appearance</p>
                        </div>
                        <div></div>
                    </div>

                    <!-- Status Messages -->
                    <div id="statusMessage" class="alert d-none status-message" role="alert"></div>

                    <!-- Core Theme Settings -->
                    <div class="settings-section">
                        <h5 class="mb-3" style="color: var(--theme-primary, #6f42c1);">
                            <i class="fas fa-palette me-2"></i>Theme & Mode
                        </h5>
                        
                        <!-- Dark Mode Toggle -->
                        <div class="row align-items-center mb-4">
                            <div class="col-md-8">
                                <h6>Dark Mode</h6>
                                <p class="text-muted mb-0">Switch to dark color scheme for low-light environments</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <label class="switch">
                                    <input type="checkbox" id="darkModeToggle" {{ 'checked' if dark_mode_enabled else '' }}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Automatic Dark Mode -->
                        <div class="row align-items-center mb-4">
                            <div class="col-md-8">
                                <h6>Automatic Day/Night Mode</h6>
                                <p class="text-muted mb-0">Automatically switch themes based on time of day</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <label class="switch">
                                    <input type="checkbox" id="autoDarkModeToggle" {{ 'checked' if auto_dark_mode else '' }}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Time Settings (only visible when auto mode is enabled) -->
                        <div id="autoModeTimeSettings" class="mb-4" style="display: {{ 'block' if auto_dark_mode else 'none' }};">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="fas fa-moon me-1"></i>Dark Mode Starts
                                    </label>
                                    <input type="time" class="form-control" id="darkModeStart" value="{{ dark_mode_start or '18:00' }}">
                                    <small class="text-muted">Default: 6:00 PM</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="fas fa-sun me-1"></i>Light Mode Starts
                                    </label>
                                    <input type="time" class="form-control" id="darkModeEnd" value="{{ dark_mode_end or '06:00' }}">
                                    <small class="text-muted">Default: 6:00 AM</small>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Current time: <span id="currentTime"></span> - 
                                    Mode would be: <span id="currentModePreview"></span>
                                </small>
                            </div>
                        </div>

                        <!-- Theme Selection -->
                        <div class="mb-3">
                            <label class="form-label">Color Scheme</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="theme-card" data-theme="default" onclick="themeManager.updateSetting('root', 'theme', 'default')">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="color-swatch" style="background: #0d6efd;"></div>
                                            <div class="color-swatch" style="background: #198754;"></div>
                                            <div class="color-swatch" style="background: #dc3545;"></div>
                                            <h6 class="mb-0 ms-2">Default Blue</h6>
                                        </div>
                                        <small class="text-muted">Classic Bootstrap colors</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="theme-card" data-theme="emerald" onclick="themeManager.updateSetting('root', 'theme', 'emerald')">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="color-swatch" style="background: #10b981;"></div>
                                            <div class="color-swatch" style="background: #059669;"></div>
                                            <div class="color-swatch" style="background: #ef4444;"></div>
                                            <h6 class="mb-0 ms-2">Emerald Green</h6>
                                        </div>
                                        <small class="text-muted">Nature-inspired green palette</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="theme-card" data-theme="purple" onclick="themeManager.updateSetting('root', 'theme', 'purple')">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="color-swatch" style="background: #8b5cf6;"></div>
                                            <div class="color-swatch" style="background: #7c3aed;"></div>
                                            <div class="color-swatch" style="background: #ef4444;"></div>
                                            <h6 class="mb-0 ms-2">Purple</h6>
                                        </div>
                                        <small class="text-muted">Professional purple scheme</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="theme-card" data-theme="amber" onclick="themeManager.updateSetting('root', 'theme', 'amber')">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="color-swatch" style="background: #f59e0b;"></div>
                                            <div class="color-swatch" style="background: #d97706;"></div>
                                            <div class="color-swatch" style="background: #ef4444;"></div>
                                            <h6 class="mb-0 ms-2">Amber</h6>
                                        </div>
                                        <small class="text-muted">Warm amber and gold tones</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="theme-card" data-theme="custom" onclick="themeManager.updateSetting('root', 'theme', 'custom')">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="color-swatch" style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);"></div>
                                            <div class="color-swatch" style="background: linear-gradient(45deg, #96ceb4, #ffeaa7, #fab1a0);"></div>
                                            <div class="color-swatch" style="background: linear-gradient(45deg, #a29bfe, #fd79a8, #fdcb6e);"></div>
                                            <h6 class="mb-0 ms-2">Custom</h6>
                                        </div>
                                        <small class="text-muted">Define your own color palette</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Font Size -->
                        <div class="row">
                            <div class="col-md-6">
                                <label for="fontSize" class="form-label">Font Size</label>
                                <select class="form-select" id="fontSize" onchange="themeManager.updateSetting('root', 'fontSize', this.value)">
                                    <option value="small" {{ 'selected' if font_size == 'small' else '' }}>Small (14px)</option>
                                    <option value="normal" {{ 'selected' if font_size == 'normal' or not font_size else '' }}>Normal (16px)</option>
                                    <option value="large" {{ 'selected' if font_size == 'large' else '' }}>Large (18px)</option>
                                    <option value="extra-large" {{ 'selected' if font_size == 'extra-large' else '' }}>Extra Large (20px)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">High Contrast</label>
                                <div class="text-end">
                                    <label class="switch">
                                        <input type="checkbox" id="highContrastToggle" {{ 'checked' if high_contrast_enabled else '' }}>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Theme Generator -->
                    <div class="settings-section">
                        <h5 class="mb-3" style="color: var(--theme-primary, #6f42c1);">
                            <i class="fas fa-magic me-2"></i>AI Theme Generator
                        </h5>
                        
                        <div class="mb-3">
                            <p class="text-muted mb-3">
                                <i class="fas fa-robot me-1"></i>
                                Describe your ideal theme and let AI generate custom colors for you.
                            </p>
                            
                            <!-- AI Chat Interface -->
                            <div id="aiThemeChat" class="ai-chat-container">
                                <div id="aiChatMessages" class="ai-chat-messages mb-3">
                                    <div class="ai-message assistant">
                                        <div class="ai-message-avatar">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div class="ai-message-content">
                                            <p>Hi! I'll help you create custom themes and backgrounds. What would you like to do?</p>
                                            
                                            <!-- Quick Action Buttons -->
                                            <div class="row g-2 mt-2 mb-2">
                                                <div class="col-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickAction('I want to create a custom color theme for my app. Help me generate a color palette with primary, secondary, success, warning, danger, and info colors. I prefer [describe your style, e.g., professional blue, nature green, warm sunset, etc.]')">
                                                        <i class="fas fa-palette me-1"></i>
                                                        <div class="small">Create Theme</div>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickAction('I want to add a custom background wallpaper to my app. Can you suggest prompts I can use with ChatGPT/DALL-E or Midjourney to generate a beautiful, professional background image? I prefer [describe style: minimalist, nature, abstract, tech, etc.]')">
                                                        <i class="fas fa-image me-1"></i>
                                                        <div class="small">Background Ideas</div>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickAction('Suggest some beautiful color combinations that would work well for an application interface. Include both light and dark mode recommendations.')">
                                                        <i class="fas fa-swatchbook me-1"></i>
                                                        <div class="small">Color Ideas</div>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickAction('Help me choose the best theme colors and style for my application. Consider factors like professionalism, readability, and modern design trends.')">
                                                        <i class="fas fa-lightbulb me-1"></i>
                                                        <div class="small">Theme Advice</div>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickAction('Help me make my current theme more accessible. Suggest improvements for color contrast, readability, and WCAG compliance.')">
                                                        <i class="fas fa-universal-access me-1"></i>
                                                        <div class="small">Accessibility</div>
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="sendQuickAction('Modify the last theme')">
                                                        <i class="fas fa-edit me-1"></i>
                                                        <div class="small">Modify Theme</div>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <p class="mb-0 mt-2 small text-muted">Or type your own request below:</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ai-chat-input-container">
                                    <div class="input-group">
                                        <input type="text" id="aiThemeInput" class="form-control" 
                                               placeholder="Describe your wallpaper or theme..." 
                                               maxlength="500">
                                        <button class="btn btn-success" type="button" id="aiGenerateWallpaperBtn" title="Generate Wallpaper with AI">
                                            <i class="fas fa-image me-1"></i>Generate Wallpaper
                                        </button>
                                        <button class="btn btn-primary" type="button" id="aiThemeGenerateBtn" title="Send Message">
                                            <i class="fas fa-paper-plane me-1"></i>Send
                                        </button>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <small class="text-muted">
                                            <i class="fas fa-lightbulb me-1"></i>
                                            <strong>Generate Wallpaper:</strong> Creates an AI image from your prompt. <strong>Send:</strong> Chat about themes and colors.
                                        </small>
                                        <button class="btn btn-outline-secondary btn-sm" type="button" id="aiClearChatBtn">
                                            <i class="fas fa-trash me-1"></i>Clear Chat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section Styling -->
                    <div class="settings-section">
                        <h5 class="mb-3" style="color: var(--theme-primary, #6f42c1);">
                            <i class="fas fa-layer-group me-2"></i>Section Styling
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="sectionBorderStyle" class="form-label">Border Style</label>
                                <select class="form-select" id="sectionBorderStyle" onchange="themeManager.updateSetting('sectionStyles', 'borderStyle', this.value)">
                                    <optgroup label="Basic Styles">
                                        <option value="none">None (no border)</option>
                                        <option value="thin">Thin (1px solid)</option>
                                        <option value="thick">Thick (4px solid)</option>
                                        <option value="dashed">Dashed (3px dashed)</option>
                                    </optgroup>
                                    <optgroup label="Themed Styles">
                                        <option value="retro">Retro (classic arcade style)</option>
                                        <option value="pixelated">Pixelated (8-bit gaming)</option>
                                        <option value="pokemon">Pokemon (game-inspired)</option>
                                        <option value="nature">Nature (organic and natural)</option>
                                        <option value="autumn">Autumn (seasonal leaves)</option>
                                        <option value="ocean">Ocean (water-themed)</option>
                                        <option value="forest">Forest (woodland theme)</option>
                                        <option value="sunset">Sunset (warm evening tones)</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="sectionSpacing" class="form-label">Spacing</label>
                                <select class="form-select" id="sectionSpacing" onchange="themeManager.updateSetting('sectionStyles', 'spacing', this.value)">
                                    <option value="compact">Compact</option>
                                    <option value="normal">Normal</option>
                                    <option value="spacious">Spacious</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="sectionBackground" class="form-label">Background Style</label>
                                <select class="form-select" id="sectionBackground" onchange="themeManager.updateSetting('sectionStyles', 'background', this.value)">
                                    <option value="flat">Flat</option>
                                    <option value="subtle">Subtle</option>
                                    <option value="elevated">Elevated</option>
                                    <option value="glassmorphic">Glassmorphic</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-1">
                            <div class="col-md-4">
                                <label for="sectionAnimation" class="form-label">Animation</label>
                                <select class="form-select" id="sectionAnimation" onchange="themeManager.updateSetting('sectionStyles', 'animation', this.value)">
                                    <option value="none">None</option>
                                    <option value="fade">Fade In</option>
                                    <option value="slide">Slide Up</option>
                                    <option value="bounce">Bounce In</option>
                                    <option value="pulse">Pulse</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="sectionEffect" class="form-label">Visual Effect</label>
                                <select class="form-select" id="sectionEffect" onchange="themeManager.updateSetting('sectionStyles', 'effect', this.value)">
                                    <option value="none">None</option>
                                    <option value="glow">Glow</option>
                                    <option value="shadow">Enhanced Shadow</option>
                                    <option value="gradient">Gradient</option>
                                    <option value="texture">Texture</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="sectionPattern" class="form-label">Pattern</label>
                                <select class="form-select" id="sectionPattern" onchange="themeManager.updateSetting('sectionStyles', 'pattern', this.value)">
                                    <option value="none">None</option>
                                    <option value="diagonal-lines">Diagonal Lines</option>
                                    <option value="dots">Dots</option>
                                    <option value="grid">Grid</option>
                                    <option value="zigzag">Zigzag</option>
                                    <option value="crosshatch">Crosshatch</option>
                                    <option value="waves">Waves</option>
                                    <option value="honeycomb">Honeycomb</option>
                                    <option value="checkers">Checkers</option>
                                    <option value="triangles">Triangles</option>
                                    <option value="stars">Stars</option>
                                    <option value="circuit">Circuit</option>
                                    <option value="noise">Noise</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-1">
                            <div class="col-md-12">
                                <label for="sectionDecoration" class="form-label">Corner Decoration - Full Emoji Library</label>
                                <select class="form-select" id="sectionDecoration" onchange="themeManager.updateSetting('sectionStyles', 'decoration', this.value)">
                                    <option value="none">None</option>
                                    <optgroup label="ðŸŒ¿ Nature & Weather">
                                        <option value="leaf">ðŸƒ Leaf</option>
                                        <option value="tree">ðŸŒ² Tree</option>
                                        <option value="flower">ðŸŒ¸ Flower</option>
                                        <option value="rose">ðŸŒ¹ Rose</option>
                                        <option value="cactus">ðŸŒµ Cactus</option>
                                        <option value="mushroom">ðŸ„ Mushroom</option>
                                        <option value="sun">â˜€ï¸ Sun</option>
                                        <option value="moon">ðŸŒ™ Moon</option>
                                        <option value="star">â­ Star</option>
                                        <option value="rainbow">ðŸŒˆ Rainbow</option>
                                        <option value="cloud">â˜ï¸ Cloud</option>
                                        <option value="snow">â„ï¸ Snow</option>
                                        <option value="fire">ðŸ”¥ Fire</option>
                                        <option value="lightning">âš¡ Lightning</option>
                                    </optgroup>
                                    <optgroup label="ðŸ¾ Animals">
                                        <option value="cat">ðŸ± Cat</option>
                                        <option value="dog">ðŸ¶ Dog</option>
                                        <option value="fox">ðŸ¦Š Fox</option>
                                        <option value="owl">ðŸ¦‰ Owl</option>
                                        <option value="butterfly">ðŸ¦‹ Butterfly</option>
                                        <option value="bee">ðŸ Bee</option>
                                    </optgroup>
                                    <optgroup label="ðŸ’Ž Gems & Objects">
                                        <option value="diamond">ðŸ’Ž Diamond</option>
                                        <option value="gem">ðŸ’  Gem</option>
                                        <option value="crown">ðŸ‘‘ Crown</option>
                                        <option value="trophy">ðŸ† Trophy</option>
                                        <option value="medal">ðŸ… Medal</option>
                                        <option value="key">ðŸ”‘ Key</option>
                                        <option value="lock">ðŸ”’ Lock</option>
                                    </optgroup>
                                    <optgroup label="âš”ï¸ Fantasy & Adventure">
                                        <option value="shield">ðŸ›¡ï¸ Shield</option>
                                        <option value="sword">âš”ï¸ Sword</option>
                                        <option value="crystal">ï¿½ Crystal Ball</option>
                                        <option value="magic">âœ¨ Magic</option>
                                        <option value="wizard">ðŸ§™ Wizard</option>
                                        <option value="unicorn">ðŸ¦„ Unicorn</option>
                                        <option value="dragon">ðŸ‰ Dragon</option>
                                    </optgroup>
                                    <optgroup label="ðŸš€ Tech & Gaming">
                                        <option value="gear">âš™ï¸ Gear</option>
                                        <option value="circuit">ðŸ”Œ Circuit</option>
                                        <option value="code">ðŸ“‹ Code</option>
                                        <option value="data">ðŸ’¾ Data</option>
                                        <option value="rocket">ðŸš€ Rocket</option>
                                        <option value="robot">ðŸ¤– Robot</option>
                                        <option value="computer">ðŸ’» Computer</option>
                                        <option value="phone">ðŸ“± Phone</option>
                                        <option value="gamepad">ðŸŽ® Gamepad</option>
                                        <option value="wifi">ðŸ“¶ WiFi</option>
                                        <option value="battery">ðŸ”‹ Battery</option>
                                    </optgroup>
                                    <optgroup label="ðŸŽ¨ Creative & Music">
                                        <option value="palette">ðŸŽ¨ Art Palette</option>
                                        <option value="music">ðŸŽµ Music</option>
                                        <option value="camera">ðŸ“· Camera</option>
                                    </optgroup>
                                    <optgroup label="âš½ Sports & Games">
                                        <option value="target">ðŸŽ¯ Target</option>
                                        <option value="soccer">âš½ Soccer</option>
                                        <option value="basketball">ðŸ€ Basketball</option>
                                    </optgroup>
                                    <optgroup label="ðŸ• Food & Drink">
                                        <option value="coffee">â˜• Coffee</option>
                                        <option value="pizza">ðŸ• Pizza</option>
                                        <option value="cake">ðŸŽ‚ Cake</option>
                                        <option value="donut">ðŸ© Donut</option>
                                    </optgroup>
                                    <optgroup label="ðŸ˜Š Faces & Emotions">
                                        <option value="smile">ðŸ˜Š Smile</option>
                                        <option value="cool">ðŸ˜Ž Cool</option>
                                        <option value="thinking">ðŸ¤” Thinking</option>
                                        <option value="party">ðŸ¥³ Party</option>
                                    </optgroup>
                                    <optgroup label="â™¾ï¸ Symbols">
                                        <option value="heart">â¤ï¸ Heart</option>
                                        <option value="peace">â˜®ï¸ Peace</option>
                                        <option value="yin-yang">â˜¯ï¸ Yin Yang</option>
                                        <option value="infinity">â™¾ï¸ Infinity</option>
                                        <option value="check">âœ… Check</option>
                                        <option value="warning">âš ï¸ Warning</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Colors (Collapsible) -->
                    <div class="settings-section collapsible-section" id="customColorsSection">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" style="color: var(--theme-primary, #6f42c1);">
                                <i class="fas fa-paint-brush me-2"></i>Custom Colors
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleSection('customColorsSection')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="collapsible-content">
                            <p class="text-muted mb-3">Override default color scheme with custom colors (requires Custom theme selection)</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Primary Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customPrimary" value="{{ custom_colors.get('primary', '#0d6efd') }}">
                                        <input type="text" class="form-control" placeholder="#0d6efd" value="{{ custom_colors.get('primary', '#0d6efd') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Primary Hover</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customPrimaryHover" value="{{ custom_colors.get('primary_hover', '#0b5ed7') }}">
                                        <input type="text" class="form-control" placeholder="#0b5ed7" value="{{ custom_colors.get('primary_hover', '#0b5ed7') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Secondary Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customSecondary" value="{{ custom_colors.get('secondary', '#6c757d') }}">
                                        <input type="text" class="form-control" placeholder="#6c757d" value="{{ custom_colors.get('secondary', '#6c757d') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Success Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customSuccess" value="{{ custom_colors.get('success', '#198754') }}">
                                        <input type="text" class="form-control" placeholder="#198754" value="{{ custom_colors.get('success', '#198754') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Warning Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customWarning" value="{{ custom_colors.get('warning', '#ffc107') }}">
                                        <input type="text" class="form-control" placeholder="#ffc107" value="{{ custom_colors.get('warning', '#ffc107') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Danger Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customDanger" value="{{ custom_colors.get('danger', '#dc3545') }}">
                                        <input type="text" class="form-control" placeholder="#dc3545" value="{{ custom_colors.get('danger', '#dc3545') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Info Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customInfo" value="{{ custom_colors.get('info', '#0dcaf0') }}">
                                        <input type="text" class="form-control" placeholder="#0dcaf0" value="{{ custom_colors.get('info', '#0dcaf0') }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Light Mode Colors (Collapsible) -->
                    <div class="settings-section collapsible-section" id="customLightModeSection">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" style="color: var(--theme-primary, #6f42c1);">
                                <i class="fas fa-sun me-2"></i>Custom Light Mode Colors
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleSection('customLightModeSection')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="collapsible-content">
                            <p class="text-muted mb-3">Customize light mode background and text colors</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Body Background</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customLightBgBody" value="{{ custom_light_mode.get('bg_body', '#ffffff') }}">
                                        <input type="text" class="form-control" placeholder="#ffffff" value="{{ custom_light_mode.get('bg_body', '#ffffff') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Card Background</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customLightBgCard" value="{{ custom_light_mode.get('bg_card', '#ffffff') }}">
                                        <input type="text" class="form-control" placeholder="#ffffff" value="{{ custom_light_mode.get('bg_card', '#ffffff') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Surface Background</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customLightBgSurface" value="{{ custom_light_mode.get('bg_surface', '#f8f9fa') }}">
                                        <input type="text" class="form-control" placeholder="#f8f9fa" value="{{ custom_light_mode.get('bg_surface', '#f8f9fa') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Text Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customLightText" value="{{ custom_light_mode.get('text', '#212529') }}">
                                        <input type="text" class="form-control" placeholder="#212529" value="{{ custom_light_mode.get('text', '#212529') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Muted Text</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customLightTextMuted" value="{{ custom_light_mode.get('text_muted', '#6c757d') }}">
                                        <input type="text" class="form-control" placeholder="#6c757d" value="{{ custom_light_mode.get('text_muted', '#6c757d') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Border Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customLightBorder" value="{{ custom_light_mode.get('border', '#dee2e6') }}">
                                        <input type="text" class="form-control" placeholder="#dee2e6" value="{{ custom_light_mode.get('border', '#dee2e6') }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Dark Mode Colors (Collapsible) -->
                    <div class="settings-section collapsible-section" id="customDarkModeSection">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" style="color: var(--theme-primary, #6f42c1);">
                                <i class="fas fa-moon me-2"></i>Custom Dark Mode Colors
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleSection('customDarkModeSection')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="collapsible-content">
                            <p class="text-muted mb-3">Customize dark mode background and text colors</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Body Background</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customDarkBgBody" value="{{ custom_dark_mode.get('bg_body', '#0d1117') }}">
                                        <input type="text" class="form-control" placeholder="#0d1117" value="{{ custom_dark_mode.get('bg_body', '#0d1117') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Card Background</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customDarkBgCard" value="{{ custom_dark_mode.get('bg_card', '#161b22') }}">
                                        <input type="text" class="form-control" placeholder="#161b22" value="{{ custom_dark_mode.get('bg_card', '#161b22') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Surface Background</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customDarkBgSurface" value="{{ custom_dark_mode.get('bg_surface', '#21262d') }}">
                                        <input type="text" class="form-control" placeholder="#21262d" value="{{ custom_dark_mode.get('bg_surface', '#21262d') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Text Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customDarkText" value="{{ custom_dark_mode.get('text', '#f0f6fc') }}">
                                        <input type="text" class="form-control" placeholder="#f0f6fc" value="{{ custom_dark_mode.get('text', '#f0f6fc') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Muted Text</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customDarkTextMuted" value="{{ custom_dark_mode.get('text_muted', '#8b949e') }}">
                                        <input type="text" class="form-control" placeholder="#8b949e" value="{{ custom_dark_mode.get('text_muted', '#8b949e') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Border Color</label>
                                    <div class="color-input-group">
                                        <input type="color" class="form-control" id="customDarkBorder" value="{{ custom_dark_mode.get('border', '#30363d') }}">
                                        <input type="text" class="form-control" placeholder="#30363d" value="{{ custom_dark_mode.get('border', '#30363d') }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Import/Export (Collapsible) -->
                    <div class="settings-section collapsible-section collapsed" id="importExportSection">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" style="color: var(--theme-primary, #6f42c1);">
                                <i class="fas fa-download me-2"></i>Import/Export Theme
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleSection('importExportSection')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="collapsible-content">
                            <p class="text-muted mb-3">Export your current theme settings or import a previously saved theme</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="exportTheme()">
                                        <i class="fas fa-download me-2"></i>Export Current Theme
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-success w-100" onclick="document.getElementById('themeImportFile').click()">
                                        <i class="fas fa-upload me-2"></i>Import Theme File
                                    </button>
                                    <input type="file" id="themeImportFile" accept=".json" style="display: none;" onchange="importTheme(this.files[0])">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Or paste theme JSON here:</label>
                                    <textarea class="form-control" id="themeImportText" rows="4" placeholder="Paste exported theme JSON here..."></textarea>
                                    <button type="button" class="btn btn-outline-info mt-2" onclick="importThemeFromText()">
                                        <i class="fas fa-paste me-2"></i>Import from Text
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Background Image (Collapsible) -->
                    <div class="settings-section collapsible-section collapsed" id="backgroundImageSection">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" style="color: var(--theme-primary, #6f42c1);">
                                <i class="fas fa-image me-2"></i>Background Image
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleSection('backgroundImageSection')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="collapsible-content">
                            <p class="text-muted mb-3">Add a custom high-resolution background image to your app</p>
                            
                            <!-- Enable Background Image -->
                            <div class="row align-items-center mb-3">
                                <div class="col-md-8">
                                    <h6>Enable Background Image</h6>
                                    <p class="text-muted mb-0 small">Show custom background behind all pages</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <label class="switch">
                                        <input type="checkbox" id="backgroundImageEnabled" onchange="backgroundManager.toggleEnabled(this.checked)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div id="backgroundImageControls">
                                <!-- Current Background Preview -->
                                <div id="currentBackgroundPreview" class="mb-3" style="display: none;">
                                    <label class="form-label">Current Background</label>
                                    <div class="position-relative" style="border: 2px solid var(--theme-border); border-radius: 8px; overflow: hidden; max-height: 200px;">
                                        <img id="currentBackgroundImg" src="" alt="Current Background" style="width: 100%; height: auto; display: block;">
                                        <button type="button" class="btn btn-sm btn-danger position-absolute" style="top: 10px; right: 10px;" onclick="backgroundManager.removeBackground()">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>

                                <!-- Upload New Background -->
                                <div class="mb-3">
                                    <label class="form-label">Upload Background Image</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="backgroundImageFile" accept="image/*" onchange="backgroundManager.uploadBackground(this.files[0])">
                                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('backgroundImageFile').click()">
                                            <i class="fas fa-upload"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Supported: PNG, JPG, JPEG, WEBP, GIF. Recommended: High resolution (1920x1080 or higher)</small>
                                </div>

                                <!-- Background Settings -->
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label for="backgroundOpacity" class="form-label">Opacity: <span id="opacityValue">50</span>%</label>
                                        <input type="range" class="form-range" id="backgroundOpacity" min="0" max="100" value="50" oninput="backgroundManager.updateOpacity(this.value)">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="backgroundBlur" class="form-label">Blur: <span id="blurValue">0</span>px</label>
                                        <input type="range" class="form-range" id="backgroundBlur" min="0" max="20" value="0" oninput="backgroundManager.updateBlur(this.value)">
                                    </div>
                                </div>

                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label for="backgroundSize" class="form-label">Size</label>
                                        <select class="form-select" id="backgroundSize" onchange="backgroundManager.updateSize(this.value)">
                                            <option value="cover">Cover (Fill screen)</option>
                                            <option value="contain">Contain (Fit in screen)</option>
                                            <option value="auto">Auto (Original size)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="backgroundPosition" class="form-label">Position</label>
                                        <select class="form-select" id="backgroundPosition" onchange="backgroundManager.updatePosition(this.value)">
                                            <option value="center">Center</option>
                                            <option value="top">Top</option>
                                            <option value="bottom">Bottom</option>
                                            <option value="left">Left</option>
                                            <option value="right">Right</option>
                                            <option value="top left">Top Left</option>
                                            <option value="top right">Top Right</option>
                                            <option value="bottom left">Bottom Left</option>
                                            <option value="bottom right">Bottom Right</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Parallax Effect -->
                                <div class="row align-items-center mb-3">
                                    <div class="col-md-8">
                                        <h6 class="mb-0">Parallax Effect</h6>
                                        <p class="text-muted mb-0 small">Fixed background when scrolling</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <label class="switch">
                                            <input type="checkbox" id="backgroundParallax" onchange="backgroundManager.toggleParallax(this.checked)">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- AI Generation (if available) -->
                                <div class="alert alert-info">
                                    <i class="fas fa-sparkles me-2"></i>
                                    <strong>AI Background Generation:</strong> 
                                    To generate custom backgrounds using AI, please use the <strong>AI Chat</strong> feature below and ask it to create a wallpaper or background image for you!
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reset Section -->
                    <div class="settings-section">
                        <h5 class="mb-3" style="color: var(--theme-danger, #dc3545);">
                            <i class="fas fa-undo me-2"></i>Reset Theme
                        </h5>
                        <p class="text-muted mb-3">Reset all theme settings to default values</p>
                        <button type="button" class="btn btn-outline-danger" onclick="resetTheme()">
                            <i class="fas fa-undo me-2"></i>Reset to Defaults
                        </button>
                    </div>

                    <!-- Save Button -->
                    <div class="text-end">
                        <button type="button" class="btn btn-theme-primary btn-lg" onclick="saveThemeSettings()">
                            <i class="fas fa-save me-2"></i>Save Theme Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Live Preview Panel -->
            <div class="col-lg-5">
                <div class="preview-container">
                    <h5 class="mb-3" style="color: var(--theme-primary, #6f42c1);">
                        <i class="fas fa-eye me-2"></i>Live Preview
                    </h5>
                    <p class="text-muted mb-3">Real-time preview of your theme settings</p>
                    
                    <div id="unified-preview">
                        <!-- Preview content will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='theme-manager.js') }}"></script>
    <script>
        // Initialize theme manager with current settings
        document.addEventListener('DOMContentLoaded', () => {
            const initialState = {
                theme: '{{ current_theme or "default" }}',
                darkMode: {{ 'true' if dark_mode_enabled else 'false' }},
                autoDarkMode: {{ 'true' if auto_dark_mode else 'false' }},
                darkModeStart: '{{ dark_mode_start or "18:00" }}',
                darkModeEnd: '{{ dark_mode_end or "06:00" }}',
                fontSize: '{{ font_size or "normal" }}',
                highContrast: {{ 'true' if high_contrast_enabled else 'false' }},
                customColors: {{ custom_colors|tojson if custom_colors else '{}' }},
                customLightMode: {{ custom_light_mode|tojson if custom_light_mode else '{}' }},
                customDarkMode: {{ custom_dark_mode|tojson if custom_dark_mode else '{}' }},
                sectionStyles: {{ section_styles|tojson if section_styles else '{}' }},
                backgroundImage: {{ background_image|tojson if background_image else '{}' }}
            };
            
            themeManager.init(initialState);
            
            // Set up event listeners
            setupEventListeners();
            
            // Update UI to reflect current state
            updateUIFromState();
        });
        
        function setupEventListeners() {
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('change', (e) => {
                themeManager.updateSetting('root', 'darkMode', e.target.checked);
            });
            
            // Auto dark mode toggle
            document.getElementById('autoDarkModeToggle').addEventListener('change', (e) => {
                themeManager.updateSetting('root', 'autoDarkMode', e.target.checked);
                // Show/hide time settings
                const timeSettings = document.getElementById('autoModeTimeSettings');
                timeSettings.style.display = e.target.checked ? 'block' : 'none';
                // Update time display
                if (e.target.checked) {
                    themeManager.updateTimeDisplay();
                    startTimeUpdater();
                }
            });
            
            // Dark mode time settings
            document.getElementById('darkModeStart').addEventListener('change', (e) => {
                themeManager.updateSetting('root', 'darkModeStart', e.target.value);
                themeManager.updateTimeDisplay();
            });
            
            document.getElementById('darkModeEnd').addEventListener('change', (e) => {
                themeManager.updateSetting('root', 'darkModeEnd', e.target.value);
                themeManager.updateTimeDisplay();
            });
            
            // High contrast toggle
            document.getElementById('highContrastToggle').addEventListener('change', (e) => {
                themeManager.updateSetting('root', 'highContrast', e.target.checked);
            });
            
            // Custom color inputs
            setupColorInputListeners();
        }
        
        function setupColorInputListeners() {
            // Standard custom colors with correct field names
            const customColorInputs = {
                'customPrimary': 'primary',
                'customPrimaryHover': 'primary_hover',
                'customSecondary': 'secondary',
                'customSuccess': 'success',
                'customWarning': 'warning',
                'customDanger': 'danger',
                'customInfo': 'info'
            };
            
            Object.entries(customColorInputs).forEach(([inputId, colorKey]) => {
                const colorInput = document.getElementById(inputId);
                if (colorInput) {
                    colorInput.addEventListener('change', (e) => {
                        themeManager.updateSetting('customColors', colorKey, e.target.value);
                        
                        // Update corresponding text input
                        const textInput = colorInput.nextElementSibling;
                        if (textInput) textInput.value = e.target.value;
                    });
                    
                    // Also listen to text input changes
                    const textInput = colorInput.nextElementSibling;
                    if (textInput) {
                        textInput.addEventListener('change', (e) => {
                            if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
                                colorInput.value = e.target.value;
                                themeManager.updateSetting('customColors', colorKey, e.target.value);
                            }
                        });
                    }
                }
            });
            
            // Light mode colors with correct field names
            const lightModeInputs = {
                'customLightBgBody': 'bg_body',
                'customLightBgCard': 'bg_card',
                'customLightBgSurface': 'bg_surface',
                'customLightText': 'text',
                'customLightTextMuted': 'text_muted',
                'customLightBorder': 'border'
            };
            
            Object.entries(lightModeInputs).forEach(([inputId, colorKey]) => {
                const colorInput = document.getElementById(inputId);
                if (colorInput) {
                    colorInput.addEventListener('change', (e) => {
                        themeManager.updateSetting('customLightMode', colorKey, e.target.value);
                        
                        // Update corresponding text input
                        const textInput = colorInput.nextElementSibling;
                        if (textInput) textInput.value = e.target.value;
                    });
                    
                    // Also listen to text input changes
                    const textInput = colorInput.nextElementSibling;
                    if (textInput) {
                        textInput.addEventListener('change', (e) => {
                            if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
                                colorInput.value = e.target.value;
                                themeManager.updateSetting('customLightMode', colorKey, e.target.value);
                            }
                        });
                    }
                }
            });
            
            // Dark mode colors with correct field names
            const darkModeInputs = {
                'customDarkBgBody': 'bg_body',
                'customDarkBgCard': 'bg_card',
                'customDarkBgSurface': 'bg_surface',
                'customDarkText': 'text',
                'customDarkTextMuted': 'text_muted',
                'customDarkBorder': 'border'
            };
            
            Object.entries(darkModeInputs).forEach(([inputId, colorKey]) => {
                const colorInput = document.getElementById(inputId);
                if (colorInput) {
                    colorInput.addEventListener('change', (e) => {
                        themeManager.updateSetting('customDarkMode', colorKey, e.target.value);
                        
                        // Update corresponding text input
                        const textInput = colorInput.nextElementSibling;
                        if (textInput) textInput.value = e.target.value;
                    });
                    
                    // Also listen to text input changes
                    const textInput = colorInput.nextElementSibling;
                    if (textInput) {
                        textInput.addEventListener('change', (e) => {
                            if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
                                colorInput.value = e.target.value;
                                themeManager.updateSetting('customDarkMode', colorKey, e.target.value);
                            }
                        });
                    }
                }
            });
        }
        
        // Time updater functionality
        let timeUpdateInterval;
        
        function startTimeUpdater() {
            // Clear any existing interval
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
            }
            
            // Update immediately
            themeManager.updateTimeDisplay();
            
            // Update every minute
            timeUpdateInterval = setInterval(() => {
                themeManager.updateTimeDisplay();
            }, 60000);
        }
        
        function updateUIFromState() {
            // Update theme selection
            const currentTheme = themeManager.state.theme;
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.theme === currentTheme);
            });
            
            // Update toggle states
            document.getElementById('darkModeToggle').checked = themeManager.state.darkMode;
            document.getElementById('autoDarkModeToggle').checked = themeManager.state.autoDarkMode;
            document.getElementById('darkModeStart').value = themeManager.state.darkModeStart;
            document.getElementById('darkModeEnd').value = themeManager.state.darkModeEnd;
            
            // Show/hide time settings based on auto mode
            const timeSettings = document.getElementById('autoModeTimeSettings');
            timeSettings.style.display = themeManager.state.autoDarkMode ? 'block' : 'none';
            
            // Start time updater if auto mode is enabled
            if (themeManager.state.autoDarkMode) {
                startTimeUpdater();
            }
            
            // Update form controls
            const controls = {
                'sectionBorderStyle': themeManager.state.sectionStyles.borderStyle || 'none',
                'sectionSpacing': themeManager.state.sectionStyles.spacing || 'normal',
                'sectionBackground': themeManager.state.sectionStyles.background || 'subtle',
                'sectionAnimation': themeManager.state.sectionStyles.animation || 'none',
                'sectionEffect': themeManager.state.sectionStyles.effect || 'none',
                'sectionPattern': themeManager.state.sectionStyles.pattern || 'none',
                'sectionDecoration': themeManager.state.sectionStyles.decoration || 'none'
            };
            
            Object.entries(controls).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.value = value;
            });
            
            // Update color inputs
            updateColorInputs();
        }
        
        function updateColorInputs() {
            // Update custom colors with correct mapping
            const customColorMapping = {
                'primary': 'customPrimary',
                'primary_hover': 'customPrimaryHover',
                'secondary': 'customSecondary',
                'success': 'customSuccess',
                'warning': 'customWarning',
                'danger': 'customDanger',
                'info': 'customInfo'
            };
            
            Object.entries(themeManager.state.customColors).forEach(([key, value]) => {
                const inputId = customColorMapping[key];
                if (inputId) {
                    const colorInput = document.getElementById(inputId);
                    if (colorInput) {
                        colorInput.value = value;
                        const textInput = colorInput.nextElementSibling;
                        if (textInput) textInput.value = value;
                    }
                }
            });
            
            // Update light mode colors with correct mapping
            const lightModeMapping = {
                'bg_body': 'customLightBgBody',
                'bg_card': 'customLightBgCard',
                'bg_surface': 'customLightBgSurface',
                'text': 'customLightText',
                'text_muted': 'customLightTextMuted',
                'border': 'customLightBorder'
            };
            
            Object.entries(themeManager.state.customLightMode).forEach(([key, value]) => {
                const inputId = lightModeMapping[key];
                if (inputId) {
                    const colorInput = document.getElementById(inputId);
                    if (colorInput) {
                        colorInput.value = value;
                        const textInput = colorInput.nextElementSibling;
                        if (textInput) textInput.value = value;
                    }
                }
            });
            
            // Update dark mode colors with correct mapping
            const darkModeMapping = {
                'bg_body': 'customDarkBgBody',
                'bg_card': 'customDarkBgCard',
                'bg_surface': 'customDarkBgSurface',
                'text': 'customDarkText',
                'text_muted': 'customDarkTextMuted',
                'border': 'customDarkBorder'
            };
            
            Object.entries(themeManager.state.customDarkMode).forEach(([key, value]) => {
                const inputId = darkModeMapping[key];
                if (inputId) {
                    const colorInput = document.getElementById(inputId);
                    if (colorInput) {
                        colorInput.value = value;
                        const textInput = colorInput.nextElementSibling;
                        if (textInput) textInput.value = value;
                    }
                }
            });
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const content = section.querySelector('.collapsible-content');
            const icon = section.querySelector('.fas');
            
            section.classList.toggle('collapsed');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }
        
        async function saveThemeSettings() {
            const statusMsg = document.getElementById('statusMessage');
            
            try {
                const success = await themeManager.saveSettings();
                
                if (success) {
                    statusMsg.className = 'alert alert-success status-message';
                    statusMsg.textContent = 'Theme settings saved successfully!';
                    
                    // Notify global theme manager of settings change
                    if (window.parent && window.parent.globalThemeManager) {
                        await window.parent.globalThemeManager.refreshSettings();
                    } else if (window.globalThemeManager) {
                        await window.globalThemeManager.refreshSettings();
                    }
                } else {
                    statusMsg.className = 'alert alert-danger status-message';
                    statusMsg.textContent = 'Failed to save theme settings. Please try again.';
                }
                
                statusMsg.classList.remove('d-none');
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    statusMsg.classList.add('d-none');
                }, 3000);
                
            } catch (error) {
                statusMsg.className = 'alert alert-danger status-message';
                statusMsg.textContent = 'An error occurred while saving. Please try again.';
                statusMsg.classList.remove('d-none');
            }
        }
        
        function exportTheme() {
            const themeData = themeManager.exportSettings();
            const blob = new Blob([themeData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `theme-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Theme exported successfully!', 'success');
        }
        
        function importTheme(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const success = themeManager.importSettings(e.target.result);
                    if (success) {
                        updateUIFromState();
                        showMessage('Theme imported successfully!', 'success');
                    } else {
                        showMessage('Failed to import theme. Invalid file format.', 'danger');
                    }
                } catch (error) {
                    showMessage('Error importing theme: ' + error.message, 'danger');
                }
            };
            reader.readAsText(file);
        }
        
        function importThemeFromText() {
            const textArea = document.getElementById('themeImportText');
            const themeData = textArea.value.trim();
            
            if (!themeData) {
                showMessage('Please paste theme JSON data first.', 'warning');
                return;
            }
            
            try {
                const success = themeManager.importSettings(themeData);
                if (success) {
                    updateUIFromState();
                    textArea.value = '';
                    showMessage('Theme imported successfully!', 'success');
                } else {
                    showMessage('Failed to import theme. Invalid JSON format.', 'danger');
                }
            } catch (error) {
                showMessage('Error importing theme: ' + error.message, 'danger');
            }
        }
        
        function resetTheme() {
            if (confirm('Are you sure you want to reset all theme settings to defaults? This action cannot be undone.')) {
                themeManager.reset();
                updateUIFromState();
                showMessage('Theme settings reset to defaults.', 'info');
            }
        }
        
        function showMessage(message, type) {
            const statusMsg = document.getElementById('statusMessage');
            statusMsg.className = `alert alert-${type} status-message`;
            statusMsg.textContent = message;
            statusMsg.classList.remove('d-none');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusMsg.classList.add('d-none');
            }, 3000);
        }
        
        // Theme manager event listener for real-time updates
        themeManager.addEventListener('change', (category, key, value) => {
            // Update UI elements when theme manager state changes
            if (category === 'root' && key === 'theme') {
                updateUIFromState();
            }
        });

        // AI Theme Generation Functionality
        let currentGeneratedTheme = null;
        let conversationHistory = [];
        
        // Quick Action Function - Send predefined prompts
        async function sendQuickAction(prompt) {
            const messagesContainer = document.getElementById('aiChatMessages');
            
            // Add user message to chat
            addChatMessage('user', prompt);
            conversationHistory.push({role: 'user', content: prompt});
            
            // Show loading message
            const loadingId = Date.now();
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'ai-message assistant';
            loadingMsg.id = `loading-${loadingId}`;
            loadingMsg.innerHTML = `
                <div class="ai-message-avatar"><i class="fas fa-robot"></i></div>
                <div class="ai-message-content">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Thinking...
                </div>
            `;
            messagesContainer.appendChild(loadingMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: prompt,
                        conversation_history: conversationHistory,
                        context: 'theme_settings'
                    })
                });
                
                const data = await response.json();
                
                // Remove loading message
                loadingMsg.remove();
                
                if (data.success) {
                    // Add AI response
                    addChatMessage('assistant', data.response);
                    conversationHistory.push({role: 'assistant', content: data.response});
                } else {
                    addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                loadingMsg.remove();
                addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }
        
        function initAIThemeChat() {
            const input = document.getElementById('aiThemeInput');
            const generateBtn = document.getElementById('aiThemeGenerateBtn');
            const generateWallpaperBtn = document.getElementById('aiGenerateWallpaperBtn');
            const messagesContainer = document.getElementById('aiChatMessages');
            
            // Handle Enter key in input
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    generateTheme();
                }
            });
            
            // Handle generate button click
            generateBtn.addEventListener('click', generateTheme);
            
            // Handle generate wallpaper button click
            generateWallpaperBtn.addEventListener('click', generateWallpaper);
            
            // Handle clear chat button
            const clearBtn = document.getElementById('aiClearChatBtn');
            clearBtn.addEventListener('click', clearChat);
            
            function clearChat() {
                // Clear conversation history
                conversationHistory = [];
                
                // Clear chat messages (keep only the initial welcome message)
                const messagesContainer = document.getElementById('aiChatMessages');
                const initialMessage = messagesContainer.querySelector('.ai-message.assistant');
                messagesContainer.innerHTML = '';
                if (initialMessage) {
                    messagesContainer.appendChild(initialMessage);
                }
                
                // Clear any existing theme previews
                const existingPreview = document.querySelector('.ai-theme-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                currentGeneratedTheme = null;
            }
            
            async function generateTheme() {
                const description = input.value.trim();
                
                if (!description) {
                    showMessage('Please describe your ideal theme first.', 'warning');
                    return;
                }
                
                // Add user message to chat
                addChatMessage('user', description);
                conversationHistory.push({role: 'user', content: description});
                input.value = '';
                
                // Show loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
                input.classList.add('ai-generating');
                
                try {
                    const response = await fetch('/api/ai/chat_theme', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: description,
                            conversation_history: conversationHistory,
                            current_theme: themeManager.exportSettings()
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.response) {
                        const aiResponse = data.response;
                        console.log('AI Response:', aiResponse); // Debug logging
                        
                        if (aiResponse.type === 'theme' && aiResponse.colors) {
                            // It's a valid theme response
                            const responseText = `âœ¨ Created "${aiResponse.name}"! ${aiResponse.rationale || ''}`;
                            addChatMessage('assistant', responseText);
                            conversationHistory.push({role: 'assistant', content: `Generated theme: ${aiResponse.name}`});
                            
                            // Show theme preview
                            showThemePreview(aiResponse);
                            currentGeneratedTheme = aiResponse;
                            
                        } else if (aiResponse.type === 'message') {
                            // Fallback message response
                            const responseText = aiResponse.content || aiResponse;
                            addChatMessage('assistant', responseText);
                            conversationHistory.push({role: 'assistant', content: responseText});
                        } else {
                            // Handle malformed responses
                            console.error('Invalid theme response:', aiResponse);
                            addChatMessage('assistant', 'I created a theme but had trouble formatting it. Please try again with a clearer description.');
                            conversationHistory.push({role: 'assistant', content: 'Theme generation error'});
                        }
                        
                    } else {
                        console.error('API Error:', data);
                        const errorMsg = `Sorry, I couldn't generate a theme. ${data.error || 'Please try again.'}`;
                        addChatMessage('assistant', errorMsg);
                        conversationHistory.push({role: 'assistant', content: errorMsg});
                    }
                    
                } catch (error) {
                    console.error('AI Theme Chat Error:', error);
                    const errorMsg = 'Sorry, there was an error processing your request. Please try again.';
                    addChatMessage('assistant', errorMsg);
                    conversationHistory.push({role: 'assistant', content: errorMsg});
                } finally {
                    // Reset loading state
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
                    input.classList.remove('ai-generating');
                }
            }
            
            async function generateWallpaper() {
                const prompt = input.value.trim();
                
                if (!prompt) {
                    showMessage('Please describe the wallpaper you want to generate.', 'warning');
                    return;
                }
                
                // Add user message to chat
                addChatMessage('user', `Generate wallpaper: ${prompt}`);
                input.value = '';
                
                // Show loading state
                generateWallpaperBtn.disabled = true;
                generateWallpaperBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
                
                // Add loading message
                const loadingId = Date.now();
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'ai-message assistant';
                loadingMsg.id = `loading-${loadingId}`;
                loadingMsg.innerHTML = `
                    <div class="ai-message-avatar"><i class="fas fa-robot"></i></div>
                    <div class="ai-message-content">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Generating your wallpaper with AI... This may take 20-30 seconds.
                    </div>
                `;
                messagesContainer.appendChild(loadingMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                try {
                    // Enhance prompt for better wallpapers
                    const enhancedPrompt = `${prompt}, high resolution wallpaper, 16:9 aspect ratio, professional quality, suitable for application background, detailed, beautiful composition`;
                    const negativePrompt = 'blurry, low quality, distorted, ugly, text, watermark, logo, busy, cluttered';
                    
                    const response = await fetch('/api/ai/generate_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: enhancedPrompt,
                            negative_prompt: negativePrompt
                        })
                    });
                    
                    const data = await response.json();
                    
                    // Remove loading message
                    loadingMsg.remove();
                    
                    if (data.success) {
                        // Create wallpaper preview with apply button
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'ai-message assistant';
                        previewDiv.innerHTML = `
                            <div class="ai-message-avatar"><i class="fas fa-robot"></i></div>
                            <div class="ai-message-content">
                                <p><strong>âœ¨ Wallpaper Generated!</strong></p>
                                <div style="border: 2px solid var(--theme-border); border-radius: 8px; overflow: hidden; margin: 10px 0;">
                                    <img src="data:${data.content_type};base64,${data.image_data}" 
                                         style="width: 100%; height: auto; display: block;" 
                                         alt="Generated Wallpaper"
                                         id="generated-wallpaper-${loadingId}">
                                </div>
                                <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-success btn-sm apply-wallpaper-btn" data-image="${data.image_data}">
                                        <i class="fas fa-check me-1"></i>Apply as Background
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm download-wallpaper-btn" data-image="${data.image_data}">
                                        <i class="fas fa-download me-1"></i>Download
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="this.closest('.ai-message').remove()">
                                        <i class="fas fa-times me-1"></i>Dismiss
                                    </button>
                                </div>
                            </div>
                        `;
                        messagesContainer.appendChild(previewDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        // Attach event listeners to the buttons
                        const applyBtn = previewDiv.querySelector('.apply-wallpaper-btn');
                        const downloadBtn = previewDiv.querySelector('.download-wallpaper-btn');
                        
                        applyBtn.addEventListener('click', () => applyGeneratedWallpaper(data.image_data));
                        downloadBtn.addEventListener('click', () => downloadGeneratedWallpaper(data.image_data));
                        
                    } else {
                        addChatMessage('assistant', `âŒ Error generating wallpaper: ${data.error}`);
                    }
                    
                } catch (error) {
                    console.error('Wallpaper generation error:', error);
                    loadingMsg.remove();
                    addChatMessage('assistant', 'âŒ Failed to generate wallpaper. Please try again or check your Hugging Face API configuration in System Settings.');
                } finally {
                    // Reset button
                    generateWallpaperBtn.disabled = false;
                    generateWallpaperBtn.innerHTML = '<i class="fas fa-image me-1"></i>Generate Wallpaper';
                }
            }
            
            async function applyGeneratedWallpaper(imageData) {
                try {
                    showMessage('Applying wallpaper...', 'info');
                    
                    // Convert base64 to blob
                    const byteCharacters = atob(imageData);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'image/jpeg' });
                    
                    // Create file from blob
                    const file = new File([blob], `ai-wallpaper-${Date.now()}.jpg`, { type: 'image/jpeg' });
                    
                    // Upload using background manager
                    await backgroundManager.uploadBackground(file);
                    
                    // Show success message
                    showMessage('âœ… Wallpaper applied! Don\'t forget to save your theme settings.', 'success');
                    
                    // Scroll to background image section
                    document.getElementById('backgroundImageSection').scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Apply wallpaper error:', error);
                    showMessage('Failed to apply wallpaper', 'danger');
                }
            }
            
            function downloadGeneratedWallpaper(imageData) {
                try {
                    const link = document.createElement('a');
                    link.href = `data:image/jpeg;base64,${imageData}`;
                    link.download = `ai-wallpaper-${Date.now()}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showMessage('âœ… Wallpaper downloaded!', 'success');
                } catch (error) {
                    console.error('Download error:', error);
                    showMessage('Failed to download wallpaper', 'danger');
                }
            }
            
            function addChatMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${type}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'ai-message-avatar';
                avatar.innerHTML = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'ai-message-content';
                contentDiv.innerHTML = `<p>${content}</p>`;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            function showThemePreview(theme) {
                // Remove existing preview
                const existingPreview = document.querySelector('.ai-theme-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                // Create new preview
                const previewDiv = document.createElement('div');
                previewDiv.className = 'ai-theme-preview';
                
                let colorsHtml = '<div class="ai-color-palette">';
                if (theme.colors) {
                    Object.entries(theme.colors).forEach(([name, color]) => {
                        colorsHtml += `
                            <div class="ai-color-swatch" style="background-color: ${color}" title="${name}: ${color}">
                                <div class="color-label">${name}</div>
                            </div>
                        `;
                    });
                }
                colorsHtml += '</div>';
                
                previewDiv.innerHTML = `
                    <h6><i class="fas fa-eye me-2"></i>Theme Preview: ${theme.name}</h6>
                    <p class="text-muted">${theme.description || ''}</p>
                    ${colorsHtml}
                    <div class="d-flex gap-2">
                        <button class="btn btn-success btn-sm" onclick="applyGeneratedTheme()">
                            <i class="fas fa-check me-1"></i>Apply Theme
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="this.closest('.ai-theme-preview').remove()">
                            <i class="fas fa-times me-1"></i>Dismiss
                        </button>
                    </div>
                `;
                
                // Insert after the chat container
                const chatContainer = document.getElementById('aiThemeChat');
                chatContainer.parentNode.insertBefore(previewDiv, chatContainer.nextSibling);
                
                // Show with animation
                setTimeout(() => previewDiv.classList.add('show'), 10);
            }
        }
        
        function applyGeneratedTheme() {
            const theme = currentGeneratedTheme;
            if (!theme || !theme.colors) {
                showMessage('Invalid theme data', 'danger');
                return;
            }
            
            // Apply the generated colors to the theme manager
            if (theme.colors.primary) {
                themeManager.updateSetting('customColors', 'primary', theme.colors.primary);
            }
            if (theme.colors.secondary) {
                themeManager.updateSetting('customColors', 'secondary', theme.colors.secondary);
            }
            if (theme.colors.success) {
                themeManager.updateSetting('customColors', 'success', theme.colors.success);
            }
            if (theme.colors.warning) {
                themeManager.updateSetting('customColors', 'warning', theme.colors.warning);
            }
            if (theme.colors.danger) {
                themeManager.updateSetting('customColors', 'danger', theme.colors.danger);
            }
            if (theme.colors.info) {
                themeManager.updateSetting('customColors', 'info', theme.colors.info);
            }
            
            // Apply light mode colors if available
            if (theme.colors.background || theme.colors.surface || theme.colors.text) {
                if (theme.colors.background) {
                    themeManager.updateSetting('customLightMode', 'bg_body', theme.colors.background);
                }
                if (theme.colors.card_bg || theme.colors.surface) {
                    themeManager.updateSetting('customLightMode', 'bg_card', theme.colors.card_bg || theme.colors.surface);
                }
                if (theme.colors.surface) {
                    themeManager.updateSetting('customLightMode', 'bg_surface', theme.colors.surface);
                }
                if (theme.colors.text) {
                    themeManager.updateSetting('customLightMode', 'text', theme.colors.text);
                }
                if (theme.colors.text_secondary) {
                    themeManager.updateSetting('customLightMode', 'text_muted', theme.colors.text_secondary);
                }
                if (theme.colors.border) {
                    themeManager.updateSetting('customLightMode', 'border', theme.colors.border);
                }
            }
            
            // Apply dark mode colors if available
            if (theme.dark_mode_colors) {
                if (theme.dark_mode_colors.background) {
                    themeManager.updateSetting('customDarkMode', 'bg_body', theme.dark_mode_colors.background);
                }
                if (theme.dark_mode_colors.card_bg || theme.dark_mode_colors.surface) {
                    themeManager.updateSetting('customDarkMode', 'bg_card', theme.dark_mode_colors.card_bg || theme.dark_mode_colors.surface);
                }
                if (theme.dark_mode_colors.surface) {
                    themeManager.updateSetting('customDarkMode', 'bg_surface', theme.dark_mode_colors.surface);
                }
                if (theme.dark_mode_colors.text) {
                    themeManager.updateSetting('customDarkMode', 'text', theme.dark_mode_colors.text);
                }
                if (theme.dark_mode_colors.text_secondary) {
                    themeManager.updateSetting('customDarkMode', 'text_muted', theme.dark_mode_colors.text_secondary);
                }
                if (theme.dark_mode_colors.border) {
                    themeManager.updateSetting('customDarkMode', 'border', theme.dark_mode_colors.border);
                }
            }
            
            // Update UI to reflect changes
            updateUIFromState();
            
            // Remove the preview
            const preview = document.querySelector('.ai-theme-preview');
            if (preview) {
                preview.remove();
            }
            
            // Show success message
            showMessage(`Applied "${theme.name}" theme! Don't forget to save your settings.`, 'success');
        }
        
        // Background Image Manager
        const backgroundManager = {
            state: {
                enabled: false,
                url: '',
                opacity: 50,
                blur: 0,
                size: 'cover',
                position: 'center',
                parallax: false
            },
            
            init() {
                // Load current settings
                const bgImage = themeManager.state.backgroundImage || {};
                this.state = {
                    enabled: bgImage.enabled || false,
                    url: bgImage.url || '',
                    opacity: bgImage.opacity || 50,
                    blur: bgImage.blur || 0,
                    size: bgImage.size || 'cover',
                    position: bgImage.position || 'center',
                    parallax: bgImage.parallax || false
                };
                
                // Update UI
                this.updateUI();
            },
            
            updateUI() {
                document.getElementById('backgroundImageEnabled').checked = this.state.enabled;
                document.getElementById('backgroundOpacity').value = this.state.opacity;
                document.getElementById('backgroundBlur').value = this.state.blur;
                document.getElementById('backgroundSize').value = this.state.size;
                document.getElementById('backgroundPosition').value = this.state.position;
                document.getElementById('backgroundParallax').checked = this.state.parallax;
                
                document.getElementById('opacityValue').textContent = this.state.opacity;
                document.getElementById('blurValue').textContent = this.state.blur;
                
                const controls = document.getElementById('backgroundImageControls');
                if (this.state.enabled) {
                    controls.style.display = 'block';
                } else {
                    controls.style.display = 'none';
                }
                
                if (this.state.url) {
                    document.getElementById('currentBackgroundPreview').style.display = 'block';
                    document.getElementById('currentBackgroundImg').src = this.state.url;
                } else {
                    document.getElementById('currentBackgroundPreview').style.display = 'none';
                }
                
                // Update theme manager state
                themeManager.state.backgroundImage = {...this.state};
                themeManager.updatePreview();
            },
            
            toggleEnabled(enabled) {
                this.state.enabled = enabled;
                this.updateUI();
            },
            
            async uploadBackground(file) {
                if (!file) return;
                
                // Show loading
                showMessage('Uploading background image...', 'info');
                
                const formData = new FormData();
                formData.append('image', file);
                
                try {
                    const response = await fetch('/api/upload_background', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.state.url = data.url;
                        this.state.enabled = true;
                        this.updateUI();
                        showMessage('Background image uploaded successfully!', 'success');
                    } else {
                        showMessage(data.error || 'Upload failed', 'danger');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showMessage('Failed to upload image', 'danger');
                }
                
                // Clear file input
                document.getElementById('backgroundImageFile').value = '';
            },
            
            async removeBackground() {
                if (!this.state.url) return;
                
                if (!confirm('Are you sure you want to remove the background image?')) {
                    return;
                }
                
                const filename = this.state.url.split('/').pop();
                
                try {
                    const response = await fetch(`/api/delete_background/${filename}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.state.url = '';
                        this.state.enabled = false;
                        this.updateUI();
                        showMessage('Background image removed', 'success');
                    } else {
                        showMessage(data.error || 'Delete failed', 'warning');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    showMessage('Failed to remove image', 'danger');
                }
            },
            
            updateOpacity(value) {
                this.state.opacity = parseInt(value);
                document.getElementById('opacityValue').textContent = value;
                this.updateUI();
            },
            
            updateBlur(value) {
                this.state.blur = parseInt(value);
                document.getElementById('blurValue').textContent = value;
                this.updateUI();
            },
            
            updateSize(value) {
                this.state.size = value;
                this.updateUI();
            },
            
            updatePosition(value) {
                this.state.position = value;
                this.updateUI();
            },
            
            toggleParallax(enabled) {
                this.state.parallax = enabled;
                this.updateUI();
            }
        };

        // Initialize AI chat and background manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initAIThemeChat();
            backgroundManager.init();
        });
    </script>
    <script src="{{ url_for('static', filename='global-theme-manager.js') }}"></script>
    <!-- About Modal -->
    {% include 'components/about_modal.html' %}
</body>
</html>
