<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - Manage Relationship Definitions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ribbon.css') }}">
    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .container {
            margin-top: 30px;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid var(--bs-border-color);
        }
        .content-section {
            position: relative;
            overflow: hidden;
            background: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }
        .content-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
        }
        .form-control, .form-select {
            margin-bottom: 15px;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .action-buttons button {
            margin-right: 5px;
        }
        .btn-blue {
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
            border: none;
            color: white;
        }
        .btn-blue:hover {
            background: linear-gradient(135deg, #0a58ca, #5a359a);
            color: white;
        }
        .table-container {
            background: var(--bs-body-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--bs-border-color);
        }
        .table thead th {
            background: var(--bs-secondary-bg);
            border-bottom: 2px solid var(--bs-primary);
            color: var(--bs-body-color);
            font-weight: 600;
            letter-spacing: 0.3px;
            font-size: 0.9rem;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .status-icon {
            font-size: 1.1em;
        }
        .btn-spacing {
            margin-left: 1rem;
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                padding: 20px;
            }
            .modal-dialog {
                margin: 0.5rem;
            }
            .modal-body {
                padding: 1rem;
            }
            .header-actions {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            /* Improve form control spacing on mobile */
            .form-control, .form-select {
                margin-bottom: 12px;
                padding: 0.75rem;
                font-size: 1rem;
            }
            .form-check {
                margin-bottom: 1rem;
                padding: 12px;
                background: var(--bs-secondary-bg);
                border-radius: 8px;
                border: 1px solid var(--bs-border-color);
                display: flex !important;
                align-items: center !important; /* Vertically center content */
                min-height: 45px;
            }
            .form-check-input {
                margin-right: 12px;
                margin-top: 0; /* Reset margin for flex alignment */
                transform: scale(1.2);
                flex-shrink: 0; /* Prevent checkbox from shrinking */
            }
            .form-check-label {
                font-size: 1rem;
                line-height: 1.4;
                margin: 0; /* Reset margins for flex alignment */
                flex: 1; /* Take remaining space */
                display: flex;
                align-items: center; /* Vertically center text */
            }
            .form-text {
                font-size: 0.85rem;
                margin-top: 0.5rem;
            }
            /* Make form sections more spaced on mobile */
            .modal-body .mb-3 {
                margin-bottom: 1.25rem !important;
            }
            /* Better button spacing */
            .modal-body .btn {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
            /* Row spacing improvements */
            .modal-body .row.mb-3 {
                margin-bottom: 1.5rem !important;
            }
            .btn-spacing {
                margin-left: 0;
                margin-top: 0.5rem;
            }
            .table-container {
                font-size: 0.875rem;
                overflow-x: auto;
            }
            .table {
                table-layout: fixed;
                width: 100%;
            }
            .table th, .table td {
                padding: 0.375rem 0.125rem;
                font-size: 0.8rem;
            }
            .table th {
                white-space: normal;
                word-wrap: break-word;
                line-height: 1.2;
            }
            .action-buttons .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            /* Hide columns 2, 3, 4, 5 on mobile */
            .table th:nth-child(2),
            .table td:nth-child(2),
            .table th:nth-child(3),
            .table td:nth-child(3),
            .table th:nth-child(4),
            .table td:nth-child(4),
            .table th:nth-child(5),
            .table td:nth-child(5) {
                display: none;
            }
            /* Column width constraints for mobile */
            .table th:nth-child(1),
            .table td:nth-child(1) {
                width: 40%;
                max-width: 120px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            /* Make indicator columns very compact */
            .table th:nth-child(6),
            .table td:nth-child(6),
            .table th:nth-child(7),
            .table td:nth-child(7) {
                width: 15%;
                max-width: 40px;
                text-align: center;
                padding: 0.375rem 0.1rem;
            }
            /* Status icon styling like manage_entry_types */
            .status-icon {
                font-size: 1.1em;
            }
            /* Compact action column */
            .table th:nth-child(8),
            .table td:nth-child(8) {
                width: 30%;
                max-width: 80px;
                padding: 0.375rem 0.1rem;
            }
            /* Right-justify action buttons on mobile */
            .action-buttons {
                text-align: right;
            }
        }
    </style>
</head>
<body>
    <!-- Universal App Ribbon -->
    {% include 'components/ribbon.html' %}
    
    <div class="container">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1 class="mb-0">{{ project_name }} Relationship Definitions</h1>
            </div>
            <div class="header-actions">
                <button id="showAddRelationshipDefinitionModalBtn" class="btn btn-blue">
                    <i class="fas fa-plus me-1"></i>Add Definition
                </button>
            </div>
        </div>

        <div class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-primary">
                    <i class="fas fa-link me-2"></i>Relationship Definitions
                </h5>
            </div>

            <div class="table-container">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>From Type</th>
                            <th>To Type</th>
                            <th>From Label</th>
                            <th>To Label</th>
                            <th class="text-center">Qty / Unit</th>
                            <th class="text-center">Hierarchical</th>
                            <th class="text-center">Active</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="relationshipDefinitionsTableBody">
                    {% if relationship_definitions %}
                        {% for def in relationship_definitions %}
                            <tr data-id="{{ def.id }}">
                                <td><strong>{{ def.name }}</strong></td>
                                <td><span class="badge bg-info text-white">{{ def.entry_type_from_label }}</span> <small class="text-muted">({{ def.cardinality_from }})</small></td>
                                <td><span class="badge bg-success text-white">{{ def.entry_type_to_label }}</span> <small class="text-muted">({{ def.cardinality_to }})</small></td>
                                <td>{{ def.label_from_side }}</td>
                                <td>{{ def.label_to_side }}</td>
                                <td class="text-center">
                                    {% if def.allow_quantity_unit %}
                                        <i class="fas fa-check-circle status-icon text-success" title="Allows Qty / Unit"></i>
                                    {% else %}
                                        <i class="fas fa-times-circle status-icon text-muted" title="No Qty / Unit"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if def.is_hierarchical %}
                                        <i class="fas fa-sitemap status-icon text-primary" title="Hierarchical (Parent-Child)"></i>
                                    {% else %}
                                        <i class="fas fa-times-circle status-icon text-muted" title="Not Hierarchical"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if def.is_active %}
                                        <i class="fas fa-toggle-on status-icon text-success" title="Active"></i>
                                    {% else %}
                                        <i class="fas fa-toggle-off status-icon text-muted" title="Inactive"></i>
                                    {% endif %}
                                </td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-outline-primary edit-relationship-definition-btn"
                                            data-id="{{ def.id }}"
                                            data-name="{{ def.name }}"
                                            data-description="{{ def.description or ''}}"
                                            data-entry-type-id-from="{{ def.entry_type_id_from }}"
                                            data-entry-type-id-to="{{ def.entry_type_id_to }}"
                                            data-cardinality-from="{{ def.cardinality_from }}"
                                            data-cardinality-to="{{ def.cardinality_to }}"
                                            data-label-from-side="{{ def.label_from_side }}"
                                            data-label-to-side="{{ def.label_to_side }}"
                                            data-allow-quantity-unit="{{ def.allow_quantity_unit | int }}"
                                            data-is-hierarchical="{{ def.is_hierarchical | int }}"
                                            data-hierarchy-direction="{{ def.hierarchy_direction or 'from_to_child' }}"
                                            data-is-active="{{ def.is_active | int }}"
                                            title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-relationship-definition-btn ms-1" 
                                            data-id="{{ def.id }}"
                                            title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-link fa-2x mb-2 d-block text-muted opacity-50"></i>
                                No relationship definitions defined yet.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Relationship Definition Modal -->
    <div class="modal fade" id="relationshipDefinitionModal" tabindex="-1" aria-labelledby="relationshipDefinitionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="relationshipDefinitionModalLabel">Add/Edit Relationship Definition</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="relationshipDefinitionForm">
                        <input type="hidden" id="definitionId">
                        <div class="mb-3">
                            <label for="definitionName" class="form-label">Definition Name: <small class="text-muted">(auto-generated)</small></label>
                            <input type="text" class="form-control" id="definitionName" required readonly placeholder="Will be generated automatically..." style="background-color: #f8f9fa;">
                            <div class="form-text">Automatically generated based on selected entry types and cardinality.</div>
                        </div>
                        <div class="mb-3">
                            <label for="definitionDescription" class="form-label">Description:</label>
                            <textarea class="form-control" id="definitionDescription" rows="2" placeholder="Describe how these entry types are related..."></textarea>
                            <div class="form-text">Optional description of this relationship for documentation purposes.</div>
                        </div>
                        <div class="mb-3">
                            <label for="entryTypeFrom" class="form-label">From Entry Type:</label>
                            <select class="form-select" id="entryTypeFrom" required>
                                {% for type_option in entry_types %}
                                    <option value="{{ type_option.id }}">{{ type_option.singular_label }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">The entry type that will contain/own the related items.</div>
                        </div>
                        <div class="mb-3">
                            <label for="entryTypeTo" class="form-label">To Entry Type:</label>
                            <select class="form-select" id="entryTypeTo" required>
                                {% for type_option in entry_types %}
                                    <option value="{{ type_option.id }}">{{ type_option.singular_label }}</option> {# Corrected: changed singular_option back to singular_label #}
                                {% endfor %}
                            </select>
                            <div class="form-text">The entry type that will be contained/owned by the From entry type.</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="cardinalityFrom" class="form-label">Cardinality (From side):</label>
                                <select class="form-select" id="cardinalityFrom" required>
                                    <option value="one">One</option>
                                    <option value="many">Many</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="cardinalityTo" class="form-label">Cardinality (To side):</label>
                                <select class="form-select" id="cardinalityTo" required>
                                    <option value="one">One</option>
                                    <option value="many">Many</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="labelFromSide" class="form-label">Display Label (From Side):</label>
                            <input type="text" class="form-control" id="labelFromSide" required placeholder="e.g., 'Ingredients', 'Components', 'Parent Batches'">
                            <div class="form-text">This will be shown as the section header when viewing the "From" entry type. Describe what the related items are from this perspective.</div>
                        </div>
                        <div class="mb-3">
                            <label for="labelToSide" class="form-label">Display Label (To Side):</label>
                            <input type="text" class="form-control" id="labelToSide" required placeholder="e.g., 'Used In', 'Part Of', 'Child Batches'">
                            <div class="form-text">This will be shown as the section header when viewing the "To" entry type. Describe what the related items are from this perspective.</div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="allowQuantityUnit">
                            <label class="form-check-label" for="allowQuantityUnit">
                                Allow Quantity and Unit
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isHierarchical">
                            <label class="form-check-label" for="isHierarchical">
                                Hierarchical Relationship (Parent-Child)
                            </label>
                            <div class="form-text">Enable this to show this relationship in the hierarchy tree view. Use for parent-child, contains, or has-part relationships.</div>
                        </div>
                        <div class="mb-3" id="hierarchyDirectionContainer" style="display: none;">
                            <label for="hierarchyDirection" class="form-label">Hierarchy Direction:</label>
                            <select class="form-select" id="hierarchyDirection">
                                <option value="from_to_child">From side is Parent → To side is Child</option>
                                <option value="to_from_child">To side is Parent → From side is Child</option>
                            </select>
                            <div class="form-text">Specify which side of the relationship represents the parent (higher in hierarchy) and which represents the child (lower in hierarchy).</div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isActive" checked>
                            <label class="form-check-label" for="isActive">
                                Is Active
                            </label>
                        </div>
                        <button type="submit" class="btn btn-blue w-100">Save Definition</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements with null checks
            const relationshipDefinitionModal = document.getElementById('relationshipDefinitionModal') ? 
                new bootstrap.Modal(document.getElementById('relationshipDefinitionModal')) : null;
            const relationshipDefinitionForm = document.getElementById('relationshipDefinitionForm');
            
            // Check if required elements exist
            if (!relationshipDefinitionModal || !relationshipDefinitionForm) {
                console.error('Required modal elements not found');
                return;
            }

            // Get other DOM elements
            const elements = {
                definitionId: document.getElementById('definitionId'),
                definitionName: document.getElementById('definitionName'),
                definitionDescription: document.getElementById('definitionDescription'),
                entryTypeFrom: document.getElementById('entryTypeFrom'),
                entryTypeTo: document.getElementById('entryTypeTo'),
                cardinalityFrom: document.getElementById('cardinalityFrom'),
                cardinalityTo: document.getElementById('cardinalityTo'),
                labelFromSide: document.getElementById('labelFromSide'),
                labelToSide: document.getElementById('labelToSide'),
                allowQuantityUnit: document.getElementById('allowQuantityUnit'),
                isHierarchical: document.getElementById('isHierarchical'),
                hierarchyDirection: document.getElementById('hierarchyDirection'),
                hierarchyDirectionContainer: document.getElementById('hierarchyDirectionContainer'),
                isActive: document.getElementById('isActive'),
                addButton: document.getElementById('showAddRelationshipDefinitionModalBtn'),
                tableBody: document.getElementById('relationshipDefinitionsTableBody')
            };

            // Verify all elements exist
            for (const [key, element] of Object.entries(elements)) {
                if (!element) {
                    console.error(`Required element '${key}' not found`);
                    return;
                }
            }

            // Function to automatically generate definition name
            function generateDefinitionName() {
                const fromSelect = elements.entryTypeFrom;
                const toSelect = elements.entryTypeTo;
                const fromCardinality = elements.cardinalityFrom.value;
                const toCardinality = elements.cardinalityTo.value;
                
                if (fromSelect.value && toSelect.value && fromCardinality && toCardinality) {
                    const fromText = fromSelect.options[fromSelect.selectedIndex].text;
                    const toText = toSelect.options[toSelect.selectedIndex].text;
                    
                    // Generate name based on cardinality pattern
                    let cardinalityPattern = '';
                    if (fromCardinality === 'one' && toCardinality === 'one') {
                        cardinalityPattern = '1:1';
                    } else if (fromCardinality === 'one' && toCardinality === 'many') {
                        cardinalityPattern = '1:N';
                    } else if (fromCardinality === 'many' && toCardinality === 'one') {
                        cardinalityPattern = 'N:1';
                    } else {
                        cardinalityPattern = 'N:N';
                    }
                    
                    // Create systematic name: FromType_ToType_Pattern
                    const generatedName = `${fromText}_${toText}_${cardinalityPattern}`;
                    elements.definitionName.value = generatedName;
                }
            }

            // Add event listeners to auto-generate name when selections change
            elements.entryTypeFrom.addEventListener('change', generateDefinitionName);
            elements.entryTypeTo.addEventListener('change', generateDefinitionName);
            elements.cardinalityFrom.addEventListener('change', generateDefinitionName);
            elements.cardinalityTo.addEventListener('change', generateDefinitionName);

            // Function to fetch and display relationship definitions
            function fetchRelationshipDefinitions() {
                fetch('/api/relationship_definitions')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const tableBody = document.getElementById('relationshipDefinitionsTableBody');
                        tableBody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No relationship definitions found.</td></tr>';
                            return;
                        }

                        data.forEach(def => {
                            const row = document.createElement('tr');
                            row.dataset.id = def.id;
                            
                            row.innerHTML = `
                                <td>${def.name}</td>
                                <td>${def.entry_type_from_label} (${def.cardinality_from})</td>
                                <td>${def.entry_type_to_label} (${def.cardinality_to})</td>
                                <td>${def.label_from_side}</td>
                                <td>${def.label_to_side}</td>
                                <td class="text-center">
                                    ${def.allow_quantity_unit ? 
                                        '<i class="fas fa-check-circle status-icon text-success" title="Allows Qty / Unit"></i>' : 
                                        '<i class="fas fa-times-circle status-icon text-muted" title="No Qty / Unit"></i>'}
                                </td>
                                <td class="text-center">
                                    ${def.is_hierarchical ? 
                                        '<i class="fas fa-sitemap status-icon text-primary" title="Hierarchical (Parent-Child)"></i>' : 
                                        '<i class="fas fa-times-circle status-icon text-muted" title="Not Hierarchical"></i>'}
                                </td>
                                <td class="text-center">
                                    ${def.is_active ? 
                                        '<i class="fas fa-toggle-on status-icon text-success" title="Active"></i>' : 
                                        '<i class="fas fa-toggle-off status-icon text-muted" title="Inactive"></i>'}
                                </td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-outline-primary edit-relationship-definition-btn"
                                            data-id="${def.id}"
                                            data-name="${def.name}"
                                            data-description="${def.description || ''}"
                                            data-entry-type-id-from="${def.entry_type_id_from}"
                                            data-entry-type-id-to="${def.entry_type_id_to}"
                                            data-cardinality-from="${def.cardinality_from === 1 ? 'one' : 'many'}"
                                            data-cardinality-to="${def.cardinality_to === 1 ? 'one' : 'many'}"
                                            data-label-from-side="${def.label_from_side}"
                                            data-label-to-side="${def.label_to_side}"
                                            data-allow-quantity-unit="${def.allow_quantity_unit ? 1 : 0}"
                                            data-is-hierarchical="${def.is_hierarchical ? 1 : 0}"
                                            data-hierarchy-direction="${def.hierarchy_direction || 'from_to_child'}"
                                            data-is-active="${def.is_active ? 1 : 0}"
                                            title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-relationship-definition-btn ms-1" 
                                            data-id="${def.id}"
                                            title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Attach event listeners to the newly added buttons
                        attachEventListeners();
                    })
                    .catch(error => {
                        console.error('Error loading relationship definitions:', error);
                        document.getElementById('relationshipDefinitionsTableBody').innerHTML = 
                            '<tr><td colspan="8" class="text-center text-danger">Failed to load relationship definitions. Please try again.</td></tr>';
                    });
            }

            // Function to attach event listeners to dynamic elements
            function attachEventListeners() {
                // Handle Edit Buttons
                document.querySelectorAll('.edit-relationship-definition-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        document.getElementById('relationshipDefinitionModalLabel').textContent = 'Edit Relationship Definition';
                        elements.definitionId.value = this.dataset.id;
                        elements.definitionName.value = this.dataset.name;
                        elements.definitionDescription.value = this.dataset.description;
                        elements.entryTypeFrom.value = this.dataset.entryTypeIdFrom;
                        elements.entryTypeTo.value = this.dataset.entryTypeIdTo;
                        elements.cardinalityFrom.value = this.dataset.cardinalityFrom;
                        elements.cardinalityTo.value = this.dataset.cardinalityTo;
                        elements.labelFromSide.value = this.dataset.labelFromSide;
                        elements.labelToSide.value = this.dataset.labelToSide;
                        elements.allowQuantityUnit.checked = (this.dataset.allowQuantityUnit === '1');
                        elements.isHierarchical.checked = (this.dataset.isHierarchical === '1');
                        elements.hierarchyDirection.value = this.dataset.hierarchyDirection || 'from_to_child';
                        elements.hierarchyDirectionContainer.style.display = elements.isHierarchical.checked ? 'block' : 'none';
                        elements.isActive.checked = (this.dataset.isActive === '1');
                        elements.definitionName.readOnly = true;
                        relationshipDefinitionModal.show();
                    });
                });

                // Handle Delete Buttons
                document.querySelectorAll('.delete-relationship-definition-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const definitionId = this.dataset.id;
                        if (confirm('Are you sure you want to delete this Relationship Definition? This will fail if there are any existing entry relationships using it.')) {
                            fetch(`/api/relationship_definitions/${definitionId}`, {
                                method: 'DELETE',
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message) {
                                    fetchRelationshipDefinitions();
                                } else if (data.error) {
                                    alert('Error: ' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An unexpected error occurred during deletion.');
                            });
                        }
                    });
                });
            }

            // Toggle hierarchy direction dropdown based on hierarchical checkbox
            elements.isHierarchical.addEventListener('change', function() {
                if (this.checked) {
                    elements.hierarchyDirectionContainer.style.display = 'block';
                } else {
                    elements.hierarchyDirectionContainer.style.display = 'none';
                }
            });

            // Add New Definition button listener
            elements.addButton.addEventListener('click', function() {
                elements.definitionId.value = '';
                relationshipDefinitionForm.reset();
                elements.definitionName.readOnly = true; // Keep readonly for auto-generation
                elements.definitionName.value = ''; // Clear the field
                document.getElementById('relationshipDefinitionModalLabel').textContent = 'Add New Relationship Definition';
                elements.isActive.checked = true;
                elements.hierarchyDirectionContainer.style.display = 'none'; // Hide direction by default
                relationshipDefinitionModal.show();
            });

            // Form submission handler
            relationshipDefinitionForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const id = elements.definitionId.value;
                const method = id ? 'PATCH' : 'POST';
                const url = id ? `/api/relationship_definitions/${id}` : '/api/relationship_definitions';

                const data = {
                    name: elements.definitionName.value,
                    description: elements.definitionDescription.value,
                    entry_type_id_from: elements.entryTypeFrom.value,
                    entry_type_id_to: elements.entryTypeTo.value,
                    cardinality_from: elements.cardinalityFrom.value,
                    cardinality_to: elements.cardinalityTo.value,
                    label_from_side: elements.labelFromSide.value,
                    label_to_side: elements.labelToSide.value,
                    allow_quantity_unit: elements.allowQuantityUnit.checked ? 1 : 0,
                    is_hierarchical: elements.isHierarchical.checked ? 1 : 0,
                    hierarchy_direction: elements.hierarchyDirection.value,
                    is_active: elements.isActive.checked ? 1 : 0
                };

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        relationshipDefinitionModal.hide();
                        fetchRelationshipDefinitions();
                    } else if (data.error) {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                });
            });

            // Initial fetch when the page loads
            fetchRelationshipDefinitions();
        });
    </script>

    <!-- About Modal -->
    {% include 'components/about_modal.html' %}
</body>
</html>