<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Master Control - {{ project_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ribbon.css') }}">
    
    <!-- Chart.js for Serial Plotter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

    <!-- Dynamic Theme CSS -->
    <style id="theme-styles">
        {{ theme_css|safe }}
    </style>
    
<style>
    :root {
        --content-spacing: 1.5rem;
        --border-radius: 0.5rem;
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    body {
        background-color: var(--theme-bg-body, var(--bs-body-bg));
        color: var(--theme-text, var(--bs-body-color));
    }

    .container-fluid {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    /* Status Badges */
    .master-status-badge {
        padding: 0.35rem 0.65rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .master-status-active {
        background-color: var(--bs-success-bg-subtle);
        color: var(--bs-success-text-emphasis);
        border: 1px solid var(--bs-success-border-subtle);
    }
    
    .master-status-inactive {
        background-color: var(--bs-danger-bg-subtle);
        color: var(--bs-danger-text-emphasis);
        border: 1px solid var(--bs-danger-border-subtle);
    }
    
    /* Sensor Status Icons */
    .sensor-status-online {
        color: var(--bs-success);
    }
    
    .sensor-status-offline {
        color: var(--bs-danger);
    }
    
    .sensor-status-pending {
        color: var(--bs-warning);
    }

    .sensor-status-hibernating {
        color: var(--bs-warning);
    }
    
    /* Config Viewer */
    .config-viewer {
        background-color: var(--theme-bg-surface, var(--bs-tertiary-bg));
        border: 1px solid var(--theme-border, var(--bs-border-color));
        border-radius: var(--border-radius);
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .config-viewer pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: var(--theme-text, var,--bs-body-color);
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
    }
    
    /* Stat Cards */
    .stat-card {
        border-left: 4px solid var(--theme-primary, var,--bs-primary);
        background: var(--theme-bg-card, var,--bs-body-bg);
        border: 1px solid var(--theme-border, var,--bs-border-color);
        border-left: 4px solid var(--theme-primary, var,--bs-primary);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px -2px rgb(0 0 0 / 0.15);
    }
    
    .stat-card.success {
        border-left-color: var(--bs-success);
    }
    
    .stat-card.danger {
        border-left-color: var(--bs-danger);
    }
    
    .stat-card.warning {
        border-left-color: var(--bs-warning);
    }

    .stat-card .card-body h3 {
        color: var(--theme-primary, var,--bs-primary);
    }

    .stat-card.success .card-body h3 {
        color: var(--bs-success);
    }

    .stat-card.danger .card-body h3 {
        color: var(--bs-danger);
    }

    .stat-card.warning .card-body h3 {
        color: var(--bs-warning);
    }
    
    /* Cards */
    .card {
        background: var(--theme-bg-card, var,--bs-body-bg);
        border: 1px solid var(--theme-border, var (--bs-border-color));
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
    }

    .card-header {
        background: var(--theme-bg-surface, var (--bs-secondary-bg));
        border-bottom: 1px solid var(--theme-border, var (--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .card-body {
        background: var(--theme-bg-card, var,--bs-body-bg));
    }
    
    /* List Items */
    .sensor-list-item {
        transition: all 0.2s;
    }
    
    .sensor-list-item:hover {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        transform: translateX(2px);
    }

    /* Tables */
    .table {
        color: var(--theme-text, var,--bs-body-color));
    }

    .table thead th {
        background: var(--theme-bg-surface, var,--bs-secondary-bg));
        border-color: var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .table tbody tr {
        border-color: var(--theme-border, var,--bs-border-color));
    }

    .table-hover tbody tr:hover {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
    }

    /* Modals */
    .modal-content {
        background: var(--theme-bg-card, var,--bs-body-bg));
        border: 1px solid var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .modal-header {
        border-bottom: 1px solid var(--theme-border, var,--bs-border-color));
    }

    .modal-footer {
        border-top: 1px solid var(--theme-border, var,--bs-border-color));
    }

    /* Form Controls */
    .form-control, .form-select {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        border-color: var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .form-control:focus, .form-select:focus {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        border-color: var(--theme-primary, var,--bs-primary));
        color: var(--theme-text, var,--bs-body-color));
    }

    /* Empty States */
    .text-center.py-4.text-muted {
        color: var(--theme-text-muted, var,--bs-secondary-color)) !important;
    }

    /* Page Header */
    h1 {
        color: var(--theme-text, var,--bs-body-color));
        margin-bottom: 0;
    }

    /* Badges */
    .badge {
        font-weight: 500;
    }

    /* Buttons - Ensure they respect theme colors */
    .btn-primary {
        background-color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
        color: #fff;
    }

    .btn-primary:hover,
    .btn-primary:focus,
    .btn-primary:active {
        background-color: var(--theme-primary-dark, var,--bs-primary));
        border-color: var(--theme-primary-dark, var,--bs-primary));
        color: #fff;
        opacity: 0.9;
    }

    .btn-outline-primary {
        color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
    }

    .btn-outline-primary:hover,
    .btn-outline-primary:focus,
    .btn-outline-primary:active {
        background-color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
        color: #fff;
    }

    @media (max-width: 768px) {
        /* Header adjustments */
        .d-flex.justify-content-between.align-items-center.mb-4 {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 1rem;
        }
        
        .d-flex.justify-content-between.align-items-center.mb-4 > div {
            width: 100%;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .d-flex.justify-content-between.align-items-center.mb-4 > div > button {
            flex: 1;
        }

        /* Table to Card transformation */
        .table-responsive table, 
        .table-responsive thead, 
        .table-responsive tbody, 
        .table-responsive th, 
        .table-responsive td, 
        .table-responsive tr { 
            display: block; 
        }
        
        .table-responsive thead tr { 
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
        
        .table-responsive tr { 
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            background: var(--theme-bg-card, var(--bs-body-bg));
            padding: 1rem;
        }
        
        .table-responsive td { 
            border: none;
            position: relative;
            padding-left: 0;
            padding-right: 0;
            padding-top: 1rem; /* Increased padding */
            padding-bottom: 1rem; /* Increased padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: right;
            border-bottom: 1px solid var(--theme-border, var(--bs-border-color));
            font-size: 1.1rem; /* Increased font size for readability */
        }

        .table-responsive td:last-child {
            border-bottom: none;
        }
        
        .table-responsive td:before { 
            content: attr(data-label);
            font-weight: 700; /* Make label bolder */
            margin-right: 1rem;
            text-align: left;
            color: var(--theme-text, var (--bs-body-color)); /* Use main text color for better contrast */
            opacity: 0.9; /* Increased opacity */
            font-size: 1rem; /* Increased font size */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Specific adjustments for the Actions column */
        .table-responsive td:last-child {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .table-responsive td:last-child > div {
            width: 100%;
            justify-content: flex-end;
        }

        /* Stat Card Mobile Overrides */
        .stat-card .card-body {
            padding: 0.75rem !important;
        }
        
        .stat-card h3 {
            font-size: 1.5rem !important;
        }
        
        .stat-card h6 {
            font-size: 0.8rem !important;
            letter-spacing: 0.5px;
        }
        
        .stat-card i {
            font-size: 1.2rem !important;
            margin-bottom: 0.25rem !important;
        }

        /* Force 2-column grid for stats on mobile */
        #statsContainer {
            display: flex !important;
            flex-wrap: wrap !important;
            flex-direction: row !important;
        }
        
        #statsContainer .col-6 {
            width: 50% !important;
            flex: 0 0 50% !important;
            max-width: 50% !important;
        }
    }
</style>
</head>
<body>
    <!-- Universal App Ribbon -->
    {% include 'components/ribbon.html' %}
    
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-broadcast-tower"></i> Sensor Master Control</h1>
        <div>
            <button class="btn btn-success" onclick="showAddDeviceModal()">
                <i class="fas fa-plus"></i> Add Device
            </button>
            <button class="btn btn-info" onclick="showCodeExportModal()">
                <i class="fas fa-code"></i> Export ESP32 Code
            </button>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4 g-3" id="statsContainer">
        <div class="col-6 col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center p-3">
                    <div class="text-muted mb-2"><i class="fas fa-microchip fa-lg"></i></div>
                    <h6 class="text-muted small text-uppercase mb-1">Total</h6>
                    <h3 id="stat-total-sensors" class="mb-0 fw-bold">-</h3>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card success h-100">
                <div class="card-body text-center p-3">
                    <div class="text-success mb-2"><i class="fas fa-check-circle fa-lg"></i></div>
                    <h6 class="text-muted small text-uppercase mb-1">Online</h6>
                    <h3 id="stat-online-sensors" class="text-success mb-0 fw-bold">-</h3>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card danger h-100">
                <div class="card-body text-center p-3">
                    <div class="text-danger mb-2"><i class="fas fa-times-circle fa-lg"></i></div>
                    <h6 class="text-muted small text-uppercase mb-1">Offline</h6>
                    <h3 id="stat-offline-sensors" class="text-danger mb-0 fw-bold">-</h3>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card warning h-100">
                <div class="card-body text-center p-3">
                    <div class="text-warning mb-2"><i class="fas fa-clock fa-lg"></i></div>
                    <h6 class="text-muted small text-uppercase mb-1">Hibernating</h6>
                    <h3 id="stat-pending-sensors" class="text-warning mb-0 fw-bold">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Registered Sensors -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-microchip"></i> Registered Sensors</h5>
            <div>
                <select class="form-select form-select-sm" id="statusFilter" onchange="loadSensors()">
                    <option value="">All Status</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                    <option value="hibernating">Hibernating</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="sensorsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sensor Scripts Library -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-file-code"></i> Sensor Scripts Library</h5>
            <div>
                <button class="btn btn-sm btn-info me-2" onclick="showUploadToManyModal()">
                    <i class="fas fa-tasks"></i> Upload to Many
                </button>
                <button class="btn btn-sm btn-success" onclick="showUploadScriptModal()">
                    <i class="fas fa-plus"></i> Upload New Script
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Script Management:</strong> Upload Arduino or MicroPython scripts here. Once uploaded, assign them to specific sensors in the Script Assignments section below.
            </div>
            <div id="scriptsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>





<!-- Sensor Detail Modal -->
<div class="modal fade" id="sensorDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sensor Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sensorDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- ESP32 Code Export Modal -->
<div class="modal fade" id="codeExportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-code"></i> Export ESP32 Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Sensor (Optional)</label>
                        <select class="form-select" id="exportSensorId">
                            <option value="">Generate New Template</option>
                        </select>
                        <small class="text-muted">Select an existing sensor or leave blank for template</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sensor Type</label>
                        <input type="text" class="form-control" id="exportSensorType" 
                               value="esp32_fermentation" placeholder="esp32_fermentation">
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label">Language <span class="text-danger">*</span></label>
                        <select class="form-select" id="exportLanguage">
                            <option value="arduino">Arduino C++</option>
                            <option value="micropython">MicroPython</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">WiFi SSID</label>
                        <input type="text" class="form-control" id="exportWifiSsid" 
                               placeholder="Your WiFi Name">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">WiFi Password</label>
                        <input type="password" class="form-control" id="exportWifiPassword" 
                               placeholder="Your WiFi Password">
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Generated Code Features:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>OFFLINE MODE</strong>: Runs independently when master control is unavailable</li>
                        <li><strong>ONLINE MODE</strong>: Full integration with master control for remote configuration</li>
                        <li>Automatic retry and fallback mechanisms</li>
                        <li>Persistent configuration storage</li>
                        <li>Customizable sensor reading sections</li>
                    </ul>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Generated Code</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyCodeToClipboard()">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="downloadCode()">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                
                <div id="codeExportLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating code...</span>
                    </div>
                    <p class="mt-3">Generating ESP32 code...</p>
                </div>
                
                <div id="codeExportResult" style="display: none;">
                    <div class="config-viewer" style="max-height: 600px;">
                        <pre id="generatedCode"></pre>
                    </div>
                </div>
                
                <div id="codeExportError" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="codeExportErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="generateCode()">
                    <i class="fas fa-magic"></i> Generate Code
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Script Modal -->
<div class="modal fade" id="uploadScriptModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create Library Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Script Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="scriptName" placeholder="e.g., Standard Blink" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Script Version</label>
                        <input type="text" class="form-control" id="scriptVersion" value="1.0.0" placeholder="1.0.0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Script Type</label>
                        <select class="form-select" id="scriptType">
                            <option value="json">JSON Logic</option>
                            <option value="arduino">Arduino C++</option>
                            <option value="micropython">MicroPython</option>
                            <option value="snippet">Code Snippet</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Description (Optional)</label>
                    <input type="text" class="form-control" id="scriptDescription" 
                           placeholder="e.g., LED blink pattern update">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Target Sensor Type (Optional)</label>
                    <input type="text" class="form-control" id="scriptTargetType" 
                           placeholder="e.g., esp32_fermentation">
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Library Script:</strong> This script will be saved to the library and can be assigned to multiple sensors later.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Script Content (JSON Commands) <span class="text-danger">*</span></label>
                    <textarea class="form-control font-monospace" id="scriptContent" rows="15" 
                              placeholder='{
  "name": "LED Blink Pattern",
  "version": "1.0.0",
  "actions": [
    {"type": "gpio_write", "pin": 2, "value": "HIGH"},
    {"type": "delay", "ms": 1000},
    {"type": "gpio_write", "pin": 2, "value": "LOW"},
    {"type": "delay", "ms": 1000},
    {"type": "read_temperature"},
    {"type": "log", "message": "Pattern complete"}
  ]
}'></textarea>
                    <small class="text-muted">
                        <strong>JSON Command System:</strong> ESP32 interprets these commands at runtime. 
                        Available actions: <code>gpio_write</code>, <code>gpio_read</code>, <code>analog_read</code>, 
                        <code>read_temperature</code>, <code>set_relay</code>, <code>delay</code>, <code>log</code>
                    </small>
                </div>
                
                <div id="scriptUploadResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadScript()">
                    <i class="fas fa-save"></i> Save to Library
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Script Modal -->
<div class="modal fade" id="assignScriptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-link"></i> Assign Script to Sensor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Assigning script: <strong id="assignScriptName"></strong></p>
                
                <div class="mb-3">
                    <label class="form-label">Select Sensor <span class="text-danger">*</span></label>
                    <select class="form-select" id="assignSensorId" required>
                        <option value="">Choose a sensor...</option>
                    </select>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Note:</strong> This will replace any currently active script on the selected sensor.
                </div>
                
                <div id="assignScriptResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAssignScriptModal()">
                    <i class="fas fa-check"></i> Assign Script
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Script Modal -->
<div class="modal fade" id="viewScriptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-code"></i> View Script Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Name:</strong> <span id="viewScriptName"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Version:</strong> <span id="viewScriptVersion" class="badge bg-secondary"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Type:</strong> <span id="viewScriptType"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Target Sensor:</strong> <span id="viewScriptTarget"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p id="viewScriptDescription" class="text-muted"></p>
                </div>
                <div class="mb-3">
                    <strong>Script Content:</strong>
                    <pre id="viewScriptContent" class="bg-light p-3 border rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Logic Builder Modal -->
<div class="modal fade" id="logicBuilderModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Logic Builder - <span id="logicBuilderSensorName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Load from Library Section -->
                <div class="row mb-3 align-items-center bg-light p-2 rounded mx-0 border">
                    <div class="col-auto">
                        <label class="fw-bold mb-0"><i class="fas fa-book"></i> Load from Library:</label>
                    </div>
                    <div class="col">
                        <select class="form-select form-select-sm" id="logicLibrarySelect" onchange="loadLogicFromLibrary(this.value)">
                            <option value="">-- Select a script to load --</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="logicName" placeholder="Script Name">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Version</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="logicVersion" placeholder="1.0.0">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Bump</button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="bumpVersion('major')">Major (+1.0.0)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="bumpVersion('minor')">Minor (+0.1.0)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="bumpVersion('patch')">Patch (+0.0.1)</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Type</label>
                        <input type="text" class="form-control" id="logicType" placeholder="json" value="json" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="logicDescription" placeholder="Description">
                    </div>
                </div>

                <ul class="nav nav-tabs mb-3" id="logicBuilderTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual-pane" type="button" onclick="syncJsonToVisual()">Visual Builder</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json-pane" type="button" onclick="syncVisualToJson()">JSON Editor</button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Visual Builder Pane -->
                    <div class="tab-pane fade show active" id="visual-pane">
                        <div class="row">
                            <div class="col-md-3 border-end">
                                <h6>Toolbox</h6>
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('gpio_write')"><i class="fas fa-bolt"></i> GPIO Write</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('gpio_read')"><i class="fas fa-eye"></i> GPIO Read</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('pwm_write')"><i class="fas fa-wave-square"></i> PWM Write</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('analog_write')"><i class="fas fa-bezier-curve"></i> DAC Write</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('analog_read')"><i class="fas fa-chart-bar"></i> Analog Read</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('read_battery')"><i class="fas fa-battery-half"></i> Read Battery</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('read_temperature')"><i class="fas fa-thermometer-half"></i> Read Temperature</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('set_relay')"><i class="fas fa-toggle-on"></i> Set Relay</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('delay')"><i class="fas fa-clock"></i> Delay</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('log')"><i class="fas fa-comment-alt"></i> Log Message</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('hibernate')"><i class="fas fa-bed"></i> Hibernate</button>
                                    <button class="btn btn-outline-warning btn-sm text-start" onclick="addLogicBlock('if')"><i class="fas fa-code-branch"></i> If Condition</button>
                                </div>
                                <hr>
                                <h6>Sensor Capabilities</h6>
                                <div id="sensorCapabilitiesList" class="small text-muted overflow-auto" style="max-height: 200px;">
                                    <!-- Populated via JS -->
                                </div>
                                <hr>
                                <h6>Defined Variables</h6>
                                <div id="availableVariablesList" class="small text-muted overflow-auto" style="max-height: 200px;">
                                    <p class="text-muted">No variables defined.</p>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="alert alert-info py-1 px-2 mb-2 small">
                                    <i class="fas fa-info-circle"></i> Drag and drop blocks to reorder, or use the Up/Down buttons.
                                </div>
                                <div id="logicCanvas" class="p-3 bg-light border rounded" style="min-height: 400px;">
                                    <!-- Blocks go here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- JSON Editor Pane -->
                    <div class="tab-pane fade" id="json-pane">
                        <textarea id="logicJsonEditor" class="form-control font-monospace" rows="20"></textarea>
                        <div class="mt-2 text-end">
                            <button class="btn btn-sm btn-outline-secondary" onclick="formatJson()">Format JSON</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveLogicBuilder()">Save Logic</button>
            </div>
        </div>
    </div>
</div>

<!-- Sensor Plotter Modal -->
<div class="modal fade" id="sensorPlotterModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-terminal me-2"></i>Sensor Serial Monitor: <span id="plotterSensorId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Live Logs</h6>
                    <div>
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                            <label class="form-check-label" for="autoScrollToggle">Auto-scroll</label>
                        </div>
                        <button class="btn btn-outline-info btn-sm me-2" onclick="resetPlotterHistory()" id="plotterHistoryBtn" style="display: none;">
                            <i class="fas fa-history"></i> History
                        </button>
                        <button class="btn btn-outline-warning btn-sm me-2" onclick="sendTestLog()">
                            <i class="fas fa-bug"></i> Test Log
                        </button>
                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="togglePlotterPause()" id="plotterPauseBtn">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearPlotterData()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Logs Section (Predominate) -->
                <div id="plotterLogs" class="bg-dark text-light p-3 border rounded mb-0 font-monospace" style="height: 70vh; overflow-y: auto; font-size: 0.9rem;">
                    <div class="text-white-50">Waiting for logs...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Device Modal -->
<div class="modal fade" id="editDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Device Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editDeviceForm">
                    <input type="hidden" id="editSensorId">
                    <div class="mb-3">
                        <label class="form-label">Friendly Name</label>
                        <input type="text" class="form-control" id="editSensorName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hibernation Duration (seconds)</label>
                        <input type="number" class="form-control" id="editCheckInInterval" min="10">
                        <div class="form-text">How often the device wakes up to check for commands and send data.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSensorSettings()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h6>Manual Entry</h6>
                        <form id="addDeviceForm">
                            <div class="mb-3">
                                <label class="form-label">Sensor ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newSensorId" required placeholder="e.g. esp32_fermentation_002">
                                <div class="form-text">Unique identifier for the device. Must match the ID in the device firmware.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Friendly Name</label>
                                <input type="text" class="form-control" id="newSensorName" placeholder="e.g. Fermentation Chamber 2">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Sensor Type</label>
                                <input type="text" class="form-control" id="newSensorType" placeholder="e.g. esp32_fermentation">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">IP Address (Optional)</label>
                                <input type="text" class="form-control" id="newSensorIp" placeholder="e.g. 192.168.1.100">
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Network Scan</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="scanForDevices()" id="scanBtn">
                                <i class="fas fa-search"></i> Scan
                            </button>
                        </div>
                        <div id="scanResults" class="list-group overflow-auto" style="max-height: 300px;">
                            <div class="text-center text-muted py-4">
                                <small>Click Scan to find devices on your network.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="registerDevice()">Register Device</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload to Many Modal -->
<div class="modal fade" id="uploadToManyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-tasks"></i> Upload Script to Multiple Sensors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="form-label fw-bold">1. Select Script</label>
                    <select class="form-select" id="bulkScriptSelect" onchange="filterBulkSensors()">
                        <option value="">-- Select a script --</option>
                    </select>
                    <div id="bulkScriptDetails" class="form-text mt-2"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">2. Select Target Sensors</label>
                    <div class="d-flex justify-content-between mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllSensors" onchange="toggleSelectAllSensors()">
                            <label class="form-check-label" for="selectAllSensors">Select All Visible</label>
                        </div>
                        <span class="badge bg-secondary" id="selectedCountBadge">0 selected</span>
                    </div>
                    
                    <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                        <div id="bulkSensorList" class="list-group list-group-flush">
                            <div class="text-center text-muted py-3">Please select a script first</div>
                        </div>
                    </div>
                </div>
                
                <div id="bulkUploadResult" class="alert" style="display: none;"></div>
                <div id="bulkUploadProgress" class="progress mb-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitBulkUpload()" id="btnBulkUpload" disabled>
                    <i class="fas fa-upload"></i> Upload to Selected
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let sensors = [];


// --- Sensor Plotter Logic ---
let plotterSensorId = null;
let plotterInterval = null;
let isPlotterPaused = false;
let lastLogId = 0;

async function openSensorPlotter(sensorId) {
    plotterSensorId = sensorId;
    document.getElementById('plotterSensorId').textContent = sensorId;
    
    // Reset state
    isPlotterPaused = false;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('sensorPlotterModal'));
    modal.show();
    
    const logsContainer = document.getElementById('plotterLogs');
    const historyBtn = document.getElementById('plotterHistoryBtn');
    
    logsContainer.innerHTML = '<div class="text-white-50 p-2">Connecting...</div>';
    
    // Initialize lastLogId to the current latest ID to avoid showing history
    try {
        const response = await fetch(`/api/sensor-master/logs/${plotterSensorId}?limit=1`);
        if (response.ok) {
            const data = await response.json();
            if (data.logs && data.logs.length > 0) {
                lastLogId = data.logs[0].id; // Logs are ordered DESC, so first is latest
                if (historyBtn) historyBtn.style.display = 'inline-block';
            } else {
                lastLogId = 0;
                if (historyBtn) historyBtn.style.display = 'none';
            }
        }
    } catch (e) {
        console.error("Error initializing plotter:", e);
        lastLogId = 0;
        if (historyBtn) historyBtn.style.display = 'none';
    }
    
    logsContainer.innerHTML = '<div class="text-white-50 p-2"><i>Connected. Listening for new logs...</i></div>';
    updatePauseButton();
    
    // Start polling
    if (plotterInterval) clearInterval(plotterInterval);
    plotterInterval = setInterval(() => {
        fetchPlotterLogs();
    }, 2000); // Poll every 2 seconds
    
    // Handle modal close to stop polling
    document.getElementById('sensorPlotterModal').addEventListener('hidden.bs.modal', function () {
        if (plotterInterval) {
            clearInterval(plotterInterval);
            plotterInterval = null;
        }
    }, { once: true });
}

function resetPlotterHistory() {
    lastLogId = 0;
    document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2">Fetching history...</div>';
    document.getElementById('plotterHistoryBtn').style.display = 'none';
    fetchPlotterLogs();
}

async function fetchPlotterLogs() {
    if (isPlotterPaused || !plotterSensorId) return;

    try {
        // Fetch logs newer than lastLogId
        // If lastLogId is 0, we fetch the latest 50 logs (default limit)
        // If lastLogId > 0 (because we cleared or have seen logs), we fetch only newer ones
        const url = `/api/sensor-master/logs/${plotterSensorId}?min_id=${lastLogId}&limit=50`;
        const response = await fetch(url);
        if (!response.ok) return;
        
        const data = await response.json();
        
        if (data.logs && data.logs.length > 0) {
            // Update lastLogId to the max ID received
            const maxId = Math.max(...data.logs.map(l => l.id));
            if (maxId > lastLogId) {
                lastLogId = maxId;
            }
            
            updatePlotterLogs(data.logs);
        } else if (lastLogId === 0) {
            // Only show "No logs" if we haven't received any logs yet AND we haven't cleared anything
            document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2">No logs available</div>';
        }
    } catch (error) {
        console.error('Error fetching plotter logs:', error);
    }
}

function updatePlotterLogs(logs) {
    const container = document.getElementById('plotterLogs');
    
    // Check if the container ONLY contains a placeholder message
    // We check if there are any log entries (divs with border-bottom)
    // If not, we can safely clear whatever is there (placeholders)
    if (!container.querySelector('div.border-bottom')) {
        container.innerHTML = '';
    }
    
    // Sort logs by ID ascending (oldest first) so we append them in order
    const sortedLogs = [...logs].sort((a, b) => a.id - b.id);
    
    // Format logs
    const html = sortedLogs.map(log => {
        // Convert UTC timestamp to local time
        const time = new Date(log.created_at).toLocaleTimeString();
        let colorClass = 'text-light';
        if (log.log_level === 'error') colorClass = 'text-danger';
        else if (log.log_level === 'warning') colorClass = 'text-warning';
        else if (log.log_level === 'debug') colorClass = 'text-secondary';
        
        return `<div class="mb-1 border-bottom border-secondary border-opacity-25 pb-1 font-monospace">
            <span class="text-white-50" style="font-size: 0.8em; margin-right: 8px;">[${time}]</span>
            <span class="${colorClass}">${log.message}</span>
        </div>`;
    }).join('');
    
    container.insertAdjacentHTML('beforeend', html);
    
    // Auto-scroll if enabled
    const autoScroll = document.getElementById('autoScrollToggle').checked;
    if (autoScroll) {
        container.scrollTop = container.scrollHeight;
    }
}

function togglePlotterPause() {
    isPlotterPaused = !isPlotterPaused;
    updatePauseButton();
}

function updatePauseButton() {
    const btn = document.getElementById('plotterPauseBtn');
    if (isPlotterPaused) {
        btn.innerHTML = '<i class="fas fa-play"></i> Resume';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-success');
    } else {
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-outline-secondary');
    }
}

function clearPlotterData() {
    // Clear the UI
    document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2"><i>Logs cleared. Listening for new entries...</i></div>';
    
    // Show history button since we now have hidden history
    const historyBtn = document.getElementById('plotterHistoryBtn');
    if (historyBtn) historyBtn.style.display = 'inline-block';
}

async function sendTestLog() {
    if (!plotterSensorId) return;
    
    try {
        const response = await fetch('/api/sensor-master/logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensor_id: plotterSensorId,
                message: 'Test log message from console',
                level: 'info'
            })
        });
        
        if (response.ok) {
            // Don't need to do anything, the poller will pick it up
            console.log('Test log sent');
        } else {
            console.error('Failed to send test log');
            showAlert('Failed to send test log', 'danger');
        }
    } catch (error) {
        console.error('Error sending test log:', error);
        showAlert('Error sending test log: ' + error.message, 'danger');
    }
}



function editSensor(sensorId) {
    const sensor = sensors.find(s => s.sensor_id === sensorId);
    if (!sensor) return;
    
    document.getElementById('editSensorId').value = sensor.sensor_id;
    document.getElementById('editSensorName').value = sensor.sensor_name || '';
    document.getElementById('editCheckInInterval').value = sensor.check_in_interval || 60;
    
    new bootstrap.Modal(document.getElementById('editDeviceModal')).show();
}

async function saveSensorSettings() {
    const sensorId = document.getElementById('editSensorId').value;
    const name = document.getElementById('editSensorName').value;
    const interval = parseInt(document.getElementById('editCheckInInterval').value);
    
    try {
        const response = await fetch(`/api/sensor-master/sensors/${sensorId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensor_name: name,
                check_in_interval: interval
            })
        });
        
        if (!response.ok) throw new Error('Failed to update sensor');
        
        showAlert('Sensor settings updated successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editDeviceModal')).hide();
        await loadSensors();
    } catch (error) {
        console.error('Error updating sensor:', error);
        showAlert('Failed to update sensor', 'danger');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    refreshData();
    
    // Auto-refresh every 30 seconds for real-time updates
    setInterval(refreshData, 30000);
});

async function refreshData() {
    // Load sensors first
    await loadSensors();
    
    // Then load everything else in parallel
    await Promise.all([
        loadScripts(),
        loadStats()
    ]);
    
    // Re-render sensors to ensure script dropdowns are populated
    renderSensors();
    
    // Update sensor status indicators based on heartbeat
    updateSensorStatusIndicators();
}

function updateSensorStatusIndicators() {
    // Check each sensor's last_check_in and update visual indicators
    const now = new Date();
    
    sensors.forEach(sensor => {
        if (!sensor.last_check_in) {
            sensor.status = 'hibernating';
            return;
        }
        
        const lastCheckIn = new Date(sensor.last_check_in);
        const timeSinceLastCheck = now - lastCheckIn;
        
        // Calculate timeout based on sensor's check-in interval
        // Default to 60s if not set, convert to ms
        // Add a grace period (e.g. 2x interval + 30s buffer) to avoid false offline
        const intervalSec = sensor.check_in_interval || 60;
        const timeoutMs = (intervalSec * 1000) * 2 + 30000; 
        
        // Update status based on time since last heartbeat
        if (timeSinceLastCheck > timeoutMs) {
            if (sensor.status !== 'offline') {
                sensor.status = 'offline';
                console.log(`Sensor ${sensor.sensor_id} marked as offline (last seen ${Math.floor(timeSinceLastCheck / 60000)} minutes ago)`);
            }
        } else {
            if (sensor.status !== 'hibernating') {
                sensor.status = 'hibernating';
            }
        }
    });
    
    // Re-render displays to show updated status
    renderSensors();
    loadStats();
}







async function assignScript(sensorId, scriptId) {
    if (!scriptId) {
        if (!confirm(`Remove script assignment from sensor ${sensorId}?`)) return;
        showAlert('To remove a script, please assign a new one or use the API directly.', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/assign-library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                library_script_id: scriptId,
                sensor_id: sensorId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(`Script assigned to ${sensorId} successfully`, 'success');
            await loadSensors();
        } else {
            throw new Error(data.error || 'Failed to assign script');
        }
    } catch (error) {
        console.error('Error assigning script:', error);
        showAlert('Failed to assign script: ' + error.message, 'danger');
    }
}

async function loadSensors() {
    try {
        const statusFilter = document.getElementById('statusFilter').value;
        let url = '/api/sensor-master/sensors';
        // Add cache buster to prevent browser caching of old data
        url += `?t=${new Date().getTime()}`;
        
        if (statusFilter) {
            url += `&status=${statusFilter}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load sensors');
        
        sensors = await response.json();
        console.log('Loaded sensors:', sensors); // Debug: Check if battery data is present
        renderSensors();
    } catch (error) {
        console.error('Error loading sensors:', error);
        showAlert('Failed to load sensors', 'danger');
    }
}

function renderSensors() {
    const container = document.getElementById('sensorsContainer');
    
    if (sensors.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-microchip fa-3x mb-3"></i>
                <p>No sensors registered yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Sensor ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Battery Level</th>
                        <th>Current Script</th>
                        <th>Running Version</th>
                        <th>Last Check-in</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sensors.map(sensor => {
                        // Build script status indicator using assigned_script
                        let scriptIndicator = '<span class="badge bg-secondary"><i class="fas fa-minus"></i> No script</span>';
                        
                        if (sensor.assigned_script) {
                            const script = sensor.assigned_script;
                            const scriptStatus = script.status || 'unknown';
                            
                            // Status-based badges
                            if (scriptStatus === 'running') {
                                scriptIndicator = `<span class="badge bg-success" title="${script.name} v${script.version} - Running"><i class="fas fa-check-circle"></i> ${script.name}</span>`;
                            } else if (scriptStatus === 'pending') {
                                scriptIndicator = `<span class="badge bg-warning" title="${script.name} v${script.version} - Pending upload to device"><i class="fas fa-clock"></i> Pending</span>`;
                            } else if (scriptStatus === 'outdated') {
                                scriptIndicator = `<span class="badge bg-info" title="${script.name} v${script.version} - Update pending"><i class="fas fa-sync"></i> Updating</span>`;
                            } else {
                                scriptIndicator = `<span class="badge bg-secondary" title="${script.name}"><i class="fas fa-question"></i> Unknown</span>`;
                            }
                        }
                        
                        // Build running version indicator
                        let versionIndicator = '<span class="text-muted">-</span>';
                        if (sensor.running_script_version) {
                            const runningVersion = sensor.running_script_version;
                            const assignedVersion = sensor.assigned_script ? sensor.assigned_script.version : null;
                            
                            if (assignedVersion && runningVersion !== assignedVersion) {
                                // Version mismatch - needs update
                                versionIndicator = `
                                    <div>
                                        <code class="text-warning">${runningVersion}</code>
                                        <i class="fas fa-arrow-right text-muted"></i>
                                        <code class="text-success">${assignedVersion}</code>
                                    </div>
                                `;
                            } else {
                                // Running latest version
                                versionIndicator = `<code class="text-success">${runningVersion}</code>`;
                            }
                        } else if (sensor.assigned_script) {
                            // Has script but sensor hasn't reported version
                            versionIndicator = `
                                <span class="badge bg-info" title="Script assigned, waiting for device to report version">
                                    <i class="fas fa-upload"></i> Uploading...
                                </span>
                            `;
                        }
                        
                        // Build script options for dropdown
                        let scriptOptions = '<option value="">-- Select Script --</option>';
                        if (typeof scripts !== 'undefined' && scripts.length > 0) {
                             scriptOptions += scripts.map(s => {
                                // Check compatibility
                                const isCompatible = !s.target_sensor_type || s.target_sensor_type === sensor.sensor_type;
                                if (!isCompatible) return '';
                                
                                return `<option value="${s.id}" ${sensor.assigned_script && sensor.assigned_script.id === s.id ? 'selected' : ''}>
                                    ${s.name} (v${s.script_version})
                                </option>`;
                            }).join('');
                        }

                        return `
                        <tr class="sensor-list-item">
                            <td data-label="Sensor ID"><code>${sensor.sensor_id}</code></td>
                            <td data-label="Name">${sensor.sensor_name || 'Unnamed'}</td>
                            <td data-label="Type"><span class="badge bg-secondary">${sensor.sensor_type}</span></td>
                            <td data-label="Status">
                                <i class="fas fa-circle sensor-status-${sensor.status}"></i>
                                ${sensor.status}
                            </td>
                            <td data-label="Battery">
                                ${sensor.last_battery_pct !== undefined && sensor.last_battery_pct !== null 
                                    ? `<div class="d-flex align-items-center battery-display w-100 justify-content-end">
                                        <div class="progress flex-grow-1 me-2" style="height: 20px; min-width: 60px; max-width: 150px;" title="${sensor.last_battery_voltage ? sensor.last_battery_voltage.toFixed(2) + 'V' : ''}">
                                            <div class="progress-bar ${sensor.last_battery_pct < 20 ? 'bg-danger' : (sensor.last_battery_pct < 50 ? 'bg-warning' : 'bg-success')}" 
                                                 role="progressbar" 
                                                 style="width: ${sensor.last_battery_pct}%" 
                                                 aria-valuenow="${sensor.last_battery_pct}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <span class="fw-bold" style="min-width: 3.5em; text-align: right;">${sensor.last_battery_pct}%</span>
                                       </div>`
                                    : (sensor.last_battery_voltage ? `<small>${sensor.last_battery_voltage.toFixed(2)}V</small>` : '<span class="text-muted">-</span>')}
                            </td>
                            <td data-label="Current Script">${scriptIndicator}</td>
                            <td data-label="Running Version">${versionIndicator}</td>
                            <td data-label="Last Check-in">${sensor.last_check_in ? new Date(sensor.last_check_in).toLocaleString() : 'Never'}</td>
                            <td data-label="Actions">
                                <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                                    <select class="form-select form-select-sm" style="width: auto; max-width: 150px;" 
                                            onchange="assignScript('${sensor.sensor_id}', this.value)"
                                            title="Assign Script">
                                        ${scriptOptions}
                                    </select>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="viewSensorDetails('${sensor.sensor_id}')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="openLogicBuilder('${sensor.sensor_id}')" title="Logic Builder">
                                            <i class="fas fa-project-diagram"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="openSensorPlotter('${sensor.sensor_id}')" title="Serial Plotter">
                                            <i class="fas fa-chart-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteSensor('${sensor.sensor_id}')" title="Delete Sensor">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}



async function loadStats() {
    try {
        // Use the already-loaded sensors array if available, otherwise fetch
        let allSensors = sensors;
        if (!allSensors || allSensors.length === 0) {
            const response = await fetch('/api/sensor-master/sensors');
            if (!response.ok) throw new Error('Failed to load stats');
            allSensors = await response.json();
        }
        
        const stats = {
            total: allSensors.length,
            online: allSensors.filter(s => s.status === 'online').length,
            offline: allSensors.filter(s => s.status === 'offline').length,
            hibernating: allSensors.filter(s => s.status === 'hibernating').length
        };
        
        document.getElementById('stat-total-sensors').textContent = stats.total;
        document.getElementById('stat-online-sensors').textContent = stats.online;
        document.getElementById('stat-offline-sensors').textContent = stats.offline;
        document.getElementById('stat-pending-sensors').textContent = stats.hibernating;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}



async function viewSensorDetails(sensorId) {
    const sensor = sensors.find(s => s.sensor_id === sensorId);
    if (!sensor) return;
    
    const content = `
        <dl class="row">
            <dt class="col-sm-3">Sensor ID:</dt>
            <dd class="col-sm-9"><code>${sensor.sensor_id}</code></dd>
            
            <dt class="col-sm-3">Name:</dt>
            <dd class="col-sm-9">${sensor.sensor_name || 'Unnamed'}</dd>
            
            <dt class="col-sm-3">Type:</dt>
            <dd class="col-sm-9">${sensor.sensor_type}</dd>
            
            <dt class="col-sm-3">Status:</dt>
            <dd class="col-sm-9">
                <i class="fas fa-circle sensor-status-${sensor.status}"></i> ${sensor.status}
            </dd>
            
            <dt class="col-sm-3">Hardware:</dt>
            <dd class="col-sm-9">${sensor.hardware_info || 'N/A'}</dd>
            
            <dt class="col-sm-3">Firmware:</dt>
            <dd class="col-sm-9">${sensor.firmware_version || 'N/A'}</dd>
            
            <dt class="col-sm-3">IP Address:</dt>
            <dd class="col-sm-9">${sensor.ip_address || 'N/A'}</dd>
            
            <dt class="col-sm-3">MAC Address:</dt>
            <dd class="col-sm-9">${sensor.mac_address || 'N/A'}</dd>
            
            <dt class="col-sm-3">Master:</dt>
            <dd class="col-sm-9">${sensor.master_name || 'Unassigned'}</dd>
            
            <dt class="col-sm-3">Temperature:</dt>
            <dd class="col-sm-9">${sensor.last_temperature !== undefined && sensor.last_temperature !== null ? parseFloat(sensor.last_temperature).toFixed(1) + ' C' : 'N/A'}</dd>

            <dt class="col-sm-3">Relay State:</dt>
            <dd class="col-sm-9">${sensor.last_relay_state !== undefined && sensor.last_relay_state !== null ? (sensor.last_relay_state ? '<span class="badge bg-success">ON</span>' : '<span class="badge bg-danger">OFF</span>') : 'N/A'}</dd>

            <dt class="col-sm-3">Battery:</dt>
            <dd class="col-sm-9">
                ${sensor.last_battery_pct !== undefined && sensor.last_battery_pct !== null 
                    ? `<div class="progress" style="height: 20px; max-width: 200px;">
                        <div class="progress-bar ${sensor.last_battery_pct < 20 ? 'bg-danger' : (sensor.last_battery_pct < 50 ? 'bg-warning' : 'bg-success')}" 
                             role="progressbar" 
                             style="width: ${sensor.last_battery_pct}%" 
                             aria-valuenow="${sensor.last_battery_pct}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${sensor.last_battery_pct}% (${sensor.last_battery_voltage ? sensor.last_battery_voltage.toFixed(2) + 'V' : ''})
                        </div>
                       </div>`
                    : (sensor.last_battery_voltage ? sensor.last_battery_voltage.toFixed(2) + ' V' : 'N/A')}
            </dd>

            <dt class="col-sm-3">Last Check-in:</dt>
            <dd class="col-sm-9">${sensor.last_check_in ? new Date(sensor.last_check_in).toLocaleString() : 'Never'}</dd>
            
            <dt class="col-sm-3">Hibernation:</dt>
            <dd class="col-sm-9">${sensor.check_in_interval || 60} seconds</dd>
            
            <dt class="col-sm-3">Registered:</dt>
            <dd class="col-sm-9">${new Date(sensor.created_at).toLocaleString()}</dd>
            
            <dt class="col-sm-3">Capabilities:</dt>
            <dd class="col-sm-9">
                ${sensor.capabilities && sensor.capabilities.length > 0 
                    ? sensor.capabilities.map(c => `<span class="badge bg-info">${c}</span>`).join(' ')
                    : 'None'}
            </dd>
        </dl>
    `;
    
    document.getElementById('sensorDetailContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('sensorDetailModal')).show();
}

async function deleteSensor(sensorId) {
    if (!confirm('Are you sure you want to delete this sensor registration?')) return;
    
    try {
        const response = await fetch(`/api/sensor-master/sensors/${sensorId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete sensor');
        
        showAlert('Sensor deleted successfully', 'success');
        await loadSensors();
        await loadStats();
    } catch (error) {
        console.error('Error deleting sensor:', error);
        showAlert('Failed to delete sensor', 'danger');
    }
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3" 
             role="alert" style="z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    setTimeout(() => {
        const alert = document.querySelector('.alert');
       
        if (alert) {
            bootstrap.Alert.getInstance(alert)?.close();
        }
    }, 5000);
}

// ============================================================================
// ESP32 CODE EXPORT FUNCTIONS
// ============================================================================

let generatedCodeData = null;

function showCodeExportModal() {
    // Populate sensor dropdown
    const sensorSelect = document.getElementById('exportSensorId');
    sensorSelect.innerHTML = '<option value="">Generate New Template</option>';
    
    sensors.forEach(sensor => {
        const option = document.createElement('option');
        option.value = sensor.sensor_id;
        option.textContent = `${sensor.sensor_name || sensor.sensor_id} (${sensor.sensor_type})`;
        sensorSelect.appendChild(option);
    });
    
    // Reset form
    document.getElementById('exportSensorType').value = 'esp32_fermentation';
    document.getElementById('exportLanguage').value = 'arduino';
    document.getElementById('exportWifiSsid').value = '';
    document.getElementById('exportWifiPassword').value = '';
    
    // Hide result sections
    document.getElementById('codeExportLoading').style.display = 'none';
    document.getElementById('codeExportResult').style.display = 'none';
    document.getElementById('codeExportError').style.display = 'none';
    
    generatedCodeData = null;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('codeExportModal'));
    modal.show();
}

async function generateCode() {
    const sensorId = document.getElementById('exportSensorId').value || null;
    const sensorType = document.getElementById('exportSensorType').value;
    const language = document.getElementById('exportLanguage').value;
    const wifiSsid = document.getElementById('exportWifiSsid').value;
    const wifiPassword = document.getElementById('exportWifiPassword').value;
    
    // Show loading
    document.getElementById('codeExportLoading').style.display = 'block';
    document.getElementById('codeExportResult').style.display = 'none';
    document.getElementById('codeExportError').style.display = 'none';
    
    try {
        const payload = {
            language: language,
            wifi_ssid: wifiSsid,
            wifi_password: wifiPassword
        };
        
        if (sensorId) {
            payload.sensor_id = sensorId;
        } else if (sensorType) {
            payload.sensor_type = sensorType;
        }
        
        const response = await fetch('/api/sensor-master/export-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            generatedCodeData = data;
            
            // Display the code
            document.getElementById('generatedCode').textContent = data.code;
            document.getElementById('codeExportResult').style.display = 'block';
            
            showAlert('Code generated successfully!', 'success');
        } else {
            throw new Error(data.error || 'Failed to generate code');
        }
    } catch (error) {
        console.error('Error generating code:', error);
        document.getElementById('codeExportErrorMessage').textContent = error.message;
        document.getElementById('codeExportError').style.display = 'block';
    } finally {
        document.getElementById('codeExportLoading').style.display = 'none';
    }
}

function copyCodeToClipboard() {
    if (!generatedCodeData) {
        showAlert('Please generate code first', 'warning');
        return;
    }
    
    const code = document.getElementById('generatedCode').textContent;
    
    navigator.clipboard.writeText(code).then(() => {
        showAlert('Code copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showAlert('Failed to copy code', 'danger');
    });
}

function downloadCode() {
    if (!generatedCodeData) {
        showAlert('Please generate code first', 'warning');
        return;
    }
    
    const code = generatedCodeData.code;
    const filename = generatedCodeData.filename || 'esp32_sensor.ino';
    
    // Create blob and download
    const blob = new Blob([code], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showAlert(`Downloaded ${filename}`, 'success');
}

// ============================================================================
// SCRIPT UPLOAD & MANAGEMENT FUNCTIONS
// ============================================================================

let scripts = [];

async function loadScripts() {
    try {
        const response = await fetch('/api/sensor-master/library-scripts');
        if (!response.ok) throw new Error('Failed to load library scripts');
        
        scripts = await response.json();
        renderScripts();
        // Also re-render sensors to update the script dropdowns
        renderSensors();
    } catch (error) {
        console.error('Error loading scripts:', error);
        document.getElementById('scriptsContainer').innerHTML = 
            '<div class="alert alert-danger">Failed to load scripts</div>';
    }
}

function renderScripts() {
    const container = document.getElementById('scriptsContainer');
    
    if (scripts.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-file-code fa-3x mb-3"></i>
                <p>No scripts in library. Click "Upload New Script" to create one.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>Name</th>
                <th>Version</th>
                <th>Type</th>
                <th>Target Sensor</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    scripts.forEach(script => {
        html += `
            <tr>
                <td data-label="Name"><strong>${script.name}</strong></td>
                <td data-label="Version"><span class="badge bg-secondary">${script.script_version}</span></td>
                <td data-label="Type"><code>${script.script_type}</code></td>
                <td data-label="Target Sensor">${script.target_sensor_type || '<span class="text-muted">Any</span>'}</td>
                <td data-label="Description">${script.description || '-'}</td>
                <td data-label="Actions">
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-sm btn-outline-info" onclick="viewScript(${script.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteScript(${script.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function deleteScript(scriptId) {
    if (!confirm('Are you sure you want to delete this script? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`/api/sensor-master/library-scripts/${scriptId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete script');
        
        showAlert('Script deleted successfully', 'success');
        await loadScripts();
    } catch (error) {
        console.error('Error deleting script:', error);
        showAlert('Failed to delete script', 'danger');
    }
}

function showUploadScriptModal() {
    // Reset form
    document.getElementById('scriptName').value = '';
    document.getElementById('scriptVersion').value = '1.0.0';
    document.getElementById('scriptType').value = 'arduino';
    document.getElementById('scriptDescription').value = '';
    document.getElementById('scriptContent').value = '';
    document.getElementById('scriptTargetType').value = '';
    document.getElementById('scriptUploadResult').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('uploadScriptModal'));
    modal.show();
}

async function uploadScript() {
    const scriptName = document.getElementById('scriptName').value;
    const scriptContent = document.getElementById('scriptContent').value;
    const scriptVersion = document.getElementById('scriptVersion').value;
    const scriptType = document.getElementById('scriptType').value;
    const description = document.getElementById('scriptDescription').value;
    const targetType = document.getElementById('scriptTargetType').value;
    
    // Validation
    if (!scriptName) {
        showAlert('Please enter a script name', 'warning');
        return;
    }
    
    if (!scriptContent.trim()) {
        showAlert('Please enter script content', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: scriptName,
                script_content: scriptContent,
                script_version: scriptVersion,
                script_type: scriptType,
                description: description,
                target_sensor_type: targetType
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Show success message
            const resultDiv = document.getElementById('scriptUploadResult');
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <strong>Script saved to library!</strong><br>
                You can now assign this script to sensors.
            `;
            resultDiv.style.display = 'block';
            
            showAlert('Script saved to library successfully!', 'success');
            
            // Reload scripts
            await loadScripts();
            
            // Close modal after a delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('uploadScriptModal')).hide();
            }, 2000);
        } else {
            throw new Error(data.error || 'Failed to save script');
        }
    } catch (error) {
        console.error('Error saving script:', error);
        const resultDiv = document.getElementById('scriptUploadResult');
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <strong>Error:</strong> ${error.message}
        `;
        resultDiv.style.display = 'block';
    }
}

let currentAssignScriptId = null;

function showAssignScriptModal(scriptId, scriptName) {
    currentAssignScriptId = scriptId;
    document.getElementById('assignScriptName').textContent = scriptName;
    
    // Populate sensor dropdown
    const select = document.getElementById('assignSensorId');
    select.innerHTML = '<option value="">Choose a sensor...</option>';
    
    sensors.forEach(sensor => {
        const option = document.createElement('option');
        option.value = sensor.sensor_id;
        option.textContent = `${sensor.sensor_name} (${sensor.sensor_type})`;
        select.appendChild(option);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('assignScriptModal'));
    modal.show();
}

async function submitAssignScriptModal() {
    const sensorId = document.getElementById('assignSensorId').value;
    
    if (!sensorId) {
        showAlert('Please select a sensor', 'warning');
        return;
    }
    
    if (!currentAssignScriptId) {
        showAlert('No script selected', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/assign-library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                library_script_id: currentAssignScriptId,
                sensor_id: sensorId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const resultDiv = document.getElementById('assignScriptResult');
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `
                               <i class="fas fa-check-circle"></i>
                <strong>Script assigned successfully!</strong>
            `;
            resultDiv.style.display = 'block';
            
            // Reload assignments if that function exists or reload page
            // For now just close modal after delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('assignScriptModal')).hide();
                resultDiv.style.display = 'none';
            }, 1500);
            
        } else {
            throw new Error(data.error || 'Failed to assign script');
        }
    } catch (error) {
        console.error('Error assigning script:', error);
        const resultDiv = document.getElementById('assignScriptResult');
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <strong>Error:</strong> ${error.message}
        `;
        resultDiv.style.display = 'block';
    }
}

function viewScript(scriptId) {
    const script = scripts.find(s => s.id === scriptId);
    if (!script) {
        showAlert('Script not found', 'error');
        return;
    }
    
    document.getElementById('viewScriptName').textContent = script.name;
    document.getElementById('viewScriptVersion').textContent = script.script_version;
    document.getElementById('viewScriptType').textContent = script.script_type;
    document.getElementById('viewScriptTarget').textContent = script.target_sensor_type || 'All';
    document.getElementById('viewScriptDescription').textContent = script.description || 'No description provided.';
    document.getElementById('viewScriptContent').textContent = script.script_content;
    
    new bootstrap.Modal(document.getElementById('viewScriptModal')).show();
}

/* Logic Builder Code */

let currentLogicSensorId = null;
let currentLogicData = { actions: [] };
let currentSensorCapabilities = null;

const SYSTEM_VARIABLES = [
    'millis', 'wifi_rssi', 'free_heap', 'uptime', 'sensor_id', 'current_time', 'sensor.temp', 'sensor.relay', 'firmware_version'
];

function openLogicBuilder(sensorId) {
    currentLogicSensorId = sensorId;
    const sensor = sensors.find(s => s.sensor_id === sensorId);
    
    if (!sensor) {
        showAlert('Sensor not found', 'error');
        return;
    }
    
    document.getElementById('logicBuilderSensorName').textContent = sensor.sensor_name || sensor.sensor_id;
    
    // Parse capabilities
    try {
        currentSensorCapabilities = typeof sensor.capabilities === 'string' 
            ? JSON.parse(sensor.capabilities) 
            : (sensor.capabilities || {});
    } catch (e) {
        console.error('Error parsing capabilities:', e);
        currentSensorCapabilities = {};
    }
    
    renderCapabilitiesList();
    
    // Initialize with BLANK data
    currentLogicData = { 
        name: '', 
        version: '1.0.0', 
        description: '', 
        actions: [] 
    };
    
    // Reset UI fields
    document.getElementById('logicName').value = '';
    document.getElementById('logicVersion').value = '1.0.0';
    document.getElementById('logicDescription').value = '';
    document.getElementById('logicLibrarySelect').value = '';
    
    // Populate library dropdown
    populateLibraryDropdown();
    
    // Initialize editors
    document.getElementById('logicJsonEditor').value = JSON.stringify(currentLogicData, null, 2);
    renderLogicCanvas();
    renderVariablesList();
    
    new bootstrap.Modal(document.getElementById('logicBuilderModal')).show();
}

function renderVariablesList() {
    const container = document.getElementById('availableVariablesList');
    if (!container) return;
    
    if (!SYSTEM_VARIABLES || SYSTEM_VARIABLES.length === 0) {
        container.innerHTML = '<p class="text-muted">No variables defined.</p>';
        return;
    }
    
    let html = '<ul class="list-unstyled ps-2">';
    SYSTEM_VARIABLES.forEach(v => {
        html += `<li><code class="text-primary">${v}</code> <span class="text-muted small">(System)</span></li>`;
    });
    html += '</ul>';
    
    container.innerHTML = html;
}

function populateLibraryDropdown() {
    const select = document.getElementById('logicLibrarySelect');
    // Keep first option
    select.innerHTML = '<option value="">-- Select a script to load --</option>';
    
    // Filter for JSON scripts only
    const jsonScripts = scripts.filter(s => s.script_type === 'json' || s.script_type === 'snippet');
    
    jsonScripts.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${s.name} (v${s.script_version})`;
        select.appendChild(option);
    });
}

function loadLogicFromLibrary(scriptId) {
    if (!scriptId) return;
    
    const script = scripts.find(s => s.id == scriptId);
    if (!script) return;
    
    try {
        let content = script.script_content;
        let parsed;
        
        if (typeof content === 'string') {
            parsed = JSON.parse(content);
        } else {
            parsed = content;
        }
        
        // Update current logic data
        currentLogicData = parsed;
        
        // Ensure actions array exists
        if (!currentLogicData.actions && currentLogicData.commands) {
            currentLogicData.actions = currentLogicData.commands;
        }
        if (!currentLogicData.actions) {
            currentLogicData.actions = [];
        }
        
        // Normalize data to ensure defaults are present
        normalizeLogicData(currentLogicData.actions);
        
        // Update UI fields
        document.getElementById('logicName').value = script.name;
        document.getElementById('logicVersion').value = script.script_version;
        document.getElementById('logicDescription').value = script.description || '';
        
        // Auto-increment version (Patch by default)
        bumpVersion('patch');
        
        // Update editors
        document.getElementById('logicJsonEditor').value = JSON.stringify(currentLogicData, null, 2);
        renderLogicCanvas();
        
        showAlert(`Loaded "${script.name}"`, 'success');
        
    } catch (e) {
        console.error('Error loading script:', e);
        showAlert('Failed to parse script content', 'danger');
    }
}

function bumpVersion(type) {
    const versionInput = document.getElementById('logicVersion');
    let currentVer = versionInput.value || '0.0.0';
    
    // Simple semantic versioning regex
    const parts = currentVer.split('.').map(p => parseInt(p));
    
    if (parts.length !== 3 || parts.some(isNaN)) {
        // If invalid format, reset to 1.0.0
        versionInput.value = '1.0.0';
        if (currentLogicData) currentLogicData.version = '1.0.0';
        return;
    }
    
    let [major, minor, patch] = parts;
    
    if (type === 'major') {
        major++;
        minor = 0;
        patch = 0;
    } else if (type === 'minor') {
        minor++;
        patch = 0;
    } else { // patch
        patch++;
    }
    
    const newVer = `${major}.${minor}.${patch}`;
    versionInput.value = newVer;
    
    // Update internal data
    if (currentLogicData) {
        currentLogicData.version = newVer;
    }
}

function renderCapabilitiesList() {
    const container = document.getElementById('sensorCapabilitiesList');
    if (!currentSensorCapabilities || Object.keys(currentSensorCapabilities).length === 0) {
        container.innerHTML = '<p class="text-muted">No capabilities reported.</p>';
        return;
    }
    
    let html = '<div class="alert alert-light p-1 mb-2 small">Use these <strong>Aliases</strong> in IF conditions (e.g. <code>temp > 25</code>)</div>';
    
    // Pins
    if (currentSensorCapabilities.pins) {
        html += '<strong>Pins (Alias):</strong><ul class="list-unstyled ps-2">';
        currentSensorCapabilities.pins.forEach(pin => {
            const alias = pin.name || `Pin ${pin.pin}`;
            html += `<li><span class="badge bg-secondary">${pin.pin}</span> <code class="text-primary">${alias}</code> <span class="text-muted small">(${pin.type})</span></li>`;
        });
        html += '</ul>';
    }
    
    // Sensors/Data
    if (currentSensorCapabilities.sensors) {
        html += '<strong>Sensors (Alias):</strong><ul class="list-unstyled ps-2">';
        currentSensorCapabilities.sensors.forEach(s => {
            html += `<li><i class="fas fa-microchip"></i> <code class="text-primary">${s.name}</code> <span class="text-muted small">(${s.type})</span></li>`;
        });
        html += '</ul>';
    }
    
    container.innerHTML = html;
}

function normalizeLogicData(actions) {
    if (!actions) return;
    
    actions.forEach(block => {
        // Apply defaults based on type
        if (block.type === 'gpio_read') {
            if (block.pin === undefined) block.pin = 2;
            if (block.mode === undefined) block.mode = 'INPUT';
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'gpio_write') {
            if (block.pin === undefined) block.pin = 2;
            if (block.value === undefined) block.value = 'HIGH';
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'pwm_write') {
            if (block.pin === undefined) block.pin = 2;
            if (block.duty === undefined) block.duty = 128;
            if (block.freq === undefined) block.freq = 5000;
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'analog_write') {
            if (block.pin === undefined) block.pin = 25;
            if (block.value === undefined) block.value = 128;
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'analog_read') {
            if (block.pin === undefined) block.pin = 34;
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'read_temperature') {
            if (block.pin === undefined) block.pin = 4;
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'read_battery') {
            if (block.pin === undefined) block.pin = 34;
            if (block.r1 === undefined) block.r1 = 100000;
            if (block.r2 === undefined) block.r2 = 100000;
            if (block.alias === undefined) block.alias = 'battery';
        } else if (block.type === 'set_relay') {
            if (block.state === undefined) block.state = true;
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'delay') {
            if (block.ms === undefined) block.ms = 1000;
        } else if (block.type === 'hibernate') {
            if (block.duration === undefined) block.duration = 60;
            if (block.unit === undefined) block.unit = 'seconds';
        } else if (block.type === 'log') {
            if (block.message === undefined) block.message = '';
        } else if (block.type === 'if') {
            if (!block.condition) block.condition = { left: '', operator: '==', right: '' };
            
            // Ensure all properties exist even if condition object exists
            if (block.condition.left === undefined) block.condition.left = '';
            if (block.condition.operator === undefined) block.condition.operator = '==';
            if (block.condition.right === undefined) block.condition.right = '';

            if (!block.then) block.then = [];
            if (!block.else) block.else = [];
            
            // Recursive calls
            normalizeLogicData(block.then);
            normalizeLogicData(block.else);
        }
    });
}

function collectUserAliases(actions) {
    let aliases = [];
    if (!actions) return aliases;
    
    actions.forEach(block => {
        if (block.alias && block.alias.trim() !== '') {
            aliases.push({ name: block.alias, type: block.type });
        }
        if (block.then) aliases = aliases.concat(collectUserAliases(block.then));
        if (block.else) aliases = aliases.concat(collectUserAliases(block.else));
    });
    return aliases;
}

function getGlobalPinAliases(actions) {
    let map = {};
    if (!actions) return map;
    
    actions.forEach(block => {
        if (block.pin !== undefined && block.alias && block.alias.trim() !== '') {
            // Only set if not already set (first one wins)
            if (!map[block.pin]) {
                map[block.pin] = block.alias;
            }
        }
        // Recurse
        if (block.then) {
            const subMap = getGlobalPinAliases(block.then);
            Object.keys(subMap).forEach(pin => {
                if (!map[pin]) map[pin] = subMap[pin];
            });
        }
        if (block.else) {
            const subMap = getGlobalPinAliases(block.else);
            Object.keys(subMap).forEach(pin => {
                if (!map[pin]) map[pin] = subMap[pin];
            });
        }
    });
    return map;
}

// Logic Builder Implementation

// Navigation stack for drilling down into nested blocks (IF/ELSE)
let logicViewStack = []; // Array of { array: [], name: "Main" }

function getCurrentLogicArray() {
    if (logicViewStack.length === 0) {
        if (!currentLogicData.actions) currentLogicData.actions = [];
        return currentLogicData.actions;
    }
    return logicViewStack[logicViewStack.length - 1].array;
}

function pushLogicView(array, name) {
    logicViewStack.push({ array: array, name: name });
    renderLogicCanvas();
}

function popLogicView() {
    if (logicViewStack.length > 0) {
        logicViewStack.pop();
        renderLogicCanvas();
    }
}

function resetLogicView() {
    logicViewStack = [];
    renderLogicCanvas();
}

function addLogicBlock(type) {
    try {
        const newBlock = { type: type };
        // Apply defaults immediately to fix "Empty JSON" bug
        normalizeLogicData([newBlock]);
        
        const targetArray = getCurrentLogicArray();
        targetArray.push(newBlock);
        
        renderLogicCanvas();
        syncVisualToJson();
    } catch (e) {
        console.error("Error adding block:", e);
        showAlert("Failed to add block: " + e.message, "danger");
    }
}

function syncJsonToVisual() {
    try {
        const json = document.getElementById('logicJsonEditor').value;
        if (json.trim()) {
            const parsed = JSON.parse(json);
            // Preserve metadata if present, or just update actions
            if (parsed.actions) {
                currentLogicData = parsed;
            } else if (Array.isArray(parsed)) {
                currentLogicData.actions = parsed;
            } else {
                // Assume it's the full object
                currentLogicData = parsed;
            }
            
            if (!currentLogicData.actions) currentLogicData.actions = [];
            
            // Normalize to ensure defaults are present
            normalizeLogicData(currentLogicData.actions);
            
            // Reset view to root when syncing from JSON
            resetLogicView();
        }
    } catch (e) {
        console.error("Sync error:", e);
        showAlert("Invalid JSON format", "warning");
    }
}

function syncVisualToJson() {
    try {
        const json = JSON.stringify(currentLogicData, null, 2);
        document.getElementById('logicJsonEditor').value = json;
    } catch (e) {
        console.error("Error syncing visual to JSON:", e);
    }
}

function formatJson() {
    try {
        const json = document.getElementById('logicJsonEditor').value;
        const parsed = JSON.parse(json);
        document.getElementById('logicJsonEditor').value = JSON.stringify(parsed, null, 2);
    } catch (e) {
        showAlert("Invalid JSON", "warning");
    }
}

function renderLogicCanvas() {
    try {
        const container = document.getElementById('logicCanvas');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Add Datalist for Variables
        let datalistHtml = '<datalist id="logicVariables">';
        
        // 1. Add System Variables
        if (SYSTEM_VARIABLES) {
            SYSTEM_VARIABLES.forEach(v => {
                datalistHtml += `<option value="${v}">${v} (System)</option>`;
            });
        }
        
        // 2. Add Sensor Capabilities (Hardware Pins/Sensors)
        if (currentSensorCapabilities) {
            if (currentSensorCapabilities.pins) {
                currentSensorCapabilities.pins.forEach(p => {
                    if (p.name) datalistHtml += `<option value="${p.name}">${p.name} (Pin ${p.pin})</option>`;
                    datalistHtml += `<option value="gpio.${p.pin}">Pin ${p.pin}</option>`;
                });
            }
            if (currentSensorCapabilities.sensors) {
                currentSensorCapabilities.sensors.forEach(s => {
                    if (s.name) datalistHtml += `<option value="${s.name}">${s.name} (Sensor)</option>`;
                });
            }
        }
        
        // 3. Add User-Defined Aliases from Logic
        if (currentLogicData && currentLogicData.actions) {
            const userAliases = collectUserAliases(currentLogicData.actions);
            // Deduplicate
            const uniqueAliases = [...new Set(userAliases.map(a => a.name))];
            uniqueAliases.forEach(alias => {
                datalistHtml += `<option value="${alias}">${alias} (Alias)</option>`;
            });
        }
        
        datalistHtml += '</datalist>';
        container.insertAdjacentHTML('beforeend', datalistHtml);
        
        // Render Breadcrumbs
        let breadcrumbHtml = '<nav aria-label="breadcrumb"><ol class="breadcrumb mb-2">';
        breadcrumbHtml += `<li class="breadcrumb-item ${logicViewStack.length === 0 ? 'active' : ''}"><a href="#" onclick="resetLogicView(); return false;">Main</a></li>`;
        
        logicViewStack.forEach((view, index) => {
            const isActive = index === logicViewStack.length - 1;
            if (isActive) {
                breadcrumbHtml += `<li class="breadcrumb-item active">${view.name}</li>`;
            } else {
                // We can't easily jump to middle of stack without complex logic, so just show name
                // Or implement a jumpToView(index) function
                breadcrumbHtml += `<li class="breadcrumb-item text-muted">${view.name}</li>`;
            }
        });
        breadcrumbHtml += '</ol></nav>';
        
        if (logicViewStack.length > 0) {
            breadcrumbHtml += `<div class="mb-2"><button class="btn btn-sm btn-outline-secondary" onclick="popLogicView()"><i class="fas fa-arrow-left"></i> Back</button></div>`;
        }
        
        container.insertAdjacentHTML('beforeend', breadcrumbHtml);
        
        const currentArray = getCurrentLogicArray();
        
        // Calculate global aliases to lock inputs
        // We need to scan the ENTIRE logic tree, not just the current view
        const globalAliases = getGlobalPinAliases(currentLogicData.actions || []);

        if (!currentArray || currentArray.length === 0) {
            container.insertAdjacentHTML('beforeend', '<div class="text-center text-muted py-5">Drag blocks from the toolbox or click to add</div>');
            return;
        }
        
        currentArray.forEach((block, index) => {
            const card = document.createElement('div');
            card.className = 'card mb-2';
            
            let headerColor = 'bg-light';
            let icon = 'fa-cube';
            
            if (block.type.includes('write')) headerColor = 'bg-primary bg-opacity-10';
            if (block.type.includes('read')) headerColor = 'bg-info bg-opacity-10';
            if (block.type === 'if') { headerColor = 'bg-warning bg-opacity-10'; icon = 'fa-code-branch'; }
            if (block.type === 'delay') { headerColor = 'bg-secondary bg-opacity-10'; icon = 'fa-clock'; }
            if (block.type === 'hibernate') { headerColor = 'bg-dark bg-opacity-10'; icon = 'fa-bed'; }
            
            let contentHtml = '';
            
            // Special handling for IF block
            if (block.type === 'if') {
                // Render Condition inputs
                const cond = block.condition || { left: '', operator: '==', right: '' };
                
                contentHtml += `
                    <div class="col-12 mb-2">
                        <label class="form-label small fw-bold">Condition</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" placeholder="Left (e.g. temp)" value="${cond.left || ''}" 
                                   list="logicVariables"
                                   onchange="updateIfCondition(${index}, 'left', this.value)">
                            <select class="form-select" style="max-width: 80px;" 
                                    onchange="updateIfCondition(${index}, 'operator', this.value)">
                                <option value="==" ${cond.operator === '==' ? 'selected' : ''}>==</option>
                                <option value="!=" ${cond.operator === '!=' ? 'selected' : ''}>!=</option>
                                <option value=">" ${cond.operator === '>' ? 'selected' : ''}>&gt;</option>
                                <option value="<" ${cond.operator === '<' ? 'selected' : ''}>&lt;</option>
                                <option value=">=" ${cond.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                <option value="<=" ${cond.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                            </select>
                            <input type="text" class="form-control" placeholder="Right (e.g. 25)" value="${cond.right || ''}" 
                                   list="logicVariables"
                                   onchange="updateIfCondition(${index}, 'right', this.value)">
                        </div>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-sm btn-outline-success w-100" onclick="editBranch(${index}, 'then')">
                            <i class="fas fa-check"></i> Edit THEN (${block.then ? block.then.length : 0})
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="editBranch(${index}, 'else')">
                            <i class="fas fa-times"></i> Edit ELSE (${block.else ? block.else.length : 0})
                        </button>
                    </div>
                `;
            } else {
                // Standard rendering for other blocks
                Object.keys(block).forEach(key => {
                    if (key === 'type') return;
                    if (key === 'then' || key === 'else') return; 
                    if (key === 'condition') return; // Handled above if type is 'if'
                    
                    const val = block[key];
                    
                    // Special handling for 'unit' in hibernate block
                    if (key === 'unit' && block.type === 'hibernate') {
                         contentHtml += `
                            <div class="col-md-4 mb-2">
                                <label class="form-label small mb-0">Unit</label>
                                <select class="form-select form-select-sm" 
                                        onchange="updateBlockProperty(${index}, '${key}', this.value, 'text', false)">
                                    <option value="seconds" ${val === 'seconds' ? 'selected' : ''}>Seconds</option>
                                    <option value="minutes" ${val === 'minutes' ? 'selected' : ''}>Minutes</option>
                                    <option value="hours" ${val === 'hours' ? 'selected' : ''}>Hours</option>
                                </select>
                            </div>
                         `;
                         return;
                    }

                    // Special handling for 'value' in gpio_write block
                    if (key === 'value' && block.type === 'gpio_write') {
                         contentHtml += `
                            <div class="col-md-4 mb-2">
                                <label class="form-label small mb-0">Value</label>
                                <select class="form-select form-select-sm" 
                                        onchange="updateBlockProperty(${index}, '${key}', this.value, 'text', false)">
                                    <option value="HIGH" ${val === 'HIGH' ? 'selected' : ''}>HIGH</option>
                                    <option value="LOW" ${val === 'LOW' ? 'selected' : ''}>LOW</option>
                                </select>
                            </div>
                         `;
                         return;
                    }
                    
                    let inputType = 'text';
                    if (typeof val === 'number') inputType = 'number';
                    if (typeof val === 'boolean') inputType = 'checkbox';
                    
                    const checkedAttr = (inputType === 'checkbox' && val) ? 'checked' : '';
                    const valueAttr = inputType !== 'checkbox' ? `value="${val}"` : '';
                    
                    // Highlight Alias field
                    let labelClass = 'small mb-0';
                    let disabledAttr = '';
                    let displayValue = val;
                    let extraHelp = '';

                    if (key === 'alias') {
                        labelClass = 'small mb-0 fw-bold text-primary';
                        
                        // Check if this pin is already aliased elsewhere
                        // If block.pin exists and is in globalAliases, and the alias there is NOT this one (or even if it is this one, we might want to lock it if it's defined 'upstream'?)
                        // Actually, simpler rule: If globalAliases[block.pin] exists, use THAT value and disable input.
                        // BUT, we need to allow defining it the FIRST time.
                        // The getGlobalPinAliases function returns the FIRST definition.
                        // So if globalAliases[block.pin] == block.alias, then THIS is the definition (or a copy of it).
                        // If globalAliases[block.pin] != block.alias (and globalAliases[block.pin] is set), then this block is using a pin that was aliased elsewhere.
                        
                        // Wait, if I am the one defining it, I should be able to edit it?
                        // The requirement is: "If I use a Pin that already has an Alias, I should not be able to add one to it, it should be locked"
                        // This implies if I add a NEW block for Pin 2, and Pin 2 is already aliased to "LED", this new block should auto-fill "LED" and lock it.
                        
                        // Refined Logic:
                        // If globalAliases[block.pin] exists:
                        //    If block.alias is empty or different, show the global alias and DISABLE input.
                        //    If block.alias is SAME as global alias, ENABLE input (this is likely the definition).
                        
                        if (block.pin !== undefined && globalAliases[block.pin]) {
                            const existingAlias = globalAliases[block.pin];
                            // If the current block's alias doesn't match the global one, we should probably force it to match visually?
                            // Or just lock it if it's already set.
                            
                            // If this block IS the one defining it (i.e. it matches), we might still want to lock it if we want to enforce "define once"?
                            // But usually you want to be able to edit the definition.
                            // Let's assume: If the block's alias matches the global one, it MIGHT be the definition.
                            // But how do we know if it's the *first* one?
                            // We can't easily know order without complex logic.
                            
                            // Let's try this: If the alias is already set in the global map, show that alias.
                            // If the current block's alias is EMPTY, auto-fill it? No, that changes data.
                            // Just disable it if it's not the definition?
                            
                            // Refined Logic:
                            // If globalAliases[block.pin] exists:
                            //    If block.alias is empty or different, show the global alias and DISABLE input.
                            //    If block.alias is SAME as global alias, ENABLE input (this is likely the definition).
                            
                            if (existingAlias && existingAlias !== block.alias) {
                                // It's defined elsewhere. Lock this one.
                                disabledAttr = 'disabled';
                                displayValue = existingAlias + ' (Locked)';
                                extraHelp = '<div class="form-text x-small text-muted">Inherited from Pin ' + block.pin + '</div>';
                            } else if (existingAlias && existingAlias === block.alias) {
                                // This matches the global definition. It is likely the definition source.
                                // Allow editing.
                                extraHelp = '<div class="form-text x-small text-success">Defining Alias for Pin ' + block.pin + '</div>';
                            }
                        }
                    }
                    
                    // If we are modifying displayValue for locked alias, we need to handle it carefully
                    // because the input value attribute is what's submitted/saved? 
                    // No, onchange updates the JSON. If it's disabled, onchange won't fire.
                    // So we just show the value.
                    
                    const finalValueAttr = inputType !== 'checkbox' ? `value="${displayValue}"` : '';

                    contentHtml += `
                        <div class="col-md-4 mb-2">
                            <label class="form-label ${labelClass}">${key}</label>
                            <input type="${inputType}" class="form-control form-control-sm" 
                                   ${finalValueAttr} ${checkedAttr} ${disabledAttr}
                                   onchange="updateBlockProperty(${index}, '${key}', this.value, '${inputType}', this.checked)">
                            ${extraHelp}
                        </div>
                    `;
                });
            }
            
            card.innerHTML = `
                <div class="card-header py-1 px-2 ${headerColor} d-flex justify-content-between align-items-center">
                    <small class="fw-bold"><i class="fas ${icon}"></i> ${block.type}</small>
                    <div>
                        <button class="btn btn-xs btn-link text-muted" onclick="moveBlock(${index}, -1)"><i class="fas fa-arrow-up"></i></button>
                        <button class="btn btn-xs btn-link text-muted" onclick="moveBlock(${index}, 1)"><i class="fas fa-arrow-down"></i></button>
                        <button class="btn btn-xs btn-link text-danger" onclick="removeBlock(${index})"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="row g-2">
                        ${contentHtml}
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    } catch (e) {
        console.error("Error rendering canvas:", e);
        const container = document.getElementById('logicCanvas');
        if (container) container.innerHTML = '<div class="alert alert-danger">Error rendering blocks</div>';
    }
}

function editBranch(index, branchName) {
    const currentArray = getCurrentLogicArray();
    const block = currentArray[index];
    
    if (!block[branchName]) block[branchName] = [];
    
    pushLogicView(block[branchName], `IF #${index + 1} ${branchName.toUpperCase()}`);
}

function updateIfCondition(index, field, value) {
    const currentArray = getCurrentLogicArray();
    const block = currentArray[index];
    
    if (!block.condition) block.condition = { left: '', operator: '==', right: '' };
    block.condition[field] = value;
    
    syncVisualToJson();
}

function updateBlockProperty(index, key, value, type, checked) {
    try {
        if (type === 'number') value = parseFloat(value);
        if (type === 'checkbox') value = checked;
        
        const currentArray = getCurrentLogicArray();
        if (currentArray && currentArray[index]) {
            currentArray[index][key] = value;
            syncVisualToJson();
            
            // Re-render if pin or alias changes, to update locks/references
            if (key === 'pin' || key === 'alias') {
                // Small delay to allow UI to settle if needed, but immediate is usually better for sync
                // However, re-rendering kills focus. 
                // If key is 'alias', we are typing in the alias field. Re-rendering on every char is bad.
                // But onchange only fires on blur/enter. So focus is already lost/moving.
                renderLogicCanvas();
            }
        }
    } catch (e) {
        console.error("Error updating block property:", e);
    }
}

function removeBlock(index) {
    try {
        const currentArray = getCurrentLogicArray();
        if (currentArray) {
            currentArray.splice(index, 1);
            renderLogicCanvas();
            syncVisualToJson();
        }
    } catch (e) {
        console.error("Error removing block:", e);
    }
}

function moveBlock(index, direction) {
    try {
        const currentArray = getCurrentLogicArray();
        if (!currentArray) return;
        
        if (index + direction < 0 || index + direction >= currentArray.length) return;
        
        const temp = currentArray[index];
        currentArray[index] = currentArray[index + direction];
        currentArray[index + direction] = temp;
        
        renderLogicCanvas();
        syncVisualToJson();
    } catch (e) {
        console.error("Error moving block:", e);
    }
}

async function saveLogicBuilder() {
    try {
        // Update metadata from inputs
        currentLogicData.name = document.getElementById('logicName').value;
        currentLogicData.version = document.getElementById('logicVersion').value;
        currentLogicData.description = document.getElementById('logicDescription').value;
        
        // Open Upload Modal with pre-filled data
        document.getElementById('scriptName').value = currentLogicData.name;
        document.getElementById('scriptVersion').value = currentLogicData.version;
        document.getElementById('scriptDescription').value = currentLogicData.description;
        document.getElementById('scriptType').value = 'json';
        document.getElementById('scriptContent').value = JSON.stringify(currentLogicData, null, 2);
        
        // Hide logic builder, show upload modal
        const logicModal = bootstrap.Modal.getInstance(document.getElementById('logicBuilderModal'));
        if (logicModal) logicModal.hide();
        
        new bootstrap.Modal(document.getElementById('uploadScriptModal')).show();
    } catch (e) {
        console.error("Error saving logic:", e);
        showAlert("Failed to prepare save: " + e.message, "danger");
    }
}

// ============================================================================
// BULK UPLOAD FUNCTIONS
// ============================================================================

function showUploadToManyModal() {
    // Populate script dropdown
    const scriptSelect = document.getElementById('bulkScriptSelect');
    scriptSelect.innerHTML = '<option value="">-- Select a script --</option>';
    
    scripts.forEach(script => {
        const option = document.createElement('option');
        option.value = script.id;
        option.textContent = `${script.name} (v${script.script_version})`;
        option.dataset.targetType = script.target_sensor_type || '';
        option.dataset.description = script.description || '';
        scriptSelect.appendChild(option);
    });
    
    // Reset UI
    document.getElementById('bulkSensorList').innerHTML = '<div class="text-center text-muted py-3">Please select a script first</div>';
    document.getElementById('bulkScriptDetails').textContent = '';
    document.getElementById('selectAllSensors').checked = false;
    document.getElementById('selectAllSensors').disabled = true;
    document.getElementById('selectedCountBadge').textContent = '0 selected';
    document.getElementById('btnBulkUpload').disabled = true;
    document.getElementById('bulkUploadResult').style.display = 'none';
    document.getElementById('bulkUploadProgress').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('uploadToManyModal'));
    modal.show();
}

function filterBulkSensors() {
    const scriptSelect = document.getElementById('bulkScriptSelect');
    const sensorList = document.getElementById('bulkSensorList');
    const scriptId = scriptSelect.value;
    
    if (!scriptId) {
        sensorList.innerHTML = '<div class="text-center text-muted py-3">Please select a script first</div>';
        document.getElementById('bulkScriptDetails').textContent = '';
        document.getElementById('selectAllSensors').disabled = true;
        document.getElementById('btnBulkUpload').disabled = true;
        return;
    }
    
    const selectedOption = scriptSelect.options[scriptSelect.selectedIndex];
    const targetType = selectedOption.dataset.targetType;
    const description = selectedOption.dataset.description;
    
    // Show script details
    let details = description;
    if (targetType) {
        details += ` (Target: ${targetType})`;
    } else {
        details += ' (Compatible with all sensor types)';
    }
    document.getElementById('bulkScriptDetails').textContent = details;
    
    // Filter sensors
    const compatibleSensors = sensors.filter(s => !targetType || s.sensor_type === targetType);
    
    if (compatibleSensors.length === 0) {
        sensorList.innerHTML = '<div class="text-center text-warning py-3">No compatible sensors found</div>';
        document.getElementById('selectAllSensors').disabled = true;
        document.getElementById('btnBulkUpload').disabled = true;
        return;
    }
    
    // Render sensor list
    let html = '';
    compatibleSensors.forEach(sensor => {
        const isAssigned = sensor.assigned_script && sensor.assigned_script.id == scriptId;
        html += `
            <label class="list-group-item d-flex gap-3 align-items-center">
                <input class="form-check-input flex-shrink-0 bulk-sensor-checkbox" type="checkbox" 
                       value="${sensor.sensor_id}" style="font-size: 1.375em;"
                       onchange="updateSelectedCount()">
                <div class="d-flex gap-2 w-100 justify-content-between">
                    <div>
                        <h6 class="mb-0">${sensor.sensor_name || sensor.sensor_id}</h6>
                        <small class="text-muted">${sensor.sensor_type}</small>
                    </div>
                    <div class="text-end">
                        ${isAssigned ? '<span class="badge bg-success">Already Assigned</span>' : ''}
                        <small class="d-block text-muted">${sensor.status}</small>
                    </div>
                </div>
            </label>
        `;
    });
    
    sensorList.innerHTML = html;
    document.getElementById('selectAllSensors').disabled = false;
    updateSelectedCount();
}

function toggleSelectAllSensors() {
    const selectAll = document.getElementById('selectAllSensors').checked;
    const checkboxes = document.querySelectorAll('.bulk-sensor-checkbox');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll;
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.bulk-sensor-checkbox:checked');
    const count = checkboxes.length;
    
    document.getElementById('selectedCountBadge').textContent = `${count} selected`;
    document.getElementById('btnBulkUpload').disabled = count === 0;
}

async function submitBulkUpload() {
    const scriptId = document.getElementById('bulkScriptSelect').value;
    const checkboxes = document.querySelectorAll('.bulk-sensor-checkbox:checked');
    const sensorIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (!scriptId || sensorIds.length === 0) return;
    
    if (!confirm(`Are you sure you want to upload this script to ${sensorIds.length} sensors?`)) return;
    
    // UI Updates
    const btn = document.getElementById('btnBulkUpload');
    const progressDiv = document.getElementById('bulkUploadProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const resultDiv = document.getElementById('bulkUploadResult');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    progressDiv.style.display = 'flex';
    resultDiv.style.display = 'none';
    
    let successCount = 0;
    let failCount = 0;
    let errors = [];
    
    // Process sequentially to avoid overwhelming the server
    for (let i = 0; i < sensorIds.length; i++) {
        const sensorId = sensorIds[i];
        const percent = Math.round(((i) / sensorIds.length) * 100);
        progressBar.style.width = `${percent}%`;
        
        try {
            const response = await fetch('/api/sensor-master/assign-library-script', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    library_script_id: scriptId,
                    sensor_id: sensorId
                })
            });
            
            if (response.ok) {
                successCount++;
            } else {
                const data = await response.json();
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            console.error(`Error assigning to ${sensorId}:`, error);
            failCount++;
            errors.push(`${sensorId}: ${error.message}`);
        }
    }
    
    progressBar.style.width = '100%';
    
    // Show results
    let resultClass = 'alert-success';
    let resultIcon = 'fa-check-circle';
    let resultTitle = 'Success!';
    
    if (failCount > 0) {
        if (successCount === 0) {
            resultClass = 'alert-danger';
            resultIcon = 'fa-times-circle';
            resultTitle = 'Failed!';
        } else {
            resultClass = 'alert-warning';
            resultIcon = 'fa-exclamation-triangle';
            resultTitle = 'Partial Success';
        }
    }
    
    let resultHtml = `
        <i class="fas ${resultIcon}"></i>
        <strong>${resultTitle}</strong><br>
        Successfully assigned to ${successCount} sensors.
    `;
    
    if (failCount > 0) {
        resultHtml += `<br>Failed: ${failCount} sensors.`;
        if (errors.length > 0) {
            resultHtml += `<div class="mt-2 small text-muted" style="max-height: 100px; overflow-y: auto;">${errors.join('<br>')}</div>`;
        }
    }
    
    resultDiv.className = `alert ${resultClass}`;
    resultDiv.innerHTML = resultHtml;
    resultDiv.style.display = 'block';
    
    btn.innerHTML = '<i class="fas fa-upload"></i> Upload to Selected';
    
    // Refresh main list
    await loadSensors();
    
    // Close modal if fully successful after delay
    if (failCount === 0) {
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('uploadToManyModal')).hide();
        }, 2000);
    } else {
        btn.disabled = false;
    }
}

// Add Device Functions
function showAddDeviceModal() {
    document.getElementById('addDeviceForm').reset();
    document.getElementById('scanResults').innerHTML = `
        <div class="text-center text-muted py-4">
            <small>Click Scan to find devices on your network.</small>
        </div>
    `;
    new bootstrap.Modal(document.getElementById('addDeviceModal')).show();
}

async function registerDevice() {
    const sensorId = document.getElementById('newSensorId').value;
    const name = document.getElementById('newSensorName').value;
    const type = document.getElementById('newSensorType').value;
    const ip = document.getElementById('newSensorIp').value;
    
    if (!sensorId) {
        showAlert('Sensor ID is required', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensor_id: sensorId,
                sensor_name: name,
                sensor_type: type || 'unknown',
                ip_address: ip,
                registration_source: 'manual'
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to register device');
        
        showAlert('Device registered successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
        await loadSensors();
    } catch (error) {
        console.error('Error registering device:', error);
        showAlert('Failed to register device: ' + error.message, 'danger');
    }
}

async function scanForDevices() {
    const resultsContainer = document.getElementById('scanResults');
    resultsContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <p class="mb-0 text-muted">Scanning network...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/api/sensor-master/scan');
        const data = await response.json();
        
        if (data.status === 'success' && data.devices.length > 0) {
            let html = '<div class="list-group">';
            data.devices.forEach(device => {
                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${device.name}</h6>
                            <small class="text-muted">${device.ip} (${device.type})</small>
                        </div>
                        <button class="btn btn-sm btn-primary" 
                            onclick="prefillRegistration('${device.ip}', '${device.type}', '${device.name}')">
                            Select
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            resultsContainer.innerHTML = html;
        } else {
            resultsContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-wifi fa-2x mb-2"></i>
                    <p>No new devices found.</p>
                    <small>Make sure your device is powered on and connected to the same network.</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('Scan error:', error);
        resultsContainer.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-circle mb-2"></i>
                <p>Scan failed: ${error.message}</p>
            </div>
        `;
    }
}

window.prefillRegistration = function(ip, type, name) {
    document.getElementById('deviceIp').value = ip;
    // Try to match type to dropdown
    const typeSelect = document.getElementById('deviceType');
    for(let i=0; i<typeSelect.options.length; i++) {
        if(typeSelect.options[i].value.toLowerCase() === type.toLowerCase()) {
            typeSelect.selectedIndex = i;
            break;
        }
    }
    // If name looks like an ID, use it
    if(name) {
        document.getElementById('deviceName').value = name.split('.')[0];
    }
};

// Expose functions to window to ensure they are accessible
window.showAddDeviceModal = showAddDeviceModal;
window.registerDevice = registerDevice;
window.scanForDevices = scanForDevices;
</script>
</body>
</html>