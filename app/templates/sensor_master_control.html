<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Master Control - {{ project_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ribbon.css') }}">
    
    <!-- Chart.js for Serial Plotter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

    <!-- Dynamic Theme CSS -->
    <style id="theme-styles">
        {{ theme_css|safe }}
    </style>
    
<style>
    :root {
        --content-spacing: 1.5rem;
        --border-radius: 0.5rem;
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    body {
        background-color: var(--theme-bg-body, var(--bs-body-bg));
        color: var(--theme-text, var(--bs-body-color));
    }

    .container-fluid {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    /* Status Badges */
    .master-status-badge {
        padding: 0.35rem 0.65rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .master-status-active {
        background-color: var(--bs-success-bg-subtle);
        color: var(--bs-success-text-emphasis);
        border: 1px solid var(--bs-success-border-subtle);
    }
    
    .master-status-inactive {
        background-color: var(--bs-danger-bg-subtle);
        color: var(--bs-danger-text-emphasis);
        border: 1px solid var(--bs-danger-border-subtle);
    }
    
    /* Sensor Status Icons */
    .sensor-status-online {
        color: var(--bs-success);
    }
    
    .sensor-status-offline {
        color: var(--bs-danger);
    }
    
    .sensor-status-pending {
        color: var(--bs-warning);
    }
    
    /* Config Viewer */
    .config-viewer {
        background-color: var(--theme-bg-surface, var(--bs-tertiary-bg));
        border: 1px solid var(--theme-border, var(--bs-border-color));
        border-radius: var(--border-radius);
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .config-viewer pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: var(--theme-text, var,--bs-body-color);
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
    }
    
    /* Stat Cards */
    .stat-card {
        border-left: 4px solid var(--theme-primary, var,--bs-primary);
        background: var(--theme-bg-card, var,--bs-body-bg);
        border: 1px solid var(--theme-border, var,--bs-border-color);
        border-left: 4px solid var(--theme-primary, var,--bs-primary);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px -2px rgb(0 0 0 / 0.15);
    }
    
    .stat-card.success {
        border-left-color: var(--bs-success);
    }
    
    .stat-card.danger {
        border-left-color: var(--bs-danger);
    }
    
    .stat-card.warning {
        border-left-color: var(--bs-warning);
    }

    .stat-card .card-body h3 {
        color: var(--theme-primary, var,--bs-primary);
    }

    .stat-card.success .card-body h3 {
        color: var(--bs-success);
    }

    .stat-card.danger .card-body h3 {
        color: var(--bs-danger);
    }

    .stat-card.warning .card-body h3 {
        color: var(--bs-warning);
    }
    
    /* Cards */
    .card {
        background: var(--theme-bg-card, var,--bs-body-bg);
        border: 1px solid var(--theme-border, var (--bs-border-color));
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
    }

    .card-header {
        background: var(--theme-bg-surface, var (--bs-secondary-bg));
        border-bottom: 1px solid var(--theme-border, var (--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .card-body {
        background: var(--theme-bg-card, var,--bs-body-bg));
    }
    
    /* List Items */
    .sensor-list-item {
        transition: all 0.2s;
    }
    
    .sensor-list-item:hover {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        transform: translateX(2px);
    }

    /* Tables */
    .table {
        color: var(--theme-text, var,--bs-body-color));
    }

    .table thead th {
        background: var(--theme-bg-surface, var,--bs-secondary-bg));
        border-color: var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .table tbody tr {
        border-color: var(--theme-border, var,--bs-border-color));
    }

    .table-hover tbody tr:hover {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
    }

    /* Modals */
    .modal-content {
        background: var(--theme-bg-card, var,--bs-body-bg));
        border: 1px solid var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .modal-header {
        border-bottom: 1px solid var(--theme-border, var,--bs-border-color));
    }

    .modal-footer {
        border-top: 1px solid var(--theme-border, var,--bs-border-color));
    }

    /* Form Controls */
    .form-control, .form-select {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        border-color: var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .form-control:focus, .form-select:focus {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        border-color: var(--theme-primary, var,--bs-primary));
        color: var(--theme-text, var,--bs-body-color));
    }

    /* Empty States */
    .text-center.py-4.text-muted {
        color: var(--theme-text-muted, var,--bs-secondary-color)) !important;
    }

    /* Page Header */
    h1 {
        color: var(--theme-text, var,--bs-body-color));
        margin-bottom: 0;
    }

    /* Badges */
    .badge {
        font-weight: 500;
    }

    /* Buttons - Ensure they respect theme colors */
    .btn-primary {
        background-color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
        color: #fff;
    }

    .btn-primary:hover,
    .btn-primary:focus,
    .btn-primary:active {
        background-color: var(--theme-primary-dark, var,--bs-primary));
        border-color: var(--theme-primary-dark, var,--bs-primary));
        color: #fff;
        opacity: 0.9;
    }

    .btn-outline-primary {
        color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
    }

    .btn-outline-primary:hover,
    .btn-outline-primary:focus,
    .btn-outline-primary:active {
        background-color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
        color: #fff;
    }
</style>
</head>
<body>
    <!-- Universal App Ribbon -->
    {% include 'components/ribbon.html' %}
    
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-broadcast-tower"></i> Sensor Master Control</h1>
        <div>
            <button class="btn btn-success" onclick="showAddDeviceModal()">
                <i class="fas fa-plus"></i> Add Device
            </button>
            <button class="btn btn-info" onclick="showCodeExportModal()">
                <i class="fas fa-code"></i> Export ESP32 Code
            </button>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statsContainer">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h6 class="text-muted">Total Sensors</h6>
                    <h3 id="stat-total-sensors">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card success">
                <div class="card-body">
                    <h6 class="text-muted">Online</h6>
                    <h3 id="stat-online-sensors" class="text-success">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card danger">
                <div class="card-body">
                    <h6 class="text-muted">Offline</h6>
                    <h3 id="stat-offline-sensors" class="text-danger">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card warning">
                <div class="card-body">
                    <h6 class="text-muted">Pending</h6>
                    <h3 id="stat-pending-sensors" class="text-warning">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Registered Sensors -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-microchip"></i> Registered Sensors</h5>
            <div>
                <select class="form-select form-select-sm" id="statusFilter" onchange="loadSensors()">
                    <option value="">All Status</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="sensorsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sensor Scripts Library -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-file-code"></i> Sensor Scripts Library</h5>
            <button class="btn btn-sm btn-success" onclick="showUploadScriptModal()">
                <i class="fas fa-plus"></i> Upload New Script
            </button>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Script Management:</strong> Upload Arduino or MicroPython scripts here. Once uploaded, assign them to specific sensors in the Script Assignments section below.
            </div>
            <div id="scriptsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Assignments -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-link"></i> Script Assignments</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i>
                <strong>Assign Scripts to Sensors:</strong> Select which script each sensor should run. Changes take effect on the next sensor check-in (typically within 30 seconds).
            </div>
            <div id="assignmentsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>



<!-- Sensor Detail Modal -->
<div class="modal fade" id="sensorDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sensor Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sensorDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- ESP32 Code Export Modal -->
<div class="modal fade" id="codeExportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-code"></i> Export ESP32 Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Sensor (Optional)</label>
                        <select class="form-select" id="exportSensorId">
                            <option value="">Generate New Template</option>
                        </select>
                        <small class="text-muted">Select an existing sensor or leave blank for template</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sensor Type</label>
                        <input type="text" class="form-control" id="exportSensorType" 
                               value="esp32_fermentation" placeholder="esp32_fermentation">
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label">Language <span class="text-danger">*</span></label>
                        <select class="form-select" id="exportLanguage">
                            <option value="arduino">Arduino C++</option>
                            <option value="micropython">MicroPython</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">WiFi SSID</label>
                        <input type="text" class="form-control" id="exportWifiSsid" 
                               placeholder="Your WiFi Name">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">WiFi Password</label>
                        <input type="password" class="form-control" id="exportWifiPassword" 
                               placeholder="Your WiFi Password">
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Generated Code Features:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>OFFLINE MODE</strong>: Runs independently when master control is unavailable</li>
                        <li><strong>ONLINE MODE</strong>: Full integration with master control for remote configuration</li>
                        <li>Automatic retry and fallback mechanisms</li>
                        <li>Persistent configuration storage</li>
                        <li>Customizable sensor reading sections</li>
                    </ul>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Generated Code</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyCodeToClipboard()">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="downloadCode()">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                
                <div id="codeExportLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating code...</span>
                    </div>
                    <p class="mt-3">Generating ESP32 code...</p>
                </div>
                
                <div id="codeExportResult" style="display: none;">
                    <div class="config-viewer" style="max-height: 600px;">
                        <pre id="generatedCode"></pre>
                    </div>
                </div>
                
                <div id="codeExportError" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="codeExportErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="generateCode()">
                    <i class="fas fa-magic"></i> Generate Code
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Script Modal -->
<div class="modal fade" id="uploadScriptModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create Library Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Script Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="scriptName" placeholder="e.g., Standard Blink" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Script Version</label>
                        <input type="text" class="form-control" id="scriptVersion" value="1.0.0" placeholder="1.0.0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Script Type</label>
                        <select class="form-select" id="scriptType">
                            <option value="arduino">Arduino C++</option>
                            <option value="micropython">MicroPython</option>
                            <option value="snippet">Code Snippet</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Description (Optional)</label>
                    <input type="text" class="form-control" id="scriptDescription" 
                           placeholder="e.g., LED blink pattern update">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Target Sensor Type (Optional)</label>
                    <input type="text" class="form-control" id="scriptTargetType" 
                           placeholder="e.g., esp32_fermentation">
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Library Script:</strong> This script will be saved to the library and can be assigned to multiple sensors later.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Script Content (JSON Commands) <span class="text-danger">*</span></label>
                    <textarea class="form-control font-monospace" id="scriptContent" rows="15" 
                              placeholder='{
  "name": "LED Blink Pattern",
  "version": "1.0.0",
  "actions": [
    {"type": "gpio_write", "pin": 2, "value": "HIGH"},
    {"type": "delay", "ms": 1000},
    {"type": "gpio_write", "pin": 2, "value": "LOW"},
    {"type": "delay", "ms": 1000},
    {"type": "read_temperature"},
    {"type": "log", "message": "Pattern complete"}
  ]
}'></textarea>
                    <small class="text-muted">
                        <strong>JSON Command System:</strong> ESP32 interprets these commands at runtime. 
                        Available actions: <code>gpio_write</code>, <code>gpio_read</code>, <code>analog_read</code>, 
                        <code>read_temperature</code>, <code>set_relay</code>, <code>delay</code>, <code>log</code>
                    </small>
                </div>
                
                <div id="scriptUploadResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadScript()">
                    <i class="fas fa-save"></i> Save to Library
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Script Modal -->
<div class="modal fade" id="assignScriptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-link"></i> Assign Script to Sensor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Assigning script: <strong id="assignScriptName"></strong></p>
                
                <div class="mb-3">
                    <label class="form-label">Select Sensor <span class="text-danger">*</span></label>
                    <select class="form-select" id="assignSensorId" required>
                        <option value="">Choose a sensor...</option>
                    </select>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Note:</strong> This will replace any currently active script on the selected sensor.
                </div>
                
                <div id="assignScriptResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAssignScriptModal()">
                    <i class="fas fa-check"></i> Assign Script
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Script Modal -->
<div class="modal fade" id="viewScriptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-code"></i> View Script Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Name:</strong> <span id="viewScriptName"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Version:</strong> <span id="viewScriptVersion" class="badge bg-secondary"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Type:</strong> <span id="viewScriptType"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Target Sensor:</strong> <span id="viewScriptTarget"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p id="viewScriptDescription" class="text-muted"></p>
                </div>
                <div class="mb-3">
                    <strong>Script Content:</strong>
                    <pre id="viewScriptContent" class="bg-light p-3 border rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Logic Builder Modal -->
<div class="modal fade" id="logicBuilderModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Logic Builder - <span id="logicBuilderSensorName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="logicBuilderTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual-pane" type="button" onclick="syncJsonToVisual()">Visual Builder</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json-pane" type="button" onclick="syncVisualToJson()">JSON Editor</button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Visual Builder Pane -->
                    <div class="tab-pane fade show active" id="visual-pane">
                        <div class="row">
                            <div class="col-md-3 border-end">
                                <h6>Toolbox</h6>
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('gpio_write')"><i class="fas fa-bolt"></i> GPIO Write</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('gpio_read')"><i class="fas fa-eye"></i> GPIO Read</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('pwm_write')"><i class="fas fa-wave-square"></i> PWM Write</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('analog_write')"><i class="fas fa-bezier-curve"></i> DAC Write</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('analog_read')"><i class="fas fa-chart-bar"></i> Analog Read</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('read_temperature')"><i class="fas fa-thermometer-half"></i> Read Temperature</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('set_relay')"><i class="fas fa-toggle-on"></i> Set Relay</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('delay')"><i class="fas fa-clock"></i> Delay</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="addLogicBlock('log')"><i class="fas fa-comment-alt"></i> Log Message</button>
                                    <button class="btn btn-outline-warning btn-sm text-start" onclick="addLogicBlock('if')"><i class="fas fa-code-branch"></i> If Condition</button>
                                </div>
                                <hr>
                                <h6>Sensor Capabilities</h6>
                                <div id="sensorCapabilitiesList" class="small text-muted overflow-auto" style="max-height: 300px;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="alert alert-info py-1 px-2 mb-2 small">
                                    <i class="fas fa-info-circle"></i> Drag and drop blocks to reorder, or use the Up/Down buttons.
                                </div>
                                <div id="logicCanvas" class="p-3 bg-light border rounded" style="min-height: 400px;">
                                    <!-- Blocks go here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- JSON Editor Pane -->
                    <div class="tab-pane fade" id="json-pane">
                        <textarea id="logicJsonEditor" class="form-control font-monospace" rows="20"></textarea>
                        <div class="mt-2 text-end">
                            <button class="btn btn-sm btn-outline-secondary" onclick="formatJson()">Format JSON</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveLogicBuilder()">Save Logic</button>
            </div>
        </div>
    </div>
</div>

<!-- Sensor Plotter Modal -->
<div class="modal fade" id="sensorPlotterModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-terminal me-2"></i>Sensor Serial Monitor: <span id="plotterSensorId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Live Logs</h6>
                    <div>
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                            <label class="form-check-label" for="autoScrollToggle">Auto-scroll</label>
                        </div>
                        <button class="btn btn-outline-info btn-sm me-2" onclick="resetPlotterHistory()" id="plotterHistoryBtn" style="display: none;">
                            <i class="fas fa-history"></i> History
                        </button>
                        <button class="btn btn-outline-warning btn-sm me-2" onclick="sendTestLog()">
                            <i class="fas fa-bug"></i> Test Log
                        </button>
                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="togglePlotterPause()" id="plotterPauseBtn">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearPlotterData()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Logs Section (Predominate) -->
                <div id="plotterLogs" class="bg-dark text-light p-3 border rounded mb-0 font-monospace" style="height: 70vh; overflow-y: auto; font-size: 0.9rem;">
                    <div class="text-white-50">Waiting for logs...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h6>Manual Entry</h6>
                        <form id="addDeviceForm">
                            <div class="mb-3">
                                <label class="form-label">Sensor ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newSensorId" required placeholder="e.g. esp32_fermentation_002">
                                <div class="form-text">Unique identifier for the device. Must match the ID in the device firmware.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Friendly Name</label>
                                <input type="text" class="form-control" id="newSensorName" placeholder="e.g. Fermentation Chamber 2">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Sensor Type</label>
                                <input type="text" class="form-control" id="newSensorType" placeholder="e.g. esp32_fermentation">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">IP Address (Optional)</label>
                                <input type="text" class="form-control" id="newSensorIp" placeholder="e.g. 192.168.1.100">
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Network Scan</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="scanForDevices()" id="scanBtn">
                                <i class="fas fa-search"></i> Scan
                            </button>
                        </div>
                        <div id="scanResults" class="list-group overflow-auto" style="max-height: 300px;">
                            <div class="text-center text-muted py-4">
                                <small>Click Scan to find devices on your network.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="registerDevice()">Register Device</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let sensors = [];


// --- Sensor Plotter Logic ---
let plotterSensorId = null;
let plotterInterval = null;
let isPlotterPaused = false;
let lastLogId = 0;

async function openSensorPlotter(sensorId) {
    plotterSensorId = sensorId;
    document.getElementById('plotterSensorId').textContent = sensorId;
    
    // Reset state
    isPlotterPaused = false;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('sensorPlotterModal'));
    modal.show();
    
    const logsContainer = document.getElementById('plotterLogs');
    const historyBtn = document.getElementById('plotterHistoryBtn');
    
    logsContainer.innerHTML = '<div class="text-white-50 p-2">Connecting...</div>';
    
    // Initialize lastLogId to the current latest ID to avoid showing history
    try {
        const response = await fetch(`/api/sensor-master/logs/${plotterSensorId}?limit=1`);
        if (response.ok) {
            const data = await response.json();
            if (data.logs && data.logs.length > 0) {
                lastLogId = data.logs[0].id; // Logs are ordered DESC, so first is latest
                if (historyBtn) historyBtn.style.display = 'inline-block';
            } else {
                lastLogId = 0;
                if (historyBtn) historyBtn.style.display = 'none';
            }
        }
    } catch (e) {
        console.error("Error initializing plotter:", e);
        lastLogId = 0;
        if (historyBtn) historyBtn.style.display = 'none';
    }
    
    logsContainer.innerHTML = '<div class="text-white-50 p-2"><i>Connected. Listening for new logs...</i></div>';
    updatePauseButton();
    
    // Start polling
    if (plotterInterval) clearInterval(plotterInterval);
    plotterInterval = setInterval(() => {
        fetchPlotterLogs();
    }, 2000); // Poll every 2 seconds
    
    // Handle modal close to stop polling
    document.getElementById('sensorPlotterModal').addEventListener('hidden.bs.modal', function () {
        if (plotterInterval) {
            clearInterval(plotterInterval);
            plotterInterval = null;
        }
    }, { once: true });
}

function resetPlotterHistory() {
    lastLogId = 0;
    document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2">Fetching history...</div>';
    document.getElementById('plotterHistoryBtn').style.display = 'none';
    fetchPlotterLogs();
}

async function fetchPlotterLogs() {
    if (isPlotterPaused || !plotterSensorId) return;

    try {
        // Fetch logs newer than lastLogId
        // If lastLogId is 0, we fetch the latest 50 logs (default limit)
        // If lastLogId > 0 (because we cleared or have seen logs), we fetch only newer ones
        const url = `/api/sensor-master/logs/${plotterSensorId}?min_id=${lastLogId}&limit=50`;
        const response = await fetch(url);
        if (!response.ok) return;
        
        const data = await response.json();
        
        if (data.logs && data.logs.length > 0) {
            // Update lastLogId to the max ID received
            const maxId = Math.max(...data.logs.map(l => l.id));
            if (maxId > lastLogId) {
                lastLogId = maxId;
            }
            
            updatePlotterLogs(data.logs);
        } else if (lastLogId === 0) {
            // Only show "No logs" if we haven't received any logs yet AND we haven't cleared anything
            document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2">No logs available</div>';
        }
    } catch (error) {
        console.error('Error fetching plotter logs:', error);
    }
}

function updatePlotterLogs(logs) {
    const container = document.getElementById('plotterLogs');
    
    // Check if the container ONLY contains a placeholder message
    // We check if there are any log entries (divs with border-bottom)
    // If not, we can safely clear whatever is there (placeholders)
    if (!container.querySelector('div.border-bottom')) {
        container.innerHTML = '';
    }
    
    // Sort logs by ID ascending (oldest first) so we append them in order
    const sortedLogs = [...logs].sort((a, b) => a.id - b.id);
    
    // Format logs
    const html = sortedLogs.map(log => {
        // Convert UTC timestamp to local time
        const time = new Date(log.created_at).toLocaleTimeString();
        let colorClass = 'text-light';
        if (log.log_level === 'error') colorClass = 'text-danger';
        else if (log.log_level === 'warning') colorClass = 'text-warning';
        else if (log.log_level === 'debug') colorClass = 'text-secondary';
        
        return `<div class="mb-1 border-bottom border-secondary border-opacity-25 pb-1 font-monospace">
            <span class="text-white-50" style="font-size: 0.8em; margin-right: 8px;">[${time}]</span>
            <span class="${colorClass}">${log.message}</span>
        </div>`;
    }).join('');
    
    container.insertAdjacentHTML('beforeend', html);
    
    // Auto-scroll if enabled
    const autoScroll = document.getElementById('autoScrollToggle').checked;
    if (autoScroll) {
        container.scrollTop = container.scrollHeight;
    }
}

function togglePlotterPause() {
    isPlotterPaused = !isPlotterPaused;
    updatePauseButton();
}

function updatePauseButton() {
    const btn = document.getElementById('plotterPauseBtn');
    if (isPlotterPaused) {
        btn.innerHTML = '<i class="fas fa-play"></i> Resume';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-success');
    } else {
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-outline-secondary');
    }
}

function clearPlotterData() {
    // Clear the UI
    document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2"><i>Logs cleared. Listening for new entries...</i></div>';
    
    // Show history button since we now have hidden history
    const historyBtn = document.getElementById('plotterHistoryBtn');
    if (historyBtn) historyBtn.style.display = 'inline-block';
}

async function sendTestLog() {
    if (!plotterSensorId) return;
    
    try {
        const response = await fetch('/api/sensor-master/logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensor_id: plotterSensorId,
                message: 'Test log message from console',
                level: 'info'
            })
        });
        
        if (response.ok) {
            // Don't need to do anything, the poller will pick it up
            console.log('Test log sent');
        } else {
            console.error('Failed to send test log');
            showAlert('Failed to send test log', 'danger');
        }
    } catch (error) {
        console.error('Error sending test log:', error);
        showAlert('Error sending test log: ' + error.message, 'danger');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    refreshData();
    
    // Auto-refresh every 30 seconds for real-time updates
    setInterval(refreshData, 30000);
});

async function refreshData() {
    // Load sensors first and show assignments immediately
    await loadSensors();
    loadAssignments(); // Don't await - render immediately with what we have
    
    // Then load everything else in parallel
    await Promise.all([
        loadScripts().then(() => renderAssignments()), // Re-render when scripts load
        loadStats()
    ]);
    
    // Update sensor status indicators based on heartbeat
    updateSensorStatusIndicators();
}

function updateSensorStatusIndicators() {
    // Check each sensor's last_check_in and update visual indicators
    const HEARTBEAT_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes in milliseconds
    const now = new Date();
    
    sensors.forEach(sensor => {
        if (!sensor.last_check_in) {
            sensor.status = 'pending';
            return;
        }
        
        const lastCheckIn = new Date(sensor.last_check_in);
        const timeSinceLastCheck = now - lastCheckIn;
        
        // Update status based on time since last heartbeat
        if (timeSinceLastCheck > HEARTBEAT_TIMEOUT_MS) {
            if (sensor.status !== 'offline') {
                sensor.status = 'offline';
                console.log(`Sensor ${sensor.sensor_id} marked as offline (last seen ${Math.floor(timeSinceLastCheck / 60000)} minutes ago)`);
            }
        } else {
            if (sensor.status !== 'online') {
                sensor.status = 'online';
            }
        }
    });
    
    // Re-render displays to show updated status
    renderSensors();
    loadStats();
}



async function loadAssignments() {
    try {
        const container = document.getElementById('assignmentsContainer');
        
        // Show sensors immediately, even if scripts aren't loaded yet
        if (sensors.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-microchip fa-3x mb-3"></i>
                    <p>No sensors registered yet. Register sensors to assign scripts.</p>
                </div>
            `;
            return;
        }
        
        // Render whatever we have - show loading state for scripts if needed
        renderAssignments();
    } catch (error) {
        console.error('Error loading assignments:', error);
    }
}

function renderAssignments() {
    const container = document.getElementById('assignmentsContainer');
    // We consider scripts loaded if the array exists, even if empty.
    // If it's null/undefined, we might still be fetching.
    // But loadScripts initializes it to [] and populates it.
    // So we can just check if we have sensors.
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>Sensor</th>
                <th>Type</th>
                <th>Status</th>
                <th>Assigned Script</th>
                <th>Version Running</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    sensors.forEach(sensor => {
        const assignedScript = sensor.assigned_script;
        
        // Build script options
        let scriptOptions = '<option value="">-- Select Script --</option>';
        if (scripts && scripts.length > 0) {
            scriptOptions += scripts.map(s => 
                `<option value="${s.id}" ${assignedScript && assignedScript.id === s.id ? 'selected' : ''}>
                    ${s.name} (v${s.script_version})
                </option>`
            ).join('');
        } else {
            scriptOptions += '<option value="" disabled>No library scripts available</option>';
        }
        
        // Script status display
        let scriptStatus = '<span class="text-muted">None</span>';
        if (assignedScript) {
            const scriptState = assignedScript.status || 'unknown';
            
            if (scriptState === 'running') {
                scriptStatus = `
                    <div>
                        ${assignedScript.name}
                        <span class="badge bg-success ms-2"><i class="fas fa-check-circle"></i> Running</span>
                    </div>
                `;
            } else if (scriptState === 'pending') {
                scriptStatus = `
                    <div>
                        ${assignedScript.name}
                        <span class="badge bg-warning ms-2"><i class="fas fa-upload"></i> Pending Upload</span>
                    </div>
                `;
            } else if (scriptState === 'outdated') {
                scriptStatus = `
                    <div>
                        ${assignedScript.name}
                        <span class="badge bg-info ms-2"><i class="fas fa-sync"></i> Updating</span>
                    </div>
                `;
            } else {
                scriptStatus = `
                    <div>
                        ${assignedScript.name}
                        <span class="badge bg-secondary ms-2"><i class="fas fa-question"></i> Unknown</span>
                    </div>
                `;
            }
        }
        
        // Version info
        let versionInfo = '<span class="text-muted">-</span>';
        if (sensor.running_script_version) {
            const runningVersion = sensor.running_script_version;
            const assignedVersion = assignedScript ? assignedScript.version : null;
            
            if (assignedVersion && runningVersion !== assignedVersion) {
                versionInfo = `
                    <div>
                        <code class="text-warning">${runningVersion}</code>
                        <i class="fas fa-arrow-right text-muted"></i>
                        <code class="text-success">${assignedVersion}</code>
                    </div>
                `;
            } else {
                versionInfo = `<code class="text-success">${runningVersion}</code>`;
            }
        } else if (assignedScript) {
            versionInfo = `<span class="badge bg-info"><i class="fas fa-upload"></i> Pending</span>`;
        }
        
        // Actions dropdown
        let actionsHtml = `
            <select class="form-select form-select-sm" onchange="assignScript('${sensor.sensor_id}', this.value)">
                ${scriptOptions}
            </select>
        `;
        
        html += `
            <tr>
                <td>
                    <strong>${sensor.sensor_name || sensor.sensor_id}</strong><br>
                    <small class="text-muted"><code>${sensor.sensor_id}</code></small>
                </td>
                <td><span class="badge bg-secondary">${sensor.sensor_type}</span></td>
                <td>
                    <i class="fas fa-circle sensor-status-${sensor.status}"></i>
                    ${sensor.status}
                </td>
                <td>${scriptStatus}</td>
                <td>${versionInfo}</td>
                <td>${actionsHtml}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    container.innerHTML = html;
}

async function assignScript(sensorId, scriptId) {
    if (!scriptId) {
        if (!confirm(`Remove script assignment from sensor ${sensorId}?`)) return;
        showAlert('To remove a script, please assign a new one or use the API directly.', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/assign-library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                library_script_id: scriptId,
                sensor_id: sensorId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(`Script assigned to ${sensorId} successfully`, 'success');
            await loadSensors();
        } else {
            throw new Error(data.error || 'Failed to assign script');
        }
    } catch (error) {
        console.error('Error assigning script:', error);
        showAlert('Failed to assign script: ' + error.message, 'danger');
    }
}

async function loadSensors() {
    try {
        const statusFilter = document.getElementById('statusFilter').value;
        let url = '/api/sensor-master/sensors';
        if (statusFilter) {
            url += `?status=${statusFilter}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load sensors');
        
        sensors = await response.json();
        renderSensors();
    } catch (error) {
        console.error('Error loading sensors:', error);
        showAlert('Failed to load sensors', 'danger');
    }
}

function renderSensors() {
    const container = document.getElementById('sensorsContainer');
    
    if (sensors.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-microchip fa-3x mb-3"></i>
                <p>No sensors registered yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Sensor ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Current Script</th>
                        <th>Running Version</th>
                        <th>Last Check-in</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sensors.map(sensor => {
                        // Build script status indicator using assigned_script
                        let scriptIndicator = '<span class="badge bg-secondary"><i class="fas fa-minus"></i> No script</span>';
                        
                        if (sensor.assigned_script) {
                            const script = sensor.assigned_script;
                            const scriptStatus = script.status || 'unknown';
                            
                            // Status-based badges
                            if (scriptStatus === 'running') {
                                scriptIndicator = `<span class="badge bg-success" title="${script.name} v${script.version} - Running"><i class="fas fa-check-circle"></i> ${script.name}</span>`;
                            } else if (scriptStatus === 'pending') {
                                scriptIndicator = `<span class="badge bg-warning" title="${script.name} v${script.version} - Pending upload to device"><i class="fas fa-clock"></i> Pending</span>`;
                            } else if (scriptStatus === 'outdated') {
                                scriptIndicator = `<span class="badge bg-info" title="${script.name} v${script.version} - Update pending"><i class="fas fa-sync"></i> Updating</span>`;
                            } else {
                                scriptIndicator = `<span class="badge bg-secondary" title="${script.name}"><i class="fas fa-question"></i> Unknown</span>`;
                            }
                        }
                        
                        // Build running version indicator
                        let versionIndicator = '<span class="text-muted">-</span>';
                        if (sensor.running_script_version) {
                            const runningVersion = sensor.running_script_version;
                            const assignedVersion = sensor.assigned_script ? sensor.assigned_script.version : null;
                            
                            if (assignedVersion && runningVersion !== assignedVersion) {
                                // Version mismatch - needs update
                                versionIndicator = `
                                    <div>
                                        <code class="text-warning">${runningVersion}</code>
                                        <i class="fas fa-arrow-right text-muted"></i>
                                        <code class="text-success">${assignedVersion}</code>
                                    </div>
                                `;
                            } else {
                                // Running latest version
                                versionIndicator = `<code class="text-success">${runningVersion}</code>`;
                            }
                        } else if (sensor.assigned_script) {
                            // Has script but sensor hasn't reported version
                            versionIndicator = `
                                <span class="badge bg-info" title="Script assigned, waiting for device to report version">
                                    <i class="fas fa-upload"></i> Uploading...
                                </span>
                            `;
                        }
                        
                        return `
                        <tr class="sensor-list-item">
                            <td><code>${sensor.sensor_id}</code></td>
                            <td>${sensor.sensor_name || 'Unnamed'}</td>
                            <td><span class="badge bg-secondary">${sensor.sensor_type}</span></td>
                            <td>
                                <i class="fas fa-circle sensor-status-${sensor.status}"></i>
                                ${sensor.status}
                            </td>
                            <td>${scriptIndicator}</td>
                            <td>${versionIndicator}</td>
                            <td>${sensor.last_check_in ? new Date(sensor.last_check_in).toLocaleString() : 'Never'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="viewSensorDetails('${sensor.sensor_id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="openLogicBuilder('${sensor.sensor_id}')" title="Logic Builder">
                                    <i class="fas fa-project-diagram"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="openSensorPlotter('${sensor.sensor_id}')" title="Serial Plotter">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteSensor('${sensor.sensor_id}')" title="Delete Sensor">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}



async function loadStats() {
    try {
        // Use the already-loaded sensors array if available, otherwise fetch
        let allSensors = sensors;
        if (!allSensors || allSensors.length === 0) {
            const response = await fetch('/api/sensor-master/sensors');
            if (!response.ok) throw new Error('Failed to load stats');
            allSensors = await response.json();
        }
        
        const stats = {
            total: allSensors.length,
            online: allSensors.filter(s => s.status === 'online').length,
            offline: allSensors.filter(s => s.status === 'offline').length,
            pending: allSensors.filter(s => s.status === 'pending').length
        };
        
        document.getElementById('stat-total-sensors').textContent = stats.total;
        document.getElementById('stat-online-sensors').textContent = stats.online;
        document.getElementById('stat-offline-sensors').textContent = stats.offline;
        document.getElementById('stat-pending-sensors').textContent = stats.pending;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}



async function viewSensorDetails(sensorId) {
    const sensor = sensors.find(s => s.sensor_id === sensorId);
    if (!sensor) return;
    
    const content = `
        <dl class="row">
            <dt class="col-sm-3">Sensor ID:</dt>
            <dd class="col-sm-9"><code>${sensor.sensor_id}</code></dd>
            
            <dt class="col-sm-3">Name:</dt>
            <dd class="col-sm-9">${sensor.sensor_name || 'Unnamed'}</dd>
            
            <dt class="col-sm-3">Type:</dt>
            <dd class="col-sm-9">${sensor.sensor_type}</dd>
            
            <dt class="col-sm-3">Status:</dt>
            <dd class="col-sm-9">
                <i class="fas fa-circle sensor-status-${sensor.status}"></i> ${sensor.status}
            </dd>
            
            <dt class="col-sm-3">Hardware:</dt>
            <dd class="col-sm-9">${sensor.hardware_info || 'N/A'}</dd>
            
            <dt class="col-sm-3">Firmware:</dt>
            <dd class="col-sm-9">${sensor.firmware_version || 'N/A'}</dd>
            
            <dt class="col-sm-3">IP Address:</dt>
            <dd class="col-sm-9">${sensor.ip_address || 'N/A'}</dd>
            
            <dt class="col-sm-3">MAC Address:</dt>
            <dd class="col-sm-9">${sensor.mac_address || 'N/A'}</dd>
            
            <dt class="col-sm-3">Master:</dt>
            <dd class="col-sm-9">${sensor.master_name || 'Unassigned'}</dd>
            
            <dt class="col-sm-3">Last Check-in:</dt>
            <dd class="col-sm-9">${sensor.last_check_in ? new Date(sensor.last_check_in).toLocaleString() : 'Never'}</dd>
            
            <dt class="col-sm-3">Registered:</dt>
            <dd class="col-sm-9">${new Date(sensor.created_at).toLocaleString()}</dd>
            
            <dt class="col-sm-3">Capabilities:</dt>
            <dd class="col-sm-9">
                ${sensor.capabilities && sensor.capabilities.length > 0 
                    ? sensor.capabilities.map(c => `<span class="badge bg-info">${c}</span>`).join(' ')
                    : 'None'}
            </dd>
        </dl>
    `;
    
    document.getElementById('sensorDetailContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('sensorDetailModal')).show();
}

async function deleteSensor(sensorId) {
    if (!confirm('Are you sure you want to delete this sensor registration?')) return;
    
    try {
        const response = await fetch(`/api/sensor-master/sensors/${sensorId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete sensor');
        
        showAlert('Sensor deleted successfully', 'success');
        await loadSensors();
        await loadStats();
    } catch (error) {
        console.error('Error deleting sensor:', error);
        showAlert('Failed to delete sensor', 'danger');
    }
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3" 
             role="alert" style="z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            bootstrap.Alert.getInstance(alert)?.close();
        }
    }, 5000);
}

// ============================================================================
// ESP32 CODE EXPORT FUNCTIONS
// ============================================================================

let generatedCodeData = null;

function showCodeExportModal() {
    // Populate sensor dropdown
    const sensorSelect = document.getElementById('exportSensorId');
    sensorSelect.innerHTML = '<option value="">Generate New Template</option>';
    
    sensors.forEach(sensor => {
        const option = document.createElement('option');
        option.value = sensor.sensor_id;
        option.textContent = `${sensor.sensor_name || sensor.sensor_id} (${sensor.sensor_type})`;
        sensorSelect.appendChild(option);
    });
    
    // Reset form
    document.getElementById('exportSensorType').value = 'esp32_fermentation';
    document.getElementById('exportLanguage').value = 'arduino';
    document.getElementById('exportWifiSsid').value = '';
    document.getElementById('exportWifiPassword').value = '';
    
    // Hide result sections
    document.getElementById('codeExportLoading').style.display = 'none';
    document.getElementById('codeExportResult').style.display = 'none';
    document.getElementById('codeExportError').style.display = 'none';
    
    generatedCodeData = null;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('codeExportModal'));
    modal.show();
}

async function generateCode() {
    const sensorId = document.getElementById('exportSensorId').value || null;
    const sensorType = document.getElementById('exportSensorType').value;
    const language = document.getElementById('exportLanguage').value;
    const wifiSsid = document.getElementById('exportWifiSsid').value;
    const wifiPassword = document.getElementById('exportWifiPassword').value;
    
    // Show loading
    document.getElementById('codeExportLoading').style.display = 'block';
    document.getElementById('codeExportResult').style.display = 'none';
    document.getElementById('codeExportError').style.display = 'none';
    
    try {
        const payload = {
            language: language,
            wifi_ssid: wifiSsid,
            wifi_password: wifiPassword
        };
        
        if (sensorId) {
            payload.sensor_id = sensorId;
        } else if (sensorType) {
            payload.sensor_type = sensorType;
        }
        
        const response = await fetch('/api/sensor-master/export-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            generatedCodeData = data;
            
            // Display the code
            document.getElementById('generatedCode').textContent = data.code;
            document.getElementById('codeExportResult').style.display = 'block';
            
            showAlert('Code generated successfully!', 'success');
        } else {
            throw new Error(data.error || 'Failed to generate code');
        }
    } catch (error) {
        console.error('Error generating code:', error);
        document.getElementById('codeExportErrorMessage').textContent = error.message;
        document.getElementById('codeExportError').style.display = 'block';
    } finally {
        document.getElementById('codeExportLoading').style.display = 'none';
    }
}

function copyCodeToClipboard() {
    if (!generatedCodeData) {
        showAlert('Please generate code first', 'warning');
        return;
    }
    
    const code = document.getElementById('generatedCode').textContent;
    
    navigator.clipboard.writeText(code).then(() => {
        showAlert('Code copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showAlert('Failed to copy code', 'danger');
    });
}

function downloadCode() {
    if (!generatedCodeData) {
        showAlert('Please generate code first', 'warning');
        return;
    }
    
    const code = generatedCodeData.code;
    const filename = generatedCodeData.filename || 'esp32_sensor.ino';
    
    // Create blob and download
    const blob = new Blob([code], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showAlert(`Downloaded ${filename}`, 'success');
}

// ============================================================================
// SCRIPT UPLOAD & MANAGEMENT FUNCTIONS
// ============================================================================

let scripts = [];

async function loadScripts() {
    try {
        const response = await fetch('/api/sensor-master/library-scripts');
        if (!response.ok) throw new Error('Failed to load library scripts');
        
        scripts = await response.json();
        renderScripts();
    } catch (error) {
        console.error('Error loading scripts:', error);
        document.getElementById('scriptsContainer').innerHTML = 
            '<div class="alert alert-danger">Failed to load scripts</div>';
    }
}

function renderScripts() {
    const container = document.getElementById('scriptsContainer');
    
    if (scripts.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-file-code fa-3x mb-3"></i>
                <p>No scripts in library. Click "Upload New Script" to create one.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>Name</th>
                <th>Version</th>
                <th>Type</th>
                <th>Target Sensor</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    scripts.forEach(script => {
        html += `
            <tr>
                <td><strong>${script.name}</strong></td>
                <td><span class="badge bg-secondary">${script.script_version}</span></td>
                <td><code>${script.script_type}</code></td>
                <td>${script.target_sensor_type || '<span class="text-muted">Any</span>'}</td>
                <td>${script.description || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="showAssignScriptModal(${script.id}, '${script.name}')">
                        <i class="fas fa-link"></i> Assign
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewScript(${script.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteScript(${script.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function deleteScript(scriptId) {
    if (!confirm('Are you sure you want to delete this script? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`/api/sensor-master/library-scripts/${scriptId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete script');
        
        showAlert('Script deleted successfully', 'success');
        await loadScripts();
    } catch (error) {
        console.error('Error deleting script:', error);
        showAlert('Failed to delete script', 'danger');
    }
}

function showUploadScriptModal() {
    // Reset form
    document.getElementById('scriptName').value = '';
    document.getElementById('scriptVersion').value = '1.0.0';
    document.getElementById('scriptType').value = 'arduino';
    document.getElementById('scriptDescription').value = '';
    document.getElementById('scriptContent').value = '';
    document.getElementById('scriptTargetType').value = '';
    document.getElementById('scriptUploadResult').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('uploadScriptModal'));
    modal.show();
}

async function uploadScript() {
    const scriptName = document.getElementById('scriptName').value;
    const scriptContent = document.getElementById('scriptContent').value;
    const scriptVersion = document.getElementById('scriptVersion').value;
    const scriptType = document.getElementById('scriptType').value;
    const description = document.getElementById('scriptDescription').value;
    const targetType = document.getElementById('scriptTargetType').value;
    
    // Validation
    if (!scriptName) {
        showAlert('Please enter a script name', 'warning');
        return;
    }
    
    if (!scriptContent.trim()) {
        showAlert('Please enter script content', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: scriptName,
                script_content: scriptContent,
                script_version: scriptVersion,
                script_type: scriptType,
                description: description,
                target_sensor_type: targetType
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Show success message
            const resultDiv = document.getElementById('scriptUploadResult');
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <strong>Script saved to library!</strong><br>
                You can now assign this script to sensors.
            `;
            resultDiv.style.display = 'block';
            
            showAlert('Script saved to library successfully!', 'success');
            
            // Reload scripts
            await loadScripts();
            
            // Close modal after a delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('uploadScriptModal')).hide();
            }, 2000);
        } else {
            throw new Error(data.error || 'Failed to save script');
        }
    } catch (error) {
        console.error('Error saving script:', error);
        const resultDiv = document.getElementById('scriptUploadResult');
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <strong>Error:</strong> ${error.message}
        `;
        resultDiv.style.display = 'block';
    }
}

let currentAssignScriptId = null;

function showAssignScriptModal(scriptId, scriptName) {
    currentAssignScriptId = scriptId;
    document.getElementById('assignScriptName').textContent = scriptName;
    
    // Populate sensor dropdown
    const select = document.getElementById('assignSensorId');
    select.innerHTML = '<option value="">Choose a sensor...</option>';
    
    sensors.forEach(sensor => {
        const option = document.createElement('option');
        option.value = sensor.sensor_id;
        option.textContent = `${sensor.sensor_name} (${sensor.sensor_type})`;
        select.appendChild(option);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('assignScriptModal'));
    modal.show();
}

async function submitAssignScriptModal() {
    const sensorId = document.getElementById('assignSensorId').value;
    
    if (!sensorId) {
        showAlert('Please select a sensor', 'warning');
        return;
    }
    
    if (!currentAssignScriptId) {
        showAlert('No script selected', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/assign-library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                library_script_id: currentAssignScriptId,
                sensor_id: sensorId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const resultDiv = document.getElementById('assignScriptResult');
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `
                               <i class="fas fa-check-circle"></i>
                <strong>Script assigned successfully!</strong>
            `;
            resultDiv.style.display = 'block';
            
            // Reload assignments if that function exists or reload page
            // For now just close modal after delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('assignScriptModal')).hide();
                resultDiv.style.display = 'none';
            }, 1500);
            
        } else {
            throw new Error(data.error || 'Failed to assign script');
        }
    } catch (error) {
        console.error('Error assigning script:', error);
        const resultDiv = document.getElementById('assignScriptResult');
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <strong>Error:</strong> ${error.message}
        `;
        resultDiv.style.display = 'block';
    }
}

function viewScript(scriptId) {
    const script = scripts.find(s => s.id === scriptId);
    if (!script) {
        showAlert('Script not found', 'error');
        return;
    }
    
    document.getElementById('viewScriptName').textContent = script.name;
    document.getElementById('viewScriptVersion').textContent = script.script_version;
    document.getElementById('viewScriptType').textContent = script.script_type;
    document.getElementById('viewScriptTarget').textContent = script.target_sensor_type || 'All';
    document.getElementById('viewScriptDescription').textContent = script.description || 'No description provided.';
    document.getElementById('viewScriptContent').textContent = script.script_content;
    
    new bootstrap.Modal(document.getElementById('viewScriptModal')).show();
}

/* Logic Builder Code */

let currentLogicSensorId = null;
let currentLogicData = { actions: [] };
let currentSensorCapabilities = null;

function openLogicBuilder(sensorId) {
    currentLogicSensorId = sensorId;
    const sensor = sensors.find(s => s.sensor_id === sensorId);
    
    if (!sensor) {
        showAlert('Sensor not found', 'error');
        return;
    }
    
    document.getElementById('logicBuilderSensorName').textContent = sensor.sensor_name || sensor.sensor_id;
    
    // Parse capabilities
    try {
        currentSensorCapabilities = typeof sensor.capabilities === 'string' 
            ? JSON.parse(sensor.capabilities) 
            : (sensor.capabilities || {});
    } catch (e) {
        console.error('Error parsing capabilities:', e);
        currentSensorCapabilities = {};
    }
    
    renderCapabilitiesList();
    
    // Load existing logic (from assigned script)
    fetch(`/api/sensor-master/script/${sensorId}`)
        .then(res => res.json())
        .then(data => {
            if (data && data.script_available && data.script) {
                try {
                    let scriptContent = data.script;
                    // If it's a string that looks like JSON, parse it
                    if (typeof scriptContent === 'string' && scriptContent.trim().startsWith('{')) {
                        const parsed = JSON.parse(scriptContent);
                        // Check if it has actions structure
                        if (parsed.actions) {
                            currentLogicData = parsed;
                        } else if (parsed.commands) {
                            // Convert old commands format to actions
                            currentLogicData = { 
                                name: parsed.name || `Logic for ${sensorId}`,
                                version: parsed.version || '1.0.0',
                                actions: parsed.commands 
                            };
                        } else {
                            // Unknown JSON structure, start fresh but keep raw
                            currentLogicData = { actions: [], raw_script: parsed };
                        }
                    } else {
                        // Not JSON (maybe C++ or Python), start fresh
                        currentLogicData = { actions: [] };
                        console.log('Current script is not JSON logic');
                    }
                } catch (e) {
                    console.error('Error parsing script:', e);
                    currentLogicData = { actions: [] };
                }
            } else {
                currentLogicData = { actions: [] };
            }
            
            // Initialize editors
            document.getElementById('logicJsonEditor').value = JSON.stringify(currentLogicData, null, 2);
            renderLogicCanvas();
            
            new bootstrap.Modal(document.getElementById('logicBuilderModal')).show();
        })
        .catch(err => {
            console.error('Error loading script:', err);
            // Don't block opening the modal on error
            currentLogicData = { actions: [] };
            renderLogicCanvas();
            new bootstrap.Modal(document.getElementById('logicBuilderModal')).show();
        });
}

function renderCapabilitiesList() {
    const container = document.getElementById('sensorCapabilitiesList');
    if (!currentSensorCapabilities || Object.keys(currentSensorCapabilities).length === 0) {
        container.innerHTML = '<p class="text-muted">No capabilities reported.</p>';
        return;
    }
    
    let html = '';
    
    // Pins
    if (currentSensorCapabilities.pins) {
        html += '<strong>Pins:</strong><ul class="list-unstyled ps-2">';
        currentSensorCapabilities.pins.forEach(pin => {
            html += `<li><span class="badge bg-secondary">${pin.pin}</span> ${pin.name || 'Pin ' + pin.pin} (${pin.type})</li>`;
        });
        html += '</ul>';
    }
    
    // Sensors/Data
    if (currentSensorCapabilities.sensors) {
        html += '<strong>Sensors:</strong><ul class="list-unstyled ps-2">';
        currentSensorCapabilities.sensors.forEach(s => {
            html += `<li><i class="fas fa-microchip"></i> ${s.name} (${s.type})</li>`;
        });
        html += '</ul>';
    }
    
    container.innerHTML = html;
}

function renderLogicCanvas() {
    const canvas = document.getElementById('logicCanvas');
    canvas.innerHTML = '';
    
    if (!currentLogicData.actions || currentLogicData.actions.length === 0) {
        canvas.innerHTML = '<div class="text-center text-muted py-5">Empty Logic. Add blocks from the toolbox.</div>';
        return;
    }
    
    renderBlocks(currentLogicData.actions, canvas);
}

function renderBlocks(blocks, container, parentPath = []) {
    blocks.forEach((block, index) => {
        const blockPath = [...parentPath, index];
        const blockPathStr = blockPath.join(',');
        const blockEl = document.createElement('div');
        blockEl.className = 'card mb-2 shadow-sm logic-block';
        blockEl.style.borderLeft = '4px solid var(--bs-primary)';
        
        // Drag and Drop attributes
        blockEl.setAttribute('draggable', 'true');
        blockEl.setAttribute('data-path', blockPathStr);
        
        // Event listeners
        blockEl.addEventListener('dragstart', handleDragStart);
        blockEl.addEventListener('dragover', handleDragOver);
        blockEl.addEventListener('drop', handleDrop);
        blockEl.addEventListener('dragenter', handleDragEnter);
        blockEl.addEventListener('dragleave', handleDragLeave);
        blockEl.addEventListener('dragend', handleDragEnd);
        
        let content = '';
        let headerColor = 'bg-light';
        let icon = 'fa-cube';
        
        // Determine block type and content
        if (block.type === 'gpio_read') {
            icon = 'fa-eye';
            blockEl.style.borderLeftColor = '#17a2b8'; // Info
            content = `
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><label>Pin:</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.pin || 2}" onchange="updateBlockValue('${blockPath.join(',')}', 'pin', parseInt(this.value))"></div>
                    <div class="col-auto"><label>Mode:</label></div>
                    <div class="col">
                        <select class="form-select form-select-sm" onchange="updateBlockValue('${blockPath.join(',')}', 'mode', this.value)">
                            <option value="INPUT" ${block.mode === 'INPUT' ? 'selected' : ''}>INPUT</option>
                            <option value="INPUT_PULLUP" ${block.mode === 'INPUT_PULLUP' ? 'selected' : ''}>INPUT_PULLUP</option>
                            <option value="INPUT_PULLDOWN" ${block.mode === 'INPUT_PULLDOWN' ? 'selected' : ''}>INPUT_PULLDOWN</option>
                        </select>
                    </div>
                </div>
            `;
        } else if (block.type === 'gpio_write') {
            icon = 'fa-bolt';
            blockEl.style.borderLeftColor = '#ffc107'; // Warning
            content = `
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><label>Pin:</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.pin || 2}" onchange="updateBlockValue('${blockPath.join(',')}', 'pin', parseInt(this.value))"></div>
                    <div class="col-auto"><label>Value:</label></div>
                    <div class="col">
                        <select class="form-select form-select-sm" onchange="updateBlockValue('${blockPath.join(',')}', 'value', this.value)">
                            <option value="HIGH" ${block.value === 'HIGH' ? 'selected' : ''}>HIGH</option>
                            <option value="LOW" ${block.value === 'LOW' ? 'selected' : ''}>LOW</option>
                        </select>
                    </div>
                </div>
            `;
        } else if (block.type === 'pwm_write') {
            icon = 'fa-wave-square';
            blockEl.style.borderLeftColor = '#6610f2'; // Purple
            content = `
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><label>Pin:</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.pin || 2}" onchange="updateBlockValue('${blockPath.join(',')}', 'pin', parseInt(this.value))"></div>
                    <div class="col-auto"><label>Duty (0-255):</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.duty || 128}" onchange="updateBlockValue('${blockPath.join(',')}', 'duty', parseInt(this.value))"></div>
                </div>
                <div class="row g-2 align-items-center mt-1">
                    <div class="col-auto"><label>Freq (Hz):</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.freq || 5000}" onchange="updateBlockValue('${blockPath.join(',')}', 'freq', parseInt(this.value))"></div>
                </div>
            `;
        } else if (block.type === 'analog_write') {
            icon = 'fa-bezier-curve';
            blockEl.style.borderLeftColor = '#d63384'; // Pink
            content = `
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><label>Pin (25/26):</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.pin || 25}" onchange="updateBlockValue('${blockPath.join(',')}', 'pin', parseInt(this.value))"></div>
                    <div class="col-auto"><label>Value (0-255):</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.value || 128}" onchange="updateBlockValue('${blockPath.join(',')}', 'value', parseInt(this.value))"></div>
                </div>
            `;
        } else if (block.type === 'analog_read') {
            icon = 'fa-chart-bar';
            blockEl.style.borderLeftColor = '#20c997'; // Teal
            content = `
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><label>Pin:</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.pin || 34}" onchange="updateBlockValue('${blockPath.join(',')}', 'pin', parseInt(this.value))"></div>
                </div>
            `;
        } else if (block.type === 'read_temperature') {
            icon = 'fa-thermometer-half';
            blockEl.style.borderLeftColor = '#e74a3b'; // Red
            content = `<div class="small text-muted">Reads temperature from configured sensor</div>`;
        } else if (block.type === 'set_relay') {
            icon = 'fa-toggle-on';
            blockEl.style.borderLeftColor = '#4e73df'; // Blue
            content = `
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><label>State:</label></div>
                    <div class="col">
                        <select class="form-select form-select-sm" onchange="updateBlockValue('${blockPath.join(',')}', 'state', this.value === 'true')">
                            <option value="true" ${block.state === true ? 'selected' : ''}>ON</option>
                            <option value="false" ${block.state === false ? 'selected' : ''}>OFF</option>
                        </select>
                    </div>
                </div>
            `;
        } else if (block.type === 'delay') {
            icon = 'fa-clock';
            blockEl.style.borderLeftColor = '#6c757d'; // Secondary
            content = `
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><label>Wait (ms):</label></div>
                    <div class="col"><input type="number" class="form-control form-control-sm" value="${block.ms || 1000}" onchange="updateBlockValue('${blockPath.join(',')}', 'ms', parseInt(this.value))"></div>
                    <div class="col-auto"><small class="text-muted">Non-blocking</small></div>
                </div>
            `;
        } else if (block.type === 'log') {
            icon = 'fa-comment-alt';
            blockEl.style.borderLeftColor = '#858796'; // Gray
            content = `
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><label>Message:</label></div>
                    <div class="col"><input type="text" class="form-control form-control-sm" value="${block.message || ''}" onchange="updateBlockValue('${blockPath.join(',')}', 'message', this.value)" placeholder="Log message"></div>
                </div>
                <div class="row g-2 align-items-center mt-1">
                    <div class="col-auto"><label>Value (Opt):</label></div>
                    <div class="col"><input type="text" class="form-control form-control-sm" value="${block.value || ''}" onchange="updateBlockValue('${blockPath.join(',')}', 'value', this.value)" placeholder="Sensor/Variable"></div>
                </div>
            `;
        } else if (block.type === 'if') {
            icon = 'fa-code-branch';
            blockEl.style.borderLeftColor = '#fd7e14'; // Orange
            
            const thenContainerId = `then-${blockPathStr.replace(/,/g, '-')}`;
            const elseContainerId = `else-${blockPathStr.replace(/,/g, '-')}`;
            
            // Helper to generate add button
            const getAddBtn = (path) => `
                <div class="dropdown d-inline-block float-end">
                    <button class="btn btn-xs btn-outline-secondary py-0" type="button" data-bs-toggle="dropdown" title="Add step inside">
                        <i class="fas fa-plus"></i>
                    </button>
                    <ul class="dropdown-menu shadow">
                        <li><h6 class="dropdown-header">Add Step</h6></li>
                        <li><button class="dropdown-item small" onclick="addLogicBlock('gpio_write', '${path}')"><i class="fas fa-bolt fa-fw"></i> GPIO Write</button></li>
                        <li><button class="dropdown-item small" onclick="addLogicBlock('delay', '${path}')"><i class="fas fa-clock fa-fw"></i> Delay</button></li>
                        <li><button class="dropdown-item small" onclick="addLogicBlock('log', '${path}')"><i class="fas fa-comment-alt fa-fw"></i> Log</button></li>
                        <li><button class="dropdown-item small" onclick="addLogicBlock('if', '${path}')"><i class="fas fa-code-branch fa-fw"></i> If...</button></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item small" onclick="addLogicBlock('set_relay', '${path}')"><i class="fas fa-toggle-on fa-fw"></i> Relay</button></li>
                        <li><button class="dropdown-item small" onclick="addLogicBlock('read_temperature', '${path}')"><i class="fas fa-thermometer-half fa-fw"></i> Temp</button></li>
                    </ul>
                </div>
            `;
            
            content = `
                <div class="row g-2 align-items-center mb-2">
                    <div class="col-auto"><label>If:</label></div>
                    <div class="col">
                        <input type="text" class="form-control form-control-sm" placeholder="Sensor/Var" 
                            value="${block.condition?.left || ''}" 
                            onchange="updateBlockValue('${blockPathStr}', 'condition.left', this.value)">
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm" 
                            onchange="updateBlockValue('${blockPathStr}', 'condition.operator', this.value)">
                            <option value="==" ${block.condition?.operator === '==' ? 'selected' : ''}>==</option>
                            <option value="!=" ${block.condition?.operator === '!=' ? 'selected' : ''}>!=</option>
                            <option value=">" ${block.condition?.operator === '>' ? 'selected' : ''}>&gt;</option>
                            <option value="<" ${block.condition?.operator === '<' ? 'selected' : ''}>&lt;</option>
                            <option value=">=" ${block.condition?.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                            <option value="<=" ${block.condition?.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                        </select>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control form-control-sm" placeholder="Value" 
                            value="${block.condition?.right || ''}" 
                            onchange="updateBlockValue('${blockPathStr}', 'condition.right', this.value)">
                    </div>
                </div>
                
                <div class="border rounded p-2 bg-white mb-2">
                    <h6 class="small text-muted mb-2">Then ${getAddBtn(blockPathStr + ',then')}</h6>
                    <div id="${thenContainerId}" class="logic-container" style="min-height: 50px; border: 1px dashed #ccc;" 
                         data-path="${blockPathStr},then"
                         ondragover="handleDragOver(event)" ondrop="handleContainerDrop(event)">
                        <!-- Nested blocks rendered here -->
                    </div>
                </div>
                
                <div class="border rounded p-2 bg-white">
                    <h6 class="small text-muted mb-2">Else ${getAddBtn(blockPathStr + ',else')}</h6>
                    <div id="${elseContainerId}" class="logic-container" style="min-height: 50px; border: 1px dashed #ccc;" 
                         data-path="${blockPathStr},else"
                         ondragover="handleDragOver(event)" ondrop="handleContainerDrop(event)">
                         <!-- Nested blocks rendered here -->
                    </div>
                </div>
            `;
        }
        
        blockEl.innerHTML = `
            <div class="card-header py-1 px-2 ${headerColor} d-flex justify-content-between align-items-center">
                <span class="small fw-bold"><i class="fas ${icon}"></i> ${block.type.toUpperCase()}</span>
                <div>
                    <button class="btn btn-xs btn-link text-muted p-0 me-1" onclick="moveBlock('${blockPath.join(',')}', -1)"><i class="fas fa-arrow-up"></i></button>
                    <button class="btn btn-xs btn-link text-muted p-0 me-1" onclick="moveBlock('${blockPath.join(',')}', 1)"><i class="fas fa-arrow-down"></i></button>
                    <button class="btn btn-xs btn-link text-danger p-0" onclick="deleteBlock('${blockPath.join(',')}')"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="card-body py-2 px-2">
                ${content}
            </div>
        `;
        
        container.appendChild(blockEl);
        
        // Post-processing for IF blocks to render children
        if (block.type === 'if') {
            const thenContainer = blockEl.querySelector(`[data-path="${blockPathStr},then"]`);
            if (block.then) {
                renderBlocks(block.then, thenContainer, [...blockPath, 'then']);
            }
            
            const elseContainer = blockEl.querySelector(`[data-path="${blockPathStr},else"]`);
            if (block.else) {
                renderBlocks(block.else, elseContainer, [...blockPath, 'else']);
            }
        }
    });
}

function getBlockArray(pathStr) {
    if (!pathStr) return currentLogicData.actions;
    
    const parts = pathStr.split(',');
    let current = currentLogicData.actions;
    
    // Navigate to the parent array
    // Path format: "0.then.1" -> index 0, property 'then', index 1
    // We want the array containing the last index
    
    // If path is just "0", we want the root array
    if (parts.length === 1) return currentLogicData.actions;
    
    // If path is "0.then", we want the 'then' array of item 0
    // But wait, my path logic in renderBlocks passes indices as part of path
    // renderBlocks(..., [...blockPath, 'then']) -> [0, 'then']
    // So pathStr "0,then" (joined by comma in calls)
    
    // Let's fix the path parsing. The path is comma separated indices and keys.
    const path = pathStr.split(',');
    
    // We want the array that contains the item at the end of the path
    // If path is [0], array is root
    // If path is [0, 'then', 1], array is root[0].then
    
    for (let i = 0; i < path.length - 1; i++) {
        const key = path[i];
        // If key is a number, it's an index
        if (!isNaN(key)) {
            current = current[parseInt(key)];
        } else {
            // It's a property like 'then' or 'else'
            if (!current[key]) current[key] = [];
            current = current[key];
        }
    }
    
    return current;
}

function addLogicBlock(type, parentPathStr) {
    const newBlock = { type: type };
    
    let targetArray;
    if (parentPathStr) {
        // If parentPathStr is provided (e.g. "0,then"), we want to push to that array
        // My getBlockArray logic gets the array containing the last element
        // But here parentPathStr points TO the array we want to add to
        
        const path = parentPathStr.split(',');
        let current = currentLogicData.actions;
        
        for (let i = 0; i < path.length; i++) {
            const key = path[i];
            if (!isNaN(key)) {
                current = current[parseInt(key)];
            } else {
                if (!current[key]) current[key] = [];
                current = current[key];
            }
        }
        targetArray = current;
    } else {
        targetArray = currentLogicData.actions;
    }
    
    targetArray.push(newBlock);
    renderLogicCanvas();
    syncVisualToJson();
}

function deleteBlock(pathStr) {
    const path = pathStr.split(',');
    const index = parseInt(path[path.length - 1]);
    
    // Get the array containing this item
    let current = currentLogicData.actions;
    for (let i = 0; i < path.length - 1; i++) {
        const key = path[i];
        if (!isNaN(key)) {
            current = current[parseInt(key)];
        } else {
            current = current[key];
        }
    }
    
    current.splice(index, 1);
    renderLogicCanvas();
    syncVisualToJson();
}

function moveBlock(pathStr, direction) {
    const path = pathStr.split(',');
    const index = parseInt(path[path.length - 1]);
    
    // Get the array containing this item
    let current = currentLogicData.actions;
    for (let i = 0; i < path.length - 1; i++) {
        const key = path[i];
        if (!isNaN(key)) {
            current = current[parseInt(key)];
        } else {
            current = current[key];
        }
    }
    
    const newIndex = index + direction;
    if (newIndex >= 0 && newIndex < current.length) {
        const item = current.splice(index, 1)[0];
        current.splice(newIndex, 0, item);
        renderLogicCanvas();
        syncVisualToJson();
    }
}

function moveBlockTo(fromPathStr, toPathStr) {
    const fromPath = fromPathStr.split(',');
    const toPath = toPathStr.split(',');
    
    const fromIndex = parseInt(fromPath[fromPath.length - 1]);
    const toIndex = parseInt(toPath[toPath.length - 1]);
    
    // Get source array
    let sourceArray = currentLogicData.actions;
    for (let i = 0; i < fromPath.length - 1; i++) {
        const key = fromPath[i];
        if (!isNaN(key)) {
            sourceArray = sourceArray[parseInt(key)];
        } else {
            sourceArray = sourceArray[key];
        }
    }
    
    // Get target array
    let targetArray = currentLogicData.actions;
    for (let i = 0; i < toPath.length - 1; i++) {
        const key = toPath[i];
        if (!isNaN(key)) {
            targetArray = targetArray[parseInt(key)];
        } else {
            targetArray = targetArray[key];
        }
    }
    
    // Check if we are moving within the same array
    const fromParentPath = fromPath.slice(0, -1).join(',');
    const toParentPath = toPath.slice(0, -1).join(',');
    
    if (fromParentPath === toParentPath) {
        // Moving within same array
        // If moving down, we need to adjust index because removal shifts subsequent items
        // But splice handles this if we remove first?
        // Example: [A, B, C, D]. Move A (0) to C (2).
        // Remove A: [B, C, D]. Insert at 2: [B, C, A, D]. Correct.
        
        // Example: [A, B, C, D]. Move C (2) to A (0).
        // Remove C: [A, B, D]. Insert at 0: [C, A, B, D]. Correct.
        
        const item = sourceArray.splice(fromIndex, 1)[0];
        sourceArray.splice(toIndex, 0, item);
    } else {
        // Moving between arrays
        const item = sourceArray.splice(fromIndex, 1)[0];
        targetArray.splice(toIndex, 0, item);
    }
    
    renderLogicCanvas();
    syncVisualToJson();
}

function updateBlockValue(pathStr, field, value) {
    const path = pathStr.split(',');
    const index = parseInt(path[path.length - 1]);
    
    // Get the array containing this item
    let current = currentLogicData.actions;
    for (let i = 0; i < path.length - 1; i++) {
        const key = path[i];
        if (!isNaN(key)) {
            current = current[parseInt(key)];
        } else {
            current = current[key];
        }
    }
    
    const item = current[index];
    
    // Handle nested fields (e.g. "condition.left")
    if (field.includes('.')) {
        const parts = field.split('.');
        let obj = item;
        for (let i = 0; i < parts.length - 1; i++) {
            if (!obj[parts[i]]) obj[parts[i]] = {};
            obj = obj[parts[i]];
        }
        obj[parts[parts.length - 1]] = value;
    } else {
        item[field] = value;
    }
    
    syncVisualToJson();
}

function syncVisualToJson() {
    document.getElementById('logicJsonEditor').value = JSON.stringify(currentLogicData, null, 2);
}

function syncJsonToVisual() {
    try {
        const json = document.getElementById('logicJsonEditor').value;
        if (json.trim()) {
            currentLogicData = JSON.parse(json);
            renderLogicCanvas();
        }
    } catch (e) {
        console.error('Invalid JSON', e);
        showAlert('Invalid JSON in editor', 'warning');
    }
}

function formatJson() {
    try {
        const json = document.getElementById('logicJsonEditor').value;
        const parsed = JSON.parse(json);
        document.getElementById('logicJsonEditor').value = JSON.stringify(parsed, null, 2);
    } catch (e) {
        // Ignore
    }
}

async function saveLogicBuilder() {
    if (!currentLogicSensorId) return;
    
    try {
        // Ensure we have the latest data from whichever tab is active
        // If JSON tab is active, we should parse it.
        // But syncJsonToVisual does that.
        
        // If the user edited JSON but didn't switch tabs, we need to grab it.
        const jsonEditor = document.getElementById('logicJsonEditor');
        if (jsonEditor.offsetParent !== null) { // Visible
             try {
                currentLogicData = JSON.parse(jsonEditor.value);
             } catch(e) {
                 showAlert('Invalid JSON. Please fix before saving.', 'danger');
                 return;
             }
        }
        
        const scriptContent = JSON.stringify(currentLogicData, null, 2);
        
        // Save as a new library script and assign it
        const response = await fetch('/api/sensor-master/library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: currentLogicData.name || `Logic for ${currentLogicSensorId} (${new Date().toLocaleTimeString()})`,
                script_content: scriptContent,
                script_version: currentLogicData.version || '1.0.0',
                script_type: 'json',
                description: 'Generated by Logic Builder',
                target_sensor_type: ''
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Assign it
            await assignScript(currentLogicSensorId, data.id);
            
            showAlert('Logic saved and applied successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('logicBuilderModal')).hide();
            
            // Refresh scripts list
            loadScripts();
        } else {
            throw new Error(data.error || 'Failed to save logic');
        }
    } catch (error) {
        console.error('Error saving logic:', error);
        showAlert('Failed to save logic: ' + error.message, 'danger');
    }
}

// --- Drag and Drop Handlers ---
let draggedItemPath = null;

function handleDragStart(e) {
    draggedItemPath = this.getAttribute('data-path');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', draggedItemPath);
    this.classList.add('opacity-50');
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    this.classList.add('border-primary');
    this.classList.add('border-2');
}

function handleDragLeave(e) {
    this.classList.remove('border-primary');
    this.classList.remove('border-2');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    const targetPath = this.getAttribute('data-path');
    
    // Don't do anything if dropping on itself
    if (draggedItemPath === targetPath) {
        return false;
    }
    
    moveBlockTo(draggedItemPath, targetPath);
    
    return false;
}

function handleDragEnd(e) {
    this.classList.remove('opacity-50');
    
    // Clean up any remaining visual classes on all blocks
    document.querySelectorAll('.logic-block').forEach(el => {
        el.classList.remove('border-primary');
        el.classList.remove('border-2');
    });
}

// New handler for dropping into containers (like 'then' and 'else' blocks)
function handleContainerDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    
    const targetPathStr = this.getAttribute('data-path'); // e.g. "0,then"
    
    // Don't allow dropping a parent into its own child
    if (targetPathStr.startsWith(draggedItemPath)) {
        return false;
    }
    
    // Get the target array to find its length
    const path = targetPathStr.split(',');
    let targetArray = currentLogicData.actions;
    
    // Navigate to the array
    for (let i = 0; i < path.length; i++) {
        const key = path[i];
        if (!isNaN(key)) {
            targetArray = targetArray[parseInt(key)];
        } else {
            if (!targetArray[key]) targetArray[key] = [];
            targetArray = targetArray[key];
        }
    }
    
    const newIndex = targetArray.length;
    const newPath = targetPathStr + ',' + newIndex;
    
    moveBlockTo(draggedItemPath, newPath);
    
    return false;
}
</script>
</body>
</html>