<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Master Control - {{ project_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ribbon.css') }}">
    
    <!-- Chart.js for Serial Plotter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    
    <!-- Board Configuration -->
    <script src="{{ url_for('static', filename='js/board-configs.js') }}"></script>

    <!-- Dynamic Theme CSS -->
    <style id="theme-styles">
        {{ theme_css|safe }}
    </style>
    
<style>
    :root {
        --content-spacing: 1.5rem;
        --border-radius: 0.5rem;
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    body {
        background-color: var(--theme-bg-body, var(--bs-body-bg));
        color: var(--theme-text, var(--bs-body-color));
    }

    .container-fluid {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    /* Status Badges */
    .master-status-badge {
        padding: 0.35rem 0.65rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .master-status-active {
        background-color: var(--bs-success-bg-subtle);
        color: var(--bs-success-text-emphasis);
        border: 1px solid var(--bs-success-border-subtle);
    }
    
    .master-status-inactive {
        background-color: var(--bs-danger-bg-subtle);
        color: var(--bs-danger-text-emphasis);
        border: 1px solid var(--bs-danger-border-subtle);
    }
    
    /* Sensor Status Icons */
    .sensor-status-online {
        color: var(--bs-success);
    }
    
    .sensor-status-offline {
        color: var(--bs-danger);
    }
    
    .sensor-status-pending {
        color: var(--bs-warning);
    }

    .sensor-status-hibernating {
        color: var(--bs-warning);
    }
    
    /* Config Viewer */
    .config-viewer {
        background-color: var(--theme-bg-surface, var(--bs-tertiary-bg));
        border: 1px solid var(--theme-border, var(--bs-border-color));
        border-radius: var(--border-radius);
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .config-viewer pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: var(--theme-text, var,--bs-body-color);
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
    }
    
    /* Stat Cards */
    .stat-card {
        border-left: 4px solid var(--theme-primary, var,--bs-primary);
        background: var(--theme-bg-card, var,--bs-body-bg);
        border: 1px solid var(--theme-border, var,--bs-border-color);
        border-left: 4px solid var(--theme-primary, var,--bs-primary);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px -2px rgb(0 0 0 / 0.15);
    }
    
    .stat-card.success {
        border-left-color: var(--bs-success);
    }
    
    .stat-card.danger {
        border-left-color: var(--bs-danger);
    }
    
    .stat-card.warning {
        border-left-color: var(--bs-warning);
    }

    .stat-card .card-body h3 {
        color: var(--theme-primary, var,--bs-primary);
    }

    .stat-card.success .card-body h3 {
        color: var(--bs-success);
    }

    .stat-card.danger .card-body h3 {
        color: var(--bs-danger);
    }

    .stat-card.warning .card-body h3 {
        color: var(--bs-warning);
    }
    
    /* Cards */
    .card {
        background: var(--theme-bg-card, var,--bs-body-bg);
        border: 1px solid var(--theme-border, var (--bs-border-color));
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
    }

    .card-header {
        background: var(--theme-bg-surface, var (--bs-secondary-bg));
        border-bottom: 1px solid var(--theme-border, var (--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .card-body {
        background: var(--theme-bg-card, var,--bs-body-bg));
    }
    
    /* List Items */
    .sensor-list-item {
        transition: all 0.2s;
    }
    
    .sensor-list-item:hover {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        transform: translateX(2px);
    }

    /* Tables */
    .table {
        color: var(--theme-text, var,--bs-body-color));
    }

    .table thead th {
        background: var(--theme-bg-surface, var,--bs-secondary-bg));
        border-color: var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .table tbody tr {
        border-color: var(--theme-border, var,--bs-border-color));
    }

    .table-hover tbody tr:hover {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
    }

    /* Modals */
    .modal-content {
        background: var(--theme-bg-card, var,--bs-body-bg));
        border: 1px solid var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .modal-header {
        border-bottom: 1px solid var(--theme-border, var,--bs-border-color));
    }

    .modal-footer {
        border-top: 1px solid var(--theme-border, var,--bs-border-color));
    }

    /* Form Controls */
    .form-control, .form-select {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        border-color: var(--theme-border, var,--bs-border-color));
        color: var(--theme-text, var,--bs-body-color));
    }

    .form-control:focus, .form-select:focus {
        background-color: var(--theme-bg-surface, var,--bs-tertiary-bg));
        border-color: var(--theme-primary, var,--bs-primary));
        color: var(--theme-text, var,--bs-body-color));
    }

    /* Empty States */
    .text-center.py-4.text-muted {
        color: var(--theme-text-muted, var,--bs-secondary-color)) !important;
    }

    /* Page Header */
    h1 {
        color: var(--theme-text, var,--bs-body-color));
        margin-bottom: 0;
    }

    /* Badges */
    .badge {
        font-weight: 500;
    }

    /* Buttons - Ensure they respect theme colors */
    .btn-primary {
        background-color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
        color: #fff;
    }

    .btn-primary:hover,
    .btn-primary:focus,
    .btn-primary:active {
        background-color: var(--theme-primary-dark, var,--bs-primary));
        border-color: var(--theme-primary-dark, var,--bs-primary));
        color: #fff;
        opacity: 0.9;
    }

    .btn-outline-primary {
        color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
    }

    .btn-outline-primary:hover,
    .btn-outline-primary:focus,
    .btn-outline-primary:active {
        background-color: var(--theme-primary, var,--bs-primary));
        border-color: var(--theme-primary, var,--bs-primary));
        color: #fff;
    }

    @media (max-width: 768px) {
        /* Header adjustments */
        .d-flex.justify-content-between.align-items-center.mb-4 {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 1rem;
        }
        
        .d-flex.justify-content-between.align-items-center.mb-4 > div {
            width: 100%;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .d-flex.justify-content-between.align-items-center.mb-4 > div > button {
            flex: 1;
        }

        /* Table to Card transformation */
        .table-responsive table, 
        .table-responsive thead, 
        .table-responsive tbody, 
        .table-responsive th, 
        .table-responsive td, 
        .table-responsive tr { 
            display: block; 
        }
        
        .table-responsive thead tr { 
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
        
        .table-responsive tr { 
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            background: var(--theme-bg-card, var(--bs-body-bg));
            padding: 1rem;
        }
        
        .table-responsive td { 
            border: none;
            position: relative;
            padding-left: 0;
            padding-right: 0;
            padding-top: 1rem; /* Increased padding */
            padding-bottom: 1rem; /* Increased padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: right;
            border-bottom: 1px solid var(--theme-border, var(--bs-border-color));
            font-size: 1.1rem; /* Increased font size for readability */
        }

        .table-responsive td:last-child {
            border-bottom: none;
        }
        
        .table-responsive td:before { 
            content: attr(data-label);
            font-weight: 700; /* Make label bolder */
            margin-right: 1rem;
            text-align: left;
            color: var(--theme-text, var (--bs-body-color)); /* Use main text color for better contrast */
            opacity: 0.9; /* Increased opacity */
            font-size: 1rem; /* Increased font size */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Specific adjustments for the Actions column */
        .table-responsive td:last-child {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .table-responsive td:last-child > div {
            width: 100%;
            justify-content: flex-end;
        }

        /* Stat Card Mobile Overrides */
        .stat-card .card-body {
            padding: 0.75rem !important;
        }
        
        .stat-card h3 {
            font-size: 1.5rem !important;
        }
        
        .stat-card h6 {
            font-size: 0.8rem !important;
            letter-spacing: 0.5px;
        }
        
        .stat-card i {
            font-size: 1.2rem !important;
            margin-bottom: 0.25rem !important;
        }

        /* Force 2-column grid for stats on mobile */
        #statsContainer {
            display: flex !important;
            flex-wrap: wrap !important;
            flex-direction: row !important;
        }
        
        #statsContainer .col-6 {
            width: 50% !important;
            flex: 0 0 50% !important;
            max-width: 50% !important;
        }
    }
    
    /* Pin indicator and wire animations */
    .pin-indicator {
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    
    .pin-control {
        border-left: 3px solid transparent;
    }
    
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.8);
            opacity: 0.8;
        }
    }
    
    @keyframes wireFlow {
        0% {
            stroke-dashoffset: 1000;
        }
        100% {
            stroke-dashoffset: 0;
        }
    }
    
    .wire {
        stroke-dasharray: 10 5;
        animation: wireFlow 20s linear infinite;
    }
    
    .wire-glow {
        stroke-dasharray: 10 5;
    }

    .structure-tree {
        font-family: 'Arial', sans-serif;
        font-size: 0.875rem;
        color: #333;
        margin-top: 0.5rem;
    }
    
    .structure-tree ul {
        padding-left: 1.5rem;
        margin: 0.5rem 0;
        list-style-type: none;
    }
    
    .structure-tree li {
        margin: 0.25rem 0;
        position: relative;
    }
    
    .structure-tree li:before {
        content: '';
        position: absolute;
        left: -0.75rem;
        top: 0.5rem;
        width: 0.5rem;
        height: 100%;
        border-left: 2px solid #007bff;
        border-top: 2px solid #007bff;
        transform: translateY(-50%);
    }
    
    .structure-tree li:last-child:before {
        height: calc(100% + 0.5rem);
    }
    
    .structure-tree .badge {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }
</style>
</head>
<body>
    <!-- Universal App Ribbon -->
    {% include 'components/ribbon.html' %}
    
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-broadcast-tower"></i> Sensor Master Control</h1>
        <div>
            <button class="btn btn-success" onclick="showAddDeviceModal()">
                <i class="fas fa-plus"></i> Add Device
            </button>
            <button class="btn btn-info" onclick="showCodeExportModal()">
                <i class="fas fa-code"></i> Export ESP32 Code
            </button>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4 g-3" id="statsContainer">
        <div class="col-6 col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center p-3">
                    <div class="text-muted mb-2"><i class="fas fa-microchip fa-lg"></i></div>
                    <h6 class="text-muted small text-uppercase mb-1">Total</h6>
                    <h3 id="stat-total-sensors" class="mb-0 fw-bold">-</h3>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card success h-100">
                <div class="card-body text-center p-3">
                    <div class="text-success mb-2"><i class="fas fa-check-circle fa-lg"></i></div>
                    <h6 class="text-muted small text-uppercase mb-1">Online</h6>
                    <h3 id="stat-online-sensors" class="text-success mb-0 fw-bold">-</h3>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card danger h-100">
                <div class="card-body text-center p-3">
                    <div class="text-danger mb-2"><i class="fas fa-times-circle fa-lg"></i></div>
                    <h6 class="text-muted small text-uppercase mb-1">Offline</h6>
                    <h3 id="stat-offline-sensors" class="text-danger mb-0 fw-bold">-</h3>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card stat-card warning h-100">
                <div class="card-body text-center p-3">
                    <div class="text-warning mb-2"><i class="fas fa-clock fa-lg"></i></div>
                    <h6 class="text-muted small text-uppercase mb-1">Hibernating</h6>
                    <h3 id="stat-pending-sensors" class="text-warning mb-0 fw-bold">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Registered Sensors -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-microchip"></i> Registered Sensors</h5>
            <div>
                <select class="form-select form-select-sm" id="statusFilter" onchange="loadSensors()">
                    <option value="">All Status</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                    <option value="hibernating">Hibernating</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="sensorsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sensor Scripts Library -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-file-code"></i> Sensor Scripts Library</h5>
            <div>
                <button class="btn btn-sm btn-info me-2" onclick="showUploadToManyModal()">
                    <i class="fas fa-tasks"></i> Upload to Many
                </button>
                <button class="btn btn-sm btn-success" onclick="openLogicBuilder()">
                    <i class="fas fa-plus"></i> Upload New Script
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Script Management:</strong> Upload Arduino or MicroPython scripts here. Once uploaded, assign them to specific sensors in the Script Assignments section below.
            </div>
            <div id="scriptsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>





<!-- Sensor Detail Modal -->
<div class="modal fade" id="sensorDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sensor Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sensorDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- ESP32 Code Export Modal -->
<div class="modal fade" id="codeExportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-code"></i> Export ESP32 Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Sensor (Optional)</label>
                        <select class="form-select" id="exportSensorId">
                            <option value="">Generate New Template</option>
                        </select>
                        <small class="text-muted">Select an existing sensor or leave blank for template</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sensor Type</label>
                        <input type="text" class="form-control" id="exportSensorType" 
                               value="esp32_fermentation" placeholder="esp32_fermentation">
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label">Language <span class="text-danger">*</span></label>
                        <select class="form-select" id="exportLanguage">
                            <option value="arduino">Arduino C++</option>
                            <option value="micropython">MicroPython</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">WiFi SSID</label>
                        <input type="text" class="form-control" id="exportWifiSsid" 
                               placeholder="Your WiFi Name">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">WiFi Password</label>
                        <input type="password" class="form-control" id="exportWifiPassword" 
                               placeholder="Your WiFi Password">
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Generated Code Features:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>OFFLINE MODE</strong>: Runs independently when master control is unavailable</li>
                        <li><strong>ONLINE MODE</strong>: Full integration with master control for remote configuration</li>
                        <li>Automatic retry and fallback mechanisms</li>
                        <li>Persistent configuration storage</li>
                        <li>Customizable sensor reading sections</li>
                    </ul>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Generated Code</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyCodeToClipboard()">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="downloadCode()">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                
                <div id="codeExportLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating code...</span>
                    </div>
                    <p class="mt-3">Generating ESP32 code...</p>
                </div>
                
                <div id="codeExportResult" style="display: none;">
                    <div class="config-viewer" style="max-height: 600px;">
                        <pre id="generatedCode"></pre>
                    </div>
                </div>
                
                <div id="codeExportError" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="codeExportErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="generateCode()">
                    <i class="fas fa-magic"></i> Generate Code
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Script Modal -->
<div class="modal fade" id="uploadScriptModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create Library Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Script Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="scriptName" placeholder="e.g., Standard Blink" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Script Version</label>
                        <input type="text" class="form-control" id="scriptVersion" value="1.0.0" placeholder="1.0.0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Script Type</label>
                        <select class="form-select" id="scriptType">
                            <option value="json">JSON Logic</option>
                            <option value="arduino">Arduino C++</option>
                            <option value="micropython">MicroPython</option>
                            <option value="snippet">Code Snippet</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Description (Optional)</label>
                    <input type="text" class="form-control" id="scriptDescription" 
                           placeholder="e.g., LED blink pattern update">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Target Sensor Type (Optional)</label>
                    <input type="text" class="form-control" id="scriptTargetType" 
                           placeholder="e.g., esp32_fermentation">
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Library Script:</strong> This script will be saved to the library and can be assigned to multiple sensors later.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Script Content (JSON Commands) <span class="text-danger">*</span></label>
                    <textarea class="form-control font-monospace" id="scriptContent" rows="15" 
                              placeholder='{
  "name": "LED Blink Pattern",
  "version": "1.0.0",
  "actions": [
    {"type": "gpio_write", "pin": 2, "value": "HIGH"},
    {"type": "delay", "ms": 1000},
    {"type": "gpio_write", "pin": 2, "value": "LOW"},
    {"type": "delay", "ms": 1000},
    {"type": "read_temperature"},
    {"type": "log", "message": "Pattern complete"}
  ]
}'></textarea>
                    <small class="text-muted">
                        <strong>JSON Command System:</strong> ESP32 interprets these commands at runtime. 
                        Available actions: <code>gpio_write</code>, <code>gpio_read</code>, <code>analog_read</code>, 
                        <code>read_temperature</code>, <code>set_relay</code>, <code>delay</code>, <code>log</code>
                    </small>
                </div>
                
                <div id="scriptUploadResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadScript()">
                    <i class="fas fa-save"></i> Save to Library
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Script Modal -->
<div class="modal fade" id="assignScriptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-link"></i> Assign Script to Sensor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Assigning script: <strong id="assignScriptName"></strong></p>
                
                <div class="mb-3">
                    <label class="form-label">Select Sensor <span class="text-danger">*</span></label>
                    <select class="form-select" id="assignSensorId" required>
                        <option value="">Choose a sensor...</option>
                    </select>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Note:</strong> This will replace any currently active script on the selected sensor.
                </div>
                
                <div id="assignScriptResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAssignScriptModal()">
                    <i class="fas fa-check"></i> Assign Script
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Script Modal -->
<div class="modal fade" id="viewScriptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-code"></i> View Script Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Name:</strong> <span id="viewScriptName"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Version:</strong> <span id="viewScriptVersion" class="badge bg-secondary"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Type:</strong> <span id="viewScriptType"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Target Sensor:</strong> <span id="viewScriptTarget"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p id="viewScriptDescription" class="text-muted"></p>
                </div>
                <div class="mb-3">
                    <strong>Script Content:</strong>
                    <pre id="viewScriptContent" class="bg-light p-3 border rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Logic Builder Modal -->
<div class="modal fade" id="logicBuilderModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Logic Builder - <span id="logicBuilderSensorName"></span>
                    <span id="logicBuilderBoardType" class="badge bg-info ms-2" style="font-size: 0.6em; vertical-align: middle;"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Load from Library Section -->
                <div class="row mb-3 align-items-center bg-light p-2 rounded mx-0 border">
                    <div class="col-auto">
                        <label class="fw-bold mb-0"><i class="fas fa-book"></i> Load from Library:</label>
                    </div>
                    <div class="col">
                        <select class="form-select form-select-sm" id="logicLibrarySelect" onchange="loadLogicFromLibrary(this.value)">
                            <option value="">-- Select a script to load --</option>
                        </select>
                    </div>
                    <div class="col-auto border-start ps-3" id="boardTypeSelectorContainer" style="display: none;">
                        <label class="fw-bold mb-0 me-2"><i class="fas fa-microchip"></i> Target Board:</label>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="logicBoardTypeSelect" onchange="changeLogicBoardType(this.value)">
                            <option value="esp32_wroom32">ESP32-WROOM-32</option>
                            <option value="firebeetle2_esp32c6">FireBeetle 2 ESP32-C6</option>
                            <option value="generic">Generic / All</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="logicName" placeholder="Script Name">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Version</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="logicVersion" placeholder="1.0.0">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Bump</button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="bumpVersion('major')">Major (+1.0.0)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="bumpVersion('minor')">Minor (+0.1.0)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="bumpVersion('patch')">Patch (+0.0.1)</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Type</label>
                        <input type="text" class="form-control" id="logicType" placeholder="json" value="json" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="logicDescription" placeholder="Description">
                    </div>
                </div>

                <ul class="nav nav-tabs mb-3" id="logicBuilderTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual-pane" type="button" onclick="syncJsonToVisual()">Visual Builder</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json-pane" type="button" onclick="syncVisualToJson()">JSON Editor</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure-pane" type="button" onclick="renderLogicStructure()">Structure View</button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Visual Builder Pane -->
                    <div class="tab-pane fade show active" id="visual-pane">
                        <div class="row">
                            <div class="col-md-3 border-end" style="height: 65vh; overflow-y: auto;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Hardware Config</h6>
                                    <button class="btn btn-xs btn-outline-primary" onclick="addHardwareConfig()" title="Add Device"><i class="fas fa-plus"></i></button>
                                </div>
                                <div id="hardwareConfigList" class="mb-3">
                                    <!-- Populated via JS -->
                                    <div class="text-muted small fst-italic">No devices configured</div>
                                </div>
                                <hr>
                                <h6>Toolbox</h6>
                                <div class="d-grid gap-2 mb-3" id="logicToolbox">
                                    <!-- Populated via JS -->
                                </div>
                                <hr>
                                <h6>Sensor Capabilities</h6>
                                <div id="sensorCapabilitiesList" class="small text-muted overflow-auto" style="max-height: 200px;">
                                    <!-- Populated via JS -->
                                </div>
                                <hr>
                                <h6>Defined Variables</h6>
                                <div id="availableVariablesList" class="small text-muted overflow-auto" style="max-height: 200px;">
                                    <p class="text-muted">No variables defined.</p>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="alert alert-info py-1 px-2 mb-2 small">
                                    <i class="fas fa-info-circle"></i> Drag and drop blocks to reorder, or use the Up/Down buttons.
                                </div>
                                <div id="logicCanvas" class="p-3 bg-light border rounded" style="height: 65vh; overflow-y: auto;">
                                    <!-- Blocks go here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- JSON Editor Pane -->
                    <div class="tab-pane fade" id="json-pane">
                        <textarea id="logicJsonEditor" class="form-control font-monospace" rows="20"></textarea>
                        <div class="mt-2 text-end">
                            <button class="btn btn-sm btn-outline-secondary" onclick="formatJson()">Format JSON</button>
                        </div>
                    </div>

                    <!-- Structure View Pane -->
                    <div class="tab-pane fade" id="structure-pane">
                        <div class="alert alert-light border mb-3">
                            <i class="fas fa-sitemap"></i> This view shows the nested structure of your logic flow.
                        </div>
                        <div id="logicStructureView" class="p-3 bg-white border rounded font-monospace" style="height: 65vh; overflow-y: auto;">
                            <!-- Structure tree goes here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveLogicBuilder()">Save Logic</button>
            </div>
        </div>
    </div>
</div>

<!-- Sensor Plotter Modal -->
<div class="modal fade" id="sensorPlotterModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-microchip me-2"></i>Interactive Board Monitor: <span id="plotterSensorId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0 h-100">
                    <!-- Board Visualization Column -->
                    <div class="col-md-5 bg-light border-end position-relative" style="height: calc(100vh - 120px); overflow-y: auto;">
                        <div class="p-3">
                            <h6 class="mb-3"><i class="fas fa-microchip"></i> Board Visualization</h6>
                            
                            <!-- Board Image Container -->
                            <div id="boardContainer" class="position-relative mx-auto" style="width: 340px; height: 580px; overflow: visible;">
                                <img id="boardImage" src="" alt="Board" class="img-fluid" style="width: 100%; height: auto; position: relative; z-index: 1;">
                                
                                <!-- Pin overlays will be dynamically added here -->
                                <div id="pinOverlays" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;"></div>
                                
                                <!-- Log overlay on chip -->
                                <div id="chipLogOverlay" class="position-absolute bg-dark text-light font-monospace p-2 border rounded" 
                                     style="font-size: 0.55rem; line-height: 1.1; overflow-y: auto; display: none; opacity: 0.95; z-index: 15; word-wrap: break-word;">
                                </div>
                            </div>
                            
                            <!-- Pin Controls Section -->
                            <div id="pinControlsSection" class="mt-4">
                                <h6 class="mb-3"><i class="fas fa-sliders-h"></i> Pin Controls</h6>
                                <div id="pinControlsList" class="list-group">
                                    <!-- Dynamic pin controls will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logs Column -->
                    <div class="col-md-7 d-flex flex-column" style="height: calc(100vh - 120px);">
                        <div class="p-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-terminal"></i> Live Logs</h6>
                                <div>
                                    <div class="form-check form-switch d-inline-block me-3">
                                        <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                                        <label class="form-check-label" for="autoScrollToggle">Auto-scroll</label>
                                    </div>
                                    <div class="form-check form-switch d-inline-block me-3">
                                        <input class="form-check-input" type="checkbox" id="chipLogToggle" checked onchange="toggleChipLog()">
                                        <label class="form-check-label" for="chipLogToggle">Chip Overlay</label>
                                    </div>
                                    <button class="btn btn-outline-warning btn-sm me-2" onclick="sendTestLog()">
                                        <i class="fas fa-bug"></i> Test
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="togglePlotterPause()" id="plotterPauseBtn">
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="clearPlotterData()">
                                        <i class="fas fa-trash"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Full Logs Section -->
                        <div id="plotterLogs" class="bg-dark text-light p-3 font-monospace flex-grow-1" style="overflow-y: auto; font-size: 0.85rem;">
                            <div class="text-white-50">Waiting for logs...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Device Modal -->
<div class="modal fade" id="editDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Device Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editDeviceForm">
                    <input type="hidden" id="editSensorId">
                    <div class="mb-3">
                        <label class="form-label">Friendly Name</label>
                        <input type="text" class="form-control" id="editSensorName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hibernation Duration (seconds)</label>
                        <input type="number" class="form-control" id="editCheckInInterval" min="10">
                        <div class="form-text">How often the device wakes up to check for commands and send data.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSensorSettings()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>Device Details</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="manualEntryToggle" onchange="toggleManualEntry()">
                                <label class="form-check-label" for="manualEntryToggle"><small>Manual Entry</small></label>
                            </div>
                        </div>
                        <form id="addDeviceForm">
                            <div class="mb-3">
                                <label class="form-label">Sensor ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control bg-light" id="newSensorId" required placeholder="Select from scan..." readonly>
                                <div class="form-text">Unique identifier inherited from device.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Friendly Name</label>
                                <input type="text" class="form-control" id="newSensorName" placeholder="e.g. Fermentation Chamber 2">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Sensor Type</label>
                                <input type="text" class="form-control" id="newSensorType" placeholder="e.g. esp32_fermentation">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">IP Address (Optional)</label>
                                <input type="text" class="form-control" id="newSensorIp" placeholder="e.g. 192.168.1.100">
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Network Scan</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="scanForDevices()" id="scanBtn">
                                <i class="fas fa-search"></i> Scan
                            </button>
                        </div>
                        <div id="scanResults" class="list-group overflow-auto" style="max-height: 300px;">
                            <div class="text-center text-muted py-4">
                                <small>Click Scan to find devices on your network.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="registerDevice()">Register Device</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload to Many Modal -->
<div class="modal fade" id="uploadToManyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-tasks"></i> Upload Script to Multiple Sensors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="form-label fw-bold">1. Select Script</label>
                    <select class="form-select" id="bulkScriptSelect" onchange="filterBulkSensors()">
                        <option value="">-- Select a script --</option>
                    </select>
                    <div id="bulkScriptDetails" class="form-text mt-2"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">2. Select Target Sensors</label>
                    <div class="d-flex justify-content-between mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllSensors" onchange="toggleSelectAllSensors()">
                            <label class="form-check-label" for="selectAllSensors">Select All Visible</label>
                        </div>
                        <span class="badge bg-secondary" id="selectedCountBadge">0 selected</span>
                    </div>
                    
                    <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                        <div id="bulkSensorList" class="list-group list-group-flush">
                            <div class="text-center text-muted py-3">Please select a script first</div>
                        </div>
                    </div>
                </div>
                
                <div id="bulkUploadResult" class="alert" style="display: none;"></div>
                <div id="bulkUploadProgress" class="progress mb-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitBulkUpload()" id="btnBulkUpload" disabled>
                    <i class="fas fa-upload"></i> Upload to Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Hardware Device Modal -->
<div class="modal fade" id="addHardwareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-microchip"></i> Add Hardware Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Device Type</label>
                    <select class="form-select" id="hwDeviceType" onchange="updateHwPinOptions()">
                        <option value="relay">Relay (Switch)</option>
                        <option value="temp_sensor">Temperature Sensor (DS18B20)</option>
                        <option value="dht_sensor">DHT Sensor (Temp & Humidity)</option>
                        <option value="button">Button / Switch (Input)</option>
                        <option value="led">LED (Output)</option>
                        <option value="analog_sensor">Analog Sensor</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Device Name (Alias)</label>
                    <input type="text" class="form-control" id="hwDeviceName" placeholder="e.g. Living Room Light">
                    <div class="form-text">This name will be used in your logic blocks.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Pin</label>
                    <select class="form-select" id="hwDevicePin">
                        <!-- Populated via JS -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveHardwareConfig()">Add Device</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let sensors = [];


// --- Sensor Plotter Logic ---
let plotterSensorId = null;
let plotterInterval = null;
let isPlotterPaused = false;
let lastLogId = 0;
let currentBoardType = 'ESP32-WROOM-32'; // Default board type
let currentPlotterLogicData = null; // Store logic for pin interactivity

async function fetchDeviceScript(sensorId) {
    try {
        // Try to get the running script from device's recent logs or status
        const response = await fetch(`/api/sensor-master/sensors/${sensorId}/script`);
        if (response.ok) {
            const data = await response.json();
            if (data.script) {
                console.log('Fetched running script from device:', data.script);
                return typeof data.script === 'string' ? JSON.parse(data.script) : data.script;
            }
        }
    } catch (e) {
        console.warn('Could not fetch device script:', e);
    }
    return null;
}

async function openSensorPlotter(sensorId) {
    plotterSensorId = sensorId;
    document.getElementById('plotterSensorId').textContent = sensorId;
    
    // Get sensor info to determine board type and logic
    const sensor = sensors.find(s => s.sensor_id === sensorId);
    if (sensor) {
        currentBoardType = sensor.board_type || 'ESP32-WROOM-32';
        
        // Get assigned script logic if available
        if (sensor.assigned_script) {
            try {
                const scriptContent = typeof sensor.assigned_script.script_content === 'string'
                    ? JSON.parse(sensor.assigned_script.script_content)
                    : sensor.assigned_script.script_content;
                currentPlotterLogicData = scriptContent;
            } catch (e) {
                console.error('Error parsing logic:', e);
                currentPlotterLogicData = null;
            }
        } else {
            // Try to fetch the running script from the device
            console.log('No assigned script in database, will fetch from device...');
            fetchDeviceScript(sensorId).then(script => {
                if (script) {
                    currentPlotterLogicData = script;
                    // Re-initialize board to show the controls
                    const pinOverlays = document.getElementById('pinOverlays');
                    const pinControlsList = document.getElementById('pinControlsList');
                    if (pinOverlays && pinControlsList) {
                        initializeBoardControls();
                    }
                }
            });
        }
    }
    
    // Reset state
    isPlotterPaused = false;
    
    // Show modal
    const modalEl = document.getElementById('sensorPlotterModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
    
    // Initialize board visualization
    // Small delay to ensure modal is fully in DOM/visible
    setTimeout(() => {
        initializeBoardVisualization();
    }, 50);
    
    const logsContainer = document.getElementById('plotterLogs');
    const historyBtn = document.getElementById('plotterHistoryBtn');
    
    logsContainer.innerHTML = '<div class="text-white-50 p-2">Loading history...</div>';
    
    // Load recent history (last 50 logs)
    try {
        const response = await fetch(`/api/sensor-master/logs/${plotterSensorId}?limit=50`);
        if (response.ok) {
            const data = await response.json();
            if (data.logs && data.logs.length > 0) {
                // Logs are ordered DESC (newest first), so we need to reverse them for display (oldest first)
                const historyLogs = data.logs.reverse();
                
                // Clear container before showing history
                logsContainer.innerHTML = '';
                
                // Display these logs
                updatePlotterLogs(historyLogs);
                
                // Set lastLogId to the newest log we found
                lastLogId = historyLogs[historyLogs.length - 1].id;
                
                if (historyBtn) historyBtn.style.display = 'none'; // Hide "Load History" since we just loaded it
            } else {
                lastLogId = 0;
                logsContainer.innerHTML = '<div class="text-white-50 p-2"><i>No logs found. Listening for new logs...</i></div>';
                if (historyBtn) historyBtn.style.display = 'none';
            }
        }
    } catch (e) {
        console.error("Error initializing plotter:", e);
        lastLogId = 0;
        logsContainer.innerHTML = '<div class="text-white-50 p-2"><i>Error loading history. Listening for new logs...</i></div>';
        if (historyBtn) historyBtn.style.display = 'none';
    }
    
    updatePauseButton();
    
    // Start polling
    if (plotterInterval) clearInterval(plotterInterval);
    plotterInterval = setInterval(() => {
        fetchPlotterLogs();
    }, 2000); // Poll every 2 seconds
    
    // Handle modal close to stop polling
    document.getElementById('sensorPlotterModal').addEventListener('hidden.bs.modal', function () {
        if (plotterInterval) {
            clearInterval(plotterInterval);
            plotterInterval = null;
        }
    }, { once: true });
}

// getBoardConfig removed to use shared version from board-configs.js

function initializeBoardVisualization() {
    const config = getBoardConfig(currentBoardType);
    const boardImage = document.getElementById('boardImage');
    
    if (!boardImage) {
        console.error('Board image element not found!');
        return;
    }

    const chipLogOverlay = document.getElementById('chipLogOverlay');
    const pinOverlays = document.getElementById('pinOverlays');
    const pinControlsList = document.getElementById('pinControlsList');
    
    // Set board image with fallback
    boardImage.src = config.image;
    
    // Wait for image to load before initializing controls
    boardImage.onload = function() {
        console.log('Board image loaded successfully');
        // Position chip log overlay
        chipLogOverlay.style.left = config.chipOverlay.x + 'px';
        chipLogOverlay.style.top = config.chipOverlay.y + 'px';
        chipLogOverlay.style.width = config.chipOverlay.width + 'px';
        chipLogOverlay.style.height = config.chipOverlay.height + 'px';
        
        // Show overlay if toggle is checked
        if (document.getElementById('chipLogToggle').checked) {
            chipLogOverlay.style.display = 'block';
        }
        
        // Initialize pin controls after image loads
        setTimeout(() => initializeBoardControls(), 200);
    };
    
    boardImage.onerror = function() {
        // Try fallback image if available
        if (config.fallbackImage && this.src !== config.fallbackImage) {
            console.log('Primary image failed, trying fallback:', config.fallbackImage);
            this.src = config.fallbackImage;
        } else {
            // If both fail, create a styled placeholder
            console.warn('Board image not available, using placeholder');
            const container = document.getElementById('boardContainer');
            container.innerHTML = `
                <div class="text-center p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white; height: 100%;">
                    <i class="fas fa-microchip fa-4x mb-3" style="opacity: 0.7;"></i>
                    <h5>${config.name}</h5>
                    <p class="small mb-0">Board visualization</p>
                    <p class="small text-white-50">Image not loaded - controls still functional</p>
                </div>
            `;
            // Re-create pin overlays div
            const newPinOverlays = document.createElement('div');
            newPinOverlays.id = 'pinOverlays';
            newPinOverlays.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;';
            container.appendChild(newPinOverlays);
            
            // Re-create chip log overlay
            const newChipLog = document.createElement('div');
            newChipLog.id = 'chipLogOverlay';
            newChipLog.className = 'position-absolute bg-dark text-light font-monospace p-2 border rounded';
            newChipLog.style.cssText = 'font-size: 0.55rem; line-height: 1.1; overflow-y: auto; display: none; opacity: 0.95; z-index: 15; word-wrap: break-word;';
            container.appendChild(newChipLog);
            
            // Update references
            const updatedOverlay = document.getElementById('chipLogOverlay');
            if (updatedOverlay) {
                updatedOverlay.style.left = config.chipOverlay.x + 'px';
                updatedOverlay.style.top = config.chipOverlay.y + 'px';
                updatedOverlay.style.width = config.chipOverlay.width + 'px';
                updatedOverlay.style.height = config.chipOverlay.height + 'px';
                if (document.getElementById('chipLogToggle')?.checked) {
                    updatedOverlay.style.display = 'block';
                }
            }
            
            // Initialize controls even without image
            setTimeout(() => initializeBoardControls(), 200);
            return; // Exit early as we've replaced the container
        }
    };
}

function initializeBoardControls() {
    const pinOverlays = document.getElementById('pinOverlays');
    const pinControlsList = document.getElementById('pinControlsList');
    
    if (!pinOverlays || !pinControlsList) return;
    
    // Clear and rebuild pin overlays
    pinOverlays.innerHTML = '';
    pinControlsList.innerHTML = '';
    
    if (!currentPlotterLogicData || !currentPlotterLogicData.actions) {
        pinControlsList.innerHTML = '<div class="text-muted p-3 text-center"><p>No logic assigned to this sensor</p><p class="small text-muted">Use the Logic Builder to assign a script, or the device will use its default firmware script.</p></div>';
        return;
    }
    
    // Extract pin actions from logic
    const pinActions = extractPinActionsFromLogic(currentPlotterLogicData.actions);
    
    if (pinActions.length === 0) {
        pinControlsList.innerHTML = '<div class="text-muted p-3 text-center">No pin actions found in logic</div>';
        return;
    }
    
    // Create SVG layer for wires
    const boardContainer = document.getElementById('boardContainer');
    const boardRect = boardContainer.getBoundingClientRect();
    let svgLayer = document.getElementById('wireSvgLayer');
    if (!svgLayer) {
        svgLayer = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svgLayer.id = 'wireSvgLayer';
        svgLayer.setAttribute('viewBox', '0 0 340 580');
        svgLayer.setAttribute('preserveAspectRatio', 'xMidYMid meet');
        svgLayer.style.position = 'absolute';
        svgLayer.style.top = '0';
        svgLayer.style.left = '0';
        svgLayer.style.width = '100%';
        svgLayer.style.height = '100%';
        svgLayer.style.pointerEvents = 'none';
        svgLayer.style.zIndex = '5';
        svgLayer.style.overflow = 'visible';
        boardContainer.appendChild(svgLayer);
        console.log('Created SVG wire layer');
    }
    svgLayer.innerHTML = ''; // Clear existing wires
    console.log('Initializing wires for', pinActions.length, 'actions');
    
    // Deduplicate pin actions - only keep first occurrence of each pin
    const seenPins = new Set();
    const uniquePinActions = pinActions.filter(action => {
        if (seenPins.has(action.pin)) {
            console.log(`Skipping duplicate pin ${action.pin}`);
            return false;
        }
        seenPins.add(action.pin);
        return true;
    });
    
    console.log(`Reduced ${pinActions.length} actions to ${uniquePinActions.length} unique pins`);
    
    // Create pin overlays and controls
    uniquePinActions.forEach((action, index) => {
        const pinInfo = getPinInfo(currentBoardType, action.pin);
        if (!pinInfo) return;
        
        // Create visual pin indicator on board
        const pinIndicator = document.createElement('div');
        pinIndicator.className = 'position-absolute rounded-circle pin-indicator';
        pinIndicator.style.left = (pinInfo.x - 6) + 'px';
        pinIndicator.style.top = (pinInfo.y - 6) + 'px';
        pinIndicator.style.width = '12px';
        pinIndicator.style.height = '12px';
        pinIndicator.style.backgroundColor = getActionColor(action.type);
        pinIndicator.style.border = '2px solid white';
        pinIndicator.style.cursor = 'pointer';
        pinIndicator.style.zIndex = '10';
        pinIndicator.style.transition = 'all 0.3s ease';
        pinIndicator.style.pointerEvents = 'auto';
        pinIndicator.title = `${pinInfo.name} (Pin ${action.pin}) - ${action.type}`;
        pinIndicator.id = `pin-indicator-${action.pin}`;
        pinIndicator.dataset.pin = action.pin;
        
        // Add hover effect to pin indicator
        pinIndicator.addEventListener('mouseenter', () => highlightWire(action.pin, true));
        pinIndicator.addEventListener('mouseleave', () => highlightWire(action.pin, false));
        
        pinOverlays.appendChild(pinIndicator);
        
        // Draw wire for ALL pin actions (both read and write)
        setTimeout(() => {
            drawWireFromPin(action.pin, pinInfo, action.type);
        }, 100);
        
        // Create control for write actions only (user can interact with these)
        if (isWriteAction(action.type)) {
            const control = createPinControl(action, pinInfo, index);
            pinControlsList.appendChild(control);
        }
    });
}

function drawWireFromPin(pin, pinInfo, actionType) {
    const svgLayer = document.getElementById('wireSvgLayer');
    if (!svgLayer) {
        console.log('No SVG layer found');
        return;
    }
    
    const boardContainer = document.getElementById('boardContainer');
    const boardImage = boardContainer.querySelector('img');
    if (!boardImage) {
        console.log('No board image found');
        return;
    }
    
    // Calculate wire extension from pin
    const startX = pinInfo.x;
    const startY = pinInfo.y;
    
    // Determine direction based on pin location (left or right side of board)
    const isRightSide = startX > 170; // Middle of 340px board
    const wireLength = 120;
    const endX = isRightSide ? startX + wireLength : startX - wireLength;
    const endY = startY;
    
    // Create wire path (straight line from pin)
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const pathData = `M ${startX} ${startY} L ${endX} ${endY}`;
    
    path.setAttribute('d', pathData);
    path.setAttribute('stroke', getActionColor(actionType));
    path.setAttribute('stroke-width', '3');
    path.setAttribute('fill', 'none');
    path.setAttribute('opacity', '0.6');
    path.setAttribute('class', `wire wire-pin-${pin}`);
    path.setAttribute('data-pin', pin);
    path.style.transition = 'all 0.3s ease';
    path.setAttribute('stroke-linecap', 'round');
    
    svgLayer.appendChild(path);
    
    // Add glow effect for animation
    const glowPath = path.cloneNode();
    glowPath.setAttribute('stroke-width', '8');
    glowPath.setAttribute('opacity', '0');
    glowPath.setAttribute('class', `wire-glow wire-glow-pin-${pin}`);
    glowPath.setAttribute('filter', 'url(#wireGlowFilter)');
    svgLayer.insertBefore(glowPath, path);
    
    console.log(`Drew wire for pin ${pin} from (${startX},${startY}) to (${endX},${endY})`);
    
    // Add SVG filter for glow effect
    if (!document.getElementById('wireGlowFilter')) {
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const filter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
        filter.id = 'wireGlowFilter';
        filter.setAttribute('x', '-50%');
        filter.setAttribute('y', '-50%');
        filter.setAttribute('width', '200%');
        filter.setAttribute('height', '200%');
        
        const feGaussianBlur = document.createElementNS('http://www.w3.org/2000/svg', 'feGaussianBlur');
        feGaussianBlur.setAttribute('stdDeviation', '3');
        feGaussianBlur.setAttribute('result', 'coloredBlur');
        
        const feMerge = document.createElementNS('http://www.w3.org/2000/svg', 'feMerge');
        const feMergeNode1 = document.createElementNS('http://www.w3.org/2000/svg', 'feMergeNode');
        feMergeNode1.setAttribute('in', 'coloredBlur');
        const feMergeNode2 = document.createElementNS('http://www.w3.org/2000/svg', 'feMergeNode');
        feMergeNode2.setAttribute('in', 'SourceGraphic');
        
        feMerge.appendChild(feMergeNode1);
        feMerge.appendChild(feMergeNode2);
        filter.appendChild(feGaussianBlur);
        filter.appendChild(feMerge);
        defs.appendChild(filter);
        svgLayer.appendChild(defs);
    }
}

function extractPinActionsFromLogic(actions, result = []) {
    actions.forEach(action => {
        if (action.pin !== undefined) {
            result.push(action);
        }
        // Recurse into conditional blocks
        if (action.then) extractPinActionsFromLogic(action.then, result);
        if (action.else) extractPinActionsFromLogic(action.else, result);
    });
    return result;
}

function getActionColor(type) {
    const colors = {
        'gpio_write': '#4CAF50',
        'gpio_read': '#2196F3',
        'pwm_write': '#FF9800',
        'analog_write': '#9C27B0',
        'analog_read': '#00BCD4',
        'read_temperature': '#F44336',
        'read_battery': '#FFC107'
    };
    return colors[type] || '#9E9E9E';
}

function isWriteAction(type) {
    return ['gpio_write', 'pwm_write', 'analog_write', 'set_relay'].includes(type);
}

function createPinControl(action, pinInfo, index) {
    const div = document.createElement('div');
    div.className = 'list-group-item pin-control';
    div.dataset.pin = action.pin;
    div.dataset.actionType = action.type;
    div.style.cursor = 'pointer';
    div.style.transition = 'all 0.3s ease';
    
    // Add hover effects for wire highlighting
    div.addEventListener('mouseenter', () => highlightWire(action.pin, true));
    div.addEventListener('mouseleave', () => highlightWire(action.pin, false));
    
    let controlHtml = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <strong>Pin ${action.pin}</strong> - ${pinInfo.name}
                ${action.alias ? `<span class="badge bg-secondary ms-2">${action.alias}</span>` : ''}
            </div>
            <span class="badge" style="background-color: ${getActionColor(action.type)}">${action.type}</span>
        </div>
    `;
    
    if (action.type === 'gpio_write') {
        const currentValue = action.value || 'LOW';
        controlHtml += `
            <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-sm ${currentValue === 'HIGH' ? 'btn-success' : 'btn-outline-secondary'}" 
                        onclick="sendPinCommand(${action.pin}, 'gpio_write', 'HIGH')">
                    <i class="fas fa-toggle-on"></i> HIGH
                </button>
                <button type="button" class="btn btn-sm ${currentValue === 'LOW' ? 'btn-danger' : 'btn-outline-secondary'}" 
                        onclick="sendPinCommand(${action.pin}, 'gpio_write', 'LOW')">
                    <i class="fas fa-toggle-off"></i> LOW
                </button>
            </div>
        `;
    } else if (action.type === 'pwm_write') {
        const currentValue = action.value || 0;
        controlHtml += `
            <div>
                <input type="range" class="form-range" min="0" max="255" value="${currentValue}" 
                       id="pwm-slider-${action.pin}" 
                       oninput="updatePWMDisplay(${action.pin}, this.value)">
                <div class="d-flex justify-content-between">
                    <small>0</small>
                    <small id="pwm-value-${action.pin}">${currentValue}</small>
                    <small>255</small>
                </div>
                <button class="btn btn-sm btn-primary w-100 mt-2" 
                        onclick="sendPinCommand(${action.pin}, 'pwm_write', document.getElementById('pwm-slider-${action.pin}').value)">
                    Apply PWM
                </button>
            </div>
        `;
    } else if (action.type === 'analog_write') {
        const currentValue = action.value || 0;
        controlHtml += `
            <div>
                <input type="range" class="form-range" min="0" max="255" value="${currentValue}" 
                       id="dac-slider-${action.pin}" 
                       oninput="updateDACDisplay(${action.pin}, this.value)">
                <div class="d-flex justify-content-between">
                    <small>0V</small>
                    <small id="dac-value-${action.pin}">${(currentValue / 255 * 3.3).toFixed(2)}V</small>
                    <small>3.3V</small>
                </div>
                <button class="btn btn-sm btn-primary w-100 mt-2" 
                        onclick="sendPinCommand(${action.pin}, 'analog_write', document.getElementById('dac-slider-${action.pin}').value)">
                    Apply DAC
                </button>
            </div>
        `;
    } else if (action.type === 'set_relay') {
        const currentState = action.state || false;
        controlHtml += `
            <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-sm ${currentState ? 'btn-success' : 'btn-outline-secondary'}" 
                        onclick="sendPinCommand(${action.pin}, 'set_relay', true)">
                    <i class="fas fa-power-off"></i> ON
                </button>
                <button type="button" class="btn btn-sm ${!currentState ? 'btn-danger' : 'btn-outline-secondary'}" 
                        onclick="sendPinCommand(${action.pin}, 'set_relay', false)">
                    <i class="fas fa-power-off"></i> OFF
                </button>
            </div>
        `;
    }
    
    div.innerHTML = controlHtml;
    return div;
}

function highlightWire(pin, highlight) {
    const wire = document.querySelector(`.wire-pin-${pin}`);
    const wireGlow = document.querySelector(`.wire-glow-pin-${pin}`);
    const pinIndicator = document.getElementById(`pin-indicator-${pin}`);
    const pinControl = document.querySelector(`.pin-control[data-pin="${pin}"]`);
    
    if (wire) {
        wire.setAttribute('opacity', highlight ? '0.9' : '0.4');
        wire.setAttribute('stroke-width', highlight ? '3' : '2');
    }
    
    if (wireGlow) {
        wireGlow.setAttribute('opacity', highlight ? '0.6' : '0');
    }
    
    if (pinIndicator) {
        pinIndicator.style.transform = highlight ? 'scale(1.5)' : 'scale(1)';
        pinIndicator.style.boxShadow = highlight ? '0 0 10px currentColor' : 'none';
    }
    
    if (pinControl) {
        pinControl.style.backgroundColor = highlight ? 'rgba(76, 175, 80, 0.1)' : '';
    }
}

function activateWire(pin, duration = 1000) {
    const wire = document.querySelector(`.wire-pin-${pin}`);
    const wireGlow = document.querySelector(`.wire-glow-pin-${pin}`);
    const pinIndicator = document.getElementById(`pin-indicator-${pin}`);
    
    // Store current state
    const currentState = wire ? wire.dataset.state : null;
    
    if (wire) {
        wire.setAttribute('opacity', '1');
        wire.setAttribute('stroke-width', '5');
    }
    
    if (wireGlow) {
        wireGlow.setAttribute('opacity', '0.8');
    }
    
    if (pinIndicator) {
        pinIndicator.style.animation = 'pulse 0.5s ease-in-out 2';
    }
    
    // Reset after duration, but preserve state-based styling
    setTimeout(() => {
        if (pinIndicator) {
            pinIndicator.style.animation = '';
        }
        
        // Don't reset if we have a state - let setWireState handle it
        if (!currentState) {
            if (wire) {
                wire.setAttribute('opacity', '0.6');
                wire.setAttribute('stroke-width', '3');
            }
            if (wireGlow) {
                wireGlow.setAttribute('opacity', '0');
            }
        }
    }, duration);
}

function updatePWMDisplay(pin, value) {
    document.getElementById(`pwm-value-${pin}`).textContent = value;
}

function updateDACDisplay(pin, value) {
    const voltage = (value / 255 * 3.3).toFixed(2);
    document.getElementById(`dac-value-${pin}`).textContent = voltage + 'V';
}

async function sendPinCommand(pin, actionType, value) {
    try {
        const response = await fetch('/api/sensor-master/pin-control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sensor_id: plotterSensorId,
                pin: pin,
                action_type: actionType,
                value: value
            })
        });
        
        if (response.ok) {
            showAlert(`Pin ${pin} command sent successfully`, 'success');
            
            // Update wire state based on value FIRST
            if (actionType === 'gpio_write') {
                setWireState(pin, value);
            }
            
            // Then do quick flash animation on top
            const indicator = document.getElementById(`pin-indicator-${pin}`);
            if (indicator) {
                const originalColor = indicator.style.backgroundColor;
                indicator.style.backgroundColor = '#FFD700'; // Gold flash
                indicator.style.animation = 'pulse 0.3s ease-in-out 1';
                setTimeout(() => {
                    indicator.style.animation = '';
                    // Restore state color
                    if (actionType === 'gpio_write') {
                        setWireState(pin, value);
                    }
                }, 300);
            }
        } else {
            const data = await response.json();
            showAlert(`Failed to send command: ${data.error || 'Unknown error'}`, 'error');
        }
    } catch (e) {
        console.error('Error sending pin command:', e);
        showAlert('Error sending pin command', 'error');
    }
}

function setWireState(pin, state) {
    const wire = document.querySelector(`.wire-pin-${pin}`);
    const wireGlow = document.querySelector(`.wire-glow-pin-${pin}`);
    const pinIndicator = document.getElementById(`pin-indicator-${pin}`);
    
    if (!wire) {
        console.log('No wire found for pin', pin);
        return;
    }
    
    // Store state for future reference
    wire.dataset.state = state;
    
    console.log(`Setting wire state for pin ${pin} to ${state}`);
    
    if (state === 'HIGH' || state === true || state === 1) {
        // HIGH state - bright green with subtle moving dash animation
        wire.setAttribute('stroke', '#00FF00');
        wire.setAttribute('stroke-width', '4');
        wire.setAttribute('opacity', '0.9');
        wire.style.filter = 'none';
        wire.setAttribute('stroke-dasharray', '8 8');
        wire.style.animation = 'wireFlow 2s linear infinite';
        
        if (wireGlow) {
            wireGlow.setAttribute('opacity', '0');
        }
        
        if (pinIndicator) {
            pinIndicator.style.backgroundColor = '#00FF00';
            pinIndicator.style.boxShadow = '0 0 6px #00FF00';
        }
    } else {
        // LOW state - red, thinner, no animation
        wire.setAttribute('stroke', '#FF0000');
        wire.setAttribute('stroke-width', '3');
        wire.setAttribute('opacity', '0.5');
        wire.style.filter = 'none';
        wire.setAttribute('stroke-dasharray', 'none');
        wire.style.animation = 'none';
        
        if (wireGlow) {
            wireGlow.setAttribute('opacity', '0');
        }
        
        if (pinIndicator) {
            pinIndicator.style.backgroundColor = '#FF0000';
            pinIndicator.style.boxShadow = 'none';
        }
    }
}

function toggleChipLog() {
    const chipLogOverlay = document.getElementById('chipLogOverlay');
    const isChecked = document.getElementById('chipLogToggle').checked;
    chipLogOverlay.style.display = isChecked ? 'block' : 'none';
}

function resetPlotterHistory() {
    lastLogId = 0;
    document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2">Fetching history...</div>';
    document.getElementById('plotterHistoryBtn').style.display = 'none';
    fetchPlotterLogs();
}

async function fetchPlotterLogs() {
    if (isPlotterPaused || !plotterSensorId) return;

    try {
        // Fetch logs newer than lastLogId
        // If lastLogId is 0, we fetch the latest 50 logs (default limit)
        // If lastLogId > 0 (because we cleared or have seen logs), we fetch only newer ones
        const url = `/api/sensor-master/logs/${plotterSensorId}?min_id=${lastLogId}&limit=50`;
        const response = await fetch(url);
        if (!response.ok) return;
        
        const data = await response.json();
        
        if (data.logs && data.logs.length > 0) {
            // Update lastLogId to the max ID received
            const maxId = Math.max(...data.logs.map(l => l.id));
            if (maxId > lastLogId) {
                lastLogId = maxId;
            }
            
            updatePlotterLogs(data.logs);
        } else if (lastLogId === 0) {
            // Only show "No logs" if we haven't received any logs yet AND we haven't cleared anything
            document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2">No logs available</div>';
        }
    } catch (error) {
        console.error('Error fetching plotter logs:', error);
    }
}

function updatePlotterLogs(logs) {
    const container = document.getElementById('plotterLogs');
    const chipLogOverlay = document.getElementById('chipLogOverlay');
    
    // Check if the container ONLY contains a placeholder message
    // We check if there are any log entries (divs with border-bottom)
    // If not, we can safely clear whatever is there (placeholders)
    if (!container.querySelector('div.border-bottom')) {
        container.innerHTML = '';
    }
    
    // Sort logs by ID ascending (oldest first) so we append them in order
    const sortedLogs = [...logs].sort((a, b) => a.id - b.id);
    
    // Parse logs for pin state changes
    sortedLogs.forEach(log => {
        const msg = log.message.toLowerCase().trim();
        // Detect HIGH state - must match exactly or specific patterns
        if (msg === 'hi' || msg === 'high' || msg === 'on' || msg.includes('led on')) {
            console.log('Detected HIGH state from log:', log.message);
            setWireState(2, 'HIGH'); // Pin 2 is the LED
        }
        // Detect LOW state - must match exactly or specific patterns
        else if (msg === 'low' || msg === 'off' || msg.includes('led off')) {
            console.log('Detected LOW state from log:', log.message);
            setWireState(2, 'LOW'); // Pin 2 is the LED
        }
    });
    
    // Format logs
    const html = sortedLogs.map(log => {
        // Convert UTC timestamp to local time
        const time = new Date(log.created_at).toLocaleTimeString();
        let colorClass = 'text-light';
        if (log.log_level === 'error') colorClass = 'text-danger';
        else if (log.log_level === 'warning') colorClass = 'text-warning';
        else if (log.log_level === 'debug') colorClass = 'text-secondary';
        
        // Replace \n and \r\n with <br> for carriage returns
        const formattedMessage = log.message.replace(/\r\n|\r|\n/g, '<br>');
        
        return `<div class="mb-1 border-bottom border-secondary border-opacity-25 pb-1 font-monospace">
            <span class="text-white-50" style="font-size: 0.8em; margin-right: 8px;">[${time}]</span>
            <span class="${colorClass}">${formattedMessage}</span>
        </div>`;
    }).join('');
    
    container.insertAdjacentHTML('beforeend', html);
    
    // Also update chip log overlay with latest logs (last 10)
    if (chipLogOverlay && document.getElementById('chipLogToggle').checked) {
        const allLogDivs = container.querySelectorAll('div.border-bottom');
        const recentLogs = Array.from(allLogDivs).slice(-10);
        chipLogOverlay.innerHTML = recentLogs.map(div => `<div class="mb-1">${div.innerHTML}</div>`).join('');
        chipLogOverlay.scrollTop = chipLogOverlay.scrollHeight;
    }
    
    // Auto-scroll if enabled
    const autoScroll = document.getElementById('autoScrollToggle').checked;
    if (autoScroll) {
        container.scrollTop = container.scrollHeight;
    }
}

function togglePlotterPause() {
    isPlotterPaused = !isPlotterPaused;
    updatePauseButton();
}

function updatePauseButton() {
    const btn = document.getElementById('plotterPauseBtn');
    if (isPlotterPaused) {
        btn.innerHTML = '<i class="fas fa-play"></i> Resume';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-success');
    } else {
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-outline-secondary');
    }
}

function clearPlotterData() {
    // Clear the UI
    document.getElementById('plotterLogs').innerHTML = '<div class="text-white-50 p-2"><i>Logs cleared. Listening for new entries...</i></div>';
    
    // Show history button since we now have hidden history
    const historyBtn = document.getElementById('plotterHistoryBtn');
    if (historyBtn) historyBtn.style.display = 'inline-block';
}

async function sendTestLog() {
    if (!plotterSensorId) return;
    
    try {
        const response = await fetch('/api/sensor-master/logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensor_id: plotterSensorId,
                message: 'Test log message from console',
                level: 'info'
            })
        });
        
        if (response.ok) {
            // Don't need to do anything, the poller will pick it up
            console.log('Test log sent');
        } else {
            console.error('Failed to send test log');
            showAlert('Failed to send test log', 'danger');
        }
    } catch (error) {
        console.error('Error sending test log:', error);
        showAlert('Error sending test log: ' + error.message, 'danger');
    }
}



function editSensor(sensorId) {
    const sensor = sensors.find(s => s.sensor_id === sensorId);
    if (!sensor) return;
    
    document.getElementById('editSensorId').value = sensor.sensor_id;
    document.getElementById('editSensorName').value = sensor.sensor_name || '';
    document.getElementById('editCheckInInterval').value = sensor.check_in_interval || 60;
    
    const modalEl = document.getElementById('editDeviceModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

async function saveSensorSettings() {
    const sensorId = document.getElementById('editSensorId').value;
    const name = document.getElementById('editSensorName').value;
    const interval = parseInt(document.getElementById('editCheckInInterval').value);
    
    try {
        const response = await fetch(`/api/sensor-master/sensors/${sensorId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensor_name: name,
                check_in_interval: interval
            })
        });
        
        if (!response.ok) throw new Error('Failed to update sensor');
        
        showAlert('Sensor settings updated successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editDeviceModal')).hide();
        await loadSensors();
    } catch (error) {
        console.error('Error updating sensor:', error);
        showAlert('Failed to update sensor', 'danger');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    refreshData();
    
    // Auto-refresh every 30 seconds for real-time updates
    setInterval(refreshData, 30000);
});

async function refreshData() {
    // Load sensors first
    await loadSensors();
    
    // Then load everything else in parallel
    await Promise.all([
        loadScripts(),
        loadStats()
    ]);
    
    // Re-render sensors to ensure script dropdowns are populated
    renderSensors();
    
    // Update sensor status indicators based on heartbeat
    updateSensorStatusIndicators();
}

function updateSensorStatusIndicators() {
    // Check each sensor's last_check_in and update visual indicators
    const now = new Date();
    
    sensors.forEach(sensor => {
        if (!sensor.last_check_in) {
            sensor.status = 'hibernating';
            return;
        }
        
        const lastCheckIn = new Date(sensor.last_check_in);
        const timeSinceLastCheck = now - lastCheckIn;
        
        // Calculate timeout based on sensor's check-in interval
        // Default to 60s if not set, convert to ms
        // Add a grace period (e.g. 2x interval + 30s buffer) to avoid false offline
        const intervalSec = sensor.check_in_interval || 60;
        const timeoutMs = (intervalSec * 1000) * 2 + 30000; 
        
        // Update status based on time since last heartbeat
        if (sensor.status === 'hibernating') {
            // Use longer timeout for hibernating sensors (e.g. 2 hours)
            const hibernationTimeoutMs = 120 * 60 * 1000;
            if (timeSinceLastCheck > hibernationTimeoutMs) {
                sensor.status = 'offline';
                console.log(`Hibernating sensor ${sensor.sensor_id} marked as offline (last seen ${Math.floor(timeSinceLastCheck / 60000)} minutes ago)`);
            }
        } else if (timeSinceLastCheck > timeoutMs) {
            if (sensor.status !== 'offline') {
                sensor.status = 'offline';
                console.log(`Sensor ${sensor.sensor_id} marked as offline (last seen ${Math.floor(timeSinceLastCheck / 60000)} minutes ago)`);
            }
        }
        // Else: Status is good (online or hibernating). Keep whatever status the server reported.
    });
    
    // Re-render displays to show updated status
    renderSensors();
    loadStats();
}







async function assignScript(sensorId, scriptId) {
    if (!scriptId) {
        if (!confirm(`Remove script assignment from sensor ${sensorId}?`)) return;
        showAlert('To remove a script, please assign a new one or use the API directly.', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/assign-library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                library_script_id: scriptId,
                sensor_id: sensorId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(`Script assigned to ${sensorId} successfully`, 'success');
            await loadSensors();
        } else {
            throw new Error(data.error || 'Failed to assign script');
        }
    } catch (error) {
        console.error('Error assigning script:', error);
        showAlert('Failed to assign script: ' + error.message, 'danger');
    }
}

async function loadSensors() {
    try {
        const statusFilter = document.getElementById('statusFilter').value;
        let url = '/api/sensor-master/sensors';
        // Add cache buster to prevent browser caching of old data
        url += `?t=${new Date().getTime()}`;
        
        if (statusFilter) {
            url += `&status=${statusFilter}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load sensors');
        
        sensors = await response.json();
        console.log('Loaded sensors:', sensors); // Debug: Check if battery data is present
        renderSensors();
    } catch (error) {
        console.error('Error loading sensors:', error);
        showAlert('Failed to load sensors', 'danger');
    }
}

function renderSensors() {
    const container = document.getElementById('sensorsContainer');
    
    if (sensors.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-microchip fa-3x mb-3"></i>
                <p>No sensors registered yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Sensor ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Board</th>
                        <th>Status</th>
                        <th>Battery Level</th>
                        <th>Current Script</th>
                        <th>Running Version</th>
                        <th>Last Check-in</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sensors.map(sensor => {
                        // Build script status indicator using assigned_script
                        let scriptIndicator = '<span class="badge bg-secondary"><i class="fas fa-minus"></i> No script</span>';
                        
                        if (sensor.assigned_script) {
                            const script = sensor.assigned_script;
                            const scriptStatus = script.status || 'unknown';
                            
                            // Status-based badges
                            if (scriptStatus === 'running') {
                                scriptIndicator = `<span class="badge bg-success" title="${script.name} v${script.version} - Running"><i class="fas fa-check-circle"></i> ${script.name}</span>`;
                            } else if (scriptStatus === 'pending') {
                                scriptIndicator = `<span class="badge bg-warning" title="${script.name} v${script.version} - Pending upload to device"><i class="fas fa-clock"></i> Pending</span>`;
                            } else if (scriptStatus === 'outdated') {
                                scriptIndicator = `<span class="badge bg-info" title="${script.name} v${script.version} - Update pending"><i class="fas fa-sync"></i> Updating</span>`;
                            } else {
                                scriptIndicator = `<span class="badge bg-secondary" title="${script.name}"><i class="fas fa-question"></i> Unknown</span>`;
                            }
                        }
                        
                        // Build running version indicator
                        let versionIndicator = '<span class="text-muted">-</span>';
                        if (sensor.running_script_version) {
                            const runningVersion = sensor.running_script_version;
                            const assignedVersion = sensor.assigned_script ? sensor.assigned_script.version : null;
                            
                            if (assignedVersion && runningVersion !== assignedVersion) {
                                // Version mismatch - needs update
                                versionIndicator = `
                                    <div>
                                        <code class="text-warning">${runningVersion}</code>
                                        <i class="fas fa-arrow-right text-muted"></i>
                                        <code class="text-success">${assignedVersion}</code>
                                    </div>
                                `;
                            } else {
                                // Running latest version
                                versionIndicator = `<code class="text-success">${runningVersion}</code>`;
                            }
                        } else if (sensor.assigned_script) {
                            // Has script but sensor hasn't reported version
                            versionIndicator = `
                                <span class="badge bg-info" title="Script assigned, waiting for device to report version">
                                    <i class="fas fa-upload"></i> Uploading...
                                </span>
                            `;
                        }
                        
                        // Build script options for dropdown
                        let scriptOptions = '<option value="">-- Select Script --</option>';
                        if (typeof scripts !== 'undefined' && scripts.length > 0) {
                             scriptOptions += scripts.map(s => {
                                // Check compatibility
                                const isCompatible = !s.target_sensor_type || s.target_sensor_type === sensor.sensor_type;
                                if (!isCompatible) return '';
                                
                                return `<option value="${s.id}" ${sensor.assigned_script && sensor.assigned_script.id === s.id ? 'selected' : ''}>
                                    ${s.name} (v${s.script_version})
                                </option>`;
                            }).join('');
                        }

                        // Check if script has battery action
                        let hasBatteryAction = false;
                        if (sensor.assigned_script && sensor.assigned_script.script_content) {
                            try {
                                const content = typeof sensor.assigned_script.script_content === 'string' 
                                    ? JSON.parse(sensor.assigned_script.script_content) 
                                    : sensor.assigned_script.script_content;
                                    
                                if (content.actions) {
                                    hasBatteryAction = content.actions.some(a => a.type === 'read_battery');
                                }
                            } catch(e) { console.error('Error parsing script content:', e); }
                        }

                        return `
                        <tr class="sensor-list-item">
                            <td data-label="Sensor ID"><code>${sensor.sensor_id}</code></td>
                            <td data-label="Name">${sensor.sensor_name || 'Unnamed'}</td>
                            <td data-label="Type"><span class="badge bg-secondary">${sensor.sensor_type}</span></td>
                            <td data-label="Board">
                                ${sensor.board_type === 'firebeetle2_esp32c6' 
                                    ? '<span class="badge bg-info" title="Firebeetle 2 ESP32-C6 (RISC-V)"><i class="fas fa-microchip"></i> ESP32-C6</span>'
                                    : sensor.board_type === 'esp32_wroom32'
                                        ? '<span class="badge bg-primary" title="ESP32-WROOM-32 (Xtensa)"><i class="fas fa-microchip"></i> ESP32</span>'
                                        : '<span class="badge bg-secondary"><i class="fas fa-question"></i> Unknown</span>'}
                            </td>
                            <td data-label="Status">
                                <i class="fas fa-circle sensor-status-${sensor.status}"></i>
                                ${sensor.status}
                            </td>
                            <td data-label="Battery">
                                ${hasBatteryAction && sensor.last_battery_pct !== undefined && sensor.last_battery_pct !== null 
                                    ? `<div class="d-flex align-items-center battery-display w-100 justify-content-end">
                                        <div class="progress flex-grow-1 me-2" style="height: 20px; min-width: 60px; max-width: 150px;" title="${sensor.last_battery_voltage ? sensor.last_battery_voltage.toFixed(2) + 'V' : ''}">
                                            <div class="progress-bar ${sensor.last_battery_pct < 20 ? 'bg-danger' : (sensor.last_battery_pct < 50 ? 'bg-warning' : 'bg-success')}" 
                                                 role="progressbar" 
                                                 style="width: ${sensor.last_battery_pct}%" 
                                                 aria-valuenow="${sensor.last_battery_pct}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <span class="fw-bold" style="min-width: 3.5em; text-align: right;">${sensor.last_battery_pct}%</span>
                                       </div>`
                                    : (hasBatteryAction && sensor.last_battery_voltage ? `<small>${sensor.last_battery_voltage.toFixed(2)}V</small>` : '<span class="text-muted">-</span>')}
                            </td>
                            <td data-label="Current Script">${scriptIndicator}</td>
                            <td data-label="Running Version">${versionIndicator}</td>
                            <td data-label="Last Check-in">${sensor.last_check_in ? new Date(sensor.last_check_in).toLocaleString() : 'Never'}</td>
                            <td data-label="Actions">
                                <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                                    <select class="form-select form-select-sm" style="width: auto; max-width: 150px;" 
                                            onchange="assignScript('${sensor.sensor_id}', this.value)"
                                            title="Assign Script">
                                        ${scriptOptions}
                                    </select>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="viewSensorDetails('${sensor.sensor_id}')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="openLogicBuilder('${sensor.sensor_id}')" title="Logic Builder">
                                            <i class="fas fa-project-diagram"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="openSensorPlotter('${sensor.sensor_id}')" title="Serial Plotter">
                                            <i class="fas fa-chart-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteSensor('${sensor.sensor_id}')" title="Delete Sensor">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}



async function loadStats() {
    try {
        // Use the already-loaded sensors array if available, otherwise fetch
        let allSensors = sensors;
        if (!allSensors || allSensors.length === 0) {
            const response = await fetch('/api/sensor-master/sensors');
            if (!response.ok) throw new Error('Failed to load stats');
            allSensors = await response.json();
        }
        
        const stats = {
            total: allSensors.length,
            online: allSensors.filter(s => s.status === 'online').length,
            offline: allSensors.filter(s => s.status === 'offline').length,
            hibernating: allSensors.filter(s => s.status === 'hibernating').length
        };
        
        document.getElementById('stat-total-sensors').textContent = stats.total;
        document.getElementById('stat-online-sensors').textContent = stats.online;
        document.getElementById('stat-offline-sensors').textContent = stats.offline;
        document.getElementById('stat-pending-sensors').textContent = stats.hibernating;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Generate board SVG visualization
function getBoardSvg(boardType) {
    if (boardType === 'firebeetle2_esp32c6') {
        // DFRobot Firebeetle 2 ESP32-C6 SVG
        return `
            <svg width="280" height="180" viewBox="0 0 280 180" xmlns="http://www.w3.org/2000/svg">
                <!-- Board PCB -->
                <rect x="20" y="20" width="240" height="140" rx="8" fill="#2E7D32" stroke="#1B5E20" stroke-width="2"/>
                
                <!-- ESP32-C6 Chip -->
                <rect x="110" y="60" width="60" height="60" rx="3" fill="#424242" stroke="#212121" stroke-width="2"/>
                <text x="140" y="85" font-family="Arial" font-size="10" fill="white" text-anchor="middle">ESP32</text>
                <text x="140" y="98" font-family="Arial" font-size="10" fill="white" text-anchor="middle">C6</text>
                <text x="140" y="111" font-family="Arial" font-size="8" fill="#90CAF9" text-anchor="middle">RISC-V</text>
                
                <!-- USB-C Port -->
                <rect x="118" y="5" width="44" height="18" rx="4" fill="#616161" stroke="#424242" stroke-width="1"/>
                <text x="140" y="16" font-family="Arial" font-size="8" fill="white" text-anchor="middle">USB-C</text>
                
                <!-- Pin Headers Left -->
                <g>
                    ${Array.from({length: 8}, (_, i) => `
                        <rect x="8" y="${35 + i * 15}" width="12" height="8" rx="1" fill="#FFD700" stroke="#FFA000" stroke-width="0.5"/>
                    `).join('')}
                </g>
                
                <!-- Pin Headers Right -->
                <g>
                    ${Array.from({length: 8}, (_, i) => `
                        <rect x="260" y="${35 + i * 15}" width="12" height="8" rx="1" fill="#FFD700" stroke="#FFA000" stroke-width="0.5"/>
                    `).join('')}
                </g>
                
                <!-- Status LED -->
                <circle cx="50" cy="35" r="3" fill="#00E676" opacity="0.8"/>
                <text x="60" y="38" font-family="Arial" font-size="8" fill="white">PWR</text>
                
                <!-- WiFi 6 Antenna -->
                <path d="M 230 40 Q 240 40, 240 50 T 230 60" stroke="#FFD700" fill="none" stroke-width="2"/>
                <text x="220" y="53" font-family="Arial" font-size="7" fill="white" text-anchor="end">WiFi 6</text>
                
                <!-- Board Label -->
                <text x="140" y="155" font-family="Arial" font-size="9" fill="white" text-anchor="middle" font-weight="bold">Firebeetle 2 ESP32-C6</text>
                <text x="140" y="168" font-family="Arial" font-size="7" fill="#81C784" text-anchor="middle">DFRobot</text>
            </svg>
        `;
    } else if (boardType === 'esp32_wroom32') {
        // ESP32-WROOM-32 SVG
        return `
            <svg width="280" height="180" viewBox="0 0 280 180" xmlns="http://www.w3.org/2000/svg">
                <!-- Board PCB -->
                <rect x="20" y="20" width="240" height="140" rx="8" fill="#1565C0" stroke="#0D47A1" stroke-width="2"/>
                
                <!-- ESP32 Module -->
                <rect x="95" y="50" width="90" height="80" rx="3" fill="#37474F" stroke="#263238" stroke-width="2"/>
                <text x="140" y="78" font-family="Arial" font-size="12" fill="white" text-anchor="middle" font-weight="bold">ESP32</text>
                <text x="140" y="93" font-family="Arial" font-size="9" fill="white" text-anchor="middle">WROOM-32</text>
                <text x="140" y="108" font-family="Arial" font-size="7" fill="#90CAF9" text-anchor="middle">Dual Core</text>
                <text x="140" y="120" font-family="Arial" font-size="7" fill="#90CAF9" text-anchor="middle">240MHz</text>
                
                <!-- Micro USB Port -->
                <rect x="120" y="5" width="40" height="18" rx="4" fill="#616161" stroke="#424242" stroke-width="1"/>
                <text x="140" y="16" font-family="Arial" font-size="8" fill="white" text-anchor="middle">USB</text>
                
                <!-- Pin Headers Left -->
                <g>
                    ${Array.from({length: 9}, (_, i) => `
                        <rect x="8" y="${30 + i * 14}" width="12" height="8" rx="1" fill="#FFD700" stroke="#FFA000" stroke-width="0.5"/>
                    `).join('')}
                </g>
                
                <!-- Pin Headers Right -->
                <g>
                    ${Array.from({length: 9}, (_, i) => `
                        <rect x="260" y="${30 + i * 14}" width="12" height="8" rx="1" fill="#FFD700" stroke="#FFA000" stroke-width="0.5"/>
                    `).join('')}
                </g>
                
                <!-- Status LED -->
                <circle cx="50" cy="35" r="3" fill="#FF1744" opacity="0.8"/>
                <text x="60" y="38" font-family="Arial" font-size="8" fill="white">LED</text>
                
                <!-- WiFi Antenna -->
                <path d="M 220 45 Q 230 45, 230 55 T 220 65" stroke="#FFD700" fill="none" stroke-width="2"/>
                <text x="210" y="58" font-family="Arial" font-size="7" fill="white" text-anchor="end">WiFi</text>
                
                <!-- Board Label -->
                <text x="140" y="155" font-family="Arial" font-size="10" fill="white" text-anchor="middle" font-weight="bold">ESP32-WROOM-32</text>
                <text x="140" y="168" font-family="Arial" font-size="7" fill="#90CAF9" text-anchor="middle">Espressif</text>
            </svg>
        `;
    } else {
        // Unknown board - generic SVG
        return `
            <svg width="280" height="180" viewBox="0 0 280 180" xmlns="http://www.w3.org/2000/svg">
                <rect x="20" y="20" width="240" height="140" rx="8" fill="#757575" stroke="#424242" stroke-width="2"/>
                <text x="140" y="95" font-family="Arial" font-size="16" fill="white" text-anchor="middle">
                    <tspan></tspan>
                </text>
                <text x="140" y="120" font-family="Arial" font-size="10" fill="white" text-anchor="middle">Unknown Board</text>
            </svg>
        `;
    }
}


async function viewSensorDetails(sensorId) {
    const sensor = sensors.find(s => s.sensor_id === sensorId);
    if (!sensor) return;
    
    // Get board configuration (same function used by Serial Plotter)
    const boardConfig = getBoardConfig(sensor.board_type);
    
    const content = `
        <!-- Board Visualization -->
        <div class="text-center mb-4 p-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
            <div style="background: white; border-radius: 8px; padding: 15px; display: inline-block; max-width: 400px;">
                <img src="${boardConfig.image}" alt="${boardConfig.name}" class="img-fluid" style="max-height: 400px; width: auto;" 
                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 280 180%22%3E%3Crect fill=%22%23ddd%22 width=%22280%22 height=%22180%22/%3E%3Ctext x=%22140%22 y=%2290%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22%23666%22%3EBoard Image%3C/text%3E%3Ctext x=%22140%22 y=%22110%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2216%22 fill=%22%23999%22%3ENot Available%3C/text%3E%3C/svg%3E';">
            </div>
            <div class="mt-3">
                <h5 class="text-white mb-1">
                    <i class="fas fa-microchip"></i> ${boardConfig.name}
                </h5>
                <small class="text-white-50">
                    ${sensor.board_type === 'firebeetle2_esp32c6' 
                        ? 'RISC-V 160MHz  WiFi 6  BLE 5.0'
                        : sensor.board_type === 'ESP32-WROOM-32'
                            ? 'Xtensa Dual-Core 240MHz  WiFi  BLE 4.2'
                            : 'ESP32 Development Board'}
                </small>
            </div>
        </div>
        
        <dl class="row">
            <dt class="col-sm-3">Sensor ID:</dt>
            <dd class="col-sm-9"><code>${sensor.sensor_id}</code></dd>
            
            <dt class="col-sm-3">Name:</dt>
            <dd class="col-sm-9">${sensor.sensor_name || 'Unnamed'}</dd>
            
            <dt class="col-sm-3">Type:</dt>
            <dd class="col-sm-9">${sensor.sensor_type}</dd>
            
            <dt class="col-sm-3">Board Type:</dt>
            <dd class="col-sm-9">
                ${sensor.board_type === 'firebeetle2_esp32c6' 
                    ? '<span class="badge bg-info"><i class="fas fa-microchip"></i> Firebeetle 2 ESP32-C6</span> <small class="text-muted">(RISC-V)</small>'
                    : sensor.board_type === 'esp32_wroom32'
                        ? '<span class="badge bg-primary"><i class="fas fa-microchip"></i> ESP32-WROOM-32</span> <small class="text-muted">(Xtensa)</small>'
                        : '<span class="text-muted">Unknown</span>'}
            </dd>
            
            <dt class="col-sm-3">Status:</dt>
            <dd class="col-sm-9">
                <i class="fas fa-circle sensor-status-${sensor.status}"></i> ${sensor.status}
            </dd>
            
            <dt class="col-sm-3">Hardware:</dt>
            <dd class="col-sm-9">${sensor.hardware_info || 'N/A'}</dd>
            
            <dt class="col-sm-3">Firmware:</dt>
            <dd class="col-sm-9">${sensor.firmware_version || 'N/A'}</dd>
            
            <dt class="col-sm-3">IP Address:</dt>
            <dd class="col-sm-9">${sensor.ip_address || 'N/A'}</dd>
            
            <dt class="col-sm-3">MAC Address:</dt>
            <dd class="col-sm-9">${sensor.mac_address || 'N/A'}</dd>
            
            <dt class="col-sm-3">Master:</dt>
            <dd class="col-sm-9">${sensor.master_name || 'Unassigned'}</dd>
            
            <dt class="col-sm-3">Temperature:</dt>
            <dd class="col-sm-9">${sensor.last_temperature !== undefined && sensor.last_temperature !== null ? parseFloat(sensor.last_temperature).toFixed(1) + ' C' : 'N/A'}</dd>

            <dt class="col-sm-3">Relay State:</dt>
            <dd class="col-sm-9">${sensor.last_relay_state !== undefined && sensor.last_relay_state !== null ? (sensor.last_relay_state ? '<span class="badge bg-success">ON</span>' : '<span class="badge bg-danger">OFF</span>') : 'N/A'}</dd>

            <dt class="col-sm-3">Battery:</dt>
            <dd class="col-sm-9">
                ${sensor.last_battery_pct !== undefined && sensor.last_battery_pct !== null 
                    ? `<div class="progress" style="height: 20px; max-width: 200px;">
                        <div class="progress-bar ${sensor.last_battery_pct < 20 ? 'bg-danger' : (sensor.last_battery_pct < 50 ? 'bg-warning' : 'bg-success')}" 
                             role="progressbar" 
                             style="width: ${sensor.last_battery_pct}%" 
                             aria-valuenow="${sensor.last_battery_pct}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${sensor.last_battery_pct}% (${sensor.last_battery_voltage ? sensor.last_battery_voltage.toFixed(2) + 'V' : ''})
                        </div>
                       </div>`
                    : (sensor.last_battery_voltage ? sensor.last_battery_voltage.toFixed(2) + ' V' : 'N/A')}
            </dd>

            <dt class="col-sm-3">Last Check-in:</dt>
            <dd class="col-sm-9">${sensor.last_check_in ? new Date(sensor.last_check_in).toLocaleString() : 'Never'}</td>
            
            <dt class="col-sm-3">Hibernation:</dt>
            <dd class="col-sm-9">${sensor.check_in_interval || 60} seconds</dd>
            
            <dt class="col-sm-3">Registered:</dt>
            <dd class="col-sm-9">${new Date(sensor.created_at).toLocaleString()}</dd>
            
            <dt class="col-sm-3">Capabilities:</dt>
            <dd class="col-sm-9">
                ${sensor.capabilities && sensor.capabilities.length > 0 
                    ? sensor.capabilities.map(c => `<span class="badge bg-info">${c}</span>`).join(' ')
                    : 'None'}
            </dd>
        </dl>
    `;
    
    document.getElementById('sensorDetailContent').innerHTML = content;
    
    const modalEl = document.getElementById('sensorDetailModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

async function deleteSensor(sensorId) {
    if (!confirm('Are you sure you want to delete this sensor registration?')) return;
    
    try {
        const response = await fetch(`/api/sensor-master/sensors/${sensorId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete sensor');
        
        showAlert('Sensor deleted successfully', 'success');
        await loadSensors();
        await loadStats();
    } catch (error) {
        console.error('Error deleting sensor:', error);
        showAlert('Failed to delete sensor', 'danger');
    }
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3" 
             role="alert" style="z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    setTimeout(() => {
        const alert = document.querySelector('.alert');
       
        if (alert) {
            bootstrap.Alert.getInstance(alert)?.close();
        }
    }, 5000);
}

// ============================================================================
// ESP32 CODE EXPORT FUNCTIONS
// ============================================================================

let generatedCodeData = null;

function showCodeExportModal() {
    // Populate sensor dropdown
    const sensorSelect = document.getElementById('exportSensorId');
    sensorSelect.innerHTML = '<option value="">Generate New Template</option>';
    
    sensors.forEach(sensor => {
        const option = document.createElement('option');
        option.value = sensor.sensor_id;
        option.textContent = `${sensor.sensor_name || sensor.sensor_id} (${sensor.sensor_type})`;
        sensorSelect.appendChild(option);
    });
    
    // Reset form
    document.getElementById('exportSensorType').value = 'esp32_fermentation';
    document.getElementById('exportLanguage').value = 'arduino';
    document.getElementById('exportWifiSsid').value = '';
    document.getElementById('exportWifiPassword').value = '';
    
    // Hide result sections
    document.getElementById('codeExportLoading').style.display = 'none';
    document.getElementById('codeExportResult').style.display = 'none';
    document.getElementById('codeExportError').style.display = 'none';
    
    generatedCodeData = null;
    
    // Show modal
    const modalEl = document.getElementById('codeExportModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

async function generateCode() {
    const sensorId = document.getElementById('exportSensorId').value || null;
    const sensorType = document.getElementById('exportSensorType').value;
    const language = document.getElementById('exportLanguage').value;
    const wifiSsid = document.getElementById('exportWifiSsid').value;
    const wifiPassword = document.getElementById('exportWifiPassword').value;
    
    // Show loading
    document.getElementById('codeExportLoading').style.display = 'block';
    document.getElementById('codeExportResult').style.display = 'none';
    document.getElementById('codeExportError').style.display = 'none';
    
    try {
        const payload = {
            language: language,
            wifi_ssid: wifiSsid,
            wifi_password: wifiPassword
        };
        
        if (sensorId) {
            payload.sensor_id = sensorId;
        } else if (sensorType) {
            payload.sensor_type = sensorType;
        }
        
        const response = await fetch('/api/sensor-master/export-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            generatedCodeData = data;
            
            // Display the code
            document.getElementById('generatedCode').textContent = data.code;
            document.getElementById('codeExportResult').style.display = 'block';
            
            showAlert('Code generated successfully!', 'success');
        } else {
            throw new Error(data.error || 'Failed to generate code');
        }
    } catch (error) {
        console.error('Error generating code:', error);
        document.getElementById('codeExportErrorMessage').textContent = error.message;
        document.getElementById('codeExportError').style.display = 'block';
    } finally {
        document.getElementById('codeExportLoading').style.display = 'none';
    }
}

function copyCodeToClipboard() {
    if (!generatedCodeData) {
        showAlert('Please generate code first', 'warning');
        return;
    }
    
    const code = document.getElementById('generatedCode').textContent;
    
    navigator.clipboard.writeText(code).then(() => {
        showAlert('Code copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showAlert('Failed to copy code', 'danger');
    });
}

function downloadCode() {
    if (!generatedCodeData) {
        showAlert('Please generate code first', 'warning');
        return;
    }
    
    const code = generatedCodeData.code;
    const filename = generatedCodeData.filename || 'esp32_sensor.ino';
    
    // Create blob and download
    const blob = new Blob([code], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showAlert(`Downloaded ${filename}`, 'success');
}

// ============================================================================
// SCRIPT UPLOAD & MANAGEMENT FUNCTIONS
// ============================================================================

let scripts = [];

async function loadScripts() {
    try {
        const response = await fetch('/api/sensor-master/library-scripts');
        if (!response.ok) throw new Error('Failed to load library scripts');
        
        scripts = await response.json();
        renderScripts();
        // Also re-render sensors to update the script dropdowns
        renderSensors();
    } catch (error) {
        console.error('Error loading scripts:', error);
        document.getElementById('scriptsContainer').innerHTML = 
            '<div class="alert alert-danger">Failed to load scripts</div>';
    }
}

function renderScripts() {
    const container = document.getElementById('scriptsContainer');
    
    if (scripts.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-file-code fa-3x mb-3"></i>
                <p>No scripts in library. Click "Upload New Script" to create one.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>Name</th>
                <th>Version</th>
                <th>Type</th>
                <th>Target Sensor</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    scripts.forEach(script => {
        html += `
            <tr>
                <td data-label="Name"><strong>${script.name}</strong></td>
                <td data-label="Version"><span class="badge bg-secondary">${script.script_version}</span></td>
                <td data-label="Type"><code>${script.script_type}</code></td>
                <td data-label="Target Sensor">${script.target_sensor_type || '<span class="text-muted">Any</span>'}</td>
                <td data-label="Description">${script.description || '-'}</td>
                <td data-label="Actions">
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-sm btn-outline-info" onclick="viewScript(${script.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteScript(${script.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function deleteScript(scriptId) {
    if (!confirm('Are you sure you want to delete this script? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`/api/sensor-master/library-scripts/${scriptId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete script');
        
        showAlert('Script deleted successfully', 'success');
        await loadScripts();
    } catch (error) {
        console.error('Error deleting script:', error);
        showAlert('Failed to delete script', 'danger');
    }
}

function showUploadScriptModal() {
    // Reset form
    document.getElementById('scriptName').value = '';
    document.getElementById('scriptVersion').value = '1.0.0';
    document.getElementById('scriptType').value = 'arduino';
    document.getElementById('scriptDescription').value = '';
    document.getElementById('scriptContent').value = '';
    document.getElementById('scriptTargetType').value = '';
    document.getElementById('scriptUploadResult').style.display = 'none';
    
    // Show modal
    const modalEl = document.getElementById('uploadScriptModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

async function uploadScript() {
    const scriptName = document.getElementById('scriptName').value;
    const scriptContent = document.getElementById('scriptContent').value;
    const scriptVersion = document.getElementById('scriptVersion').value;
    const scriptType = document.getElementById('scriptType').value;
    const description = document.getElementById('scriptDescription').value;
    const targetType = document.getElementById('scriptTargetType').value;
    
    // Validation
    if (!scriptName) {
        showAlert('Please enter a script name', 'warning');
        return;
    }
    
    if (!scriptContent.trim()) {
        showAlert('Please enter script content', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: scriptName,
                script_content: scriptContent,
                script_version: scriptVersion,
                script_type: scriptType,
                description: description,
                target_sensor_type: targetType
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Show success message
            const resultDiv = document.getElementById('scriptUploadResult');
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <strong>Script saved to library!</strong><br>
                You can now assign this script to sensors.
            `;
            resultDiv.style.display = 'block';
            
            showAlert('Script saved to library successfully!', 'success');
            
            // Reload scripts
            await loadScripts();
            
            // Close modal after a delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('uploadScriptModal')).hide();
            }, 2000);
        } else {
            throw new Error(data.error || 'Failed to save script');
        }
    } catch (error) {
        console.error('Error saving script:', error);
        const resultDiv = document.getElementById('scriptUploadResult');
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <strong>Error:</strong> ${error.message}
        `;
        resultDiv.style.display = 'block';
    }
}

let currentAssignScriptId = null;

function showAssignScriptModal(scriptId, scriptName) {
    currentAssignScriptId = scriptId;
    document.getElementById('assignScriptName').textContent = scriptName;
    
    // Populate sensor dropdown
    const select = document.getElementById('assignSensorId');
    select.innerHTML = '<option value="">Choose a sensor...</option>';
    
    sensors.forEach(sensor => {
        const option = document.createElement('option');
        option.value = sensor.sensor_id;
        option.textContent = `${sensor.sensor_name} (${sensor.sensor_type})`;
        select.appendChild(option);
    });
    
    const modalEl = document.getElementById('assignScriptModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

async function submitAssignScriptModal() {
    const sensorId = document.getElementById('assignSensorId').value;
    
    if (!sensorId) {
        showAlert('Please select a sensor', 'warning');
        return;
    }
    
    if (!currentAssignScriptId) {
        showAlert('No script selected', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/assign-library-script', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                library_script_id: currentAssignScriptId,
                sensor_id: sensorId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const resultDiv = document.getElementById('assignScriptResult');
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `
                               <i class="fas fa-check-circle"></i>
                <strong>Script assigned successfully!</strong>
            `;
            resultDiv.style.display = 'block';
            
            // Reload assignments if that function exists or reload page
            // For now just close modal after delay
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('assignScriptModal')).hide();
                resultDiv.style.display = 'none';
            }, 1500);
            
        } else {
            throw new Error(data.error || 'Failed to assign script');
        }
    } catch (error) {
        console.error('Error assigning script:', error);
        const resultDiv = document.getElementById('assignScriptResult');
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <strong>Error:</strong> ${error.message}
        `;
        resultDiv.style.display = 'block';
    }
}

function viewScript(scriptId) {
    const script = scripts.find(s => s.id === scriptId);
    if (!script) {
        showAlert('Script not found', 'error');
        return;
    }
    
    document.getElementById('viewScriptName').textContent = script.name;
    document.getElementById('viewScriptVersion').textContent = script.script_version;
    document.getElementById('viewScriptType').textContent = script.script_type;
    document.getElementById('viewScriptTarget').textContent = script.target_sensor_type || 'All';
    document.getElementById('viewScriptDescription').textContent = script.description || 'No description provided.';
    document.getElementById('viewScriptContent').textContent = script.script_content;
    
    const modalEl = document.getElementById('viewScriptModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

/* Logic Builder Code */

let currentLogicSensorId = null;
let currentLogicData = { actions: [] };
let currentSensorCapabilities = null;
let currentLogicSensor = null; // Store the full sensor object

const SYSTEM_VARIABLES = [
    'millis', 'wifi_rssi', 'free_heap', 'uptime', 'sensor_id', 
    'firmware_version', 'battery', 'battery_pct', 
    'ip_address', 'wifi_ssid', 'current_datetime'
];

// Helper to insert text at cursor position in a textarea/input
function insertAtCursor(elementId, text) {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    const start = el.selectionStart;
    const end = el.selectionEnd;
    const val = el.value;
    
    el.value = val.substring(0, start) + text + val.substring(end);
    el.selectionStart = el.selectionEnd = start + text.length;
    el.focus();
    el.dispatchEvent(new Event('change'));
}

function openLogicBuilder(sensorId = null, scriptId = null) {
    currentLogicSensorId = sensorId;
    currentLogicData = { actions: [] };
    logicViewStack = [];
    
    if (sensorId) {
        const sensor = sensors.find(s => s.sensor_id === sensorId);
        currentLogicSensor = sensor;
        
        document.getElementById('logicBuilderSensorName').textContent = sensor ? (sensor.sensor_name || 'Sensor ' + sensor.sensor_id) : 'Unknown Sensor';
        
        const boardBadge = document.getElementById('logicBuilderBoardType');
        if (boardBadge && sensor) {
            boardBadge.textContent = sensor.board_type || 'Unknown Board';
            boardBadge.className = 'badge bg-info ms-2';
        }
        
        const boardSelector = document.getElementById('boardTypeSelectorContainer');
        if (boardSelector) boardSelector.style.display = 'none';
        
        try {
            if (sensor) {
                currentSensorCapabilities = typeof sensor.capabilities === 'string' 
                    ? JSON.parse(sensor.capabilities) 
                    : (sensor.capabilities || {});
            } else {
                currentSensorCapabilities = {};
            }
        } catch (e) {
            console.error('Error parsing capabilities:', e);
            currentSensorCapabilities = {};
        }
    } else {
        // Generic / New Script Mode
        currentLogicSensor = null;
        document.getElementById('logicBuilderSensorName').textContent = 'New Generic Script';
        
        const boardBadge = document.getElementById('logicBuilderBoardType');
        if (boardBadge) {
            boardBadge.textContent = 'Generic / All';
            boardBadge.className = 'badge bg-secondary ms-2';
        }
        
        // Show board selector for generic mode
        const boardSelector = document.getElementById('boardTypeSelectorContainer');
        if (boardSelector) {
            boardSelector.style.display = 'block';
            // Default to generic
            document.getElementById('logicBoardTypeSelect').value = 'generic';
        }
        
        currentSensorCapabilities = {};
    }
    
    // Hide board selector if we are editing a specific sensor (locked to that sensor's board)
    if (sensorId) {
        const boardSelector = document.getElementById('boardTypeSelectorContainer');
        if (boardSelector) boardSelector.style.display = 'none';
    }
    
    renderCapabilitiesList();
    
    // Initialize Logic Data
    let loadedFromSensor = false;
    
    // Try to load current script from sensor if available
    if (sensorId && currentLogicSensor && currentLogicSensor.assigned_script) {
        try {
            const script = currentLogicSensor.assigned_script;
            let content = script.script_content;
            let parsed;
            
            if (typeof content === 'string') {
                parsed = JSON.parse(content);
            } else {
                parsed = content;
            }
            
            currentLogicData = parsed;
            
            // Ensure actions array exists
            if (!currentLogicData.actions && currentLogicData.commands) {
                currentLogicData.actions = currentLogicData.commands;
            }
            if (!currentLogicData.actions) {
                currentLogicData.actions = [];
            }
            
            // Normalize data
            normalizeLogicData(currentLogicData.actions);
            
            // Update UI fields
            document.getElementById('logicName').value = script.name;
            document.getElementById('logicVersion').value = script.version;
            document.getElementById('logicDescription').value = ''; 
            
            // Auto-increment version (Patch by default)
            bumpVersion('patch');
            
            loadedFromSensor = true;
            // showAlert(`Loaded current script for ${currentLogicSensor.sensor_name || sensorId}`, 'success');
            
        } catch (e) {
            console.error('Error loading sensor script:', e);
            // Fallback to blank will happen below
        }
    }
    
    // If not loaded from sensor, initialize with BLANK data
    if (!loadedFromSensor) {
        currentLogicData = { 
            name: '', 
            version: '1.0.0', 
            description: '', 
            target_sensor_type: currentLogicSensor ? (currentLogicSensor.board_type || 'generic') : 'generic',
            actions: [] 
        };
        
        // Reset UI fields
        document.getElementById('logicName').value = '';
        document.getElementById('logicVersion').value = '1.0.0';
        document.getElementById('logicDescription').value = '';
    }
    
    document.getElementById('logicLibrarySelect').value = '';
    
    // Populate library dropdown
    populateLibraryDropdown();
    
    // Render Toolbox based on capabilities
    renderToolbox();
    
    // Initialize editors
    document.getElementById('logicJsonEditor').value = JSON.stringify(currentLogicData, null, 2);
    renderLogicCanvas();
    renderVariablesList();
    
    const modalEl = document.getElementById('logicBuilderModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

function renderVariablesList() {
    const container = document.getElementById('availableVariablesList');
    if (!container) return;
    
    // 1. System Variables
    const systemVars = SYSTEM_VARIABLES || [];
    
    // 2. User Aliases (from Logic)
    const userAliases = collectUserAliases(currentLogicData.actions);
    const uniqueAliases = [...new Set(userAliases.map(a => a.name))];
    
    // 3. User Variables (from Logic)
    const userVars = collectUserVariables(currentLogicData.actions);
    const uniqueVars = [...new Set(userVars)];

    // 4. Sensor Capabilities
    const sensorCaps = currentSensorCapabilities && currentSensorCapabilities.sensors ? currentSensorCapabilities.sensors : [];
    
    if (systemVars.length === 0 && uniqueAliases.length === 0 && uniqueVars.length === 0 && sensorCaps.length === 0) {
        container.innerHTML = '<p class="text-muted">No variables defined.</p>';
        return;
    }
    
    let html = '<ul class="list-unstyled ps-2 small">';
    
    // System
    if (systemVars.length > 0) {
        html += '<li class="mb-1"><strong><i class="fas fa-cog"></i> System</strong></li>';
        systemVars.forEach(v => {
            html += `<li class="ms-3"><code class="text-secondary">{${v}}</code></li>`;
        });
    }

    // Sensors
    if (sensorCaps.length > 0) {
        html += '<li class="mt-2 mb-1"><strong><i class="fas fa-microchip"></i> Sensors</strong></li>';
        sensorCaps.forEach(s => {
            if (s.name) html += `<li class="ms-3"><code class="text-info">{${s.name}}</code></li>`;
        });
    }
    
    // Aliases
    if (uniqueAliases.length > 0) {
        html += '<li class="mt-2 mb-1"><strong><i class="fas fa-tag"></i> Aliases</strong></li>';
        uniqueAliases.forEach(a => {
            html += `<li class="ms-3"><code class="text-success">{${a}}</code></li>`;
        });
    }
    
    // User Variables
    if (uniqueVars.length > 0) {
        html += '<li class="mt-2 mb-1"><strong><i class="fas fa-calculator"></i> Variables</strong></li>';
        uniqueVars.forEach(v => {
            html += `<li class="ms-3"><code class="text-primary">{${v}}</code></li>`;
        });
    }
    
    html += '</ul>';
    container.innerHTML = html;
}

function changeLogicBoardType(boardType) {
    // Update badge
    const boardBadge = document.getElementById('logicBuilderBoardType');
    if (boardBadge) {
        if (boardType === 'generic') {
            boardBadge.textContent = 'Generic / All';
            boardBadge.className = 'badge bg-secondary ms-2';
        } else {
            boardBadge.textContent = boardType;
            if (boardType.includes('c6')) {
                boardBadge.className = 'badge bg-success ms-2';
            } else {
                boardBadge.className = 'badge bg-info ms-2';
            }
        }
    }
    
    // Update currentLogicSensor mock object to reflect selected board type
    if (!currentLogicSensor) {
        currentLogicSensor = {};
    }
    currentLogicSensor.board_type = boardType;
    
    // Update the logic data itself so it's saved with the script
    if (currentLogicData) {
        currentLogicData.target_sensor_type = boardType;
    }
    
    // Re-render toolbox to show/hide capabilities based on board
    renderToolbox();
}

function populateLibraryDropdown() {
    const select = document.getElementById('logicLibrarySelect');
    // Keep first option
    select.innerHTML = '<option value="">-- Select a script to load --</option>';
    
    // Filter for JSON scripts only
    const jsonScripts = scripts.filter(s => s.script_type === 'json' || s.script_type === 'snippet');
    
    jsonScripts.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${s.name} (v${s.script_version})`;
        select.appendChild(option);
    });
}

function loadLogicFromLibrary(scriptId) {
    if (!scriptId) return;
    
    const script = scripts.find(s => s.id == scriptId);
    if (!script) return;
    
    try {
        let content = script.script_content;
        let parsed;
        
        if (typeof content === 'string') {
            parsed = JSON.parse(content);
        } else {
            parsed = content;
        }
        
        // Update current logic data
        currentLogicData = parsed;
        
        // Ensure actions array exists
        if (!currentLogicData.actions && currentLogicData.commands) {
            currentLogicData.actions = currentLogicData.commands;
        }
        if (!currentLogicData.actions) {
            currentLogicData.actions = [];
        }
        
        // Normalize data to ensure defaults are present
        normalizeLogicData(currentLogicData.actions);
        
        // Update UI fields
        document.getElementById('logicName').value = script.name;
        document.getElementById('logicVersion').value = script.script_version;
        document.getElementById('logicDescription').value = script.description || '';
        
        // Set board type based on script target if in generic mode
        // Priority: 1. target_sensor_type in JSON content, 2. target_sensor_type in DB record
        const targetType = currentLogicData.target_sensor_type || script.target_sensor_type;
        
        if (targetType) {
            const boardSelector = document.getElementById('boardTypeSelectorContainer');
            // Only auto-select if the selector is visible (Generic Mode)
            if (boardSelector && boardSelector.style.display !== 'none') {
                let targetBoard = 'generic';
                const target = targetType.toLowerCase();
                
                if (target.includes('c6') || target.includes('firebeetle')) {
                    targetBoard = 'firebeetle2_esp32c6';
                } else if (target.includes('wroom') || target.includes('esp32')) {
                    targetBoard = 'esp32_wroom32';
                }
                
                const select = document.getElementById('logicBoardTypeSelect');
                if (select) {
                    select.value = targetBoard;
                    changeLogicBoardType(targetBoard);
                }
            }
        }
        
        // Auto-increment version (Patch by default)
        bumpVersion('patch');
        
        // Update editors
        document.getElementById('logicJsonEditor').value = JSON.stringify(currentLogicData, null, 2);
        renderLogicCanvas();
        
        showAlert(`Loaded "${script.name}"`, 'success');
        
    } catch (e) {
        console.error('Error loading script:', e);
        showAlert('Failed to parse script content', 'danger');
    }
}

function bumpVersion(type) {
    const versionInput = document.getElementById('logicVersion');
    let currentVer = versionInput.value || '0.0.0';
    
    // Simple semantic versioning regex
    const parts = currentVer.split('.').map(p => parseInt(p));
    
    if (parts.length !== 3 || parts.some(isNaN)) {
        // If invalid format, reset to 1.0.0
        versionInput.value = '1.0.0';
        if (currentLogicData) currentLogicData.version = '1.0.0';
        return;
    }
    
    let [major, minor, patch] = parts;
    
    if (type === 'major') {
        major++;
        minor = 0;
        patch = 0;
    } else if (type === 'minor') {
        minor++;
        patch = 0;
    } else { // patch
        patch++;
    }
    
    const newVer = `${major}.${minor}.${patch}`;
    versionInput.value = newVer;
    
    // Update internal data
    if (currentLogicData) {
        currentLogicData.version = newVer;
    }
}

function renderCapabilitiesList() {
    const container = document.getElementById('logicCapabilitiesList');
    if (!container) return;
    
    if (!currentSensorCapabilities || Object.keys(currentSensorCapabilities).length === 0) {
        container.innerHTML = '<p class="text-muted">No capabilities detected.</p>';
        return;
    }
    
    let html = '';
    
    // Pins
    if (currentSensorCapabilities.pins) {
        html += '<strong>Hardware Pins:</strong><ul class="list-unstyled ps-2">';
        currentSensorCapabilities.pins.forEach(p => {
            html += `<li>Pin ${p.pin}: <code class="text-primary">${p.name || 'GPIO'}</code></li>`;
        });
        html += '</ul>';
    }
    
    // Sensors/Data
    if (currentSensorCapabilities.sensors) {
        html += '<strong>Sensors (Alias):</strong><ul class="list-unstyled ps-2">';
        currentSensorCapabilities.sensors.forEach(s => {
            html += `<li><i class="fas fa-microchip"></i> <code class="text-primary">${s.name}</code> <span class="text-muted small">(${s.type})</span></li>`;
        });
        html += '</ul>';
    }
    
    container.innerHTML = html;
}

function normalizeLogicData(actions) {
    if (!actions) return;
    
    actions.forEach(block => {
        // Apply defaults based on type
        if (block.type === 'gpio_read') {
            if (block.pin === undefined) block.pin = 2;
            if (block.mode === undefined) block.mode = 'INPUT';
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'gpio_write') {
            if (block.pin === undefined) block.pin = 2;
            if (block.value === undefined) block.value = 'HIGH';
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'pwm_write') {
            if (block.pin === undefined) block.pin = 2;
            if (block.duty === undefined) block.duty = 128;
            if (block.freq === undefined) block.freq = 5000;
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'analog_write') {
            if (block.pin === undefined) block.pin = 25;
            if (block.value === undefined) block.value = 128;
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'analog_read') {
            if (block.pin === undefined) block.pin = 34;
            if (block.alias === undefined) block.alias = '';
        } else if (block.type === 'read_temperature') {
            if (block.pin === undefined) block.pin = 4;
            if (block.alias === undefined) block.alias = '';
            block.device_type = 'temp_sensor';
        } else if (block.type === 'read_battery') {
            if (block.pin === undefined) block.pin = 34;
            if (block.r1 === undefined) block.r1 = 100000;
            if (block.r2 === undefined) block.r2 = 100000;
            if (block.alias === undefined) block.alias = 'battery';
        } else if (block.type === 'set_relay') {
            if (block.pin === undefined) block.pin = ''; // Ensure pin exists so it renders
            if (block.state === undefined) block.state = true;
            if (block.alias === undefined) block.alias = '';
            block.device_type = 'relay';
        } else if (block.type === 'delay') {
            if (block.ms === undefined) block.ms = 1000;
        } else if (block.type === 'hibernate') {
            if (block.duration === undefined) block.duration = 60;
            if (block.unit === undefined) block.unit = 'seconds';
        } else if (block.type === 'log') {
            if (block.message === undefined) block.message = '';
        } else if (block.type === 'variable_op') {
            if (block.name === undefined) block.name = 'myVar';
            if (block.operation === undefined) block.operation = '=';
            if (block.value === undefined) block.value = 0;
        } else if (block.type === 'if') {
            if (!block.condition) block.condition = { left: '', operator: '==', right: '' };
            
            // Ensure all properties exist even if condition object exists
            if (block.condition.left === undefined) block.condition.left = '';
            if (block.condition.operator === undefined) block.condition.operator = '==';
            if (block.condition.right === undefined) block.condition.right = '';

            if (!block.then) block.then = [];
            if (!block.else) block.else = [];
            
            // Recursive calls
            normalizeLogicData(block.then);
            normalizeLogicData(block.else);
        }
    });
}

function collectUserAliases(actions) {
    let aliases = [];
    if (!actions) return aliases;
    
    actions.forEach(block => {
        if (block.alias && block.alias.trim() !== '') {
            aliases.push({ name: block.alias, type: block.type });
        }
        if (block.then) aliases = aliases.concat(collectUserAliases(block.then));
        if (block.else) aliases = aliases.concat(collectUserAliases(block.else));
    });
    return aliases;
}

function collectUserVariables(actions) {
    let vars = [];
    if (!actions) return vars;
    
    actions.forEach(block => {
        if (block.type === 'variable_op' && block.name) {
            vars.push(block.name);
        }
        if (block.then) vars = vars.concat(collectUserVariables(block.then));
        if (block.else) vars = vars.concat(collectUserVariables(block.else));
    });
    return vars;
}

function getGlobalPinAliases(actions) {
    let map = {};
    if (!actions) return map;
    
    actions.forEach(block => {
        if (block.pin !== undefined && block.alias && block.alias.trim() !== '') {
            // Only set if not already set (first one wins)
            if (!map[block.pin]) {
                map[block.pin] = block.alias;
            }
        }
        // Recurse
        if (block.then) {
            const subMap = getGlobalPinAliases(block.then);
            Object.keys(subMap).forEach(pin => {
                if (!map[pin]) map[pin] = subMap[pin];
            });
        }
        if (block.else) {
            const subMap = getGlobalPinAliases(block.else);
            Object.keys(subMap).forEach(pin => {
                if (!map[pin]) map[pin] = subMap[pin];
            });
        }
    });
    return map;
}

// Logic Builder Implementation

function validateLogic(actions, path = "") {
    let errors = [];
    if (!actions) return errors;
    
    actions.forEach((block, idx) => {
        const blockName = block.type.toUpperCase() + (path ? ` (in ${path})` : ` #${idx + 1}`);
        
        if (block.type === 'if') {
            if (!block.condition || block.condition.left === '' || block.condition.right === '') {
                errors.push(`${blockName}: Incomplete condition`);
            }
            errors = errors.concat(validateLogic(block.then, `${blockName} THEN`));
            errors = errors.concat(validateLogic(block.else, `${blockName} ELSE`));
        } else if (block.type === 'variable_op') {
            if (!block.name) errors.push(`${blockName}: Missing variable name`);
        } else if (block.type === 'gpio_write' || block.type === 'gpio_read') {
            if (block.pin === undefined || block.pin === null || block.pin === "") errors.push(`${blockName}: Missing Pin`);
        } else if (block.type === 'delay') {
            if (!block.ms || block.ms < 0) errors.push(`${blockName}: Invalid duration`);
        }
    });
    return errors;
}

// Navigation stack for drilling down into nested blocks (IF/ELSE)
let logicViewStack = []; // Array of { array: [], name: "Main" }

function getCurrentLogicArray() {
    if (logicViewStack.length === 0) {
        if (!currentLogicData.actions) currentLogicData.actions = [];
        return currentLogicData.actions;
    }
    return logicViewStack[logicViewStack.length - 1].array;
}

function pushLogicView(array, name) {
    logicViewStack.push({ array: array, name: name });
    renderLogicCanvas();
}

function popLogicView() {
    if (logicViewStack.length > 0) {
        logicViewStack.pop();
        renderLogicCanvas();
    }
}

function resetLogicView() {
    logicViewStack = [];
    renderLogicCanvas();
}

function getConfiguredPeripherals(actions) {
    let peripherals = { relay: [], temp_sensor: [], led: [], button: [] };
    if (!actions) return peripherals;
    
    actions.forEach(block => {
        // Determine device type (explicit or implied by block type)
        let dType = block.device_type;
        if (!dType) {
            if (block.type === 'read_temperature') dType = 'temp_sensor';
            else if (block.type === 'set_relay') dType = 'relay';
        }

        if (dType) {
            if (!peripherals[dType]) peripherals[dType] = [];
            peripherals[dType].push(block);
        }
        // Recurse
        if (block.then) {
            const sub = getConfiguredPeripherals(block.then);
            Object.keys(sub).forEach(k => {
                if (!peripherals[k]) peripherals[k] = [];
                peripherals[k] = peripherals[k].concat(sub[k]);
            });
        }
        if (block.else) {
            const sub = getConfiguredPeripherals(block.else);
            Object.keys(sub).forEach(k => {
                if (!peripherals[k]) peripherals[k] = [];
                peripherals[k] = peripherals[k].concat(sub[k]);
            });
        }
    });
    return peripherals;
}

function renderToolbox() {
    const container = document.getElementById('logicToolbox');
    if (!container) return;
    
    container.innerHTML = '';
    
    const boardType = currentLogicSensor && currentLogicSensor.board_type ? currentLogicSensor.board_type : 'ESP32-WROOM-32';
    const boardConfig = getBoardConfig(boardType);
    const caps = boardConfig.capabilities || {};
    
    // Get currently configured peripherals
    const configured = getConfiguredPeripherals(currentLogicData ? currentLogicData.actions : null);
    
    // Helper to add button
    const addBtn = (label, type, icon, colorClass = 'btn-outline-secondary', disabled = false, title = '') => {
        const btn = document.createElement('button');
        btn.className = `btn ${colorClass} text-start`;
        btn.innerHTML = `<i class="fas ${icon} me-2"></i> ${label}`;
        if (disabled) {
            btn.disabled = true;
            btn.title = title || "Configure a pin for this device first";
            btn.style.opacity = '0.6';
        } else {
            btn.onclick = () => addLogicBlock(type);
        }
        container.appendChild(btn);
    };
    
    // 0. Setup / Configuration
    addBtn('Configure Pin / Device', 'configure_pin', 'fa-cogs', 'btn-outline-dark');
    
    // 1. Logic / Flow Control (Always available)
    addBtn('IF Condition', 'if', 'fa-code-branch', 'btn-outline-warning');
    addBtn('Delay / Wait', 'delay', 'fa-clock');
    addBtn('Log Message', 'log', 'fa-comment-alt');
    addBtn('Hibernate / Sleep', 'hibernate', 'fa-bed', 'btn-outline-dark');
    
    // Variables & Math
    addBtn('Set Variable / Math', 'variable_op', 'fa-calculator', 'btn-outline-secondary');
    addBtn('Initialize Variable (Safe)', 'init_variable', 'fa-shield-alt', 'btn-outline-success');
    
    // 2. GPIO Control
    if (caps.digital_output && caps.digital_output.length > 0) {
        addBtn('Digital Write (On/Off)', 'gpio_write', 'fa-toggle-on', 'btn-outline-primary');
    }
    if (caps.digital_input && caps.digital_input.length > 0) {
        addBtn('Digital Read', 'gpio_read', 'fa-eye', 'btn-outline-info');
    }
    
    // 3. Analog
    if (caps.analog_input && caps.analog_input.length > 0) {
        addBtn('Analog Read (ADC)', 'adc_read', 'fa-wave-square', 'btn-outline-info');
    }
    if (caps.pwm && caps.pwm.length > 0) {
        addBtn('PWM Write (Dimmer)', 'pwm_write', 'fa-sliders-h', 'btn-outline-primary');
    }
    
    // 4. Sensors & Special
    // Temperature (DS18B20) - Requires 'temp_sensor' configuration
    if (configured.temp_sensor && configured.temp_sensor.length > 0) {
        addBtn('Read Temperature', 'read_temperature', 'fa-thermometer-half', 'btn-outline-success');
    }
    
    // Relay - Requires 'relay' configuration
    if (configured.relay && configured.relay.length > 0) {
        addBtn('Control Relay', 'set_relay', 'fa-plug', 'btn-outline-danger');
    }
    
    // Battery - Only if board has battery capability
    if (caps.battery && caps.battery.length > 0) {
        addBtn('Read Battery', 'read_battery', 'fa-battery-half', 'btn-outline-success');
    } else if (boardType.includes('firebeetle')) {
        // Fallback: FireBeetles usually have battery monitoring even if not explicitly in caps
        addBtn('Read Battery', 'read_battery', 'fa-battery-half', 'btn-outline-success');
    }
}

function addLogicBlock(type) {
    try {
        let newBlock;
        
        if (type === 'init_variable') {
            // Create the "Safe Initialization" pattern: IF (var == 0) THEN (var = val)
            newBlock = {
                type: 'if',
                condition: { left: 'myVar', operator: '==', right: '0' },
                then: [
                    { type: 'variable_op', operation: '=', name: 'myVar', value: '1' }
                ],
                else: []
            };
        } else {
            newBlock = { type: type };
        }
        
        // Apply defaults immediately to fix "Empty JSON" bug
        if (type !== 'init_variable') {
            normalizeLogicData([newBlock]);
        }
        
        // Apply Board-Specific Overrides
        const boardType = currentLogicSensor && currentLogicSensor.board_type ? currentLogicSensor.board_type : 'ESP32-WROOM-32';
        const boardConfig = getBoardConfig(boardType);
        
        if (type === 'read_battery' && boardConfig.capabilities && boardConfig.capabilities.battery) {
            // Auto-set the battery pin if defined in capabilities
            if (boardConfig.capabilities.battery.length > 0) {
                newBlock.pin = boardConfig.capabilities.battery[0];
            }
        }
        
        const targetArray = getCurrentLogicArray();
        targetArray.push(newBlock);
        
        renderLogicCanvas();
        syncVisualToJson();
        
        // Auto-scroll to bottom to show new block
        setTimeout(() => {
            const canvas = document.getElementById('logicCanvas');
            if (canvas) {
                canvas.scrollTop = canvas.scrollHeight;
            }
        }, 50);
    } catch (e) {
        console.error("Error adding block:", e);
        showAlert("Failed to add block: " + e.message, "danger");
    }
}

function syncJsonToVisual() {
    try {
        const json = document.getElementById('logicJsonEditor').value;
        if (json.trim()) {
            const parsed = JSON.parse(json);
            // Preserve metadata if present, or just update actions
            if (parsed.actions) {
                currentLogicData = parsed;
            } else if (Array.isArray(parsed)) {
                currentLogicData.actions = parsed;
            } else {
                // Assume it's the full object
                currentLogicData = parsed;
            }
            
            if (!currentLogicData.actions) currentLogicData.actions = [];
            
            // Normalize to ensure defaults are present
            normalizeLogicData(currentLogicData.actions);
            
            // Reset view to root when syncing from JSON
            resetLogicView();
        }
    } catch (e) {
        console.error("Sync error:", e);
        showAlert("Invalid JSON format", "warning");
    }
}

function syncVisualToJson() {
    try {
        const json = JSON.stringify(currentLogicData, null, 2);
        document.getElementById('logicJsonEditor').value = json;
    } catch (e) {
        console.error("Error syncing visual to JSON:", e);
    }
}

function formatJson() {
    try {
        const json = document.getElementById('logicJsonEditor').value;
        const parsed = JSON.parse(json);
        document.getElementById('logicJsonEditor').value = JSON.stringify(parsed, null, 2);
    } catch (e) {
        showAlert("Invalid JSON", "warning");
    }
}

function renderLogicStructure() {
    const container = document.getElementById('logicStructureView');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!currentLogicData.actions || currentLogicData.actions.length === 0) {
        container.innerHTML = '<div class="text-muted text-center p-4">No logic blocks defined.</div>';
        return;
    }
    
    const treeRoot = document.createElement('div');
    treeRoot.className = 'logic-tree';
    
    currentLogicData.actions.forEach(action => {
        treeRoot.appendChild(renderStructureNode(action));
    });
    
    container.appendChild(treeRoot);
}

function renderStructureNode(action) {
    const node = document.createElement('div');
    node.className = 'logic-tree-node mb-1';
    node.style.borderLeft = '2px solid #dee2e6';
    node.style.paddingLeft = '10px';
    
    // Header
    const header = document.createElement('div');
    header.className = 'd-flex align-items-center';
    
    // Icon & Title
    let icon = 'fa-cube';
    let color = 'text-secondary';
    let details = '';
    
    switch(action.type) {
        case 'if':
            icon = 'fa-code-branch';
            color = 'text-warning';
            const cond = action.condition || {};
            details = `<span class="badge bg-light text-dark border ms-2">IF ${cond.left || '?'} ${cond.operator || '=='} ${cond.right || '?'}</span>`;
            break;
        case 'loop':
            icon = 'fa-sync';
            color = 'text-info';
            details = `<span class="badge bg-light text-dark border ms-2">Repeat ${action.count || 1} times</span>`;
            break;
        case 'while':
            icon = 'fa-redo';
            color = 'text-info';
            const wCond = action.condition || {};
            details = `<span class="badge bg-light text-dark border ms-2">WHILE ${wCond.left || '?'} ${wCond.operator || '=='} ${wCond.right || '?'}</span>`;
            break;
        case 'wait':
            icon = 'fa-clock';
            color = 'text-secondary';
            details = `<span class="text-muted ms-2">${action.value || 0} ms</span>`;
            break;
        case 'gpio_write':
            icon = 'fa-bolt';
            color = 'text-success';
            details = `<span class="text-muted ms-2">Pin ${action.pin} &rarr; ${action.value}</span>`;
            break;
        case 'variable_op':
            icon = 'fa-calculator';
            color = 'text-primary';
            details = `<span class="text-muted ms-2">${action.name} ${action.operation} ${action.value}</span>`;
            break;
        default:
            details = `<span class="text-muted ms-2 small">${action.type}</span>`;
    }
    
    header.innerHTML = `<i class="fas ${icon} ${color} me-2"></i><strong>${action.type.toUpperCase()}</strong>${details}`;
    node.appendChild(header);
    
    // Children (Recursive)
    if (action.type === 'if') {
        // THEN Branch
        if (action.then && action.then.length > 0) {
            const thenContainer = document.createElement('div');
            thenContainer.className = 'ms-3 mt-1';
            thenContainer.innerHTML = '<div class="small text-success fw-bold"><i class="fas fa-check me-1"></i>THEN</div>';
            action.then.forEach(child => thenContainer.appendChild(renderStructureNode(child)));
            node.appendChild(thenContainer);
        }
        
        // ELSE Branch
        if (action.else && action.else.length > 0) {
            const elseContainer = document.createElement('div');
            elseContainer.className = 'ms-3 mt-1';
            elseContainer.innerHTML = '<div class="small text-danger fw-bold"><i class="fas fa-times me-1"></i>ELSE</div>';
            action.else.forEach(child => elseContainer.appendChild(renderStructureNode(child)));
            node.appendChild(elseContainer);
        }
    } else if ((action.type === 'loop' || action.type === 'while') && action.do && action.do.length > 0) {
        const doContainer = document.createElement('div');
        doContainer.className = 'ms-3 mt-1';
        doContainer.innerHTML = '<div class="small text-info fw-bold"><i class="fas fa-level-down-alt me-1"></i>DO</div>';
        action.do.forEach(child => doContainer.appendChild(renderStructureNode(child)));
        node.appendChild(doContainer);
    }
    
    return node;
}

function renderLogicCanvas() {
    try {
        const container = document.getElementById('logicCanvas');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Add Datalist for Variables
        let datalistHtml = '<datalist id="logicVariables">';
        let uniqueVars = []; // Define uniqueVars in function scope
        
        // 1. Add System Variables
        if (SYSTEM_VARIABLES) {
            SYSTEM_VARIABLES.forEach(v => {
                datalistHtml += `<option value="${v}">${v} (System)</option>`;
            });
        }
        
        // 2. Add Sensor Capabilities (Hardware Pins/Sensors)
        if (currentSensorCapabilities) {
            if (currentSensorCapabilities.pins) {
                currentSensorCapabilities.pins.forEach(p => {
                    if (p.name) datalistHtml += `<option value="${p.name}">${p.name} (Pin ${p.pin})</option>`;
                    datalistHtml += `<option value="gpio.${p.pin}">Pin ${p.pin}</option>`;
                });
            }
            if (currentSensorCapabilities.sensors) {
                currentSensorCapabilities.sensors.forEach(s => {
                    if (s.name) datalistHtml += `<option value="${s.name}">${s.name} (Sensor)</option>`;
                });
            }
        }
        
        // 3. Add User-Defined Aliases from Logic
        if (currentLogicData && currentLogicData.actions) {
            const userAliases = collectUserAliases(currentLogicData.actions);
            // Deduplicate
            const uniqueAliases = [...new Set(userAliases.map(a => a.name))];
            uniqueAliases.forEach(alias => {
                datalistHtml += `<option value="${alias}">${alias} (Alias)</option>`;
            });
            
            // Add User-Defined Variables
            const userVars = collectUserVariables(currentLogicData.actions);
            uniqueVars = [...new Set(userVars)];
            uniqueVars.forEach(v => {
                datalistHtml += `<option value="${v}">${v} (Variable)</option>`;
            });
        }
        
        datalistHtml += '</datalist>';
        container.insertAdjacentHTML('beforeend', datalistHtml);
        
        // Render Breadcrumbs
        let breadcrumbHtml = '<nav aria-label="breadcrumb"><ol class="breadcrumb mb-2">';
        breadcrumbHtml += `<li class="breadcrumb-item ${logicViewStack.length === 0 ? 'active' : ''}"><a href="#" onclick="resetLogicView(); return false;">Main</a></li>`;
        
        logicViewStack.forEach((view, index) => {
            const isActive = index === logicViewStack.length - 1;
            if (isActive) {
                breadcrumbHtml += `<li class="breadcrumb-item active">${view.name}</li>`;
            } else {
                // We can't easily jump to middle of stack without complex logic, so just show name
                // Or implement a jumpToView(index) function
                breadcrumbHtml += `<li class="breadcrumb-item text-muted">${view.name}</li>`;
            }
        });
        breadcrumbHtml += '</ol></nav>';
        
        if (logicViewStack.length > 0) {
            breadcrumbHtml += `<div class="mb-2"><button class="btn btn-sm btn-outline-secondary" onclick="popLogicView()"><i class="fas fa-arrow-left"></i> Back</button></div>`;
        }
        
        container.insertAdjacentHTML('beforeend', breadcrumbHtml);
        
        const currentArray = getCurrentLogicArray();
        
        // Calculate global aliases to lock inputs
        // We need to scan the ENTIRE logic tree, not just the current view
        const globalAliases = getGlobalPinAliases(currentLogicData.actions || []);

        if (!currentArray || currentArray.length === 0) {
            container.insertAdjacentHTML('beforeend', '<div class="text-center text-muted py-5">Drag blocks from the toolbox or click to add</div>');
            return;
        }
        
        currentArray.forEach((block, index) => {
            const card = document.createElement('div');
            card.className = 'card mb-2';
            
            let headerColor = 'bg-light';
            let icon = 'fa-cube';
            
            if (block.type.includes('write')) headerColor = 'bg-primary bg-opacity-10';
            if (block.type.includes('read')) headerColor = 'bg-info bg-opacity-10';
            if (block.type === 'if') { headerColor = 'bg-warning bg-opacity-10'; icon = 'fa-code-branch'; }
            if (block.type === 'delay') { headerColor = 'bg-secondary bg-opacity-10'; icon = 'fa-clock'; }
            if (block.type === 'hibernate') { headerColor = 'bg-dark bg-opacity-10'; icon = 'fa-bed'; }
            
            let contentHtml = '';
            
            // Special handling for IF block
            if (block.type === 'if') {
                // Render Condition inputs
                const cond = block.condition || { left: '', operator: '==', right: '' };
                
                contentHtml += `
                    <div class="col-12 mb-2">
                        <label class="form-label small fw-bold">Condition</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" placeholder="Left (e.g. temp)" value="${cond.left || ''}" 
                                   list="logicVariables"
                                   onchange="updateIfCondition(${index}, 'left', this.value)">
                            <select class="form-select" style="max-width: 80px;" 
                                    onchange="updateIfCondition(${index}, 'operator', this.value)">
                                <option value="==" ${cond.operator === '==' ? 'selected' : ''}>==</option>
                                <option value="!=" ${cond.operator === '!=' ? 'selected' : ''}>!=</option>
                                <option value=">" ${cond.operator === '>' ? 'selected' : ''}>&gt;</option>
                                <option value="<" ${cond.operator === '<' ? 'selected' : ''}>&lt;</option>
                                <option value=">=" ${cond.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                <option value="<=" ${cond.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                            </select>
                            <input type="text" class="form-control" placeholder="Right (e.g. 25)" value="${cond.right || ''}" 
                                   list="logicVariables"
                                   onchange="updateIfCondition(${index}, 'right', this.value)">
                        </div>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-sm btn-outline-success w-100" onclick="editBranch(${index}, 'then')">
                            <i class="fas fa-check"></i> Edit THEN (${block.then ? block.then.length : 0})
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="editBranch(${index}, 'else')">
                            <i class="fas fa-times"></i> Edit ELSE (${block.else ? block.else.length : 0})
                        </button>
                    </div>
                `;
            } else if (block.type === 'variable_op') {
                 contentHtml += `
                    <div class="col-md-4 mb-2">
                        <label class="form-label small mb-0 fw-bold text-primary">Variable Name</label>
                        <input type="text" class="form-control form-control-sm" 
                               value="${block.name}" placeholder="e.g. counter"
                               list="logicVariables"
                               onchange="updateBlockProperty(${index}, 'name', this.value, 'text', false)">
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label small mb-0">Operation</label>
                        <select class="form-select form-select-sm" 
                                onchange="updateBlockProperty(${index}, 'operation', this.value, 'text', false)">
                            <option value="=" ${block.operation === '=' ? 'selected' : ''}>= (Set)</option>
                            <option value="+=" ${block.operation === '+=' ? 'selected' : ''}>+= (Add)</option>
                            <option value="-=" ${block.operation === '-=' ? 'selected' : ''}>-= (Sub)</option>
                            <option value="*=" ${block.operation === '*=' ? 'selected' : ''}>*= (Mult)</option>
                            <option value="/=" ${block.operation === '/=' ? 'selected' : ''}>/= (Div)</option>
                        </select>
                    </div>
                    <div class="col-md-5 mb-2">
                        <label class="form-label small mb-0">Value / Operand</label>
                        <input type="text" class="form-control form-control-sm" 
                               value="${block.value}" placeholder="Number or Variable"
                               list="logicVariables"
                               onchange="updateBlockProperty(${index}, 'value', this.value, 'text', false)">
                    </div>
                 `;
            } else if (block.type === 'configure_pin') {
                 contentHtml += `
                    <div class="col-md-3 mb-2">
                        <label class="form-label small mb-0 fw-bold">Pin</label>
                        <input type="number" class="form-control form-control-sm" 
                               value="${block.pin || ''}" placeholder="Pin #"
                               onchange="updateBlockProperty(${index}, 'pin', this.value, 'number', false)">
                    </div>
                    <div class="col-md-5 mb-2">
                        <label class="form-label small mb-0">Alias / Name</label>
                        <input type="text" class="form-control form-control-sm" 
                               value="${block.alias || ''}" placeholder="e.g. Heater"
                               onchange="updateBlockProperty(${index}, 'alias', this.value, 'text', false)">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label small mb-0">Device Type</label>
                        <select class="form-select form-select-sm" 
                                onchange="updateBlockProperty(${index}, 'device_type', this.value, 'text', false)">
                            <option value="">-- Select --</option>
                            <option value="relay" ${block.device_type === 'relay' ? 'selected' : ''}>Relay</option>
                            <option value="temp_sensor" ${block.device_type === 'temp_sensor' ? 'selected' : ''}>Temp Sensor</option>
                            <option value="led" ${block.device_type === 'led' ? 'selected' : ''}>LED</option>
                            <option value="button" ${block.device_type === 'button' ? 'selected' : ''}>Button</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <div class="form-text x-small text-muted"><i class="fas fa-info-circle"></i> Configures this pin for use with specific tools.</div>
                    </div>
                 `;
            } else if (block.type === 'adc_read') {
                 // Dedicated UI so ADC blocks never render as blank
                 // (and so we can show the context-aware Device Type selector)
                 contentHtml += `
                    <div class="col-md-4 mb-2">
                        <label class="form-label small mb-0 fw-bold">Pin</label>
                        <input type="number" class="form-control form-control-sm" 
                               value="${block.pin ?? ''}" placeholder="ADC Pin #"
                               onchange="updateBlockProperty(${index}, 'pin', this.value, 'number', false)">
                        <div class="form-text x-small text-muted">Use an ADC-capable pin for this board.</div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label small mb-0">Alias / Name</label>
                        <input type="text" class="form-control form-control-sm" 
                               value="${block.alias || ''}" placeholder="e.g. soil_moisture"
                               onchange="updateBlockProperty(${index}, 'alias', this.value, 'text', false)">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label small mb-0">Device Type</label>
                        <select class="form-select form-select-sm" 
                                onchange="updateBlockProperty(${index}, 'device_type', this.value, 'text', false)">
                            <option value="">-- None --</option>
                            <option value="temp_sensor" ${block.device_type === 'temp_sensor' ? 'selected' : ''}>Temp Sensor</option>
                            <option value="button" ${block.device_type === 'button' ? 'selected' : ''}>Button</option>
                        </select>
                    </div>
                 `;
            } else {
                // Standard rendering for other blocks
                Object.keys(block).forEach(key => {
                    if (key === 'type') return;
                    if (key === 'then' || key === 'else') return; 
                    if (key === 'condition') return; // Handled above if type is 'if'
                    
                    const val = block[key];
                    
                    // Special handling for 'alias' to include Device Type
                    if (key === 'alias') {
                        // Hide Alias/Device Type for blocks where it is implied/redundant
                        if (block.type === 'read_temperature' || block.type === 'set_relay') {
                            return;
                        }

                        // Determine context for device type options
                        let deviceOptions = '<option value="">-- None --</option>';
                        const isWrite = ['gpio_write', 'pwm_write', 'analog_write', 'set_relay'].includes(block.type);
                        const isRead = ['gpio_read', 'analog_read', 'adc_read', 'read_temperature', 'read_battery', 'dht_read', 'ds18b20_read'].includes(block.type);
                        
                        if (isWrite) {
                             deviceOptions += `
                                <option value="relay" ${block.device_type === 'relay' ? 'selected' : ''}>Relay</option>
                                <option value="led" ${block.device_type === 'led' ? 'selected' : ''}>LED</option>
                             `;
                        } else if (isRead) {
                             deviceOptions += `
                                <option value="temp_sensor" ${block.device_type === 'temp_sensor' ? 'selected' : ''}>Temp Sensor</option>
                                <option value="button" ${block.device_type === 'button' ? 'selected' : ''}>Button</option>
                             `;
                        } else {
                             // Fallback for unknown types
                             deviceOptions += `
                                <option value="relay" ${block.device_type === 'relay' ? 'selected' : ''}>Relay</option>
                                <option value="temp_sensor" ${block.device_type === 'temp_sensor' ? 'selected' : ''}>Temp Sensor</option>
                                <option value="led" ${block.device_type === 'led' ? 'selected' : ''}>LED</option>
                                <option value="button" ${block.device_type === 'button' ? 'selected' : ''}>Button</option>
                             `;
                        }

                        contentHtml += `
                            <div class="col-md-6 mb-2">
                                <label class="form-label small mb-0">Alias / Name</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${val || ''}" placeholder="e.g. Heater"
                                       onchange="updateBlockProperty(${index}, 'alias', this.value, 'text', false)">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small mb-0">Device Type</label>
                                <select class="form-select form-select-sm" 
                                        onchange="updateBlockProperty(${index}, 'device_type', this.value, 'text', false)">
                                    ${deviceOptions}
                                </select>
                            </div>
                        `;
                        return;
                    }
                    
                    // Special handling for 'device_type' - handled with alias, so skip here
                    if (key === 'device_type') return;
                    
                    // Special handling for 'unit' in hibernate block
                    if (key === 'unit' && block.type === 'hibernate') {
                         contentHtml += `
                            <div class="col-md-4 mb-2">
                                <label class="form-label small mb-0">Unit</label>
                                <select class="form-select form-select-sm" 
                                        onchange="updateBlockProperty(${index}, '${key}', this.value, 'text', false)">
                                    <option value="seconds" ${val === 'seconds' ? 'selected' : ''}>Seconds</option>
                                    <option value="minutes" ${val === 'minutes' ? 'selected' : ''}>Minutes</option>
                                    <option value="hours" ${val === 'hours' ? 'selected' : ''}>Hours</option>
                                </select>
                            </div>
                         `;
                         return;
                    }

                    // Special handling for 'value' in gpio_write block
                    if (key === 'value' && block.type === 'gpio_write') {
                         contentHtml += `
                            <div class="col-md-4 mb-2">
                                <label class="form-label small mb-0">Value</label>
                                <select class="form-select form-select-sm" 
                                        onchange="updateBlockProperty(${index}, '${key}', this.value, 'text', false)">
                                    <option value="HIGH" ${val === 'HIGH' ? 'selected' : ''}>HIGH</option>
                                    <option value="LOW" ${val === 'LOW' ? 'selected' : ''}>LOW</option>
                                </select>
                            </div>
                         `;
                         return;
                    }
                    
                    // Special handling for 'message' in log block
                    if (key === 'message' && block.type === 'log') {
                        // Get board-specific variable suggestions
                        const boardType = currentLogicSensor && currentLogicSensor.board_type ? currentLogicSensor.board_type : 'unknown';
                        let placeholderText = 'Log message (use {variable} syntax)';
                        let varOptions = ''; // Initialize varOptions
                        
                        if (uniqueVars.length > 0) {
                            varOptions += '<li><h6 class="dropdown-header">Variables</h6></li>';
                            uniqueVars.forEach(v => {
                                varOptions += `<li><a class="dropdown-item small" href="#" onclick="insertAtCursor('log-message-${index}', '{${v}}'); return false;">{${v}}</a></li>`;
                            });
                        }
                        
                        // System
                        varOptions += '<li><h6 class="dropdown-header">System</h6></li>';
                        const systemVars = SYSTEM_VARIABLES || []; // Ensure systemVars is defined
                        systemVars.forEach(v => {
                            varOptions += `<li><a class="dropdown-item small" href="#" onclick="insertAtCursor('log-message-${index}', '{${v}}'); return false;">{${v}}</a></li>`;
                        });
                        
                        const helpText = '<div class="form-text x-small">Use {variable} to insert values.</div>';
                        
                        contentHtml += `
                            <div class="col-12 mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label class="form-label small mb-0 fw-bold text-success"><i class="fas fa-comment-alt"></i> ${key}</label>
                                    <div class="dropdown">
                                        <button class="btn btn-xs btn-outline-secondary dropdown-toggle py-0" type="button" data-bs-toggle="dropdown">
                                            Insert Variable
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" style="max-height: 200px; overflow-y: auto;">
                                            ${varOptions}
                                        </ul>
                                    </div>
                                </div>
                                <textarea id="log-message-${index}" class="form-control form-control-sm" rows="2" 
                                          placeholder="${placeholderText}"
                                          onchange="updateBlockProperty(${index}, '${key}', this.value, 'text', false)">${val}</textarea>
                                ${helpText}
                            </div>
                         `;
                         return;
                    }
                    
                    // Special handling for 'state' in set_relay block
                    if (key === 'state' && block.type === 'set_relay') {
                         contentHtml += `
                            <div class="col-md-4 mb-2">
                                <label class="form-label small mb-0">State</label>
                                <select class="form-select form-select-sm" 
                                        onchange="updateBlockProperty(${index}, '${key}', this.value, 'boolean', false)">
                                    <option value="true" ${val === true ? 'selected' : ''}>ON (High)</option>
                                    <option value="false" ${val === false ? 'selected' : ''}>OFF (Low)</option>
                                </select>
                            </div>
                         `;
                         return;
                    }

                    // Special handling for 'pin' to show guided dropdown
                    if (key === 'pin') {
                        try {
                            const boardType = currentLogicSensor && currentLogicSensor.board_type ? currentLogicSensor.board_type : 'ESP32-WROOM-32';
                            const boardConfig = getBoardConfig(boardType);
                            let validPins = [];
                            let capability = '';
                            
                            // Check for configured peripherals first
                            const configured = getConfiguredPeripherals(currentLogicData.actions);
                            let forcedPins = null;
                            
                            if (block.type === 'read_temperature' && configured.temp_sensor) {
                                forcedPins = configured.temp_sensor.map(b => ({ pin: parseInt(b.pin), name: b.alias || `Pin ${b.pin}` }));
                            }

                            // Determine required capability based on block type
                            if (block.type === 'gpio_read') capability = 'digital_input';
                            else if (block.type === 'gpio_write') capability = 'digital_output';
                            else if (block.type === 'adc_read') capability = 'analog_input';
                            else if (block.type === 'pwm_write') capability = 'pwm';
                            else if (block.type === 'read_temperature' || block.type === 'dht_read' || block.type === 'ds18b20_read') capability = 'digital_output';
                            else if (block.type === 'read_battery') capability = 'battery';
                            else if (block.type === 'set_relay') capability = 'digital_output';
                            else capability = 'digital_input'; // Default

                            // Filter pins
                            if (forcedPins) {
                                validPins = forcedPins;
                            } else if (boardConfig && boardConfig.pins) {
                                if (boardConfig.capabilities && boardConfig.capabilities[capability]) {
                                    const validPinNums = boardConfig.capabilities[capability];
                                    validPins = boardConfig.pins.filter(p => validPinNums.includes(p.pin));
                                } else {
                                    // Fallback if no capability map or capability not found
                                    // If capability is 'battery' and not found, it means board doesn't support it
                                    if (capability === 'battery') {
                                        validPins = [];
                                    } else {
                                        validPins = boardConfig.pins;
                                    }
                                }
                            } else {
                                console.warn('No pins defined for board:', boardType);
                                validPins = [];
                            }

                            // Special handling for Battery Read: Lock if only one option
                            let disabledAttr = '';
                            let extraHelp = '';
                            if (block.type === 'read_battery' && validPins.length === 1) {
                                // Force the value to the only valid pin if not set
                                if (val != validPins[0].pin) {
                                    console.log(`Auto-correcting pin from ${val} to ${validPins[0].pin}`);
                                    block.pin = validPins[0].pin;
                                    // Trigger sync to update JSON editor
                                    setTimeout(syncVisualToJson, 0);
                                }
                                disabledAttr = 'disabled';
                                extraHelp = '<div class="form-text x-small text-success"><i class="fas fa-lock"></i> Locked to board default</div>';
                            }

                            let optionsHtml = `<option value="">-- Select Pin --</option>`;
                            
                            // Add "Manual Entry" option just in case, but NOT for battery if locked
                            if (!disabledAttr) {
                                // Only show if val is defined and not in validPins
                                if (val !== undefined && val !== '' && !validPins.find(p => p.pin == val)) {
                                    optionsHtml += `<option value="${val}" selected>${val} (Custom)</option>`;
                                }
                            } else {
                                // If locked, ensure the correct value is selected visually even if 'val' is wrong initially
                                // (though addLogicBlock should handle it)
                            }

                            // Group options for Relays to make selection easier
                            // Check if we have any "real" configured relays (excluding the current block if it's new/empty)
                            const realRelays = (configured.relay || []).filter(r => r.pin !== '' && r.pin !== undefined && r !== block);

                            if (block.type === 'set_relay' && realRelays.length > 0) {
                                // Strict Mode: User has configured relays, so we limit selection to those
                                
                                // 1. Add Configured Relays
                                validPins.forEach(p => {
                                    const existing = configured.relay.find(r => r.pin == p.pin);
                                    if (existing) {
                                        const isSelected = (p.pin == val) ? 'selected' : '';
                                        let label = `Pin ${p.pin}`;
                                        if (existing.alias) label += ` (${existing.alias})`;
                                        else if (p.name) label += ` (${p.name})`;
                                        
                                        optionsHtml += `<option value="${p.pin}" ${isSelected}>${label}</option>`;
                                    }
                                });

                                // 2. Ensure the CURRENT pin is shown even if not configured (so we don't break the UI for new/unconfigured blocks)
                                if (val !== undefined && val !== '' && !configured.relay.find(r => r.pin == val)) {
                                    const p = validPins.find(vp => vp.pin == val);
                                    if (p) {
                                        let label = `Pin ${p.pin}`;
                                        if (p.name) label += ` (${p.name})`;
                                        optionsHtml += `<option value="${p.pin}" selected>${label} (Unconfigured)</option>`;
                                    } else {
                                        optionsHtml += `<option value="${val}" selected>${val} (Custom)</option>`;
                                    }
                                }
                                
                            } else {
                                // Standard flat list for other blocks
                                validPins.forEach(p => {
                                    const isSelected = (p.pin == val || (validPins.length === 1 && block.type === 'read_battery')) ? 'selected' : '';
                                    let label = `Pin ${p.pin}`;
                                    
                                    if (p.name) label += ` (${p.name})`;
                                    
                                    // Add icons/badges for special pins
                                    if (p.battery) label += '  Battery';
                                    if (p.led) label += '  LED';
                                    
                                    optionsHtml += `<option value="${p.pin}" ${isSelected}>${label}</option>`;
                                });
                            }

                            contentHtml += `
                                <div class="col-md-4 mb-2">
                                    <label class="form-label small mb-0 fw-bold text-primary">Pin Selection</label>
                                    <select class="form-select form-select-sm" 
                                            ${disabledAttr}
                                            onchange="updateBlockProperty(${index}, '${key}', this.value, 'number', false)">
                                        ${optionsHtml}
                                    </select>
                                    ${extraHelp}
                                    <div class="form-text x-small text-muted">
                                        Board: ${boardConfig ? boardConfig.name : boardType}
                                    </div>
                                </div>
                            `;
                            return;
                        } catch (err) {
                            console.error('Error rendering pin dropdown:', err);
                            // Fallback to standard input if dropdown fails
                        }
                    }

                    let inputType = 'text';
                    if (typeof val === 'number') inputType = 'number';
                    if (typeof val === 'boolean') inputType = 'checkbox';
                    
                    const checkedAttr = (inputType === 'checkbox' && val) ? 'checked' : '';
                    const valueAttr = inputType !== 'checkbox' ? `value="${val}"` : '';
                    
                    // Highlight Alias field
                    let labelClass = 'small mb-0';
                    let disabledAttr = '';
                    let displayValue = val;
                    let extraHelp = '';

                    if (key === 'alias') {
                        labelClass = 'small mb-0 fw-bold text-primary';
                        
                        // Check if this pin is already aliased elsewhere
                        // If block.pin exists and is in globalAliases, and the alias there is NOT this one (or even if it is this one, we might want to lock it if it's defined 'upstream'?)
                        // Actually, simpler rule: If globalAliases[block.pin] exists, use THAT value and disable input.
                        // BUT, we need to allow defining it the FIRST time.
                        // The getGlobalPinAliases function returns the FIRST definition.
                        // So if globalAliases[block.pin] == block.alias, then THIS is the definition (or a copy of it).
                        // If globalAliases[block.pin] != block.alias (and globalAliases[block.pin] is set), then this block is using a pin that was aliased elsewhere.
                        
                        // Wait, if I am the one defining it, I should be able to edit it?
                        // The requirement is: "If I use a Pin that already has an Alias, I should not be able to add one to it, it should be locked"
                        // This implies if I add a NEW block for Pin 2, and Pin 2 is already aliased to "LED", this new block should auto-fill "LED" and lock it.
                        
                        // Refined Logic:
                        // If globalAliases[block.pin] exists:
                        //    If block.alias is empty or different, show the global alias and DISABLE input.
                        //    If block.alias is SAME as global alias, ENABLE input (this is likely the definition).
                        
                        if (block.pin !== undefined && globalAliases[block.pin]) {
                            const existingAlias = globalAliases[block.pin];
                            // If the current block's alias doesn't match the global one, we should probably force it to match visually?
                            // Or just lock it if it's already set.
                            
                            // If this block IS the one defining it (i.e. it matches), we might still want to lock it if we want to enforce "define once"?
                            // But usually you want to be able to edit the definition.
                            // Let's assume: If the block's alias matches the global one, it MIGHT be the definition.
                            // But how do we know if it's the *first* one?
                            // We can't easily know order without complex logic.
                            
                            // Let's try this: If the alias is already set in the global map, show that alias.
                            // If the current block's alias is EMPTY, auto-fill it? No, that changes data.
                            // Just disable it if it's not the definition?
                            
                            // Refined Logic:
                            // If globalAliases[block.pin] exists:
                            //    If block.alias is empty or different, show the global alias and DISABLE input.
                            //    If block.alias is SAME as global alias, ENABLE input (this is likely the definition).
                            
                            if (existingAlias && existingAlias !== block.alias) {
                                // It's defined elsewhere. Lock this one.
                                disabledAttr = 'disabled';
                                displayValue = existingAlias + ' (Locked)';
                                extraHelp = '<div class="form-text x-small text-muted">Inherited from Pin ' + block.pin + '</div>';
                            } else if (existingAlias && existingAlias === block.alias) {
                                // This matches the global definition. It is likely the definition source.
                                // Allow editing.
                                extraHelp = '<div class="form-text x-small text-success">Defining Alias for Pin ' + block.pin + '</div>';
                            }
                        }
                    }
                    
                    // If we are modifying displayValue for locked alias, we need to handle it carefully
                    // because the input value attribute is what's submitted/saved? 
                    // No, onchange updates the JSON. If it's disabled, onchange won't fire.
                    // So we just show the value.
                    
                    const finalValueAttr = inputType !== 'checkbox' ? `value="${displayValue}"` : '';

                    contentHtml += `
                        <div class="col-md-4 mb-2">
                            <label class="form-label ${labelClass}">${key}</label>
                            <input type="${inputType}" class="form-control form-control-sm" 
                                   ${finalValueAttr} ${checkedAttr} ${disabledAttr}
                                   onchange="updateBlockProperty(${index}, '${key}', this.value, '${inputType}', this.checked)">
                            ${extraHelp}
                        </div>
                    `;
                });
            }
            
            card.innerHTML = `
                <div class="card-header py-1 px-2 ${headerColor} d-flex justify-content-between align-items-center">
                    <small class="fw-bold"><i class="fas ${icon}"></i> ${block.type}</small>
                    <div>
                        <button class="btn btn-xs btn-link text-muted" onclick="moveBlock(${index}, -1)"><i class="fas fa-arrow-up"></i></button>
                        <button class="btn btn-xs btn-link text-muted" onclick="moveBlock(${index}, 1)"><i class="fas fa-arrow-down"></i></button>
                        <button class="btn btn-xs btn-link text-danger" onclick="removeBlock(${index})"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="row g-2">
                        ${contentHtml}
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });

        // Update the variables list sidebar whenever the canvas is re-rendered
        renderVariablesList();
    } catch (e) {
        console.error("Error rendering canvas:", e);
        const container = document.getElementById('logicCanvas');
        if (container) container.innerHTML = '<div class="alert alert-danger">Error rendering blocks</div>';
    }
}

function editBranch(index, branchName) {
    const currentArray = getCurrentLogicArray();
    const block = currentArray[index];
    
    if (!block[branchName]) block[branchName] = [];
    
    pushLogicView(block[branchName], `IF #${index + 1} ${branchName.toUpperCase()}`);
}

function updateIfCondition(index, field, value) {
    const currentArray = getCurrentLogicArray();
    const block = currentArray[index];
    
    if (!block.condition) block.condition = { left: '', operator: '==', right: '' };
    block.condition[field] = value;
    
    syncVisualToJson();
}

function updateBlockProperty(index, key, value, type, checked) {
    try {
        if (type === 'number') value = parseFloat(value);
        if (type === 'checkbox') value = checked;
        
        const currentArray = getCurrentLogicArray();
        if (currentArray && currentArray[index]) {
            currentArray[index][key] = value;
            syncVisualToJson();
            
            // Re-render if pin, alias, or device_type changes
            if (key === 'pin' || key === 'alias' || key === 'device_type') {
                // Small delay to allow UI to settle if needed, but immediate is usually better for sync
                // However, re-rendering kills focus. 
                // If key is 'alias', we are typing in the alias field. Re-rendering on every char is bad.
                // But onchange only fires on blur/enter. So focus is already lost/moving.
                renderLogicCanvas();
                
                // Also re-render toolbox if device_type changes, to show/hide dependent tools
                if (key === 'device_type') {
                    renderToolbox();
                }
            }
        }
    } catch (e) {
        console.error("Error updating block property:", e);
    }
}

function removeBlock(index) {
    try {
        const currentArray = getCurrentLogicArray();
        if (currentArray) {
            currentArray.splice(index, 1);
            renderLogicCanvas();
            syncVisualToJson();
        }
    } catch (e) {
        console.error("Error removing block:", e);
    }
}

function moveBlock(index, direction) {
    try {
        const currentArray = getCurrentLogicArray();
        if (!currentArray) return;
        
        if (index + direction < 0 || index + direction >= currentArray.length) return;
        
        const temp = currentArray[index];
        currentArray[index] = currentArray[index + direction];
        currentArray[index + direction] = temp;
        
        renderLogicCanvas();
        syncVisualToJson();
    } catch (e) {
        console.error("Error moving block:", e);
    }
}

async function saveLogicBuilder() {
    try {
        // Validate Logic
        const errors = validateLogic(currentLogicData.actions);
        if (errors.length > 0) {
            const errorHtml = `
                <strong>Please fix the following errors:</strong>
                <ul class="mb-0 ps-3 mt-1">
                    ${errors.map(e => `<li>${e}</li>`).join('')}
                </ul>
            `;
            showAlert(errorHtml, "danger");
            return;
        }

        // Update metadata from inputs
        currentLogicData.name = document.getElementById('logicName').value;
        currentLogicData.version = document.getElementById('logicVersion').value;
        currentLogicData.description = document.getElementById('logicDescription').value;
        
        // Open Upload Modal with pre-filled data
        document.getElementById('scriptName').value = currentLogicData.name;
        document.getElementById('scriptVersion').value = currentLogicData.version;
        document.getElementById('scriptDescription').value = currentLogicData.description;
        document.getElementById('scriptType').value = 'json';
        document.getElementById('scriptContent').value = JSON.stringify(currentLogicData, null, 2);
        
        // Hide logic builder, show upload modal
        const logicModal = bootstrap.Modal.getInstance(document.getElementById('logicBuilderModal'));
        if (logicModal) logicModal.hide();
        
        const modalEl = document.getElementById('uploadScriptModal');
        let modal = bootstrap.Modal.getInstance(modalEl);
        if (!modal) {
            modal = new bootstrap.Modal(modalEl);
        }
        modal.show();
    } catch (e) {
        console.error("Error saving logic:", e);
        showAlert("Failed to prepare save: " + e.message, "danger");
    }
}

// ============================================================================
// BULK UPLOAD FUNCTIONS
// ============================================================================

function showUploadToManyModal() {
    // Populate script dropdown
    const scriptSelect = document.getElementById('bulkScriptSelect');
    scriptSelect.innerHTML = '<option value="">-- Select a script --</option>';
    
    scripts.forEach(script => {
        const option = document.createElement('option');
        option.value = script.id;
        option.textContent = `${script.name} (v${script.script_version})`;
        option.dataset.targetType = script.target_sensor_type || '';
        option.dataset.description = script.description || '';
        scriptSelect.appendChild(option);
    });
    
    // Reset UI
    document.getElementById('bulkSensorList').innerHTML = '<div class="text-center text-muted py-3">Please select a script first</div>';
    document.getElementById('bulkScriptDetails').textContent = '';
    document.getElementById('selectAllSensors').checked = false;
    document.getElementById('selectAllSensors').disabled = true;
    document.getElementById('selectedCountBadge').textContent = '0 selected';
    document.getElementById('btnBulkUpload').disabled = true;
    document.getElementById('bulkUploadResult').style.display = 'none';
    document.getElementById('bulkUploadProgress').style.display = 'none';
    
    const modalEl = document.getElementById('uploadToManyModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

function filterBulkSensors() {
    const scriptSelect = document.getElementById('bulkScriptSelect');
    const sensorList = document.getElementById('bulkSensorList');
    const scriptId = scriptSelect.value;
    
    if (!scriptId) {
        sensorList.innerHTML = '<div class="text-center text-muted py-3">Please select a script first</div>';
        document.getElementById('bulkScriptDetails').textContent = '';
        document.getElementById('selectAllSensors').disabled = true;
        document.getElementById('btnBulkUpload').disabled = true;
        return;
    }
    
    const selectedOption = scriptSelect.options[scriptSelect.selectedIndex];
    const targetType = selectedOption.dataset.targetType;
    const description = selectedOption.dataset.description;
    
    // Show script details
    let details = description;
    if (targetType) {
        details += ` (Target: ${targetType})`;
    } else {
        details += ' (Compatible with all sensor types)';
    }
    document.getElementById('bulkScriptDetails').textContent = details;
    
    // Filter sensors
    const compatibleSensors = sensors.filter(s => !targetType || s.sensor_type === targetType);
    
    if (compatibleSensors.length === 0) {
        sensorList.innerHTML = '<div class="text-center text-warning py-3">No compatible sensors found</div>';
        document.getElementById('selectAllSensors').disabled = true;
        document.getElementById('btnBulkUpload').disabled = true;
        return;
    }
    
    // Render sensor list
    let html = '';
    compatibleSensors.forEach(sensor => {
        const isAssigned = sensor.assigned_script && sensor.assigned_script.id == scriptId;
        html += `
            <label class="list-group-item d-flex gap-3 align-items-center">
                <input class="form-check-input flex-shrink-0 bulk-sensor-checkbox" type="checkbox" 
                       value="${sensor.sensor_id}" style="font-size: 1.375em;"
                       onchange="updateSelectedCount()">
                <div class="d-flex gap-2 w-100 justify-content-between">
                    <div>
                        <h6 class="mb-0">${sensor.sensor_name || sensor.sensor_id}</h6>
                        <small class="text-muted">${sensor.sensor_type}</small>
                    </div>
                    <div class="text-end">
                        ${isAssigned ? '<span class="badge bg-success">Already Assigned</span>' : ''}
                        <small class="d-block text-muted">${sensor.status}</small>
                    </div>
                </div>
            </label>
        `;
    });
    
    sensorList.innerHTML = html;
    document.getElementById('selectAllSensors').disabled = false;
    updateSelectedCount();
}

function toggleSelectAllSensors() {
    const selectAll = document.getElementById('selectAllSensors').checked;
    const checkboxes = document.querySelectorAll('.bulk-sensor-checkbox');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll;
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.bulk-sensor-checkbox:checked');
    const count = checkboxes.length;
    
    document.getElementById('selectedCountBadge').textContent = `${count} selected`;
    document.getElementById('btnBulkUpload').disabled = count === 0;
}

async function submitBulkUpload() {
    const scriptId = document.getElementById('bulkScriptSelect').value;
    const checkboxes = document.querySelectorAll('.bulk-sensor-checkbox:checked');
    const sensorIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (!scriptId || sensorIds.length === 0) return;
    
    if (!confirm(`Are you sure you want to upload this script to ${sensorIds.length} sensors?`)) return;
    
    // UI Updates
    const btn = document.getElementById('btnBulkUpload');
    const progressDiv = document.getElementById('bulkUploadProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const resultDiv = document.getElementById('bulkUploadResult');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    progressDiv.style.display = 'flex';
    resultDiv.style.display = 'none';
    
    let successCount = 0;
    let failCount = 0;
    let errors = [];
    
    // Process sequentially to avoid overwhelming the server
    for (let i = 0; i < sensorIds.length; i++) {
        const sensorId = sensorIds[i];
        const percent = Math.round(((i) / sensorIds.length) * 100);
        progressBar.style.width = `${percent}%`;
        
        try {
            const response = await fetch('/api/sensor-master/assign-library-script', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    library_script_id: scriptId,
                    sensor_id: sensorId
                })
            });
            
            if (response.ok) {
                successCount++;
            } else {
                const data = await response.json();
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            console.error(`Error assigning to ${sensorId}:`, error);
            failCount++;
            errors.push(`${sensorId}: ${error.message}`);
        }
    }
    
    progressBar.style.width = '100%';
    
    // Show results
    let resultClass = 'alert-success';
    let resultIcon = 'fa-check-circle';
    let resultTitle = 'Success!';
    
    if (failCount > 0) {
        if (successCount === 0) {
            resultClass = 'alert-danger';
            resultIcon = 'fa-times-circle';
            resultTitle = 'Failed!';
        } else {
            resultClass = 'alert-warning';
            resultIcon = 'fa-exclamation-triangle';
            resultTitle = 'Partial Success';
        }
    }
    
    let resultHtml = `
        <i class="fas ${resultIcon}"></i>
        <strong>${resultTitle}</strong><br>
        Successfully assigned to ${successCount} sensors.
    `;
    
    if (failCount > 0) {
        resultHtml += `<br>Failed: ${failCount} sensors.`;
        if (errors.length > 0) {
            resultHtml += `<div class="mt-2 small text-muted" style="max-height: 100px; overflow-y: auto;">${errors.join('<br>')}</div>`;
        }
    }
    
    resultDiv.className = `alert ${resultClass}`;
    resultDiv.innerHTML = resultHtml;
    resultDiv.style.display = 'block';
    
    btn.innerHTML = '<i class="fas fa-upload"></i> Upload to Selected';
    
    // Refresh main list
    await loadSensors();
    
    // Close modal if fully successful after delay
    if (failCount === 0) {
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('uploadToManyModal')).hide();
        }, 2000);
    } else {
        btn.disabled = false;
    }
}

// Add Device Functions
function showAddDeviceModal() {
    document.getElementById('addDeviceForm').reset();
    document.getElementById('scanResults').innerHTML = `
        <div class="text-center text-muted py-4">
            <small>Click Scan to find devices on your network.</small>
        </div>
    `;
    
    const modalEl = document.getElementById('addDeviceModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

async function registerDevice() {
    const sensorId = document.getElementById('newSensorId').value;
    const name = document.getElementById('newSensorName').value;
    const type = document.getElementById('newSensorType').value;
    const ip = document.getElementById('newSensorIp').value;
    
    if (!sensorId) {
        showAlert('Sensor ID is required', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/sensor-master/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sensor_id: sensorId,
                sensor_name: name,
                sensor_type: type || 'unknown',
                ip_address: ip,
                registration_source: 'manual'
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to register device');
        
        showAlert('Device registered successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
        await loadSensors();
    } catch (error) {
        console.error('Error registering device:', error);
        showAlert('Failed to register device: ' + error.message, 'danger');
    }
}

async function scanForDevices() {
    const resultsContainer = document.getElementById('scanResults');
    resultsContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <p class="mb-0 text-muted">Scanning network...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/api/sensor-master/scan');
        const data = await response.json();
        
        if (data.status === 'success' && data.devices.length > 0) {
            let html = '<div class="list-group">';
            data.devices.forEach(device => {
                const props = device.properties || {};
                const sensorId = props.id || '';
                // Use name from TXT record if available, otherwise mDNS name
                const sensorName = props.name || device.name.replace('._http._tcp.local.', '').replace('.local.', '');
                const isRegistered = device.is_registered;
                
                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center ${isRegistered ? 'bg-light' : ''}">
                        <div>
                            <h6 class="mb-1">
                                ${sensorName}
                                ${isRegistered ? '<span class="badge bg-success ms-2" style="font-size: 0.7em;">Registered</span>' : ''}
                            </h6>
                            <small class="text-muted">${device.ip} (${device.type})</small>
                            ${sensorId ? `<br><small class="text-info">ID: ${sensorId}</small>` : ''}
                        </div>
                        ${isRegistered ? 
                            `<button class="btn btn-sm btn-outline-secondary" disabled>Added</button>` : 
                            `<button class="btn btn-sm btn-primary" 
                                onclick="prefillRegistration('${device.ip}', '${device.type}', '${sensorName}', '${sensorId}')">
                                Select
                            </button>`
                        }
                    </div>
                `;
            });
            html += '</div>';
            resultsContainer.innerHTML = html;
        } else {
            resultsContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-wifi fa-2x mb-2"></i>
                    <p>No new devices found.</p>
                    <small>Make sure your device is powered on and connected to the same network.</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('Scan error:', error);
        resultsContainer.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-circle mb-2"></i>
                <p>Scan failed: ${error.message}</p>
            </div>
        `;
    }
}

window.prefillRegistration = function(ip, type, name, id) {
    document.getElementById('newSensorIp').value = ip;
    document.getElementById('newSensorType').value = type;
    document.getElementById('newSensorName').value = name;
    
    const idField = document.getElementById('newSensorId');
    if (id) {
        idField.value = id;
        // Flash the field to indicate update
        idField.classList.add('bg-success', 'text-white');
        setTimeout(() => idField.classList.remove('bg-success', 'text-white'), 500);
    } else {
        // If no ID provided, maybe use name if it looks like an ID?
        // Or force manual entry
        if (!document.getElementById('manualEntryToggle').checked) {
            document.getElementById('manualEntryToggle').click();
        }
        idField.value = '';
        idField.focus();
        showAlert('Device did not report an ID. Please enter manually.', 'warning');
    }
};

window.toggleManualEntry = function() {
    const isManual = document.getElementById('manualEntryToggle').checked;
    const idField = document.getElementById('newSensorId');
    
    if (isManual) {
        idField.readOnly = false;
        idField.classList.remove('bg-light');
        idField.placeholder = "e.g. esp32_fermentation_002";
        idField.focus();
    } else {
        idField.readOnly = true;
        idField.classList.add('bg-light');
        idField.placeholder = "Select from scan...";
    }
};

// Expose functions to window to ensure they are accessible
window.showAddDeviceModal = showAddDeviceModal;
window.registerDevice = registerDevice;
window.scanForDevices = scanForDevices;
</script>
</body>
</html>