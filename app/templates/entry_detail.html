<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - {{ entry.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Dynamic Theme CSS -->
    <style id="theme-styles">
        {{ theme_css|safe }}
    </style>
    
    <!-- Clean Base Styles -->
    <style>
        :root {
            --content-spacing: 1rem;
            --border-radius: 0.5rem;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
            --transition-base: all 0.2s ease;
        }

        body {
            background-color: var(--theme-bg-body, var(--bs-body-bg));
            color: var(--theme-text, var(--bs-body-color));
            font-family: var(--bs-font-sans-serif);
            line-height: 1.6;
        }

        .main-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .container {
            background-color: var(--theme-bg-card, var(--bs-body-bg));
            color: var(--theme-text, var(--bs-body-color));
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: var(--content-spacing);
            margin-bottom: 2rem;
        }

        .content-section {
            background: var(--section-bg, var(--theme-bg-card, var(--bs-body-bg)));
            color: var(--theme-text, var(--bs-body-color));
            border: 1px solid var(--section-border, var(--theme-border, var(--bs-border-color)));
            border-radius: var(--section-border-radius, 12px);
            border-left: 4px solid var(--theme-primary, var(--bs-primary));
            box-shadow: var(--section-shadow, var(--shadow-sm));
            backdrop-filter: var(--section-backdrop-filter, none);
            overflow: hidden;
            margin-bottom: var(--section-margin-bottom, var(--content-spacing));
            transition: var(--transition-base);
        }

        .content-section:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        /* Theme Section Styles */
        .theme-section {
            background: var(--section-bg, var(--theme-bg-surface, var(--bs-secondary-bg)));
            border: 1px solid var(--section-border, var(--theme-border, var(--bs-border-color)));
            border-radius: var(--section-border-radius, var(--border-radius));
            padding: var(--section-padding, var(--content-spacing));
            margin-bottom: var(--section-margin-bottom, var(--content-spacing));
            box-shadow: var(--section-shadow, none);
            backdrop-filter: var(--section-backdrop-filter, none);
            -webkit-backdrop-filter: var(--section-backdrop-filter, none);
            animation: var(--section-animation, none);
            transition: all 0.3s ease;
        }

        .theme-section:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Pattern Styles for Theme Sections */
        .theme-section.pattern-zigzag {
            background-image: linear-gradient(135deg, 
                transparent 0%, 
                transparent 25%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 50%, 
                transparent 50%, 
                transparent 75%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 75%) !important;
            background-size: 25px 25px !important;
        }

        .theme-section.pattern-diagonal-lines {
            background-image: 
                linear-gradient(45deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, transparent 25%) !important;
            background-size: 20px 20px !important;
            background-position: 0 0, 10px 10px !important;
        }

        .pattern-dots {
            background-image: radial-gradient(circle, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.2) 2px, transparent 2px);
            background-size: 15px 15px;
        }

        .pattern-grid {
            background-image: 
                linear-gradient(rgba(var(--theme-border-rgb, 222, 226, 230), 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(var(--theme-border-rgb, 222, 226, 230), 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .pattern-zigzag {
            background-image: linear-gradient(135deg, 
                transparent 0%, 
                transparent 25%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 50%, 
                transparent 50%, 
                transparent 75%, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 75%);
            background-size: 25px 25px;
        }

        .pattern-crosshatch {
            background-image: 
                linear-gradient(45deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, transparent 25%);
            background-size: 30px 30px;
        }

        .pattern-waves {
            background-image: 
                radial-gradient(ellipse 50px 20px at 50% 0%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1), transparent),
                radial-gradient(ellipse 50px 20px at 50% 100%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1), transparent);
            background-size: 100px 60px;
            background-position: 0 0, 50px 30px;
        }

        .pattern-hexagon {
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 2px, transparent 2px);
            background-size: 30px 30px;
        }

        .pattern-triangles {
            background-image: 
                linear-gradient(60deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, transparent 25%),
                linear-gradient(-60deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 25%, transparent 25%);
            background-size: 25px 43px;
        }

        .pattern-circles {
            background-image: radial-gradient(circle, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 30%, transparent 30%);
            background-size: 25px 25px;
        }

        .pattern-squares {
            background-image: 
                linear-gradient(90deg, rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 50%, transparent 50%),
                linear-gradient(rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1) 50%, transparent 50%);
            background-size: 20px 20px;
        }

        /* Effect Styles */
        .theme-section.effect-shadow {
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.1),
                0 20px 48px rgba(0, 0, 0, 0.1),
                0 1px 4px rgba(0, 0, 0, 0.1) !important;
        }

        .theme-section.effect-glow {
            box-shadow: 
                0 0 20px rgba(var(--theme-primary-rgb, 13, 110, 253), 0.3),
                0 0 40px rgba(var(--theme-primary-rgb, 13, 110, 253), 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }

        .effect-gradient {
            background: linear-gradient(135deg, 
                rgba(var(--theme-primary-rgb, 13, 110, 253), 0.05) 0%,
                rgba(var(--theme-secondary-rgb, 108, 117, 125), 0.05) 100%);
        }

        .effect-blur {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(var(--theme-bg-surface-rgb, 255, 255, 255), 0.8);
        }

        .effect-neon {
            border: 2px solid rgba(var(--theme-primary-rgb, 13, 110, 253), 0.6);
            box-shadow: 
                0 0 5px rgba(var(--theme-primary-rgb, 13, 110, 253), 0.6),
                inset 0 0 5px rgba(var(--theme-primary-rgb, 13, 110, 253), 0.3);
        }

        .effect-raised {
            transform: translateY(-2px);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.15),
                0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .effect-inset {
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Decoration Styles */
        .decoration-leaf {
            position: relative;
        }

        .decoration-leaf::before {
            content: "ðŸƒ";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0.3;
            font-size: 1.2rem;
        }

        .decoration-star {
            position: relative;
        }

        .decoration-star::before {
            content: "â­";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0.4;
            font-size: 1rem;
        }

        .decoration-flower {
            position: relative;
        }

        .decoration-flower::before {
            content: "ðŸŒ¸";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0.4;
            font-size: 1rem;
        }

        .decoration-gem {
            position: relative;
        }

        .decoration-gem::before {
            content: "ðŸ’Ž";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0.4;
            font-size: 1rem;
        }

        .decoration-crown {
            position: relative;
        }

        .decoration-crown::before {
            content: "ðŸ‘‘";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0.4;
            font-size: 1rem;
        }

        .section-header {
            border-bottom: 1px solid var(--theme-border, var(--bs-border-color));
            margin-bottom: var(--content-spacing);
            padding-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            color: var(--theme-text, var(--bs-body-color));
            margin: 0;
            font-weight: 600;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: var(--theme-primary, var(--bs-primary));
            font-size: 1.1em;
        }

        /* Enhanced Reminder Styles */
        .reminder-status-card {
            background: var(--theme-bg-surface, var(--bs-secondary-bg));
            border: 1px solid var(--theme-border, var(--bs-border-color)) !important;
            transition: var(--transition-base);
        }

        .reminder-status-card:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .reminder-details {
            font-size: 0.95rem;
        }

        #reminderProgressSummary {
            border: 1px solid var(--theme-border, var(--bs-border-color));
            background: var(--theme-bg-surface, var(--bs-info-bg-subtle));
            color: var(--theme-text, var(--bs-info-color));
            border-left: 4px solid var(--theme-info, var(--bs-info));
        }

        #reminderProgressSummary .alert-heading {
            color: var(--theme-text, var(--bs-info-color));
            margin-bottom: 0.5rem;
        }

        .section-content {
            padding: var(--content-spacing);
        }

        /* Enhanced Form Controls Theme Support */
        .form-control, .form-select {
            margin-bottom: 15px;
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            border-color: var(--theme-border, var(--bs-border-color)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            border-color: var(--theme-primary, var(--bs-primary)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb, 13, 110, 253), 0.25) !important;
        }

        /* Enhanced form-select theming with theme integration */
        .form-select {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            border-color: var(--theme-border, var(--bs-border-color)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 0.75rem center !important;
            background-size: 16px 12px !important;
        }

        .form-select:focus {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            border-color: var(--theme-primary, var(--bs-primary)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23495057' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e") !important;
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25) !important;
            outline: none !important;
        }

        /* Form-select option theming */
        .form-select option {
            background-color: var(--bs-body-bg) !important;
            color: var(--bs-body-color) !important;
        }

        .form-select option:checked {
            background-color: var(--bs-primary) !important;
            color: white !important;
        }

        /* Override Bootstrap's select focus ring */
        select.form-select:focus {
            border-color: var(--bs-primary) !important;
            outline: 0 !important;
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25) !important;
        }

        /* Specific targeting for label printing form selects - COMPREHENSIVE THEMING */
        #labelTypeSelect, #labelRotationSelect {
            background-color: var(--bs-body-bg) !important;
            border-color: var(--bs-border-color) !important;
            color: var(--bs-body-color) !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23495057' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 0.75rem center !important;
            background-size: 16px 12px !important;
        }

        /* Force override any Bootstrap/browser defaults */
        select#labelTypeSelect, select#labelRotationSelect,
        .form-select#labelTypeSelect, .form-select#labelRotationSelect {
            background-color: var(--bs-body-bg) !important;
            border-color: var(--bs-border-color) !important;
            color: var(--bs-body-color) !important;
            -webkit-text-fill-color: var(--bs-body-color) !important;
        }

        /* Focus state - highlight around the box */
        #labelTypeSelect:focus, #labelRotationSelect:focus,
        select#labelTypeSelect:focus, select#labelRotationSelect:focus {
            background-color: var(--bs-body-bg) !important;
            border-color: var(--bs-primary) !important;
            color: var(--bs-body-color) !important;
            -webkit-text-fill-color: var(--bs-body-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25) !important;
            outline: none !important;
        }

        /* Hover state */
        #labelTypeSelect:hover, #labelRotationSelect:hover {
            border-color: var(--bs-primary) !important;
            background-color: var(--bs-body-bg) !important;
            color: var(--bs-body-color) !important;
            -webkit-text-fill-color: var(--bs-body-color) !important;
        }

        /* ====== SIMPLE DIRECT OPTION STYLING ====== */
        
        /* Direct option hover styling */
        select option:hover {
            background-color: var(--bs-primary) !important;
            color: white !important;
        }
        
        /* Direct option selection styling */
        select option:checked {
            background-color: var(--bs-primary) !important;
            color: white !important;
        }
        
        /* All options default styling */
        select option {
            background-color: var(--bs-body-bg) !important;
            color: var(--bs-body-color) !important;
        }

        /* Override any webkit/browser defaults */
        select#labelTypeSelect::-webkit-scrollbar, select#labelRotationSelect::-webkit-scrollbar {
            background-color: var(--bs-body-bg) !important;
        }

        select#labelTypeSelect::-webkit-scrollbar-thumb, select#labelRotationSelect::-webkit-scrollbar-thumb {
            background-color: var(--bs-border-color) !important;
        }

        /* Force remove any blue default values */
        #labelTypeSelect:invalid, #labelRotationSelect:invalid,
        #labelTypeSelect:valid, #labelRotationSelect:valid {
            color: var(--bs-body-color) !important;
            -webkit-text-fill-color: var(--bs-body-color) !important;
        }

        /* ====== ADDITIONAL FORM-SELECT ELEMENTS THEMING ====== */
        
        /* Target all other form-select elements */
        #entryTypeSelect, #statusSelect, #chartTypeSelect, #sensorTypeFilter {
            background-color: var(--bs-body-bg) !important;
            border-color: var(--bs-border-color) !important;
            color: var(--bs-body-color) !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23495057' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 0.75rem center !important;
            background-size: 16px 12px !important;
            -webkit-text-fill-color: var(--bs-body-color) !important;
        }

        /* Focus states for additional selects */
        #entryTypeSelect:focus, #statusSelect:focus, #chartTypeSelect:focus, #sensorTypeFilter:focus {
            background-color: var(--bs-body-bg) !important;
            border-color: var(--bs-primary) !important;
            color: var(--bs-body-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25) !important;
            outline: none !important;
            -webkit-text-fill-color: var(--bs-body-color) !important;
        }

        /* Hover states for additional selects */
        #entryTypeSelect:hover, #statusSelect:hover, #chartTypeSelect:hover, #sensorTypeFilter:hover {
            border-color: var(--bs-primary) !important;
            background-color: var(--bs-body-bg) !important;
            -webkit-text-fill-color: var(--bs-body-color) !important;
        }

        /* Remove the complex additional selects styling - using simple global approach now */

        /* Note item styling with improved organization */
        .note-item {
            background-color: var(--theme-bg-card, var(--bs-body-bg));
            color: var(--theme-text, var(--bs-body-color));
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: var(--transition-base);
            position: relative;
        }

        .note-item:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--theme-primary, var(--bs-primary));
            transform: translateY(-1px);
        }

        .note-item h5 {
            margin-top: 0;
            font-size: 1.1rem;
            color: var(--theme-text, var(--bs-body-color));
            border-bottom: 1px solid var(--theme-border, var(--bs-border-color));
            padding-bottom: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .note-item p {
            font-size: 0.9rem;
            color: var(--theme-text, var(--bs-body-color));
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
        }

        .note-actions button {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* Relationship item styling */
        .relationship-item {
            background: var(--theme-bg-card, var(--bs-body-bg));
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .relationship-item:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--theme-primary, var(--bs-primary));
        }
        
        .section-header {
            border-bottom: 1px solid var(--theme-border, var(--bs-border-color));
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
        }
        
        .section-title {
            color: var(--theme-text, var(--bs-body-color));
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .content-subsection {
            background: var(--theme-bg-surface, var(--bs-secondary-bg));
            color: var(--theme-text, var(--bs-body-color));
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--theme-border, var(--bs-border-color));
        }
        
        .info-card {
            background: var(--theme-bg-surface, var(--bs-secondary-bg));
            color: var(--theme-text, var(--bs-body-color));
            border-radius: 8px;
            padding: 0.75rem;
            border: 1px solid var(--theme-border, var(--bs-border-color));
            height: 100%;
        }
        
        .info-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--theme-text-muted, var(--bs-secondary-color));
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .info-value {
            font-size: 1rem;
            color: var(--theme-text, var(--bs-body-color));
            font-weight: 500;
        }
        .relationship-item h5 {
            margin-top: 0;
            font-size: 1.1rem;
            color: var(--theme-primary, var(--bs-primary, #0056b3));
        }
        .relationship-item p {
            font-size: 0.9rem;
            color: var(--theme-text, var(--bs-body-color));
        }
        .relationship-actions button {
            margin-left: 5px;
        }
        /* New styles for inline note form */
        .placeholder-section {
            border: 1px dashed var(--theme-border, var(--bs-border-color));
            padding: 20px;
            text-align: center;
            color: var(--theme-text-muted, var(--bs-secondary-color));
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg));
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #newNoteForm.collapse:not(.show) {
            display: none;
        }
        #newNoteForm.collapsing {
            height: 0;
            overflow: hidden;
            transition: height 0.35s ease;
        }
        #newNoteForm.collapse.show {
            height: auto;
        }
        /* Style for the modal note content to preserve line breaks and ensure expansion */
        #modalNoteContent {
            white-space: pre-wrap; /* Preserves whitespace and wraps text */
        }
        /* Style for notes list to preserve line breaks */
        .note-text-preview {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* Notes search and filter styling */
        .notes-filter-controls {
            gap: 0.5rem;
        }
        
        .notes-filter-controls .form-select-sm {
            height: 31px; /* Match search input height */
            font-size: 0.875rem;
        }
        
        /* Ensure consistent sizing for input group elements */
        #notesSearchFilters .input-group-sm .input-group-text {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 0.375rem;
            height: 31px;
            display: flex;
            align-items: center;
        }
        
        #notesSearchFilters .input-group-sm .input-group-text i {
            font-size: 12px;
        }
        
        #notesSearchFilters .input-group-sm .form-control {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            height: 31px;
        }
        
        #notesSearchFilters .input-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            height: 31px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #notesSearchFilters .input-group-sm .btn i {
            font-size: 12px;
        }
        /* Ensure modals are responsive */
        @media (max-width: 576px) {
            .modal-dialog {
                margin: 0.5rem;
            }
        }
        /* Style for disabled relationship buttons */
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn:disabled:hover {
            opacity: 0.5;
        }
        
        /* Shared Relationships Styles */
        .opportunity-group {
            background: var(--theme-bg-surface, var(--bs-body-bg));
            border: 1px solid var(--theme-border, var(--bs-border-color)) !important;
            transition: all 0.3s ease;
        }
        
        .shared-relationship-group {
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-left: 4px solid var(--theme-primary, var(--bs-primary));
            transition: all 0.2s ease;
        }
        
        .shared-relationship-group:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .shared-targets-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .shared-target-item {
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .shared-target-item:hover {
            background-color: var(--bs-secondary-bg);
        }
        
        .shared-target-checkbox {
            margin-right: 0.75rem;
        }
        
        .create-shared-relationships-btn {
            min-width: 120px;
        }
        
        /* New shared relationship button styling */
        .shared-relationship-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .shared-relationship-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .shared-relationship-btn .fas {
            font-size: 0.7rem;
        }
        
        /* Mobile-only: remove margin from icon when text is hidden */
        @media (max-width: 767.98px) {
            .shared-relationship-btn .fas {
                margin-right: 0 !important;
            }
            
            .add-new-btn .fas,
            .add-existing-btn .fas {
                margin-right: 0 !important;
            }
            
            /* AI assistance buttons */
            #aiGenerateDescriptionBtn .fas,
            #aiImproveDescriptionBtn .fas,
            #aiGenerateBtn .fas,
            #aiExplainBtn .fas {
                margin-right: 0 !important;
            }
        }
        
        .shared-targets-selection {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: var(--bs-secondary-bg);
        }
        
        .shared-targets-selection .form-check {
            background-color: var(--bs-body-bg);
            transition: all 0.2s ease;
            margin-bottom: 0.5rem !important;
            border: 1px solid var(--bs-border-color) !important;
            color: var(--bs-body-color);
        }
        
        .shared-targets-selection .form-check:hover {
            background-color: var(--bs-tertiary-bg);
            border-color: var(--theme-primary, var(--bs-primary)) !important;
        }
        
        .shared-targets-selection .form-check-input {
            margin-top: 0 !important;
            margin-right: 0 !important;
            width: 1.25em;
            height: 1.25em;
            flex-shrink: 0;
            background-color: var(--bs-body-bg);
            border-color: var(--bs-border-color);
        }
        
        .shared-targets-selection .form-check-input:checked {
            background-color: var(--theme-primary, var(--bs-primary));
            border-color: var(--theme-primary, var(--bs-primary));
        }
        
        .shared-targets-selection .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(var(--theme-primary-rgb, 13, 110, 253), 0.25);
        }
        
        .shared-targets-selection .form-check-label {
            cursor: pointer;
            width: 100%;
            color: var(--bs-body-color);
        }
        
        .shared-targets-selection .text-muted {
            color: var(--bs-secondary-color) !important;
        }
        
        .quantity-inputs {
            min-width: 140px;
            flex-shrink: 0;
        }
        
        .quantity-inputs .input-group-sm .form-control {
            font-size: 0.8rem;
            height: calc(1.5em + 0.5rem + 2px);
        }
        
        .opportunity-group:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: var(--theme-primary, var(--bs-primary)) !important;
        }
        
        
        .target-item {
            background: var(--theme-bg-card, var(--bs-body-bg));
            border: 1px solid var(--theme-border-light, #e9ecef) !important;
            transition: all 0.2s ease;
        }
        
        .target-item:hover {
            border-color: var(--theme-primary, var(--bs-primary)) !important;
        }
        
        .target-item.bg-light {
            background: var(--theme-bg-selected, rgba(13, 110, 253, 0.1)) !important;
            border-color: var(--theme-primary, var(--bs-primary)) !important;
        }
        
        .quantity-inputs .form-control {
            font-size: 0.85rem;
        }
        
        .targets-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .section-content {
            padding: 1rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .section-title {
            color: var(--theme-text, var(--bs-body-color));
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .content-subsection {
            background: var(--theme-bg-surface, var(--bs-secondary-bg));
            color: var(--theme-text, var(--bs-body-color));
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--theme-border, var(--bs-border-color));
        }
        
        .info-card {
            background: var(--theme-bg-surface, var(--bs-secondary-bg));
            color: var(--theme-text, var(--bs-body-color));
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--bs-border-color);
            height: 100%;
        }
        
        .info-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--theme-text-muted, var(--bs-secondary-color));
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .info-value {
            font-size: 1rem;
            color: var(--bs-body-color);
            font-weight: 500;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .main-container {
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
            
            .container {
                margin: 0.5rem;
                padding: 1rem;
            }
            
            .section-content {
                padding: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .entry-actions {
                width: 100%;
                justify-content: center;
            }
        }

        /* Enhanced Modal theme support */
        .modal-content {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
            border-color: var(--theme-border, var(--bs-border-color)) !important;
            border-radius: var(--bs-border-radius, 0.375rem) !important;
        }
        
        .modal-header {
            border-bottom-color: var(--theme-border, var(--bs-border-color)) !important;
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
        }
        
        .modal-title {
            color: var(--theme-text, var(--bs-body-color)) !important;
        }
        
        .modal-body {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
        }
        
        .modal-footer {
            border-top-color: var(--theme-border, var(--bs-border-color)) !important;
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg)) !important;
        }

        /* Modal backdrop theme support */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5) !important;
        }

        /* Modal form controls theme support */
        .modal .form-control,
        .modal .form-select {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            border-color: var(--theme-border, var(--bs-border-color)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
        }

        .modal .form-control:focus,
        .modal .form-select:focus {
            background-color: var(--theme-bg-card, var(--bs-body-bg)) !important;
            border-color: var(--theme-primary, var(--bs-primary)) !important;
            color: var(--theme-text, var(--bs-body-color)) !important;
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb, 13, 110, 253), 0.25) !important;
        }

        /* Modal form labels theme support */
        .modal .form-label {
            color: var(--theme-text, var(--bs-body-color)) !important;
        }

        /* Modal form text and help text theme support */
        .modal .form-text {
            color: var(--theme-text-muted, var(--bs-secondary-color)) !important;
        }

        /* Modal buttons theme support */
        .modal .btn {
            margin: 0.25rem;
        }

        /* Enhanced Table theme support */
        .table {
            color: var(--theme-text, var(--bs-body-color));
            border-color: var(--theme-border, var(--bs-border-color));
            background-color: var(--theme-bg-card, var(--bs-body-bg));
            font-size: 0.875rem;
        }

        .table th {
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg));
            border-color: var(--theme-border, var(--bs-border-color));
            color: var(--theme-text, var(--bs-body-color));
            font-weight: 600;
            padding: 0.75rem;
            border-bottom: 2px solid var(--theme-border, var(--bs-border-color));
        }

        .table td {
            border-color: var(--theme-border, var(--bs-border-color));
            color: var(--theme-text, var(--bs-body-color));
            padding: 0.75rem;
            vertical-align: top;
        }

        .table tbody tr {
            background-color: var(--theme-bg-card, var(--bs-body-bg));
            transition: background-color 0.15s ease-in-out;
        }

        .table tbody tr:hover {
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg));
        }

        /* Table-sm (small table) enhanced styling */
        .table-sm th,
        .table-sm td {
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        .table-sm th {
            font-weight: 600;
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg));
            color: var(--theme-text, var(--bs-body-color));
            border-bottom: 1px solid var(--theme-border, var(--bs-border-color));
        }

        .table-sm td {
            color: var(--theme-text, var(--bs-body-color));
            border-color: var(--theme-border, var(--bs-border-color));
        }

        .table-sm tbody tr:hover {
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg));
        }

        /* Table striped theme support */
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: var(--theme-bg-stripe, rgba(var(--bs-primary-rgb, 13, 110, 253), 0.05)) !important;
        }

        .table-striped.table-sm > tbody > tr:nth-of-type(odd) {
            background-color: var(--theme-bg-stripe, rgba(var(--bs-primary-rgb, 13, 110, 253), 0.05)) !important;
        }

        /* Table bordered theme support */
        .table-bordered {
            border: 1px solid var(--theme-border, var(--bs-border-color));
        }

        .table-bordered th,
        .table-bordered td {
            border: 1px solid var(--theme-border, var(--bs-border-color));
        }

        /* Table responsive wrapper */
        .table-responsive {
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius, 0.375rem);
            background-color: var(--theme-bg-card, var(--bs-body-bg));
        }

        /* Table caption theme support */
        .table caption {
            color: var(--theme-text-muted, var(--bs-secondary-color));
            font-size: 0.875rem;
            font-style: italic;
            padding: 0.5rem 0;
        }
        
        /* Card and badge theme support */
        .card {
            background-color: var(--bs-body-bg);
            border-color: var(--bs-border-color);
            color: var(--bs-body-color);
        }

        .card-header {
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg));
            border-bottom-color: var(--theme-border, var(--bs-border-color));
            color: var(--theme-text, var(--bs-body-color));
        }

        .card-body {
            background-color: var(--theme-bg-card, var(--bs-body-bg));
            color: var(--theme-text, var(--bs-body-color));
        }

        .border-theme {
            border-color: var(--bs-primary) !important;
        }

        .text-theme-info {
            color: var(--bs-primary) !important;
        }
        
        /* Enhanced Anchor/Link theme support */
        a {
            color: var(--theme-primary, var(--bs-primary));
            text-decoration: none;
            transition: var(--transition-base);
        }
        
        a:hover {
            color: var(--theme-primary, var(--bs-primary));
            opacity: 0.8;
        }
        
        a:focus {
            color: var(--theme-primary, var(--bs-primary));
            outline: 2px solid var(--theme-primary, var(--bs-primary));
            outline-offset: 2px;
        }
        
        /* Theme-aware link classes */
        .link-theme {
            color: var(--theme-primary, var(--bs-primary)) !important;
        }
        
        .link-theme:hover {
            color: var(--theme-primary, var(--bs-primary)) !important;
            opacity: 0.8;
        }
        
        .link-theme-muted {
            color: var(--theme-text-muted, var(--bs-secondary-color)) !important;
        }
        
        .link-theme-muted:hover {
            color: var(--theme-text, var(--bs-body-color)) !important;
        }
        
        /* Enhanced Button theme support */
        .btn-outline-secondary {
            color: var(--bs-secondary) !important;
            border-color: var(--bs-secondary) !important;
            background-color: transparent !important;
        }
        
        .btn-outline-secondary:hover, .btn-outline-secondary:focus, .btn-outline-secondary:active {
            background-color: var(--bs-secondary) !important;
            border-color: var(--bs-secondary) !important;
            color: var(--bs-light, #fff) !important;
        }
        
        .btn-outline-primary {
            color: var(--bs-primary, #0d6efd) !important;
            border-color: var(--bs-primary, #0d6efd) !important;
            background-color: transparent !important;
        }
        
        .btn-outline-primary:hover, .btn-outline-primary:focus, .btn-outline-primary:active {
            background-color: var(--bs-primary, #0d6efd) !important;
            border-color: var(--bs-primary, #0d6efd) !important;
            color: var(--bs-light, #fff) !important;
        }
        
        .btn-outline-danger {
            color: var(--bs-danger, #dc3545) !important;
            border-color: var(--bs-danger, #dc3545) !important;
            background-color: transparent !important;
        }
        
        .btn-outline-danger:hover, .btn-outline-danger:focus, .btn-outline-danger:active {
            background-color: var(--bs-danger, #dc3545) !important;
            border-color: var(--bs-danger, #dc3545) !important;
            color: var(--bs-light, #fff) !important;
        }

        /* Solid button theme support */
        .btn-danger {
            background-color: var(--bs-danger, #dc3545) !important;
            border-color: var(--bs-danger, #dc3545) !important;
            color: var(--bs-light, #fff) !important;
        }
        
        .btn-danger:hover, .btn-danger:focus, .btn-danger:active {
            background-color: var(--bs-danger-dark, #b02a37) !important;
            border-color: var(--bs-danger-dark, #b02a37) !important;
            color: var(--bs-light, #fff) !important;
        }

        .btn-primary {
            background-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            border-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            color: var(--theme-primary-text, white) !important;
        }
        
        .btn-primary:hover, .btn-primary:focus, .btn-primary:active {
            background-color: var(--theme-primary-hover, var(--bs-primary-dark, #0b5ed7)) !important;
            border-color: var(--theme-primary-hover, var(--bs-primary-dark, #0b5ed7)) !important;
            color: var(--theme-primary-text, white) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: var(--bs-secondary, #6c757d) !important;
            border-color: var(--bs-secondary, #6c757d) !important;
            color: var(--bs-light, #fff) !important;
        }
        
        .btn-secondary:hover, .btn-secondary:focus, .btn-secondary:active {
            background-color: var(--bs-secondary-dark, #565e64) !important;
            border-color: var(--bs-secondary-dark, #565e64) !important;
            color: var(--bs-light, #fff) !important;
        }

        /* Theme-specific button classes */
        .btn-outline-theme {
            color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            border-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            background-color: transparent !important;
        }
        
        .btn-outline-theme:hover, .btn-outline-theme:focus, .btn-outline-theme:active {
            background-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            border-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            color: var(--bs-light, #fff) !important;
        }

        /* Theme-aware button classes */
        .btn-theme-primary {
            background-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            border-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            color: var(--theme-primary-text, white) !important;
            font-weight: 500;
        }
        
        .btn-theme-primary:hover, .btn-theme-primary:focus, .btn-theme-primary:active {
            background-color: var(--theme-primary-hover, var(--bs-primary-dark, #0b5ed7)) !important;
            border-color: var(--theme-primary-hover, var(--bs-primary-dark, #0b5ed7)) !important;
            color: var(--theme-primary-text, white) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .btn-theme-secondary {
            background-color: var(--theme-secondary, var(--bs-secondary, #6c757d)) !important;
            border-color: var(--theme-secondary, var(--bs-secondary, #6c757d)) !important;
            color: white !important;
            font-weight: 500;
        }
        
        .btn-theme-secondary:hover, .btn-theme-secondary:focus, .btn-theme-secondary:active {
            background-color: var(--theme-secondary-hover, var(--bs-secondary-dark, #5c636a)) !important;
            border-color: var(--theme-secondary-hover, var(--bs-secondary-dark, #5c636a)) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Outline theme button variants */
        .btn-outline-theme-primary {
            color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            border-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            background-color: transparent !important;
            font-weight: 500;
        }

        .btn-outline-theme-primary:hover, .btn-outline-theme-primary:focus, .btn-outline-theme-primary:active {
            background-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            border-color: var(--theme-primary, var(--bs-primary, #0d6efd)) !important;
            color: var(--theme-primary-text, white) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .btn-outline-theme-secondary {
            color: var(--theme-secondary, var(--bs-secondary, #6c757d)) !important;
            border-color: var(--theme-secondary, var(--bs-secondary, #6c757d)) !important;
            background-color: transparent !important;
            font-weight: 500;
        }

        .btn-outline-theme-secondary:hover, .btn-outline-theme-secondary:focus, .btn-outline-theme-secondary:active {
            background-color: var(--theme-secondary, var(--bs-secondary, #6c757d)) !important;
            border-color: var(--theme-secondary, var(--bs-secondary, #6c757d)) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        /* Text color overrides for theme support */
        .text-muted {
            color: var(--theme-text-muted, #6c757d) !important;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: var(--theme-text, #212529);
        }
        
        /* Dropdown and select theme support */
        .dropdown-menu {
            background-color: var(--theme-bg-card, #fff);
            border-color: var(--bs-border-color, #dee2e6);
        }
        
        .dropdown-item {
            color: var(--theme-text, #212529);
        }
        
        .dropdown-item:hover, .dropdown-item:focus {
            background-color: var(--theme-bg-surface, #f8f9fa);
            color: var(--theme-text, #212529);
        }
        
        /* Card and badge theme support */
        .card {
            background-color: var(--theme-bg-card, #fff);
            border-color: var(--bs-border-color, #dee2e6);
            color: var(--theme-text, #212529);
        }

        /* Badge theme integration */
        .badge.bg-primary {
            background-color: var(--bs-primary, #0d6efd) !important;
            color: var(--bs-light, #fff) !important;
        }

        .badge.bg-secondary {
            background-color: var(--bs-secondary, #6c757d) !important;
            color: var(--bs-light, #fff) !important;
        }

        .badge.bg-success {
            background-color: var(--bs-success, #198754) !important;
            color: var(--bs-light, #fff) !important;
        }

        .badge.bg-danger {
            background-color: var(--bs-danger, #dc3545) !important;
            color: var(--bs-light, #fff) !important;
        }

        .badge.bg-warning {
            background-color: var(--bs-warning, #ffc107) !important;
            color: var(--bs-dark, #000) !important;
        }

        .badge.bg-info {
            background-color: var(--bs-info, #0dcaf0) !important;
            color: var(--bs-dark, #000) !important;
        }

        .badge.bg-light {
            background-color: var(--bs-light, #f8f9fa) !important;
            color: var(--bs-dark, #000) !important;
        }

        .badge.bg-dark {
            background-color: var(--bs-dark, #212529) !important;
            color: var(--bs-light, #fff) !important;
        }
        
        .badge {
            color: white;
        }

        /* Label Grid Styles */
        .label-grid {
            background: var(--theme-bg-surface, var(--bs-secondary-bg));
            border: 1px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .label-grid-container {
            border: 2px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            padding: 10px;
            background: var(--theme-bg-card, var(--bs-body-bg));
            max-width: 200px;
        }

        .label-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .label-row:last-child {
            margin-bottom: 0;
        }

        .label-position {
            width: 80px;
            height: 40px;
            border: 2px solid var(--theme-border, var(--bs-border-color));
            border-radius: var(--border-radius);
            background: var(--theme-bg-card, var(--bs-body-bg));
            color: var(--theme-text, var(--bs-body-color));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 12px;
        }

        .label-position:hover {
            border-color: var(--theme-primary, var(--bs-primary));
            background: var(--theme-bg-info, var(--bs-info-bg-subtle, rgba(13, 202, 240, 0.1)));
            color: var(--theme-primary, var(--bs-primary));
            transform: translateY(-1px);
        }

        .label-position.selected {
            background: var(--theme-primary, var(--bs-primary));
            color: var(--theme-primary-text, white);
            border-color: var(--theme-primary, var(--bs-primary));
        }

        .label-position.selected:hover {
            background: var(--theme-primary-hover, var(--bs-primary));
            color: var(--theme-primary-text, white);
        }
        
        /* Bootstrap CSS variables override for theme integration */
        :root {
            --bs-info-bg-subtle: var(--theme-alert-info-bg, rgba(13, 202, 240, 0.1));
            --bs-info-border-subtle: var(--theme-alert-info-border, rgba(13, 202, 240, 0.2));
            --bs-info-text-emphasis: var(--theme-alert-info-text, #0c5460);
            
            /* Form control variables for theming */
            --bs-form-select-bg-img: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
            --bs-border-color: var(--theme-border, #dee2e6);
            --bs-body-bg: var(--theme-bg-card, #fff);
            --bs-body-color: var(--theme-text, #212529);
            --bs-focus-ring-color: rgba(var(--theme-primary-rgb, 13, 110, 253), 0.25);
        }

        /* Alert and status message theme support */
        .alert {
            border-color: var(--bs-border-color, #dee2e6);
        }
        
        .alert-info {
            background-color: var(--theme-alert-info-bg, var(--bs-info-bg-subtle, rgba(13, 202, 240, 0.1))) !important;
            border-color: var(--theme-alert-info-border, var(--bs-info-border-subtle, rgba(13, 202, 240, 0.2))) !important;
            color: var(--theme-alert-info-text, var(--bs-info-text-emphasis, #0c5460)) !important;
        }
        
        .alert-success {
            background-color: rgba(var(--bs-success-rgb, 25, 135, 84), 0.1);
            border-color: rgba(var(--bs-success-rgb, 25, 135, 84), 0.2);
            color: var(--theme-text, #212529);
        }
        
        .alert-warning {
            background-color: rgba(var(--bs-warning-rgb, 255, 193, 7), 0.1);
            border-color: rgba(var(--bs-warning-rgb, 255, 193, 7), 0.2);
            color: var(--theme-text, #212529);
        }
        
        .alert-danger {
            background-color: rgba(var(--bs-danger-rgb, 220, 53, 69), 0.1);
            border-color: rgba(var(--bs-danger-rgb, 220, 53, 69), 0.2);
            color: var(--theme-text, #212529);
        }
        
        /* Enhanced Bootstrap button theme support */
        .btn-primary {
            background-color: var(--theme-primary, var(--bs-primary, #0d6efd));
            border-color: var(--theme-primary, var(--bs-primary, #0d6efd));
            color: var(--theme-primary-text, white);
        }
        
        .btn-primary:hover {
            background-color: var(--theme-primary-hover, var(--bs-primary-dark, #0b5ed7));
            border-color: var(--theme-primary-hover, var(--bs-primary-dark, #0b5ed7));
            color: var(--theme-primary-text, white);
        }
        
        .btn-secondary {
            background-color: var(--bs-secondary, #6c757d);
            border-color: var(--bs-secondary, #6c757d);
        }
        
        .btn-secondary:hover {
            background-color: var(--bs-secondary, #5c636a);
            border-color: var(--bs-secondary, #565e64);
        }
        
        .btn-success {
            background-color: var(--bs-success, #198754);
            border-color: var(--bs-success, #198754);
        }
        
        .btn-success:hover {
            background-color: var(--bs-success, #157347);
            border-color: var(--bs-success, #146c43);
        }
        
        .btn-danger {
            background-color: var(--bs-danger, #dc3545);
            border-color: var(--bs-danger, #dc3545);
        }
        
        .btn-danger:hover {
            background-color: var(--bs-danger, #bb2d3b);
            border-color: var(--bs-danger, #b02a37);
        }
        
        .btn-warning {
            background-color: var(--bs-warning, #ffc107);
            border-color: var(--bs-warning, #ffc107);
            color: var(--bs-dark, #000);
        }
        
        .btn-warning:hover {
            background-color: var(--bs-warning, #e0a800);
            border-color: var(--bs-warning, #d39e00);
            color: var(--bs-dark, #000);
        }
        
        .btn-info {
            background-color: var(--bs-info, #0dcaf0);
            border-color: var(--bs-info, #0dcaf0);
        }
        
        .btn-info:hover {
            background-color: var(--bs-info, #31d2f2);
            border-color: var(--bs-info, #25cff2);
        }
        
        .btn-light {
            background-color: var(--theme-bg-surface, #f8f9fa);
            border-color: var(--bs-border-color, #f8f9fa);
            color: var(--theme-text, #212529);
        }
        
        .btn-light:hover {
            background-color: var(--theme-bg-surface, #e2e6ea);
            border-color: var(--bs-border-color, #dae0e5);
            color: var(--theme-text, #212529);
        }
        
        .btn-dark {
            background-color: var(--theme-text, #212529);
            border-color: var(--theme-text, #212529);
            color: var(--theme-bg-card, #fff);
        }
        
        .btn-dark:hover {
            background-color: var(--theme-text, #1c1f23);
            border-color: var(--theme-text, #1a1e21);
            color: var(--theme-bg-card, #fff);
        }
        
        /* List group theme support */
        .list-group-item {
            background-color: var(--theme-bg-card, #fff);
            border-color: var(--bs-border-color, #dee2e6);
            color: var(--theme-text, #212529);
        }
        
        .list-group-item:hover {
            background-color: var(--theme-bg-surface, #f8f9fa);
        }
        
        .list-group-item.active {
            background-color: var(--bs-primary, #0d6efd);
            border-color: var(--bs-primary, #0d6efd);
        }
        
        /* Input group theme support */
        .input-group-text {
            background-color: var(--theme-bg-surface, #e9ecef);
            border-color: var(--bs-border-color, #ced4da);
            color: var(--theme-text, #495057);
        }
        
        /* Progress bar theme support */
        .progress {
            background-color: var(--theme-bg-surface, var(--bs-secondary-bg));
            border: 1px solid var(--theme-border, var(--bs-border-color));
        }
        
        .progress-bar {
            background: linear-gradient(135deg, var(--theme-primary, var(--bs-primary)), var(--theme-primary-hover, var(--bs-primary)));
            transition: all 0.3s ease;
        }
        
        .progress-bar.progress-bar-striped {
            background: linear-gradient(45deg, 
                transparent 25%, 
                rgba(255,255,255,0.15) 25%, 
                rgba(255,255,255,0.15) 50%, 
                transparent 50%, 
                transparent 75%, 
                rgba(255,255,255,0.15) 75%, 
                rgba(255,255,255,0.15)) var(--theme-primary, var(--bs-primary));
        }
        
        /* Progress Timeline Styles */
        .progress-timeline {
            padding: 1rem;
            background: var(--theme-bg-card, var(--bs-body-bg));
            border-radius: 12px;
            border: 1px solid var(--theme-border, var(--bs-border-color));
            box-shadow: var(--shadow-sm);
        }
        
        .progress-header {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .progress-header small {
            color: var(--theme-text-muted, var(--bs-secondary));
        }
        
        .progress-status-text {
            font-weight: 600;
            color: var(--theme-primary, var(--bs-primary));
            font-size: 0.95rem;
        }
        
        .progress-timeline .progress {
            background-color: var(--theme-bg-surface, #e9ecef);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--theme-border, rgba(0,0,0,0.1));
        }
        
        .progress-timeline .progress-bar {
            background: linear-gradient(90deg, 
                var(--theme-primary, var(--bs-primary)) 0%, 
                var(--theme-primary-hover, var(--bs-primary)) 100%);
            transition: width 0.8s ease-in-out;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-timeline .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.3) 50%, 
                transparent 100%);
            animation: progress-shine 2s infinite;
        }
        
        @keyframes progress-shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .progress-details {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--theme-border, var(--bs-border-color-translucent));
        }
        
        .progress-details small {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .progress-details .fa-clock {
            color: var(--theme-info, var(--bs-info));
        }
        
        .progress-details .fa-calendar-day {
            color: var(--theme-secondary, var(--bs-secondary));
        }
        
        .progress-details .fa-hourglass-half {
            color: var(--theme-warning, var(--bs-warning));
        }
        
        /* Progress states */
        .progress-bar.progress-overdue {
            background: linear-gradient(90deg, 
                var(--theme-danger, var(--bs-danger)) 0%, 
                var(--theme-danger-hover, #dc2626) 100%);
        }
        
        .progress-bar.progress-complete {
            background: linear-gradient(90deg, 
                var(--theme-success, var(--bs-success)) 0%, 
                var(--theme-success-hover, #16a34a) 100%);
        }
        
        .progress-bar.progress-near-deadline {
            background: linear-gradient(90deg, 
                var(--theme-warning, var(--bs-warning)) 0%, 
                var(--theme-warning-hover, #f59e0b) 100%);
        }
        
        .text-overdue {
            color: var(--theme-danger, var(--bs-danger)) !important;
        }
        
        .text-complete {
            color: var(--theme-success, var(--bs-success)) !important;
        }
        
        .text-near-deadline {
            color: var(--theme-warning, var(--bs-warning)) !important;
        }
        
        /* Tab theme support */
        .nav-tabs {
            border-bottom-color: var(--bs-border-color, #dee2e6);
        }
        
        .nav-tabs .nav-link {
            color: var(--theme-text, #495057);
            border-color: transparent;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: var(--theme-bg-surface, #e9ecef) var(--theme-bg-surface, #e9ecef) var(--bs-border-color, #dee2e6);
            isolation: isolate;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--theme-text, #495057);
            background-color: var(--theme-bg-card, #fff);
            border-color: var(--bs-border-color, #dee2e6) var(--bs-border-color, #dee2e6) var(--theme-bg-card, #fff);
        }
        
        .tab-content > .tab-pane {
            background-color: var(--theme-bg-card, #fff);
            color: var(--theme-text, #212529);
        }
        
        /* Accordion theme support */
        .accordion-item {
            background-color: var(--theme-bg-card, #fff);
            border-color: var(--bs-border-color, #dee2e6);
        }
        
        .accordion-button {
            background-color: var(--theme-bg-card, #fff);
            color: var(--theme-text, #212529);
        }
        
        .accordion-button:not(.collapsed) {
            background-color: var(--theme-bg-surface, #e7f1ff);
            color: var(--bs-primary, #0c63e4);
        }
        
        /* Pagination theme support */
        .page-item .page-link {
            background-color: var(--theme-bg-card, #fff);
            border-color: var(--bs-border-color, #dee2e6);
            color: var(--bs-primary, #0d6efd);
        }
        
        .page-item:hover .page-link {
            background-color: var(--theme-bg-surface, #e9ecef);
            border-color: var(--bs-border-color, #adb5bd);
        }
        
        .page-item.active .page-link {
            background-color: var(--bs-primary, #0d6efd);
            border-color: var(--bs-primary, #0d6efd);
        }
        
        /* Spinner theme support */
        .spinner-border {
            color: var(--bs-primary, #0d6efd);
        }
        
        /* Close button theme support */
        .btn-close {
            filter: var(--theme-text, invert(1)) grayscale(100%) brightness(200%);
        }
        
        /* Tooltip theme support */
        .tooltip .tooltip-inner {
            background-color: var(--theme-text, #212529);
            color: var(--theme-bg-card, #fff);
        }
        
        /* Popover theme support */
        .popover {
            background-color: var(--theme-bg-card, #fff);
            border-color: var(--bs-border-color, #dee2e6);
        }
        
        .popover-body {
            color: var(--theme-text, #212529);
        }
        
        .popover-header {
            background-color: var(--theme-bg-surface, #f8f9fa);
            border-bottom-color: var(--bs-border-color, #dee2e6);
            color: var(--theme-text, #212529);
        }
        
        /* Toast theme support */
        .toast {
            background-color: var(--theme-bg-card, #fff);
            border-color: var(--bs-border-color, #dee2e6);
            color: var(--theme-text, #212529);
        }
        
        .toast-header {
            background-color: var(--theme-bg-surface, #f8f9fa);
            border-bottom-color: var(--bs-border-color, #dee2e6);
            color: var(--theme-text, #212529);
        }
        
        /* Status indicators */
        .badge-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Custom component themes */
        .status-message {
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border: 1px solid var(--bs-border-color, #dee2e6);
            background-color: var(--theme-bg-surface, #f8f9fa);
            color: var(--theme-text, #212529);
        }
        
        .loading-indicator {
            color: var(--theme-text-muted, #6c757d);
        }
        
        .error-message {
            color: var(--bs-danger, #dc3545);
            background-color: rgba(var(--bs-danger-rgb, 220, 53, 69), 0.1);
            border-color: rgba(var(--bs-danger-rgb, 220, 53, 69), 0.2);
        }
        
        .success-message {
            color: var(--bs-success, #198754);
            background-color: rgba(var(--bs-success-rgb, 25, 135, 84), 0.1);
            border-color: rgba(var(--bs-success-rgb, 25, 135, 84), 0.2);
        }
        
        .warning-message {
            color: var(--bs-warning, #ffc107);
            background-color: rgba(var(--bs-warning-rgb, 255, 193, 7), 0.1);
            border-color: rgba(var(--bs-warning-rgb, 255, 193, 7), 0.2);
        }
        
        .info-message {
            color: var(--bs-info, #0dcaf0);
            background-color: rgba(var(--bs-info-rgb, 13, 202, 240), 0.1);
            border-color: rgba(var(--bs-info-rgb, 13, 202, 240), 0.2);
        }

        /* ===== RESPONSIVE DESIGN & ACCESSIBILITY IMPROVEMENTS ===== */
        
        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            :root {
                --content-spacing: 1rem;
            }
            
            .container {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .btn-group {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                border-radius: var(--border-radius) !important;
                margin-bottom: 0.5rem;
            }
            
            .d-flex.gap-2 {
                flex-direction: column;
                gap: 0.75rem !important;
            }
            
            .note-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            /* Better mobile text handling */
            .info-card {
                padding: 0.5rem;
            }
            
            .info-value div {
                margin-bottom: 0.5rem !important;
            }
            
            /* Progress timeline mobile improvements */
            .progress-timeline {
                padding: 0.75rem;
            }
            
            .progress-header {
                gap: 0.5rem !important;
            }
            
            .progress-details small {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }
        }
        
        /* Tablet responsive adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .section-title {
                font-size: 1.2rem;
            }
            
            .content-section {
                margin-bottom: 1.25rem;
            }
        }
        
        /* Enhanced focus management for accessibility */
        *:focus {
            outline: 2px solid var(--theme-primary, var(--bs-primary));
            outline-offset: 2px;
            transition: outline-color 0.2s ease;
        }
        
        .btn:focus,
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb, 13, 110, 253), 0.25);
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.3);
            }
            
            .content-section {
                border-width: 2px;
                border-left-width: 6px;
            }
            
            .btn {
                border-width: 2px;
                font-weight: 600;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                transform: none !important;
            }
        }
        
        /* Print styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            
            .content-section {
                border: 1px solid #000 !important;
                box-shadow: none !important;
                break-inside: avoid;
            }
            
            .btn, .note-actions {
                display: none !important;
            }
        }
        
        /* Dark mode color scheme preference support */
        @media (prefers-color-scheme: dark) {
            :root {
                --fallback-bg-body: #0d1117;
                --fallback-bg-card: #161b22;
                --fallback-text: #f0f6fc;
                --fallback-border: #30363d;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="content-section theme-section mb-4">
            <div class="section-content">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                    <!-- Editable Title -->
                    <div class="flex-grow-1 me-md-3 mb-2 mb-md-0">
                        <h1 class="h1 mb-0" id="entryTitleDisplay">{{ entry.title }}</h1>
                        <input type="text" class="form-control form-control-lg d-none" id="entryTitleInput" value="{{ entry.title }}" placeholder="Enter entry title">
                    </div>
                    <div class="entry-actions d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-success d-none" id="saveEntryBtn">
                            <i class="fas fa-save me-1"></i>Save
                        </button>
                        <button class="btn btn-sm btn-secondary d-none" id="cancelEditBtn">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button class="btn btn-sm btn-theme-primary" id="editEntryBtn">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn btn-sm btn-danger" id="deleteEntryBtn">
                            <i class="fas fa-trash-alt me-1"></i>Delete
                        </button>
                        {% if entry.show_labels_section %}
                        <button class="btn btn-sm btn-theme-primary" id="manageLabelBtn" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#labelPrintingSection" 
                                aria-expanded="false" aria-controls="labelPrintingSection">
                            <i class="fas fa-tags me-1"></i>Labels
                        </button>
                        {% endif %}
                        <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back
                        </a>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="info-card">
                            <div class="info-label">Details</div>
                            <div class="info-value">
                                <!-- Display Mode -->
                                <div id="detailsDisplay">
                                    <div><strong>Type:</strong> <span id="entryTypeDisplay">{{ entry.entry_type_label }}</span></div>
                                    <div><strong>Status:</strong> <span id="statusDisplay">{{ (entry.status or 'active').title() }}</span></div>
                                </div>
                                <!-- Edit Mode -->
                                <div id="detailsEdit" class="d-none">
                                    <div class="mb-2">
                                        <label for="entryTypeSelect" class="form-label small">Entry Type</label>
                                        <select class="form-select form-select-sm" id="entryTypeSelect">
                                            <!-- Options will be loaded dynamically -->
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label for="statusSelect" class="form-label small">Status</label>
                                        <select class="form-select form-select-sm" id="statusSelect">
                                            <option value="active" {{ 'selected' if entry.status == 'active' else '' }}>Active</option>
                                            <option value="inactive" {{ 'selected' if entry.status == 'inactive' else '' }}>Inactive</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="info-card">
                            <div class="info-label">Dates</div>
                            <div class="info-value">
                                <!-- Display Mode -->
                                <div id="datesDisplay">
                                    <div class="mb-2"><strong>Created On:</strong><br class="d-md-none"><span class="ms-md-2" id="created-at">{{ entry.created_at }}</span></div>
                                    {% if entry.intended_end_date and entry.show_end_dates %}
                                    <div class="mb-2"><strong>Intended End:</strong><br class="d-md-none"><span class="ms-md-2" id="intended-end-date-display">{{ entry.intended_end_date[:10] if entry.intended_end_date else '' }}</span></div>
                                    {% endif %}
                                    {% if entry.actual_end_date and entry.show_end_dates %}
                                    <div class="mb-2"><strong>Actual End:</strong><br class="d-md-none"><span class="ms-md-2" id="actual-end-date-display">{{ entry.actual_end_date[:10] if entry.actual_end_date else '' }}</span></div>
                                    {% endif %}
                                </div>
                                <!-- Edit Mode -->
                                {% if entry.show_end_dates %}
                                <div id="datesEdit" class="d-none">
                                    <div class="mb-2"><strong>Created On:</strong><br class="d-md-none"><span class="ms-md-2 text-muted" id="created-at-edit">{{ entry.created_at }}</span></div>
                                    <div class="mb-2">
                                        <label for="intendedEndDateInput" class="form-label small">Intended End Date</label>
                                        <input type="date" class="form-control form-control-sm" id="intendedEndDateInput" value="{{ entry.intended_end_date[:10] if entry.intended_end_date else '' }}">
                                    </div>
                                    <div class="mb-2">
                                        <label for="actualEndDateInput" class="form-label small">Actual End Date</label>
                                        <input type="date" class="form-control form-control-sm" id="actualEndDateInput" value="{{ entry.actual_end_date[:10] if entry.actual_end_date else '' }}">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <div class="info-card">
                        <div class="info-label">
                            Description
                            <div class="float-end d-none" id="descriptionEditActions">
                                <button class="btn btn-sm btn-outline-warning me-1" id="aiGenerateDescriptionBtn" title="Generate description using AI">
                                    <i class="fas fa-robot"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info me-1" id="aiImproveDescriptionBtn" title="Improve existing description using AI">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="searchWikipediaBtn" title="Search Wikipedia">
                                    <i class="fab fa-wikipedia-w"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-value">
                            <!-- Display Mode -->
                            <div id="descriptionDisplay">{{ entry.description or 'No description available' }}</div>
                            <!-- Edit Mode -->
                            <div id="descriptionEdit" class="d-none">
                                <textarea class="form-control" id="descriptionTextarea" rows="4" placeholder="Add a detailed description for this entry...">{{ entry.description if entry.description is not none else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Timeline Section -->
                {% if entry.intended_end_date and entry.show_end_dates %}
                <div class="mt-3">
                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-chart-line me-2"></i>Progress Timeline
                        </div>
                        <div class="info-value">
                            <div id="progressContainer" class="progress-timeline">
                                <div class="progress-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-2 gap-2">
                                    <small class="text-muted">
                                        <i class="fas fa-play-circle me-1"></i>
                                        Created: <span id="progress-start-date">{{ entry.created_at[:10] if entry.created_at else '' }}</span>
                                    </small>
                                    <small class="progress-status-text text-center" id="progressStatusText">
                                        <span id="progressPercentage">0</span>% Complete
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-flag-checkered me-1"></i>
                                        Target: <span id="progress-end-date">{{ entry.intended_end_date[:10] if entry.intended_end_date else '' }}</span>
                                    </small>
                                </div>
                                <div class="progress mb-3" style="height: 12px;">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: 0%;" 
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="progress-details">
                                    <div class="row g-2">
                                        <div class="col-12 col-md-4">
                                            <small class="text-muted d-block text-center text-md-start">
                                                <i class="fas fa-clock me-1"></i>
                                                <span id="daysElapsed">0</span> days elapsed
                                            </small>
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <small class="text-muted d-block text-center">
                                                <i class="fas fa-calendar-day me-1"></i>
                                                <span id="totalDays">0</span> total days
                                            </small>
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <small id="remainingTime" class="text-muted d-block text-center text-md-end">
                                                <i class="fas fa-hourglass-half me-1"></i>
                                                <span id="daysRemaining">0</span> days remaining
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Status Message for Entry Updates -->
                <div id="entryStatusMessage" class="mt-3 d-none"></div>
                
                <!-- Wikipedia Results (only shown during edit) -->
                <div id="wikipediaResults" class="mt-3 d-none">
                    <div class="content-section theme-section">
                        <div class="section-content">
                            <div class="section-header mb-3">
                                <h6 class="section-title">
                                    <i class="fab fa-wikipedia-w me-2"></i>Wikipedia Result
                                </h6>
                            </div>
                            <h6 id="wikipediaTitle" class="fw-bold"></h6>
                            <p id="wikipediaExtract" class="text-muted"></p>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-theme-primary" id="useWikipediaBtn">
                                    Use This Description
                                </button>
                                <a id="wikipediaLink" href="#" target="_blank" class="btn btn-sm btn-theme-secondary" rel="noopener noreferrer">
                                    <i class="fas fa-external-link-alt me-1"></i>View on Wikipedia
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collapsible Labels Section -->
        {% if entry.show_labels_section %}
        <div class="collapse mb-4" id="labelPrintingSection">
            <div class="content-section theme-section">
                <div class="section-content">
                    <div class="section-header mb-3">
                        <h4 class="section-title">
                            <i class="fas fa-tags me-2"></i>Label Printing
                        </h4>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="labelTypeSelect" class="form-label">Label Sheet Type</label>
                                <select class="form-select" id="labelTypeSelect">
                                    <option value="8_labels">8 Labels (2x4) - Larger</option>
                                    <option value="14_labels">14 Labels (2x7) - Smaller</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="labelRotationSelect" class="form-label">Label Orientation</label>
                                <select class="form-select" id="labelRotationSelect">
                                    <option value="0">Normal (0Â°)</option>
                                    <option value="90">Rotated (90Â°)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <div id="labelPositionContainer">
                                    <!-- Position grid will be populated dynamically -->
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <button type="button" class="btn btn-sm btn-theme-secondary" id="previewLabelBtn">
                                    <i class="fas fa-eye me-1"></i>Preview
                                </button>
                                <button type="button" class="btn btn-sm btn-theme-secondary" id="printLabelBtn">
                                    <i class="fas fa-print me-1"></i>Print
                                </button>
                                <button type="button" class="btn btn-sm btn-theme-secondary" id="downloadLabelPdfBtn">
                                    <i class="fas fa-download me-1"></i>Download PDF
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="labelPreviewContainer" class="text-center">
                                <div class="border rounded p-3" style="background-color: var(--theme-bg-surface, #f8f9fa);">
                                    <p class="text-muted">Click "Preview" to see how your label will look</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="labelStatusMessage" class="mt-3 d-none"></div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row g-4">
            <div class="col-lg-7">

                {% if entry.has_sensors %}
                <div class="content-section theme-section mb-4">
                    <div class="section-content">
                        <!-- Performance Alert (hidden by default, shown by JavaScript when needed) -->
                        <div id="performanceAlert" class="alert alert-info d-none mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-info-circle me-2 mt-1"></i>
                                <div>
                                    <strong>Performance Tip:</strong> 
                                    <span id="performanceMessage">Loading large datasets may be slower on mobile devices. Consider using the data limit or time range filters for better performance.</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section-header mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="section-title mb-0">
                                    <i class="fas fa-chart-line me-2"></i>Sensor Data
                                </h4>
                                <div class="d-flex align-items-center gap-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadSensorData()" title="Refresh sensor data and charts now">
                                        <i class="fas fa-sync me-1"></i>Refresh Now
                                    </button>
                                    <small class="text-muted">
                                        <span id="autoRefreshStatus">Auto-refresh: Every 60s</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart/Table Toggle Buttons -->
                        <div class="btn-group mb-3" role="group" aria-label="Data view options">
                            <input type="radio" class="btn-check" name="viewOptions" id="tableView">
                            <label class="btn btn-secondary" for="tableView">
                                <i class="fas fa-table me-1"></i>Table View
                            </label>
                            
                            <input type="radio" class="btn-check" name="viewOptions" id="chartView" checked>
                            <label class="btn btn-theme-primary" for="chartView">
                                <i class="fas fa-chart-line me-1"></i>Chart View
                            </label>
                        </div>
                        
                        <!-- Sensor Data Container (hidden by default) -->
                        <div id="sensorDataContainer" style="display: none;">
                            <p class="text-muted text-center" id="loadingSensorData">Loading sensor data...</p>
                            <!-- Sensor data will be loaded here -->
                        </div>
                        
                        <!-- Chart Container (visible by default) -->
                        <div id="sensorChartContainer">
                            <p class="text-muted text-center" id="loadingChart">Loading chart...</p>
                            <div class="mb-3">
                                <canvas id="sensorChart" width="400" height="200"></canvas>
                            </div>
                            
                            <!-- Chart Options -->
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="chartTypeSelect" class="form-label">Chart Type</label>
                                    <select class="form-select form-select-sm" id="chartTypeSelect">
                                        <option value="line">Line Chart</option>
                                        <option value="bar">Bar Chart</option>
                                        <option value="scatter">Scatter Plot</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="sensorTypeFilter" class="form-label">Filter by Sensor Type</label>
                                    <select class="form-select form-select-sm" id="sensorTypeFilter">
                                        <option value="all">All Sensor Types</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="timeRangeFilter" class="form-label">Time Range</label>
                                    <select class="form-select form-select-sm" id="timeRangeFilter">
                                        <option value="all">All Time</option>
                                        <option value="24h" selected>Last 24 Hours</option>
                                        <option value="7d">Last 7 Days</option>
                                        <option value="30d">Last 30 Days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-4">
                                    <label for="dataLimitFilter" class="form-label">Data Limit</label>
                                    <input type="number" class="form-control form-control-sm" id="dataLimitFilter" 
                                           placeholder="Enter number or leave empty for all" 
                                           min="1" max="10000" 
                                           title="Enter number of most recent data points to display (1-10000), or leave empty for all data">
                                    <div class="form-text">
                                        <small>Number of most recent data points to show (leave empty for all)</small>
                                        <small class="d-block d-md-none text-info mt-1">
                                            <i class="fas fa-mobile-alt me-1"></i>Mobile: Auto-limited to 50 points for better performance
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-theme-primary btn-sm mt-4" onclick="saveChartPreferences()">
                                        <i class="fas fa-save me-1"></i>Save Chart Settings
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-secondary btn-sm mt-4" onclick="resetChartPreferences()">
                                        <i class="fas fa-undo me-1"></i>Reset to Defaults
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 flex-wrap mt-3">
                            <button class="btn btn-theme-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#addSensorDataModal">
                                <i class="fas fa-plus-circle me-2"></i>Add Sensor Reading
                            </button>
                            <button class="btn btn-theme-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#addSharedSensorDataModal">
                                <i class="fas fa-share-alt me-2"></i>Add Shared Reading
                            </button>
                            <button class="btn btn-theme-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#deviceManagementModal" onclick="openDeviceManagement()">
                                <i class="fas fa-cogs me-2"></i>Manage Device Sensors
                            </button>
                        </div>

                        <!-- Shared Sensor Data Info -->
                        <div id="sharedSensorInfo" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="sharedSensorMessage">Some sensor readings are shared with other entries.</span>
                                <button class="btn btn-sm btn-outline-info ms-2" onclick="toggleSharedSensorDetails()">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </button>
                            </div>
                            <div id="sharedSensorDetails" class="mt-2" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Sensor Type</th>
                                                <th>Shared Readings</th>
                                                <th>Linked Entries</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sharedSensorDetailsBody">
                                            <!-- Shared sensor details will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="content-section theme-section mb-4" id="relatedRecordsSection" style="display: none;">
                    <div class="section-content">
                        <div class="section-header mb-3">
                            <h4 class="section-title">
                                <i class="fas fa-link me-2"></i>Related Records
                            </h4>
                        </div>
                        <div id="relatedRecordsContainer">
                            <p class="text-muted text-center" id="loadingRelationships">Loading relationships...</p>
                        </div>
                    </div>
                </div>

                <!-- Shared Relationship Opportunities Section -->
                <div class="content-section theme-section mb-4" id="sharedRelationshipsSection" style="display: none;">
                    <div class="section-content">
                        <div class="section-header mb-3">
                            <h4 class="section-title">
                                <i class="fas fa-share-alt me-2"></i>Suggested Relationships
                            </h4>
                            <small class="text-muted">Based on relationships from related entries</small>
                        </div>
                        <div id="sharedRelationshipsContainer">
                            <p class="text-muted text-center" id="loadingSharedRelationships">Loading suggestions...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <!-- AI Assistant Section -->
                <div class="content-section theme-section mb-4">
                    <div class="section-content">
                        <div class="section-header mb-3">
                            <h4 class="section-title">
                                <i class="fas fa-robot me-2"></i>AI Assistant
                            </h4>
                            <button class="btn btn-theme-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#aiChatSection" aria-expanded="false" aria-controls="aiChatSection">
                                <i class="fas fa-comments me-2"></i><span id="toggleAiChatText">Start Chat</span>
                            </button>
                        </div>

                        <div class="collapse" id="aiChatSection">
                            <div class="content-subsection">
                                <!-- AI Status Indicator -->
                                <div id="aiChatStatus" class="alert alert-info small mb-3" style="display: none;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="aiStatusMessage">Checking AI availability...</span>
                                </div>

                                <!-- Chat Messages Container -->
                                <div id="aiChatMessages" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: var(--theme-bg-surface, #f8f9fa);">
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-robot fa-3x mb-3"></i>
                                        <p>Ask me anything about this entry!</p>
                                        <p class="small">I can help you understand the entry's status, relationships, notes, and more.</p>
                                    </div>
                                </div>

                                <!-- Chat Input -->
                                <div class="input-group">
                                    <input type="text" class="form-control" id="aiChatInput" placeholder="Type your message..." disabled>
                                    <button class="btn btn-theme-primary" type="button" id="aiChatSendBtn" disabled>
                                        <i class="fas fa-paper-plane me-1"></i>Send
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="aiChatClearBtn" title="Clear chat history" disabled>
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                </div>
                                
                                <!-- Options row -->
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="aiIncludeAllNotes" disabled>
                                        <label class="form-check-label small" for="aiIncludeAllNotes">
                                            <i class="fas fa-sticky-note me-1"></i>Include all notes content
                                            <span class="text-muted">(provides deeper context)</span>
                                        </label>
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <span id="aiChatHint">Press Enter to send</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="content-section theme-section">
                    <div class="section-content">
                        <div class="section-header mb-3">
                            <h4 class="section-title">
                                <i class="fas fa-sticky-note me-2"></i>Notes
                            </h4>
                            <button class="btn btn-theme-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#newNoteForm" aria-expanded="false" aria-controls="newNoteForm">
                                <i class="fas fa-plus-circle me-2"></i><span id="toggleNewNoteText">Add New Note</span>
                            </button>
                        </div>

                        <!-- Notes Search and Filter Controls -->
                        <div class="mb-3" id="notesSearchFilters">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" 
                                               class="form-control" 
                                               id="notesSearchInput" 
                                               placeholder="Search notes content...">
                                        <button type="button" 
                                                class="btn btn-outline-secondary btn-sm" 
                                                id="clearNotesSearch"
                                                title="Clear search"
                                                style="display: none;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="notesTypeFilter">
                                        <option value="">All Types</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="notesSortOrder">
                                        <option value="newest">Newest First</option>
                                        <option value="oldest">Oldest First</option>
                                        <option value="title">By Title</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-12">
                                    <small class="text-muted" id="notesFilterStatus">
                                        <span id="notesCount">0</span> notes found
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Reminder Progress Summary -->
                        <div id="reminderProgressSummary" class="alert alert-info mb-3" style="display: none;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">
                                        <i class="fas fa-bell me-2"></i>Reminder Progress
                                    </h6>
                                    <div id="reminderProgressContent">
                                        <!-- Dynamic content will be inserted here -->
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="viewAllRemindersBtn">
                                        <i class="fas fa-list me-1"></i>View All
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="collapse mb-3" id="newNoteForm">
                            <div class="content-subsection">
                                <!-- Core Note Fields -->
                                <div class="mb-3">
                                    <label for="noteTitleInput" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="noteTitleInput" placeholder="Provide a title">
                                </div>
                                <div class="mb-3">
                                    <label for="noteTypeSelect" class="form-label">Type</label>
                                    <select class="form-select" id="noteTypeSelect">
                                        {# Options will be dynamically populated by JavaScript based on entry.note_types #}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="newNoteTextarea" class="form-label">Notes</label>
                                    <textarea class="form-control" id="newNoteTextarea" rows="4" placeholder="Type your new note here..."></textarea>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="aiGenerateNoteBtn">
                                            <i class="fas fa-magic me-1 d-none d-md-inline"></i>
                                            <span class="d-none d-md-inline">AI Generate</span>
                                            <i class="fas fa-magic d-md-none"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="aiImproveNoteBtn">
                                            <i class="fas fa-wand-magic-sparkles me-1"></i>
                                            <span class="d-none d-md-inline">AI Improve</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Optional Controls Toggle Buttons -->
                                <div class="mb-3">
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="toggleAssociateBtn" 
                                                data-bs-toggle="collapse" data-bs-target="#associateSection" aria-expanded="false">
                                            <i class="fas fa-link me-1"></i>Associate <i class="fas fa-chevron-down ms-1"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" id="toggleReminderBtn"
                                                data-bs-toggle="collapse" data-bs-target="#reminderSection" aria-expanded="false">
                                            <i class="fas fa-bell me-1"></i>Reminder <i class="fas fa-chevron-down ms-1"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" id="toggleUploadBtn"
                                                data-bs-toggle="collapse" data-bs-target="#uploadSection" aria-expanded="false">
                                            <i class="fas fa-paperclip me-1"></i>Upload <i class="fas fa-chevron-down ms-1"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" id="toggleBookmarksBtn"
                                                data-bs-toggle="collapse" data-bs-target="#bookmarksSection" aria-expanded="false">
                                            <i class="fas fa-bookmark me-1"></i>Bookmarks <i class="fas fa-chevron-down ms-1"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Associated Entries Section (Collapsible) -->
                                <div class="collapse mb-3" id="associateSection">
                                    <div class="border rounded p-3 bg-light">
                                        <div class="mb-3">
                                            <label for="associatedEntriesSelect" class="form-label">
                                                <i class="fas fa-link me-1"></i>Associate with Additional Entries
                                            </label>
                                            <select class="form-select" id="associatedEntriesSelect" multiple>
                                                <option value="" disabled>Loading entries...</option>
                                            </select>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Select additional entries to associate this note with. The note will appear in all selected entries.
                                            </div>
                                            <div class="mt-2">
                                                <div id="selectedAssociationsDisplay" class="small text-info" style="display: none;">
                                                    <!-- Selected associations will be displayed here -->
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAssociationsBtn" style="display: none;">
                                                    <i class="fas fa-times me-1"></i>Clear All Associations
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Reminder Section (Collapsible) -->
                                <div class="collapse mb-3" id="reminderSection">
                                    <div class="border rounded p-3 bg-light">
                                        <div class="mb-3">
                                            <label for="reminderDateInput" class="form-label">
                                                <i class="fas fa-bell text-warning me-1"></i>Set Reminder Date & Time
                                            </label>
                                            <input type="datetime-local" class="form-control" id="reminderDateInput" 
                                                   min="" placeholder="Choose reminder date and time">
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i> 
                                                A notification will appear at this exact date and time. 
                                                <strong>Note:</strong> If you select a date, you must also select a time (defaults to 1:00 AM if not specified).
                                            </div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-warning" onclick="clearReminder()">
                                                    <i class="fas fa-times me-1"></i>Clear
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Section (Collapsible) -->
                                <div class="collapse mb-3" id="uploadSection">
                                    <div class="border rounded p-3 bg-light">
                                        <div class="mb-3">
                                            <label for="fileUploadInput" class="form-label">
                                                <i class="fas fa-paperclip me-1"></i>Upload Files
                                            </label>
                                            <input type="file" class="form-control" id="fileUploadInput" multiple>
                                            <div id="selectedFilesInfo" class="mt-2 small text-muted">No files selected.</div>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i> 
                                                <span id="supportedFileTypes">
                                                    {% set file_types = allowed_file_types.split(',') %}
                                                    Supported file types: 
                                                    {% set image_types = [] %}
                                                    {% set doc_types = [] %}
                                                    {% set archive_types = [] %}
                                                    {% set video_types = [] %}
                                                    {% set audio_types = [] %}
                                                    {% set other_types = [] %}
                                                    {% for ext in file_types %}
                                                        {% set ext = ext.strip().upper() %}
                                                        {% if ext in ['JPG', 'JPEG', 'PNG', 'GIF', 'WEBP', 'SVG'] %}
                                                            {% if image_types.append(ext) %}{% endif %}
                                                        {% elif ext in ['PDF', 'DOC', 'DOCX', 'TXT', 'XLS', 'XLSX', 'PPT', 'PPTX'] %}
                                                            {% if doc_types.append(ext) %}{% endif %}
                                                        {% elif ext in ['ZIP', 'RAR', '7Z', 'TAR', 'GZ'] %}
                                                            {% if archive_types.append(ext) %}{% endif %}
                                                        {% elif ext in ['MP4', 'AVI', 'MOV', 'WMV', 'FLV', 'WEBM', 'MKV'] %}
                                                            {% if video_types.append(ext) %}{% endif %}
                                                        {% elif ext in ['MP3', 'WAV', 'FLAC', 'AAC', 'OGG'] %}
                                                            {% if audio_types.append(ext) %}{% endif %}
                                                        {% else %}
                                                            {% if other_types.append(ext) %}{% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    {% if image_types %}ðŸ“· Images ({{ image_types|join(', ') }}){% endif %}
                                                    {% if doc_types %}{% if image_types %}, {% endif %}ðŸ“„ Documents ({{ doc_types|join(', ') }}){% endif %}
                                                    {% if video_types %}{% if image_types or doc_types %}, {% endif %}ðŸŽ¥ Videos ({{ video_types|join(', ') }}){% endif %}
                                                    {% if audio_types %}{% if image_types or doc_types or video_types %}, {% endif %}ðŸŽµ Audio ({{ audio_types|join(', ') }}){% endif %}
                                                    {% if archive_types %}{% if image_types or doc_types or video_types or audio_types %}, {% endif %}ðŸ“¦ Archives ({{ archive_types|join(', ') }}){% endif %}
                                                    {% if other_types %}{% if image_types or doc_types or video_types or audio_types or archive_types %}, {% endif %}{{ other_types|join(', ') }}{% endif %}
                                                </span>
                                                Max file size: {{ max_file_size }}MB
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- URL Bookmarks Section (Collapsible) -->
                                <div class="collapse mb-3" id="bookmarksSection">
                                    <div class="border rounded p-3 bg-light">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-bookmark text-success me-1"></i>URL Bookmarks
                                            </label>
                                            <div id="urlBookmarksList">
                                                <!-- Dynamic bookmark entries will be inserted here -->
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-success" id="addBookmarkBtn">
                                                <i class="fas fa-plus me-1"></i>Add Bookmark
                                            </button>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i> 
                                                Add reference links with friendly names for easy access.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-grid">
                                    <button type="button" class="btn btn-theme-primary" id="addNoteBtn">
                                        <i class="fas fa-plus-circle me-2"></i>Add Note
                                    </button>
                                </div>

                                <!-- Status Message -->
                                <div id="noteStatusMessage" class="mt-3"></div>
                            </div>
                        </div>

                        <div id="notesList" class="mt-4">
                            <p class="text-muted" id="noNotesMessage">Loading notes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Detail Modal (Still a modal for full view) -->
    <div class="modal fade" id="noteDetailModal" tabindex="-1" aria-labelledby="noteDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="noteDetailModalLabel">Note Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Title:</strong> <span id="modalNoteTitle"></span></p>
                    <p><strong>Type:</strong> <span id="modalNoteType"></span></p>
                    <p><strong>Created On:</strong> <span id="modalNoteCreated"></span></p>
                    
                    <!-- Note Relationships Section -->
                    <div id="modalNoteRelationships" style="display: none;">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-sitemap me-2"></i>Entry Relationships
                                </h6>
                                <span id="modalRelationshipType" class="badge ms-2"></span>
                            </div>
                            <div id="modalRelationshipDetails">
                                <!-- Dynamic relationship details will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Reminder Section -->
                    <div id="modalNoteReminder" style="display: none;">
                        <div class="reminder-status-card mb-3 p-3 border rounded">
                            <div id="reminderDisplayMode">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h6 class="mb-0">
                                        <i class="fas fa-bell me-2"></i>Reminder Status
                                    </h6>
                                    <span id="modalReminderStatus" class="badge"></span>
                                </div>
                                <div class="reminder-details">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">Scheduled for:</small>
                                            <div id="modalReminderDate" class="fw-bold"></div>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="editReminderBtn">
                                                <i class="fas fa-edit me-1"></i>Edit
                                            </button>
                                        </div>
                                    </div>
                                    <div id="reminderProgress" class="mt-2">
                                        <!-- Dynamic progress info will be inserted here -->
                                    </div>
                                </div>
                            </div>
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                            </p>
                        </div>
                        
                        <!-- Edit Reminder Form -->
                        <div id="reminderEditMode" style="display: none;">
                            <div class="mb-3">
                                <label for="editReminderDate" class="form-label">Reminder Date:</label>
                                <input type="date" class="form-control" id="editReminderDate">
                            </div>
                            <div class="mb-3">
                                <label for="editReminderTime" class="form-label">Reminder Time:</label>
                                <input type="time" class="form-control" id="editReminderTime" value="01:00">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-success" id="saveReminderBtn">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" id="cancelReminderEditBtn">
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" id="deleteReminderBtn">
                                    <i class="fas fa-trash me-1"></i>Remove Reminder
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <h6>Content:</h6>
                    <div id="noteContentDisplay">
                        <p id="modalNoteContent"></p>
                        
                        <!-- URL Bookmarks Display -->
                        <div id="modalBookmarksDisplay" style="display: none;">
                            <h6 class="mt-3">URL Bookmarks:</h6>
                            <div id="modalBookmarksList" class="list-group list-group-flush">
                                <!-- Bookmarks will be populated here -->
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-sm btn-primary" id="editNoteContentBtn">
                            <i class="fas fa-edit me-1"></i>Edit Note
                        </button>
                    </div>
                    
                    <!-- Edit Note Content Form -->
                    <div id="noteContentEditMode" style="display: none;">
                        <div class="mb-3">
                            <label for="editNoteTitle" class="form-label">Note Title:</label>
                            <input type="text" class="form-control" id="editNoteTitle">
                        </div>
                        <div class="mb-3">
                            <label for="editNoteText" class="form-label">Note Content:</label>
                            <textarea class="form-control" id="editNoteText" rows="4"></textarea>
                            <!-- AI Assistance Buttons for Note Editing -->
                            <div class="mt-2 d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-info ai-btn" id="aiEditGenerateNoteBtn" title="Generate note content using AI">
                                    <i class="fas fa-magic me-1"></i>
                                    <span class="d-none d-sm-inline">AI Generate</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary ai-btn" id="aiEditImproveNoteBtn" title="Improve existing note content using AI">
                                    <i class="fas fa-wand-magic-sparkles me-1"></i>
                                    <span class="d-none d-sm-inline">AI Improve</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- URL Bookmarks for Edit Mode -->
                        <div class="mb-3">
                            <label class="form-label">URL Bookmarks:</label>
                            <div id="editUrlBookmarksContainer">
                                <div id="editUrlBookmarksList">
                                    <!-- Dynamic bookmark fields will be added here -->
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="editAddBookmarkBtn">
                                    <i class="fas fa-plus me-1"></i>Add Bookmark
                                </button>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-success" id="saveNoteContentBtn">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" id="cancelNoteContentEditBtn">
                                Cancel
                            </button>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Attached Files:</h6>
                        <button type="button" class="btn btn-sm btn-success" id="addAttachmentsBtn">
                            <i class="fas fa-paperclip me-1"></i>Add Files
                        </button>
                    </div>
                    
                    <!-- Add Attachments Form -->
                    <div id="addAttachmentsForm" style="display: none;" class="mb-3">
                        <div class="mb-3">
                            <label for="additionalFiles" class="form-label">Select files to attach:</label>
                            <input type="file" class="form-control" id="additionalFiles" multiple>
                            <div class="form-text">Maximum file size: {{ max_file_size }}MB per file</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-success" id="uploadAdditionalFilesBtn">
                                <i class="fas fa-upload me-1"></i>Upload Files
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" id="cancelAddAttachmentsBtn">
                                Cancel
                            </button>
                        </div>
                    </div>
                    
                    <div id="modalNoteFiles" class="row row-cols-1 row-cols-md-2 g-2">
                        <div class="col" id="noAttachmentsPlaceholder">
                            <div class="placeholder-section" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                                <p>No files attached yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="deleteNoteFromModalBtn">
                        <i class="fas fa-trash-alt me-1"></i> Delete Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Relationship Modal (Still a modal) -->
    <div class="modal fade" id="addRelatedEntryModal" tabindex="-1" aria-labelledby="addRelatedEntryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRelatedEntryModalLabel">Add Related <span id="modalRelatedEntryTypeLabel"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addRelatedEntryForm">
                        <input type="hidden" id="currentRelationshipDefId">
                        <p>Relating from: <strong>{{ entry.title }} ({{ entry.entry_type_label }})</strong></p>

                        <div class="mb-3">
                            <label for="relatedEntrySelect" class="form-label">Select Existing <span id="selectLabelEntryType"></span>:</label>
                            <select class="form-select" id="relatedEntrySelect">
                                <option value="">Search or Select...</option>
                            </select>
                        </div>
                        <div class="mb-3" id="newRelatedEntryNameGroup" style="display:none;">
                            <label for="newRelatedEntryName" class="form-label">New <span id="newLabelEntryType"></span> Name:</label>
                            <input type="text" class="form-control" id="newRelatedEntryName">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="createNewRelatedEntryCheckbox">
                            <label class="form-check-label" for="createNewRelatedEntryCheckbox">
                                Create a New <span id="createLabelEntryType"></span> instead
                            </label>
                        </div>

                        <div class="row" id="quantityUnitFields" style="display: none;">
                            <div class="col-md-6 mb-3">
                                <label for="relatedQuantity" class="form-label">Quantity:</label>
                                <input type="number" step="any" class="form-control" id="relatedQuantity">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="relatedUnit" class="form-label">Unit:</label>
                                <input type="text" class="form-control" id="relatedUnit">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-theme-primary">Add Relationship</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Relationship Modal -->
    <div class="modal fade" id="addNewRelationshipModal" tabindex="-1" aria-labelledby="addNewRelationshipModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addNewRelationshipModalLabel">Add New Relationship</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addNewRelationshipForm">
                        <div class="mb-3">
                            <label for="newEntryName" class="form-label">Entry Name</label>
                            <input type="text" class="form-control" id="newEntryName" placeholder="Enter new entry name" required>
                        </div>
                        <div class="mb-3">
                            <label for="newEntryDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="newEntryDescription" rows="3" placeholder="Enter description"></textarea>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-theme-secondary" id="searchWikipediaNewRelationBtn">
                                    <i class="fab fa-wikipedia-w me-1"></i> Search Wikipedia
                                </button>
                            </div>
                        </div>
                        <div id="wikipediaNewRelationResults" class="mb-3 d-none">
                            <div class="card border-info">
                                <div class="card-header" style="background-color: var(--theme-bg-surface, #f8f9fa); border-bottom: 1px solid var(--bs-border-color, #dee2e6);">
                                    <h6 class="mb-0"><i class="fab fa-wikipedia-w me-1"></i> Wikipedia Result</h6>
                                </div>
                                <div class="card-body">
                                    <h6 id="wikipediaNewRelationTitle" class="card-title"></h6>
                                    <p id="wikipediaNewRelationExtract" class="card-text" style="font-size: 0.9em; max-height: 100px; overflow-y: auto;"></p>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-theme-secondary" id="useWikipediaNewRelationBtn">Use This Description</button>
                                        <a id="wikipediaNewRelationLink" href="#" target="_blank" class="btn btn-sm btn-theme-secondary">View on Wikipedia</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-theme-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Existing Relationship Modal -->
    <div class="modal fade" id="addExistingRelationshipModal" tabindex="-1" aria-labelledby="addExistingRelationshipModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addExistingRelationshipModalLabel">Add Existing Relationship</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addExistingRelationshipForm">
                        <div class="mb-3">
                            <label for="existingEntrySelect" class="form-label">Select Entry</label>
                            <select class="form-select" id="existingEntrySelect" required>
                                <option value="" disabled selected>Select an entry</option>
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-theme-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Management Modal -->
    <div class="modal fade" id="deviceManagementModal" tabindex="-1" aria-labelledby="deviceManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceManagementModalLabel">
                        <i class="fas fa-microchip me-2"></i>Device Sensor Management
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Manage your ESP32 devices and configure which sensor data gets automatically recorded to this entry.</strong>
                        <br>Use this interface to discover devices, configure data points, and set up automatic polling.
                    </div>
                    
                    <!-- Device Management Content will be loaded here -->
                    <div id="deviceManagementContent">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="text-muted mt-2">Loading device management interface...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="loadDeviceManagementContent()">
                        <i class="fas fa-sync me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Quantity/Unit Modal -->
    <div class="modal fade" id="editQuantityUnitModal" tabindex="-1" aria-labelledby="editQuantityUnitModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editQuantityUnitModalLabel">Edit Quantity and Unit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editQuantityUnitForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editQuantityInput" class="form-label">Quantity:</label>
                                    <input type="number" step="any" class="form-control" id="editQuantityInput" placeholder="e.g., 2.5">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUnitInput" class="form-label">Unit:</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="editUnitInput" placeholder="e.g., kg, cups" list="unitSuggestions">
                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Common units">
                                            <i class="fas fa-list"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" id="unitSuggestionsDropdown">
                                            <!-- Unit suggestions will be populated here -->
                                        </ul>
                                    </div>
                                    <datalist id="unitSuggestions">
                                        <!-- Unit suggestions for autocomplete -->
                                    </datalist>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                <strong>Common units:</strong> g, kg, ml, l, cup, tbsp, tsp, pcs, units, each
                            </small>
                        </div>
                        <input type="hidden" id="editRelationshipId">
                        <button type="submit" class="btn btn-theme-primary">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Sensor Data Modal -->
    {% if entry.has_sensors %}
    <div class="modal fade" id="addSensorDataModal" tabindex="-1" aria-labelledby="addSensorDataModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSensorDataModalLabel">Add Sensor Reading</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addSensorDataForm">
                        <div class="mb-3">
                            <label for="sensorTypeInput" class="form-label">Sensor Type:</label>
                            <select class="form-select" id="sensorTypeInput" required>
                                <option value="" disabled selected>Select a sensor type</option>
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sensorValueInput" class="form-label">Value:</label>
                            <input type="text" class="form-control" id="sensorValueInput" placeholder="e.g., 23.5Â°C, 65%, 1013.2 hPa" required>
                        </div>
                        <div class="mb-3">
                            <label for="sensorRecordedAt" class="form-label">Recorded At:</label>
                            <input type="datetime-local" class="form-control" id="sensorRecordedAt">
                        </div>
                        <button type="submit" class="btn btn-theme-primary">Add Reading</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Add Shared Sensor Data Modal -->
    {% if entry.has_sensors %}
    <div class="modal fade" id="addSharedSensorDataModal" tabindex="-1" aria-labelledby="addSharedSensorDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSharedSensorDataModalLabel">Add Shared Sensor Reading</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addSharedSensorDataForm">
                        <div class="mb-3">
                            <label for="sharedSensorTypeInput" class="form-label">Sensor Type</label>
                            <select class="form-select" id="sharedSensorTypeInput" required>
                                <option value="" disabled selected>Select a sensor type</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sharedSensorValueInput" class="form-label">Value</label>
                            <input type="text" class="form-control" id="sharedSensorValueInput" placeholder="e.g., 25.5" required>
                        </div>
                        <div class="mb-3">
                            <label for="sharedSensorRecordedAt" class="form-label">Recorded At</label>
                            <input type="datetime-local" class="form-control" id="sharedSensorRecordedAt">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Additional Entries to Link</label>
                            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" id="entrySearchInput" placeholder="Search entries...">
                                </div>
                                <div id="additionalEntriesContainer">
                                    <small class="text-muted">Loading available entries...</small>
                                </div>
                            </div>
                            <div class="form-text">
                                This sensor reading will be linked to the current entry and any additional entries you select above.
                            </div>
                        </div>
                        <button type="submit" class="btn btn-theme-primary">Add Shared Reading</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data injected from Flask/Jinja
        const entryId = "{{ entry.id }}";
        const entryTypeNoteTypesRaw = "{{ entry.note_types | default('General', true) }}";
        const currentEntryTypeId = "{{ entry.entry_type_id }}"; // Needed for related records
        const currentEntryName = {{ entry.title|tojson }}; // Using title as name for consistency
        const currentEntryTypeLabel = {{ entry.entry_type_label|tojson }};
        const hasSensors = {{ entry.has_sensors|tojson }}; // Convert to JavaScript boolean
        const enabledSensorTypes = "{{ entry.enabled_sensor_types | default('', true) }}"; // Entry type's enabled sensor types

        // DOM elements for Notes and Description (existing)
        const noteTitleInput = document.getElementById('noteTitleInput');
        const noteTypeSelect = document.getElementById('noteTypeSelect');
        const newNoteTextarea = document.getElementById('newNoteTextarea');
        const fileUploadInput = document.getElementById('fileUploadInput');
        const selectedFilesInfo = document.getElementById('selectedFilesInfo');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const notesList = document.getElementById('notesList');
        const noNotesMessage = document.getElementById('noNotesMessage');
        const noteStatusMessage = document.getElementById('noteStatusMessage');
        
        // New DOM elements for Associated Entries
        const associatedEntriesSelect = document.getElementById('associatedEntriesSelect');
        const selectedAssociationsDisplay = document.getElementById('selectedAssociationsDisplay');
        const clearAssociationsBtn = document.getElementById('clearAssociationsBtn');
        
        // Notes search and filter elements
        const notesSearchInput = document.getElementById('notesSearchInput');
        const clearNotesSearch = document.getElementById('clearNotesSearch');
        const notesTypeFilter = document.getElementById('notesTypeFilter');
        const notesSortOrder = document.getElementById('notesSortOrder');
        const notesCount = document.getElementById('notesCount');
        const notesFilterStatus = document.getElementById('notesFilterStatus');
        
        const descriptionTextarea = document.getElementById('descriptionTextarea');
        const entryTitleInput = document.getElementById('entryTitleInput');
        const entryTypeSelect = document.getElementById('entryTypeSelect');
        const statusSelect = document.getElementById('statusSelect');
        {% if entry.show_end_dates %}
        const intendedEndDateInput = document.getElementById('intendedEndDateInput');
        const actualEndDateInput = document.getElementById('actualEndDateInput');
        {% endif %}
        
        // New inline editing elements
        const editEntryBtn = document.getElementById('editEntryBtn');
        const saveEntryBtn = document.getElementById('saveEntryBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const entryTitleDisplay = document.getElementById('entryTitleDisplay');
        const entryTypeDisplay = document.getElementById('entryTypeDisplay');
        const statusDisplay = document.getElementById('statusDisplay');
        const detailsDisplay = document.getElementById('detailsDisplay');
        const detailsEdit = document.getElementById('detailsEdit');
        const datesDisplay = document.getElementById('datesDisplay');
        const datesEdit = document.getElementById('datesEdit');
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        const descriptionEdit = document.getElementById('descriptionEdit');
        const descriptionEditActions = document.getElementById('descriptionEditActions');
        const entryStatusMessage = document.getElementById('entryStatusMessage');
        
        // Remove old elements that no longer exist
        const intendedEndDateDisplay = document.getElementById('intended-end-date-display');
        const actualEndDateDisplay = document.getElementById('actual-end-date-display');
        const createdAtSpan = document.getElementById('created-at');
        const newNoteFormCollapseElement = document.getElementById('newNoteForm');
        const toggleNewNoteText = document.getElementById('toggleNewNoteText');

        // Modal elements for note detail (existing)
        const noteDetailModal = new bootstrap.Modal(document.getElementById('noteDetailModal'));
        const modalNoteTitle = document.getElementById('modalNoteTitle');
        const modalNoteType = document.getElementById('modalNoteType');
        const modalNoteCreated = document.getElementById('modalNoteCreated');
        const modalNoteContent = document.getElementById('modalNoteContent');
        const modalNoteFiles = document.getElementById('modalNoteFiles');
        const deleteNoteFromModalBtn = document.getElementById('deleteNoteFromModalBtn');

        // Reminder editing elements
        const editReminderBtn = document.getElementById('editReminderBtn');
        const reminderDisplayMode = document.getElementById('reminderDisplayMode');
        const reminderEditMode = document.getElementById('reminderEditMode');
        const editReminderDate = document.getElementById('editReminderDate');
        const editReminderTime = document.getElementById('editReminderTime');
        const saveReminderBtn = document.getElementById('saveReminderBtn');
        const cancelReminderEditBtn = document.getElementById('cancelReminderEditBtn');
        const deleteReminderBtn = document.getElementById('deleteReminderBtn');

        // Note content editing elements
        const editNoteContentBtn = document.getElementById('editNoteContentBtn');
        const noteContentDisplay = document.getElementById('noteContentDisplay');
        const noteContentEditMode = document.getElementById('noteContentEditMode');
        const editNoteTitle = document.getElementById('editNoteTitle');
        const editNoteText = document.getElementById('editNoteText');
        const saveNoteContentBtn = document.getElementById('saveNoteContentBtn');
        const cancelNoteContentEditBtn = document.getElementById('cancelNoteContentEditBtn');

        // Attachment management elements
        const addAttachmentsBtn = document.getElementById('addAttachmentsBtn');
        const addAttachmentsForm = document.getElementById('addAttachmentsForm');
        const additionalFiles = document.getElementById('additionalFiles');
        const uploadAdditionalFilesBtn = document.getElementById('uploadAdditionalFilesBtn');
        const cancelAddAttachmentsBtn = document.getElementById('cancelAddAttachmentsBtn');
        const noAttachmentsPlaceholder = document.getElementById('noAttachmentsPlaceholder');

        // Map to store fetched notes by ID for quick lookup
        let loadedNotes = new Map();
        let currentNoteIdInModal = null; // To keep track of which note is open in the modal
        
        // Store all notes for filtering and searching
        let allNotes = [];
        let filteredNotes = [];
        
        let noteTypeColors = null; // Cache for note type colors

        // Function to get note type color
        function getNoteTypeColor(noteType) {
            // Default colors for standard note types
            const defaultColors = {
                'general': '#0dcaf0',
                'info': '#0dcaf0',
                'important': '#dc3545',
                'critical': '#dc3545',
                'warning': '#fd7e14',
                'caution': '#fd7e14',
                'success': '#198754',
                'completed': '#198754'
            };
            
            // Check if we have custom note types loaded
            if (noteTypeColors && noteTypeColors[noteType.toLowerCase()]) {
                return noteTypeColors[noteType.toLowerCase()];
            }
            
            // Fall back to default colors
            const lowerType = noteType.toLowerCase();
            return defaultColors[lowerType] || '#6f42c1'; // Purple for unknown types
        }

        // Function to format sensor timestamps for display
        function formatSensorTimestamp(timestamp) {
            try {
                // Handle various timestamp formats
                let date;
                
                // If timestamp doesn't end with 'Z' and doesn't have timezone info, 
                // assume it's in local time (common for stored timestamps)
                if (!timestamp.endsWith('Z') && !timestamp.includes('+') && !timestamp.includes('-', 10)) {
                    // Treat as local time by appending local timezone offset
                    date = new Date(timestamp);
                } else {
                    // Parse as is (UTC or timezone-aware)
                    date = new Date(timestamp);
                }
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.warn('Invalid timestamp:', timestamp);
                    return timestamp; // Return original if parsing fails
                }
                
                // Format with local timezone
                return date.toLocaleString(undefined, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false // Use 24-hour format for consistency
                });
            } catch (error) {
                console.error('Error formatting timestamp:', timestamp, error);
                return timestamp; // Return original if error occurs
            }
        }

        // Load custom note type colors from system parameters
        async function loadNoteTypeColors() {
            try {
                const response = await fetch('/api/system_params');
                const params = await response.json();
                
                if (params.custom_note_types) {
                    const customTypes = JSON.parse(params.custom_note_types);
                    noteTypeColors = {};
                    
                    customTypes.forEach(noteType => {
                        noteTypeColors[noteType.name.toLowerCase()] = noteType.color;
                    });
                }
            } catch (error) {
                console.error('Error loading note type colors:', error);
            }
        }

        // DOM elements for Related Records (new)
        const relatedRecordsContainer = document.getElementById('relatedRecordsContainer');
        const loadingRelationships = document.getElementById('loadingRelationships');
        const addRelatedEntryModal = new bootstrap.Modal(document.getElementById('addRelatedEntryModal'));
        const addRelatedEntryForm = document.getElementById('addRelatedEntryForm');
        const relatedEntrySelect = document.getElementById('relatedEntrySelect');
        const createNewRelatedEntryCheckbox = document.getElementById('createNewRelatedEntryCheckbox');
        const newRelatedEntryNameGroup = document.getElementById('newRelatedEntryNameGroup');
        const newRelatedEntryName = document.getElementById('newRelatedEntryName');
        const quantityUnitFields = document.getElementById('quantityUnitFields');
        const relatedQuantity = document.getElementById('relatedQuantity');
        const relatedUnit = document.getElementById('relatedUnit');

        let allRelationshipDefinitions = []; // Store definitions for easy lookup
        let allPossibleRelatedEntries = {}; // Cache entries for dropdowns by type ID

        // Chart variables for sensor data
        let sensorChart = null;
        let allSensorData = []; // Store all sensor data for filtering and charting
        let chartTypeSelect, sensorTypeFilter, timeRangeFilter, tableViewBtn, chartViewBtn, sensorChartContainer;

        // Format the created_at timestamp
        if (createdAtSpan && createdAtSpan.textContent) {
            try {
                const date = new Date(createdAtSpan.textContent);
                createdAtSpan.textContent = date.toLocaleString();
            } catch (e) {
                console.error("Error parsing date:", e);
            }
        }

        // Function to update the consolidated dates display
        function updateDatesDisplay(intendedEndDate, actualEndDate) {
            {% if entry.show_end_dates %}
            if (datesDisplay) {
                let datesHtml = '<div><strong>Created On:</strong> <span id="created-at">' + createdAtSpan.textContent + '</span></div>';
                
                if (intendedEndDate && intendedEndDate !== '') {
                    datesHtml += '<div><strong>Intended End:</strong> <span id="intended-end-date-display">' + intendedEndDate + '</span></div>';
                }
                
                if (actualEndDate && actualEndDate !== '') {
                    datesHtml += '<div><strong>Actual End:</strong> <span id="actual-end-date-display">' + actualEndDate + '</span></div>';
                }
                
                datesDisplay.innerHTML = datesHtml;
            }
            
            // Update progress timeline if we have the necessary dates
            const createdDate = "{{ entry.created_at[:10] if entry.created_at else '' }}";
            if (createdDate && intendedEndDate && intendedEndDate !== '') {
                updateProgressTimeline(createdDate, intendedEndDate, actualEndDate);
            }
            {% endif %}
        }

        // Function to update the consolidated details display
        function updateDetailsDisplay(entryType, status) {
            if (detailsDisplay) {
                let detailsHtml = '<div><strong>Type:</strong> <span id="entryTypeDisplay">' + entryType + '</span></div>';
                detailsHtml += '<div><strong>Status:</strong> <span id="statusDisplay">' + status + '</span></div>';
                detailsDisplay.innerHTML = detailsHtml;
                
                // Update individual references for compatibility
                const updatedEntryTypeDisplay = document.getElementById('entryTypeDisplay');
                const updatedStatusDisplay = document.getElementById('statusDisplay');
                if (updatedEntryTypeDisplay) updatedEntryTypeDisplay.textContent = entryType;
                if (updatedStatusDisplay) updatedStatusDisplay.textContent = status;
            }
        }

        // Progress Timeline Functions
        function initializeProgressTimeline() {
            {% if entry.intended_end_date and entry.show_end_dates %}
            const createdDate = "{{ entry.created_at[:10] if entry.created_at else '' }}";
            const intendedEndDate = "{{ entry.intended_end_date[:10] if entry.intended_end_date else '' }}";
            const actualEndDate = "{{ entry.actual_end_date[:10] if entry.actual_end_date else '' }}";
            
            if (createdDate && intendedEndDate) {
                updateProgressTimeline(createdDate, intendedEndDate, actualEndDate);
            }
            {% endif %}
        }

        function updateProgressTimeline(createdDate, intendedEndDate, actualEndDate = null) {
            const progressContainer = document.getElementById('progressContainer');
            if (!progressContainer) return;

            const progressBar = document.getElementById('progressBar');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressStatusText = document.getElementById('progressStatusText');
            const daysElapsed = document.getElementById('daysElapsed');
            const totalDays = document.getElementById('totalDays');
            const daysRemaining = document.getElementById('daysRemaining');
            const remainingTime = document.getElementById('remainingTime');

            try {
                const created = new Date(createdDate);
                const intended = new Date(intendedEndDate);
                const now = new Date();
                const actual = actualEndDate ? new Date(actualEndDate) : null;

                // Calculate total project duration
                const totalMs = intended.getTime() - created.getTime();
                const totalDaysNum = Math.ceil(totalMs / (1000 * 60 * 60 * 24));

                // Calculate elapsed time (from creation to now, or to actual end if completed)
                const referenceDate = actual || now;
                const elapsedMs = referenceDate.getTime() - created.getTime();
                const elapsedDaysNum = Math.floor(elapsedMs / (1000 * 60 * 60 * 24));

                // Calculate progress percentage
                let progressPercent = Math.min(Math.max((elapsedMs / totalMs) * 100, 0), 100);
                
                // Calculate remaining days
                const remainingMs = intended.getTime() - now.getTime();
                const remainingDaysNum = Math.ceil(remainingMs / (1000 * 60 * 60 * 24));

                // Update display values
                if (daysElapsed) daysElapsed.textContent = Math.max(0, elapsedDaysNum);
                if (totalDays) totalDays.textContent = Math.max(1, totalDaysNum);
                if (daysRemaining) daysRemaining.textContent = Math.max(0, remainingDaysNum);

                // Determine status and styling
                let statusClass = '';
                let statusText = '';
                let barClass = '';

                if (actual) {
                    // Project is completed
                    progressPercent = 100;
                    statusClass = 'text-complete';
                    barClass = 'progress-complete';
                    statusText = 'Completed';
                    if (remainingTime) {
                        remainingTime.innerHTML = '<i class="fas fa-check-circle me-1"></i>Completed';
                        remainingTime.className = 'text-success';
                    }
                } else if (remainingDaysNum < 0) {
                    // Project is overdue
                    statusClass = 'text-overdue';
                    barClass = 'progress-overdue';
                    statusText = `Overdue by ${Math.abs(remainingDaysNum)} day${Math.abs(remainingDaysNum) !== 1 ? 's' : ''}`;
                    if (remainingTime) {
                        remainingTime.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>${Math.abs(remainingDaysNum)} day${Math.abs(remainingDaysNum) !== 1 ? 's' : ''} overdue`;
                        remainingTime.className = 'text-danger';
                    }
                } else if (remainingDaysNum <= 3) {
                    // Approaching deadline
                    statusClass = 'text-near-deadline';
                    barClass = 'progress-near-deadline';
                    statusText = `${Math.round(progressPercent)}% Complete (Due Soon)`;
                    if (remainingTime) {
                        remainingTime.innerHTML = `<i class="fas fa-hourglass-half me-1"></i>${remainingDaysNum} day${remainingDaysNum !== 1 ? 's' : ''} remaining`;
                        remainingTime.className = 'text-warning';
                    }
                } else {
                    // Normal progress
                    statusText = `${Math.round(progressPercent)}% Complete`;
                    if (remainingTime) {
                        remainingTime.innerHTML = `<i class="fas fa-hourglass-half me-1"></i>${remainingDaysNum} day${remainingDaysNum !== 1 ? 's' : ''} remaining`;
                        remainingTime.className = 'text-muted';
                    }
                }

                // Update progress bar
                if (progressBar) {
                    progressBar.style.width = `${Math.round(progressPercent)}%`;
                    progressBar.setAttribute('aria-valuenow', Math.round(progressPercent));
                    progressBar.className = `progress-bar progress-bar-striped ${actual ? '' : 'progress-bar-animated'} ${barClass}`;
                }

                // Update percentage and status
                if (progressPercentage) {
                    progressPercentage.textContent = Math.round(progressPercent);
                }
                if (progressStatusText) {
                    progressStatusText.textContent = statusText;
                    progressStatusText.className = `progress-status-text ${statusClass}`;
                }

            } catch (error) {
                console.error('Error calculating progress:', error);
                // Hide progress container on error
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initializeNoteTypeDropdown();
            initializeAssociatedEntriesDropdown(); // Initialize the new dropdown
            loadNoteBindingState(); // Load note binding preferences
            loadNoteTypeColors(); // Load custom note type colors
            fetchNotes();
            loadRelatedRecords(); // Call the new function to load related records (this will also load shared relationships)
            loadSharedRelationshipOpportunities(); // Load shared relationship suggestions
            initializeProgressTimeline(); // Initialize progress timeline
            if (hasSensors) {
                loadSensorData(); // Load sensor data if this entry type supports sensors
                initializeSensorDataForm(); // Initialize sensor data form
                await initializeChartControls(); // Initialize chart controls
                startSensorDataAutoRefresh(); // Start auto-refresh for sensor data and charts
            }
        });

        function initializeNoteTypeDropdown() {
            const noteTypes = entryTypeNoteTypesRaw.split(',').map(type => type.trim()).filter(type => type !== '');
            noteTypeSelect.innerHTML = '';

            if (noteTypes.length === 0) {
                const option = document.createElement('option');
                option.value = 'General';
                option.textContent = 'General';
                noteTypeSelect.appendChild(option);
            } else {
                noteTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    noteTypeSelect.appendChild(option);
                });
            }
        }

        // Initialize Associated Entries Dropdown
        async function initializeAssociatedEntriesDropdown() {
            try {
                const response = await fetch('/api/entries');
                if (!response.ok) {
                    throw new Error('Failed to load entries');
                }
                const entries = await response.json();
                
                // Clear the dropdown
                associatedEntriesSelect.innerHTML = '';
                
                // Add placeholder option
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = 'Select entries to associate...';
                placeholderOption.disabled = true;
                associatedEntriesSelect.appendChild(placeholderOption);
                
                // Filter out the current entry and add the rest
                entries.filter(entry => entry.id != entryId).forEach(entry => {
                    const option = document.createElement('option');
                    option.value = entry.id;
                    option.textContent = `${entry.title} (${entry.entry_type_label})`;
                    associatedEntriesSelect.appendChild(option);
                });
                
                // Initialize event listeners for the dropdown
                initializeAssociatedEntriesEventListeners();
                
            } catch (error) {
                console.error('Error loading entries for association:', error);
                associatedEntriesSelect.innerHTML = '<option value="" disabled>Error loading entries</option>';
            }
        }

        // Initialize event listeners for associated entries functionality
        function initializeAssociatedEntriesEventListeners() {
            // Handle selection changes
            associatedEntriesSelect.addEventListener('change', function() {
                updateSelectedAssociationsDisplay();
            });
            
            // Handle clear associations button
            clearAssociationsBtn.addEventListener('click', function() {
                // Clear all selections
                Array.from(associatedEntriesSelect.options).forEach(option => {
                    option.selected = false;
                });
                updateSelectedAssociationsDisplay();
            });
        }

        // Update the display of selected associations
        function updateSelectedAssociationsDisplay() {
            const selectedOptions = Array.from(associatedEntriesSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                selectedAssociationsDisplay.style.display = 'none';
                clearAssociationsBtn.style.display = 'none';
            } else {
                selectedAssociationsDisplay.style.display = 'block';
                clearAssociationsBtn.style.display = 'inline-block';
                
                const associationsList = selectedOptions.map(option => option.textContent).join(', ');
                selectedAssociationsDisplay.innerHTML = `
                    <i class="fas fa-link me-1"></i>
                    <strong>Will be associated with:</strong> ${associationsList}
                `;
            }
        }

        // Get selected associated entry IDs
        function getSelectedAssociatedEntryIds() {
            return Array.from(associatedEntriesSelect.selectedOptions).map(option => parseInt(option.value));
        }

        // Toggle button event listeners for collapsible sections
        const toggleAssociateBtn = document.getElementById('toggleAssociateBtn');
        const toggleReminderBtn = document.getElementById('toggleReminderBtn');
        const toggleUploadBtn = document.getElementById('toggleUploadBtn');

        // Associate section events
        if (toggleAssociateBtn) {
            const associateSection = document.getElementById('associateSection');
            
            associateSection.addEventListener('shown.bs.collapse', () => {
                toggleAssociateBtn.classList.remove('btn-outline-primary');
                toggleAssociateBtn.classList.add('btn-primary');
                const chevron = toggleAssociateBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (chevron) {
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-up');
                }
            });
            
            associateSection.addEventListener('hidden.bs.collapse', () => {
                toggleAssociateBtn.classList.remove('btn-primary');
                toggleAssociateBtn.classList.add('btn-outline-primary');
                const chevron = toggleAssociateBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (chevron) {
                    chevron.classList.remove('fa-chevron-up');
                    chevron.classList.add('fa-chevron-down');
                }
            });
        }

        // Reminder section events
        if (toggleReminderBtn) {
            const reminderSection = document.getElementById('reminderSection');
            
            reminderSection.addEventListener('shown.bs.collapse', () => {
                toggleReminderBtn.classList.remove('btn-outline-warning');
                toggleReminderBtn.classList.add('btn-warning');
                const chevron = toggleReminderBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (chevron) {
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-up');
                }
            });
            
            reminderSection.addEventListener('hidden.bs.collapse', () => {
                toggleReminderBtn.classList.remove('btn-warning');
                toggleReminderBtn.classList.add('btn-outline-warning');
                const chevron = toggleReminderBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (chevron) {
                    chevron.classList.remove('fa-chevron-up');
                    chevron.classList.add('fa-chevron-down');
                }
            });
        }

        // Upload section events
        if (toggleUploadBtn) {
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('shown.bs.collapse', () => {
                toggleUploadBtn.classList.remove('btn-outline-info');
                toggleUploadBtn.classList.add('btn-info');
                const chevron = toggleUploadBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (chevron) {
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-up');
                }
            });
            
            uploadSection.addEventListener('hidden.bs.collapse', () => {
                toggleUploadBtn.classList.remove('btn-info');
                toggleUploadBtn.classList.add('btn-outline-info');
                const chevron = toggleUploadBtn.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (chevron) {
                    chevron.classList.remove('fa-chevron-up');
                    chevron.classList.add('fa-chevron-down');
                }
            });
        }

        // Bootstrap collapse event listener to update button text
        newNoteFormCollapseElement.addEventListener('shown.bs.collapse', () => {
            toggleNewNoteText.textContent = 'Hide New Note Form';
            // Auto-populate associated entries based on binding state
            autoPopulateAssociatedEntries();
        });
        newNoteFormCollapseElement.addEventListener('hidden.bs.collapse', () => {
            toggleNewNoteText.textContent = 'Add New Note';
        });

        // Handle file selection change
        fileUploadInput.addEventListener('change', () => {
            if (fileUploadInput.files.length > 0) {
                let fileList = Array.from(fileUploadInput.files).map(file => {
                    const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                    return `${file.name} (${sizeInMB} MB)`;
                }).join(', ');
                selectedFilesInfo.innerHTML = `<strong>Selected:</strong> ${fileList}`;
                selectedFilesInfo.classList.remove('text-muted');
                selectedFilesInfo.classList.add('text-info');
            } else {
                selectedFilesInfo.textContent = 'No files selected.';
                selectedFilesInfo.classList.remove('text-info');
                selectedFilesInfo.classList.add('text-muted');
            }
        });

        // --- Notes Section (Add Note) ---
        const reminderDateInput = document.getElementById('reminderDateInput');
        
        // Set minimum date to today
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Adjust for timezone
        reminderDateInput.min = now.toISOString().slice(0, 16);
        
        // Add event listener to ensure time is set when date is selected
        reminderDateInput.addEventListener('change', function() {
            const value = this.value;
            if (value) {
                // Check if only date is provided (no time part)
                if (value.length === 10) {
                    // Date only, append default time of 01:00 (1 AM)
                    this.value = value + 'T01:00';
                } else if (value.includes('T') && value.split('T')[1] === '') {
                    // Date with T but no time, append default time
                    this.value = value + '01:00';
                }
            }
        });
        
        // Helper functions for reminder date buttons
        function setReminderToToday() {
            const today = new Date();
            today.setHours(today.getHours() + 1); // Set to 1 hour from now
            today.setMinutes(0); // Round to nearest hour
            today.setSeconds(0);
            today.setMilliseconds(0);
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset()); // Adjust for timezone
            reminderDateInput.value = today.toISOString().slice(0, 16);
        }
        
        function setReminderToTomorrow() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(1); // Set to 1 AM tomorrow (default time)
            tomorrow.setMinutes(0);
            tomorrow.setSeconds(0);
            tomorrow.setMilliseconds(0);
            tomorrow.setMinutes(tomorrow.getMinutes() - tomorrow.getTimezoneOffset()); // Adjust for timezone
            reminderDateInput.value = tomorrow.toISOString().slice(0, 16);
        }
        
        function clearReminder() {
            reminderDateInput.value = '';
        }
        
        // Make functions global so onclick can access them
        window.setReminderToToday = setReminderToToday;
        window.setReminderToTomorrow = setReminderToTomorrow;
        window.clearReminder = clearReminder;
        
        // URL Bookmarks functionality
        let urlBookmarks = [];
        let bookmarkCounter = 0;
        
        function addBookmarkField(url = '', friendlyName = '') {
            const bookmarkId = ++bookmarkCounter;
            const bookmarkDiv = document.createElement('div');
            bookmarkDiv.className = 'bookmark-entry mb-2 p-2 border rounded';
            bookmarkDiv.dataset.bookmarkId = bookmarkId;
            
            bookmarkDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-md-5">
                        <input type="text" class="form-control form-control-sm bookmark-name" 
                               placeholder="Friendly name (e.g., GitHub Repo)" value="${friendlyName}">
                    </div>
                    <div class="col-md-6">
                        <input type="url" class="form-control form-control-sm bookmark-url" 
                               placeholder="https://example.com" value="${url}">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-bookmark-btn" 
                                onclick="removeBookmark(${bookmarkId})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('urlBookmarksList').appendChild(bookmarkDiv);
            return bookmarkDiv;
        }
        
        function removeBookmark(bookmarkId) {
            const bookmarkDiv = document.querySelector(`[data-bookmark-id="${bookmarkId}"]`);
            if (bookmarkDiv) {
                bookmarkDiv.remove();
            }
        }
        
        function getUrlBookmarks() {
            const bookmarks = [];
            document.querySelectorAll('.bookmark-entry').forEach(entry => {
                const nameInput = entry.querySelector('.bookmark-name');
                const urlInput = entry.querySelector('.bookmark-url');
                
                const friendlyName = nameInput.value.trim();
                const url = urlInput.value.trim();
                
                if (url && friendlyName) {
                    bookmarks.push({
                        url: url,
                        friendly_name: friendlyName
                    });
                }
            });
            return bookmarks;
        }
        
        function clearAllBookmarks() {
            document.getElementById('urlBookmarksList').innerHTML = '';
            bookmarkCounter = 0;
        }
        
        // Display URL bookmarks in the modal
        function displayUrlBookmarks(urlBookmarks) {
            const modalBookmarksDisplay = document.getElementById('modalBookmarksDisplay');
            const modalBookmarksList = document.getElementById('modalBookmarksList');
            
            // Clear existing bookmarks
            modalBookmarksList.innerHTML = '';
            
            if (urlBookmarks && urlBookmarks.length > 0) {
                modalBookmarksDisplay.style.display = 'block';
                
                urlBookmarks.forEach(bookmark => {
                    const bookmarkItem = document.createElement('div');
                    bookmarkItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    const displayName = bookmark.friendly_name && bookmark.friendly_name.trim() 
                        ? bookmark.friendly_name.trim() 
                        : bookmark.url;
                    
                    bookmarkItem.innerHTML = `
                        <div>
                            <a href="${bookmark.url}" target="_blank" class="text-decoration-none">
                                <i class="fas fa-external-link-alt me-2"></i>
                                ${displayName}
                            </a>
                            ${bookmark.friendly_name && bookmark.friendly_name.trim() ? `<br><small class="text-muted">${bookmark.url}</small>` : ''}
                        </div>
                    `;
                    
                    modalBookmarksList.appendChild(bookmarkItem);
                });
            } else {
                modalBookmarksDisplay.style.display = 'none';
            }
        }
        
        // Edit mode bookmark functions
        let editBookmarkCounter = 0;
        
        function addEditBookmarkField(url = '', friendlyName = '') {
            editBookmarkCounter++;
            const container = document.getElementById('editUrlBookmarksList');
            
            const bookmarkDiv = document.createElement('div');
            bookmarkDiv.className = 'edit-bookmark-field mb-2 p-2 border rounded';
            bookmarkDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-md-5">
                        <input type="url" class="form-control form-control-sm" placeholder="https://example.com" 
                               name="edit_bookmark_url_${editBookmarkCounter}" value="${url}">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control form-control-sm" placeholder="Friendly Name" 
                               name="edit_bookmark_name_${editBookmarkCounter}" value="${friendlyName}">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="removeEditBookmark(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(bookmarkDiv);
        }
        
        function removeEditBookmark(button) {
            button.closest('.edit-bookmark-field').remove();
        }
        
        function getEditUrlBookmarks() {
            const bookmarks = [];
            const container = document.getElementById('editUrlBookmarksList');
            const bookmarkFields = container.querySelectorAll('.edit-bookmark-field');
            
            bookmarkFields.forEach(field => {
                const urlInput = field.querySelector('input[name^="edit_bookmark_url_"]');
                const nameInput = field.querySelector('input[name^="edit_bookmark_name_"]');
                
                if (urlInput && urlInput.value.trim()) {
                    bookmarks.push({
                        url: urlInput.value.trim(),
                        friendly_name: nameInput ? nameInput.value.trim() : ''
                    });
                }
            });
            return bookmarks;
        }
        
        function clearEditBookmarks() {
            document.getElementById('editUrlBookmarksList').innerHTML = '';
            editBookmarkCounter = 0;
        }
        
        function populateEditBookmarks(urlBookmarks) {
            clearEditBookmarks();
            if (urlBookmarks && urlBookmarks.length > 0) {
                urlBookmarks.forEach(bookmark => {
                    addEditBookmarkField(bookmark.url, bookmark.friendly_name);
                });
            }
        }
        
        // Create bookmarks display for note list items
        function createBookmarksListDisplay(urlBookmarks) {
            if (!urlBookmarks || urlBookmarks.length === 0) {
                return '';
            }
            
            let bookmarksHtml = '<div class="mt-2"><small class="text-muted"><i class="fas fa-bookmark me-1"></i>Bookmarks:</small><br>';
            
            urlBookmarks.forEach((bookmark, index) => {
                const displayName = bookmark.friendly_name && bookmark.friendly_name.trim() 
                    ? bookmark.friendly_name.trim() 
                    : bookmark.url;
                
                bookmarksHtml += `
                    <a href="${bookmark.url}" target="_blank" class="text-decoration-none me-3 d-inline-block">
                        <small><i class="fas fa-external-link-alt me-1"></i>${displayName}</small>
                    </a>
                `;
            });
            
            bookmarksHtml += '</div>';
            return bookmarksHtml;
        }
        
        // Event listeners
        document.getElementById('addBookmarkBtn').addEventListener('click', () => {
            addBookmarkField();
        });
        
        // Edit mode bookmark event listener
        document.getElementById('editAddBookmarkBtn').addEventListener('click', () => {
            addEditBookmarkField();
        });
        
        // Make removeBookmark globally accessible
        window.removeBookmark = removeBookmark;
        
        addNoteBtn.addEventListener('click', async () => {
            const noteTitle = noteTitleInput.value.trim();
            const noteText = newNoteTextarea.value.trim();
            const noteType = noteTypeSelect.value;
            let reminderDate = reminderDateInput.value;
            const files = fileUploadInput.files;

            if (!noteText) {
                displayStatus(noteStatusMessage, 'Note content cannot be empty.', 'alert-warning');
                return;
            }

            // Validate file sizes
            const maxFileSize = {{ max_file_size }} * 1024 * 1024; // Convert MB to bytes
            const allowedExtensions = new Set({{ allowed_file_types.split(',')|map('trim')|map('lower')|list|tojson }});
            
            for (let file of files) {
                if (file.size > maxFileSize) {
                    displayStatus(noteStatusMessage, `File "${file.name}" is too large. Maximum file size is {{ max_file_size }}MB.`, 'alert-warning');
                    return;
                }
                
                // Validate file extension
                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();
                if (!allowedExtensions.has(fileExtension)) {
                    displayStatus(noteStatusMessage, `File "${file.name}" has an unsupported file type. Please check the supported file types below.`, 'alert-warning');
                    return;
                }
            }

            // Validate reminder date if provided
            if (reminderDate) {
                // Ensure complete datetime format
                if (reminderDate.length === 10) {
                    // Only date provided, append default time of 01:00
                    reminderDate = reminderDate + 'T01:00';
                    reminderDateInput.value = reminderDate; // Update the input field
                } else if (reminderDate.includes('T') && reminderDate.split('T')[1] === '') {
                    // Date with T but no time
                    reminderDate = reminderDate + '01:00';
                    reminderDateInput.value = reminderDate; // Update the input field
                } else if (reminderDate.length === 16 && !reminderDate.includes('T')) {
                    // Invalid format - require proper datetime
                    displayStatus(noteStatusMessage, 'Please select both date and time for the reminder.', 'alert-warning');
                    return;
                }
                
                // Validate that the reminder date is in the future
                const reminderDateTime = new Date(reminderDate);
                const now = new Date();
                if (reminderDateTime <= now) {
                    displayStatus(noteStatusMessage, 'Reminder date and time must be in the future.', 'alert-warning');
                    return;
                }
            }

            displayStatus(noteStatusMessage, 'Adding note...', 'alert-info');

            try {
                // Use FormData for file uploads
                const formData = new FormData();
                formData.append('note_title', noteTitle);
                formData.append('note_text', noteText);
                formData.append('note_type', noteType);
                
                // Add associated entry IDs if any selected
                const associatedEntryIds = getSelectedAssociatedEntryIds();
                if (associatedEntryIds.length > 0) {
                    formData.append('associated_entry_ids', JSON.stringify(associatedEntryIds));
                }
                
                // Add URL bookmarks if any
                const bookmarks = getUrlBookmarks();
                if (bookmarks.length > 0) {
                    formData.append('url_bookmarks', JSON.stringify(bookmarks));
                }
                
                // Add reminder date if provided
                if (reminderDate) {
                    formData.append('reminder_date', reminderDate);
                }
                
                // Add files if any
                for (let file of files) {
                    formData.append('files', file);
                }
                
                const response = await fetch(`/api/entries/${entryId}/notes`, {
                    method: 'POST',
                    body: formData  // Don't set Content-Type header, let browser set it with boundary
                });

                const data = await response.json();

                if (response.ok) {
                    displayStatus(noteStatusMessage, 'Note added successfully!', 'alert-success');
                    noteTitleInput.value = '';
                    newNoteTextarea.value = '';
                    reminderDateInput.value = '';
                    noteTypeSelect.value = noteTypeSelect.options[0].value;
                    fileUploadInput.value = '';
                    selectedFilesInfo.textContent = 'No files selected.';
                    selectedFilesInfo.classList.remove('text-info');
                    selectedFilesInfo.classList.add('text-muted');

                    // Clear associated entries selection
                    Array.from(associatedEntriesSelect.options).forEach(option => {
                        option.selected = false;
                    });
                    updateSelectedAssociationsDisplay();
                    
                    // Clear URL bookmarks
                    clearAllBookmarks();

                    const bsCollapse = new bootstrap.Collapse(newNoteFormCollapseElement, { toggle: false });
                    bsCollapse.hide(); // Hide the form after successful submission
                    fetchNotes(); // Refresh the notes list
                } else {
                    displayStatus(noteStatusMessage, `Error: ${data.message || 'Failed to add note.'}`, 'alert-danger');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayStatus(noteStatusMessage, 'An unexpected error occurred while adding note.', 'alert-danger');
            }
        });

        async function fetchNotes() {
            noNotesMessage.textContent = 'Loading notes...';
            notesList.innerHTML = '';
            notesList.appendChild(noNotesMessage);
            try {
                const response = await fetch(`/api/entries/${entryId}/notes`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const notes = await response.json();

                loadedNotes.clear();
                notes.forEach(note => {
                    loadedNotes.set(parseInt(note.id), note);
                });

                // Store all notes for filtering
                allNotes = [...notes];
                
                // Initialize note type filter options
                updateNoteTypeFilter();
                
                // Apply current filters and display
                applyNotesFilter();
                updateReminderProgressSummary(notes);
            } catch (error) {
                console.error('Error fetching notes:', error);
                noNotesMessage.textContent = 'Failed to load notes.';
                noNotesMessage.classList.add('text-danger');
            }
        }

        function displayNotes(notes) {
            notesList.innerHTML = '';
            if (notes.length === 0) {
                noNotesMessage.textContent = 'No notes yet.';
                notesList.appendChild(noNotesMessage);
                return;
            }
            if (noNotesMessage.parentNode === notesList) {
                noNotesMessage.remove();
            }

            notes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.classList.add('list-group-item', 'list-group-item-action', 'flex-column', 'align-items-start', 'mb-3', 'border-2', 'rounded');
                
                // Color-code border based on note type
                let borderColor = getNoteTypeColor(note.note_type);
                
                noteItem.style.cssText = `border-left: 4px solid ${borderColor} !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease; background-color: rgba(${borderColor === '#007bff' ? '0,123,255' : borderColor === '#dc3545' ? '220,53,69' : borderColor === '#fd7e14' ? '253,126,20' : borderColor === '#198754' ? '25,135,84' : borderColor === '#0dcaf0' ? '13,202,240' : '111,66,193'}, 0.02); padding: 1.25rem !important;`;
                
                // Add hover effect
                noteItem.addEventListener('mouseenter', () => {
                    noteItem.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                    noteItem.style.transform = 'translateY(-1px)';
                });
                noteItem.addEventListener('mouseleave', () => {
                    noteItem.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    noteItem.style.transform = 'translateY(0)';
                });
                
                // Create reminder indicator if present
                let reminderIndicator = '';
                if (note.reminder) {
                    const reminderDate = new Date(note.reminder.scheduled_for);
                    const now = new Date();
                    const isPast = reminderDate <= now;
                    const isRead = note.reminder.is_read;
                    const isDismissed = note.reminder.is_dismissed;
                    
                    let iconClass = 'fas fa-bell';
                    let colorClass = 'text-warning';
                    let title = `Reminder set for ${reminderDate.toLocaleString()}`;
                    
                    if (isDismissed) {
                        iconClass = 'fas fa-bell-slash';
                        colorClass = 'text-muted';
                        title = 'Reminder dismissed';
                    } else if (isPast && !isRead) {
                        iconClass = 'fas fa-bell';
                        colorClass = 'text-danger';
                        title = `Reminder was due ${reminderDate.toLocaleString()}`;
                    } else if (isPast && isRead) {
                        iconClass = 'fas fa-bell-slash';
                        colorClass = 'text-success';
                        title = 'Reminder completed';
                    }
                    
                    reminderIndicator = `<i class="${iconClass} ${colorClass} ms-2" title="${title}"></i>`;
                }
                
                // Create attachment indicator if present
                let attachmentIndicator = '';
                if (note.file_paths && note.file_paths.length > 0) {
                    const fileCount = note.file_paths.length;
                    const title = fileCount === 1 ? '1 file attached' : `${fileCount} files attached`;
                    attachmentIndicator = `<i class="fas fa-paperclip text-info ms-2" title="${title}"></i>`;
                }
                
                // Create relationship indicator if this note is associated with other entries
                let relationshipIndicator = '';
                if (note.relationship_type && note.relationship_type !== 'primary') {
                    let relationshipIcon = 'fas fa-link';
                    let relationshipColor = 'text-info';
                    let relationshipText = 'Associated';
                    
                    if (note.relationship_type === 'cross_referenced') {
                        relationshipIcon = 'fas fa-external-link-alt';
                        relationshipColor = 'text-primary';
                        relationshipText = 'Cross-referenced';
                    }
                    
                    relationshipIndicator = `<i class="${relationshipIcon} ${relationshipColor} ms-2" title="This note is ${relationshipText.toLowerCase()} with this entry"></i>`;
                }

                // Create associated entries info if available
                let associatedEntriesInfo = '';
                if (note.associated_entry_ids && note.associated_entry_ids.length > 0) {
                    const associatedCount = note.associated_entry_ids.length;
                    const title = associatedCount === 1 ? '1 associated entry' : `${associatedCount} associated entries`;
                    associatedEntriesInfo = `<small class="text-muted d-block mt-1">
                        <i class="fas fa-sitemap me-1"></i>Associated with ${associatedCount} other ${associatedCount === 1 ? 'entry' : 'entries'}
                    </small>`;
                }

                // Create bookmarks display
                const bookmarksDisplay = createBookmarksListDisplay(note.url_bookmarks);

                noteItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">
                            ${note.note_title ? note.note_title : 'No Title'} 
                            <small class="text-muted">(${note.note_type})</small>
                            ${reminderIndicator}
                            ${attachmentIndicator}
                            ${relationshipIndicator}
                        </h5>
                        <small>${new Date(note.created_at).toLocaleString()}</small>
                    </div>
                    <p class="mb-1 note-text-preview">${note.note_text.substring(0, 100)}${note.note_text.length > 100 ? '...' : ''}</p>
                    ${associatedEntriesInfo}
                    ${bookmarksDisplay}
                    <button type="button" class="btn btn-theme-primary btn-sm mt-2 open-note-details-btn" data-note-id="${note.id}">
                        Open Details <i class="fas fa-external-link-alt ms-1"></i>
                    </button>
                `;
                notesList.appendChild(noteItem);
            });

            notesList.querySelectorAll('.open-note-details-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const noteId = parseInt(event.currentTarget.dataset.noteId);
                    const note = loadedNotes.get(noteId);

                    if (note) {
                        currentNoteIdInModal = noteId;
                        modalNoteTitle.textContent = note.note_title || 'No Title';
                        modalNoteType.textContent = note.note_type || 'General';
                        modalNoteCreated.textContent = new Date(note.created_at).toLocaleString();
                        modalNoteContent.textContent = note.note_text;
                        
                        // Display URL bookmarks if they exist
                        displayUrlBookmarks(note.url_bookmarks);
                        
                        // Handle relationship information
                        const modalNoteRelationships = document.getElementById('modalNoteRelationships');
                        const modalRelationshipType = document.getElementById('modalRelationshipType');
                        const modalRelationshipDetails = document.getElementById('modalRelationshipDetails');
                        
                        if (note.relationship_type && note.relationship_type !== 'primary') {
                            modalNoteRelationships.style.display = 'block';
                            
                            // Set relationship type badge
                            let badgeClass = 'bg-info';
                            let relationshipText = 'Associated';
                            
                            if (note.relationship_type === 'cross_referenced') {
                                badgeClass = 'bg-primary';
                                relationshipText = 'Cross-referenced';
                            }
                            
                            modalRelationshipType.className = `badge ${badgeClass}`;
                            modalRelationshipType.textContent = relationshipText;
                            
                            // Build relationship details
                            let detailsHtml = `<small class="text-muted">This note is ${relationshipText.toLowerCase()} with this entry through the associated entries system.</small>`;
                            
                            if (note.associated_entry_ids && note.associated_entry_ids.length > 0) {
                                detailsHtml += `<br><small class="text-muted mt-1 d-block">
                                    <i class="fas fa-link me-1"></i>This note is also associated with ${note.associated_entry_ids.length} other ${note.associated_entry_ids.length === 1 ? 'entry' : 'entries'}.
                                </small>`;
                            }
                            
                            modalRelationshipDetails.innerHTML = detailsHtml;
                        } else if (note.associated_entry_ids && note.associated_entry_ids.length > 0) {
                            // This is a primary note but has associated entries
                            modalNoteRelationships.style.display = 'block';
                            modalRelationshipType.className = 'badge bg-success';
                            modalRelationshipType.textContent = 'Primary';
                            
                            modalRelationshipDetails.innerHTML = `
                                <small class="text-muted">This is the primary note for this entry.</small>
                                <br><small class="text-muted mt-1 d-block">
                                    <i class="fas fa-sitemap me-1"></i>It is also associated with ${note.associated_entry_ids.length} other ${note.associated_entry_ids.length === 1 ? 'entry' : 'entries'}.
                                </small>
                            `;
                        } else {
                            modalNoteRelationships.style.display = 'none';
                        }
                        
                        // Handle reminder information
                        const modalNoteReminder = document.getElementById('modalNoteReminder');
                        const modalReminderDate = document.getElementById('modalReminderDate');
                        const modalReminderStatus = document.getElementById('modalReminderStatus');
                        
                        if (note.reminder) {
                            modalNoteReminder.style.display = 'block';
                            const reminderDate = new Date(note.reminder.scheduled_for);
                            modalReminderDate.textContent = reminderDate.toLocaleString();
                            
                            // Set status badge and progress information
                            const now = new Date();
                            const isPast = reminderDate <= now;
                            const isRead = note.reminder.is_read;
                            const isDismissed = note.reminder.is_dismissed;
                            const reminderProgress = document.getElementById('reminderProgress');
                            
                            let progressHtml = '';
                            
                            if (isDismissed) {
                                modalReminderStatus.className = 'badge bg-secondary';
                                modalReminderStatus.textContent = 'Dismissed';
                                progressHtml = '<small class="text-muted"><i class="fas fa-ban me-1"></i>This reminder has been dismissed</small>';
                            } else if (isPast && !isRead) {
                                modalReminderStatus.className = 'badge bg-danger';
                                modalReminderStatus.textContent = 'Overdue';
                                const overdueDays = Math.floor((now - reminderDate) / (1000 * 60 * 60 * 24));
                                const overdueHours = Math.floor((now - reminderDate) / (1000 * 60 * 60));
                                
                                if (overdueDays > 0) {
                                    progressHtml = `<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Overdue by ${overdueDays} day${overdueDays !== 1 ? 's' : ''}</small>`;
                                } else if (overdueHours > 0) {
                                    progressHtml = `<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Overdue by ${overdueHours} hour${overdueHours !== 1 ? 's' : ''}</small>`;
                                } else {
                                    progressHtml = '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Overdue (less than 1 hour)</small>';
                                }
                            } else if (isPast && isRead) {
                                modalReminderStatus.className = 'badge bg-success';
                                modalReminderStatus.textContent = 'Completed';
                                progressHtml = '<small class="text-success"><i class="fas fa-check-circle me-1"></i>Reminder has been completed</small>';
                            } else {
                                modalReminderStatus.className = 'badge bg-warning text-dark';
                                modalReminderStatus.textContent = 'Scheduled';
                                const timeUntil = getRelativeTimeString(reminderDate, now);
                                progressHtml = `<small class="text-info"><i class="fas fa-clock me-1"></i>Scheduled for ${timeUntil}</small>`;
                            }
                            
                            if (reminderProgress) {
                                reminderProgress.innerHTML = progressHtml;
                            }
                        } else {
                            modalNoteReminder.style.display = 'none';
                        }
                        
                        // Display attached files
                        displayNoteFiles(note);

                        noteDetailModal.show();
                    } else {
                        alert("Could not load note details. Please try again.");
                    }
                });
            });
        }

        // Function to update reminder progress summary
        function updateReminderProgressSummary(notes) {
            const reminderProgressSummary = document.getElementById('reminderProgressSummary');
            const reminderProgressContent = document.getElementById('reminderProgressContent');
            const viewAllRemindersBtn = document.getElementById('viewAllRemindersBtn');
            
            if (!reminderProgressSummary || !reminderProgressContent) return;
            
            // Filter notes with reminders
            const notesWithReminders = notes.filter(note => note.reminder);
            
            if (notesWithReminders.length === 0) {
                reminderProgressSummary.style.display = 'none';
                return;
            }
            
            const now = new Date();
            let overdue = 0;
            let upcoming = 0;
            let completed = 0;
            let dismissed = 0;
            
            // Categorize reminders
            notesWithReminders.forEach(note => {
                const reminderDate = new Date(note.reminder.scheduled_for);
                const isPast = reminderDate <= now;
                const isRead = note.reminder.is_read;
                const isDismissed = note.reminder.is_dismissed;
                
                if (isDismissed) {
                    dismissed++;
                } else if (isPast && !isRead) {
                    overdue++;
                } else if (isPast && isRead) {
                    completed++;
                } else {
                    upcoming++;
                }
            });
            
            // Create summary content
            let summaryHtml = '';
            const summaryItems = [];
            
            if (overdue > 0) {
                summaryItems.push(`<span class="badge bg-danger me-2">${overdue} Overdue</span>`);
            }
            if (upcoming > 0) {
                summaryItems.push(`<span class="badge bg-warning text-dark me-2">${upcoming} Upcoming</span>`);
            }
            if (completed > 0) {
                summaryItems.push(`<span class="badge bg-success me-2">${completed} Completed</span>`);
            }
            if (dismissed > 0) {
                summaryItems.push(`<span class="badge bg-secondary me-2">${dismissed} Dismissed</span>`);
            }
            
            if (summaryItems.length > 0) {
                summaryHtml = `<div class="d-flex flex-wrap align-items-center gap-1">${summaryItems.join('')}</div>`;
                
                // Add the next upcoming reminder info
                const nextUpcoming = notesWithReminders
                    .filter(note => {
                        const reminderDate = new Date(note.reminder.scheduled_for);
                        return reminderDate > now && !note.reminder.is_dismissed;
                    })
                    .sort((a, b) => new Date(a.reminder.scheduled_for) - new Date(b.reminder.scheduled_for))[0];
                
                if (nextUpcoming) {
                    const nextDate = new Date(nextUpcoming.reminder.scheduled_for);
                    const timeUntil = getRelativeTimeString(nextDate, now);
                    summaryHtml += `<small class="text-muted mt-1 d-block">
                        <i class="fas fa-clock me-1"></i>Next: "${nextUpcoming.note_title || 'Untitled'}" ${timeUntil}
                    </small>`;
                }
            }
            
            reminderProgressContent.innerHTML = summaryHtml;
            reminderProgressSummary.style.display = 'block';
            
            // Set up the view all button click handler
            viewAllRemindersBtn.onclick = () => {
                // Scroll to notes section and highlight reminder items
                const notesList = document.getElementById('notesList');
                if (notesList) {
                    notesList.scrollIntoView({ behavior: 'smooth' });
                    
                    // Temporarily highlight notes with reminders
                    setTimeout(() => {
                        notesList.querySelectorAll('.list-group-item').forEach(item => {
                            const reminderIcon = item.querySelector('.fa-bell, .fa-bell-slash');
                            if (reminderIcon) {
                                item.style.backgroundColor = 'var(--theme-primary, #007bff)';
                                item.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
                                item.style.borderColor = 'var(--theme-primary, #007bff)';
                                
                                setTimeout(() => {
                                    item.style.backgroundColor = '';
                                    item.style.borderColor = '';
                                }, 2000);
                            }
                        });
                    }, 500);
                }
            };
        }
        
        // Helper function to get relative time string
        function getRelativeTimeString(targetDate, currentDate) {
            const diffMs = targetDate - currentDate;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.ceil(diffMs / (1000 * 60));
            
            if (diffDays > 1) {
                return `in ${diffDays} days`;
            } else if (diffHours > 1) {
                return `in ${diffHours} hours`;
            } else if (diffMinutes > 1) {
                return `in ${diffMinutes} minutes`;
            } else {
                return 'very soon';
            }
        }

        // Notes filtering and searching functions
        function updateNoteTypeFilter() {
            // Get unique note types from all notes
            const noteTypes = [...new Set(allNotes.map(note => note.note_type || 'General'))];
            noteTypes.sort();
            
            // Clear existing options (except "All Types")
            notesTypeFilter.innerHTML = '<option value="">All Types</option>';
            
            // Add options for each note type
            noteTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                notesTypeFilter.appendChild(option);
            });
        }

        function applyNotesFilter() {
            const searchTerm = notesSearchInput.value.toLowerCase().trim();
            const selectedType = notesTypeFilter.value;
            const sortOrder = notesSortOrder.value;
            
            // Filter notes based on search term and type
            filteredNotes = allNotes.filter(note => {
                // Search in title and content
                const matchesSearch = !searchTerm || 
                    (note.note_title && note.note_title.toLowerCase().includes(searchTerm)) ||
                    (note.note_text && note.note_text.toLowerCase().includes(searchTerm));
                
                // Filter by note type
                const matchesType = !selectedType || (note.note_type || 'General') === selectedType;
                
                return matchesSearch && matchesType;
            });
            
            // Sort filtered notes
            sortNotes(filteredNotes, sortOrder);
            
            // Update count display
            notesCount.textContent = filteredNotes.length;
            
            // Display filtered notes
            displayNotes(filteredNotes);
        }

        function sortNotes(notes, sortOrder) {
            switch (sortOrder) {
                case 'oldest':
                    notes.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'title':
                    notes.sort((a, b) => {
                        const titleA = (a.note_title || '').toLowerCase();
                        const titleB = (b.note_title || '').toLowerCase();
                        return titleA.localeCompare(titleB);
                    });
                    break;
                case 'newest':
                default:
                    notes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
            }
        }

        function clearNotesFilter() {
            notesSearchInput.value = '';
            notesTypeFilter.value = '';
            notesSortOrder.value = 'newest';
            clearNotesSearch.style.display = 'none';
            applyNotesFilter();
        }

        // Function to display note files in the modal
        function displayNoteFiles(note) {
            modalNoteFiles.innerHTML = '';
            
            if (note.file_paths && note.file_paths.length > 0) {
                note.file_paths.forEach((filePath, index) => {
                    const fileName = filePath.split('/').pop();
                    const fileExtension = fileName.split('.').pop().toLowerCase();
                    const fileDiv = document.createElement('div');
                    fileDiv.classList.add('col');
                    
                    // Determine file type and icon
                    let fileIcon = 'fas fa-file';
                    let isImage = false;
                    
                    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExtension)) {
                        fileIcon = 'fas fa-image';
                        isImage = true;
                    } else if (['pdf'].includes(fileExtension)) {
                        fileIcon = 'fas fa-file-pdf';
                    } else if (['doc', 'docx'].includes(fileExtension)) {
                        fileIcon = 'fas fa-file-word';
                    } else if (['txt'].includes(fileExtension)) {
                        fileIcon = 'fas fa-file-alt';
                    } else if (['zip', 'rar', '7z'].includes(fileExtension)) {
                        fileIcon = 'fas fa-file-archive';
                    } else if (['mp4', 'avi', 'mov', 'mkv'].includes(fileExtension)) {
                        fileIcon = 'fas fa-file-video';
                    } else if (['mp3', 'wav', 'flac'].includes(fileExtension)) {
                        fileIcon = 'fas fa-file-audio';
                    }
                    
                    if (isImage) {
                        fileDiv.innerHTML = `
                            <div class="file-attachment position-relative">
                                <img src="/static/uploads/${filePath.split('/').pop()}" alt="${fileName}" 
                                     class="img-thumbnail mb-2" style="max-height: 150px; cursor: pointer;"
                                     onclick="window.open('/static/uploads/${filePath.split('/').pop()}', '_blank')">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-file-btn" 
                                        data-file-index="${index}" title="Delete file">
                                    <i class="fas fa-times"></i>
                                </button>
                                <p class="small text-center mb-0">${fileName}</p>
                            </div>
                        `;
                    } else {
                        fileDiv.innerHTML = `
                            <div class="file-attachment text-center p-3 border rounded position-relative">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-file-btn" 
                                        data-file-index="${index}" title="Delete file">
                                    <i class="fas fa-times"></i>
                                </button>
                                <i class="${fileIcon} fa-3x text-muted mb-2"></i>
                                <p class="small mb-1">${fileName}</p>
                                <a href="/static/uploads/${filePath.split('/').pop()}" 
                                   class="btn btn-sm btn-success" download>
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                            </div>
                        `;
                    }
                    
                    modalNoteFiles.appendChild(fileDiv);
                });
                
                // Add event listeners for delete buttons
                modalNoteFiles.querySelectorAll('.delete-file-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const fileIndex = parseInt(event.currentTarget.dataset.fileIndex);
                        const fileName = note.file_paths[fileIndex].split('/').pop();
                        
                        if (confirm(`Are you sure you want to delete "${fileName}"? This cannot be undone.`)) {
                            try {
                                const response = await fetch(`/api/notes/${currentNoteIdInModal}/attachments/${fileIndex}`, {
                                    method: 'DELETE'
                                });
                                
                                if (response.ok) {
                                    const result = await response.json();
                                    
                                    // Update the stored note data
                                    const updatedNote = loadedNotes.get(currentNoteIdInModal);
                                    if (updatedNote) {
                                        updatedNote.file_paths = result.file_paths;
                                        loadedNotes.set(currentNoteIdInModal, updatedNote);
                                        
                                        // Refresh the file display and notes list
                                        displayNoteFiles(updatedNote);
                                        await fetchNotes();
                                    }
                                } else {
                                    const data = await response.json();
                                    alert('Error deleting file: ' + (data.error || 'Unknown error'));
                                }
                            } catch (error) {
                                console.error('Error deleting file:', error);
                                alert('An unexpected error occurred while deleting the file.');
                            }
                        }
                    });
                });
                
                // Hide no attachments placeholder
                if (noAttachmentsPlaceholder) {
                    noAttachmentsPlaceholder.style.display = 'none';
                }
            } else {
                modalNoteFiles.appendChild(noAttachmentsPlaceholder);
                noAttachmentsPlaceholder.style.display = 'block';
            }
        }

        // Handle delete note from modal
        deleteNoteFromModalBtn.addEventListener('click', async () => {
            if (currentNoteIdInModal && confirm('Are you sure you want to delete this note? This cannot be undone.')) {
                try {
                    const response = await fetch(`/api/notes/${currentNoteIdInModal}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        alert('Note deleted successfully!');
                        noteDetailModal.hide();
                        fetchNotes();
                        currentNoteIdInModal = null;
                    } else {
                        const data = await response.json();
                        alert('Error deleting note: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting note:', error);
                    alert('An unexpected error occurred while deleting the note.');
                }
            }
        });

        // Handle reminder editing
        editReminderBtn.addEventListener('click', () => {
            const note = loadedNotes.get(currentNoteIdInModal);
            if (note && note.reminder) {
                const reminderDate = new Date(note.reminder.scheduled_for);
                editReminderDate.value = reminderDate.toISOString().split('T')[0];
                editReminderTime.value = reminderDate.toTimeString().slice(0, 5);
                
                reminderDisplayMode.style.display = 'none';
                reminderEditMode.style.display = 'block';
            }
        });

        cancelReminderEditBtn.addEventListener('click', () => {
            reminderDisplayMode.style.display = 'block';
            reminderEditMode.style.display = 'none';
        });

        saveReminderBtn.addEventListener('click', async () => {
            if (!editReminderDate.value || !editReminderTime.value) {
                alert('Please enter both date and time for the reminder.');
                return;
            }

            const reminderDateTime = `${editReminderDate.value}T${editReminderTime.value}:00`;
            
            try {
                const response = await fetch(`/api/notes/${currentNoteIdInModal}/reminder`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scheduled_for: reminderDateTime
                    }),
                });

                if (response.ok) {
                    alert('Reminder updated successfully!');
                    // Refresh the note data and modal display
                    await fetchNotes();
                    const updatedNote = loadedNotes.get(currentNoteIdInModal);
                    if (updatedNote) {
                        // Update the modal display
                        const modalReminderDate = document.getElementById('modalReminderDate');
                        const modalReminderStatus = document.getElementById('modalReminderStatus');
                        
                        if (updatedNote.reminder) {
                            const reminderDate = new Date(updatedNote.reminder.scheduled_for);
                            modalReminderDate.textContent = reminderDate.toLocaleString();
                            
                            // Update status badge
                            const now = new Date();
                            const isPast = reminderDate <= now;
                            const isRead = updatedNote.reminder.is_read;
                            const isDismissed = updatedNote.reminder.is_dismissed;
                            
                            if (isDismissed) {
                                modalReminderStatus.className = 'badge ms-2';
                                modalReminderStatus.style.backgroundColor = 'var(--theme-secondary, #6c757d)';
                                modalReminderStatus.style.color = 'white';
                                modalReminderStatus.textContent = 'Dismissed';
                            } else if (isPast && !isRead) {
                                modalReminderStatus.className = 'badge ms-2';
                                modalReminderStatus.style.backgroundColor = 'var(--theme-danger, #dc3545)';
                                modalReminderStatus.style.color = 'white';
                                modalReminderStatus.textContent = 'Overdue';
                            } else if (isPast && isRead) {
                                modalReminderStatus.className = 'badge ms-2';
                                modalReminderStatus.style.backgroundColor = 'var(--theme-success, #198754)';
                                modalReminderStatus.style.color = 'white';
                                modalReminderStatus.textContent = 'Completed';
                            } else {
                                modalReminderStatus.className = 'badge ms-2';
                                modalReminderStatus.style.backgroundColor = 'var(--theme-warning, #ffc107)';
                                modalReminderStatus.style.color = 'var(--theme-text-dark, #000)';
                                modalReminderStatus.textContent = 'Scheduled';
                            }
                        }
                    }
                    
                    reminderDisplayMode.style.display = 'block';
                    reminderEditMode.style.display = 'none';
                } else {
                    const data = await response.json();
                    alert('Error updating reminder: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating reminder:', error);
                alert('An unexpected error occurred while updating the reminder.');
            }
        });

        deleteReminderBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to remove this reminder?')) {
                try {
                    const response = await fetch(`/api/notes/${currentNoteIdInModal}/reminder`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        alert('Reminder removed successfully!');
                        // Refresh the note data and hide reminder section
                        await fetchNotes();
                        const modalNoteReminder = document.getElementById('modalNoteReminder');
                        modalNoteReminder.style.display = 'none';
                        
                        reminderDisplayMode.style.display = 'block';
                        reminderEditMode.style.display = 'none';
                    } else {
                        const data = await response.json();
                        alert('Error removing reminder: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error removing reminder:', error);
                    alert('An unexpected error occurred while removing the reminder.');
                }
            }
        });

        // Handle note content editing
        editNoteContentBtn.addEventListener('click', () => {
            const currentNote = loadedNotes.get(currentNoteIdInModal);
            if (currentNote) {
                editNoteTitle.value = currentNote.note_title || '';
                editNoteText.value = currentNote.note_text || '';
                
                // Populate edit bookmarks
                populateEditBookmarks(currentNote.url_bookmarks);
                
                noteContentDisplay.style.display = 'none';
                noteContentEditMode.style.display = 'block';
            }
        });

        cancelNoteContentEditBtn.addEventListener('click', () => {
            noteContentDisplay.style.display = 'block';
            noteContentEditMode.style.display = 'none';
        });

        saveNoteContentBtn.addEventListener('click', async () => {
            try {
                const formData = new FormData();
                formData.append('note_title', editNoteTitle.value.trim());
                formData.append('note_text', editNoteText.value.trim());
                
                // Add URL bookmarks
                const editBookmarks = getEditUrlBookmarks();
                formData.append('url_bookmarks', JSON.stringify(editBookmarks));

                const response = await fetch(`/api/notes/${currentNoteIdInModal}`, {
                    method: 'PUT',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Update the stored note data
                    const updatedNote = loadedNotes.get(currentNoteIdInModal);
                    if (updatedNote) {
                        updatedNote.note_title = result.note_title;
                        updatedNote.note_text = result.note_text;
                        updatedNote.url_bookmarks = result.url_bookmarks;
                        loadedNotes.set(currentNoteIdInModal, updatedNote);
                        
                        // Update modal display
                        modalNoteTitle.textContent = result.note_title || 'No Title';
                        modalNoteContent.textContent = result.note_text;
                        
                        // Update URL bookmarks display
                        displayUrlBookmarks(result.url_bookmarks);
                        
                        // Refresh notes list to show updated content
                        await fetchNotes();
                    }
                    
                    noteContentDisplay.style.display = 'block';
                    noteContentEditMode.style.display = 'none';
                } else {
                    const data = await response.json();
                    alert('Error updating note: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating note:', error);
                alert('An unexpected error occurred while updating the note.');
            }
        });

        // Handle attachment management
        addAttachmentsBtn.addEventListener('click', () => {
            addAttachmentsForm.style.display = 'block';
            addAttachmentsBtn.style.display = 'none';
        });

        cancelAddAttachmentsBtn.addEventListener('click', () => {
            addAttachmentsForm.style.display = 'none';
            addAttachmentsBtn.style.display = 'inline-block';
            additionalFiles.value = '';
        });

        uploadAdditionalFilesBtn.addEventListener('click', async () => {
            const files = additionalFiles.files;
            if (files.length === 0) {
                alert('Please select files to upload.');
                return;
            }

            // Validate files before upload
            const maxFileSize = {{ max_file_size }} * 1024 * 1024; // Convert MB to bytes
            const allowedExtensions = new Set({{ allowed_file_types.split(',')|map('trim')|map('lower')|list|tojson }});
            
            for (let file of files) {
                if (file.size > maxFileSize) {
                    alert(`File "${file.name}" is too large. Maximum file size is {{ max_file_size }}MB.`);
                    return;
                }
                
                // Validate file extension
                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();
                if (!allowedExtensions.has(fileExtension)) {
                    alert(`File "${file.name}" has an unsupported file type. Please check the supported file types.`);
                    return;
                }
            }

            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }

                const response = await fetch(`/api/notes/${currentNoteIdInModal}/attachments`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Update the stored note data
                    const updatedNote = loadedNotes.get(currentNoteIdInModal);
                    if (updatedNote) {
                        updatedNote.file_paths = result.file_paths;
                        loadedNotes.set(currentNoteIdInModal, updatedNote);
                        
                        // Refresh the file display and notes list
                        displayNoteFiles(updatedNote);
                        await fetchNotes();
                    }
                    
                    // Reset form
                    addAttachmentsForm.style.display = 'none';
                    addAttachmentsBtn.style.display = 'inline-block';
                    additionalFiles.value = '';
                } else {
                    const data = await response.json();
                    alert('Error uploading files: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error uploading files:', error);
                alert('An unexpected error occurred while uploading files.');
            }
        });

        // Handle delete entry
        document.getElementById('deleteEntryBtn').addEventListener('click', async () => {
            if (confirm(`Are you sure you want to delete the entry "${currentEntryName}"? This will also delete all associated notes and relationships. This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/entries/${entryId}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        alert('Entry deleted successfully!');
                        // Redirect to home page after successful deletion
                        window.location.href = '/';
                    } else {
                        const data = await response.json();
                        alert('Error deleting entry: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting entry:', error);
                    alert('An unexpected error occurred while deleting the entry.');
                }
            }
        });

        // --- Notes Search and Filter Event Listeners ---
        
        // Search input with debouncing
        let searchTimeout;
        notesSearchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            
            // Show/hide clear button based on input value
            const hasValue = notesSearchInput.value.trim().length > 0;
            clearNotesSearch.style.display = hasValue ? 'block' : 'none';
            
            searchTimeout = setTimeout(() => {
                applyNotesFilter();
            }, 300);
        });
        
        // Clear search button
        clearNotesSearch.addEventListener('click', () => {
            clearNotesFilter();
        });
        
        // Note type filter
        notesTypeFilter.addEventListener('change', () => {
            applyNotesFilter();
        });
        
        // Sort order
        notesSortOrder.addEventListener('change', () => {
            applyNotesFilter();
        });

        // --- Inline Entry Editing Section ---
        const originalEntryTypeId = {{ entry.entry_type_id }};
        let isEditing = false;
        
        // Store original values for cancel functionality
        let originalValues = {
            title: {{ entry.title|tojson }},
            description: {{ (entry.description if entry.description is not none else "")|tojson }},
            entryTypeId: originalEntryTypeId,
            status: {{ (entry.status if entry.status else "active")|tojson }},
            {% if entry.show_end_dates %}
            intendedEndDate: '{{ entry.intended_end_date[:10] if entry.intended_end_date else "" }}',
            actualEndDate: '{{ entry.actual_end_date[:10] if entry.actual_end_date else "" }}'
            {% endif %}
        };
        
        // Toggle edit mode
        function toggleEditMode(editing) {
            isEditing = editing;
            
            if (editing) {
                // Show edit elements, hide display elements
                entryTitleDisplay.classList.add('d-none');
                entryTitleInput.classList.remove('d-none');
                detailsDisplay.classList.add('d-none');
                detailsEdit.classList.remove('d-none');
                {% if entry.show_end_dates %}
                datesDisplay.classList.add('d-none');
                datesEdit.classList.remove('d-none');
                {% endif %}
                descriptionDisplay.classList.add('d-none');
                descriptionEdit.classList.remove('d-none');
                descriptionEditActions.classList.remove('d-none');
                
                // Show save/cancel buttons, hide edit button
                editEntryBtn.classList.add('d-none');
                saveEntryBtn.classList.remove('d-none');
                cancelEditBtn.classList.remove('d-none');
                
                // Load entry types
                loadEntryTypes();
            } else {
                // Show display elements, hide edit elements
                entryTitleDisplay.classList.remove('d-none');
                entryTitleInput.classList.add('d-none');
                detailsDisplay.classList.remove('d-none');
                detailsEdit.classList.add('d-none');
                {% if entry.show_end_dates %}
                datesDisplay.classList.remove('d-none');
                datesEdit.classList.add('d-none');
                {% endif %}
                descriptionDisplay.classList.remove('d-none');
                descriptionEdit.classList.add('d-none');
                descriptionEditActions.classList.add('d-none');
                
                // Show edit button, hide save/cancel buttons
                editEntryBtn.classList.remove('d-none');
                saveEntryBtn.classList.add('d-none');
                cancelEditBtn.classList.add('d-none');
                
                // Hide Wikipedia results
                document.getElementById('wikipediaResults').classList.add('d-none');
            }
        }
        
        // Load entry types for the select dropdown
        async function loadEntryTypes() {
            try {
                const response = await fetch('/api/entry_types');
                const entryTypes = await response.json();
                
                entryTypeSelect.innerHTML = '';
                entryTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.singular_label;
                    if (type.id == originalEntryTypeId) {
                        option.selected = true;
                    }
                    entryTypeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading entry types:', error);
                displayStatus(entryStatusMessage, 'Error loading entry types', 'alert-danger');
            }
        }
        
        // Edit button click
        editEntryBtn.addEventListener('click', () => {
            toggleEditMode(true);
        });
        
        // Cancel edit
        cancelEditBtn.addEventListener('click', () => {
            // Reset all fields to original values
            entryTitleInput.value = originalValues.title;
            descriptionTextarea.value = originalValues.description;
            entryTypeSelect.value = originalValues.entryTypeId;
            statusSelect.value = originalValues.status;
            {% if entry.show_end_dates %}
            intendedEndDateInput.value = originalValues.intendedEndDate;
            actualEndDateInput.value = originalValues.actualEndDate;
            {% endif %}
            
            // Clear any status messages
            entryStatusMessage.className = 'mt-3 d-none';
            
            toggleEditMode(false);
        });
        
        // Save changes
        saveEntryBtn.addEventListener('click', async () => {
            const title = entryTitleInput.value.trim();
            const description = descriptionTextarea.value;
            const entryTypeId = parseInt(entryTypeSelect.value);
            const status = statusSelect.value;
            {% if entry.show_end_dates %}
            const intendedEndDate = intendedEndDateInput.value;
            const actualEndDate = actualEndDateInput.value;
            {% else %}
            const intendedEndDate = null;
            const actualEndDate = null;
            {% endif %}
            
            if (!title) {
                displayStatus(entryStatusMessage, 'Entry title is required.', 'alert-danger');
                return;
            }
            
            // Show loading state
            saveEntryBtn.disabled = true;
            saveEntryBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
            
            try {
                const response = await fetch(`/api/entries/${entryId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        title: title,
                        description: description,
                        entry_type_id: entryTypeId,
                        status: status,
                        intended_end_date: intendedEndDate,
                        actual_end_date: actualEndDate
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayStatus(entryStatusMessage, 'Entry updated successfully!', 'alert-success');
                    
                    // Update the display elements
                    entryTitleDisplay.textContent = title;
                    descriptionDisplay.textContent = description || 'No description available';
                    
                    // Update details display
                    const selectedOption = entryTypeSelect.options[entryTypeSelect.selectedIndex];
                    const entryTypeLabel = selectedOption ? selectedOption.textContent : 'Unknown';
                    const capitalizedStatus = status.charAt(0).toUpperCase() + status.slice(1);
                    entryTypeDisplay.textContent = entryTypeLabel;
                    statusDisplay.textContent = capitalizedStatus;
                    
                    // Update dates display
                    {% if entry.show_end_dates %}
                    if (intendedEndDateDisplay) {
                        intendedEndDateDisplay.textContent = intendedEndDate || '';
                    }
                    if (actualEndDateDisplay) {
                        actualEndDateDisplay.textContent = actualEndDate || '';
                    }
                    {% endif %}
                    
                    // Update page title
                    document.title = document.title.replace(/- .+ -/, `- ${title} -`);
                    
                    // Update original values
                    originalValues.title = title;
                    originalValues.description = description;
                    originalValues.entryTypeId = entryTypeId;
                    originalValues.status = status;
                    {% if entry.show_end_dates %}
                    originalValues.intendedEndDate = intendedEndDate;
                    originalValues.actualEndDate = actualEndDate;
                    {% endif %}
                    
                    // Exit edit mode after short delay
                    setTimeout(() => {
                        toggleEditMode(false);
                        entryStatusMessage.className = 'mt-3 d-none';
                    }, 1500);
                } else {
                    displayStatus(entryStatusMessage, `Error: ${data.error || 'Failed to update entry.'}`, 'alert-danger');
                }
            } catch (error) {
                console.error('Network or server error:', error);
                displayStatus(entryStatusMessage, 'An unexpected error occurred while updating entry.', 'alert-danger');
            } finally {
                // Restore button state
                saveEntryBtn.disabled = false;
                saveEntryBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save';
            }
        });

        // --- Wikipedia Search Functionality ---
        document.getElementById('searchWikipediaBtn').addEventListener('click', async () => {
            const searchBtn = document.getElementById('searchWikipediaBtn');
            const wikipediaResults = document.getElementById('wikipediaResults');
            const entryTitle = entryTitleInput.value.trim() || currentEntryName; // Use current input value, fallback to original
            
            // Update button state
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Searching...';
            
            try {
                const response = await fetch(`/api/wikipedia/search/${encodeURIComponent(entryTitle)}`);
                const data = await response.json();
                
                if (data.found) {
                    // Populate Wikipedia results
                    document.getElementById('wikipediaTitle').textContent = data.title;
                    document.getElementById('wikipediaExtract').textContent = data.extract;
                    document.getElementById('wikipediaLink').href = data.url;
                    
                    // Store the extract for later use
                    wikipediaResults.dataset.extract = data.extract;
                    
                    // Show results
                    wikipediaResults.classList.remove('d-none');
                    
                    displayStatus(descriptionStatusMessage, 'Wikipedia article found!', 'alert-success');
                } else {
                    displayStatus(descriptionStatusMessage, data.message || 'No Wikipedia article found', 'alert-warning');
                    wikipediaResults.classList.add('d-none');
                }
            } catch (error) {
                console.error('Wikipedia search error:', error);
                displayStatus(descriptionStatusMessage, 'Error searching Wikipedia', 'alert-danger');
                wikipediaResults.classList.add('d-none');
            } finally {
                // Reset button state
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fab fa-wikipedia-w me-1"></i> Search Wikipedia';
            }
        });

        // Handle "Use This Description" button
        document.getElementById('useWikipediaBtn').addEventListener('click', () => {
            const wikipediaResults = document.getElementById('wikipediaResults');
            const extract = wikipediaResults.dataset.extract;
            
            if (extract) {
                descriptionTextarea.value = extract;
                displayStatus(descriptionStatusMessage, 'Wikipedia description added! Remember to save.', 'alert-info');
                
                // Hide Wikipedia results after use
                wikipediaResults.classList.add('d-none');
            }
        });

        // --- Generic Status Display Function ---
        function displayStatus(element, message, type) {
            element.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info');
            element.classList.add('alert', type);
            element.textContent = message;
            setTimeout(() => {
                element.classList.add('d-none');
            }, 5000);
        }

        // --- AI Description Assistance ---
        document.getElementById('aiGenerateDescriptionBtn').addEventListener('click', async () => {
            const entryTitle = entryTitleInput.value.trim() || currentEntryName;
            const entryType = currentEntryTypeLabel;
            
            if (!entryTitle) {
                displayStatus(descriptionStatusMessage, 'Please enter an entry title first.', 'alert-warning');
                return;
            }
            
            const generateBtn = document.getElementById('aiGenerateDescriptionBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
            
            try {
                const response = await fetch('/api/ai/generate_description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: entryTitle,
                        entry_type: entryType,
                        context: descriptionTextarea.value.trim()
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.description) {
                    descriptionTextarea.value = data.description;
                    displayStatus(descriptionStatusMessage, 'AI generated description successfully! Remember to save.', 'alert-success');
                } else {
                    throw new Error(data.error || 'Failed to generate description');
                }
                
            } catch (error) {
                console.error('Error generating description:', error);
                displayStatus(descriptionStatusMessage, 'Error generating description: ' + error.message, 'alert-danger');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            }
        });
        
        document.getElementById('aiImproveDescriptionBtn').addEventListener('click', async () => {
            const currentDescription = descriptionTextarea.value.trim();
            
            if (!currentDescription) {
                displayStatus(descriptionStatusMessage, 'Please enter some description text to improve.', 'alert-warning');
                return;
            }
            
            const improveBtn = document.getElementById('aiImproveDescriptionBtn');
            const originalText = improveBtn.innerHTML;
            improveBtn.disabled = true;
            improveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Improving...';
            
            try {
                const response = await fetch('/api/ai/improve_note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: currentDescription,
                        type: 'description'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.improved_content) {
                    descriptionTextarea.value = data.improved_content;
                    displayStatus(descriptionStatusMessage, 'AI improved description successfully! Remember to save.', 'alert-success');
                } else {
                    throw new Error(data.error || 'Failed to improve description');
                }
                
            } catch (error) {
                console.error('Error improving description:', error);
                displayStatus(descriptionStatusMessage, 'Error improving description: ' + error.message, 'alert-danger');
            } finally {
                improveBtn.disabled = false;
                improveBtn.innerHTML = originalText;
            }
        });

        // --- AI Note Assistance ---
        // AI Note Generation for new notes
        document.getElementById('aiGenerateNoteBtn').addEventListener('click', async () => {
            const entryTitle = entryTitleInput.value.trim() || currentEntryName;
            const entryType = currentEntryTypeLabel;
            const noteType = document.getElementById('noteTypeSelect').value || 'General';
            
            if (!entryTitle) {
                showAlert('Please enter an entry title first.', 'warning');
                return;
            }
            
            const generateBtn = document.getElementById('aiGenerateNoteBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
            
            try {
                const response = await fetch('/api/ai/generate_note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: entryTitle,
                        entry_type: entryType,
                        note_type: noteType,
                        context: document.getElementById('newNoteTextarea').value.trim()
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.note_content) {
                    document.getElementById('newNoteTextarea').value = data.note_content;
                    showAlert('AI generated note content successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to generate note content');
                }
                
            } catch (error) {
                console.error('Error generating note:', error);
                showAlert('Error generating note: ' + error.message, 'danger');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            }
        });

        // AI Note Improvement for new notes
        document.getElementById('aiImproveNoteBtn').addEventListener('click', async () => {
            const currentNote = document.getElementById('newNoteTextarea').value.trim();
            const noteType = document.getElementById('noteTypeSelect').value || 'General';
            
            if (!currentNote) {
                showAlert('Please enter some note text to improve.', 'warning');
                return;
            }
            
            const improveBtn = document.getElementById('aiImproveNoteBtn');
            const originalText = improveBtn.innerHTML;
            improveBtn.disabled = true;
            improveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Improving...';
            
            try {
                const response = await fetch('/api/ai/improve_note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: currentNote,
                        type: noteType
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.improved_content) {
                    document.getElementById('newNoteTextarea').value = data.improved_content;
                    showAlert('AI improved note content successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to improve note content');
                }
                
            } catch (error) {
                console.error('Error improving note:', error);
                showAlert('Error improving note: ' + error.message, 'danger');
            } finally {
                improveBtn.disabled = false;
                improveBtn.innerHTML = originalText;
            }
        });

        // AI Note Generation for editing notes
        document.getElementById('aiEditGenerateNoteBtn').addEventListener('click', async () => {
            const entryTitle = entryTitleInput.value.trim() || currentEntryName;
            const entryType = currentEntryTypeLabel;
            const noteType = document.getElementById('modalNoteType').textContent || 'General';
            
            if (!entryTitle) {
                showAlert('Please enter an entry title first.', 'warning');
                return;
            }
            
            const generateBtn = document.getElementById('aiEditGenerateNoteBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
            
            try {
                const response = await fetch('/api/ai/generate_note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: entryTitle,
                        entry_type: entryType,
                        note_type: noteType,
                        context: document.getElementById('editNoteText').value.trim()
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.note_content) {
                    document.getElementById('editNoteText').value = data.note_content;
                    showAlert('AI generated note content successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to generate note content');
                }
                
            } catch (error) {
                console.error('Error generating note:', error);
                showAlert('Error generating note: ' + error.message, 'danger');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            }
        });

        // AI Note Improvement for editing notes
        document.getElementById('aiEditImproveNoteBtn').addEventListener('click', async () => {
            const currentNote = document.getElementById('editNoteText').value.trim();
            const noteType = document.getElementById('modalNoteType').textContent || 'General';
            
            if (!currentNote) {
                showAlert('Please enter some note text to improve.', 'warning');
                return;
            }
            
            const improveBtn = document.getElementById('aiEditImproveNoteBtn');
            const originalText = improveBtn.innerHTML;
            improveBtn.disabled = true;
            improveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Improving...';
            
            try {
                const response = await fetch('/api/ai/improve_note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: currentNote,
                        type: noteType
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.improved_content) {
                    document.getElementById('editNoteText').value = data.improved_content;
                    showAlert('AI improved note content successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to improve note content');
                }
                
            } catch (error) {
                console.error('Error improving note:', error);
                showAlert('Error improving note: ' + error.message, 'danger');
            } finally {
                improveBtn.disabled = false;
                improveBtn.innerHTML = originalText;
            }
        });

        // --- Related Records Functions (NEW) ---

        async function loadRelatedRecords() {
            loadingRelationships.style.display = 'block';
            relatedRecordsContainer.innerHTML = ''; // Clear previous content

            try {
                // Fetch relationship definitions
                const definitionsResponse = await fetch(`/api/relationship_definitions`);
                const definitions = await definitionsResponse.json();

                // Fetch relationships for the current entry
                const relationshipsResponse = await fetch(`/api/entries/${entryId}/relationships`);
                const relationships = await relationshipsResponse.json();

                // Group relationships by definition ID
                const groupedEntries = relationships.reduce((acc, rel) => {
                    if (!acc[rel.definition_id]) {
                        acc[rel.definition_id] = [];
                    }
                    acc[rel.definition_id].push(rel);
                    return acc;
                }, {});

                renderRelatedRecords(definitions, groupedEntries);
            } catch (error) {
                relatedRecordsContainer.innerHTML = `<p class="text-danger text-center">Error loading related records: ${error.message}</p>`;
            } finally {
                loadingRelationships.style.display = 'none';
            }
        }

        function renderRelatedRecords(definitions, groupedEntries) {
            // Store definitions globally for easy lookup
            allRelationshipDefinitions = definitions;
            
            // Filter definitions to only show those relevant to the current entry type
            const relevantDefinitions = definitions.filter(def => 
                def.entry_type_id_from == currentEntryTypeId || def.entry_type_id_to == currentEntryTypeId
            );
            
            // Show or hide the Related Records section based on whether there are relevant definitions
            const relatedRecordsSection = document.getElementById('relatedRecordsSection');
            if (relevantDefinitions.length === 0) {
                relatedRecordsSection.style.display = 'none';
                return;
            } else {
                relatedRecordsSection.style.display = 'block';
            }
            
            relevantDefinitions.forEach(def => {
                const relatedEntries = groupedEntries[def.id] || [];
                
                // Determine if current entry is the "from" or "to" side of this relationship
                const isFromSide = def.entry_type_id_from == currentEntryTypeId;
                
                // Check the appropriate cardinality based on the current entry's role in the relationship
                const relevantCardinality = isFromSide ? def.cardinality_from : def.cardinality_to;
                const canAddMore = relevantCardinality === -1 || relatedEntries.length < relevantCardinality;
                
                // Use the appropriate label based on which side of the relationship we're on
                const displayLabel = isFromSide ? def.label_from_side : def.label_to_side;
                const cardTitle = displayLabel || def.name; // Fallback to name if no label is set

                const cardHtml = `
                    <div class="card mb-3" data-definition-id="${def.id}">
                        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: var(--theme-bg-surface, var(--bs-secondary-bg)); border-bottom-color: var(--theme-border, var(--bs-border-color)); color: var(--theme-text, var(--bs-body-color));">
                            <h5 class="mb-0">${cardTitle}</h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-theme-primary add-new-btn" data-definition-id="${def.id}" ${canAddMore ? '' : 'disabled'} title="Add New ${displayLabel || def.name}">
                                    <i class="fas fa-plus me-1"></i><span class="d-none d-md-inline">New</span>
                                </button>
                                <button class="btn btn-sm btn-theme-secondary add-existing-btn" data-definition-id="${def.id}" ${canAddMore ? '' : 'disabled'} title="Add Existing ${displayLabel || def.name}">
                                    <i class="fas fa-link me-1"></i><span class="d-none d-md-inline">Link</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Related Entry</th>
                                        ${def.allow_quantity_unit ? '<th width="120" class="text-center">Quantity</th><th width="100" class="text-center">Unit</th>' : ''}
                                        <th width="${def.allow_quantity_unit ? '140' : '100'}" class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${relatedEntries.map(entry => `
                                        <tr>
                                            <td><a href="/entry/${entry.related_entry_id}" class="link-theme">${entry.related_entry_title}</a></td>
                                            ${def.allow_quantity_unit ? `
                                                <td class="text-center">
                                                    <span class="quantity-display">${entry.quantity || '-'}</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="unit-display">${entry.unit || '-'}</span>
                                                </td>
                                            ` : ''}
                                            <td class="text-end">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    ${def.allow_quantity_unit ? `
                                                        <button class="btn btn-outline-secondary edit-quantity-btn" 
                                                                data-relationship-id="${entry.relationship_id}" 
                                                                data-quantity="${entry.quantity || ''}"
                                                                data-unit="${entry.unit || ''}"
                                                                data-definition-id="${def.id}"
                                                                title="Edit quantity/unit">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                    ` : ''}
                                                    <button class="btn btn-outline-primary bind-notes-btn" 
                                                            data-entry-id="${entry.related_entry_id}" 
                                                            data-entry-title="${entry.related_entry_title}" 
                                                            title="Bind notes from this entry">
                                                        <i class="fas fa-link"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger delete-related-btn" 
                                                            data-relationship-id="${entry.relationship_id}" 
                                                            title="Delete relationship">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                relatedRecordsContainer.insertAdjacentHTML('beforeend', cardHtml);
            });

            attachRelatedRecordEventListeners();
            
            // Apply binding state styling after DOM is updated
            applyBindingStateToButtons();
            
            // After rendering the related records, integrate shared opportunities
            loadSharedRelationships();
        }

        function attachRelatedRecordEventListeners() {
            // Add New Button
            document.querySelectorAll('.add-new-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const definitionId = this.getAttribute('data-definition-id');
                    
                    // Get relationship definition to check if quantity/unit is allowed
                    const relationshipDef = allRelationshipDefinitions.find(def => def.id == definitionId);
                    const allowQuantityUnit = relationshipDef ? relationshipDef.allow_quantity_unit : false;
                    
                    const modalHtml = `
                        <div class="modal fade" id="addNewModal" tabindex="-1" aria-labelledby="addNewModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addNewModalLabel">Add New Entry</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="addNewForm">
                                            <div class="mb-3">
                                                <label for="newEntryName" class="form-label">Name:</label>
                                                <input type="text" class="form-control" id="newEntryName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="newEntryDescription" class="form-label">Description:</label>
                                                <textarea class="form-control" id="newEntryDescription" rows="3"></textarea>
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-sm btn-theme-secondary" id="searchWikipediaDynamicBtn">
                                                        <i class="fab fa-wikipedia-w me-1"></i> Search Wikipedia
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-theme" id="generateDescriptionDynamicBtn">
                                                        <i class="fas fa-magic me-1"></i> Generate with AI
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-theme" id="improveDescriptionDynamicBtn">
                                                        <i class="fas fa-star me-1"></i> Improve with AI
                                                    </button>
                                                </div>
                                            </div>
                                            ${allowQuantityUnit ? `
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="newEntryQuantity" class="form-label">Quantity:</label>
                                                        <input type="number" step="any" class="form-control" id="newEntryQuantity" placeholder="e.g., 2.5">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="newEntryUnit" class="form-label">Unit:</label>
                                                        <div class="position-relative">
                                                            <input type="text" class="form-control pe-5" id="newEntryUnit" placeholder="e.g., kg, cups" list="newEntryUnitSuggestions">
                                                            <button class="btn btn-outline-secondary position-absolute top-0 end-0 h-100 px-1 border-start-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Common units" style="border-top-left-radius: 0; border-bottom-left-radius: 0; margin: 2px 2px 2px 0; height: calc(100% - 4px); width: 32px;">
                                                                <i class="fas fa-list"></i>
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-end" id="newEntryUnitDropdown">
                                                                <!-- Unit suggestions will be populated here -->
                                                            </ul>
                                                        </div>
                                                        <datalist id="newEntryUnitSuggestions">
                                                            <!-- Unit suggestions for autocomplete -->
                                                        </datalist>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            <div id="wikipediaDynamicResults" class="mb-3 d-none">
                                                <div class="card border-info">
                                                    <div class="card-header" style="background-color: var(--theme-bg-surface, #f8f9fa); border-bottom: 1px solid var(--bs-border-color, #dee2e6);">
                                                        <h6 class="mb-0"><i class="fab fa-wikipedia-w me-1"></i> Wikipedia Result</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <h6 id="wikipediaDynamicTitle" class="card-title"></h6>
                                                        <p id="wikipediaDynamicExtract" class="card-text" style="font-size: 0.9em; max-height: 100px; overflow-y: auto;"></p>
                                                        <div class="d-flex gap-2">
                                                            <button type="button" class="btn btn-sm btn-theme-secondary" id="useWikipediaDynamicBtn">Use This Description</button>
                                                            <a id="wikipediaDynamicLink" href="#" target="_blank" class="btn btn-sm btn-theme-secondary">View on Wikipedia</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-theme-primary w-100">Add</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    const addNewModal = new bootstrap.Modal(document.getElementById('addNewModal'));
                    addNewModal.show();

                    // Wait for modal to be fully rendered before adding event listener
                    addNewModal._element.addEventListener('shown.bs.modal', function() {
                        // Load unit suggestions if quantity/unit is allowed
                        if (allowQuantityUnit) {
                            loadNewEntryUnitSuggestions(definitionId);
                        }
                        
                        // Add Wikipedia search functionality for dynamic modal
                        document.getElementById('searchWikipediaDynamicBtn').addEventListener('click', async () => {
                            const modal = document.getElementById('addNewModal');
                            const searchBtn = modal.querySelector('#searchWikipediaDynamicBtn');
                            const entryNameInput = modal.querySelector('#newEntryName');
                            const wikipediaResults = modal.querySelector('#wikipediaDynamicResults');
                            
                            const entryName = entryNameInput.value.trim();
                            
                            if (!entryName) {
                                alert('Please enter an entry name first to search Wikipedia');
                                return;
                            }
                            
                            // Update button state
                            searchBtn.disabled = true;
                            searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Searching...';
                            
                            try {
                                const response = await fetch(`/api/wikipedia/search/${encodeURIComponent(entryName)}`);
                                const data = await response.json();
                                
                                if (data.found) {
                                    // Populate Wikipedia results
                                    modal.querySelector('#wikipediaDynamicTitle').textContent = data.title;
                                    modal.querySelector('#wikipediaDynamicExtract').textContent = data.extract;
                                    modal.querySelector('#wikipediaDynamicLink').href = data.url;
                                    
                                    // Store the extract for later use
                                    wikipediaResults.dataset.extract = data.extract;
                                    
                                    // Show results
                                    wikipediaResults.classList.remove('d-none');
                                } else {
                                    alert(data.message || 'No Wikipedia article found');
                                    wikipediaResults.classList.add('d-none');
                                }
                            } catch (error) {
                                console.error('Wikipedia search error:', error);
                                alert('Error searching Wikipedia');
                                wikipediaResults.classList.add('d-none');
                            } finally {
                                // Reset button state
                                searchBtn.disabled = false;
                                searchBtn.innerHTML = '<i class="fab fa-wikipedia-w me-1"></i> Search Wikipedia';
                            }
                        });

                        // Handle "Use This Description" button in dynamic modal
                        document.getElementById('useWikipediaDynamicBtn').addEventListener('click', function() {
                            const modal = document.getElementById('addNewModal');
                            const wikipediaResults = modal.querySelector('#wikipediaDynamicResults');
                            const extract = wikipediaResults.dataset.extract;
                            const descriptionTextarea = modal.querySelector('#newEntryDescription');
                            
                            if (extract) {
                                descriptionTextarea.value = extract;
                                // Hide Wikipedia results after use
                                wikipediaResults.classList.add('d-none');
                            }
                        });

                        // AI Generate Description functionality for dynamic modal
                        document.getElementById('generateDescriptionDynamicBtn').addEventListener('click', async () => {
                            const modal = document.getElementById('addNewModal');
                            const entryNameInput = modal.querySelector('#newEntryName');
                            const descriptionTextarea = modal.querySelector('#newEntryDescription');
                            const generateBtn = modal.querySelector('#generateDescriptionDynamicBtn');
                            
                            const entryName = entryNameInput.value.trim();
                            
                            if (!entryName) {
                                alert('Please enter an entry name first to generate description');
                                return;
                            }
                            
                            // Use a generic "Entry" type for now
                            const targetEntryType = 'Entry';
                            
                            // Update button state
                            generateBtn.disabled = true;
                            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Generating...';
                            
                            try {
                                const response = await fetch('/api/ai/generate_description', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        title: entryName,
                                        entry_type: targetEntryType,
                                        context: ''
                                    })
                                });
                                
                                const data = await response.json();
                                
                                if (data.success) {
                                    descriptionTextarea.value = data.description;
                                } else {
                                    alert(data.error || 'Failed to generate description');
                                }
                            } catch (error) {
                                console.error('AI generation error:', error);
                                alert('Error generating description with AI');
                            } finally {
                                // Reset button state
                                generateBtn.disabled = false;
                                generateBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Generate with AI';
                            }
                        });

                        // AI Improve Description functionality for dynamic modal
                        document.getElementById('improveDescriptionDynamicBtn').addEventListener('click', async () => {
                            const modal = document.getElementById('addNewModal');
                            const descriptionTextarea = modal.querySelector('#newEntryDescription');
                            const improveBtn = modal.querySelector('#improveDescriptionDynamicBtn');
                            
                            const currentDescription = descriptionTextarea.value.trim();
                            
                            if (!currentDescription) {
                                alert('Please enter some description text first to improve it');
                                return;
                            }
                            
                            // Update button state
                            improveBtn.disabled = true;
                            improveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Improving...';
                            
                            try {
                                const response = await fetch('/api/ai/improve_description', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        description: currentDescription
                                    })
                                });
                                
                                const data = await response.json();
                                
                                if (data.success) {
                                    descriptionTextarea.value = data.improved_description;
                                } else {
                                    alert(data.error || 'Failed to improve description');
                                }
                            } catch (error) {
                                console.error('AI improvement error:', error);
                                alert('Error improving description with AI');
                            } finally {
                                // Reset button state
                                improveBtn.disabled = false;
                                improveBtn.innerHTML = '<i class="fas fa-star me-1"></i> Improve with AI';
                            }
                        });

                        document.getElementById('addNewForm').addEventListener('submit', function(event) {
                            event.preventDefault(); // Prevent default form submission

                            // Make sure we're getting the field from the correct modal
                            const modal = document.getElementById('addNewModal');
                            const nameField = modal.querySelector('#newEntryName');
                            const rawValue = nameField.value;
                            const name = rawValue.trim();

                        // Detailed logging for debugging
                        console.log('Raw field value:', `"${rawValue}"`);
                        console.log('Trimmed field value:', `"${name}"`);
                        console.log('Field value length:', rawValue.length);
                        console.log('Trimmed value length:', name.length);
                        console.log('Field element:', nameField);

                        // Clear previous validation error styles
                        nameField.classList.remove('is-invalid');

                        // Check if the Name field is empty (using raw value first)
                        if (!rawValue || !name) {
                            console.error('Validation Failed: Name field is empty.');
                            console.error('Raw value empty:', !rawValue);
                            console.error('Trimmed value empty:', !name);
                            nameField.classList.add('is-invalid');
                            alert('Name is required.');
                            return;
                        }

                        // Proceed if the Name field has a value
                        console.log('Validation passed! Name field value:', name);
                        
                        // Get description field value
                        const descriptionField = modal.querySelector('#newEntryDescription');
                        const description = descriptionField.value.trim();

                        // Get quantity and unit if fields exist (when relationship allows it)
                        const quantityField = modal.querySelector('#newEntryQuantity');
                        const unitField = modal.querySelector('#newEntryUnit');
                        const quantity = quantityField ? quantityField.value : null;
                        const unit = unitField ? unitField.value : null;

                        // Disable the submit button to prevent double submission
                        const submitButton = modal.querySelector('button[type="submit"]');
                        submitButton.disabled = true;
                        submitButton.textContent = 'Creating...';

                        // Create the new entry and relationship
                        createNewEntryAndRelationship(definitionId, name, description, addNewModal, submitButton, quantity, unit);
                    });
                });
                });
            });

            // Add Existing Button
            document.querySelectorAll('.add-existing-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const definitionId = this.getAttribute('data-definition-id');
                    
                    // Get the relationship definition to determine which entry type we need
                    const relationshipDef = allRelationshipDefinitions.find(def => def.id == definitionId);
                    if (!relationshipDef) {
                        alert('Relationship definition not found');
                        return;
                    }
                    
                    // Determine which entry type the related entry should be
                    const isCurrentEntryFromSide = relationshipDef.entry_type_id_from == currentEntryTypeId;
                    const targetEntryTypeId = isCurrentEntryFromSide ? relationshipDef.entry_type_id_to : relationshipDef.entry_type_id_from;
                    const targetEntryTypeLabel = isCurrentEntryFromSide ? relationshipDef.entry_type_to_label : relationshipDef.entry_type_from_label;
                    
                    const modalHtml = `
                        <div class="modal fade" id="addExistingModal" tabindex="-1" aria-labelledby="addExistingModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addExistingModalLabel">Add Existing ${targetEntryTypeLabel}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="addExistingForm">
                                            <div class="mb-3">
                                                <label for="entrySearchInput" class="form-label">Search for ${targetEntryTypeLabel}:</label>
                                                <input type="text" class="form-control" id="entrySearchInput" placeholder="Type to search..." autocomplete="off">
                                                <div id="searchResults" class="mt-2" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; display: none;">
                                                    <!-- Search results will appear here -->
                                                </div>
                                                <input type="hidden" id="selectedEntryId" required>
                                                <div id="selectedEntryDisplay" class="mt-2 p-2 rounded" style="display: none; background-color: var(--theme-bg-surface, #f8f9fa);">
                                                    <small class="text-muted">Selected:</small>
                                                    <div id="selectedEntryName" class="fw-bold"></div>
                                                    <button type="button" class="btn btn-sm btn-warning mt-1" id="clearSelection">Clear Selection</button>
                                                </div>
                                            </div>
                                            ${relationshipDef.allow_quantity_unit ? `
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="existingEntryQuantity" class="form-label">Quantity:</label>
                                                        <input type="number" step="any" class="form-control" id="existingEntryQuantity" placeholder="e.g., 2.5">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="existingEntryUnit" class="form-label">Unit:</label>
                                                        <div class="position-relative">
                                                            <input type="text" class="form-control pe-5" id="existingEntryUnit" placeholder="e.g., kg, cups" list="existingEntryUnitSuggestions">
                                                            <button class="btn btn-outline-secondary position-absolute top-0 end-0 h-100 px-1 border-start-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Common units" style="border-top-left-radius: 0; border-bottom-left-radius: 0; margin: 2px 2px 2px 0; height: calc(100% - 4px); width: 32px;">
                                                                <i class="fas fa-list"></i>
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-end" id="existingEntryUnitDropdown">
                                                                <!-- Unit suggestions will be populated here -->
                                                            </ul>
                                                        </div>
                                                        <datalist id="existingEntryUnitSuggestions">
                                                            <!-- Unit suggestions for autocomplete -->
                                                        </datalist>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            <button type="submit" class="btn btn-theme-primary w-100" id="addExistingSubmitBtn" disabled>Add Relationship</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    const addExistingModal = new bootstrap.Modal(document.getElementById('addExistingModal'));
                    addExistingModal.show();

                    // Load unit suggestions if quantity/unit is allowed
                    if (relationshipDef.allow_quantity_unit) {
                        loadExistingEntryUnitSuggestions(definitionId);
                    }

                    // Get already related entry IDs for this definition to exclude them
                    const alreadyRelatedIds = new Set();
                    try {
                        const relResponse = await fetch(`/api/entries/${entryId}/relationships`);
                        const relationships = await relResponse.json();
                        relationships.forEach(rel => {
                            if (rel.definition_id == definitionId) {
                                alreadyRelatedIds.add(rel.related_entry_id);
                            }
                        });
                        // Also exclude the current entry itself
                        alreadyRelatedIds.add(parseInt(entryId));
                    } catch (error) {
                        console.error('Error fetching existing relationships:', error);
                    }

                    // Search functionality
                    const searchInput = document.getElementById('entrySearchInput');
                    const searchResults = document.getElementById('searchResults');
                    const selectedEntryId = document.getElementById('selectedEntryId');
                    const selectedEntryDisplay = document.getElementById('selectedEntryDisplay');
                    const selectedEntryName = document.getElementById('selectedEntryName');
                    const submitBtn = document.getElementById('addExistingSubmitBtn');
                    const clearBtn = document.getElementById('clearSelection');
                    
                    let searchTimeout;
                    
                    searchInput.addEventListener('input', function() {
                        clearTimeout(searchTimeout);
                        const query = this.value.trim();
                        
                        if (query.length < 2) {
                            searchResults.style.display = 'none';
                            return;
                        }
                        
                        searchTimeout = setTimeout(async () => {
                            try {
                                const response = await fetch(`/api/search_entries?q=${encodeURIComponent(query)}&entry_type_id=${targetEntryTypeId}`);
                                const entries = await response.json();
                                
                                // Filter out already related entries
                                const availableEntries = entries.filter(entry => !alreadyRelatedIds.has(entry.id));
                                
                                if (availableEntries.length === 0) {
                                    searchResults.innerHTML = '<div class="p-2 text-muted">No available entries found</div>';
                                } else {
                                    searchResults.innerHTML = availableEntries.map(entry => 
                                        `<div class="search-result-item p-2 border-bottom" data-entry-id="${entry.id}" data-entry-name="${entry.title}" style="cursor: pointer;">
                                            <div class="fw-semibold">${entry.title}</div>
                                            <small class="text-muted">${entry.entry_type_label}</small>
                                        </div>`
                                    ).join('');
                                    
                                    // Add click handlers for search results
                                    document.querySelectorAll('.search-result-item').forEach(item => {
                                        item.addEventListener('click', function() {
                                            const entryIdValue = this.getAttribute('data-entry-id');
                                            const entryName = this.getAttribute('data-entry-name');
                                            
                                            selectedEntryId.value = entryIdValue;
                                            selectedEntryName.textContent = entryName;
                                            selectedEntryDisplay.style.display = 'block';
                                            searchResults.style.display = 'none';
                                            searchInput.value = '';
                                            submitBtn.disabled = false;
                                        });
                                        
                                        // Add hover effect
                                        item.addEventListener('mouseenter', function() {
                                            this.style.backgroundColor = '#f8f9fa';
                                        });
                                        item.addEventListener('mouseleave', function() {
                                            this.style.backgroundColor = '';
                                        });
                                    });
                                }
                                
                                searchResults.style.display = 'block';
                            } catch (error) {
                                searchResults.innerHTML = '<div class="p-2 text-danger">Error searching entries</div>';
                                searchResults.style.display = 'block';
                            }
                        }, 300);
                    });
                    
                    // Clear selection handler
                    clearBtn.addEventListener('click', function() {
                        selectedEntryId.value = '';
                        selectedEntryDisplay.style.display = 'none';
                        submitBtn.disabled = true;
                        searchInput.focus();
                    });
                    
                    // Hide search results when clicking outside
                    document.addEventListener('click', function(e) {
                        if (!searchResults.contains(e.target) && e.target !== searchInput) {
                            searchResults.style.display = 'none';
                        }
                    });

                    document.getElementById('addExistingForm').addEventListener('submit', async function(event) {
                        event.preventDefault();
                        const relatedEntryId = selectedEntryId.value;
                        
                        if (!relatedEntryId) {
                            alert('Please select an entry first');
                            return;
                        }

                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Adding...';

                        try {
                            const requestBody = { 
                                definition_id: parseInt(definitionId), 
                                related_entry_id: parseInt(relatedEntryId) 
                            };
                            
                            // Add quantity and unit if the relationship allows it
                            if (relationshipDef.allow_quantity_unit) {
                                const quantity = document.getElementById('existingEntryQuantity').value;
                                const unit = document.getElementById('existingEntryUnit').value;
                                
                                if (quantity) {
                                    requestBody.quantity = parseFloat(quantity);
                                }
                                if (unit) {
                                    requestBody.unit = unit;
                                }
                            }

                            const response = await fetch(`/api/entries/${entryId}/relationships`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(requestBody)
                            });

                            if (response.ok) {
                                alert('Relationship added successfully!');
                                addExistingModal.hide();
                                loadRelatedRecords(); // Refresh the records
                            } else {
                                const error = await response.json();
                                alert(`Error: ${error.error}`);
                            }
                        } catch (error) {
                            alert(`Error: ${error.message}`);
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Add Relationship';
                        }
                    });
                    
                    // Clean up modal when closed
                    addExistingModal._element.addEventListener('hidden.bs.modal', function() {
                        document.getElementById('addExistingModal').remove();
                    });
                });
            });

            // Delete Related Button
            document.querySelectorAll('.delete-related-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const relationshipId = this.getAttribute('data-relationship-id');
                    
                    // Find the related entry ID from the current row
                    const row = this.closest('tr');
                    const bindNotesBtn = row.querySelector('.bind-notes-btn');
                    const relatedEntryId = bindNotesBtn ? bindNotesBtn.getAttribute('data-entry-id') : null;
                    const relatedEntryTitle = bindNotesBtn ? bindNotesBtn.getAttribute('data-entry-title') : null;
                    
                    if (confirm('Are you sure you want to delete this relationship?')) {
                        try {
                            await fetch(`/api/relationships/${relationshipId}`, { method: 'DELETE' });
                            
                            // Clean up note binding if it exists for this entry
                            if (relatedEntryId) {
                                const entryIdInt = parseInt(relatedEntryId);
                                
                                try {
                                    // Call the cleanup API to remove note bindings if no relationships remain
                                    const cleanupResponse = await fetch('/api/note_bindings/cleanup', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            source_entry_id: entryId,
                                            target_entry_id: entryIdInt
                                        })
                                    });
                                    
                                    if (cleanupResponse.ok) {
                                        const cleanupResult = await cleanupResponse.json();
                                        if (cleanupResult.deleted_count > 0) {
                                            console.log(`Removed note binding for deleted relationship with entry ${relatedEntryTitle} (ID: ${entryIdInt})`);
                                            
                                            // Update local state
                                            noteBingingState.delete(entryIdInt);
                                            
                                            // Update UI - remove binding state styling
                                            updateBindNotesButtonState(entryIdInt, false);
                                            
                                            // Show notification
                                            console.log(`Note binding automatically removed for ${relatedEntryTitle} since relationship was deleted`);
                                        }
                                    } else {
                                        console.error('Failed to cleanup note bindings:', cleanupResponse.statusText);
                                    }
                                } catch (cleanupError) {
                                    console.error('Error cleaning up note bindings:', cleanupError);
                                }
                            }
                            
                            loadRelatedRecords(); // Refresh the records
                        } catch (error) {
                            alert(`Error: ${error.message}`);
                        }
                    }
                });
            });

            // Bind Notes Button
            document.querySelectorAll('.bind-notes-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const entryId = this.getAttribute('data-entry-id');
                    const entryTitle = this.getAttribute('data-entry-title');
                    showBindNotesModal(entryId, entryTitle);
                });
            });

            // Edit Quantity/Unit Button
            document.querySelectorAll('.edit-quantity-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const relationshipId = this.getAttribute('data-relationship-id');
                    const quantity = this.getAttribute('data-quantity');
                    const unit = this.getAttribute('data-unit');
                    const definitionId = this.getAttribute('data-definition-id');
                    
                    showEditQuantityUnitModal(relationshipId, quantity, unit, definitionId);
                });
            });
        }

        // Function to create new entry and establish relationship
        async function createNewEntryAndRelationship(definitionId, entryName, entryDescription, modal, submitButton, quantity = null, unit = null) {
            try {
                // Find the relationship definition from the already loaded definitions
                let relationshipDef = allRelationshipDefinitions.find(def => def.id == definitionId);
                
                // If not found in cache, fetch all definitions again
                if (!relationshipDef) {
                    const definitionsResponse = await fetch(`/api/relationship_definitions`);
                    if (!definitionsResponse.ok) {
                        throw new Error('Failed to fetch relationship definitions');
                    }
                    allRelationshipDefinitions = await definitionsResponse.json();
                    relationshipDef = allRelationshipDefinitions.find(def => def.id == definitionId);
                }
                
                if (!relationshipDef) {
                    throw new Error('Relationship definition not found');
                }
                
                console.log('Found relationship definition:', relationshipDef);
                
                // Determine which entry type the new entry should be based on the current entry's role
                const isCurrentEntryFromSide = relationshipDef.entry_type_id_from == currentEntryTypeId;
                const newEntryTypeId = isCurrentEntryFromSide ? relationshipDef.entry_type_id_to : relationshipDef.entry_type_id_from;
                
                console.log('Creating entry with:', {
                    title: entryName,
                    description: entryDescription,
                    entry_type_id: newEntryTypeId,
                    currentEntryFromSide: isCurrentEntryFromSide
                });
                
                // Validate that we have the required fields
                if (!entryName || !newEntryTypeId) {
                    console.error('Missing required fields:');
                    console.error('Title (entryName):', entryName);
                    console.error('Entry Type ID:', newEntryTypeId);
                    console.error('Current entry from side:', isCurrentEntryFromSide);
                    throw new Error('Missing required fields for entry creation');
                }
                
                // Create the new entry
                const createEntryResponse = await fetch('/api/entries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: entryName,  // API expects 'title', not 'name'
                        description: entryDescription,
                        entry_type_id: newEntryTypeId // Use the dynamically determined entry type
                    })
                });

                if (!createEntryResponse.ok) {
                    const error = await createEntryResponse.json();
                    console.error('Create entry failed:', error);
                    console.error('Response status:', createEntryResponse.status);
                    throw new Error(error.error || error.message || 'Failed to create new entry');
                }

                const newEntry = await createEntryResponse.json();
                console.log('New entry created:', newEntry);
                
                // Extract entry ID from the redirect URL (format: "/entry/5")
                const newEntryId = newEntry.redirect.split('/').pop();
                console.log('Extracted new entry ID:', newEntryId);

                // Create the relationship between the current entry and the new entry
                const relationshipData = {
                    definition_id: parseInt(definitionId),
                    related_entry_id: parseInt(newEntryId)
                };
                
                // Add quantity and unit if provided and allowed
                if (relationshipDef.allow_quantity_unit) {
                    if (quantity !== null && quantity !== '') {
                        relationshipData.quantity = parseFloat(quantity);
                    }
                    if (unit && unit.trim()) {
                        relationshipData.unit = unit.trim();
                    }
                }
                
                console.log('Creating relationship with data:', relationshipData);
                
                const createRelationshipResponse = await fetch(`/api/entries/${entryId}/relationships`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(relationshipData)
                });

                if (!createRelationshipResponse.ok) {
                    const error = await createRelationshipResponse.json();
                    console.error('Create relationship failed:', error);
                    console.error('Response status:', createRelationshipResponse.status);
                    throw new Error(error.error || error.message || 'Failed to create relationship');
                }

                console.log('Relationship created successfully');
                
                // Hide the modal first
                modal.hide();
                
                // Ask user if they want to go to the new entry or stay here
                const goToNewEntry = confirm(`New entry "${entryName}" created and relationship established successfully!\n\nWould you like to go to the new entry now?`);
                
                if (goToNewEntry && newEntry.redirect) {
                    // Navigate to the newly created entry
                    window.location.href = newEntry.redirect;
                } else {
                    // Stay on current entry and refresh the related records
                    loadRelatedRecords();
                }

                // Clean up the modal from DOM
                setTimeout(() => {
                    const modalElement = document.getElementById('addNewModal');
                    if (modalElement) {
                        modalElement.remove();
                    }
                }, 500);

            } catch (error) {
                console.error('Error creating entry and relationship:', error);
                alert(`Error: ${error.message}`);
                
                // Re-enable the submit button
                submitButton.disabled = false;
                submitButton.textContent = 'Add';
            }
        }

        // Edit Quantity/Unit Modal Function
        async function showEditQuantityUnitModal(relationshipId, currentQuantity, currentUnit, definitionId) {
            // Get the modal elements
            const modal = new bootstrap.Modal(document.getElementById('editQuantityUnitModal'));
            const quantityInput = document.getElementById('editQuantityInput');
            const unitInput = document.getElementById('editUnitInput');
            const relationshipIdInput = document.getElementById('editRelationshipId');
            const form = document.getElementById('editQuantityUnitForm');
            
            // Populate current values
            quantityInput.value = currentQuantity || '';
            unitInput.value = currentUnit || '';
            relationshipIdInput.value = relationshipId;
            
            // Load unit suggestions
            await loadUnitSuggestions(definitionId);
            
            // Show modal
            modal.show();
            
            // Handle form submission
            const handleSubmit = async (e) => {
                e.preventDefault();
                
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Updating...';
                
                try {
                    const response = await fetch(`/api/relationships/${relationshipId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            quantity: quantityInput.value ? parseFloat(quantityInput.value) : null,
                            unit: unitInput.value.trim() || null
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to update quantity/unit');
                    }
                    
                    // Close modal and refresh
                    modal.hide();
                    loadRelatedRecords();
                    
                } catch (error) {
                    console.error('Error updating quantity/unit:', error);
                    alert('Error updating quantity/unit: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            };
            
            // Remove any existing listeners and add new one
            form.removeEventListener('submit', handleSubmit);
            form.addEventListener('submit', handleSubmit);
            
            // Clean up when modal is hidden
            modal._element.addEventListener('hidden.bs.modal', function() {
                form.removeEventListener('submit', handleSubmit);
            }, { once: true });
        }

        // Load unit suggestions for the edit modal
        async function loadUnitSuggestions(definitionId) {
            try {
                // Get relationship definition for context
                const relationshipDef = allRelationshipDefinitions.find(def => def.id == definitionId);
                
                if (relationshipDef) {
                    // Get contextual suggestions
                    const response = await fetch('/api/units/suggestions/relationship', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            relationship_name: relationshipDef.name,
                            from_type: relationshipDef.entry_type_from_label,
                            to_type: relationshipDef.entry_type_to_label
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        populateUnitSuggestions(data.suggestions);
                        return;
                    }
                }
                
                // Fallback to general suggestions
                const generalResponse = await fetch('/api/units/suggestions');
                if (generalResponse.ok) {
                    const data = await generalResponse.json();
                    populateUnitSuggestions(data.units);
                }
                
            } catch (error) {
                console.error('Error loading unit suggestions:', error);
                // Use fallback static suggestions
                populateUnitSuggestions(['g', 'kg', 'ml', 'l', 'cup', 'tbsp', 'tsp', 'pcs', 'units', 'each']);
            }
        }
        
        // Populate unit suggestions in dropdown and datalist
        function populateUnitSuggestions(units) {
            const dropdown = document.getElementById('unitSuggestionsDropdown');
            const datalist = document.getElementById('unitSuggestions');
            const unitInput = document.getElementById('editUnitInput');
            
            // Clear existing suggestions
            dropdown.innerHTML = '';
            datalist.innerHTML = '';
            
            // Populate dropdown
            units.forEach(unit => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" data-unit="${unit}">${unit}</a>`;
                dropdown.appendChild(li);
                
                const option = document.createElement('option');
                option.value = unit;
                datalist.appendChild(option);
            });
            
            // Add click handlers for dropdown items
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    unitInput.value = this.getAttribute('data-unit');
                });
            });
        }

        // Load unit suggestions for the new entry modal
        async function loadNewEntryUnitSuggestions(definitionId) {
            try {
                // Get relationship definition for context
                const relationshipDef = allRelationshipDefinitions.find(def => def.id == definitionId);
                
                if (relationshipDef) {
                    // Get contextual suggestions
                    const response = await fetch('/api/units/suggestions/relationship', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            relationship_name: relationshipDef.name,
                            from_type: relationshipDef.entry_type_from_label,
                            to_type: relationshipDef.entry_type_to_label
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        populateNewEntryUnitSuggestions(data.suggestions);
                        return;
                    }
                }
                
                // Fallback to general suggestions
                const generalResponse = await fetch('/api/units/suggestions');
                if (generalResponse.ok) {
                    const data = await generalResponse.json();
                    populateNewEntryUnitSuggestions(data.units);
                }
                
            } catch (error) {
                console.error('Error loading unit suggestions:', error);
                // Use fallback static suggestions
                populateNewEntryUnitSuggestions(['g', 'kg', 'ml', 'l', 'cup', 'tbsp', 'tsp', 'pcs', 'units', 'each']);
            }
        }
        
        // Populate unit suggestions for new entry modal
        function populateNewEntryUnitSuggestions(units) {
            const dropdown = document.getElementById('newEntryUnitDropdown');
            const datalist = document.getElementById('newEntryUnitSuggestions');
            const unitInput = document.getElementById('newEntryUnit');
            
            if (!dropdown || !datalist || !unitInput) return;
            
            // Clear existing suggestions
            dropdown.innerHTML = '';
            datalist.innerHTML = '';
            
            // Populate dropdown
            units.forEach(unit => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" data-unit="${unit}">${unit}</a>`;
                dropdown.appendChild(li);
                
                const option = document.createElement('option');
                option.value = unit;
                datalist.appendChild(option);
            });
            
            // Add click handlers for dropdown items
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    unitInput.value = this.getAttribute('data-unit');
                });
            });
        }

        // Load unit suggestions for the existing entry modal
        async function loadExistingEntryUnitSuggestions(definitionId) {
            try {
                // Get relationship definition for context
                const relationshipDef = allRelationshipDefinitions.find(def => def.id == definitionId);
                
                if (relationshipDef) {
                    // Get contextual suggestions
                    const response = await fetch('/api/units/suggestions/relationship', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            relationship_name: relationshipDef.name,
                            from_type: relationshipDef.entry_type_from_label,
                            to_type: relationshipDef.entry_type_to_label
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        populateExistingEntryUnitSuggestions(data.suggestions);
                        return;
                    }
                }
                
                // Fallback to general suggestions
                const generalResponse = await fetch('/api/units/suggestions');
                if (generalResponse.ok) {
                    const data = await generalResponse.json();
                    populateExistingEntryUnitSuggestions(data.units);
                }
                
            } catch (error) {
                console.error('Error loading unit suggestions:', error);
                // Use fallback static suggestions
                populateExistingEntryUnitSuggestions(['g', 'kg', 'ml', 'l', 'cup', 'tbsp', 'tsp', 'pcs', 'units', 'each']);
            }
        }
        
        // Populate unit suggestions for existing entry modal
        function populateExistingEntryUnitSuggestions(units) {
            const dropdown = document.getElementById('existingEntryUnitDropdown');
            const datalist = document.getElementById('existingEntryUnitSuggestions');
            const unitInput = document.getElementById('existingEntryUnit');
            
            if (!dropdown || !datalist || !unitInput) return;
            
            // Clear existing suggestions
            dropdown.innerHTML = '';
            datalist.innerHTML = '';
            
            // Populate dropdown
            units.forEach(unit => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" data-unit="${unit}">${unit}</a>`;
                dropdown.appendChild(li);
                
                const option = document.createElement('option');
                option.value = unit;
                datalist.appendChild(option);
            });
            
            // Add click handlers for dropdown items
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    unitInput.value = this.getAttribute('data-unit');
                });
            });
        }

        // Load unit suggestions for shared relationship modal
        async function loadSharedUnitSuggestions(definitionId, targets) {
            try {
                // Get relationship definition for context
                const relationshipDef = allRelationshipDefinitions.find(def => def.id == definitionId);
                
                let unitSuggestions = [];
                
                if (relationshipDef) {
                    // Get contextual suggestions
                    const response = await fetch('/api/units/suggestions/relationship', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            relationship_name: relationshipDef.name,
                            from_type: relationshipDef.entry_type_from_label,
                            to_type: relationshipDef.entry_type_to_label
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        unitSuggestions = data.suggestions;
                    }
                }
                
                // Fallback to general suggestions if contextual failed
                if (unitSuggestions.length === 0) {
                    const generalResponse = await fetch('/api/units/suggestions');
                    if (generalResponse.ok) {
                        const data = await generalResponse.json();
                        unitSuggestions = data.units;
                    }
                }
                
                // Apply suggestions to all targets
                targets.forEach(target => {
                    populateSharedUnitSuggestions(target.target_entry.id, unitSuggestions);
                });
                
            } catch (error) {
                console.error('Error loading shared unit suggestions:', error);
                // Use fallback static suggestions for all targets
                const fallbackUnits = ['g', 'kg', 'ml', 'l', 'cup', 'tbsp', 'tsp', 'pcs', 'units', 'each'];
                targets.forEach(target => {
                    populateSharedUnitSuggestions(target.target_entry.id, fallbackUnits);
                });
            }
        }
        
        // Populate unit suggestions for shared relationship modal
        function populateSharedUnitSuggestions(targetId, units) {
            const dropdown = document.getElementById(`sharedUnitDropdown-${targetId}`);
            const datalist = document.getElementById(`sharedUnitSuggestions-${targetId}`);
            const unitInput = document.querySelector(`input[list="sharedUnitSuggestions-${targetId}"]`);
            
            if (!dropdown || !datalist || !unitInput) return;
            
            // Clear existing suggestions
            dropdown.innerHTML = '';
            datalist.innerHTML = '';
            
            // Populate dropdown
            units.forEach(unit => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" data-unit="${unit}">${unit}</a>`;
                dropdown.appendChild(li);
                
                const option = document.createElement('option');
                option.value = unit;
                datalist.appendChild(option);
            });
            
            // Add click handlers for dropdown items
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    unitInput.value = this.getAttribute('data-unit');
                });
            });
        }

        // --- Shared Relationship Opportunities Functions ---

        async function loadSharedRelationshipOpportunities() {
            const sharedRelationshipsSection = document.getElementById('sharedRelationshipsSection');
            const sharedRelationshipsContainer = document.getElementById('sharedRelationshipsContainer');
            const loadingSharedRelationships = document.getElementById('loadingSharedRelationships');
            
            if (!sharedRelationshipsContainer) {
                console.error('sharedRelationshipsContainer element not found');
                return;
            }
            
            try {
                if (loadingSharedRelationships) {
                    loadingSharedRelationships.style.display = 'block';
                }
                
                const response = await fetch(`/api/entries/${entryId}/shared_relationship_opportunities`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const opportunities = await response.json();
                
                if (opportunities.length === 0) {
                    // Hide the section if no opportunities are available
                    sharedRelationshipsSection.style.display = 'none';
                    return;
                }
                
                // Show the section and render opportunities
                sharedRelationshipsSection.style.display = 'block';
                renderSharedRelationshipOpportunities(opportunities);
                
            } catch (error) {
                console.error('Error loading shared relationship opportunities:', error);
                sharedRelationshipsContainer.innerHTML = '<p class="text-danger text-center">Error loading suggestions.</p>';
            } finally {
                if (loadingSharedRelationships) {
                    loadingSharedRelationships.style.display = 'none';
                }
            }
        }

        function renderSharedRelationshipOpportunities(opportunities) {
            const sharedRelationshipsContainer = document.getElementById('sharedRelationshipsContainer');
            
            let html = '';
            
            opportunities.forEach((opportunity, index) => {
                const intermediateEntry = opportunity.intermediate_entry;
                const relationshipDef = opportunity.relationship_definition;
                const targets = opportunity.potential_targets;
                
                html += `
                    <div class="opportunity-group mb-4 p-3 border rounded" data-opportunity-index="${index}">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="mb-1">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    From <strong>${intermediateEntry.title}</strong>
                                </h6>
                                <small class="text-muted">
                                    Add ${relationshipDef.name} relationships (${targets.length} available)
                                </small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success" onclick="selectAllTargets(${index})">
                                    <i class="fas fa-check-double me-1"></i>Select All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="deselectAllTargets(${index})">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                        
                        <div class="targets-list">
                            ${targets.map((target, targetIndex) => {
                                const isSelected = true; // Default to selected
                                const targetEntry = target.target_entry;
                                const sourceRel = target.source_relationship;
                                
                                return `
                                    <div class="form-check target-item mb-2 p-2 border rounded ${isSelected ? 'bg-light' : ''}" 
                                         data-target-index="${targetIndex}">
                                        <input class="form-check-input target-checkbox" 
                                               type="checkbox" 
                                               ${isSelected ? 'checked' : ''}
                                               id="target_${index}_${targetIndex}"
                                               data-target-id="${targetEntry.id}"
                                               data-definition-id="${relationshipDef.id}">
                                        <label class="form-check-label flex-grow-1" for="target_${index}_${targetIndex}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>${targetEntry.title}</strong>
                                                    <small class="text-muted d-block">${targetEntry.entry_type_id}</small>
                                                </div>
                                                ${sourceRel.quantity || sourceRel.unit ? `
                                                    <div class="text-end">
                                                        <small class="text-muted">
                                                            ${sourceRel.quantity || ''} ${sourceRel.unit || ''}
                                                        </small>
                                                        ${relationshipDef.allow_quantity_unit ? `
                                                            <div class="quantity-inputs mt-1" style="display: ${isSelected ? 'block' : 'none'}">
                                                                <input type="number" step="any" class="form-control form-control-sm d-inline-block" 
                                                                       style="width: 80px;" 
                                                                       placeholder="Qty"
                                                                       value="${sourceRel.quantity || ''}"
                                                                       data-type="quantity">
                                                                <input type="text" class="form-control form-control-sm d-inline-block ms-1" 
                                                                       style="width: 60px;" 
                                                                       placeholder="Unit"
                                                                       value="${sourceRel.unit || ''}"
                                                                       data-type="unit">
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="text-end mt-3">
                            <button class="btn btn-primary" onclick="createSelectedRelationships(${index})">
                                <i class="fas fa-plus me-1"></i>Create Selected Relationships
                            </button>
                        </div>
                    </div>
                `;
            });
            
            sharedRelationshipsContainer.innerHTML = html;
            
            // Add event listeners for checkboxes to show/hide quantity inputs
            attachSharedRelationshipEventListeners();
        }

        function attachSharedRelationshipEventListeners() {
            document.querySelectorAll('.target-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const targetItem = this.closest('.target-item');
                    const quantityInputs = targetItem.querySelector('.quantity-inputs');
                    
                    if (this.checked) {
                        targetItem.classList.add('bg-light');
                        if (quantityInputs) {
                            quantityInputs.style.display = 'block';
                        }
                    } else {
                        targetItem.classList.remove('bg-light');
                        if (quantityInputs) {
                            quantityInputs.style.display = 'none';
                        }
                    }
                });
            });
        }

        function selectAllTargets(opportunityIndex) {
            const opportunityGroup = document.querySelector(`[data-opportunity-index="${opportunityIndex}"]`);
            const checkboxes = opportunityGroup.querySelectorAll('.target-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        function deselectAllTargets(opportunityIndex) {
            const opportunityGroup = document.querySelector(`[data-opportunity-index="${opportunityIndex}"]`);
            const checkboxes = opportunityGroup.querySelectorAll('.target-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        async function createSelectedRelationships(opportunityIndex) {
            const opportunityGroup = document.querySelector(`[data-opportunity-index="${opportunityIndex}"]`);
            const selectedCheckboxes = opportunityGroup.querySelectorAll('.target-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one relationship to create.');
                return;
            }
            
            // Get the relationship definition ID from the first checkbox to check cardinality
            const firstCheckbox = selectedCheckboxes[0];
            const definitionId = parseInt(firstCheckbox.getAttribute('data-definition-id'));
            
            // Find the relationship definition to check cardinality
            const relationshipDef = allRelationshipDefinitions.find(def => def.id === definitionId);
            console.log('Debug - relationshipDef:', relationshipDef);
            console.log('Debug - allRelationshipDefinitions:', allRelationshipDefinitions);
            
            if (relationshipDef) {
                // Count existing relationships for this definition
                const relatedRecordsResponse = await fetch(`/api/entries/${entryId}/relationships`);
                const existingRelationships = await relatedRecordsResponse.json();
                const existingForThisDef = existingRelationships.filter(rel => rel.definition_id === definitionId);
                
                // Determine if current entry is the "from" or "to" side of this relationship
                const isFromSide = relationshipDef.entry_type_id_from == currentEntryTypeId;
                
                // Check the appropriate cardinality based on the current entry's role in the relationship
                const relevantCardinality = isFromSide ? relationshipDef.cardinality_from : relationshipDef.cardinality_to;
                
                console.log('Debug - cardinality check:', {
                    definitionId: definitionId,
                    currentEntryTypeId: currentEntryTypeId,
                    isFromSide: isFromSide,
                    cardinality_from: relationshipDef.cardinality_from,
                    cardinality_to: relationshipDef.cardinality_to,
                    relevantCardinality: relevantCardinality,
                    existingCount: existingForThisDef.length,
                    selectedCount: selectedCheckboxes.length,
                    existingRelationships: existingForThisDef
                });
                
                // Check if adding the selected relationships would exceed the limit
                if (relevantCardinality !== -1) {
                    const totalAfterAdd = existingForThisDef.length + selectedCheckboxes.length;
                    if (totalAfterAdd > relevantCardinality) {
                        const maxCanAdd = relevantCardinality - existingForThisDef.length;
                        alert(`Cannot create ${selectedCheckboxes.length} relationships. This relationship is limited to ${relevantCardinality} item(s) and you already have ${existingForThisDef.length}. You can add at most ${maxCanAdd} more.`);
                        return;
                    }
                }
            } else {
                console.log('Debug - relationshipDef not found for ID:', definitionId);
            }
            
            const relationships = [];
            
            selectedCheckboxes.forEach(checkbox => {
                const targetItem = checkbox.closest('.target-item');
                const quantityInput = targetItem.querySelector('input[data-type="quantity"]');
                const unitInput = targetItem.querySelector('input[data-type="unit"]');
                
                relationships.push({
                    definition_id: parseInt(checkbox.getAttribute('data-definition-id')),
                    target_entry_id: parseInt(checkbox.getAttribute('data-target-id')),
                    quantity: quantityInput ? quantityInput.value : null,
                    unit: unitInput ? unitInput.value : null
                });
            });
            
            const createButton = opportunityGroup.querySelector('button[onclick*="createSelectedRelationships"]');
            const originalText = createButton.innerHTML;
            createButton.disabled = true;
            createButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';
            
            try {
                const response = await fetch(`/api/entries/${entryId}/create_shared_relationships`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        relationships: relationships
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create relationships');
                }
                
                const result = await response.json();
                
                if (result.created.length > 0) {
                    alert(`Successfully created ${result.created.length} relationships!`);
                    
                    // Refresh related records and shared opportunities
                    loadRelatedRecords();
                    loadSharedRelationshipOpportunities();
                } else {
                    alert('No relationships were created. ' + (result.failed.length > 0 ? 'Some failed due to errors.' : ''));
                }
                
                if (result.failed.length > 0) {
                    console.error('Failed relationships:', result.failed);
                }
                
            } catch (error) {
                console.error('Error creating shared relationships:', error);
                alert('Error creating relationships: ' + error.message);
            } finally {
                createButton.disabled = false;
                createButton.innerHTML = originalText;
            }
        }

        // --- Shared Relationships Functions ---
        
        async function loadSharedRelationships() {
            try {
                const response = await fetch(`/api/entries/${entryId}/shared_relationship_opportunities`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const opportunities = await response.json();
                console.log('Loaded shared relationship opportunities:', opportunities);
                
                // Hide the separate shared relationships section since we're integrating into grids
                const sharedRelationshipsSection = document.getElementById('sharedRelationshipsSection');
                if (sharedRelationshipsSection) {
                    sharedRelationshipsSection.style.display = 'none';
                }
                
                // Integrate opportunities into existing relationship grids
                integrateSharedOpportunitiesIntoGrids(opportunities);
                
            } catch (error) {
                console.error('Error loading shared relationship opportunities:', error);
            }
        }
        
        function integrateSharedOpportunitiesIntoGrids(opportunities) {
            console.log('Integrating opportunities into grids:', opportunities);
            
            // Group opportunities by relationship definition, preserving all intermediate entries
            const opportunitiesByDef = opportunities.reduce((acc, opportunity) => {
                const defId = opportunity.relationship_definition.id;
                if (!acc[defId]) {
                    acc[defId] = [];
                }
                acc[defId].push(opportunity);
                return acc;
            }, {});
            
            console.log('Opportunities by definition:', opportunitiesByDef);
            
            // For each relationship definition card, check if there are opportunities
            const cards = document.querySelectorAll('[data-definition-id]');
            console.log('Found cards with data-definition-id:', cards.length);
            
            cards.forEach(card => {
                const defId = parseInt(card.getAttribute('data-definition-id'));
                console.log('Checking card for definition ID:', defId);
                const opportunities = opportunitiesByDef[defId];
                
                if (opportunities && opportunities.length > 0) {
                    // Check if any opportunity has potential targets
                    const hasTargets = opportunities.some(opp => opp.potential_targets.length > 0);
                    if (hasTargets) {
                        console.log('Adding button for definition ID:', defId, opportunities);
                        addSharedRelationshipButtonToGrid(card, opportunities);
                    } else {
                        console.log('No opportunities with targets for definition ID:', defId);
                    }
                } else {
                    console.log('No opportunities for definition ID:', defId);
                }
            });
        }
        
        function addSharedRelationshipButtonToGrid(card, opportunities) {
            console.log('Adding button to card:', card, opportunities);
            
            // Check if button already exists
            if (card.querySelector('.shared-relationship-btn')) {
                console.log('Button already exists, skipping');
                return;
            }
            
            const cardHeader = card.querySelector('.card-header');
            console.log('Card header found:', cardHeader);
            if (!cardHeader) return;
            
            const headerButtons = cardHeader.querySelector('.header-buttons') || 
                                 cardHeader.querySelector('.d-flex .ms-auto') ||
                                 cardHeader.querySelector('.btn-group') ||
                                 cardHeader.querySelector('.d-flex.gap-2');
            
            console.log('Header buttons container found:', headerButtons);
            if (!headerButtons) {
                console.log('No header buttons container found');
                return;
            }
            
            // Calculate total potential targets across all opportunities
            const totalTargets = opportunities.reduce((sum, opp) => sum + opp.potential_targets.length, 0);
            const relationshipDef = opportunities[0].relationship_definition;
            
            // Create the shared relationship button
            const sharedBtn = document.createElement('button');
            sharedBtn.className = 'btn btn-sm btn-theme-secondary shared-relationship-btn ms-1';
            sharedBtn.innerHTML = `<i class="fas fa-share-alt me-1"></i><span class="d-none d-md-inline">From ${opportunities.length > 1 ? `${opportunities.length} entries` : opportunities[0].intermediate_entry.title}</span>`;
            sharedBtn.title = `Add ${totalTargets} ${relationshipDef.to_type_label.toLowerCase()}(s) from ${opportunities.length > 1 ? `${opportunities.length} different entries` : opportunities[0].intermediate_entry.title}`;
            
            console.log('Created button:', sharedBtn);
            
            // Add click handler
            sharedBtn.addEventListener('click', function() {
                console.log('Shared relationship button clicked');
                showSharedRelationshipModal(opportunities, card);
            });
            
            headerButtons.appendChild(sharedBtn);
            console.log('Button added to header');
        }
        
        function showSharedRelationshipModal(opportunities, card) {
            const modalId = 'sharedRelationshipModal';
            
            // Remove existing modal if it exists
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }
            
            const relationshipDef = opportunities[0].relationship_definition;
            const multipleIntermediate = opportunities.length > 1;
            
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="${modalId}Label">
                                    <i class="fas fa-share-alt me-2"></i>
                                    Add ${relationshipDef.to_type_label}s ${multipleIntermediate ? 'from Related Entries' : `from ${opportunities[0].intermediate_entry.title}`}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ${multipleIntermediate ? `
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Multiple entries have ${relationshipDef.to_type_label.toLowerCase()}s that can be added to this ${relationshipDef.from_type_label.toLowerCase()}.
                                        Select which entry to inherit relationships from.
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="form-label">
                                            <strong>Select source entry:</strong>
                                        </label>
                                        <div class="intermediate-entry-selection">
                                            ${opportunities.map((opp, index) => `
                                                <div class="form-check mb-2 p-3 border rounded">
                                                    <input class="form-check-input intermediate-radio" 
                                                           type="radio" 
                                                           name="intermediateEntry" 
                                                           value="${index}"
                                                           id="intermediate-${index}"
                                                           ${index === 0 ? 'checked' : ''}>
                                                    <label class="form-check-label" for="intermediate-${index}">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <strong>${opp.intermediate_entry.title}</strong>
                                                                <br><small class="text-muted">${opp.potential_targets.length} ${relationshipDef.to_type_label.toLowerCase()}(s) available</small>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        These ${relationshipDef.to_type_label.toLowerCase()}s are currently related to 
                                        <strong>${opportunities[0].intermediate_entry.title}</strong> and can be added to this ${relationshipDef.from_type_label.toLowerCase()}.
                                    </div>
                                `}
                                
                                <form id="sharedRelationshipForm">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <strong>Select ${relationshipDef.to_type_label}s to add:</strong>
                                        </label>
                                        <div class="shared-targets-selection" style="max-height: 300px; overflow-y: auto;" id="targetsContainer">
                                            <!-- Targets will be populated dynamically -->
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-4">
                                        <div>
                                            <button type="button" class="btn btn-sm btn-theme-secondary" id="selectAllBtn">
                                                <i class="fas fa-check-square me-1"></i>Select All
                                            </button>
                                            <button type="button" class="btn btn-sm btn-theme-secondary ms-2" id="selectNoneBtn">
                                                <i class="fas fa-square me-1"></i>Select None
                                            </button>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="text-muted me-3" id="selectionCount">
                                                0 of 0 selected
                                            </span>
                                            <button type="submit" class="btn btn-theme-primary" id="createRelationshipsBtn" disabled>
                                                <i class="fas fa-plus me-1"></i>Add Selected
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
            
            // Add event handlers
            setupEnhancedSharedRelationshipModalHandlers(modalId, opportunities, card);
            
            // Clean up modal when closed
            document.getElementById(modalId).addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
        
        function setupEnhancedSharedRelationshipModalHandlers(modalId, opportunities, card) {
            const modal = document.getElementById(modalId);
            const selectAllBtn = modal.querySelector('#selectAllBtn');
            const selectNoneBtn = modal.querySelector('#selectNoneBtn');
            const selectionCount = modal.querySelector('#selectionCount');
            const createBtn = modal.querySelector('#createRelationshipsBtn');
            const form = modal.querySelector('#sharedRelationshipForm');
            const targetsContainer = modal.querySelector('#targetsContainer');
            const intermediateRadios = modal.querySelectorAll('.intermediate-radio');
            
            let currentTargets = [];
            
            function updateTargetsDisplay() {
                const selectedIntermediateIndex = document.querySelector('.intermediate-radio:checked')?.value || '0';
                const selectedOpportunity = opportunities[parseInt(selectedIntermediateIndex)];
                currentTargets = selectedOpportunity.potential_targets;
                const relationshipDef = selectedOpportunity.relationship_definition;
                
                targetsContainer.innerHTML = currentTargets.map(target => `
                    <div class="form-check mb-2 p-3 border rounded">
                        <div class="d-flex align-items-start">
                            <input class="form-check-input shared-modal-checkbox me-3 mt-1" 
                                   type="checkbox" 
                                   value="${target.target_entry.id}"
                                   data-definition-id="${relationshipDef.id}"
                                   data-target-title="${target.target_entry.title}"
                                   ${relationshipDef.allow_quantity_unit && target.source_relationship.quantity ? 
                                     `data-quantity="${target.source_relationship.quantity}" data-unit="${target.source_relationship.unit || ''}"` : 
                                     ''}
                                   id="shared-modal-${target.target_entry.id}"
                                   checked>
                            <div class="flex-grow-1">
                                <label class="form-check-label d-block" for="shared-modal-${target.target_entry.id}">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                        <div class="me-3 mb-2 mb-md-0 flex-grow-1">
                                            <strong>${target.target_entry.title}</strong>
                                            ${target.source_relationship.quantity ? 
                                              `<br><small class="text-muted">Original: ${target.source_relationship.quantity}${target.source_relationship.unit ? ' ' + target.source_relationship.unit : ''}</small>` : 
                                              ''}
                                        </div>
                                        ${relationshipDef.allow_quantity_unit ? 
                                          `<div class="quantity-inputs">
                                                <div class="row g-2">
                                                    <div class="col-12 col-md-6">
                                                        <input type="number" 
                                                               class="form-control form-control-sm quantity-input" 
                                                               placeholder="Quantity" 
                                                               value="${target.source_relationship.quantity || ''}"
                                                               step="any">
                                                    </div>
                                                    <div class="col-12 col-md-6">
                                                        <div class="position-relative">
                                                            <input type="text" 
                                                                   class="form-control form-control-sm unit-input pe-5" 
                                                                   placeholder="Unit" 
                                                                   value="${target.source_relationship.unit || ''}"
                                                                   list="sharedUnitSuggestions-${target.target_entry.id}">
                                                            <button class="btn btn-outline-secondary position-absolute top-0 end-0 h-100 px-1 border-start-0" 
                                                                    type="button" 
                                                                    data-bs-toggle="dropdown" 
                                                                    aria-expanded="false" 
                                                                    title="Common units" 
                                                                    style="border-top-left-radius: 0; border-bottom-left-radius: 0; margin: 2px 2px 2px 0; height: calc(100% - 4px); width: 32px;">
                                                                <i class="fas fa-list"></i>
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-end" id="sharedUnitDropdown-${target.target_entry.id}">
                                                                <!-- Unit suggestions will be populated here -->
                                                            </ul>
                                                        </div>
                                                        <datalist id="sharedUnitSuggestions-${target.target_entry.id}">
                                                            <!-- Unit suggestions for autocomplete -->
                                                        </datalist>
                                                    </div>
                                                </div>
                                           </div>` : ''}
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Re-attach event listeners for new checkboxes
                const checkboxes = modal.querySelectorAll('.shared-modal-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectionCount);
                });
                
                // Load unit suggestions for each target if quantity/unit is allowed
                if (relationshipDef.allow_quantity_unit) {
                    loadSharedUnitSuggestions(relationshipDef.id, currentTargets);
                }
                
                updateSelectionCount();
            }
            
            function updateSelectionCount() {
                const selectedCount = modal.querySelectorAll('.shared-modal-checkbox:checked').length;
                const totalCount = currentTargets.length;
                selectionCount.textContent = `${selectedCount} of ${totalCount} selected`;
                createBtn.disabled = selectedCount === 0;
                
                if (selectedCount === 0) {
                    createBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Add Selected';
                } else {
                    createBtn.innerHTML = `<i class="fas fa-plus me-1"></i>Add ${selectedCount} Selected`;
                }
            }
            
            // Intermediate entry radio button handlers (if multiple)
            intermediateRadios.forEach(radio => {
                radio.addEventListener('change', updateTargetsDisplay);
            });
            
            // Select all button
            selectAllBtn.addEventListener('click', function() {
                const checkboxes = modal.querySelectorAll('.shared-modal-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                updateSelectionCount();
            });
            
            // Select none button
            selectNoneBtn.addEventListener('click', function() {
                const checkboxes = modal.querySelectorAll('.shared-modal-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateSelectionCount();
            });
            
            // Form submission with cardinality checking
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const selectedCheckboxes = modal.querySelectorAll('.shared-modal-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one item to add.');
                    return;
                }
                
                // Check cardinality limits before creating relationships
                const firstCheckbox = selectedCheckboxes[0];
                const definitionId = parseInt(firstCheckbox.dataset.definitionId);
                
                console.log('Shared relationship cardinality check - definitionId:', definitionId);
                console.log('Shared relationship cardinality check - selectedCount:', selectedCheckboxes.length);
                
                // Find the relationship definition to check cardinality
                const relationshipDef = allRelationshipDefinitions.find(def => def.id === definitionId);
                console.log('Shared relationship cardinality check - relationshipDef:', relationshipDef);
                
                if (relationshipDef) {
                    // Count existing relationships for this definition
                    const relatedRecordsResponse = await fetch(`/api/entries/${entryId}/relationships`);
                    const existingRelationships = await relatedRecordsResponse.json();
                    const existingForThisDef = existingRelationships.filter(rel => rel.definition_id === definitionId);
                    
                    // Determine if current entry is the "from" or "to" side of this relationship
                    const isFromSide = relationshipDef.entry_type_id_from == currentEntryTypeId;
                    
                    // Check the appropriate cardinality based on the current entry's role in the relationship
                    const relevantCardinality = isFromSide ? relationshipDef.cardinality_from : relationshipDef.cardinality_to;
                    
                    console.log('Shared relationship cardinality check:', {
                        definitionId: definitionId,
                        currentEntryTypeId: currentEntryTypeId,
                        isFromSide: isFromSide,
                        cardinality_from: relationshipDef.cardinality_from,
                        cardinality_to: relationshipDef.cardinality_to,
                        relevantCardinality: relevantCardinality,
                        existingCount: existingForThisDef.length,
                        selectedCount: selectedCheckboxes.length,
                        existingRelationships: existingForThisDef
                    });
                    
                    // Check if adding the selected relationships would exceed the limit
                    if (relevantCardinality !== -1) {
                        const totalAfterAdd = existingForThisDef.length + selectedCheckboxes.length;
                        if (totalAfterAdd > relevantCardinality) {
                            const maxCanAdd = relevantCardinality - existingForThisDef.length;
                            alert(`Cannot create ${selectedCheckboxes.length} relationships. This relationship is limited to ${relevantCardinality} item(s) and you already have ${existingForThisDef.length}. You can add at most ${maxCanAdd} more.`);
                            return;
                        }
                    }
                } else {
                    console.log('Shared relationship cardinality check - relationshipDef not found for ID:', definitionId);
                }
                
                const relationships = Array.from(selectedCheckboxes).map(checkbox => {
                    const relationship = {
                        definition_id: parseInt(checkbox.dataset.definitionId),
                        target_entry_id: parseInt(checkbox.value)
                    };
                    
                    // Get quantity and unit from the form inputs if they exist
                    const checkboxContainer = checkbox.closest('.form-check');
                    const quantityInput = checkboxContainer.querySelector('.quantity-input');
                    const unitInput = checkboxContainer.querySelector('.unit-input');
                    
                    if (quantityInput && quantityInput.value.trim()) {
                        relationship.quantity = parseFloat(quantityInput.value);
                    }
                    if (unitInput && unitInput.value.trim()) {
                        relationship.unit = unitInput.value.trim();
                    }
                    
                    return relationship;
                });
                
                // Disable form during submission
                createBtn.disabled = true;
                const originalBtnText = createBtn.innerHTML;
                createBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';
                
                try {
                    const response = await fetch(`/api/entries/${entryId}/create_shared_relationships`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ relationships })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.created && result.created.length > 0) {
                        const successCount = result.created.length;
                        const failCount = result.failed ? result.failed.length : 0;
                        
                        let message = `Successfully added ${successCount} relationship${successCount !== 1 ? 's' : ''}!`;
                        if (failCount > 0) {
                            message += `\n${failCount} relationship${failCount !== 1 ? 's' : ''} failed to create.`;
                        }
                        
                        alert(message);
                        
                        // Close modal
                        bootstrap.Modal.getInstance(modal).hide();
                        
                        // Refresh related records and shared opportunities
                        loadRelatedRecords();
                        loadSharedRelationships();
                    } else {
                        throw new Error(result.error || 'Failed to create relationships');
                    }
                } catch (error) {
                    console.error('Error creating shared relationships:', error);
                    alert(`Error creating relationships: ${error.message}`);
                } finally {
                    // Re-enable form
                    createBtn.disabled = false;
                    createBtn.innerHTML = originalBtnText;
                }
            });
            
            // Initialize the targets display
            updateTargetsDisplay();
        }

        // --- Note Binding Functions ---
        
        // Global variables to track note binding state
        let noteBingingState = new Map(); // Map of entry_id -> boolean (whether binding is enabled)

        // Load note binding state from database
        async function loadNoteBindingState() {
            try {
                const response = await fetch(`/api/note_bindings?entry_id=${entryId}`);
                if (response.ok) {
                    const bindings = await response.json();
                    
                    // Clear existing state
                    noteBingingState.clear();
                    
                    // Populate state from database
                    bindings.forEach(binding => {
                        if (binding.enabled) {
                            noteBingingState.set(binding.target_entry_id, true);
                        }
                    });
                    
                    // Update button states
                    noteBingingState.forEach((isEnabled, entryId) => {
                        updateBindNotesButtonState(entryId, isEnabled);
                    });
                    
                    console.log('Loaded note binding state from database:', noteBingingState);
                } else {
                    console.error('Failed to load note binding state:', response.statusText);
                    noteBingingState = new Map();
                }
            } catch (error) {
                console.error('Error loading note binding state:', error);
                noteBingingState = new Map();
            }
        }

        // Show Bind Notes Modal
        function showBindNotesModal(targetEntryId, targetEntryTitle) {
            const modalId = 'bindNotesModal';
            
            // Remove existing modal if it exists
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }
            
            const currentBindingState = noteBingingState.get(parseInt(targetEntryId)) || false;
            
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="${modalId}Label">
                                    <i class="fas fa-link me-2"></i>
                                    Bind Notes: ${targetEntryTitle}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note Binding:</strong> When enabled, any new notes created in this entry will automatically be associated with <strong>${targetEntryTitle}</strong>.
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="bindNotesToggle" ${currentBindingState ? 'checked' : ''}>
                                    <label class="form-check-label" for="bindNotesToggle">
                                        <strong>Enable automatic note binding to ${targetEntryTitle}</strong>
                                    </label>
                                </div>
                                
                                <div class="border-top pt-3">
                                    <h6><i class="fas fa-question-circle me-2"></i>How it works:</h6>
                                    <ul class="small text-muted mb-0">
                                        <li>When enabled, new notes in this entry will automatically include ${targetEntryTitle} in their associations</li>
                                        <li>You can still manually add/remove associations when creating notes</li>
                                        <li>This setting only affects new notes - existing notes are not changed</li>
                                        <li>You can disable this at any time</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveBindingBtn">
                                    <i class="fas fa-save me-1"></i>Save Setting
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
            
            // Add event listeners
            const saveBtn = document.getElementById('saveBindingBtn');
            const toggle = document.getElementById('bindNotesToggle');
            
            saveBtn.addEventListener('click', async function() {
                const isEnabled = toggle.checked;
                const originalText = saveBtn.innerHTML;
                
                try {
                    // Show loading state
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
                    
                    // Save to database via API
                    const response = await fetch('/api/note_bindings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            source_entry_id: entryId,
                            target_entry_id: parseInt(targetEntryId),
                            enabled: isEnabled
                        })
                    });
                    
                    if (response.ok) {
                        // Update local state
                        noteBingingState.set(parseInt(targetEntryId), isEnabled);
                        
                        // Update UI feedback
                        updateBindNotesButtonState(targetEntryId, isEnabled);
                        
                        // Show success message
                        const alertHtml = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle me-2"></i>
                                Note binding ${isEnabled ? 'enabled' : 'disabled'} for ${targetEntryTitle}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                        
                        // Add alert to the page
                        const alertContainer = document.querySelector('.container-fluid');
                        if (alertContainer) {
                            alertContainer.insertAdjacentHTML('afterbegin', alertHtml);
                            
                            // Auto-dismiss after 3 seconds
                            setTimeout(() => {
                                const alert = alertContainer.querySelector('.alert-success');
                                if (alert) {
                                    alert.remove();
                                }
                            }, 3000);
                        }
                        
                        // Close modal
                        modal.hide();
                        
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to save note binding');
                    }
                    
                } catch (error) {
                    console.error('Error saving note binding:', error);
                    alert(`Error saving note binding: ${error.message}`);
                } finally {
                    // Restore button state
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            });
            
            // Clean up modal when closed
            document.getElementById(modalId).addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Update bind notes button visual state
        function updateBindNotesButtonState(entryId, isEnabled) {
            const button = document.querySelector(`[data-entry-id="${entryId}"].bind-notes-btn`);
            if (button) {
                const icon = button.querySelector('i');
                if (isEnabled) {
                    // Enabled state - solid blue button with link icon
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-primary');
                    button.title = 'Notes binding enabled - click to configure';
                    if (icon) {
                        icon.classList.remove('fa-link');
                        icon.classList.add('fa-link', 'fa-solid'); // Ensure solid icon
                    }
                } else {
                    // Disabled state - outline button with link icon
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-outline-primary');
                    button.title = 'Bind notes from this entry';
                    if (icon) {
                        icon.classList.remove('fa-solid');
                        icon.classList.add('fa-link'); // Regular link icon
                    }
                }
            }
        }

        // Auto-populate associated entries based on binding state
        function autoPopulateAssociatedEntries() {
            const boundEntries = [];
            noteBingingState.forEach((isEnabled, entryId) => {
                if (isEnabled) {
                    boundEntries.push(entryId);
                }
            });
            
            if (boundEntries.length > 0) {
                // Select the bound entries in the dropdown
                Array.from(associatedEntriesSelect.options).forEach(option => {
                    if (boundEntries.includes(parseInt(option.value))) {
                        option.selected = true;
                    }
                });
                updateSelectedAssociationsDisplay();
            }
        }

        // Apply binding state styling to all bind buttons
        function applyBindingStateToButtons() {
            noteBingingState.forEach((isEnabled, entryId) => {
                updateBindNotesButtonState(entryId, isEnabled);
            });
        }

        // --- Sensor Data Functions ---
        {% if entry.has_sensors %}
        // Auto-refresh variables
        let sensorDataRefreshInterval = null;
        const SENSOR_REFRESH_INTERVAL = 60000; // 60 seconds
        let isLoadingSensorData = false; // Flag to prevent multiple simultaneous requests
        
        async function loadSensorData() {
            console.log('loadSensorData() called');
            
            // Prevent multiple simultaneous requests
            if (isLoadingSensorData) {
                console.log('Already loading sensor data, skipping...');
                return;
            }
            
            isLoadingSensorData = true;
            const sensorDataContainer = document.getElementById('sensorDataContainer');
            const loadingSensorData = document.getElementById('loadingSensorData');
            
            // Check if elements exist before proceeding
            if (!sensorDataContainer) {
                console.error('sensorDataContainer element not found');
                return;
            }
            
            try {
                if (loadingSensorData) {
                    loadingSensorData.style.display = 'block';
                }
                console.log('Fetching sensor data from API...');
                const response = await fetch(`/api/entries/${entryId}/sensor_data`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const sensorData = await response.json();
                console.log('Loaded sensor data:', sensorData); // Debug log
                console.log('Sensor data length:', sensorData.length);
                renderSensorData(sensorData);
                
                // Update chart immediately if in chart view
                if (chartViewBtn && chartViewBtn.checked) {
                    renderChartView();
                }
            } catch (error) {
                console.error('Error loading sensor data:', error);
                sensorDataContainer.innerHTML = '<p class="text-danger">Error loading sensor data.</p>';
            } finally {
                if (loadingSensorData) {
                    loadingSensorData.style.display = 'none';
                }
                isLoadingSensorData = false; // Reset loading flag
            }
        }
        
        function startSensorDataAutoRefresh() {
            // Clear any existing interval
            if (sensorDataRefreshInterval) {
                clearInterval(sensorDataRefreshInterval);
            }
            
            // Only start auto-refresh if we have sensor data capability
            if (document.getElementById('sensorDataContainer')) {
                console.log('Starting sensor data auto-refresh (every 60 seconds)');
                
                // Update status indicator
                const statusElement = document.getElementById('autoRefreshStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i>Auto-refresh: Active (60s)';
                    statusElement.className = 'text-success';
                }
                
                sensorDataRefreshInterval = setInterval(async () => {
                    try {
                        // Add a subtle visual indicator during refresh
                        if (statusElement) {
                            statusElement.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i>Refreshing...';
                        }
                        
                        await loadSensorData();
                        
                        // Restore normal status
                        if (statusElement) {
                            statusElement.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i>Auto-refresh: Active (60s)';
                            statusElement.className = 'text-success';
                        }
                    } catch (error) {
                        console.error('Error during auto-refresh:', error);
                        // Show error status
                        if (statusElement) {
                            statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Refresh error';
                            statusElement.className = 'text-warning';
                        }
                    }
                }, SENSOR_REFRESH_INTERVAL);
            }
        }
        
        function stopSensorDataAutoRefresh() {
            if (sensorDataRefreshInterval) {
                clearInterval(sensorDataRefreshInterval);
                sensorDataRefreshInterval = null;
                console.log('Stopped sensor data auto-refresh');
                
                // Update status indicator
                const statusElement = document.getElementById('autoRefreshStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-pause me-1"></i>Auto-refresh: Stopped';
                    statusElement.className = 'text-muted';
                }
            }
        }

        // Device Management Functions
        function openDeviceManagement() {
            // Get or create the device management modal
            const modalElement = document.getElementById('deviceManagementModal');
            const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            modal.show();
            
            // Load device management content immediately
            loadDeviceManagementContent();
        }
        
        async function loadDeviceManagementContent() {
            try {
                const contentDiv = document.getElementById('deviceManagementContent');
                contentDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">Loading devices...</p>
                    </div>
                `;

                console.log('Fetching devices and linked devices...');

                // Fetch both devices and linked devices for this entry
                const [devicesResponse, linkedDevicesResponse] = await Promise.all([
                    fetch('/api/devices'),
                    fetch(`/api/entries/${entryId}/linked-devices`)
                ]);

                console.log('Devices response:', devicesResponse.ok, devicesResponse.status);
                console.log('Linked devices response:', linkedDevicesResponse.ok, linkedDevicesResponse.status);

                if (!devicesResponse.ok) {
                    throw new Error('Failed to load devices');
                }

                const devices = await devicesResponse.json();
                let linkedDevices = [];
                
                if (linkedDevicesResponse.ok) {
                    const linkedData = await linkedDevicesResponse.json();
                    linkedDevices = linkedData.linked_devices || [];
                }

                console.log('Loaded devices:', devices.length);
                console.log('Loaded linked devices:', linkedDevices.length);

                renderDeviceManagementInterface(devices, linkedDevices);

            } catch (error) {
                console.error('Error loading device management:', error);
                document.getElementById('deviceManagementContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading devices: ${error.message}
                        <br><small>Try refreshing or check your network connection.</small>
                    </div>
                `;
            }
        }

        function renderDeviceManagementInterface(devices, linkedDevices = []) {
            const contentDiv = document.getElementById('deviceManagementContent');
            const linkedDeviceIds = new Set(linkedDevices.map(d => d.id));
            
            let html = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1"><i class="fas fa-microchip me-2"></i>Available Devices</h6>
                            <small class="text-muted">${devices.length} device(s) found, ${linkedDevices.length} linked to this entry</small>
                        </div>
                        <a href="/manage_devices" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>Manage All Devices
                        </a>
                    </div>
                </div>
            `;

            if (devices.length === 0) {
                html += `
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>No devices found</strong><br>
                        <a href="/manage_devices" target="_blank" class="btn btn-primary btn-sm mt-2">
                            <i class="fas fa-plus me-1"></i>Add Devices
                        </a>
                    </div>
                `;
            } else {
                html += '<div class="list-group">';
                
                devices.forEach(device => {
                    const isLinked = linkedDeviceIds.has(device.id);
                    const statusColor = device.auto_polling ? 'success' : 'warning';
                    const statusText = device.auto_polling ? 'Auto-polling' : 'Manual only';
                    
                    html += `
                        <div class="list-group-item ${isLinked ? 'list-group-item-success' : ''}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <h6 class="mb-0 me-2">${device.device_name}</h6>
                                        <span class="badge bg-${statusColor}">${statusText}</span>
                                        ${isLinked ? '<span class="badge bg-success ms-1"><i class="fas fa-link me-1"></i>Linked</span>' : ''}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-network-wired me-1"></i>
                                        <a href="http://${device.ip}" target="_blank" class="link-theme" title="Open device web interface">
                                            ${device.ip} <i class="fas fa-external-link-alt ms-1"></i>
                                        </a>
                                        <i class="fas fa-microchip me-1 ms-2"></i>${device.device_type}
                                        ${device.last_poll_success ? 
                                            '<br><i class="fas fa-clock me-1"></i>Last poll: ' + new Date(device.last_poll_success).toLocaleString() 
                                            : ''}
                                    </small>
                                </div>
                                <div class="ms-3">
                                    ${isLinked ? 
                                        `<button class="btn btn-outline-danger btn-sm" onclick="unlinkDeviceFromEntry(${device.id})">
                                            <i class="fas fa-unlink me-1"></i>Unlink
                                        </button>` :
                                        `<button class="btn btn-success btn-sm" onclick="linkDeviceToEntry(${device.id})">
                                            <i class="fas fa-link me-1"></i>Link to Entry
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            contentDiv.innerHTML = html;
        }

        async function refreshDeviceList() {
            loadDeviceManagementContent();
        }

        async function linkDeviceToEntry(deviceId) {
            try {
                const response = await fetch(`/api/devices/${deviceId}/link-entry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ entry_id: entryId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to link device');
                }

                const result = await response.json();
                alert('Device linked successfully! It will now automatically record sensor data to this entry.');
                
                // Refresh the device list
                loadDeviceManagementContent();

            } catch (error) {
                console.error('Error linking device:', error);
                alert('Error linking device: ' + error.message);
            }
        }

        async function unlinkDeviceFromEntry(deviceId) {
            try {
                if (!confirm('Are you sure you want to unlink this device from this entry? It will stop automatically recording data to this entry.')) {
                    return;
                }

                const response = await fetch(`/api/devices/${deviceId}/unlink-entry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ entry_id: entryId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to unlink device');
                }

                const result = await response.json();
                alert('Device unlinked successfully!');
                
                // Refresh the device list
                loadDeviceManagementContent();

            } catch (error) {
                console.error('Error unlinking device:', error);
                alert('Error unlinking device: ' + error.message);
            }
        }

        function renderSensorData(sensorData) {
            const sensorDataContainer = document.getElementById('sensorDataContainer');
            
            // Store data globally for chart functionality
            allSensorData = sensorData;
            
            // Manage performance alert
            showPerformanceAlertIfNeeded(sensorData.length);
            
            if (sensorData.length === 0) {
                sensorDataContainer.innerHTML = '<p class="text-muted">No sensor data recorded yet.</p>';
                sensorChartContainer.innerHTML = '<p class="text-muted">No sensor data recorded yet.</p>';
                return;
            }

            // Always render table view for when user switches to it
            renderTableView(sensorData);
            
            // Update chart filters
            updateChartFilters(sensorData);
            
            // Show chart view by default (or if chart view is active)
            if (!chartViewBtn || chartViewBtn.checked) {
                renderChartView();
            }
        }

        function renderTableView(sensorData) {
            const sensorDataContainer = document.getElementById('sensorDataContainer');
            
            // Pagination variables
            const itemsPerPage = 10;
            const totalPages = Math.ceil(sensorData.length / itemsPerPage);
            let currentPage = parseInt(sensorDataContainer.dataset.currentPage || '1');
            
            // Ensure current page is valid
            if (currentPage > totalPages) currentPage = 1;
            if (currentPage < 1) currentPage = 1;
            
            // Calculate pagination slice
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, sensorData.length);
            const paginatedData = sensorData.slice(startIndex, endIndex);
            
            const tableHtml = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Showing ${startIndex + 1}-${endIndex} of ${sensorData.length} readings</span>
                    ${totalPages > 1 ? `
                        <nav aria-label="Sensor data pagination">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                                    <button class="page-link sensor-page-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                </li>
                                ${Array.from({length: Math.min(5, totalPages)}, (_, i) => {
                                    let pageNum;
                                    if (totalPages <= 5) {
                                        pageNum = i + 1;
                                    } else if (currentPage <= 3) {
                                        pageNum = i + 1;
                                    } else if (currentPage >= totalPages - 2) {
                                        pageNum = totalPages - 4 + i;
                                    } else {
                                        pageNum = currentPage - 2 + i;
                                    }
                                    return `
                                        <li class="page-item ${pageNum === currentPage ? 'active' : ''}">
                                            <button class="page-link sensor-page-btn" data-page="${pageNum}">${pageNum}</button>
                                        </li>
                                    `;
                                }).join('')}
                                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                                    <button class="page-link sensor-page-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    ` : ''}
                </div>
                <table class="table table-sm table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Sensor Type</th>
                            <th>Value</th>
                            <th>Recorded At</th>
                            <th width="100">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedData.map(data => `
                            <tr>
                                <td>${data.sensor_type}</td>
                                <td>${data.value}</td>
                                <td>${formatSensorTimestamp(data.recorded_at)}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger delete-sensor-btn" data-sensor-id="${data.id}" title="Delete reading">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            sensorDataContainer.innerHTML = tableHtml;
            sensorDataContainer.dataset.currentPage = currentPage;
            
            // Attach pagination event listeners
            const pageButtons = sensorDataContainer.querySelectorAll('.sensor-page-btn');
            pageButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const newPage = parseInt(this.dataset.page);
                    sensorDataContainer.dataset.currentPage = newPage;
                    renderTableView(sensorData); // Re-render with new page
                });
            });
            
            attachSensorDataEventListeners();
        }

        function attachSensorDataEventListeners() {
            // Delete sensor data buttons
            document.querySelectorAll('.delete-sensor-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const sensorId = this.getAttribute('data-sensor-id');
                    if (confirm('Are you sure you want to delete this sensor reading?')) {
                        await deleteSensorData(sensorId);
                    }
                });
            });
        }

        async function deleteSensorData(sensorId) {
            try {
                const response = await fetch(`/api/sensor_data/${sensorId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete sensor data');
                }

                // Reload sensor data
                await loadSensorData();
                
            } catch (error) {
                console.error('Error deleting sensor data:', error);
                alert('Error deleting sensor data: ' + error.message);
            }
        }

        function initializeSensorDataForm() {
            const addSensorDataForm = document.getElementById('addSensorDataForm');
            const addSensorDataModal = bootstrap.Modal.getInstance(document.getElementById('addSensorDataModal')) || 
                                      new bootstrap.Modal(document.getElementById('addSensorDataModal'));
            
            // Function to set current date/time
            function setCurrentDateTime() {
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('sensorRecordedAt').value = localDateTime;
            }
            
            // Function to populate sensor types dropdown
            async function populateSensorTypes() {
                try {
                    // Use the entry type's enabled sensor types
                    const sensorTypes = enabledSensorTypes ? enabledSensorTypes.split(',').map(type => type.trim()).filter(type => type !== '') : [];
                    
                    const sensorTypeSelect = document.getElementById('sensorTypeInput');
                    // Clear existing options except the first one
                    sensorTypeSelect.innerHTML = '<option value="" disabled selected>Select a sensor type</option>';
                    
                    if (sensorTypes.length === 0) {
                        // No sensor types enabled for this entry type
                        sensorTypeSelect.innerHTML = '<option value="" disabled selected>No sensor types configured for this entry type</option>';
                        return;
                    }
                    
                    // Add enabled sensor type options
                    sensorTypes.forEach(sensorType => {
                        const option = document.createElement('option');
                        option.value = sensorType;
                        option.textContent = sensorType;
                        sensorTypeSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading sensor types:', error);
                    // Fallback to some default sensor types
                    const sensorTypeSelect = document.getElementById('sensorTypeInput');
                    sensorTypeSelect.innerHTML = `
                        <option value="" disabled selected>Select a sensor type</option>
                        <option value="Temperature">Temperature</option>
                        <option value="Humidity">Humidity</option>
                        <option value="Pressure">Pressure</option>
                    `;
                }
            }
            
            // Set current date/time as default on initialization
            setCurrentDateTime();
            
            // Populate sensor types dropdown
            populateSensorTypes();
            
            // Reset date/time each time the modal is shown
            document.getElementById('addSensorDataModal').addEventListener('shown.bs.modal', function() {
                setCurrentDateTime();
            });
            
            addSensorDataForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const sensorType = document.getElementById('sensorTypeInput').value;
                const sensorValue = document.getElementById('sensorValueInput').value.trim();
                const recordedAt = document.getElementById('sensorRecordedAt').value;
                
                if (!sensorType || !sensorValue) {
                    alert('Please fill in all required fields.');
                    return;
                }
                
                try {
                    // Convert datetime-local to ISO string with timezone
                    let isoRecordedAt;
                    if (recordedAt) {
                        // datetime-local gives us local time without timezone info
                        // Convert it to a proper ISO string with timezone
                        const localDate = new Date(recordedAt);
                        isoRecordedAt = localDate.toISOString();
                    } else {
                        isoRecordedAt = new Date().toISOString();
                    }
                    
                    const response = await fetch(`/api/entries/${entryId}/sensor_data`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sensor_type: sensorType,
                            value: sensorValue,
                            recorded_at: isoRecordedAt
                        })
                    });
                    
                    console.log('Sensor data POST response status:', response.status); // Debug log
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to add sensor data');
                    }
                    
                    const result = await response.json();
                    console.log('Sensor data added successfully:', result); // Debug log
                    
                    // Reset form and close modal
                    addSensorDataForm.reset();
                    setCurrentDateTime(); // Reset to current time
                    addSensorDataModal.hide();
                    
                    // Reload sensor data to show the new entry
                    console.log('Reloading sensor data...'); // Debug log
                    await loadSensorData();
                    
                } catch (error) {
                    console.error('Error adding sensor data:', error);
                    alert('Error adding sensor data: ' + error.message);
                }
            });
        }

        // Chart Functions
        async function initializeChartControls() {
            console.log('initializeChartControls() called');
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js library is not loaded!');
                return;
            } else {
                console.log('Chart.js version:', Chart.version);
            }
            
            // Initialize DOM element references
            chartTypeSelect = document.getElementById('chartTypeSelect');
            sensorTypeFilter = document.getElementById('sensorTypeFilter');
            timeRangeFilter = document.getElementById('timeRangeFilter');
            tableViewBtn = document.getElementById('tableView');
            chartViewBtn = document.getElementById('chartView');
            sensorChartContainer = document.getElementById('sensorChartContainer');
            
            console.log('Chart controls elements:', {
                chartTypeSelect,
                sensorTypeFilter,
                timeRangeFilter,
                tableViewBtn,
                chartViewBtn,
                sensorChartContainer
            });
            
            // Set initial visibility based on default selection (chart view)
            if (sensorDataContainer && sensorChartContainer) {
                sensorDataContainer.style.display = 'none';
                sensorChartContainer.style.display = 'block';
            }
            
            // View toggle event listeners
            if (tableViewBtn) {
                tableViewBtn.addEventListener('change', function() {
                    if (this.checked) {
                        sensorDataContainer.style.display = 'block';
                        sensorChartContainer.style.display = 'none';
                    }
                });
            }

            if (chartViewBtn) {
                chartViewBtn.addEventListener('change', function() {
                    if (this.checked) {
                        sensorDataContainer.style.display = 'none';
                        sensorChartContainer.style.display = 'block';
                        renderChartView();
                    }
                });
            }

            // Chart control event listeners with auto-save
            if (chartTypeSelect) {
                chartTypeSelect.addEventListener('change', function() {
                    renderChartView();
                    autoSaveChartPreferences();
                });
            }
            if (sensorTypeFilter) {
                sensorTypeFilter.addEventListener('change', function() {
                    renderChartView();
                    autoSaveChartPreferences();
                });
            }
            if (timeRangeFilter) {
                timeRangeFilter.addEventListener('change', function() {
                    renderChartView();
                    autoSaveChartPreferences();
                });
            }
            
            // Data limit filter event listener
            const dataLimitFilter = document.getElementById('dataLimitFilter');
            if (dataLimitFilter) {
                dataLimitFilter.addEventListener('change', function() {
                    renderChartView();
                    autoSaveChartPreferences();
                });
            }
            
            // Load saved chart preferences on page load
            await loadChartPreferences();
        }

        function updateChartFilters(sensorData) {
            if (!sensorTypeFilter) return;
            
            // Get unique sensor types
            const sensorTypes = [...new Set(sensorData.map(d => d.sensor_type))];
            
            // Clear and repopulate sensor type filter
            sensorTypeFilter.innerHTML = '<option value="all">All Sensor Types</option>';
            sensorTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                sensorTypeFilter.appendChild(option);
            });
        }
        
        function isMobileDevice() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function getFilteredSensorData() {
            let filteredData = [...allSensorData];
            
            // Filter by sensor type
            if (sensorTypeFilter && sensorTypeFilter.value !== 'all') {
                filteredData = filteredData.filter(d => d.sensor_type === sensorTypeFilter.value);
            }
            
            // Filter by time range
            if (timeRangeFilter && timeRangeFilter.value !== 'all') {
                const now = new Date();
                let cutoffDate;
                
                switch (timeRangeFilter.value) {
                    case '24h':
                        cutoffDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        break;
                    case '7d':
                        cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '30d':
                        cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        cutoffDate = new Date(0);
                }
                
                filteredData = filteredData.filter(d => new Date(d.recorded_at) >= cutoffDate);
            }
            
            // Sort by recorded_at (most recent first for limiting)
            filteredData.sort((a, b) => new Date(b.recorded_at) - new Date(a.recorded_at));
            
            // Apply data limit with mobile-specific defaults
            const dataLimitFilter = document.getElementById('dataLimitFilter');
            
            if (dataLimitFilter && dataLimitFilter.value.trim() !== '') {
                const limit = parseInt(dataLimitFilter.value);
                if (!isNaN(limit) && limit > 0) {
                    filteredData = filteredData.slice(0, limit);
                }
            } else if (isMobileDevice() && filteredData.length > 50) {
                // Auto-limit data on mobile for better performance
                filteredData = filteredData.slice(0, 50);
                console.log('Auto-limited data to 50 points for mobile performance');
            }
            
            // Sort again by recorded_at for chart display (oldest first)
            filteredData.sort((a, b) => new Date(a.recorded_at) - new Date(b.recorded_at));
            
            return filteredData;
        }

        function renderChartView() {
            console.log('renderChartView() called');
            try {
                const canvas = document.getElementById('sensorChart');
                const loadingChart = document.getElementById('loadingChart');
                
                console.log('Canvas element:', canvas);
                console.log('Loading element:', loadingChart);
                
                if (!canvas) {
                    console.error('Canvas element not found!');
                    return;
                }
                
                const startTime = performance.now();
                const ctx = canvas.getContext('2d');
                const filteredData = getFilteredSensorData();
                
                console.log('Filtered data length:', filteredData.length);
                
                // Performance logging
                console.log(`Chart rendering started: ${filteredData.length} data points, Mobile: ${isMobileDevice()}`);
                
                // Hide loading message
                if (loadingChart) {
                    loadingChart.style.display = 'none';
                }
                
                if (filteredData.length === 0) {
                    console.log('No data available, showing empty message');
                    // Clear chart and show message
                    if (sensorChart) {
                        sensorChart.destroy();
                        sensorChart = null;
                    }
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#6c757d';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data available for the selected filters', canvas.width / 2, canvas.height / 2);
                    return;
                }
            
            // Group data by sensor type for multiple datasets
            const groupedData = {};
            filteredData.forEach(d => {
                if (!groupedData[d.sensor_type]) {
                    groupedData[d.sensor_type] = [];
                }
                groupedData[d.sensor_type].push(d);
            });
            
            // Detect mobile device for performance optimizations (move this up)
            const isMobile = isMobileDevice();
            const dataPointCount = filteredData.length;
            
            // Create datasets
            const datasets = [];
            
            // Get theme primary color from CSS custom properties
            const computedStyle = getComputedStyle(document.documentElement);
            const primaryColor = computedStyle.getPropertyValue('--theme-primary').trim() || '#0d6efd';
            
            // Create color variations based on primary theme color
            function hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            
            // Generate primary-based color palette with variations
            const colors = [
                hexToRgba(primaryColor, 0.8),
                hexToRgba(primaryColor, 0.6),
                hexToRgba(primaryColor, 0.9),
                hexToRgba(primaryColor, 0.7),
                hexToRgba(primaryColor, 0.5),
                hexToRgba(primaryColor, 0.4),
                hexToRgba(primaryColor, 0.3),
                hexToRgba(primaryColor, 0.2)
            ];
            
            let colorIndex = 0;
            Object.keys(groupedData).forEach(sensorType => {
                const data = groupedData[sensorType];
                const color = colors[colorIndex % colors.length];
                
                // Optimize dataset configuration for performance
                const dataset = {
                    label: sensorType,
                    data: data.map(d => ({
                        x: new Date(d.recorded_at),
                        y: parseFloat(d.value)
                    })),
                    backgroundColor: color,
                    borderColor: color.replace('0.8', '1'),
                    borderWidth: isMobile ? 1 : 2,
                    fill: false,
                    tension: 0, // Disable BÃ©zier curves for better performance
                    pointRadius: isMobile ? 1 : 2,
                    pointHoverRadius: isMobile ? 3 : 4,
                    pointHitRadius: 10, // Explicitly set hit radius to fix Chart.js error
                    pointBorderWidth: 1,
                    pointHoverBorderWidth: 2,
                    parsing: false, // Data is already in the correct format
                    normalized: true // Data is sorted by time
                };
                
                // For very large datasets on mobile, consider hiding points
                if (isMobile && dataPointCount > 100) {
                    dataset.pointRadius = 0;
                    dataset.pointHoverRadius = 2;
                }
                
                datasets.push(dataset);
                colorIndex++;
            });
            
            // Destroy existing chart
            if (sensorChart && typeof sensorChart.destroy === 'function') {
                console.log('Destroying existing chart instance');
                sensorChart.destroy();
                sensorChart = null;
            }
            
            // Clear canvas to ensure clean state
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate time axis bounds based on actual data
            let timeAxisMin, timeAxisMax;
            if (filteredData.length > 0) {
                const allTimestamps = filteredData.map(d => new Date(d.recorded_at).getTime());
                timeAxisMin = new Date(Math.min(...allTimestamps));
                timeAxisMax = new Date(Math.max(...allTimestamps));
                
                // Add a small buffer (5% of the time range) for better visual spacing
                const timeRange = timeAxisMax.getTime() - timeAxisMin.getTime();
                const buffer = timeRange * 0.05;
                timeAxisMin = new Date(timeAxisMin.getTime() - buffer);
                timeAxisMax = new Date(timeAxisMax.getTime() + buffer);
                
                console.log('Auto-scaling time axis from', timeAxisMin.toISOString(), 'to', timeAxisMax.toISOString());
            }
            
            // Create new chart
            const chartType = chartTypeSelect ? chartTypeSelect.value : 'line';
            
            sensorChart = new Chart(ctx, {
                type: chartType,
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    color: primaryColor, // Set default text color to primary theme color
                    // Disable animations on mobile or with large datasets
                    animation: !isMobile && dataPointCount <= 50,
                    // Optimize elements for mobile
                    elements: {
                        point: {
                            radius: isMobile ? 2 : 3,
                            hoverRadius: isMobile ? 4 : 6,
                            hitRadius: 10, // Explicitly set hit radius
                            borderWidth: 1,
                            hoverBorderWidth: 2
                        },
                        line: {
                            borderWidth: isMobile ? 1 : 2,
                            tension: 0 // Disable BÃ©zier curves for better performance
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            adapters: {
                                date: {
                                    zone: 'UTC'
                                }
                            },
                            time: {
                                parser: 'YYYY-MM-DDTHH:mm:ss.sssZ',
                                displayFormats: {
                                    millisecond: 'HH:mm:ss.SSS',
                                    second: 'HH:mm:ss',
                                    minute: 'HH:mm',
                                    hour: 'MM/dd HH:mm',
                                    day: 'MM/dd',
                                    week: 'MM/dd',
                                    month: 'MM/yy',
                                    quarter: 'MM/yy',
                                    year: 'yyyy'
                                }
                            },
                            // Auto-scale to fit the actual data range
                            min: timeAxisMin,
                            max: timeAxisMax,
                            title: {
                                display: true,
                                text: 'Time',
                                color: primaryColor
                            },
                            ticks: {
                                color: hexToRgba(primaryColor, 0.7),
                                autoSkip: true,
                                maxTicksLimit: isMobile ? 5 : 10
                            },
                            grid: {
                                color: hexToRgba(primaryColor, 0.2)
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value',
                                color: primaryColor
                            },
                            ticks: {
                                color: hexToRgba(primaryColor, 0.7)
                            },
                            grid: {
                                color: hexToRgba(primaryColor, 0.2)
                            }
                        }
                    },
                    plugins: {
                        decimation: {
                            enabled: false, // Temporarily disable to test hitRadius fix
                            algorithm: 'lttb',
                            samples: isMobile ? Math.min(100, Math.floor(ctx.canvas.width / 2)) : Math.min(200, ctx.canvas.width),
                            threshold: dataPointCount > 20 ? 20 : 0
                        },
                        title: {
                            display: true,
                            text: 'Sensor Data Over Time',
                            color: primaryColor,
                            font: {
                                size: isMobile ? 14 : 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: Object.keys(groupedData).length > 1,
                            labels: {
                                color: primaryColor,
                                font: {
                                    size: isMobile ? 11 : 12
                                },
                                boxWidth: isMobile ? 15 : 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: hexToRgba(primaryColor, 0.9),
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: primaryColor,
                            borderWidth: 1,
                            titleFont: {
                                size: isMobile ? 12 : 14
                            },
                            bodyFont: {
                                size: isMobile ? 11 : 12
                            },
                            callbacks: {
                                title: function(context) {
                                    if (context[0]) {
                                        return new Date(context[0].parsed.x).toLocaleString();
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    }
                }
            });
            
            // Performance logging
            const endTime = performance.now();
            const renderTime = endTime - startTime;
            console.log(`Chart rendered in ${renderTime.toFixed(2)}ms with ${dataPointCount} data points (Mobile: ${isMobile})`);
            
            if (renderTime > 1000) {
                console.warn('Chart rendering took longer than 1 second. Consider reducing data points or optimizing settings.');
            }
            
            } catch (error) {
                console.error('Error in renderChartView:', error);
                console.error('Error stack:', error.stack);
                
                // Show error message on canvas
                const canvas = document.getElementById('sensorChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#dc3545';
                    ctx.textAlign = 'center';
                    ctx.fillText('Error loading chart. Check console for details.', canvas.width / 2, canvas.height / 2);
                }
            }
        }
        
        function showPerformanceAlertIfNeeded(dataCount) {
            const performanceAlert = document.getElementById('performanceAlert');
            const performanceMessage = document.getElementById('performanceMessage');
            
            if (!performanceAlert || !performanceMessage) return;
            
            // Show alert for mobile devices with many data points
            if (isMobileDevice() && dataCount > 20) {
                performanceMessage.textContent = `You have ${dataCount} sensor readings. On mobile devices, consider using the data limit filter (set to 50 or less) for better chart performance.`;
                performanceAlert.classList.remove('d-none');
            } else if (!isMobileDevice() && dataCount > 100) {
                performanceMessage.textContent = `You have ${dataCount} sensor readings. For better performance, consider using the time range or data limit filters.`;
                performanceAlert.classList.remove('d-none');
            } else {
                performanceAlert.classList.add('d-none');
            }
        }
        
        // Chart preference persistence functions
        async function loadChartPreferences() {
            try {
                const response = await fetch(`/api/user_preferences/chart/{{ entry.id }}`);
                const data = await response.json();
                
                if (data.success && data.preferences) {
                    const prefs = data.preferences;
                    
                    // Apply saved preferences to the form controls
                    if (chartTypeSelect && prefs.chartType) {
                        chartTypeSelect.value = prefs.chartType;
                    }
                    if (sensorTypeFilter && prefs.sensorType) {
                        sensorTypeFilter.value = prefs.sensorType;
                    }
                    if (timeRangeFilter && prefs.timeRange) {
                        timeRangeFilter.value = prefs.timeRange;
                    } else if (timeRangeFilter) {
                        // Default to 24h if no preference is saved
                        timeRangeFilter.value = '24h';
                    }
                    const dataLimitFilter = document.getElementById('dataLimitFilter');
                    if (dataLimitFilter && prefs.dataLimit) {
                        // Handle both old select values and new input values
                        if (prefs.dataLimit === 'all') {
                            dataLimitFilter.value = '';
                        } else {
                            dataLimitFilter.value = prefs.dataLimit;
                        }
                    }
                    
                    console.log('Loaded chart preferences from database:', prefs);
                    
                    // Re-render chart with loaded preferences
                    if (typeof renderChartView === 'function') {
                        renderChartView();
                    }
                } else {
                    console.log('No saved chart preferences found, using defaults');
                    // Apply default 24h time range
                    if (timeRangeFilter) {
                        timeRangeFilter.value = '24h';
                        if (typeof renderChartView === 'function') {
                            renderChartView();
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading chart preferences:', error);
                // Set defaults on error
                if (timeRangeFilter) {
                    timeRangeFilter.value = '24h';
                    if (typeof renderChartView === 'function') {
                        renderChartView();
                    }
                }
            }
        }
        
        async function autoSaveChartPreferences() {
            const dataLimitFilter = document.getElementById('dataLimitFilter');
            
            const prefs = {
                chartType: chartTypeSelect ? chartTypeSelect.value : 'line',
                sensorType: sensorTypeFilter ? sensorTypeFilter.value : 'all',
                timeRange: timeRangeFilter ? timeRangeFilter.value : '24h',
                dataLimit: dataLimitFilter ? (dataLimitFilter.value.trim() || 'all') : 'all'
            };
            
            try {
                const response = await fetch(`/api/user_preferences/chart/{{ entry.id }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(prefs)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Auto-saved chart preferences to database:', prefs);
                } else {
                    console.error('Failed to save chart preferences:', data.message);
                }
            } catch (error) {
                console.error('Error saving chart preferences:', error);
            }
        }
        
        async function saveChartPreferences() {
            try {
                await autoSaveChartPreferences();
                
                // Show user feedback
                const saveButton = document.querySelector('button[onclick="saveChartPreferences()"]');
                if (saveButton) {
                    const originalText = saveButton.innerHTML;
                    saveButton.innerHTML = '<i class="fas fa-check me-1"></i>Saved!';
                    saveButton.classList.remove('btn-theme-primary');
                    saveButton.classList.add('btn-success');
                    
                    setTimeout(() => {
                        saveButton.innerHTML = originalText;
                        saveButton.classList.remove('btn-success');
                        saveButton.classList.add('btn-theme-primary');
                    }, 2000);
                }
            } catch (error) {
                console.error('Error saving chart preferences:', error);
                
                // Show error feedback
                const saveButton = document.querySelector('button[onclick="saveChartPreferences()"]');
                if (saveButton) {
                    const originalText = saveButton.innerHTML;
                    saveButton.innerHTML = '<i class="fas fa-times me-1"></i>Error!';
                    saveButton.classList.remove('btn-theme-primary');
                    saveButton.classList.add('btn-danger');
                    
                    setTimeout(() => {
                        saveButton.innerHTML = originalText;
                        saveButton.classList.remove('btn-danger');
                        saveButton.classList.add('btn-theme-primary');
                    }, 3000);
                }
            }
        }
        
        async function resetChartPreferences() {
            try {
                const response = await fetch(`/api/user_preferences/chart/{{ entry.id }}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Chart preferences deleted from database');
                } else {
                    console.error('Failed to delete chart preferences:', data.message);
                }
            } catch (error) {
                console.error('Error deleting chart preferences:', error);
            }
            
            // Reset form controls to defaults
            if (chartTypeSelect) chartTypeSelect.value = 'line';
            if (sensorTypeFilter) sensorTypeFilter.value = 'all';
            if (timeRangeFilter) timeRangeFilter.value = '24h'; // Use 24h as default
            const dataLimitFilter = document.getElementById('dataLimitFilter');
            if (dataLimitFilter) dataLimitFilter.value = '';
            
            // Re-render chart with default settings
            if (typeof renderChartView === 'function') {
                renderChartView();
            }
            
            // Show user feedback
            const resetButton = document.querySelector('button[onclick="resetChartPreferences()"]');
            if (resetButton) {
                const originalText = resetButton.innerHTML;
                resetButton.innerHTML = '<i class="fas fa-check me-1"></i>Reset!';
                resetButton.classList.remove('btn-outline-secondary');
                resetButton.classList.add('btn-success');
                
                setTimeout(() => {
                    resetButton.innerHTML = originalText;
                    resetButton.classList.remove('btn-success');
                    resetButton.classList.add('btn-outline-secondary');
                }, 2000);
            }
            
            console.log('Chart preferences reset to defaults');
        }
        
        // Add event listener for when device management modal is hidden
        document.getElementById('deviceManagementModal').addEventListener('hidden.bs.modal', function() {
            // Clear any modal backdrop or state issues
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        });
        
        {% endif %}

        // Wikipedia search functionality for new relationship modal
        document.getElementById('searchWikipediaNewRelationBtn').addEventListener('click', async () => {
            const searchBtn = document.getElementById('searchWikipediaNewRelationBtn');
            const entryNameInput = document.getElementById('newEntryName');
            const wikipediaResults = document.getElementById('wikipediaNewRelationResults');
            
            const entryName = entryNameInput.value.trim();
            
            if (!entryName) {
                alert('Please enter an entry name first to search Wikipedia');
                return;
            }
            
            // Update button state
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Searching...';
            
            try {
                const response = await fetch(`/api/wikipedia/search/${encodeURIComponent(entryName)}`);
                const data = await response.json();
                
                if (data.found) {
                    // Populate Wikipedia results
                    document.getElementById('wikipediaNewRelationTitle').textContent = data.title;
                    document.getElementById('wikipediaNewRelationExtract').textContent = data.extract;
                    document.getElementById('wikipediaNewRelationLink').href = data.url;
                    
                    // Store the extract for later use
                    wikipediaResults.dataset.extract = data.extract;
                    
                    // Show results
                    wikipediaResults.classList.remove('d-none');
                } else {
                    alert(data.message || 'No Wikipedia article found');
                    wikipediaResults.classList.add('d-none');
                }
            } catch (error) {
                console.error('Wikipedia search error:', error);
                alert('Error searching Wikipedia');
                wikipediaResults.classList.add('d-none');
            } finally {
                // Reset button state
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fab fa-wikipedia-w me-1"></i> Search Wikipedia';
            }
        });

        // Handle "Use This Description" button in new relationship modal
        document.getElementById('useWikipediaNewRelationBtn').addEventListener('click', function() {
            const wikipediaResults = document.getElementById('wikipediaNewRelationResults');
            const extract = wikipediaResults.dataset.extract;
            const descriptionTextarea = document.getElementById('newEntryDescription');
            
            if (extract) {
                descriptionTextarea.value = extract;
                // Hide Wikipedia results after use
                wikipediaResults.classList.add('d-none');
            }
        });

        // Auto-resize textarea functionality
        function autoResizeTextarea(textarea) {
            // Reset height to auto to get the correct scrollHeight
            textarea.style.height = 'auto';
            // Set height to scrollHeight plus a small buffer
            textarea.style.height = (textarea.scrollHeight + 5) + 'px';
            // Ensure minimum height
            if (textarea.scrollHeight < 60) {
                textarea.style.height = '60px';
            }
        }

        // Apply theme section styles based on current settings
        function applyThemeSectionStyles() {
            console.log('applyThemeSectionStyles called');
            // Fetch theme settings from API instead of template variable
            fetch('/api/theme_settings')
                .then(response => {
                    console.log('API response received:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Theme data received:', data);
                    const sectionStyles = data.section_styles || {};
                    console.log('Section styles:', sectionStyles);
                    const themeSections = document.querySelectorAll('.theme-section');
                    console.log('Found theme sections:', themeSections.length);
                    
                    themeSections.forEach((section, index) => {
                        console.log(`Processing section ${index}:`, section.className);
                        // Remove existing pattern, effect, and decoration classes
                        section.className = section.className.replace(/\b(pattern|effect|decoration)-\S+/g, '');
                        
                        // Add pattern class if specified and not 'none'
                        if (sectionStyles.pattern && sectionStyles.pattern !== 'none') {
                            section.classList.add(`pattern-${sectionStyles.pattern}`);
                            console.log(`Added pattern-${sectionStyles.pattern} to section ${index}`);
                        }
                        
                        // Add effect class if specified and not 'none'
                        if (sectionStyles.effect && sectionStyles.effect !== 'none') {
                            section.classList.add(`effect-${sectionStyles.effect}`);
                            console.log(`Added effect-${sectionStyles.effect} to section ${index}`);
                        }
                        
                        // Add decoration class if specified and not 'none'
                        if (sectionStyles.decoration && sectionStyles.decoration !== 'none') {
                            section.classList.add(`decoration-${sectionStyles.decoration}`);
                            console.log(`Added decoration-${sectionStyles.decoration} to section ${index}`);
                        }
                        
                        console.log(`Final section ${index} classes:`, section.className);
                        
                        // Debug: Check computed styles
                        const computedStyle = window.getComputedStyle(section);
                        console.log(`Section ${index} background-image:`, computedStyle.backgroundImage);
                        console.log(`Section ${index} box-shadow:`, computedStyle.boxShadow);
                    });
                })
                .catch(error => {
                    console.error('Error fetching theme settings:', error);
                    // Fallback to empty styles if API fails
                });
        }

        // Apply auto-resize to all textareas
        document.addEventListener('DOMContentLoaded', function() {
            // Apply theme section styles first
            applyThemeSectionStyles();
            
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                // Set initial height
                autoResizeTextarea(textarea);
                
                // Add event listeners for auto-resize
                textarea.addEventListener('input', () => {
                    autoResizeTextarea(textarea);
                });
                
                textarea.addEventListener('paste', () => {
                    // Delay to allow paste content to be processed
                    setTimeout(() => autoResizeTextarea(textarea), 50);
                });
                
                // Handle focus to ensure proper sizing
                textarea.addEventListener('focus', () => {
                    autoResizeTextarea(textarea);
                });
                
                // Handle keyup for better responsiveness
                textarea.addEventListener('keyup', () => {
                    autoResizeTextarea(textarea);
                });
            });
            
            // Watch for dynamically added textareas
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            const newTextareas = node.querySelectorAll ? node.querySelectorAll('textarea') : [];
                            newTextareas.forEach(textarea => {
                                autoResizeTextarea(textarea);
                                textarea.addEventListener('input', () => autoResizeTextarea(textarea));
                                textarea.addEventListener('paste', () => {
                                    setTimeout(() => autoResizeTextarea(textarea), 50);
                                });
                                textarea.addEventListener('focus', () => autoResizeTextarea(textarea));
                                textarea.addEventListener('keyup', () => autoResizeTextarea(textarea));
                            });
                            
                            // Also check for AI improve buttons that might be missing icons
                            const aiButtons = node.querySelectorAll ? node.querySelectorAll('button') : [];
                            aiButtons.forEach(button => {
                                if (button.textContent.includes('AI Improve') && !button.querySelector('i')) {
                                    // Add an icon to AI improve buttons that don't have one
                                    const icon = document.createElement('i');
                                    icon.className = 'fas fa-magic me-1';
                                    button.insertBefore(icon, button.firstChild);
                                }
                            });
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Check existing AI improve buttons on page load
            document.querySelectorAll('button').forEach(button => {
                if (button.textContent.includes('AI Improve') && !button.querySelector('i')) {
                    // Add an icon to AI improve buttons that don't have one
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-magic me-1';
                    button.insertBefore(icon, button.firstChild);
                }
            });
        });
        
        // Cleanup auto-refresh when leaving the page
        window.addEventListener('beforeunload', function() {
            {% if entry.has_sensors %}
            stopSensorDataAutoRefresh();
            {% endif %}
        });

        // =====================================
        // AI Chat Functionality
        // =====================================
        let isFirstAIMessage = true;
        let aiChatAvailable = false;

        // Check AI availability on page load
        async function checkAIAvailability() {
            try {
                const response = await fetch('/api/ai/status');
                const data = await response.json();
                
                aiChatAvailable = data.available;
                
                const statusEl = document.getElementById('aiChatStatus');
                const messageEl = document.getElementById('aiStatusMessage');
                const chatInput = document.getElementById('aiChatInput');
                const sendBtn = document.getElementById('aiChatSendBtn');
                const clearBtn = document.getElementById('aiChatClearBtn');
                const includeNotesCheckbox = document.getElementById('aiIncludeAllNotes');
                
                if (aiChatAvailable) {
                    statusEl.className = 'alert alert-success small mb-3';
                    messageEl.innerHTML = '<i class="fas fa-check-circle me-2"></i>AI Assistant is ready!';
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    clearBtn.disabled = false;
                    includeNotesCheckbox.disabled = false;
                    
                    // Hide status after 2 seconds
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 2000);
                } else {
                    statusEl.className = 'alert alert-warning small mb-3';
                    messageEl.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>AI Assistant is not configured. Please set up Gemini API key in settings.';
                    chatInput.disabled = true;
                    sendBtn.disabled = true;
                    clearBtn.disabled = true;
                    includeNotesCheckbox.disabled = true;
                }
                
                statusEl.style.display = 'block';
            } catch (error) {
                console.error('Error checking AI availability:', error);
            }
        }

        // Initialize AI chat when section is expanded
        document.getElementById('aiChatSection').addEventListener('shown.bs.collapse', function() {
            checkAIAvailability();
        });

        // Send message to AI
        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            const includeAllNotes = document.getElementById('aiIncludeAllNotes').checked;
            
            if (!message || !aiChatAvailable) return;
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            const typingId = addTypingIndicator();
            
            try {
                const response = await fetch('/api/ai/entry-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entry_id: {{ entry.id }},
                        message: message,
                        is_first_message: isFirstAIMessage,
                        include_all_notes: includeAllNotes
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                if (data.success) {
                    addMessageToChat('ai', data.response);
                    isFirstAIMessage = false;
                } else {
                    addMessageToChat('error', data.error || 'Failed to get response from AI');
                }
            } catch (error) {
                removeTypingIndicator(typingId);
                addMessageToChat('error', 'Error communicating with AI: ' + error.message);
                console.error('AI chat error:', error);
            }
        }

        // Add message to chat UI
        function addMessageToChat(type, text) {
            const messagesContainer = document.getElementById('aiChatMessages');
            
            // Clear welcome message if it's the first message
            if (messagesContainer.querySelector('.text-center.text-muted')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-3 ${type}-message`;
            
            let iconClass = '';
            let bgClass = '';
            let textClass = '';
            
            if (type === 'user') {
                iconClass = 'fas fa-user';
                bgClass = 'bg-primary';
                textClass = 'text-white';
            } else if (type === 'ai') {
                iconClass = 'fas fa-robot';
                bgClass = 'bg-light';
                textClass = 'text-dark';
            } else if (type === 'error') {
                iconClass = 'fas fa-exclamation-triangle';
                bgClass = 'bg-danger';
                textClass = 'text-white';
            }
            
            messageDiv.innerHTML = `
                <div class="d-flex ${type === 'user' ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="message-bubble ${bgClass} ${textClass} p-3 rounded" style="max-width: 80%;">
                        <div class="d-flex align-items-start">
                            <i class="${iconClass} me-2 mt-1"></i>
                            <div style="white-space: pre-wrap;">${escapeHtml(text)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add typing indicator
        function addTypingIndicator() {
            const messagesContainer = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            const typingId = 'typing-' + Date.now();
            typingDiv.id = typingId;
            typingDiv.className = 'typing-indicator mb-3';
            typingDiv.innerHTML = `
                <div class="d-flex justify-content-start">
                    <div class="message-bubble bg-light text-dark p-3 rounded">
                        <i class="fas fa-robot me-2"></i>
                        <span class="typing-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </span>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return typingId;
        }

        // Remove typing indicator
        function removeTypingIndicator(typingId) {
            const typingDiv = document.getElementById(typingId);
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // Clear chat
        function clearAIChat() {
            const messagesContainer = document.getElementById('aiChatMessages');
            messagesContainer.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-robot fa-3x mb-3"></i>
                    <p>Ask me anything about this entry!</p>
                    <p class="small">I can help you understand the entry's status, relationships, notes, and more.</p>
                </div>
            `;
            isFirstAIMessage = true;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners for AI chat
        document.getElementById('aiChatSendBtn').addEventListener('click', sendAIMessage);
        document.getElementById('aiChatClearBtn').addEventListener('click', clearAIChat);
        document.getElementById('aiChatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIMessage();
            }
        });

        // Add CSS for typing animation
        const style = document.createElement('style');
        style.textContent = `
            .typing-dots span {
                animation: typingDot 1.4s infinite;
            }
            .typing-dots span:nth-child(2) {
                animation-delay: 0.2s;
            }
            .typing-dots span:nth-child(3) {
                animation-delay: 0.4s;
            }
            @keyframes typingDot {
                0%, 60%, 100% { opacity: 0; }
                30% { opacity: 1; }
            }
            .message-bubble {
                word-wrap: break-word;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            .user-message .message-bubble {
                background-color: var(--theme-primary, #0d6efd) !important;
            }
            .ai-message .message-bubble {
                background-color: var(--theme-bg-surface, #f8f9fa) !important;
                border: 1px solid var(--theme-border, #dee2e6);
            }
        `;
        document.head.appendChild(style);

    </script>
    <script src="{{ url_for('static', filename='label_printing.js') }}"></script>
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>
</body>
</html>
