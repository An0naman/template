<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - DevOps Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ribbon.css') }}">
    
    <!-- Dynamic Theme CSS -->
    <style id="theme-styles">
        {{ theme_css|safe }}
    </style>
    
<style>
    body {
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
    }
    
    .git-dashboard {
        padding: 20px;
        margin-top: 30px;
    }
    
    .repo-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid #0d6efd;
    }
    
    .repo-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .repo-card.active {
        background-color: #e7f3ff;
        border-left-color: #0a58ca;
    }
    
    .commit-item {
        border-left: 3px solid #dee2e6;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .commit-item:hover {
        border-left-color: #0d6efd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .commit-hash {
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.85em;
    }
    
    .commit-stats {
        display: inline-flex;
        gap: 10px;
        font-size: 0.85em;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .branch-badge {
        background: #e7f3ff;
        color: #0a58ca;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        display: inline-block;
        margin: 2px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .stats-card .stat-value {
        font-size: 2em;
        font-weight: bold;
    }
    
    .stats-card .stat-label {
        opacity: 0.9;
        font-size: 0.9em;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .loading .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>
</head>
<body>

<div class="container-fluid">
<div class="git-dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fab fa-git-alt me-2"></i>DevOps Dashboard</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRepoModal">
            <i class="fas fa-plus me-2"></i>Add Repository
        </button>
    </div>
    
    <div class="row">
        <!-- Repository List -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-folder me-2"></i>Repositories
                </div>
                <div class="card-body p-0" id="repoList">
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-md-9">
            <!-- Stats Cards -->
            <div class="row" id="statsSection" style="display: none;">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stat-value" id="totalCommits">0</div>
                        <div class="stat-label">Total Commits</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-value" id="commitsToday">0</div>
                        <div class="stat-label">Commits Today</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-value" id="uniqueAuthors">0</div>
                        <div class="stat-label">Contributors</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-value" id="linesChanged">0</div>
                        <div class="stat-label">Lines Changed</div>
                    </div>
                </div>
            </div>
            
            <!-- Commit Timeline -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-code-branch me-2"></i>Recent Commits</span>
                    <button class="btn btn-sm btn-secondary" id="syncBtn" style="display: none;">
                        <i class="fas fa-sync me-1"></i>Sync
                    </button>
                </div>
                <div class="card-body" id="commitTimeline">
                    <div class="empty-state">
                        <i class="fab fa-git-alt"></i>
                        <h4>Select a Repository</h4>
                        <p>Choose a repository from the list to view commits</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Add Repository Modal -->
<div class="modal fade" id="addRepoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fab fa-git-alt me-2"></i>Add Git Repository</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRepoForm">
                    <div class="mb-3">
                        <label class="form-label">Repository Name</label>
                        <input type="text" class="form-control" id="repoName" required>
                        <small class="text-muted">A friendly name for this repository</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Repository URL</label>
                        <input type="text" class="form-control" id="repoUrl" required 
                               placeholder="https://github.com/username/repo.git">
                        <small class="text-muted">Or local path: /path/to/repo</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Default Branch</label>
                        <input type="text" class="form-control" id="repoBranch" value="main">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Link to Entry Type (Optional)</label>
                        <select class="form-select" id="repoEntryType">
                            <option value="">-- Don't link --</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="repoAutoSync">
                        <label class="form-check-label" for="repoAutoSync">
                            Enable auto-sync
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="repoAutoCreate">
                        <label class="form-check-label" for="repoAutoCreate">
                            Auto-create entries from commits
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRepoBtn">
                    <i class="fas fa-save me-2"></i>Add Repository
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Commit Details Modal -->
<div class="modal fade" id="commitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-code-commit me-2"></i>Commit Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="commitDetails">
                <!-- Commit details loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="createEntryBtn">
                    <i class="fas fa-file-plus me-2"></i>Create Entry
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentRepoId = null;
let currentCommit = null;

// Load repositories on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRepositories();
    loadEntryTypes();
});

// Load all repositories
async function loadRepositories() {
    try {
        const response = await fetch('/api/git/repositories');
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error);
        }
        
        const repoList = document.getElementById('repoList');
        
        if (data.repositories.length === 0) {
            repoList.innerHTML = `
                <div class="empty-state">
                    <i class="fab fa-git-alt"></i>
                    <p>No repositories configured</p>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addRepoModal">
                        Add Your First Repo
                    </button>
                </div>
            `;
            return;
        }
        
        repoList.innerHTML = '';
        data.repositories.forEach(repo => {
            const repoCard = document.createElement('div');
            repoCard.className = 'repo-card list-group-item list-group-item-action';
            repoCard.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1"><i class="fab fa-git-alt me-2"></i>${escapeHtml(repo.name)}</h6>
                        <small class="text-muted">${repo.stats.total_commits || 0} commits</small>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            `;
            repoCard.onclick = () => selectRepository(repo.id);
            repoList.appendChild(repoCard);
        });
        
    } catch (error) {
        console.error('Failed to load repositories:', error);
        showAlert('Failed to load repositories: ' + error.message, 'danger');
    }
}

// Select a repository
async function selectRepository(repoId) {
    currentRepoId = repoId;
    
    // Update active state
    document.querySelectorAll('.repo-card').forEach(card => {
        card.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Show sync button
    document.getElementById('syncBtn').style.display = 'block';
    document.getElementById('statsSection').style.display = 'flex';
    
    // Load stats and commits
    await loadRepositoryStats(repoId);
    await loadCommits(repoId);
}

// Load repository statistics
async function loadRepositoryStats(repoId) {
    try {
        const response = await fetch(`/api/git/repositories/${repoId}/stats`);
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('totalCommits').textContent = stats.total_commits;
            document.getElementById('commitsToday').textContent = stats.commits_today;
            document.getElementById('uniqueAuthors').textContent = stats.unique_authors;
            const linesChanged = stats.total_insertions + stats.total_deletions;
            document.getElementById('linesChanged').textContent = linesChanged.toLocaleString();
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

// Load commits for repository
async function loadCommits(repoId) {
    const timeline = document.getElementById('commitTimeline');
    timeline.innerHTML = '<div class="loading"><div class="spinner-border text-primary"></div></div>';
    
    try {
        const response = await fetch(`/api/git/repositories/${repoId}/commits?limit=50`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error);
        }
        
        if (data.commits.length === 0) {
            timeline.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h5>No commits found</h5>
                    <p>Click "Sync" to fetch commits from the repository</p>
                </div>
            `;
            return;
        }
        
        timeline.innerHTML = '';
        data.commits.forEach(commit => {
            const commitItem = createCommitElement(commit);
            timeline.appendChild(commitItem);
        });
        
    } catch (error) {
        console.error('Failed to load commits:', error);
        timeline.innerHTML = `
            <div class="alert alert-danger">
                Failed to load commits: ${escapeHtml(error.message)}
            </div>
        `;
    }
}

// Create commit element
function createCommitElement(commit) {
    const div = document.createElement('div');
    div.className = 'commit-item';
    
    const date = new Date(commit.commit_date);
    const hasEntry = commit.entry_id !== null;
    
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <strong>${escapeHtml(commit.message)}</strong>
                <div class="text-muted small mt-1">
                    <span class="commit-hash">${commit.commit_hash.substring(0, 7)}</span>
                    by ${escapeHtml(commit.author)}
                </div>
            </div>
            <div class="text-end">
                <small class="text-muted">${formatDate(date)}</small>
                ${hasEntry ? '<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Entry</span>' : ''}
            </div>
        </div>
        <div class="commit-stats text-muted">
            <span class="stat-item"><i class="fas fa-file"></i> ${commit.files_changed} files</span>
            <span class="stat-item text-success"><i class="fas fa-plus"></i> ${commit.insertions}</span>
            <span class="stat-item text-danger"><i class="fas fa-minus"></i> ${commit.deletions}</span>
        </div>
        ${!hasEntry ? `
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="showCommitDetails('${commit.commit_hash}')">
                <i class="fas fa-eye me-1"></i>View Details
            </button>
        ` : `
            <a href="/entries/${commit.entry_id}" class="btn btn-sm btn-outline-success mt-2">
                <i class="fas fa-external-link-alt me-1"></i>View Entry
            </a>
        `}
    `;
    
    return div;
}

// Show commit details in modal
async function showCommitDetails(commitHash) {
    try {
        const response = await fetch(`/api/git/repositories/${currentRepoId}/commits`);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        const commit = data.commits.find(c => c.commit_hash === commitHash);
        if (!commit) throw new Error('Commit not found');
        
        currentCommit = commit;
        
        const details = document.getElementById('commitDetails');
        details.innerHTML = `
            <div class="mb-3">
                <h6>Commit Message:</h6>
                <pre class="bg-light p-3 rounded">${escapeHtml(commit.message_body || commit.message)}</pre>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Hash:</strong> <code>${commit.commit_hash}</code></p>
                    <p><strong>Author:</strong> ${escapeHtml(commit.author)} &lt;${escapeHtml(commit.author_email)}&gt;</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Date:</strong> ${new Date(commit.commit_date).toLocaleString()}</p>
                    <p><strong>Changes:</strong> ${commit.files_changed} files, +${commit.insertions}/-${commit.deletions}</p>
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('commitModal'));
        modal.show();
        
    } catch (error) {
        showAlert('Failed to load commit details: ' + error.message, 'danger');
    }
}

// Create entry from commit
document.getElementById('createEntryBtn')?.addEventListener('click', async function() {
    if (!currentCommit) return;
    
    try {
        // Get entry type from repository configuration
        const repoResponse = await fetch(`/api/git/repositories/${currentRepoId}`);
        const repoData = await repoResponse.json();
        
        const entryTypeId = repoData.repository.entry_type_id;
        if (!entryTypeId) {
            showAlert('Please configure an entry type for this repository in settings', 'warning');
            return;
        }
        
        const response = await fetch(`/api/git/commits/${currentCommit.commit_hash}/create-entry`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ entry_type_id: entryTypeId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('Entry created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('commitModal')).hide();
            loadCommits(currentRepoId);
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        showAlert('Failed to create entry: ' + error.message, 'danger');
    }
});

// Sync repository
document.getElementById('syncBtn')?.addEventListener('click', async function() {
    if (!currentRepoId) return;
    
    const btn = this;
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Syncing...';
    
    try {
        const response = await fetch(`/api/git/repositories/${currentRepoId}/sync`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            await loadRepositoryStats(currentRepoId);
            await loadCommits(currentRepoId);
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        showAlert('Sync failed: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
});

// Load entry types for dropdown
async function loadEntryTypes() {
    try {
        const response = await fetch('/api/entry-types');
        const data = await response.json();
        
        const select = document.getElementById('repoEntryType');
        data.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load entry types:', error);
    }
}

// Add repository
document.getElementById('saveRepoBtn')?.addEventListener('click', async function() {
    const form = document.getElementById('addRepoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const btn = this;
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/git/repositories', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: document.getElementById('repoName').value,
                url: document.getElementById('repoUrl').value,
                default_branch: document.getElementById('repoBranch').value,
                entry_type_id: parseInt(document.getElementById('repoEntryType').value) || null,
                auto_sync: document.getElementById('repoAutoSync').checked,
                auto_create_entries: document.getElementById('repoAutoCreate').checked
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('Repository added successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addRepoModal')).hide();
            form.reset();
            loadRepositories();
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        showAlert('Failed to add repository: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
    }
});

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(date) {
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) return 'Today';
    if (days === 1) return 'Yesterday';
    if (days < 7) return `${days} days ago`;
    
    return date.toLocaleDateString();
}

function showAlert(message, type = 'info') {
    // Implement your alert system here
    alert(message);
}
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
