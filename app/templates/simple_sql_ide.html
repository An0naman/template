<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - SQL IDE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">
    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .sql-ide-container {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid var(--bs-border-color);
            overflow: hidden;
        }
        
        .schema-panel {
            background: var(--bs-secondary-bg);
            border-right: 1px solid var(--bs-border-color);
            height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        
        .schema-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #6f42c1, #d63384);
        }
        
        .schema-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--bs-border-color);
            background: var(--bs-body-bg);
        }
        
        .schema-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #6f42c1;
        }
        
        .query-panel {
            background: var(--bs-body-bg);
            height: 85vh;
            display: flex;
            flex-direction: column;
        }
        
        .query-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--bs-border-color);
            background: var(--bs-secondary-bg);
        }
        
        .query-content {
            flex: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        
        .section-card {
            background: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #6f42c1, #d63384);
        }
        
        .CodeMirror {
            height: 250px;
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        
        /* Fix cursor visibility in dark mode */
        .CodeMirror-cursor {
            border-left: 2px solid var(--bs-body-color) !important;
        }
        
        /* Dark mode specific cursor fix */
        [data-bs-theme="dark"] .CodeMirror-cursor {
            border-left: 2px solid #ffffff !important;
        }
        
        /* Selected text visibility */
        .CodeMirror-selected {
            background: rgba(111, 66, 193, 0.3) !important;
        }
        
        .table-item {
            padding: 10px 16px;
            border-bottom: 1px solid var(--bs-border-color);
            cursor: pointer;
            font-family: monospace;
            transition: background-color 0.2s;
            margin-left: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-item:hover {
            background: rgba(111, 66, 193, 0.1);
            color: #6f42c1;
        }
        
        .table-expand-btn {
            background: none;
            border: none;
            color: var(--bs-secondary-color);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        
        .table-expand-btn:hover {
            background: rgba(111, 66, 193, 0.1);
            color: #6f42c1;
        }
        
        .column-item {
            padding: 6px 24px;
            font-size: 0.85em;
            color: var(--bs-secondary-color);
            background: var(--bs-body-bg);
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            margin: 2px 4px;
        }
        
        .column-item:hover {
            background: rgba(111, 66, 193, 0.1) !important;
            color: #6f42c1;
        }
        
        .results-container {
            flex: 1;
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            background: var(--bs-body-bg);
            overflow: auto;
            max-height: 400px;
            min-height: 200px;
        }
        
        .results-table {
            margin-bottom: 0;
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        
        .results-table th {
            background: var(--bs-secondary-bg);
            color: var(--bs-body-color);
            border-bottom: 2px solid var(--bs-border-color);
            padding: 12px 8px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .results-table td {
            padding: 8px;
            border-bottom: 1px solid var(--bs-border-color);
            vertical-align: top;
            word-break: break-word;
        }
        
        .results-table tbody tr:hover {
            background: var(--bs-secondary-bg);
        }
        
        .results-table .null-value {
            color: var(--bs-secondary-color);
            font-style: italic;
        }
        
        /* Fallback styling for better visibility */
        #resultsContainer {
            min-height: 100px;
        }
        
        #resultsContainer.visible {
            border: 2px solid #6f42c1;
            background: var(--bs-body-bg) !important;
        }
        
        .results-container table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-container table, 
        .results-container th, 
        .results-container td {
            border: 1px solid var(--bs-border-color);
            color: var(--bs-body-color) !important;
        }
        
        /* Force visibility in case of theme issues */
        .results-table * {
            color: inherit !important;
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #6f42c1, #d63384);
            border: none;
            color: white;
        }
        
        .btn-purple:hover {
            background: linear-gradient(135deg, #5a359a, #b02a5b);
            color: white;
        }
        
        .bg-purple {
            background-color: #6f42c1 !important;
        }
        
        .text-purple {
            color: #6f42c1 !important;
        }
        
        .alert-purple {
            background-color: rgba(111, 66, 193, 0.1);
            border-color: rgba(111, 66, 193, 0.2);
            color: #6f42c1;
        }
        
        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 8px;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 8px;
        }
        
        .info {
            color: #0c5460;
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 10px;
            border-radius: 8px;
        }

        /* IntelliSense Hint Styling */
        .CodeMirror-hints {
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10000;
        }

        .CodeMirror-hint {
            margin: 0;
            padding: 8px 12px;
            border-radius: 0;
            white-space: pre;
            color: var(--bs-body-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .CodeMirror-hint:hover {
            background: rgba(111, 66, 193, 0.1);
        }

        .CodeMirror-hint.CodeMirror-hint-active {
            background: rgba(111, 66, 193, 0.15);
            color: #6f42c1;
        }

        .sql-keyword-hint {
            color: #0066cc;
            font-weight: bold;
        }

        .sql-table-hint {
            color: #cc6600;
            font-weight: 600;
        }

        .sql-column-hint {
            color: #009900;
        }

        .sql-template-hint {
            color: #666666;
            font-style: italic;
        }
        
        .page-header {
            padding: 2rem 2rem 1rem 2rem;
            background: var(--bs-body-bg);
            border-bottom: 1px solid var(--bs-border-color);
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--bs-body-color);
        }
        
        .page-subtitle {
            color: var(--bs-secondary-color);
            margin-bottom: 0;
        }
        
        @media (max-width: 768px) {
            .sql-ide-container {
                margin: 10px;
            }
            .schema-panel, .query-panel {
                height: auto;
                min-height: 50vh;
            }
        }
        
        /* Sequence execution styles */
        .sequence-summary {
            padding: 1rem;
            background: var(--bs-secondary-bg);
            border-radius: 8px;
            border-left: 4px solid #6f42c1;
        }
        
        .sequence-summary h5 {
            color: var(--bs-body-color);
            margin-bottom: 1rem;
        }
        
        .sequence-summary .alert {
            margin-top: 1rem;
            margin-bottom: 0;
        }
        
        /* Saved queries dropdown styling */
        .dropdown-menu {
            max-height: 400px;
            overflow-y: auto;
            min-width: 300px;
        }
        
        .dropdown-item.d-flex {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--bs-border-color);
        }
        
        .dropdown-item.d-flex:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start flex-column flex-md-row gap-3">
            <div>
                <h1 class="page-title">{{ project_name }} SQL IDE</h1>
                <p class="page-subtitle d-none d-md-block">
                    <i class="fas fa-database me-2"></i>Database management and query interface with intelligent autocomplete
                </p>
            </div>
            <div>
                <a href="{{ url_for('maintenance.maintenance_module_page') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i><span class="d-none d-sm-inline">Back to </span>Settings
                </a>
            </div>
        </div>
    </div>

    <!-- Main SQL IDE Container -->
    <div class="sql-ide-container">
        <div class="row g-0">
            <!-- Schema Panel -->
            <div class="col-12 col-lg-3 col-md-4 order-2 order-md-1">
                <div class="schema-panel">
                    <div class="schema-header">
                        <div class="schema-title">
                            <i class="fas fa-sitemap me-2"></i><span class="d-none d-sm-inline">Database </span>Schema
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button id="loadSchemaBtn" class="btn btn-purple btn-sm mb-2">
                                <i class="fas fa-sync me-1"></i><span class="d-none d-sm-inline">Load </span>Schema
                            </button>
                            <button id="testApiBtn" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-flask me-1"></i><span class="d-none d-sm-inline">Test </span>API
                            </button>
                        </div>
                    </div>
                    <div id="schemaContent" class="p-3">
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-database fa-2x mb-3"></i>
                            <p>Click "Load Schema" to view tables</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Query Panel -->
            <div class="col-12 col-lg-9 col-md-8 order-1 order-md-2">
                <div class="query-panel">
                    <div class="query-header">
                        <h4 class="mb-0 text-purple">
                            <i class="fas fa-code me-2"></i>SQL Query Editor
                        </h4>
                        <small class="text-muted">Use Ctrl+Space for autocomplete, Ctrl+Enter to execute</small>
                    </div>
                    
                    <div class="query-content">
                        <!-- SQL Editor Section -->
                        <div class="section-card">
                            <div class="mb-3">
                                <label for="sqlQuery" class="form-label fw-semibold">
                                    <i class="fas fa-edit me-1"></i>SQL Query
                                </label>
                                <textarea id="sqlQuery" class="form-control" placeholder="Enter your SQL query here...">SELECT * FROM Entry LIMIT 10;</textarea>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mb-3 flex-wrap btn-group-mobile-stack">
                                <button id="executeBtn" class="btn btn-purple">
                                    <i class="fas fa-play me-1"></i><span class="d-none d-sm-inline">Execute</span><span class="d-sm-none">Run</span>
                                </button>
                                <div class="btn-group">
                                    <button id="saveQueryBtn" class="btn btn-info">
                                        <i class="fas fa-save me-1"></i><span class="d-none d-sm-inline">Save Query</span><span class="d-sm-none">Save</span>
                                    </button>
                                    <button class="btn btn-info dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" id="savedQueriesDropdown">
                                        <li><h6 class="dropdown-header">Saved Queries</h6></li>
                                        <li><span class="dropdown-item-text text-muted">No saved queries yet</span></li>
                                    </ul>
                                </div>
                                <button id="clearBtn" class="btn btn-outline-secondary">
                                    <i class="fas fa-eraser me-1"></i><span class="d-none d-sm-inline">Clear</span>
                                </button>
                                <!-- AI Assistance Buttons -->
                                <div class="btn-group btn-group-mobile-stack" role="group">
                                    <button id="aiGenerateBtn" class="btn btn-outline-warning btn-sm" title="Generate SQL from description">
                                        <i class="fas fa-robot me-1"></i><span class="d-none d-md-inline">AI Generate</span><span class="d-md-none">AI</span>
                                    </button>
                                    <button id="aiExplainBtn" class="btn btn-outline-info btn-sm" title="Explain current query">
                                        <i class="fas fa-lightbulb me-1"></i><span class="d-none d-md-inline">AI Explain</span><span class="d-md-none">Help</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Messages -->
                            <div id="messages"></div>
                        </div>
                        
                        <!-- Results Section -->
                        <div id="resultsContainer" class="section-card" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="text-purple mb-0">
                                    <i class="fas fa-table me-2"></i>Query Results
                                    <span id="resultCount" class="badge bg-secondary ms-2"></span>
                                </h5>
                                <!-- Navigation for multiple results -->
                                <div id="resultNavigation" class="btn-group" style="display: none;">
                                    <button id="prevResultBtn" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span id="resultCounter" class="btn btn-sm btn-outline-secondary disabled">1 / 1</span>
                                    <button id="nextResultBtn" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="currentResultInfo" class="mb-2 text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                <span>Single query result</span>
                            </div>
                            <div class="results-container">
                                <table id="resultsTable" class="table results-table">
                                    <thead id="resultsTableHead"></thead>
                                    <tbody id="resultsTableBody"></tbody>
                                </table>
                            </div>
                            <div class="mt-2 text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="resultInfo">Results displayed above</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/sql-hint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    
    <script>
        let schemaData = {};
        let allTableNames = [];
        let allColumnNames = [];
        let columnsByTable = {};

        // Initialize CodeMirror with enhanced SQL IntelliSense
        const sqlEditor = CodeMirror.fromTextArea(document.getElementById('sqlQuery'), {
            mode: 'text/x-sql',
            theme: 'default',
            lineNumbers: true,
            indentWithTabs: true,
            smartIndent: true,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            hintOptions: {
                tables: {},
                defaultTable: '',
                disableKeywords: false
            },
            extraKeys: {
                "Ctrl-Enter": executeQuery,
                "Cmd-Enter": executeQuery,
                "Ctrl-Space": "autocomplete",
                "Tab": function(cm) {
                    if (cm.somethingSelected()) {
                        cm.indentSelection("add");
                    } else {
                        cm.replaceSelection("    ", "end");
                    }
                }
            }
        });

        // Enhanced autocomplete functionality
        function setupIntelliSense() {
            // Update CodeMirror hint options with our schema data
            if (sqlEditor && Object.keys(columnsByTable).length > 0) {
                sqlEditor.setOption('hintOptions', {
                    tables: columnsByTable,
                    defaultTable: '',
                    disableKeywords: false
                });
            }

            // Custom hint function that combines SQL keywords, tables, and columns
            CodeMirror.registerHelper("hint", "sql", function(editor, options) {
                const cur = editor.getCursor();
                const token = editor.getTokenAt(cur);
                const start = token.start;
                const end = cur.ch;
                const search = token.string.trim().toLowerCase();
                
                // SQL Keywords
                const sqlKeywords = [
                    'SELECT', 'FROM', 'WHERE', 'INSERT', 'UPDATE', 'DELETE', 'CREATE', 'ALTER', 'DROP',
                    'JOIN', 'INNER JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'FULL JOIN', 'ON', 'AS', 'AND', 'OR',
                    'ORDER BY', 'GROUP BY', 'HAVING', 'DISTINCT', 'COUNT', 'SUM', 'AVG', 'MAX', 'MIN',
                    'LIMIT', 'OFFSET', 'UNION', 'INTERSECT', 'EXCEPT', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END',
                    'IS NULL', 'IS NOT NULL', 'LIKE', 'ILIKE', 'IN', 'NOT IN', 'EXISTS', 'NOT EXISTS',
                    'BETWEEN', 'NOT BETWEEN', 'ASC', 'DESC', 'TRUE', 'FALSE', 'NULL'
                ];

                // Context-aware suggestions
                const line = editor.getLine(cur.line).toLowerCase();
                const beforeCursor = line.substring(0, cur.ch).trim();
                
                let suggestions = [];

                // Detect context
                const isAfterFrom = /\bfrom\s+$/i.test(beforeCursor);
                const isAfterSelect = /\bselect\s+([^from])*$/i.test(beforeCursor);
                const isAfterWhere = /\bwhere\s+([^order|group|limit])*$/i.test(beforeCursor);
                const isAfterJoin = /\bjoin\s+$/i.test(beforeCursor);
                const hasTableContext = /\bfrom\s+(\w+)/i.exec(beforeCursor);

                // Table suggestions (after FROM, JOIN)
                if (isAfterFrom || isAfterJoin) {
                    suggestions = allTableNames.filter(table => 
                        table.toLowerCase().includes(search)
                    ).map(table => ({
                        text: table,
                        displayText: `üìÅ ${table}`,
                        className: 'sql-table-hint'
                    }));
                }
                // Column suggestions (after SELECT, WHERE, or with table context)
                else if (isAfterSelect || isAfterWhere || hasTableContext) {
                    // If we have a table context, show its columns first
                    if (hasTableContext) {
                        const tableName = hasTableContext[1];
                        if (columnsByTable[tableName]) {
                            suggestions = columnsByTable[tableName].filter(col => 
                                col.toLowerCase().includes(search)
                            ).map(col => ({
                                text: col,
                                displayText: `üîó ${tableName}.${col}`,
                                className: 'sql-column-hint'
                            }));
                        }
                    }
                    
                    // Add all columns as fallback
                    suggestions = suggestions.concat(
                        allColumnNames.filter(col => 
                            col.toLowerCase().includes(search) && 
                            !suggestions.some(s => s.text === col)
                        ).map(col => {
                            // Find which table this column belongs to
                            const tableName = Object.keys(columnsByTable).find(table => 
                                columnsByTable[table].includes(col)
                            );
                            return {
                                text: col,
                                displayText: tableName ? `üìÑ ${col} (${tableName})` : `üìÑ ${col}`,
                                className: 'sql-column-hint'
                            };
                        })
                    );
                }
                
                // Add SQL keywords if no specific context or if search matches
                const keywordSuggestions = sqlKeywords.filter(keyword => 
                    keyword.toLowerCase().includes(search)
                ).map(keyword => ({
                    text: keyword,
                    displayText: `‚ö° ${keyword}`,
                    className: 'sql-keyword-hint'
                }));

                suggestions = suggestions.concat(keywordSuggestions);

                // Add common query templates
                if (search.length <= 2) {
                    const templates = [
                        {
                            text: 'SELECT * FROM ',
                            displayText: 'üìã SELECT * FROM template',
                            className: 'sql-template-hint'
                        },
                        {
                            text: 'SELECT COUNT(*) FROM ',
                            displayText: 'üìä COUNT template',
                            className: 'sql-template-hint'
                        },
                        {
                            text: 'INSERT INTO table_name (columns) VALUES (values)',
                            displayText: '‚ûï INSERT template',
                            className: 'sql-template-hint'
                        },
                        {
                            text: 'UPDATE table_name SET column = value WHERE condition',
                            displayText: '‚úèÔ∏è UPDATE template',
                            className: 'sql-template-hint'
                        }
                    ];
                    suggestions = suggestions.concat(templates);
                }

                // Sort suggestions: exact matches first, then by relevance
                suggestions.sort((a, b) => {
                    const aExact = a.text.toLowerCase() === search;
                    const bExact = b.text.toLowerCase() === search;
                    if (aExact && !bExact) return -1;
                    if (!aExact && bExact) return 1;
                    return a.text.localeCompare(b.text);
                });

                return {
                    list: suggestions.slice(0, 20), // Limit to 20 suggestions
                    from: CodeMirror.Pos(cur.line, start),
                    to: CodeMirror.Pos(cur.line, end)
                };
            });

            // Auto-trigger hints on typing
            sqlEditor.on("inputRead", function(editor, change) {
                if (change.text[0].match(/[a-zA-Z]/)) {
                    CodeMirror.commands.autocomplete(editor, null, {
                        completeSingle: false,
                        closeOnUnfocus: true,
                        alignWithWord: true,
                        closeCharacters: /[\s()\[\]{};:>,]/
                    });
                }
            });
        }

        // DOM elements
        const loadSchemaBtn = document.getElementById('loadSchemaBtn');
        const testApiBtn = document.getElementById('testApiBtn');
        const schemaContent = document.getElementById('schemaContent');
        const executeBtn = document.getElementById('executeBtn');
        const saveQueryBtn = document.getElementById('saveQueryBtn');
        const savedQueriesDropdown = document.getElementById('savedQueriesDropdown');
        const clearBtn = document.getElementById('clearBtn');
        const aiGenerateBtn = document.getElementById('aiGenerateBtn');
        const aiExplainBtn = document.getElementById('aiExplainBtn');
        const messages = document.getElementById('messages');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsTable = document.getElementById('resultsTable');
        const resultsTableHead = document.getElementById('resultsTableHead');
        const resultsTableBody = document.getElementById('resultsTableBody');
        
        // Result navigation elements
        const resultNavigation = document.getElementById('resultNavigation');
        const prevResultBtn = document.getElementById('prevResultBtn');
        const nextResultBtn = document.getElementById('nextResultBtn');
        const resultCounter = document.getElementById('resultCounter');
        const currentResultInfo = document.getElementById('currentResultInfo');
        
        // Global variables for result management
        let allResults = [];
        let currentResultIndex = 0;

        // Event listeners
        loadSchemaBtn.addEventListener('click', loadSchema);
        testApiBtn.addEventListener('click', testApi);
        executeBtn.addEventListener('click', executeQuery);
        saveQueryBtn.addEventListener('click', saveQuery);
        clearBtn.addEventListener('click', clearEditor);
        aiGenerateBtn.addEventListener('click', showAIGenerateModal);
        aiExplainBtn.addEventListener('click', explainQuery);
        prevResultBtn.addEventListener('click', () => navigateResults(-1));
        nextResultBtn.addEventListener('click', () => navigateResults(1));
        
        // Load saved queries on page load
        loadSavedQueries();

        function showMessage(message, type = 'info') {
            const alertClass = type === 'error' ? 'error' : 
                              type === 'success' ? 'success' : 'info';
            messages.innerHTML = `<div class="${alertClass}">${message}</div>`;
            setTimeout(() => {
                messages.innerHTML = '';
            }, 5000);
        }

        function testApi() {
            testApiBtn.disabled = true;
            testApiBtn.textContent = 'Testing...';
            
            fetch('/api/sql/tables')
                .then(response => {
                    console.log('Test API Response status:', response.status);
                    console.log('Test API Response type:', response.headers.get('content-type'));
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    console.log('Test API Raw response (first 200 chars):', text.substring(0, 200));
                    
                    try {
                        const data = JSON.parse(text);
                        showMessage(`API Test SUCCESS! Found ${data.tables ? data.tables.length : 0} tables`, 'success');
                    } catch (e) {
                        showMessage(`API returned non-JSON: ${text.substring(0, 100)}...`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Test API Error:', error);
                    showMessage(`API Test FAILED: ${error.message}`, 'error');
                })
                .finally(() => {
                    testApiBtn.disabled = false;
                    testApiBtn.textContent = 'Test API';
                });
        }

        function loadSchema() {
            loadSchemaBtn.disabled = true;
            loadSchemaBtn.textContent = 'Loading...';
            schemaContent.innerHTML = '<div class="loading">Loading schema...</div>';

            fetch('/api/sql/tables')
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response.text(); // Get as text first to debug
                })
                .then(text => {
                    console.log('Raw response:', text);
                    
                    try {
                        const data = JSON.parse(text);
                        if (data.success) {
                            schemaData = data.table_info;
                            
                            // Extract data for IntelliSense
                            allTableNames = data.tables || [];
                            columnsByTable = {};
                            allColumnNames = [];
                            
                            Object.keys(schemaData).forEach(tableName => {
                                if (schemaData[tableName] && schemaData[tableName].columns) {
                                    columnsByTable[tableName] = schemaData[tableName].columns.map(col => col.name);
                                    allColumnNames = allColumnNames.concat(columnsByTable[tableName]);
                                }
                            });
                            
                            // Remove duplicates from allColumnNames
                            allColumnNames = [...new Set(allColumnNames)];
                            
                            console.log('IntelliSense data prepared:', { 
                                tables: allTableNames, 
                                columns: allColumnNames, 
                                columnsByTable 
                            });
                            
                            displaySchema(data.tables, data.table_info);
                            setupIntelliSense(); // Enable IntelliSense with loaded data
                            showMessage('Schema loaded successfully with IntelliSense!', 'success');
                        } else {
                            throw new Error(data.error || 'Failed to load schema');
                        }
                    } catch (parseError) {
                        console.error('JSON Parse Error:', parseError);
                        throw new Error(`Invalid JSON response: ${parseError.message}`);
                    }
                })
                .catch(error => {
                    console.error('Schema loading error:', error);
                    schemaContent.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                    showMessage(`Failed to load schema: ${error.message}`, 'error');
                })
                .finally(() => {
                    loadSchemaBtn.disabled = false;
                    loadSchemaBtn.textContent = 'Reload Schema';
                });
        }

        function displaySchema(tables, tableInfo) {
            let html = '';
            
            tables.forEach(tableName => {
                html += `<div class="table-item" onclick="insertTableName('${tableName}')">
                    <span><strong>üìÅ ${tableName}</strong></span>
                    <button class="table-expand-btn" onclick="event.stopPropagation(); toggleTable('${tableName}'); this.innerHTML = document.getElementById('columns-${tableName}').style.display === 'none' ? '<i class=&quot;fas fa-chevron-down&quot;></i>' : '<i class=&quot;fas fa-chevron-up&quot;></i>';">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>`;
                html += `<div id="columns-${tableName}" style="display: none;">`;
                
                if (tableInfo[tableName] && tableInfo[tableName].columns) {
                    tableInfo[tableName].columns.forEach(column => {
                        const icon = column.primary_key ? 'üîë' : 
                                   column.not_null ? 'üìå' : 'üìÑ';
                        html += `<div class="column-item" onclick="insertColumnName('${tableName}', '${column.name}')" title="Click to insert ${tableName}.${column.name}">
                            ${icon} ${column.name} <em>(${column.type})</em>
                        </div>`;
                    });
                }
                
                html += '</div>';
            });
            
            schemaContent.innerHTML = html;
        }

        function insertTableName(tableName) {
            const cursor = sqlEditor.getCursor();
            sqlEditor.replaceRange(tableName, cursor);
            sqlEditor.focus();
        }

        function insertColumnName(tableName, columnName) {
            const cursor = sqlEditor.getCursor();
            sqlEditor.replaceRange(`${tableName}.${columnName}`, cursor);
            sqlEditor.focus();
        }

        function toggleTable(tableName) {
            const columnsDiv = document.getElementById(`columns-${tableName}`);
            if (columnsDiv) {
                columnsDiv.style.display = columnsDiv.style.display === 'none' ? 'block' : 'none';
            }
        }

        function executeQuery() {
            const query = sqlEditor.getValue().trim();
            
            if (!query) {
                showMessage('Please enter a SQL query', 'error');
                return;
            }

            // Split by semicolons and filter out empty commands
            const commands = query.split(';')
                .map(cmd => cmd.trim())
                .filter(cmd => cmd.length > 0);

            if (commands.length === 0) {
                showMessage('No valid commands found', 'error');
                return;
            }

            executeBtn.disabled = true;
            
            if (commands.length === 1) {
                // Single command execution
                executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Executing...';
                executeSingleCommand(commands[0]);
            } else {
                // Multiple command execution
                executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Executing Sequence...';
                executeCommandSequence(commands, 0, []);
            }
        }

        function executeSingleCommand(command) {
            messages.innerHTML = '<div class="loading">Executing query...</div>';

            fetch('/api/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: command })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Query response:', data);
                if (data.success) {
                    if (data.query_type === 'select') {
                        console.log('Processing SELECT query results...');
                        allResults = [{
                            command: command,
                            data: data,
                            success: true,
                            index: 0
                        }];
                        currentResultIndex = 0;
                        displayCurrentResult();
                        showMessage(`Query executed successfully. ${data.row_count} row(s) returned.`, 'success');
                    } else {
                        console.log('Non-SELECT query executed');
                        hideResults();
                        showMessage(`Query executed successfully. ${data.affected_rows} row(s) affected.`, 'success');
                    }
                } else {
                    console.error('Query failed:', data.error);
                    hideResults();
                    showMessage(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Query execution error:', error);
                hideResults();
                showMessage(`Network error: ${error.message}`, 'error');
            })
            .finally(() => {
                executeBtn.disabled = false;
                executeBtn.innerHTML = '<i class="fas fa-play me-1"></i>Execute';
            });
        }

        function displayResults(results, columnNames) {
            console.log('displayResults called with:', { results, columnNames });
            
            if (!results || results.length === 0) {
                hideResults();
                showMessage('Query executed successfully but returned no results.', 'success');
                return;
            }

            console.log(`Displaying ${results.length} rows with ${columnNames.length} columns`);

            // Update result count badge
            const resultCount = document.getElementById('resultCount');
            if (resultCount) {
                resultCount.textContent = `${results.length} rows`;
            }

            // Update result info
            const resultInfo = document.getElementById('resultInfo');
            if (resultInfo) {
                resultInfo.textContent = `Showing ${results.length} row(s) with ${columnNames.length} column(s)`;
            }

            // Create table header
            let headerHtml = '<tr>';
            columnNames.forEach(column => {
                headerHtml += `<th title="Column: ${column}">${column}</th>`;
            });
            headerHtml += '</tr>';
            resultsTableHead.innerHTML = headerHtml;
            console.log('Table header created:', headerHtml);

            // Create table body
            let bodyHtml = '';
            results.forEach((row, rowIndex) => {
                bodyHtml += '<tr>';
                columnNames.forEach(column => {
                    const value = row[column];
                    let displayValue, cellClass = '';
                    
                    if (value === null || value === undefined) {
                        displayValue = '<span class="null-value">NULL</span>';
                    } else if (typeof value === 'string' && value.length > 100) {
                        displayValue = value.substring(0, 100) + '...';
                    } else {
                        displayValue = String(value);
                    }
                    
                    bodyHtml += `<td title="Row ${rowIndex + 1}, ${column}: ${value}">${displayValue}</td>`;
                });
                bodyHtml += '</tr>';
            });
            resultsTableBody.innerHTML = bodyHtml;
            console.log(`Table body created with ${results.length} rows`);

            // Show the results container
            resultsContainer.style.display = 'block';
            resultsContainer.classList.add('visible');
            console.log('Results container shown with visibility class');
            
            // Scroll to results if needed
            setTimeout(() => {
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function hideResults() {
            resultsContainer.style.display = 'none';
            resultsContainer.classList.remove('visible');
            resultNavigation.style.display = 'none';
            allResults = [];
            currentResultIndex = 0;
        }

        function displayCurrentResult() {
            if (allResults.length === 0) {
                hideResults();
                return;
            }

            const currentResult = allResults[currentResultIndex];
            
            // Show navigation only if there are multiple results
            if (allResults.length > 1) {
                resultNavigation.style.display = 'flex';
                resultCounter.textContent = `${currentResultIndex + 1} / ${allResults.length}`;
                prevResultBtn.disabled = currentResultIndex === 0;
                nextResultBtn.disabled = currentResultIndex === allResults.length - 1;
                
                // Update current result info
                currentResultInfo.innerHTML = `
                    <i class="fas fa-info-circle me-1"></i>
                    <span>Command ${currentResult.index + 1}: ${currentResult.command.substring(0, 50)}${currentResult.command.length > 50 ? '...' : ''}</span>
                `;
            } else {
                resultNavigation.style.display = 'none';
                currentResultInfo.innerHTML = `
                    <i class="fas fa-info-circle me-1"></i>
                    <span>Single query result</span>
                `;
            }

            // Display the current result
            if (currentResult.success && currentResult.data && currentResult.data.query_type === 'select') {
                displayResults(currentResult.data.results, currentResult.data.column_names);
            } else {
                hideResults();
            }
        }

        function navigateResults(direction) {
            if (allResults.length === 0) return;
            
            const newIndex = currentResultIndex + direction;
            if (newIndex >= 0 && newIndex < allResults.length) {
                currentResultIndex = newIndex;
                displayCurrentResult();
            }
        }

        function clearEditor() {
            sqlEditor.setValue('');
            hideResults();
            messages.innerHTML = '';
        }

        // Query saving and loading functions
        function saveQuery() {
            const query = sqlEditor.getValue().trim();
            if (!query) {
                showMessage('Please enter a query to save', 'error');
                return;
            }

            const queryName = prompt('Enter a name for this query:');
            if (!queryName) return;

            const savedQueries = getSavedQueries();
            const queryId = Date.now().toString();
            
            savedQueries[queryId] = {
                name: queryName,
                query: query,
                savedAt: new Date().toISOString()
            };

            localStorage.setItem('sqlIdeQueries', JSON.stringify(savedQueries));
            loadSavedQueries();
            showMessage(`Query "${queryName}" saved successfully`, 'success');
        }

        function getSavedQueries() {
            try {
                return JSON.parse(localStorage.getItem('sqlIdeQueries') || '{}');
            } catch (e) {
                return {};
            }
        }

        function loadSavedQueries() {
            const savedQueries = getSavedQueries();
            const dropdown = savedQueriesDropdown;
            
            // Clear existing items except header
            dropdown.innerHTML = '<li><h6 class="dropdown-header">Saved Queries</h6></li>';
            
            const queryIds = Object.keys(savedQueries);
            if (queryIds.length === 0) {
                dropdown.innerHTML += '<li><span class="dropdown-item-text text-muted">No saved queries yet</span></li>';
                return;
            }

            // Sort by saved date (newest first)
            queryIds.sort((a, b) => new Date(savedQueries[b].savedAt) - new Date(savedQueries[a].savedAt));

            queryIds.forEach(queryId => {
                const query = savedQueries[queryId];
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="dropdown-item d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <a href="#" class="text-decoration-none" onclick="loadQuery('${queryId}'); return false;">
                                <strong>${query.name}</strong><br>
                                <small class="text-muted">${new Date(query.savedAt).toLocaleDateString()}</small>
                            </a>
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteQuery('${queryId}'); return false;" title="Delete query">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                dropdown.appendChild(li);
            });
        }

        function loadQuery(queryId) {
            const savedQueries = getSavedQueries();
            const query = savedQueries[queryId];
            if (query) {
                sqlEditor.setValue(query.query);
                showMessage(`Loaded query: ${query.name}`, 'success');
            }
        }

        function deleteQuery(queryId) {
            const savedQueries = getSavedQueries();
            const query = savedQueries[queryId];
            
            if (confirm(`Are you sure you want to delete the query "${query.name}"?`)) {
                delete savedQueries[queryId];
                localStorage.setItem('sqlIdeQueries', JSON.stringify(savedQueries));
                loadSavedQueries();
                showMessage(`Query "${query.name}" deleted`, 'success');
            }
        }

        async function executeCommandSequence(commands, index, results) {
            if (index >= commands.length) {
                // All commands executed
                executeBtn.disabled = false;
                executeBtn.innerHTML = '<i class="fas fa-play me-1"></i>Execute';
                
                // Filter results to only include successful SELECT queries
                const selectResults = results.filter(r => r.success && r.data && r.data.query_type === 'select');
                
                // Display summary
                const successCount = results.filter(r => r.success).length;
                const errorCount = results.length - successCount;
                
                let summaryHtml = `<div class="sequence-summary">
                    <h5><i class="fas fa-list-check me-2"></i>Sequence Execution Complete</h5>
                    <p><strong>${successCount}/${results.length}</strong> commands executed successfully</p>
                `;

                if (errorCount > 0) {
                    summaryHtml += `<div class="alert alert-warning">
                        <strong>${errorCount} command(s) failed:</strong><br>
                        ${results.filter(r => !r.success).map((r, i) => 
                            `Command ${r.index + 1}: ${r.error}`
                        ).join('<br>')}
                    </div>`;
                }

                if (selectResults.length > 0) {
                    summaryHtml += `<p><strong>${selectResults.length} SELECT query/queries returned results</strong> - use the navigation arrows to browse through them.</p>`;
                    
                    // Set up result navigation
                    allResults = selectResults;
                    currentResultIndex = 0;
                    displayCurrentResult();
                } else {
                    summaryHtml += `<p>No SELECT queries returned results to display.</p>`;
                    hideResults();
                }

                summaryHtml += '</div>';
                showMessage(summaryHtml, successCount === results.length ? 'success' : 'warning');
                return;
            }

            const command = commands[index];
            messages.innerHTML = `<div class="loading">Executing command ${index + 1}/${commands.length}: ${command.substring(0, 50)}${command.length > 50 ? '...' : ''}</div>`;

            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: command })
                });

                const data = await response.json();
                results.push({
                    index: index,
                    command: command,
                    success: data.success,
                    data: data.success ? data : null,
                    error: data.success ? null : data.error
                });

                // Small delay between commands
                setTimeout(() => {
                    executeCommandSequence(commands, index + 1, results);
                }, 100);

            } catch (error) {
                results.push({
                    index: index,
                    command: command,
                    success: false,
                    data: null,
                    error: error.message
                });

                setTimeout(() => {
                    executeCommandSequence(commands, index + 1, results);
                }, 100);
            }
        }

        // AI Functions
        function showAIGenerateModal() {
            const modal = new bootstrap.Modal(document.getElementById('aiGenerateModal'));
            modal.show();
            
            // Set up the generate button in the modal
            const generateBtn = document.getElementById('generateSqlBtn');
            generateBtn.onclick = generateSQL;
        }

        function generateSQL() {
            const description = document.getElementById('sqlDescription').value.trim();
            if (!description) {
                showMessage('Please enter a description of what you want to do.', 'warning');
                return;
            }

            const generateBtn = document.getElementById('generateSqlBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';

            // First fetch the database schema
            fetch('/api/sql/tables')
            .then(response => response.json())
            .then(schemaData => {
                // Build table info string
                let tableInfo = '';
                if (schemaData.success && schemaData.table_info) {
                    tableInfo = 'Database Schema:\n';
                    for (const [tableName, info] of Object.entries(schemaData.table_info)) {
                        tableInfo += `\nTable: ${tableName}\n`;
                        tableInfo += 'Columns:\n';
                        info.columns.forEach(col => {
                            tableInfo += `  - ${col.name} (${col.type})${col.primary_key ? ' PRIMARY KEY' : ''}${col.not_null ? ' NOT NULL' : ''}\n`;
                        });
                    }
                }
                
                return fetch('/api/ai/generate_sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: description,
                        table_info: tableInfo
                    })
                });
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('Error generating SQL: ' + data.error, 'danger');
                } else {
                    // Insert the generated SQL into the editor
                    sqlEditor.setValue(data.sql_query);
                    showMessage('SQL generated successfully!', 'success');
                    // Close the modal
                    bootstrap.Modal.getInstance(document.getElementById('aiGenerateModal')).hide();
                    // Clear the description for next use
                    document.getElementById('sqlDescription').value = '';
                }
            })
            .catch(error => {
                console.error('Error generating SQL:', error);
                showMessage('Error generating SQL. Please try again.', 'danger');
            })
            .finally(() => {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            });
        }

        function explainQuery() {
            const query = sqlEditor.getValue().trim();
            if (!query) {
                showMessage('Please enter a SQL query to explain.', 'warning');
                return;
            }

            const originalText = aiExplainBtn.innerHTML;
            aiExplainBtn.disabled = true;
            aiExplainBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Explaining...';

            fetch('/api/ai/explain_sql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sql_query: query
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('Error explaining SQL: ' + data.error, 'danger');
                } else {
                    // Show explanation in a nice format
                    showMessage(`<strong>Query Explanation:</strong><br>${data.explanation.replace(/\n/g, '<br>')}`, 'info', 10000);
                }
            })
            .catch(error => {
                console.error('Error explaining SQL:', error);
                showMessage('Error explaining SQL. Please try again.', 'danger');
            })
            .finally(() => {
                aiExplainBtn.disabled = false;
                aiExplainBtn.innerHTML = originalText;
            });
        }

        // Auto-load schema when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, setting up SQL IDE...');
            // Don't auto-load, let user click the button
        });
    </script>
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>

    <!-- AI Generate SQL Modal -->
    <div class="modal fade" id="aiGenerateModal" tabindex="-1" aria-labelledby="aiGenerateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiGenerateModalLabel">
                        <i class="fas fa-robot me-2"></i>AI Generate SQL
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="sqlDescription" class="form-label">Describe what you want to do:</label>
                        <textarea class="form-control" id="sqlDescription" rows="3" 
                                  placeholder="e.g., 'Find all users who registered in the last 30 days' or 'Update all products with price greater than 100'"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="generateSqlBtn">
                        <i class="fas fa-magic me-1"></i>Generate SQL
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
