{# Sensor Data Section - Real-time sensor monitoring with charts and tables #}

{% if entry.has_sensors %}
<div class="sensor-section">
    <!-- Performance Alert -->
    <div id="performanceAlert" class="alert alert-info d-none mb-3">
        <div class="d-flex align-items-start">
            <i class="fas fa-info-circle me-2 mt-1"></i>
            <div>
                <strong>Performance Tip:</strong> 
                <span id="performanceMessage">Loading large datasets may be slower on mobile devices. Consider using the data limit or time range filters.</span>
            </div>
        </div>
    </div>

    <!-- Section Header with Controls -->
    <div class="sensor-header mb-3">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Sensor Data
            </h5>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadSensorData()" title="Refresh sensor data and charts now">
                    <i class="fas fa-sync me-1"></i><span class="d-none d-md-inline">Refresh</span>
                </button>
                <small class="text-muted">
                    <span id="autoRefreshStatus">Auto-refresh: 60s</span>
                </small>
            </div>
        </div>
    </div>

    <!-- View Toggle Buttons -->
    <div class="btn-group mb-3 w-100 w-md-auto" role="group" aria-label="Data view options">
        <input type="radio" class="btn-check" name="viewOptions" id="chartView" checked>
        <label class="btn btn-outline-primary" for="chartView">
            <i class="fas fa-chart-line me-1"></i>Chart
        </label>
        
        <input type="radio" class="btn-check" name="viewOptions" id="tableView">
        <label class="btn btn-outline-primary" for="tableView">
            <i class="fas fa-table me-1"></i>Table
        </label>
    </div>

    <!-- Chart Container -->
    <div id="sensorChartContainer" class="chart-wrapper">
        <div class="mb-3">
            <canvas id="sensorChart" width="400" height="200"></canvas>
        </div>
        <p class="text-muted text-center" id="loadingChart">Loading chart...</p>
        
        <!-- Chart Controls -->
        <div class="chart-controls mt-3">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label for="chartTypeSelect" class="form-label small">Chart Type</label>
                    <select class="form-select form-select-sm" id="chartTypeSelect">
                        <option value="line">Line Chart</option>
                        <option value="bar">Bar Chart</option>
                        <option value="scatter">Scatter Plot</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label for="sensorTypeFilter" class="form-label small">Sensor Type</label>
                    <select class="form-select form-select-sm" id="sensorTypeFilter">
                        <option value="all">All Sensor Types</option>
                        <!-- Options populated dynamically -->
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label for="timeRangeFilter" class="form-label small">Time Range</label>
                    <select class="form-select form-select-sm" id="timeRangeFilter">
                        <option value="all" selected>All Time</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-12 col-md-4">
                    <label for="dataLimitFilter" class="form-label small">Data Limit</label>
                    <input type="number" class="form-control form-control-sm" id="dataLimitFilter" 
                           placeholder="All data" 
                           min="1" max="10000" 
                           title="Number of most recent data points (1-10000)">
                    <small class="form-text text-muted d-block">Leave empty for all data</small>
                    <small class="form-text text-info d-block d-md-none mt-1">
                        <i class="fas fa-mobile-alt me-1"></i>Auto-limited to 50 on mobile
                    </small>
                </div>
                <div class="col-12 col-md-4">
                    <button type="button" class="btn btn-sm btn-primary w-100 mt-4" onclick="saveChartPreferences()">
                        <i class="fas fa-save me-1"></i>Save Settings
                    </button>
                </div>
                <div class="col-12 col-md-4">
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100 mt-4" onclick="resetChartPreferences()">
                        <i class="fas fa-undo me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Container -->
    <div id="sensorDataContainer" style="display: none;">
        <p class="text-muted text-center" id="loadingSensorData">Loading sensor data...</p>
        <!-- Table will be rendered here -->
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2 flex-wrap mt-3">
        <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#addSensorDataModal">
            <i class="fas fa-plus-circle me-1"></i>Add Reading
        </button>
        <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#addSharedSensorDataModal">
            <i class="fas fa-share-alt me-1"></i>Add Shared Reading
        </button>
        <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#deviceManagementModal" onclick="openDeviceManagement()">
            <i class="fas fa-cogs me-1"></i>Manage Devices
        </button>
    </div>

    <!-- Shared Sensor Info -->
    <div id="sharedSensorInfo" class="mt-3" style="display: none;">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <span id="sharedSensorMessage">Some sensor readings are shared with other entries.</span>
            <button class="btn btn-sm btn-outline-info ms-2" onclick="toggleSharedSensorDetails()">
                <i class="fas fa-eye me-1"></i>Details
            </button>
        </div>
        <div id="sharedSensorDetails" class="mt-2" style="display: none;">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Sensor Type</th>
                            <th>Shared Readings</th>
                            <th>Linked Entries</th>
                        </tr>
                    </thead>
                    <tbody id="sharedSensorDetailsBody">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="text-center py-5 text-muted">
    <i class="fas fa-ban fa-3x mb-3 opacity-50"></i>
    <p class="mb-0">Sensor data not enabled</p>
    <small>This entry type doesn't support sensor data</small>
</div>
{% endif %}

<style>
/* Sensor Section Styles */
.sensor-section {
    width: 100%;
}

.sensor-header h5 {
    color: var(--theme-text, var(--bs-body-color));
    font-weight: 600;
}

.sensor-header i {
    color: var(--theme-primary, var(--bs-primary));
}

/* Chart Wrapper */
.chart-wrapper {
    background: var(--theme-bg-surface, var(--bs-secondary-bg));
    border: 1px solid var(--theme-border, var(--bs-border-color));
    border-radius: 8px;
    padding: 1rem;
}

.chart-wrapper canvas {
    max-height: 400px;
}

/* Chart Controls */
.chart-controls {
    padding-top: 1rem;
    border-top: 1px solid var(--theme-border, var(--bs-border-color));
}

.chart-controls label {
    color: var(--theme-text-muted, var(--bs-secondary));
    font-weight: 500;
}

/* View Toggle Buttons */
.btn-check:checked + .btn-outline-primary {
    background-color: var(--theme-primary, var(--bs-primary));
    border-color: var(--theme-primary, var(--bs-primary));
    color: white;
}

/* Refresh Status */
#autoRefreshStatus {
    font-size: 0.875rem;
    color: var(--theme-success, var(--bs-success));
}

#autoRefreshStatus .fa-spin {
    animation: fa-spin 2s linear infinite;
}

/* Mobile Optimizations */
@media (max-width: 767.98px) {
    .sensor-header {
        text-align: center;
    }
    
    .sensor-header > div {
        width: 100%;
    }
    
    .chart-wrapper canvas {
        max-height: 250px;
    }
    
    .btn-group {
        width: 100%;
    }
    
    .btn-group .btn {
        flex: 1;
    }
}

/* Performance Alert */
#performanceAlert {
    background: var(--theme-info-subtle, var(--bs-info-bg-subtle));
    border-color: var(--theme-info-border, var(--bs-info-border-subtle));
    color: var(--theme-info, var(--bs-info));
}

/* Table Styles */
.table {
    --bs-table-bg: var(--theme-bg-card, var(--bs-body-bg));
    --bs-table-color: var(--theme-text, var(--bs-body-color));
    --bs-table-border-color: var(--theme-border, var(--bs-border-color));
}

.table-hover tbody tr:hover {
    --bs-table-hover-bg: var(--theme-primary-subtle, rgba(13, 110, 253, 0.05));
}

/* Shared Sensor Alert */
#sharedSensorInfo .alert-info {
    background: var(--theme-info-subtle, var(--bs-info-bg-subtle));
    border-color: var(--theme-info-border, var(--bs-info-border-subtle));
    color: var(--theme-info, var(--bs-info));
}
</style>

<!-- Sensor Data JavaScript - Main Functions -->
<script>
// This initialization will be called after sensors.js is loaded
if (typeof window.sensorSectionCallbacks === 'undefined') {
    window.sensorSectionCallbacks = [];
}

window.sensorSectionCallbacks.push(function() {
    console.log('Sensor section callback executing');
    if (document.querySelector('.sensor-section')) {
        // Wait for both DOMContentLoaded and sensors.js to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSensorSection);
        } else {
            initializeSensorSection();
        }
    }
});
</script>
