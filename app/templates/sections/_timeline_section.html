{# Timeline Section - Progress tracking for entries with end dates #}

{% if entry.intended_end_date and entry.show_end_dates %}
<div class="timeline-container">
    <div class="progress-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
        <small class="timeline-date">
            <i class="fas fa-play-circle me-1"></i>
            Started: <strong><span id="progress-start-date">{{ entry.created_at[:10] if entry.created_at else '' }}</span></strong>
        </small>
        <div class="progress-status-badge" id="progressStatusBadge">
            <span id="progressPercentage">0</span>% Complete
        </div>
        <small class="timeline-date">
            <i class="fas fa-flag-checkered me-1"></i>
            Target: <strong><span id="progress-end-date">{{ entry.intended_end_date[:10] if entry.intended_end_date else '' }}</span></strong>
        </small>
    </div>

    <!-- Progress Bar -->
    <div class="progress mb-3" style="height: 16px;">
        <div id="progressBar" 
             class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" 
             style="width: 0%;" 
             aria-valuenow="0" 
             aria-valuemin="0" 
             aria-valuemax="100">
        </div>
    </div>

    <!-- Progress Details -->
    <div class="progress-details">
        <div class="row g-2">
            <div class="col-12 col-md-4">
                <div class="progress-stat">
                    <i class="fas fa-clock"></i>
                    <span id="daysElapsed">0</span> days elapsed
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="progress-stat text-center">
                    <i class="fas fa-calendar-day"></i>
                    <span id="totalDays">0</span> total days
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="progress-stat text-end" id="remainingTime">
                    <i class="fas fa-hourglass-half"></i>
                    <span id="daysRemaining">0</span> days remaining
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Timeline Container */
.timeline-container {
    padding: 1.25rem;
    background: var(--theme-bg-card, var(--bs-body-bg));
    border-radius: 12px;
    border: 1px solid var(--theme-border, var(--bs-border-color));
    box-shadow: var(--shadow-sm);
    transition: var(--transition-base);
}

.timeline-container:hover {
    box-shadow: var(--shadow-md);
}

/* Progress Header */
.progress-header {
    font-size: 0.875rem;
}

.timeline-date {
    color: var(--theme-text-muted, var(--bs-secondary));
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.timeline-date i {
    color: var(--theme-primary, var(--bs-primary));
    font-size: 1rem;
}

.timeline-date strong {
    color: var(--theme-text, var(--bs-body-color));
}

/* Status Badge */
.progress-status-badge {
    background: var(--theme-primary-subtle, rgba(13, 110, 253, 0.1));
    color: var(--theme-primary, var(--bs-primary));
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.95rem;
    border: 1px solid var(--theme-primary-border, rgba(13, 110, 253, 0.2));
    transition: all 0.2s ease;
}

.progress-status-badge.text-complete {
    background: var(--theme-success-subtle, rgba(25, 135, 84, 0.1));
    color: var(--theme-success, var(--bs-success));
    border-color: var(--theme-success-border, rgba(25, 135, 84, 0.2));
}

.progress-status-badge.text-overdue {
    background: var(--theme-danger-subtle, rgba(220, 53, 69, 0.1));
    color: var(--theme-danger, var(--bs-danger));
    border-color: var(--theme-danger-border, rgba(220, 53, 69, 0.2));
}

.progress-status-badge.text-near-deadline {
    background: var(--theme-warning-subtle, rgba(255, 193, 7, 0.1));
    color: var(--theme-warning, var(--bs-warning));
    border-color: var(--theme-warning-border, rgba(255, 193, 7, 0.2));
}

/* Progress Bar Container */
.timeline-container .progress {
    background-color: var(--theme-bg-surface, #e9ecef);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--theme-border, rgba(0,0,0,0.1));
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
}

/* Progress Bar */
.timeline-container .progress-bar {
    background: linear-gradient(90deg, 
        var(--theme-primary, var(--bs-primary)) 0%, 
        var(--theme-primary-hover, var(--bs-primary)) 100%);
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Progress Bar Shine Effect */
.timeline-container .progress-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.3) 50%, 
        transparent 100%);
    animation: progress-shine 2s infinite;
}

@keyframes progress-shine {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Progress Bar States */
.progress-bar.progress-complete {
    background: linear-gradient(90deg, 
        var(--theme-success, var(--bs-success)) 0%, 
        var(--theme-success-hover, var(--theme-success)) 100%);
}

.progress-bar.progress-overdue {
    background: linear-gradient(90deg, 
        var(--theme-danger, var(--bs-danger)) 0%, 
        var(--theme-danger-hover, var(--theme-danger)) 100%);
}

.progress-bar.progress-near-deadline {
    background: linear-gradient(90deg, 
        var(--theme-warning, var(--bs-warning)) 0%, 
        var(--theme-warning-hover, var(--theme-warning)) 100%);
}

/* Progress Details */
.progress-details {
    padding-top: 1rem;
    border-top: 1px solid var(--theme-border, var(--bs-border-color-translucent));
}

.progress-stat {
    color: var(--theme-text-muted, var(--bs-secondary));
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.progress-stat i {
    color: var(--theme-primary, var(--bs-primary));
    font-size: 1rem;
    width: 20px;
    text-align: center;
}

.progress-stat.text-success i {
    color: var(--theme-success, var(--bs-success));
}

.progress-stat.text-danger i {
    color: var(--theme-danger, var(--bs-danger));
}

.progress-stat.text-warning i {
    color: var(--theme-warning, var(--bs-warning));
}

/* Mobile Optimizations */
@media (max-width: 767.98px) {
    .progress-header {
        text-align: center;
    }
    
    .timeline-date {
        justify-content: center;
    }
    
    .progress-status-badge {
        width: 100%;
        text-align: center;
    }
    
    .progress-stat {
        justify-content: center;
    }
    
    .progress-stat.text-end {
        text-align: center;
        justify-content: center;
    }
}
</style>

<script>
// Initialize timeline on page load
document.addEventListener('DOMContentLoaded', function() {
    updateProgressTimeline(
        '{{ entry.created_at }}',
        '{{ entry.intended_end_date }}',
        {{ ('\"' + entry.actual_end_date + '\"') if entry.actual_end_date else 'null' }}
    );
});

function updateProgressTimeline(createdDate, intendedEndDate, actualEndDate = null) {
    const progressBar = document.getElementById('progressBar');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressStatusBadge = document.getElementById('progressStatusBadge');
    const daysElapsed = document.getElementById('daysElapsed');
    const totalDays = document.getElementById('totalDays');
    const daysRemaining = document.getElementById('daysRemaining');
    const remainingTime = document.getElementById('remainingTime');

    if (!progressBar) return;

    try {
        const created = new Date(createdDate);
        const intended = new Date(intendedEndDate);
        const now = new Date();
        const actual = actualEndDate ? new Date(actualEndDate) : null;

        // Calculate total project duration
        const totalMs = intended.getTime() - created.getTime();
        const totalDaysNum = Math.ceil(totalMs / (1000 * 60 * 60 * 24));

        // Calculate elapsed time
        const referenceDate = actual || now;
        const elapsedMs = referenceDate.getTime() - created.getTime();
        const elapsedDaysNum = Math.floor(elapsedMs / (1000 * 60 * 60 * 24));

        // Calculate progress percentage
        let progressPercent = Math.min(Math.max((elapsedMs / totalMs) * 100, 0), 100);
        
        // Calculate remaining days
        const remainingMs = intended.getTime() - now.getTime();
        const remainingDaysNum = Math.ceil(remainingMs / (1000 * 60 * 60 * 24));

        // Update display values
        if (daysElapsed) daysElapsed.textContent = Math.max(0, elapsedDaysNum);
        if (totalDays) totalDays.textContent = Math.max(1, totalDaysNum);
        if (daysRemaining) daysRemaining.textContent = Math.max(0, remainingDaysNum);

        // Determine status and styling
        let statusClass = '';
        let statusText = '';
        let barClass = '';

        if (actual) {
            // Project is completed
            progressPercent = 100;
            statusClass = 'text-complete';
            barClass = 'progress-complete';
            statusText = 'Completed';
            if (remainingTime) {
                remainingTime.innerHTML = '<i class="fas fa-check-circle"></i>Completed';
                remainingTime.className = 'progress-stat text-success text-end';
            }
        } else if (remainingDaysNum < 0) {
            // Project is overdue
            statusClass = 'text-overdue';
            barClass = 'progress-overdue';
            statusText = `${Math.round(progressPercent)}% - Overdue`;
            if (remainingTime) {
                remainingTime.innerHTML = `<i class="fas fa-exclamation-triangle"></i>${Math.abs(remainingDaysNum)} day${Math.abs(remainingDaysNum) !== 1 ? 's' : ''} overdue`;
                remainingTime.className = 'progress-stat text-danger text-end';
            }
        } else if (remainingDaysNum <= 3) {
            // Approaching deadline
            statusClass = 'text-near-deadline';
            barClass = 'progress-near-deadline';
            statusText = `${Math.round(progressPercent)}% - Due Soon`;
            if (remainingTime) {
                remainingTime.innerHTML = `<i class="fas fa-hourglass-half"></i>${remainingDaysNum} day${remainingDaysNum !== 1 ? 's' : ''} remaining`;
                remainingTime.className = 'progress-stat text-warning text-end';
            }
        } else {
            // Normal progress
            statusText = `${Math.round(progressPercent)}% Complete`;
            if (remainingTime) {
                remainingTime.innerHTML = `<i class="fas fa-hourglass-half"></i>${remainingDaysNum} day${remainingDaysNum !== 1 ? 's' : ''} remaining`;
                remainingTime.className = 'progress-stat text-end';
            }
        }

        // Update progress bar
        progressBar.style.width = `${Math.round(progressPercent)}%`;
        progressBar.setAttribute('aria-valuenow', Math.round(progressPercent));
        progressBar.className = `progress-bar progress-bar-striped ${actual ? '' : 'progress-bar-animated'} ${barClass}`;

        // Update percentage and status badge
        if (progressPercentage) {
            progressPercentage.textContent = Math.round(progressPercent);
        }
        if (progressStatusBadge) {
            progressStatusBadge.innerHTML = `<span id="progressPercentage">${Math.round(progressPercent)}</span>% ${statusText.includes('Complete') ? 'Complete' : statusText.split(' - ')[1] || 'Complete'}`;
            progressStatusBadge.className = `progress-status-badge ${statusClass}`;
        }

    } catch (error) {
        console.error('Error calculating progress:', error);
    }
}
</script>

{% else %}
<div class="text-center py-5 text-muted">
    <i class="fas fa-calendar-times fa-3x mb-3 opacity-50"></i>
    <p class="mb-0">No timeline available</p>
    <small>Set an intended end date to track progress</small>
</div>
{% endif %}
