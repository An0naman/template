{# AI Assistant Section - Chat interface with description preview capability #}

<script>
// Define functions in global scope before any inline handlers can call them
var chatHistory = [];
var currentDraft = null;
var activeConversationMode = false;
var currentAction = null;

function quickPrompt(prompt) {
    document.getElementById('chatInput').value = prompt;
    sendChatMessage();
}

function selectAction(action, prompt, displayName, iconName) {
    currentAction = action;
    activeConversationMode = true;
    
    // Update button to show selected action
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    
    buttonText.innerHTML = `<i class="fas fa-${iconName} me-1"></i>${displayName}`;
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-info');
    
    // Set the prompt in the input
    document.getElementById('chatInput').value = prompt;
    document.getElementById('chatInput').focus();
}

function quickAction(action, prompt) {
    currentAction = action;
    activeConversationMode = true;
    document.getElementById('chatInput').value = prompt;
    sendChatMessage();
}

function updateDraft() {
    // Allows user to refine the current draft
    const input = document.getElementById('chatInput');
    input.placeholder = "Tell me how to revise this draft...";
    input.focus();
}

function resetActionButton() {
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    
    buttonText.textContent = 'Quick Actions';
    button.classList.remove('btn-info');
    button.classList.add('btn-outline-secondary');
}

// Planning Mode Functions
var currentPlan = null;
var planningMode = false;

async function enterPlanningMode() {
    planningMode = true;
    currentAction = null;
    
    // Update button
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    buttonText.innerHTML = '<i class="fas fa-calendar-check me-1"></i>Planning Mode';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-info');
    
    // Clear chat and show welcome message
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    addMessageToChat('assistant', `üéØ Planning Mode activated! 

I'll help you create a milestone plan for this entry. I can:
- Analyze your entry context and historical data
- Research typical timelines for your project type
- Suggest realistic milestone dates
- Adjust the plan based on your feedback

What would you like to plan?`);
    
    document.getElementById('chatInput').placeholder = "E.g., 'Help me plan this fermentation' or 'Create a timeline for this project'";
    document.getElementById('chatInput').focus();
}

async function generatePlan(userPrompt) {
    const loadingId = addMessageToChat('assistant', 'Analyzing entry context and generating plan...', true);
    
    try {
        const response = await fetch(`/api/entries/{{ entry.id }}/generate_plan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: userPrompt })
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (data.success) {
            currentPlan = data.plan;
            
            // Add context summary
            addMessageToChat('assistant', `üìä ${data.context_summary}

I've created a proposed plan. You can review it in the preview area below and either apply it or discuss changes.`);
            
            // Render the plan in preview area
            renderPlanCard(data.plan);
            
        } else {
            addMessageToChat('assistant', `‚ùå Error: ${data.error || 'Failed to generate plan'}`);
        }
    } catch (error) {
        console.error('Plan generation error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Failed to generate plan. Please try again.');
    }
}

function renderPlanCard(plan) {
    // Show plan in the preview area instead of in chat
    const previewContainer = document.getElementById('planPreview');
    const previewContent = document.getElementById('planPreviewContent');
    
    let milestoneHTML = '';
    plan.milestones.forEach((milestone, index) => {
        const statusIcon = index === 0 ? '‚úì' : '‚Üí';
        const statusColor = milestone.state_color || '#6c757d';
        
        milestoneHTML += `
            <div class="milestone-step mb-3" data-milestone-index="${index}">
                <div class="d-flex align-items-start">
                    <span class="badge rounded-pill me-2" style="background-color: ${statusColor};">${statusIcon}</span>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <strong>${milestone.target_date}</strong>
                            ${milestone.duration_days ? `<span class="badge bg-info">${milestone.duration_days} days</span>` : ''}
                        </div>
                        <div class="fw-bold">${milestone.status_name}</div>
                        ${milestone.notes ? `<small class="text-muted">${milestone.notes}</small>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    previewContent.innerHTML = `
        <div class="mb-3">
            <h5 class="mb-1">${plan.title || 'Proposed Milestone Plan'}</h5>
            <small class="text-muted">Total Duration: ${plan.duration_total_days} days</small>
        </div>
        ${plan.reasoning ? `<div class="alert alert-info mb-3"><small><strong>Reasoning:</strong> ${plan.reasoning}</small></div>` : ''}
        <div class="plan-timeline">
            ${milestoneHTML}
        </div>
    `;
    
    // Show the preview container
    previewContainer.classList.remove('d-none');
}

async function applyPlanPreview() {
    if (!currentPlan) {
        addMessageToChat('assistant', '‚ùå No plan to apply');
        return;
    }
    
    const loadingId = addMessageToChat('assistant', 'Creating milestones...', true);
    
    try {
        const response = await fetch(`/api/entries/{{ entry.id }}/apply_plan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan: currentPlan })
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (data.success) {
            addMessageToChat('assistant', `‚úÖ ${data.message}

The milestones are now visible in the Progress & Status section below. I'll continue to monitor your progress!`);
            
            // Close the preview
            closePlanPreview();
            
            // Refresh timeline section if it exists
            if (window.timelineModule && typeof window.timelineModule.refresh === 'function') {
                window.timelineModule.refresh();
            }
            
            currentPlan = null;
        } else {
            addMessageToChat('assistant', `‚ùå Error: ${data.error || 'Failed to apply plan'}`);
        }
    } catch (error) {
        console.error('Apply plan error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Failed to apply plan. Please try again.');
    }
}

function closePlanPreview() {
    const previewContainer = document.getElementById('planPreview');
    previewContainer.classList.add('d-none');
}

function refinePlanPreview() {
    addMessageToChat('assistant', `Sure! Tell me what you'd like to change:

- Move a milestone date?
- Add or remove a step?
- Adjust the timeline?

Just describe what you want, and I'll update the plan.`);
    
    document.getElementById('chatInput').placeholder = "E.g., 'Move bottling to day 15' or 'Add dry hopping step'";
    document.getElementById('chatInput').focus();
}

function exitPlanningMode() {
    planningMode = false;
    currentPlan = null;
    
    // Remove plan card if present
    const planCard = document.getElementById('current-plan-card');
    if (planCard) planCard.remove();
    
    resetActionButton();
    addMessageToChat('assistant', 'Planning mode exited. How else can I help?');
    document.getElementById('chatInput').placeholder = "Ask AI or request description changes...";
}

// Note Composer Mode Functions
var noteComposerMode = false;
var currentNoteProposal = null;
var noteAttachments = [];

async function enterNoteComposerMode() {
    noteComposerMode = true;
    currentAction = null;
    
    // Update button
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    buttonText.innerHTML = '<i class="fas fa-file-alt me-1"></i>Compose Note';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-info');
    
    // Clear chat and show welcome message
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    addMessageToChat('assistant', `üìù Note Composer activated!

I'll help you create a well-structured note for this entry. I can:
- Choose the appropriate note type
- Suggest a clear title
- Draft comprehensive content
- Add Wikipedia links for reference (when relevant)
- Include any URLs you provide
- **Link to related entries across your app** üîó
- Interpret any files you want to attach

What kind of note would you like to create? You can:
- Describe the purpose (e.g., "Document today's progress")
- Specify a note type (e.g., "Create a Technical note about...")
- Share context or observations
- Request Wikipedia links (e.g., "Add a wiki link for this ingredient")
- Provide specific URLs to include (e.g., "Add a link to https://example.com")
- Mention related entries to link them (e.g., "Reference my flour and sugar entries")
- Upload files for me to interpret

üí° **Tips**: 
- I can suggest Wikipedia links automatically, but for other websites, please provide the actual URLs!
- I'll actively look for opportunities to link this note with related entries in your workspace!

You can also upload files at any time using the attachment button below!`);
    
    document.getElementById('chatInput').placeholder = "Describe what you want in this note...";
    document.getElementById('chatInput').focus();
    
    // Show attachment upload UI if not already visible
    showAttachmentUploadUI();
}

function showAttachmentUploadUI() {
    // Check if upload UI already exists
    if (document.getElementById('noteAttachmentUploadUI')) return;
    
    const chatContainer = document.getElementById('aiChatContainer');
    const chatInput = chatContainer.querySelector('.chat-input');
    
    const uploadUI = document.createElement('div');
    uploadUI.id = 'noteAttachmentUploadUI';
    uploadUI.className = 'attachment-upload-ui mb-2';
    uploadUI.innerHTML = `
        <div class="d-flex align-items-center gap-2">
            <label class="btn btn-sm btn-outline-secondary mb-0" for="noteAttachmentInput">
                <i class="fas fa-paperclip me-1"></i>Attach Files
            </label>
            <input type="file" id="noteAttachmentInput" multiple class="d-none" onchange="handleNoteAttachments(this)">
            <div id="noteAttachmentsList" class="flex-grow-1 small text-muted">
                No files attached
            </div>
        </div>
    `;
    
    chatInput.parentNode.insertBefore(uploadUI, chatInput);
}

function hideAttachmentUploadUI() {
    const uploadUI = document.getElementById('noteAttachmentUploadUI');
    if (uploadUI) uploadUI.remove();
    noteAttachments = [];
}

async function handleNoteAttachments(input) {
    const files = Array.from(input.files);
    
    if (files.length === 0) return;
    
    // Add files to attachments array
    for (const file of files) {
        noteAttachments.push(file);
        
        // Try to read text preview for certain file types
        if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.txt')) {
            try {
                const preview = await readFilePreview(file);
                addMessageToChat('assistant', `üìé I've received "${file.name}". I'll consider this when composing the note.`);
            } catch (e) {
                console.error('Error reading file preview:', e);
            }
        } else {
            addMessageToChat('assistant', `üìé I've received "${file.name}" (${formatFileSize(file.size)}). This will be attached to the note.`);
        }
    }
    
    updateAttachmentsList();
}

function readFilePreview(file, maxLength = 500) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            let text = e.target.result;
            if (text.length > maxLength) {
                text = text.substring(0, maxLength) + '...';
            }
            resolve(text);
        };
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function updateAttachmentsList() {
    const listElement = document.getElementById('noteAttachmentsList');
    if (!listElement) return;
    
    if (noteAttachments.length === 0) {
        listElement.innerHTML = 'No files attached';
        listElement.className = 'flex-grow-1 small text-muted';
    } else {
        listElement.innerHTML = noteAttachments.map((file, index) => 
            `<span class="badge bg-secondary me-1">
                ${file.name}
                <i class="fas fa-times ms-1" style="cursor: pointer;" onclick="removeNoteAttachment(${index})"></i>
            </span>`
        ).join('');
        listElement.className = 'flex-grow-1 small';
    }
}

function removeNoteAttachment(index) {
    noteAttachments.splice(index, 1);
    updateAttachmentsList();
    addMessageToChat('assistant', 'Attachment removed.');
}

async function composeNote(userPrompt) {
    const loadingId = addMessageToChat('assistant', 'Analyzing context and composing note...', true);
    
    try {
        // Prepare attachment file info for AI
        const attachmentFiles = [];
        for (const file of noteAttachments) {
            const fileInfo = {
                filename: file.name,
                type: file.type || 'unknown',
                size: file.size
            };
            
            // Add preview for text files
            if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.txt')) {
                try {
                    fileInfo.preview = await readFilePreview(file);
                } catch (e) {
                    console.error('Error reading file preview:', e);
                }
            }
            
            // Add base64 data for images so AI can analyze them
            if (file.type.startsWith('image/')) {
                try {
                    const reader = new FileReader();
                    const base64Promise = new Promise((resolve, reject) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    fileInfo.data = await base64Promise;
                } catch (e) {
                    console.error('Error reading image data:', e);
                }
            }
            
            attachmentFiles.push(fileInfo);
        }
        
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: userPrompt,
                entry_id: {{ entry.id }},
                action: 'compose_note',
                note_context: currentNoteProposal ? { current_draft: currentNoteProposal } : {},
                attachment_files: attachmentFiles,
                chat_history: chatHistory  // Include conversation history
            })
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (data.note_preview) {
            currentNoteProposal = data.note_preview;
            
            const aiMessage = data.message || "I've composed a note for you. Review it below and you can continue chatting to refine it, or click Apply Note when ready.";
            
            // Add to chat history
            chatHistory.push({
                role: 'user',
                content: userPrompt
            });
            chatHistory.push({
                role: 'assistant',
                content: aiMessage
            });
            
            // Show reasoning message
            addMessageToChat('assistant', aiMessage);
            
            // Render the note preview
            renderNotePreview(data.note_preview);
            
        } else if (data.error) {
            // Handle special case where AI detects this is a question, not a note request
            const errorMessage = data.error;
            chatHistory.push({
                role: 'user',
                content: userPrompt
            });
            chatHistory.push({
                role: 'assistant',
                content: errorMessage
            });
            addMessageToChat('assistant', errorMessage);
        } else if (data.message) {
            const aiMessage = data.message;
            chatHistory.push({
                role: 'user',
                content: userPrompt
            });
            chatHistory.push({
                role: 'assistant',
                content: aiMessage
            });
            addMessageToChat('assistant', aiMessage);
        } else {
            addMessageToChat('assistant', `‚ùå Error: Failed to compose note. Please try again.`);
        }
    } catch (error) {
        console.error('Note composition error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Failed to compose note. Please try again.');
    }
}

async function fetchAssociatedEntryNames(entryIds) {
    try {
        // Fetch each entry's details
        const entryPromises = entryIds.map(id => 
            fetch(`/api/entries/${id}`).then(r => r.json())
        );
        
        const entries = await Promise.all(entryPromises);
        
        // Build HTML for entry list
        const entryListHTML = entries.map(entry => {
            if (entry.error) {
                return `<div class="text-muted small">‚Ä¢ Entry ID ${entry.id || 'unknown'} (not found)</div>`;
            }
            return `
                <div class="small">
                    ‚Ä¢ <strong>${entry.title}</strong> 
                    <span class="text-muted">(${entry.entry_type?.singular_label || 'Entry'})</span>
                </div>
            `;
        }).join('');
        
        // Update the preview container
        const previewContainer = document.getElementById('associatedEntriesPreview');
        if (previewContainer) {
            previewContainer.innerHTML = entryListHTML;
        }
    } catch (error) {
        console.error('Error fetching entry names:', error);
        const previewContainer = document.getElementById('associatedEntriesPreview');
        if (previewContainer) {
            previewContainer.innerHTML = '<small class="text-danger">Error loading entry names</small>';
        }
    }
}

function renderNotePreview(noteProposal) {
    const previewContainer = document.getElementById('notePreview');
    const previewContent = document.getElementById('notePreviewContent');
    
    let bookmarksHTML = '';
    if (noteProposal.url_bookmarks && noteProposal.url_bookmarks.length > 0) {
        bookmarksHTML = `
            <div class="mt-3">
                <strong>üîó Links:</strong>
                <ul class="list-unstyled ms-3 mt-1">
                    ${noteProposal.url_bookmarks.map(bookmark => 
                        `<li><a href="${bookmark.url}" target="_blank">${bookmark.friendly_name || bookmark.url}</a></li>`
                    ).join('')}
                </ul>
            </div>
        `;
    }
    
    let associationsHTML = '';
    if (noteProposal.associated_entry_ids && noteProposal.associated_entry_ids.length > 0) {
        associationsHTML = `
            <div class="mt-3">
                <strong>üîó Associated Entries:</strong>
                <div class="ms-3 mt-1" id="associatedEntriesPreview">
                    <small class="text-muted">Loading entry names...</small>
                </div>
            </div>
        `;
        
        // Fetch entry details asynchronously
        fetchAssociatedEntryNames(noteProposal.associated_entry_ids);
    }
    
    let attachmentsHTML = '';
    if (noteAttachments.length > 0) {
        attachmentsHTML = `
            <div class="mt-3">
                <strong>üìé Attachments:</strong>
                <ul class="list-unstyled ms-3 mt-1">
                    ${noteAttachments.map(file => 
                        `<li><i class="fas fa-file me-1"></i>${file.name} (${formatFileSize(file.size)})</li>`
                    ).join('')}
                </ul>
            </div>
        `;
    }
    
    // Format note text: convert markdown to HTML and preserve line breaks
    let formattedContent = noteProposal.note_text || 'No content';
    
    // Remove ** markdown bold formatting
    formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert markdown headers
    formattedContent = formattedContent.replace(/^### (.*?)$/gm, '<h6>$1</h6>');
    formattedContent = formattedContent.replace(/^## (.*?)$/gm, '<h5>$1</h5>');
    formattedContent = formattedContent.replace(/^# (.*?)$/gm, '<h4>$1</h4>');
    
    // Convert bullet points (- or *)
    formattedContent = formattedContent.replace(/^[\-\*] (.*?)$/gm, '<li>$1</li>');
    formattedContent = formattedContent.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    
    // Convert line breaks to <br> tags (but not inside HTML tags)
    formattedContent = formattedContent.replace(/\n/g, '<br>');
    
    previewContent.innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <small class="text-muted d-block mb-1"><i class="fas fa-pencil-alt"></i> Click to edit</small>
                    <h5 class="mb-1 editable-title" contenteditable="true" 
                        data-field="note_title"
                        style="border: 1px dashed transparent; padding: 4px; border-radius: 4px;"
                        onfocus="this.style.borderColor='#0d6efd'; this.style.backgroundColor='#fff';"
                        onblur="this.style.borderColor='transparent'; this.style.backgroundColor='transparent'; updateNoteField('note_title', this.textContent);"
                    >${noteProposal.note_title || 'Untitled Note'}</h5>
                    <span class="badge bg-info">${noteProposal.note_type || 'General'}</span>
                </div>
            </div>
        </div>
        <div class="note-content mb-3">
            <strong>Content:</strong>
            <div class="mt-2 p-2 border rounded bg-light editable-content" contenteditable="true"
                data-field="note_text"
                style="white-space: normal; min-height: 100px; border: 1px dashed transparent !important;"
                onfocus="this.style.borderColor='#0d6efd'; this.style.backgroundColor='#fff';"
                onblur="this.style.borderColor='transparent'; this.style.backgroundColor='#f8f9fa'; updateNoteField('note_text', this.innerHTML);"
            >${formattedContent}</div>
        </div>
        ${bookmarksHTML}
        ${associationsHTML}
        ${attachmentsHTML}
    `;
    
    previewContainer.classList.remove('d-none');
}

function updateNoteField(field, value) {
    if (!currentNoteProposal) return;
    
    if (field === 'note_title') {
        currentNoteProposal.note_title = value.trim();
    } else if (field === 'note_text') {
        // Convert HTML back to a more readable format for storage
        // Keep the HTML formatting since it will be converted when saved
        currentNoteProposal.note_text = value
            .replace(/<br\s*\/?>/gi, '\n')  // Convert <br> back to newlines
            .replace(/<\/p>/gi, '\n\n')      // Paragraph breaks
            .replace(/<p>/gi, '')
            .replace(/<strong>(.*?)<\/strong>/gi, '**$1**')  // Bold back to markdown
            .replace(/<h6>(.*?)<\/h6>/gi, '### $1\n')        // Headers back to markdown
            .replace(/<h5>(.*?)<\/h5>/gi, '## $1\n')
            .replace(/<h4>(.*?)<\/h4>/gi, '# $1\n')
            .replace(/<\/?ul>/gi, '')                        // Remove ul tags
            .replace(/<li>(.*?)<\/li>/gi, '- $1\n')          // List items back to markdown
            .replace(/<[^>]+>/g, '')                         // Remove any other HTML tags
            .trim();
    }
}


async function applyNotePreview() {
    if (!currentNoteProposal) {
        addMessageToChat('assistant', '‚ùå No note to apply');
        return;
    }
    
    const loadingId = addMessageToChat('assistant', 'Creating note...', true);
    
    try {
        // Prepare form data for note creation
        const formData = new FormData();
        formData.append('note_title', currentNoteProposal.note_title || '');
        formData.append('note_text', currentNoteProposal.note_text || '');
        formData.append('note_type', currentNoteProposal.note_type || 'General');
        
        // Add URL bookmarks as JSON
        if (currentNoteProposal.url_bookmarks && currentNoteProposal.url_bookmarks.length > 0) {
            formData.append('url_bookmarks', JSON.stringify(currentNoteProposal.url_bookmarks));
        }
        
        // Add associated entry IDs as JSON
        if (currentNoteProposal.associated_entry_ids && currentNoteProposal.associated_entry_ids.length > 0) {
            formData.append('associated_entry_ids', JSON.stringify(currentNoteProposal.associated_entry_ids));
        }
        
        // Add file attachments
        for (const file of noteAttachments) {
            formData.append('files', file);
        }
        
        const response = await fetch(`/api/entries/{{ entry.id }}/notes`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (response.ok && data.success) {
            addMessageToChat('assistant', `‚úÖ Note created successfully!

The note has been added to this entry. You can find it in the Notes section below. Would you like to create another note?`);
            
            // Close the preview
            closeNotePreview();
            
            // Refresh notes section if it exists
            if (typeof fetchNotes === 'function') {
                fetchNotes();
            }
            
            // Clear attachments and proposal
            currentNoteProposal = null;
            noteAttachments = [];
            updateAttachmentsList();
            
        } else {
            addMessageToChat('assistant', `‚ùå Error: ${data.error || 'Failed to create note'}`);
        }
    } catch (error) {
        console.error('Apply note error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Failed to create note. Please try again.');
    }
}

function closeNotePreview() {
    const previewContainer = document.getElementById('notePreview');
    previewContainer.classList.add('d-none');
}

function exitNoteComposerMode() {
    noteComposerMode = false;
    currentNoteProposal = null;
    noteAttachments = [];
    
    // Remove note preview if present
    closeNotePreview();
    
    // Hide attachment UI
    hideAttachmentUploadUI();
    
    resetActionButton();
    addMessageToChat('assistant', 'Note composer exited. How else can I help?');
    document.getElementById('chatInput').placeholder = "Ask AI or request description changes...";
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addMessageToChat('user', message);
    const actionToSend = currentAction;
    currentAction = null;
    input.value = '';
    input.placeholder = "Continue the conversation or start a new request...";
    
    // Check if in planning mode
    if (planningMode && !actionToSend) {
        // Check if user is asking for a new plan or refining existing one
        if (!currentPlan || message.toLowerCase().includes('new plan') || message.toLowerCase().includes('start over')) {
            await generatePlan(message);
        } else {
            // Refining existing plan - regenerate with refinement prompt
            await generatePlan(`Based on the previous plan, ${message}`);
        }
        return;
    }
    
    // Check if in note composer mode
    if (noteComposerMode && !actionToSend) {
        // Check if user is asking for a new note or refining existing one
        if (!currentNoteProposal || message.toLowerCase().includes('new note') || message.toLowerCase().includes('start over')) {
            await composeNote(message);
        } else {
            // Refining existing note - compose with refinement prompt
            await composeNote(`Based on the previous note proposal, ${message}`);
        }
        return;
    }
    
    const loadingId = addMessageToChat('assistant', 'Thinking...', true);
    
    try {
        let response, data;
        
        // If action is set (description generation/improvement), use /api/ai/chat
        // Otherwise use /api/ai/entry-chat for full context conversation
        if (actionToSend || (activeConversationMode && currentDraft)) {
            const payload = {
                message: message,
                entry_id: {{ entry.id }},
                entry_title: {{ entry.title|tojson }},
                entry_description: {{ (entry.description or '')|tojson }},
                chat_history: chatHistory
            };
            
            if (actionToSend) {
                payload.action = actionToSend;
            } else if (activeConversationMode && currentDraft) {
                payload.action = 'refine_draft';
                payload.current_draft = currentDraft;
            }
            
            response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            data = await response.json();
        } else {
            // General conversation with full entry context
            response = await fetch('/api/ai/entry-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    entry_id: {{ entry.id }},
                    message: message,
                    is_first_message: chatHistory.length === 0,
                    include_all_notes: false // Can be toggled later
                })
            });
            
            const entryData = await response.json();
            data = {
                message: entryData.success ? entryData.response : (entryData.error || 'Failed to get response')
            };
        }
        
        document.getElementById(loadingId).remove();
        
        if (response.ok) {
            const aiMessage = data.message || data.response || 'No response';
            addMessageToChat('assistant', aiMessage);
            
            // Reset action button to default
            resetActionButton();
            
            if (data.description_preview) {
                currentDraft = data.description_preview;
                showDescriptionPreview(data.description_preview);
            }
            
            chatHistory.push({
                role: 'user',
                content: message
            });
            chatHistory.push({
                role: 'assistant',
                content: aiMessage
            });
        } else {
            addMessageToChat('assistant', 'Error: ' + (data.error || 'Failed to get response'));
            activeConversationMode = false;
        }
    } catch (error) {
        console.error('Chat error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', 'Error: Failed to communicate with AI');
        activeConversationMode = false;
    }
}

function addMessageToChat(role, content, isLoading = false) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageId = 'msg-' + Date.now();
    
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.className = 'chat-message ' + role + (isLoading ? ' loading' : '');
    
    const icon = role === 'user' ? 'fa-user' : 'fa-robot';
    const label = role === 'user' ? 'You' : 'AI Assistant';
    
    messageDiv.innerHTML = `
        <div class="message-header">
            <span><i class="fas ${icon} me-2"></i>${label}</span>
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        </div>
        <div class="message-content">${content}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
}

function showDescriptionPreview(description) {
    const previewContainer = document.getElementById('descriptionPreview');
    const previewContent = document.getElementById('previewContent');
    
    previewContent.textContent = description;
    // Render as markdown
    if (typeof renderMarkdown === 'function') {
        renderMarkdown(previewContent);
    }
    previewContainer.classList.remove('d-none');
    previewContainer.dataset.previewText = description;
}

function applyDescriptionPreview() {
    const previewContainer = document.getElementById('descriptionPreview');
    const previewText = previewContainer.dataset.previewText;
    
    if (previewText) {
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        if (descriptionDisplay) {
            descriptionDisplay.textContent = previewText;
            // Immediately render as markdown
            if (typeof renderMarkdown === 'function') {
                renderMarkdown(descriptionDisplay);
            }
        }
        
        const descriptionTextarea = document.getElementById('descriptionTextarea');
        if (descriptionTextarea) {
            descriptionTextarea.value = previewText;
        }
        
        saveDescriptionUpdate(previewText);
        previewContainer.classList.add('d-none');
        addMessageToChat('assistant', 'Description updated successfully!');
        
        // Exit conversation mode
        activeConversationMode = false;
        currentDraft = null;
        document.getElementById('chatInput').placeholder = "Ask AI or request description changes...";
    }
}

async function saveDescriptionUpdate(description) {
    try {
        const response = await fetch(`/api/entries/{{ entry.id }}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description
            })
        });
        
        if (!response.ok) {
            console.error('Failed to save description update');
        }
    } catch (error) {
        console.error('Error saving description:', error);
    }
}
</script>

<div class="chat-container" id="aiChatContainer">
    <!-- Chat Messages -->
    <div class="chat-messages mb-3" id="chatMessages" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--theme-border, var(--bs-border-color)); border-radius: 8px; padding: 1rem; background: var(--theme-bg-surface, var(--bs-body-bg));">
        <div class="text-center text-muted py-4">
            <i class="fas fa-robot fa-2x mb-2"></i>
            <p>Ask me anything about this entry or request description improvements!</p>
        </div>
    </div>
    
    <!-- Description Preview Area (Hidden by default) -->
    <div class="description-preview d-none mb-3" id="descriptionPreview">
        <div class="card border-info">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-eye me-2"></i>Current Draft</span>
                <div>
                    <button class="btn btn-sm btn-light me-2" onclick="updateDraft()">
                        <i class="fas fa-sync me-1"></i>Revise
                    </button>
                    <button class="btn btn-sm btn-success" onclick="applyDescriptionPreview()">
                        <i class="fas fa-check me-1"></i>Apply to Entry
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="previewContent" class="markdown-content"></div>
            </div>
        </div>
    </div>
    
    <!-- Plan Preview Area (Hidden by default) -->
    <div class="plan-preview d-none mb-3" id="planPreview">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-calendar-check me-2"></i>Proposed Plan</span>
                <div>
                    <button class="btn btn-sm btn-light me-2" onclick="refinePlanPreview()">
                        <i class="fas fa-comments me-1"></i>Discuss Changes
                    </button>
                    <button class="btn btn-sm btn-success" onclick="applyPlanPreview()">
                        <i class="fas fa-check me-1"></i>Apply to Entry
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="closePlanPreview()">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="planPreviewContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Note Preview Area (Hidden by default) -->
    <div class="note-preview d-none mb-3" id="notePreview">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-alt me-2"></i>Proposed Note</span>
                <div>
                    <button class="btn btn-sm btn-success" onclick="applyNotePreview()">
                        <i class="fas fa-check me-1"></i>Apply Note
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="closeNotePreview()">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="notePreviewContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Chat Input -->
    <div class="chat-input">
        <div class="input-group">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="aiActionButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-magic me-1"></i><span id="selectedActionText">Quick Actions</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="selectAction('generate_description', 'Generate a description for this entry', 'Generate', 'robot'); return false;">
                    <i class="fas fa-robot me-2"></i>Generate Description
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="selectAction('improve_description', 'Improve the description', 'Improve', 'lightbulb'); return false;">
                    <i class="fas fa-lightbulb me-2"></i>Improve Description
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="enterNoteComposerMode(); return false;">
                    <i class="fas fa-file-alt me-2"></i>Compose Note
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Planning Mode: show_end_dates={{ entry.show_end_dates }}, intended_end_date={{ entry.intended_end_date }} -->
                {% if entry.show_end_dates and entry.intended_end_date %}
                <li><a class="dropdown-item" href="#" onclick="enterPlanningMode(); return false;">
                    <i class="fas fa-calendar-check me-2"></i>Plan Milestones
                </a></li>
                <li><hr class="dropdown-divider"></li>
                {% else %}
                <!-- Planning mode hidden: show_end_dates={{ entry.show_end_dates }}, intended_end_date={{ entry.intended_end_date }} -->
                {% endif %}
                <li><a class="dropdown-item" href="#" onclick="selectAction('wikipedia', 'Provide Wikipedia-style information', 'Wikipedia', 'wikipedia-w'); return false;">
                    <i class="fab fa-wikipedia-w me-2"></i>Wikipedia Style
                </a></li>
            </ul>
            <input type="text" class="form-control" id="chatInput" placeholder="Ask AI or request description changes..." onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button class="btn btn-primary" onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<style>
.chat-message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    animation: fadeIn 0.3s ease;
}

.chat-message.user {
    background: var(--bs-primary-bg-subtle);
    border-left: 3px solid var(--bs-primary);
}

.chat-message.assistant {
    background: var(--bs-secondary-bg-subtle);
    border-left: 3px solid var(--bs-secondary);
}

.chat-message .message-header {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-message .message-content {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.chat-message.loading .message-content::after {
    content: '...';
    animation: dots 1.5s steps(4, end) infinite;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* Planning Mode Styles */
.plan-card {
    animation: fadeIn 0.5s ease;
    margin: 1rem 0;
}

.plan-card .card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.milestone-step {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    background: var(--bs-light);
    transition: all 0.2s ease;
}

.milestone-step:hover {
    background: var(--bs-secondary-bg-subtle);
    transform: translateX(4px);
}

.milestone-step .badge {
    min-width: 24px;
    height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.plan-timeline {
    max-height: 400px;
    overflow-y: auto;
}
</style>

