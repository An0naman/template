{# AI Assistant Section - Chat interface with description preview capability #}

<script>
// Define functions in global scope before any inline handlers can call them
var chatHistory = [];
var currentDraft = null;
var activeConversationMode = false;
var currentAction = null;
var debugMode = false;

// Section configuration (includes custom AI prompts)
{% if section_config is defined %}
var aiSectionConfig = {{ section_config|tojson|safe }};
{% else %}
var aiSectionConfig = {};
{% endif %}

function toggleDebugMode() {
    debugMode = document.getElementById('debugModeToggle').checked;
    console.log('[AI Assistant] Debug mode:', debugMode ? 'enabled' : 'disabled');
    
    // Toggle visibility of all existing debug sections
    document.querySelectorAll('.debug-reasoning').forEach(el => {
        el.style.display = debugMode ? 'block' : 'none';
    });
}

function quickPrompt(prompt) {
    document.getElementById('chatInput').value = prompt;
    sendChatMessage();
}

function selectAction(action, prompt, displayName, iconName) {
    currentAction = action;
    activeConversationMode = true;
    
    // Update button to show selected action
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    
    buttonText.innerHTML = `<i class="fas fa-${iconName} me-1"></i>${displayName}`;
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-info');
    
    // Set the prompt in the input
    document.getElementById('chatInput').value = prompt;
    document.getElementById('chatInput').focus();
}

function quickAction(action, prompt) {
    currentAction = action;
    activeConversationMode = true;
    document.getElementById('chatInput').value = prompt;
    sendChatMessage();
}

function updateDraft() {
    // Allows user to refine the current draft
    const input = document.getElementById('chatInput');
    input.placeholder = "Tell me how to revise this draft...";
    input.focus();
}

function resetActionButton() {
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    
    buttonText.textContent = 'Quick Actions';
    button.classList.remove('btn-info');
    button.classList.add('btn-outline-secondary');
}

// Planning Mode Functions
var currentPlan = null;
var planningMode = false;

async function enterPlanningMode() {
    planningMode = true;
    currentAction = null;
    
    // Update button
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    buttonText.innerHTML = '<i class="fas fa-calendar-check me-1"></i>Planning Mode';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-info');
    
    // Clear chat and show welcome message
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    addMessageToChat('assistant', `üéØ Planning Mode activated! 

I'll help you create a milestone plan for this entry. I can:
- Analyze your entry context and historical data
- Research typical timelines for your project type
- Suggest realistic milestone dates
- Adjust the plan based on your feedback

What would you like to plan?`);
    
    document.getElementById('chatInput').placeholder = "E.g., 'Help me plan this fermentation' or 'Create a timeline for this project'";
    document.getElementById('chatInput').focus();
}

async function generatePlan(userPrompt) {
    const loadingId = addMessageToChat('assistant', 'Analyzing entry context and generating plan...', true);
    
    try {
        const response = await fetch(`/api/entries/{{ entry.id }}/generate_plan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: userPrompt })
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (data.success) {
            currentPlan = data.plan;
            
            // Add context summary
            addMessageToChat('assistant', `üìä ${data.context_summary}

I've created a proposed plan. You can review it in the preview area below and either apply it or discuss changes.`);
            
            // Render the plan in preview area
            renderPlanCard(data.plan);
            
        } else {
            addMessageToChat('assistant', `‚ùå Error: ${data.error || 'Failed to generate plan'}`);
        }
    } catch (error) {
        console.error('Plan generation error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Failed to generate plan. Please try again.');
    }
}

function renderPlanCard(plan) {
    // Show plan in the preview area instead of in chat
    const previewContainer = document.getElementById('planPreview');
    const previewContent = document.getElementById('planPreviewContent');
    
    let milestoneHTML = '';
    plan.milestones.forEach((milestone, index) => {
        const statusIcon = index === 0 ? '‚úì' : '‚Üí';
        const statusColor = milestone.state_color || '#6c757d';
        
        milestoneHTML += `
            <div class="milestone-step mb-3" data-milestone-index="${index}">
                <div class="d-flex align-items-start">
                    <span class="badge rounded-pill me-2" style="background-color: ${statusColor};">${statusIcon}</span>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <strong>${milestone.target_date}</strong>
                            ${milestone.duration_days ? `<span class="badge bg-info">${milestone.duration_days} days</span>` : ''}
                        </div>
                        <div class="fw-bold">${milestone.status_name}</div>
                        ${milestone.notes ? `<small class="text-muted">${milestone.notes}</small>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    previewContent.innerHTML = `
        <div class="mb-3">
            <h5 class="mb-1">${plan.title || 'Proposed Milestone Plan'}</h5>
            <small class="text-muted">Total Duration: ${plan.duration_total_days} days</small>
        </div>
        ${plan.reasoning ? `<div class="alert alert-info mb-3"><small><strong>Reasoning:</strong> ${plan.reasoning}</small></div>` : ''}
        <div class="plan-timeline">
            ${milestoneHTML}
        </div>
    `;
    
    // Show the preview container
    previewContainer.classList.remove('d-none');
}

async function applyPlanPreview() {
    if (!currentPlan) {
        addMessageToChat('assistant', '‚ùå No plan to apply');
        return;
    }
    
    const loadingId = addMessageToChat('assistant', 'Creating milestones...', true);
    
    try {
        const response = await fetch(`/api/entries/{{ entry.id }}/apply_plan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan: currentPlan })
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (data.success) {
            addMessageToChat('assistant', `‚úÖ ${data.message}

The milestones are now visible in the Progress & Status section below. I'll continue to monitor your progress!`);
            
            // Close the preview
            closePlanPreview();
            
            // Refresh timeline section if it exists
            if (window.timelineModule && typeof window.timelineModule.refresh === 'function') {
                window.timelineModule.refresh();
            }
            
            currentPlan = null;
        } else {
            addMessageToChat('assistant', `‚ùå Error: ${data.error || 'Failed to apply plan'}`);
        }
    } catch (error) {
        console.error('Apply plan error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Failed to apply plan. Please try again.');
    }
}

function closePlanPreview() {
    const previewContainer = document.getElementById('planPreview');
    previewContainer.classList.add('d-none');
}

function refinePlanPreview() {
    addMessageToChat('assistant', `Sure! Tell me what you'd like to change:

- Move a milestone date?
- Add or remove a step?
- Adjust the timeline?

Just describe what you want, and I'll update the plan.`);
    
    document.getElementById('chatInput').placeholder = "E.g., 'Move bottling to day 15' or 'Add dry hopping step'";
    document.getElementById('chatInput').focus();
}

function exitPlanningMode() {
    planningMode = false;
    currentPlan = null;
    
    // Remove plan card if present
    const planCard = document.getElementById('current-plan-card');
    if (planCard) planCard.remove();
    
    resetActionButton();
    addMessageToChat('assistant', 'Planning mode exited. How else can I help?');
    document.getElementById('chatInput').placeholder = "Ask AI or request description changes...";
}

// Note Composer Mode Functions
var noteComposerMode = false;
var currentNoteProposal = null;
var noteAttachments = [];

async function enterNoteComposerMode() {
    noteComposerMode = true;
    currentAction = null;
    
    // Update button
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    buttonText.innerHTML = '<i class="fas fa-file-alt me-1"></i>Compose Note';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-info');
    
    // Clear chat and show welcome message
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    addMessageToChat('assistant', `üìù Note Composer activated!

I'll help you create a well-structured note for this entry. I can:
- Choose the appropriate note type
- Suggest a clear title
- Draft comprehensive content
- Add Wikipedia links for reference (when relevant)
- Include any URLs you provide
- **Link to related entries across your app** üîó
- Interpret any files you want to attach

What kind of note would you like to create? You can:
- Describe the purpose (e.g., "Document today's progress")
- Specify a note type (e.g., "Create a Technical note about...")
- Share context or observations
- Request Wikipedia links (e.g., "Add a wiki link for this ingredient")
- Provide specific URLs to include (e.g., "Add a link to https://example.com")
- Mention related entries to link them (e.g., "Reference my flour and sugar entries")
- Upload files for me to interpret

üí° **Tips**: 
- I can suggest Wikipedia links automatically, but for other websites, please provide the actual URLs!
- I'll actively look for opportunities to link this note with related entries in your workspace!

You can also upload files at any time using the attachment button below!`);
    
    document.getElementById('chatInput').placeholder = "Describe what you want in this note...";
    document.getElementById('chatInput').focus();
    
    // Show attachment upload UI if not already visible
    showAttachmentUploadUI();
}

function showAttachmentUploadUI() {
    // Check if upload UI already exists
    if (document.getElementById('noteAttachmentUploadUI')) return;
    
    const chatContainer = document.getElementById('aiChatContainer');
    const chatInput = chatContainer.querySelector('.chat-input');
    
    const uploadUI = document.createElement('div');
    uploadUI.id = 'noteAttachmentUploadUI';
    uploadUI.className = 'attachment-upload-ui mb-2';
    uploadUI.innerHTML = `
        <div class="d-flex align-items-center gap-2">
            <label class="btn btn-sm btn-outline-secondary mb-0" for="noteAttachmentInput">
                <i class="fas fa-paperclip me-1"></i>Attach Files
            </label>
            <input type="file" id="noteAttachmentInput" multiple class="d-none" onchange="handleNoteAttachments(this)">
            <div id="noteAttachmentsList" class="flex-grow-1 small text-muted">
                No files attached
            </div>
        </div>
    `;
    
    chatInput.parentNode.insertBefore(uploadUI, chatInput);
}

function hideAttachmentUploadUI() {
    const uploadUI = document.getElementById('noteAttachmentUploadUI');
    if (uploadUI) uploadUI.remove();
    noteAttachments = [];
}

async function handleNoteAttachments(input) {
    const files = Array.from(input.files);
    
    if (files.length === 0) return;
    
    // Add files to attachments array
    for (const file of files) {
        noteAttachments.push(file);
        
        // Try to read text preview for certain file types
        if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.txt')) {
            try {
                const preview = await readFilePreview(file);
                addMessageToChat('assistant', `üìé I've received "${file.name}". I'll consider this when composing the note.`);
            } catch (e) {
                console.error('Error reading file preview:', e);
            }
        } else {
            addMessageToChat('assistant', `üìé I've received "${file.name}" (${formatFileSize(file.size)}). This will be attached to the note.`);
        }
    }
    
    updateAttachmentsList();
}

function readFilePreview(file, maxLength = 500) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            let text = e.target.result;
            if (text.length > maxLength) {
                text = text.substring(0, maxLength) + '...';
            }
            resolve(text);
        };
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function updateAttachmentsList() {
    const listElement = document.getElementById('noteAttachmentsList');
    if (!listElement) return;
    
    if (noteAttachments.length === 0) {
        listElement.innerHTML = 'No files attached';
        listElement.className = 'flex-grow-1 small text-muted';
    } else {
        listElement.innerHTML = noteAttachments.map((file, index) => 
            `<span class="badge bg-secondary me-1">
                ${file.name}
                <i class="fas fa-times ms-1" style="cursor: pointer;" onclick="removeNoteAttachment(${index})"></i>
            </span>`
        ).join('');
        listElement.className = 'flex-grow-1 small';
    }
}

function removeNoteAttachment(index) {
    noteAttachments.splice(index, 1);
    updateAttachmentsList();
    addMessageToChat('assistant', 'Attachment removed.');
}

async function composeNote(userPrompt) {
    const loadingId = addMessageToChat('assistant', 'Analyzing context and composing note...', true);
    
    try {
        // Prepare attachment file info for AI
        const attachmentFiles = [];
        for (const file of noteAttachments) {
            const fileInfo = {
                filename: file.name,
                type: file.type || 'unknown',
                size: file.size
            };
            
            // Add preview for text files
            if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.txt')) {
                try {
                    fileInfo.preview = await readFilePreview(file);
                } catch (e) {
                    console.error('Error reading file preview:', e);
                }
            }
            
            // Add base64 data for images so AI can analyze them
            if (file.type.startsWith('image/')) {
                try {
                    const reader = new FileReader();
                    const base64Promise = new Promise((resolve, reject) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    fileInfo.data = await base64Promise;
                } catch (e) {
                    console.error('Error reading image data:', e);
                }
            }
            
            attachmentFiles.push(fileInfo);
        }
        
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: userPrompt,
                entry_id: {{ entry.id }},
                action: 'compose_note',
                note_context: currentNoteProposal ? { current_draft: currentNoteProposal } : {},
                attachment_files: attachmentFiles,
                chat_history: chatHistory  // Include conversation history
            })
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (data.note_preview) {
            currentNoteProposal = data.note_preview;
            
            const aiMessage = data.message || "I've composed a note for you. Review it below and you can continue chatting to refine it, or click Apply Note when ready.";
            
            // Add to chat history
            chatHistory.push({
                role: 'user',
                content: userPrompt
            });
            chatHistory.push({
                role: 'assistant',
                content: aiMessage
            });
            
            // Show reasoning message
            addMessageToChat('assistant', aiMessage);
            
            // Render the note preview
            renderNotePreview(data.note_preview);
            
        } else if (data.error) {
            // Handle special case where AI detects this is a question, not a note request
            const errorMessage = data.error;
            chatHistory.push({
                role: 'user',
                content: userPrompt
            });
            chatHistory.push({
                role: 'assistant',
                content: errorMessage
            });
            addMessageToChat('assistant', errorMessage);
        } else if (data.message) {
            const aiMessage = data.message;
            chatHistory.push({
                role: 'user',
                content: userPrompt
            });
            chatHistory.push({
                role: 'assistant',
                content: aiMessage
            });
            addMessageToChat('assistant', aiMessage);
        } else {
            addMessageToChat('assistant', `‚ùå Error: Failed to compose note. Please try again.`);
        }
    } catch (error) {
        console.error('Note composition error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Failed to compose note. Please try again.');
    }
}

async function fetchAssociatedEntryNames(entryIds) {
    try {
        // Fetch each entry's details
        const entryPromises = entryIds.map(id => 
            fetch(`/api/entries/${id}`).then(r => r.json())
        );
        
        const entries = await Promise.all(entryPromises);
        
        // Build HTML for entry list
        const entryListHTML = entries.map(entry => {
            if (entry.error) {
                return `<div class="text-muted small">‚Ä¢ Entry ID ${entry.id || 'unknown'} (not found)</div>`;
            }
            return `
                <div class="small">
                    ‚Ä¢ <strong>${entry.title}</strong> 
                    <span class="text-muted">(${entry.entry_type?.singular_label || 'Entry'})</span>
                </div>
            `;
        }).join('');
        
        // Update the preview container
        const previewContainer = document.getElementById('associatedEntriesPreview');
        if (previewContainer) {
            previewContainer.innerHTML = entryListHTML;
        }
    } catch (error) {
        console.error('Error fetching entry names:', error);
        const previewContainer = document.getElementById('associatedEntriesPreview');
        if (previewContainer) {
            previewContainer.innerHTML = '<small class="text-danger">Error loading entry names</small>';
        }
    }
}

function renderNotePreview(noteProposal) {
    const previewContainer = document.getElementById('notePreview');
    const previewContent = document.getElementById('notePreviewContent');
    
    let bookmarksHTML = '';
    if (noteProposal.url_bookmarks && noteProposal.url_bookmarks.length > 0) {
        bookmarksHTML = `
            <div class="mt-3">
                <strong>üîó Links:</strong>
                <ul class="list-unstyled ms-3 mt-1">
                    ${noteProposal.url_bookmarks.map(bookmark => 
                        `<li><a href="${bookmark.url}" target="_blank">${bookmark.friendly_name || bookmark.url}</a></li>`
                    ).join('')}
                </ul>
            </div>
        `;
    }
    
    let associationsHTML = '';
    if (noteProposal.associated_entry_ids && noteProposal.associated_entry_ids.length > 0) {
        associationsHTML = `
            <div class="mt-3">
                <strong>üîó Associated Entries:</strong>
                <div class="ms-3 mt-1" id="associatedEntriesPreview">
                    <small class="text-muted">Loading entry names...</small>
                </div>
            </div>
        `;
        
        // Fetch entry details asynchronously
        fetchAssociatedEntryNames(noteProposal.associated_entry_ids);
    }
    
    let attachmentsHTML = '';
    if (noteAttachments.length > 0) {
        attachmentsHTML = `
            <div class="mt-3">
                <strong>üìé Attachments:</strong>
                <ul class="list-unstyled ms-3 mt-1">
                    ${noteAttachments.map(file => 
                        `<li><i class="fas fa-file me-1"></i>${file.name} (${formatFileSize(file.size)})</li>`
                    ).join('')}
                </ul>
            </div>
        `;
    }
    
    // Format note text: convert markdown to HTML and preserve line breaks
    let formattedContent = noteProposal.note_text || 'No content';
    
    // Remove ** markdown bold formatting
    formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert markdown headers
    formattedContent = formattedContent.replace(/^### (.*?)$/gm, '<h6>$1</h6>');
    formattedContent = formattedContent.replace(/^## (.*?)$/gm, '<h5>$1</h5>');
    formattedContent = formattedContent.replace(/^# (.*?)$/gm, '<h4>$1</h4>');
    
    // Convert bullet points (- or *)
    formattedContent = formattedContent.replace(/^[\-\*] (.*?)$/gm, '<li>$1</li>');
    formattedContent = formattedContent.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    
    // Convert line breaks to <br> tags (but not inside HTML tags)
    formattedContent = formattedContent.replace(/\n/g, '<br>');
    
    previewContent.innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <small class="text-muted d-block mb-1"><i class="fas fa-pencil-alt"></i> Click to edit</small>
                    <h5 class="mb-1 editable-title" contenteditable="true" 
                        data-field="note_title"
                        style="border: 1px dashed transparent; padding: 4px; border-radius: 4px;"
                        onfocus="this.style.borderColor='#0d6efd'; this.style.backgroundColor='#fff';"
                        onblur="this.style.borderColor='transparent'; this.style.backgroundColor='transparent'; updateNoteField('note_title', this.textContent);"
                    >${noteProposal.note_title || 'Untitled Note'}</h5>
                    <span class="badge bg-info">${noteProposal.note_type || 'General'}</span>
                </div>
            </div>
        </div>
        <div class="note-content mb-3">
            <strong>Content:</strong>
            <div class="mt-2 p-2 border rounded bg-light editable-content" contenteditable="true"
                data-field="note_text"
                style="white-space: normal; min-height: 100px; border: 1px dashed transparent !important;"
                onfocus="this.style.borderColor='#0d6efd'; this.style.backgroundColor='#fff';"
                onblur="this.style.borderColor='transparent'; this.style.backgroundColor='#f8f9fa'; updateNoteField('note_text', this.innerHTML);"
            >${formattedContent}</div>
        </div>
        ${bookmarksHTML}
        ${associationsHTML}
        ${attachmentsHTML}
    `;
    
    previewContainer.classList.remove('d-none');
}

function updateNoteField(field, value) {
    if (!currentNoteProposal) return;
    
    if (field === 'note_title') {
        currentNoteProposal.note_title = value.trim();
    } else if (field === 'note_text') {
        // Convert HTML back to a more readable format for storage
        // Keep the HTML formatting since it will be converted when saved
        currentNoteProposal.note_text = value
            .replace(/<br\s*\/?>/gi, '\n')  // Convert <br> back to newlines
            .replace(/<\/p>/gi, '\n\n')      // Paragraph breaks
            .replace(/<p>/gi, '')
            .replace(/<strong>(.*?)<\/strong>/gi, '**$1**')  // Bold back to markdown
            .replace(/<h6>(.*?)<\/h6>/gi, '### $1\n')        // Headers back to markdown
            .replace(/<h5>(.*?)<\/h5>/gi, '## $1\n')
            .replace(/<h4>(.*?)<\/h4>/gi, '# $1\n')
            .replace(/<\/?ul>/gi, '')                        // Remove ul tags
            .replace(/<li>(.*?)<\/li>/gi, '- $1\n')          // List items back to markdown
            .replace(/<[^>]+>/g, '')                         // Remove any other HTML tags
            .trim();
    }
}


async function applyNotePreview() {
    if (!currentNoteProposal) {
        addMessageToChat('assistant', '‚ùå No note to apply');
        return;
    }
    
    const loadingId = addMessageToChat('assistant', 'Creating note...', true);
    
    try {
        // Prepare form data for note creation
        const formData = new FormData();
        formData.append('note_title', currentNoteProposal.note_title || '');
        formData.append('note_text', currentNoteProposal.note_text || '');
        formData.append('note_type', currentNoteProposal.note_type || 'General');
        
        // Add URL bookmarks as JSON
        if (currentNoteProposal.url_bookmarks && currentNoteProposal.url_bookmarks.length > 0) {
            formData.append('url_bookmarks', JSON.stringify(currentNoteProposal.url_bookmarks));
        }
        
        // Add associated entry IDs as JSON
        if (currentNoteProposal.associated_entry_ids && currentNoteProposal.associated_entry_ids.length > 0) {
            formData.append('associated_entry_ids', JSON.stringify(currentNoteProposal.associated_entry_ids));
        }
        
        // Add file attachments
        for (const file of noteAttachments) {
            formData.append('files', file);
        }
        
        const response = await fetch(`/api/entries/{{ entry.id }}/notes`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (response.ok && data.success) {
            addMessageToChat('assistant', `‚úÖ Note created successfully!

The note has been added to this entry. You can find it in the Notes section below. Would you like to create another note?`);
            
            // Close the preview
            closeNotePreview();
            
            // Refresh notes section if it exists
            if (typeof fetchNotes === 'function') {
                fetchNotes();
            }
            
            // Clear attachments and proposal
            currentNoteProposal = null;
            noteAttachments = [];
            updateAttachmentsList();
            
        } else {
            addMessageToChat('assistant', `‚ùå Error: ${data.error || 'Failed to create note'}`);
        }
    } catch (error) {
        console.error('Apply note error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Failed to create note. Please try again.');
    }
}

function closeNotePreview() {
    const previewContainer = document.getElementById('notePreview');
    previewContainer.classList.add('d-none');
}

function exitNoteComposerMode() {
    noteComposerMode = false;
    currentNoteProposal = null;
    noteAttachments = [];
    
    // Remove note preview if present
    closeNotePreview();
    
    // Hide attachment UI
    hideAttachmentUploadUI();
    
    resetActionButton();
    addMessageToChat('assistant', 'Note composer exited. How else can I help?');
    document.getElementById('chatInput').placeholder = "Ask AI or request description changes...";
}

// Diagram Editor Mode Functions
var diagramMode = false;
var currentDiagramXML = null;
var diagramUpdateCallback = null;

async function enterDiagramMode() {
    diagramMode = true;
    currentAction = null;
    
    // Update button
    const buttonText = document.getElementById('selectedActionText');
    const button = document.getElementById('aiActionButton');
    buttonText.innerHTML = '<i class="fas fa-project-diagram me-1"></i>Edit Diagram';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-info');
    
    // Clear chat and show welcome message
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    // Try to load current diagram
    try {
        const response = await fetch(`/api/entries/{{ entry.id }}/drawio`);
        if (response.ok) {
            const data = await response.json();
            currentDiagramXML = data.diagram_data;
            
            // If no diagram exists yet, create and save a blank one
            if (!currentDiagramXML || currentDiagramXML.trim() === '') {
                const blankDiagram = `<mxGraphModel>
  <root>
    <mxCell id="0"/>
    <mxCell id="1" parent="0"/>
  </root>
</mxGraphModel>`;
                
                // Save the blank diagram
                const saveResponse = await fetch(`/api/entries/{{ entry.id }}/drawio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        diagram_data: blankDiagram
                    })
                });
                
                if (saveResponse.ok) {
                    currentDiagramXML = blankDiagram;
                    console.log('Created blank diagram for new entry');
                }
            }
        }
    } catch (error) {
        console.error('Error loading diagram:', error);
    }
    
    addMessageToChat('assistant', `üé® Diagram Planning Mode activated!

Let's discuss what kind of diagram you want to create. I'll help you plan and refine the concept before we generate it.

**How this works:**
1. **Discuss**: Tell me what you want to diagram (system architecture, flowchart, wiring, etc.)
2. **Refine**: I'll ask clarifying questions and help you think through the design
3. **Generate**: When you're ready, say "create the diagram" or "generate it"

**Examples of what to discuss:**
- "I need a diagram showing how my ESP32 connects to sensors"
- "Create a flowchart for user authentication"
- "Show the architecture of a web application"
- "Diagram a home automation setup"

${currentDiagramXML ? 'üìä I can see your current diagram and will work with it.' : 'üìÑ Starting with a blank canvas.'}

What kind of diagram would you like to create?`);
    
    // Show the create diagram button
    showCreateDiagramButton();
    
    document.getElementById('chatInput').placeholder = "Describe your diagram idea...";
    document.getElementById('chatInput').focus();
}

async function updateDiagram(diagramXML, explanation) {
    // Show the diagram update in chat
    addMessageToChat('assistant', `‚úÖ ${explanation}

I've updated the diagram. Click "Apply Diagram" below to see the changes.`);
    
    // Show diagram preview with apply button
    showDiagramPreview(diagramXML, explanation);
}

function showDiagramPreview(diagramXML, explanation) {
    const previewContainer = document.getElementById('diagramPreview');
    const previewContent = document.getElementById('diagramPreviewContent');
    
    previewContent.innerHTML = `
        <div class="mb-3">
            <h5 class="mb-1"><i class="fas fa-project-diagram me-2"></i>Diagram Update Ready</h5>
            <small class="text-muted">${explanation}</small>
        </div>
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            The diagram has been generated. Click "Apply Diagram" to update the Draw.io editor.
        </div>
        <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="applyDiagramPreview()">
                <i class="fas fa-check me-1"></i>Apply Diagram
            </button>
            <button class="btn btn-outline-secondary" onclick="refineDiagramPreview()">
                <i class="fas fa-edit me-1"></i>Make Changes
            </button>
            <button class="btn btn-outline-danger" onclick="closeDiagramPreview()">
                <i class="fas fa-times me-1"></i>Cancel
            </button>
        </div>
    `;
    
    // Store the XML for later
    currentDiagramXML = diagramXML;
    
    // Show the preview container
    previewContainer.classList.remove('d-none');
}

function applyDiagramPreview() {
    if (!currentDiagramXML) {
        addMessageToChat('assistant', '‚ùå No diagram to apply');
        return;
    }
    
    // Find all Draw.io frames on the page
    const drawioFrames = document.querySelectorAll('iframe[id^="drawioFrame-"]');
    
    if (drawioFrames.length === 0) {
        addMessageToChat('assistant', '‚ùå No Draw.io editor found. Please make sure the Draw.io section is visible on this entry page.');
        return;
    }
    
    // Send the diagram to the first Draw.io frame
    const frame = drawioFrames[0];
    
    try {
        frame.contentWindow.postMessage(JSON.stringify({
            action: 'load',
            xml: currentDiagramXML,
            autosave: 1
        }), '*');
        
        addMessageToChat('assistant', '‚úÖ Diagram applied! The Draw.io editor has been updated. Scroll down to see the Diagram Editor section.');
        closeDiagramPreview();
    } catch (error) {
        console.error('Error applying diagram:', error);
        addMessageToChat('assistant', '‚ùå Error applying diagram. Please try again.');
    }
}

function closeDiagramPreview() {
    const previewContainer = document.getElementById('diagramPreview');
    previewContainer.classList.add('d-none');
}

function refineDiagramPreview() {
    addMessageToChat('assistant', `Sure! Tell me what you'd like to change:

- Add new elements?
- Move something?
- Change colors or styles?
- Remove something?

Just describe what you want, and I'll update the diagram.`);
    
    document.getElementById('chatInput').placeholder = "E.g., 'Make the API box larger' or 'Add a cache layer'";
    document.getElementById('chatInput').focus();
}

function showCreateDiagramButton() {
    const buttonContainer = document.getElementById('createDiagramButton');
    buttonContainer.classList.remove('d-none');
    
    // Scroll to show the button
    buttonContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function hideCreateDiagramButton() {
    const buttonContainer = document.getElementById('createDiagramButton');
    buttonContainer.classList.add('d-none');
}

async function triggerDiagramGeneration() {
    // Keep the button visible for continued iterations
    // (user can continue to iterate on the diagram after generation)
    
    // Add a message to indicate we're generating
    addMessageToChat('user', 'Create the diagram');
    
    // Trigger the generation
    await processDiagramRequest('Generate the diagram based on our discussion');
}

function exitDiagramMode() {
    diagramMode = false;
    currentDiagramXML = null;
    closeDiagramPreview();
    hideCreateDiagramButton();
    
    resetActionButton();
    addMessageToChat('assistant', 'Diagram editor mode exited. How else can I help?');
    document.getElementById('chatInput').placeholder = "Ask AI or request description changes...";
}

async function processDiagramRequest(message) {
    // Check if user is asking to generate/create/commit the diagram
    const generateKeywords = ['create', 'generate', 'make', 'build', 'commit', 'apply', 'produce', 'draw'];
    const shouldGenerate = generateKeywords.some(keyword => 
        message.toLowerCase().includes(keyword + ' diagram') || 
        message.toLowerCase().includes(keyword + ' it') ||
        message.toLowerCase().includes(keyword + ' the diagram')
    );
    
    if (!shouldGenerate) {
        // Discussion mode - just chat about the diagram concept
        const loadingId = addMessageToChat('assistant', 'Thinking...', true);
        
        // Add user message to history
        chatHistory.push({
            role: 'user',
            content: message
        });
        
        try {
            const response = await fetch('/api/ai/diagram/discuss', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    entry_id: {{ entry.id }},
                    message: message,
                    chat_history: chatHistory,
                    current_diagram: currentDiagramXML
                })
            });
            
            const data = await response.json();
            document.getElementById(loadingId).remove();
            
            if (response.ok && data.response) {
                addMessageToChat('assistant', data.response, false, data.debug_info);
                // Add assistant response to history
                chatHistory.push({
                    role: 'assistant',
                    content: data.response
                });
            } else {
                addMessageToChat('assistant', '‚ùå Error: ' + (data.error || 'Failed to process message'));
            }
        } catch (error) {
            document.getElementById(loadingId).remove();
            addMessageToChat('assistant', '‚ùå Error communicating with AI service: ' + error.message);
        }
        return;
    }
    
    // Generation mode - actually create the diagram
    const loadingId = addMessageToChat('assistant', 'Generating diagram...', true);
    
    try {
        const response = await fetch('/api/ai/diagram', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                entry_id: {{ entry.id }},
                message: message,
                chat_history: chatHistory,
                current_diagram: currentDiagramXML
            })
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove();
        
        if (response.ok && data.diagram_xml) {
            updateDiagram(data.diagram_xml, data.explanation || 'Diagram updated');
            
            // Show debug info if available and debug mode is on
            if (debugMode && data.debug_info) {
                addMessageToChat('assistant', '‚úÖ Diagram generated', false, data.debug_info);
            }
        } else {
            addMessageToChat('assistant', '‚ùå Error: ' + (data.error || 'Failed to generate diagram'));
        }
    } catch (error) {
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', '‚ùå Error communicating with AI service: ' + error.message);
    }
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Check if diagram should be included
    let diagramXML = null;
    
    if (diagramInclusionEnabled) {
        console.log('[AI Assistant] Diagram inclusion enabled, capturing...');
        
        // Show spinner on button
        const btn = document.getElementById('includeDiagramCheckboxBtn');
        const icon = document.getElementById('diagramCheckboxIcon');
        const originalIconClass = icon.className;
        icon.className = 'fas fa-spinner fa-spin';
        
        diagramXML = await captureCurrentDiagram();
        
        // Restore icon
        icon.className = originalIconClass;
        
        if (diagramXML) {
            console.log('[AI Assistant] Diagram captured, will include with message');
        } else {
            console.warn('[AI Assistant] Could not capture diagram');
            addMessageToChat('assistant', '‚ö†Ô∏è Note: Could not capture diagram. Continuing without it.');
        }
    }
    
    addMessageToChat('user', message);
    const actionToSend = currentAction;
    currentAction = null;
    input.value = '';
    input.placeholder = "Continue the conversation or start a new request...";
    
    // Check if in planning mode
    if (planningMode && !actionToSend) {
        // Check if user is asking for a new plan or refining existing one
        if (!currentPlan || message.toLowerCase().includes('new plan') || message.toLowerCase().includes('start over')) {
            await generatePlan(message);
        } else {
            // Refining existing plan - regenerate with refinement prompt
            await generatePlan(`Based on the previous plan, ${message}`);
        }
        return;
    }
    
    // Check if in diagram mode
    if (diagramMode && !actionToSend) {
        await processDiagramRequest(message);
        return;
    }
    
    // Check if in note composer mode
    if (noteComposerMode && !actionToSend) {
        // Check if user is asking for a new note or refining existing one
        if (!currentNoteProposal || message.toLowerCase().includes('new note') || message.toLowerCase().includes('start over')) {
            await composeNote(message);
        } else {
            // Refining existing note - compose with refinement prompt
            await composeNote(`Based on the previous note proposal, ${message}`);
        }
        return;
    }
    
    const loadingId = addMessageToChat('assistant', 'Thinking...', true);
    
    try {
        let response, data;
        
        // If action is set (description generation/improvement), use /api/ai/chat
        // Otherwise use /api/ai/entry-chat for full context conversation
        if (actionToSend || (activeConversationMode && currentDraft)) {
            const payload = {
                message: message,
                entry_id: {{ entry.id }},
                entry_title: {{ entry.title|tojson }},
                entry_description: {{ (entry.description or '')|tojson }},
                chat_history: chatHistory,
                section_config: aiSectionConfig  // Include section-specific AI prompts
            };
            
            // Add diagram XML if captured
            if (diagramXML) {
                payload.diagram_xml = diagramXML;
                console.log('[AI Assistant] Including diagram with message');
            }
            
            if (actionToSend) {
                payload.action = actionToSend;
            } else if (activeConversationMode && currentDraft) {
                payload.action = 'refine_draft';
                payload.current_draft = currentDraft;
            }
            
            response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            
            data = await response.json();
        } else {
            // General conversation with full entry context
            const entryPayload = {
                entry_id: {{ entry.id }},
                message: message,
                is_first_message: chatHistory.length === 0,
                include_all_notes: false // Can be toggled later
            };
            
            // Add diagram XML if captured
            if (diagramXML) {
                entryPayload.diagram_xml = diagramXML;
                console.log('[AI Assistant] Including diagram with entry chat');
            }
            
            response = await fetch('/api/ai/entry-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(entryPayload)
            });
            
            const entryData = await response.json();
            data = {
                message: entryData.success ? entryData.response : (entryData.error || 'Failed to get response'),
                debug_info: entryData.debug_info
            };
        }
        
        document.getElementById(loadingId).remove();
        
        if (response.ok) {
            const aiMessage = data.message || data.response || 'No response';
            addMessageToChat('assistant', aiMessage, false, data.debug_info);
            
            // Reset action button to default
            resetActionButton();
            
            if (data.description_preview) {
                currentDraft = data.description_preview;
                showDescriptionPreview(data.description_preview);
            }
            
            chatHistory.push({
                role: 'user',
                content: message
            });
            chatHistory.push({
                role: 'assistant',
                content: aiMessage
            });
        } else {
            addMessageToChat('assistant', 'Error: ' + (data.error || 'Failed to get response'));
            activeConversationMode = false;
        }
    } catch (error) {
        console.error('Chat error:', error);
        document.getElementById(loadingId).remove();
        addMessageToChat('assistant', 'Error: Failed to communicate with AI');
        activeConversationMode = false;
    }
}

function addMessageToChat(role, content, isLoading = false, debugInfo = null) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageId = 'msg-' + Date.now();
    
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.className = 'chat-message ' + role + (isLoading ? ' loading' : '');
    
    const icon = role === 'user' ? 'fa-user' : 'fa-robot';
    const label = role === 'user' ? 'You' : 'AI Assistant';
    
    let debugSection = '';
    if (debugInfo && role === 'assistant') {
        console.log('[AI Assistant] Building debug section with debugInfo:', debugInfo);
        const debugId = `debug-${messageId}`;
        const fullPromptId = `fullprompt-${messageId}`;
        
        debugSection = `
            <div class="debug-reasoning mt-2 p-2 bg-light border rounded small" style="display: ${debugMode ? 'block' : 'none'};">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong class="text-primary"><i class="fas fa-bug me-1"></i>AI Reasoning Context</strong>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyDebugInfo(this)" data-debug-info='${JSON.stringify(debugInfo).replace(/'/g, "&#39;")}'>
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                ${debugInfo.section_prompt ? `<div class="mb-2"><strong>Section Custom Prompt:</strong><br><code class="small">${escapeHtml(debugInfo.section_prompt)}</code></div>` : ''}
                ${debugInfo.entry_type ? `<div class="mb-2"><strong>Entry Type:</strong> ${debugInfo.entry_type}</div>` : ''}
                ${debugInfo.action ? `<div class="mb-2"><strong>Action:</strong> ${debugInfo.action}</div>` : ''}
                ${debugInfo.has_diagram ? `<div class="mb-2"><strong>Diagram Context:</strong> ‚úì Included</div>` : ''}
                ${debugInfo.has_diagram_examples ? `<div class="mb-2"><strong>Diagram Examples:</strong> ${debugInfo.diagram_examples_count} example(s) provided</div>` : ''}
                ${debugInfo.prompt_layers ? `<div class="mb-2"><strong>Prompt Layers:</strong> ${debugInfo.prompt_layers.join(' ‚Üí ')}</div>` : ''}
                
                ${debugInfo.full_prompt ? `
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#${fullPromptId}" aria-expanded="false">
                            <i class="fas fa-code me-1"></i>Show Full Prompt Sent to AI
                        </button>
                        <div class="collapse mt-2" id="${fullPromptId}">
                            <div class="card card-body bg-white" style="max-height: 400px; overflow-y: auto;">
                                <pre class="mb-0 small" style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(debugInfo.full_prompt)}</pre>
                            </div>
                        </div>
                    </div>
                ` : `<div class="mt-2 text-muted small"><i class="fas fa-info-circle me-1"></i>Full prompt not available for this response type</div>`}
            </div>
        `;
    }
    
    messageDiv.innerHTML = `
        <div class="message-header">
            <span><i class="fas ${icon} me-2"></i>${label}</span>
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        </div>
        <div class="message-content">${content}</div>
        ${debugSection}
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyDebugInfo(button) {
    const debugInfo = JSON.parse(button.getAttribute('data-debug-info'));
    navigator.clipboard.writeText(JSON.stringify(debugInfo, null, 2));
    const icon = button.querySelector('i');
    icon.className = 'fas fa-check';
    setTimeout(() => {
        icon.className = 'fas fa-copy';
    }, 2000);
}

function showDescriptionPreview(description) {
    const previewContainer = document.getElementById('descriptionPreview');
    const previewContent = document.getElementById('previewContent');
    
    previewContent.textContent = description;
    // Render as markdown
    if (typeof renderMarkdown === 'function') {
        renderMarkdown(previewContent);
    }
    previewContainer.classList.remove('d-none');
    previewContainer.dataset.previewText = description;
}

function applyDescriptionPreview() {
    const previewContainer = document.getElementById('descriptionPreview');
    const previewText = previewContainer.dataset.previewText;
    
    if (previewText) {
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        if (descriptionDisplay) {
            descriptionDisplay.textContent = previewText;
            // Immediately render as markdown
            if (typeof renderMarkdown === 'function') {
                renderMarkdown(descriptionDisplay);
            }
        }
        
        const descriptionTextarea = document.getElementById('descriptionTextarea');
        if (descriptionTextarea) {
            descriptionTextarea.value = previewText;
        }
        
        saveDescriptionUpdate(previewText);
        previewContainer.classList.add('d-none');
        addMessageToChat('assistant', 'Description updated successfully!');
        
        // Exit conversation mode
        activeConversationMode = false;
        currentDraft = null;
        document.getElementById('chatInput').placeholder = "Ask AI or request description changes...";
    }
}

async function saveDescriptionUpdate(description) {
    try {
        const response = await fetch(`/api/entries/{{ entry.id }}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description
            })
        });
        
        if (!response.ok) {
            console.error('Failed to save description update');
        }
    } catch (error) {
        console.error('Error saving description:', error);
    }
}

// State variable for diagram inclusion
let diagramInclusionEnabled = false;

// Function to toggle diagram inclusion
function toggleDiagramCheckbox() {
    diagramInclusionEnabled = !diagramInclusionEnabled;
    
    const btn = document.getElementById('includeDiagramCheckboxBtn');
    const icon = document.getElementById('diagramCheckboxIcon');
    
    if (diagramInclusionEnabled) {
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-info');
        icon.classList.add('text-white');
        btn.title = 'Diagram included with messages (click to disable)';
        console.log('[AI Assistant] Diagram inclusion enabled');
    } else {
        btn.classList.remove('btn-info');
        btn.classList.add('btn-outline-secondary');
        icon.classList.remove('text-white');
        btn.title = 'Include diagram with messages';
        console.log('[AI Assistant] Diagram inclusion disabled');
    }
}

// Check if Draw.io section exists and show the checkbox button
function checkForDrawioSection() {
    const drawioFrames = document.querySelectorAll('iframe[id^="drawioFrame-"]');
    const checkboxBtn = document.getElementById('includeDiagramCheckboxBtn');
    
    if (drawioFrames.length > 0) {
        checkboxBtn.style.display = 'block';
        console.log('[AI Assistant] Draw.io section detected, showing diagram inclusion button');
    } else {
        checkboxBtn.style.display = 'none';
        console.log('[AI Assistant] No Draw.io section found');
    }
}

// Run check on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(checkForDrawioSection, 1000); // Wait for sections to load
});

// Function to capture current diagram from Draw.io section
async function captureCurrentDiagram() {
    return new Promise((resolve, reject) => {
        console.log('[AI Assistant] Attempting to capture diagram from Draw.io section');
        
        // Find all Draw.io frames on the page
        const drawioFrames = document.querySelectorAll('iframe[id^="drawioFrame-"]');
        
        console.log('[AI Assistant] Found', drawioFrames.length, 'Draw.io frame(s)');
        
        if (drawioFrames.length === 0) {
            console.warn('[AI Assistant] No Draw.io editor found');
            resolve(null);
            return;
        }
        
        const frame = drawioFrames[0];
        console.log('[AI Assistant] Using frame:', frame.id);
        
        // Set up a temporary message listener for diagram export
        const messageHandler = function(evt) {
            console.log('[AI Assistant] Received message from origin:', evt.origin);
            
            // Check for both diagrams.net and embed.diagrams.net
            if (!evt.origin.includes('diagrams.net')) {
                console.log('[AI Assistant] Ignoring message from non-diagrams.net origin');
                return;
            }
            
            if (!evt.data || typeof evt.data !== 'string') {
                console.log('[AI Assistant] Message data is not a string');
                return;
            }
            
            try {
                const msg = JSON.parse(evt.data);
                console.log('[AI Assistant] Parsed message event:', msg.event, 'format:', msg.format);
                
                if (msg.event === 'export') {
                    console.log('[AI Assistant] Export event - checking fields: xml?', !!msg.xml, 'data?', !!msg.data);
                    
                    // Draw.io sends XML in msg.xml field (even if msg.format says 'svg')
                    // We requested XML format, so check for xml field specifically
                    if (msg.xml) {
                        window.removeEventListener('message', messageHandler);
                        console.log('[AI Assistant] Diagram XML captured successfully, length:', msg.xml.length);
                        console.log('[AI Assistant] First 100 chars:', msg.xml.substring(0, 100));
                        resolve(msg.xml);
                    } else {
                        console.warn('[AI Assistant] Export event but no XML data in message');
                        console.log('[AI Assistant] Message structure:', Object.keys(msg));
                    }
                }
            } catch (error) {
                console.error('[AI Assistant] Error parsing diagram message:', error);
            }
        };
        
        // Add the message listener
        window.addEventListener('message', messageHandler);
        
        // Set timeout to clean up if no response
        setTimeout(() => {
            window.removeEventListener('message', messageHandler);
            console.warn('[AI Assistant] Diagram capture timeout after 5 seconds');
            resolve(null);
        }, 5000);
        
        // Request XML export from Draw.io (uncompressed with all attributes)
        try {
            const exportMessage = JSON.stringify({
                action: 'export',
                format: 'xmlpng',  // Use xmlpng to get full uncompressed XML
                xml: true,          // Explicitly request XML
                spin: false         // Don't show spinner
            });
            console.log('[AI Assistant] Sending export request to Draw.io');
            frame.contentWindow.postMessage(exportMessage, '*');
        } catch (error) {
            console.error('[AI Assistant] Error requesting diagram export:', error);
            window.removeEventListener('message', messageHandler);
            resolve(null);
        }
    });
}
</script>

<div class="chat-container" id="aiChatContainer">
    <!-- Debug Toggle -->
    <div class="mb-2 d-flex justify-content-end">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="debugModeToggle" onchange="toggleDebugMode()">
            <label class="form-check-label small text-muted" for="debugModeToggle">
                <i class="fas fa-bug me-1"></i>Show AI Reasoning
            </label>
        </div>
    </div>
    
    <!-- Chat Messages -->
    <div class="chat-messages mb-3" id="chatMessages" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--theme-border, var(--bs-border-color)); border-radius: 8px; padding: 1rem; background: var(--theme-bg-surface, var(--bs-body-bg));">
        <div class="text-center text-muted py-4">
            <i class="fas fa-robot fa-2x mb-2"></i>
            <p>Ask me anything about this entry or request description improvements!</p>
        </div>
    </div>
    
    <!-- Description Preview Area (Hidden by default) -->
    <div class="description-preview d-none mb-3" id="descriptionPreview">
        <div class="card border-info">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-eye me-2"></i>Current Draft</span>
                <div>
                    <button class="btn btn-sm btn-light me-2" onclick="updateDraft()">
                        <i class="fas fa-sync me-1"></i>Revise
                    </button>
                    <button class="btn btn-sm btn-success" onclick="applyDescriptionPreview()">
                        <i class="fas fa-check me-1"></i>Apply to Entry
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="previewContent" class="markdown-content"></div>
            </div>
        </div>
    </div>
    
    <!-- Plan Preview Area (Hidden by default) -->
    <div class="plan-preview d-none mb-3" id="planPreview">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-calendar-check me-2"></i>Proposed Plan</span>
                <div>
                    <button class="btn btn-sm btn-light me-2" onclick="refinePlanPreview()">
                        <i class="fas fa-comments me-1"></i>Discuss Changes
                    </button>
                    <button class="btn btn-sm btn-success" onclick="applyPlanPreview()">
                        <i class="fas fa-check me-1"></i>Apply to Entry
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="closePlanPreview()">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="planPreviewContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Note Preview Area (Hidden by default) -->
    <div class="note-preview d-none mb-3" id="notePreview">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-alt me-2"></i>Proposed Note</span>
                <div>
                    <button class="btn btn-sm btn-success" onclick="applyNotePreview()">
                        <i class="fas fa-check me-1"></i>Apply Note
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="closeNotePreview()">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="notePreviewContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Diagram Preview Area (Hidden by default) -->
    <div class="diagram-preview d-none mb-3" id="diagramPreview">
        <div class="card border-info">
            <div class="card-body">
                <div id="diagramPreviewContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Create Diagram Button (Always shown in diagram mode) -->
    <div class="d-none mb-3" id="createDiagramButton">
        <div class="d-grid">
            <button class="btn btn-primary btn-lg" onclick="triggerDiagramGeneration()">
                <i class="fas fa-magic me-2"></i>Create Diagram Now
            </button>
        </div>
    </div>
    
    <!-- Chat Input -->
    <div class="chat-input">
        <div class="input-group">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="aiActionButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-magic me-1"></i><span id="selectedActionText">Quick Actions</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="selectAction('generate_description', 'Generate a description for this entry', 'Generate', 'robot'); return false;">
                    <i class="fas fa-robot me-2"></i>Generate Description
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="enterNoteComposerMode(); return false;">
                    <i class="fas fa-file-alt me-2"></i>Compose Note
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="enterDiagramMode(); return false;">
                    <i class="fas fa-project-diagram me-2"></i>Edit Diagram
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Planning Mode: show_end_dates={{ entry.show_end_dates }}, intended_end_date={{ entry.intended_end_date }} -->
                {% if entry.show_end_dates and entry.intended_end_date %}
                <li><a class="dropdown-item" href="#" onclick="enterPlanningMode(); return false;">
                    <i class="fas fa-calendar-check me-2"></i>Plan Milestones
                </a></li>
                <li><hr class="dropdown-divider"></li>
                {% else %}
                <!-- Planning mode hidden: show_end_dates={{ entry.show_end_dates }}, intended_end_date={{ entry.intended_end_date }} -->
                {% endif %}
                <li><a class="dropdown-item" href="#" onclick="selectAction('wikipedia', 'Provide Wikipedia-style information', 'Wikipedia', 'wikipedia-w'); return false;">
                    <i class="fab fa-wikipedia-w me-2"></i>Wikipedia Style
                </a></li>
            </ul>
            <input type="text" class="form-control" id="chatInput" placeholder="Ask AI or request description changes..." onkeypress="if(event.key==='Enter') sendChatMessage()">
            <!-- Include Diagram Checkbox (only shown if Draw.io section exists) -->
            <button class="btn btn-outline-secondary" type="button" id="includeDiagramCheckboxBtn" style="display: none;" onclick="toggleDiagramCheckbox()" title="Include diagram with messages">
                <i class="fas fa-project-diagram" id="diagramCheckboxIcon"></i>
            </button>
            <button class="btn btn-primary" onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<style>
.chat-message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    animation: fadeIn 0.3s ease;
}

.chat-message.user {
    background: var(--bs-primary-bg-subtle);
    border-left: 3px solid var(--bs-primary);
}

.chat-message.assistant {
    background: var(--bs-secondary-bg-subtle);
    border-left: 3px solid var(--bs-secondary);
}

.chat-message .message-header {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-message .message-content {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.chat-message.loading .message-content::after {
    content: '...';
    animation: dots 1.5s steps(4, end) infinite;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* Planning Mode Styles */
.plan-card {
    animation: fadeIn 0.5s ease;
    margin: 1rem 0;
}

.plan-card .card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.milestone-step {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    background: var(--bs-light);
    transition: all 0.2s ease;
}

.milestone-step:hover {
    background: var(--bs-secondary-bg-subtle);
    transform: translateX(4px);
}

.milestone-step .badge {
    min-width: 24px;
    height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.plan-timeline {
    max-height: 400px;
    overflow-y: auto;
}
</style>

