{# Relationships Section for Entry Detail V2 #}

<div class="relationships-section" id="relationshipsSection{{ entry.id }}">
  
  <!-- Section Header -->
  <div class="section-header mb-3">
    <h5>
      <i class="fas fa-link me-2"></i>
      Related Records
    </h5>
  </div>

  <!-- Loading State -->
  <div id="relationshipsLoading{{ entry.id }}" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading relationships...</p>
  </div>

  <!-- Section Content -->
  <div id="relatedRecordsContainer{{ entry.id }}" style="display: none;">
    <!-- Will be populated via JavaScript with cards for each relationship type -->
  </div>

</div>

<style>
/* Relationship cards styling with theme support */
.relationship-type-card {
    margin-bottom: 1rem;
    border: 1px solid var(--theme-border-color, var(--bs-border-color));
    border-radius: 0.5rem;
    overflow: hidden;
    background-color: var(--theme-card-bg, var(--bs-body-bg));
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.2s ease, transform 0.2s ease;
}

.relationship-type-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.relationship-type-card .card-header {
    background-color: var(--bs-secondary-bg);
    border-bottom: 1px solid var(--bs-border-color);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.relationship-type-card .card-header h6 {
    margin: 0;
    font-weight: 600;
    color: var(--bs-body-color);
}

.relationship-type-card .card-body {
    padding: 0;
    background-color: var(--theme-card-body-bg, var(--bs-body-bg));
}

.relationship-type-card table {
    margin: 0;
}

.relationship-type-card .table > :not(caption) > * > * {
    padding: 0.5rem 1rem;
    border-color: var(--theme-border-color, var(--bs-border-color));
}

.relationship-item-row {
    transition: background-color 0.15s ease;
}

.relationship-item-row:hover {
    background-color: var(--theme-hover-bg, var(--bs-secondary-bg));
}

.relationship-link {
    color: var(--bs-body-color) !important;
    text-decoration: none;
    transition: opacity 0.2s ease;
}

.relationship-link:hover {
    opacity: 0.7;
    text-decoration: underline;
}

.btn-add-relationship {
    white-space: nowrap;
    transition: all 0.2s ease;
}

.btn-add-relationship:hover:not(:disabled) {
    transform: scale(1.05);
}

.btn-add-relationship:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Dark mode adjustments */
[data-bs-theme="dark"] .relationship-type-card {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

[data-bs-theme="dark"] .relationship-type-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

/* Empty state styling */
.relationships-empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--bs-secondary-color);
}

.relationships-empty-state i {
    font-size: 3rem;
    opacity: 0.25;
    margin-bottom: 1rem;
}
</style>

<script>
(function() {
    const entryId = {{ entry.id }};
    const currentEntryTypeId = {{ entry.entry_type_id }};
    
    // Store definitions globally for this entry
    let relationshipDefinitions = [];
    
    async function loadRelationships() {
        const loadingEl = document.getElementById('relationshipsLoading' + entryId);
        const containerEl = document.getElementById('relatedRecordsContainer' + entryId);
        
        try {
            // Fetch relationship definitions
            const defsResponse = await fetch('/api/relationship_definitions');
            const definitions = await defsResponse.json();
            
            // Filter to relevant definitions for this entry type
            relationshipDefinitions = definitions.filter(def => 
                def.entry_type_id_from === currentEntryTypeId || 
                def.entry_type_id_to === currentEntryTypeId
            );
            
            // Fetch existing relationships
            const relsResponse = await fetch(`/api/entries/${entryId}/relationships`);
            const relationships = await relsResponse.json();
            
            // Group relationships by definition ID
            const groupedRelationships = {};
            relationships.forEach(rel => {
                if (!groupedRelationships[rel.definition_id]) {
                    groupedRelationships[rel.definition_id] = [];
                }
                groupedRelationships[rel.definition_id].push(rel);
            });
            
            // Render the cards
            renderRelationshipCards(relationshipDefinitions, groupedRelationships);
            
            loadingEl.style.display = 'none';
            containerEl.style.display = 'block';
            
        } catch (error) {
            console.error('Error loading relationships:', error);
            loadingEl.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading relationships: ${error.message}
                </div>
            `;
        }
    }
    
    function renderRelationshipCards(definitions, groupedRelationships) {
        const container = document.getElementById('relatedRecordsContainer' + entryId);
        
        if (definitions.length === 0) {
            container.innerHTML = `
                <div class="relationships-empty-state">
                    <i class="fas fa-link"></i>
                    <p>No relationship types available for this entry type.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        definitions.forEach(def => {
            const isFromSide = def.entry_type_id_from === currentEntryTypeId;
            const relationships = groupedRelationships[def.id] || [];
            
            // Determine the appropriate label and cardinality
            const displayLabel = isFromSide ? def.label_from_side : def.label_to_side;
            const relevantCardinality = isFromSide ? def.cardinality_from : def.cardinality_to;
            const canAddMore = relevantCardinality === -1 || relationships.length < relevantCardinality;
            
            html += `
                <div class="relationship-type-card">
                    <div class="card-header">
                        <h6>${escapeHtml(displayLabel || def.name)}</h6>
                        <button class="btn btn-sm btn-primary btn-add-relationship" 
                                data-definition-id="${def.id}"
                                data-label="${escapeHtml(displayLabel || def.name)}"
                                data-target-type-id="${isFromSide ? def.entry_type_id_to : def.entry_type_id_from}"
                                data-target-type-label="${isFromSide ? def.entry_type_to_label : def.entry_type_from_label}"
                                data-allow-quantity="${def.allow_quantity_unit}"
                                ${!canAddMore ? 'disabled' : ''}
                                title="${canAddMore ? 'Add ' + (displayLabel || def.name) : 'Maximum entries reached'}">
                            <i class="fas fa-plus me-1"></i>Add
                        </button>
                    </div>
                    <div class="card-body">
                        ${relationships.length > 0 ? `
                            <table class="table table-sm table-hover mb-0">
                                <tbody>
                                    ${relationships.map(rel => renderRelationshipRow(rel, def)).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div class="text-center py-3 text-muted">
                                <small>No relationships yet. Click "Add" to create one.</small>
                            </div>
                        `}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Attach event listeners
        attachEventListeners();
    }
    
    function renderRelationshipRow(rel, def) {
        // Get contrasting text color for status badge
        const getContrastColor = (hexColor) => {
            if (!hexColor) return '#fff';
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000' : '#fff';
        };
        
        const statusColor = rel.related_entry_status_color || '#6c757d';
        const textColor = getContrastColor(statusColor);
        
        return `
            <tr class="relationship-item-row">
                <td>
                    <a href="/entry/${rel.related_entry_id}" class="relationship-link">
                        ${escapeHtml(rel.related_entry_title)}
                    </a>
                    ${rel.related_entry_status ? `
                        <span class="badge ms-2" style="background-color: ${statusColor}; color: ${textColor}; font-size: 0.75rem;">
                            ${escapeHtml(rel.related_entry_status)}
                        </span>
                    ` : ''}
                </td>
                ${def.allow_quantity_unit ? `
                    <td class="text-center" style="width: 150px;">
                        <small class="text-muted">
                            ${rel.quantity ? `${rel.quantity} ${rel.unit || ''}` : '-'}
                        </small>
                    </td>
                ` : ''}
                <td class="text-end" style="width: 100px;">
                    <div class="btn-group btn-group-sm">
                        ${def.allow_quantity_unit ? `
                            <button class="btn btn-outline-secondary btn-edit-quantity" 
                                    data-relationship-id="${rel.relationship_id}"
                                    data-quantity="${rel.quantity || ''}"
                                    data-unit="${rel.unit || ''}"
                                    title="Edit quantity/unit">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-outline-danger btn-delete-relationship" 
                                data-relationship-id="${rel.relationship_id}"
                                data-entry-title="${escapeHtml(rel.related_entry_title)}"
                                title="Delete relationship">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    function attachEventListeners() {
        // Add relationship buttons
        document.querySelectorAll('.btn-add-relationship').forEach(btn => {
            btn.addEventListener('click', function() {
                const definitionId = this.dataset.definitionId;
                const label = this.dataset.label;
                const targetTypeId = this.dataset.targetTypeId;
                const targetTypeLabel = this.dataset.targetTypeLabel;
                const allowQuantity = this.dataset.allowQuantity === 'true';
                
                openAddRelationshipModal(definitionId, label, targetTypeId, targetTypeLabel, allowQuantity);
            });
        });
        
        // Delete relationship buttons
        document.querySelectorAll('.btn-delete-relationship').forEach(btn => {
            btn.addEventListener('click', function() {
                const relationshipId = this.dataset.relationshipId;
                const entryTitle = this.dataset.entryTitle;
                deleteRelationship(relationshipId, entryTitle);
            });
        });
        
        // Edit quantity buttons
        document.querySelectorAll('.btn-edit-quantity').forEach(btn => {
            btn.addEventListener('click', function() {
                const relationshipId = this.dataset.relationshipId;
                const quantity = this.dataset.quantity;
                const unit = this.dataset.unit;
                editQuantity(relationshipId, quantity, unit);
            });
        });
    }
    
    function openAddRelationshipModal(definitionId, label, targetTypeId, targetTypeLabel, allowQuantity) {
        // Create and show modal
        const modalId = 'addRelModal_' + definitionId;
        
        // Remove existing modal if any
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
            existingModal.remove();
        }
        
        const modalHtml = `
            <div class="modal fade" id="${modalId}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-plus me-2"></i>
                                Add ${escapeHtml(label)}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Search existing entries -->
                            <div class="mb-3">
                                <label class="form-label">Search Existing ${escapeHtml(targetTypeLabel)}</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="searchEntry_${definitionId}"
                                       placeholder="Start typing to search...">
                                <div id="searchResults_${definitionId}" 
                                     class="list-group mt-2" 
                                     style="max-height: 200px; overflow-y: auto; display: none;">
                                </div>
                            </div>
                            
                            <div class="text-center my-3">
                                <span class="text-muted">— OR —</span>
                            </div>
                            
                            <!-- Create new entry -->
                            <div class="form-check mb-3">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="createNew_${definitionId}">
                                <label class="form-check-label" for="createNew_${definitionId}">
                                    Create a new ${escapeHtml(targetTypeLabel)} instead
                                </label>
                            </div>
                            
                            <div id="newEntryFields_${definitionId}" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Title *</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="newEntryTitle_${definitionId}"
                                           placeholder="Enter title">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" 
                                              id="newEntryDescription_${definitionId}"
                                              rows="3"
                                              placeholder="Optional description"></textarea>
                                </div>
                            </div>
                            
                            ${allowQuantity ? `
                                <hr class="my-3">
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" 
                                               step="any" 
                                               class="form-control" 
                                               id="quantity_${definitionId}"
                                               placeholder="e.g., 2.5">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Unit</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="unit_${definitionId}"
                                               placeholder="e.g., kg, cups">
                                    </div>
                                </div>
                            ` : ''}
                            
                            <input type="hidden" id="selectedEntryId_${definitionId}">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <button type="button" 
                                    class="btn btn-primary" 
                                    id="btnSubmit_${definitionId}">
                                <i class="fas fa-check me-1"></i>
                                Add Relationship
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById(modalId));
        modal.show();
        
        // Setup modal interactions
        setupModalInteractions(modalId, definitionId, targetTypeId, allowQuantity);
        
        // Cleanup on hide
        document.getElementById(modalId).addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }
    
    async function setupModalInteractions(modalId, definitionId, targetTypeId, allowQuantity) {
        const searchInput = document.getElementById(`searchEntry_${definitionId}`);
        const searchResults = document.getElementById(`searchResults_${definitionId}`);
        const createNewCheckbox = document.getElementById(`createNew_${definitionId}`);
        const newEntryFields = document.getElementById(`newEntryFields_${definitionId}`);
        const selectedEntryIdInput = document.getElementById(`selectedEntryId_${definitionId}`);
        const submitBtn = document.getElementById(`btnSubmit_${definitionId}`);
        
        // Get already related entry IDs for this definition to exclude them
        const alreadyRelatedIds = new Set();
        try {
            const relResponse = await fetch(`/api/entries/${entryId}/relationships`);
            const relationships = await relResponse.json();
            relationships.forEach(rel => {
                if (rel.definition_id == definitionId) {
                    alreadyRelatedIds.add(rel.related_entry_id);
                }
            });
            // Also exclude the current entry itself
            alreadyRelatedIds.add(parseInt(entryId));
            
            console.log('Excluded entry IDs for definition', definitionId, ':', Array.from(alreadyRelatedIds));
        } catch (error) {
            console.error('Error fetching existing relationships:', error);
        }
        
        let searchTimeout;
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/search_entries?q=${encodeURIComponent(query)}&entry_type_id=${targetTypeId}`);
                    const entries = await response.json();
                    
                    // Filter out already related entries
                    const availableEntries = entries.filter(entry => !alreadyRelatedIds.has(entry.id));
                    
                    if (availableEntries.length === 0) {
                        searchResults.innerHTML = '<div class="list-group-item text-muted">No available entries found</div>';
                    } else {
                        searchResults.innerHTML = availableEntries.map(entry => `
                            <button type="button" 
                                    class="list-group-item list-group-item-action search-result-item"
                                    data-entry-id="${entry.id}"
                                    data-entry-title="${escapeHtml(entry.title)}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>${escapeHtml(entry.title)}</span>
                                    <small class="badge bg-secondary">${escapeHtml(entry.status || 'Active')}</small>
                                </div>
                            </button>
                        `).join('');
                        
                        // Attach click handlers
                        document.querySelectorAll('.search-result-item').forEach(item => {
                            item.addEventListener('click', function() {
                                selectedEntryIdInput.value = this.dataset.entryId;
                                searchInput.value = this.dataset.entryTitle;
                                searchResults.style.display = 'none';
                                
                                // Uncheck create new
                                createNewCheckbox.checked = false;
                                newEntryFields.style.display = 'none';
                            });
                        });
                    }
                    
                    searchResults.style.display = 'block';
                } catch (error) {
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<div class="list-group-item text-danger">Search failed</div>';
                    searchResults.style.display = 'block';
                }
            }, 300);
        });
        
        // Create new toggle
        createNewCheckbox.addEventListener('change', function() {
            if (this.checked) {
                newEntryFields.style.display = 'block';
                searchInput.disabled = true;
                selectedEntryIdInput.value = '';
                searchResults.style.display = 'none';
            } else {
                newEntryFields.style.display = 'none';
                searchInput.disabled = false;
            }
        });
        
        // Submit
        submitBtn.addEventListener('click', async function() {
            const isCreatingNew = createNewCheckbox.checked;
            const quantity = allowQuantity ? document.getElementById(`quantity_${definitionId}`).value : null;
            const unit = allowQuantity ? document.getElementById(`unit_${definitionId}`).value : null;
            
            if (isCreatingNew) {
                const title = document.getElementById(`newEntryTitle_${definitionId}`).value.trim();
                const description = document.getElementById(`newEntryDescription_${definitionId}`).value.trim();
                
                if (!title) {
                    alert('Please enter a title for the new entry');
                    return;
                }
                
                await createNewAndLink(definitionId, title, description, quantity, unit);
            } else {
                const targetEntryId = selectedEntryIdInput.value;
                
                if (!targetEntryId) {
                    alert('Please search and select an entry, or choose to create a new one');
                    return;
                }
                
                await linkExisting(definitionId, targetEntryId, quantity, unit);
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
        });
    }
    
    async function linkExisting(definitionId, targetEntryId, quantity, unit) {
        try {
            const payload = {
                definition_id: parseInt(definitionId),
                related_entry_id: parseInt(targetEntryId)
            };
            
            if (quantity) payload.quantity = parseFloat(quantity);
            if (unit) payload.unit = unit;
            
            const response = await fetch(`/api/entries/${entryId}/relationships`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to create relationship');
            }
            
            // Reload relationships
            await loadRelationships();
            
            showNotification('Relationship created successfully', 'success');
        } catch (error) {
            console.error('Error creating relationship:', error);
            showNotification('Error: ' + error.message, 'danger');
        }
    }
    
    async function createNewAndLink(definitionId, title, description, quantity, unit) {
        try {
            const payload = {
                definition_id: parseInt(definitionId),
                name: title,
                description: description
            };
            
            if (quantity) payload.quantity = parseFloat(quantity);
            if (unit) payload.unit = unit;
            
            const response = await fetch(`/api/entries/${entryId}/relationships/new`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to create entry and relationship');
            }
            
            // Reload relationships
            await loadRelationships();
            
            showNotification('New entry created and linked successfully', 'success');
        } catch (error) {
            console.error('Error creating entry:', error);
            showNotification('Error: ' + error.message, 'danger');
        }
    }
    
    async function deleteRelationship(relationshipId, entryTitle) {
        if (!confirm(`Delete relationship with "${entryTitle}"?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/relationships/${relationshipId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete relationship');
            }
            
            await loadRelationships();
            showNotification('Relationship deleted', 'success');
        } catch (error) {
            console.error('Error deleting relationship:', error);
            showNotification('Error: ' + error.message, 'danger');
        }
    }
    
    async function editQuantity(relationshipId, currentQuantity, currentUnit) {
        const newQuantity = prompt('Enter quantity:', currentQuantity);
        if (newQuantity === null) return;
        
        const newUnit = prompt('Enter unit:', currentUnit);
        if (newUnit === null) return;
        
        try {
            const response = await fetch(`/api/relationships/${relationshipId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    quantity: parseFloat(newQuantity) || null,
                    unit: newUnit || null
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update quantity/unit');
            }
            
            await loadRelationships();
            showNotification('Quantity/unit updated', 'success');
        } catch (error) {
            console.error('Error updating quantity:', error);
            showNotification('Error: ' + error.message, 'danger');
        }
    }
    
    function showNotification(message, type) {
        // Simple notification - you can enhance this
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize on load
    loadRelationships();
})();
</script>
