<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - System Parameters</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ribbon.css') }}">
    
    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .container {
            margin-top: 30px;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid var(--bs-border-color);
        }
        .settings-section {
            margin-bottom: 2rem;
        }
        .section-card {
            background: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #6f42c1, #d63384);
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #6f42c1;
        }
        .form-control, .form-select {
            margin-bottom: 15px;
        }
        .preview-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bs-body-bg);
        }
        .logo-preview {
            max-width: 150px;
            max-height: 150px;
        }
        .btn-purple {
            background: linear-gradient(135deg, #6f42c1, #d63384);
            border: none;
            color: white;
        }
        .btn-purple:hover {
            background: linear-gradient(135deg, #5a359a, #b02a5b);
            color: white;
        }
        .bg-purple {
            background-color: #6f42c1 !important;
        }
        .text-purple {
            color: #6f42c1 !important;
        }
        .alert-purple {
            background-color: rgba(111, 66, 193, 0.1);
            border-color: rgba(111, 66, 193, 0.2);
            color: #6f42c1;
        }
        .alert-purple .fas {
            color: #6f42c1;
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Universal App Ribbon -->
    {% include 'components/ribbon.html' %}
    
    <div class="container">
        <div class="mb-4">
            <h1 class="mb-0">{{ project_name }} System Parameters</h1>
        </div>

        <!-- General Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-info-circle me-2"></i>General Settings
                </div>
                <form id="generalSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectName" class="form-label">Project Name:</label>
                                <input type="text" class="form-control" id="projectName" value="{{ params.project_name }}" placeholder="Enter project name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectSubtitle" class="form-label">Project Subtitle:</label>
                                <input type="text" class="form-control" id="projectSubtitle" value="{{ params.project_subtitle if params.project_subtitle else 'Management System' }}" placeholder="Enter project subtitle">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="entrySingularLabel" class="form-label">Entry Singular Label:</label>
                                <input type="text" class="form-control" id="entrySingularLabel" value="{{ params.entry_singular_label }}" placeholder="Entry">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="entryPluralLabel" class="form-label">Entry Plural Label:</label>
                                <input type="text" class="form-control" id="entryPluralLabel" value="{{ params.entry_plural_label }}" placeholder="Entries">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sensor Feature Toggle -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="fas fa-thermometer-half me-2"></i>Sensor Functionality</h6>
                                        <small>Enable or disable sensor features across the entire application. When disabled, all sensor-related UI elements will be hidden.</small>
                                    </div>
                                    <div class="form-check form-switch ms-3">
                                        <input class="form-check-input" type="checkbox" role="switch" id="enableSensorsToggle" style="width: 3rem; height: 1.5rem;">
                                        <label class="form-check-label ms-2 fw-bold" for="enableSensorsToggle" id="sensorToggleLabel">Loading...</label>
                                    </div>
                                </div>
                                
                                <!-- Sensor Master Control Sub-toggle -->
                                <div id="sensorMasterControlContainer" class="mt-3 pt-3 border-top border-info-subtle" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1"><i class="fas fa-microchip me-2"></i>Sensor Master Control</h6>
                                            <small>Enable the Sensor Master Control interface for centralized ESP32 configuration.</small>
                                        </div>
                                        <div class="form-check form-switch ms-3">
                                            <input class="form-check-input" type="checkbox" role="switch" id="enableSensorMasterControlToggle" style="width: 2.5rem; height: 1.25rem;">
                                            <label class="form-check-label ms-2" for="enableSensorMasterControlToggle" id="sensorMasterControlToggleLabel">Disabled</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kanban Feature Toggle -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-purple">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="fas fa-columns me-2"></i>Kanban Functionality</h6>
                                        <small>Enable or disable Kanban boards across the entire application. When disabled, the Kanban menu item will be hidden.</small>
                                    </div>
                                    <div class="form-check form-switch ms-3">
                                        <input class="form-check-input" type="checkbox" role="switch" id="enableKanbanToggle" style="width: 3rem; height: 1.5rem;">
                                        <label class="form-check-label ms-2 fw-bold" for="enableKanbanToggle" id="kanbanToggleLabel">Loading...</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-purple">
                        <i class="fas fa-save me-1"></i>Save General Settings
                    </button>
                </form>
                <div id="generalStatusMessage" class="mt-3 d-none"></div>
            </div>
        </div>

        <!-- AI Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-brain me-2"></i>AI Integration Settings
                </div>
                <div class="mb-3">
                    <p class="text-muted">Configure AI services for writing assistance with descriptions, notes, SQL queries, and diagrams.</p>
                </div>
                
                <!-- AI Configuration Tabs -->
                <ul class="nav nav-tabs mb-3" id="aiConfigTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" 
                                id="services-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#services-panel" 
                                type="button" 
                                role="tab"
                                aria-controls="services-panel"
                                aria-selected="true">
                            <i class="fas fa-cogs"></i> AI Services
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" 
                                id="prompts-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#prompts-panel" 
                                type="button" 
                                role="tab"
                                aria-controls="prompts-panel"
                                aria-selected="false">
                            <i class="fas fa-comment-dots"></i> System Prompts
                        </button>
                    </li>
                </ul>

                <form id="aiSettingsForm">
                <div class="tab-content" id="aiConfigTabContent">
                    <!-- AI Services Tab -->
                    <div class="tab-pane fade show active" 
                         id="services-panel" 
                         role="tabpanel"
                         aria-labelledby="services-tab">
                        
                        <!-- AI Services Status -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label">AI Services Status:</label>
                                <div id="aiServiceStatus" class="mt-2">
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Checking...
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- AI Service Selector -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="aiServiceSelector" class="form-label">
                                    <i class="fas fa-robot me-1"></i>Select AI Service to Configure:
                                </label>
                                <select class="form-select" id="aiServiceSelector" onchange="switchAiServiceSettings()">
                                    <option value="gemini">Google Gemini (Primary AI Service)</option>
                                    <option value="groq">Groq (Diagram Generation - Optional)</option>
                                    <option value="huggingface">Hugging Face (Image Generation - Free!)</option>
                                </select>
                                <small class="text-muted">Choose which AI service you want to configure</small>
                            </div>
                        </div>

                    <!-- Gemini Settings -->
                    <div id="geminiSettings" class="ai-service-settings">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Google Gemini</strong> is the primary AI service for content generation, writing assistance, and natural language processing.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="geminiApiKey" class="form-label">
                                        <i class="fas fa-key me-1"></i>Google Gemini API Key:
                                        {% if params.gemini_api_key %}
                                        <span class="badge bg-success ms-2">
                                            <i class="fas fa-check-circle me-1"></i>Configured
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning ms-2">
                                            <i class="fas fa-exclamation-circle me-1"></i>Not Set
                                        </span>
                                        {% endif %}
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="geminiApiKey" 
                                               value="{{ params.gemini_api_key if params.gemini_api_key else '' }}" 
                                               placeholder="Enter your Google Gemini API key">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('geminiApiKey', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        Get your API key from 
                                        <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-decoration-none">
                                            Google AI Studio <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="geminiModelName" class="form-label">
                                        <i class="fas fa-brain me-1"></i>Gemini Model:
                                    </label>
                                    <select class="form-select" id="geminiModelName">
                                        <option value="">Loading models...</option>
                                    </select>
                                    <small class="text-muted" id="modelDescription">
                                        Select a Gemini AI model for content generation
                                    </small>
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            <a href="https://ai.google.dev/gemini-api/docs/models/gemini" target="_blank" class="text-decoration-none">
                                                View all models documentation <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>

                    <!-- Groq Settings -->
                    <div id="groqSettings" class="ai-service-settings" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Groq</strong> is recommended for diagram generation. It has no rate limits and no safety filters for technical content, making it ideal for generating Draw.io diagrams.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="groqApiKey" class="form-label">
                                        <i class="fas fa-key me-1"></i>Groq API Key:
                                        {% if params.groq_api_key %}
                                        <span class="badge bg-success ms-2">
                                            <i class="fas fa-check-circle me-1"></i>Configured
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning ms-2">
                                            <i class="fas fa-exclamation-circle me-1"></i>Not Set
                                        </span>
                                        {% endif %}
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="groqApiKey" 
                                               value="{{ params.groq_api_key if params.groq_api_key else '' }}" 
                                               placeholder="Enter your Groq API key">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('groqApiKey', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        Get your free API key from 
                                        <a href="https://console.groq.com" target="_blank" class="text-decoration-none">
                                            Groq Console <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="groqModelName" class="form-label">
                                        <i class="fas fa-brain me-1"></i>Groq Model:
                                    </label>
                                    <select class="form-select" id="groqModelName">
                                        <option value="llama-3.3-70b-versatile" {{ 'selected' if params.groq_model_name == 'llama-3.3-70b-versatile' or not params.groq_model_name else '' }}>Llama 3.3 70B Versatile (Recommended)</option>
                                        <option value="llama-3.1-70b-versatile" {{ 'selected' if params.groq_model_name == 'llama-3.1-70b-versatile' else '' }}>Llama 3.1 70B Versatile</option>
                                        <option value="llama-3.1-8b-instant" {{ 'selected' if params.groq_model_name == 'llama-3.1-8b-instant' else '' }}>Llama 3.1 8B Instant (Fastest)</option>
                                        <option value="mixtral-8x7b-32768" {{ 'selected' if params.groq_model_name == 'mixtral-8x7b-32768' else '' }}>Mixtral 8x7B (Long Context)</option>
                                        <option value="gemma2-9b-it" {{ 'selected' if params.groq_model_name == 'gemma2-9b-it' else '' }}>Gemma 2 9B</option>
                                    </select>
                                    <small class="text-muted" id="groqModelDescription">
                                        Most capable model for complex diagram generation
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> If Groq is not configured, diagram generation will fall back to using Gemini, which may have safety filter issues with technical diagrams.
                        </div>
                    </div>

                    <!-- Hugging Face Settings -->
                    <div id="huggingfaceSettings" class="ai-service-settings" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Hugging Face</strong> offers FREE API access for image generation! Perfect for creating custom wallpapers and backgrounds.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="huggingfaceApiKey" class="form-label">
                                        <i class="fas fa-key me-1"></i>Hugging Face API Token (FREE):
                                        {% if params.huggingface_api_key %}
                                        <span class="badge bg-success ms-2">
                                            <i class="fas fa-check-circle me-1"></i>Configured
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning ms-2">
                                            <i class="fas fa-exclamation-circle me-1"></i>Not Set
                                        </span>
                                        {% endif %}
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="huggingfaceApiKey" 
                                               value="{{ params.huggingface_api_key if params.huggingface_api_key else '' }}" 
                                               placeholder="Enter your Hugging Face API token">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('huggingfaceApiKey', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        Get your free token from 
                                        <a href="https://huggingface.co/settings/tokens" target="_blank" class="text-decoration-none">
                                            Hugging Face Settings <i class="fas fa-external-link-alt"></i>
                                        </a>
                                        - 100% free, no credit card required!
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="huggingfaceModel" class="form-label">
                                        <i class="fas fa-brain me-1"></i>Image Generation Model:
                                    </label>
                                    <select class="form-select" id="huggingfaceModel">
                                        <option value="stabilityai/stable-diffusion-xl-base-1.0" {{ 'selected' if params.huggingface_model == 'stabilityai/stable-diffusion-xl-base-1.0' or not params.huggingface_model else '' }}>Stable Diffusion XL Base 1.0 ‚≠ê (Recommended)</option>
                                        <option value="black-forest-labs/FLUX.1-schnell" {{ 'selected' if params.huggingface_model == 'black-forest-labs/FLUX.1-schnell' else '' }}>FLUX.1 Schnell (Fast, High Quality)</option>
                                        <option value="stabilityai/stable-diffusion-2-1" {{ 'selected' if params.huggingface_model == 'stabilityai/stable-diffusion-2-1' else '' }}>Stable Diffusion 2.1 (Balanced)</option>
                                        <option value="runwayml/stable-diffusion-v1-5" {{ 'selected' if params.huggingface_model == 'runwayml/stable-diffusion-v1-5' else '' }}>Stable Diffusion v1.5 (Legacy)</option>
                                        <option value="prompthero/openjourney-v4" {{ 'selected' if params.huggingface_model == 'prompthero/openjourney-v4' else '' }}>OpenJourney v4 (Artistic)</option>
                                        <option value="CompVis/stable-diffusion-v1-4" {{ 'selected' if params.huggingface_model == 'CompVis/stable-diffusion-v1-4' else '' }}>Stable Diffusion v1.4 (Classic)</option>
                                    </select>
                                    <small class="text-muted">
                                        Models with ‚≠ê are tested and work reliably. Others may have loading times or require PRO tokens.
                                    </small>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="huggingfaceImageSize" class="form-label">
                                        <i class="fas fa-arrows-alt me-1"></i>Image Size:
                                    </label>
                                    <select class="form-select" id="huggingfaceImageSize">
                                        <option value="1024x576" {{ 'selected' if params.huggingface_image_size == '1024x576' or not params.huggingface_image_size else '' }}>1024x576 (16:9 Landscape)</option>
                                        <option value="1280x720" {{ 'selected' if params.huggingface_image_size == '1280x720' else '' }}>1280x720 (HD)</option>
                                        <option value="768x768" {{ 'selected' if params.huggingface_image_size == '768x768' else '' }}>768x768 (Square)</option>
                                        <option value="512x512" {{ 'selected' if params.huggingface_image_size == '512x512' else '' }}>512x512 (Fast)</option>
                                    </select>
                                    <small class="text-muted">
                                        Larger = better quality, slower generation
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>How to get your token:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Go to <a href="https://huggingface.co/join" target="_blank">huggingface.co/join</a> and create free account</li>
                                <li>Visit <a href="https://huggingface.co/settings/tokens" target="_blank">Settings ‚Üí Access Tokens</a></li>
                                <li>Click "New token" ‚Üí Select "Read" role ‚Üí Create</li>
                                <li>Copy the token and paste it above</li>
                            </ol>
                        </div>
                        
                        <div class="alert alert-success">
                            <i class="fas fa-gift me-2"></i>
                            <strong>100% FREE:</strong> No rate limits, no credit card, unlimited generations!
                        </div>
                    </div>

                    </div> <!-- End AI Services panel -->

                    <!-- System Prompts Tab -->
                    <div class="tab-pane fade" 
                         id="prompts-panel" 
                         role="tabpanel"
                         aria-labelledby="prompts-tab">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>System Prompts</strong> control how the AI behaves in different contexts. Customize these to fine-tune AI responses for your specific use case.
                        </div>
                        
                        <!-- Prompt Selector -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="promptSelector" class="form-label">
                                    <i class="fas fa-list me-1"></i>Select Prompt to Edit:
                                </label>
                                <select class="form-select" id="promptSelector" onchange="switchPromptEditor()">
                                    <option value="base">Base Prompt (General Context)</option>
                                    <option value="description">Description Generation</option>
                                    <option value="note">Note Generation</option>
                                    <option value="sql">SQL Query Generation</option>
                                    <option value="theme">Theme Generation</option>
                                    <option value="chat">Entry Chat Assistant</option>
                                    <option value="diagram">Diagram Generation</option>
                                    <option value="summary">Dashboard Summary</option>
                                </select>
                                <small class="text-muted">Choose which prompt you want to customize</small>
                            </div>
                        </div>

                        <!-- Base Prompt Editor -->
                        <div id="promptEditor_base" class="prompt-editor-section">
                            <div class="mb-3">
                                <label for="geminiBasePrompt" class="form-label">
                                    <i class="fas fa-comment-alt me-1"></i>Base Prompt (General Context):
                                </label>
                                <textarea class="form-control font-monospace" id="geminiBasePrompt" rows="6" 
                                          placeholder="Provide context or instructions that will be included with every AI request">{{ params.gemini_base_prompt if params.gemini_base_prompt else 'You are a helpful assistant for a project management application. Please provide clear, concise, and well-structured responses.' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> This is prepended to all AI requests to provide consistent context.<br>
                                    <strong>Used in:</strong> All AI functions<br>
                                    <strong>Variables:</strong> None (this is the foundation for all other prompts)
                                </small>
                            </div>
                        </div>

                        <!-- Description Prompt Editor -->
                        <div id="promptEditor_description" class="prompt-editor-section" style="display: none;">
                            <div class="mb-3">
                                <label for="promptDescription" class="form-label">
                                    <i class="fas fa-align-left me-1"></i>Description Generation Prompt:
                                </label>
                                <textarea class="form-control font-monospace" id="promptDescription" rows="8" 
                                          placeholder="Prompt used when generating entry descriptions">{{ params.prompt_description if params.prompt_description else 'Task: Generate a concise, informative description for a {entry_type} named "{title}".\n\nRequirements:\n- Be factual and informative\n- Include relevant details for a database/inventory system\n- Use professional, neutral tone\n- Use Markdown formatting when helpful\n- Use hyphens (-) for bullet lists\n\nReturn ONLY the description content.' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> Controls how AI generates descriptions for entries<br>
                                    <strong>Used in:</strong> "Generate with AI" button on entry descriptions<br>
                                    <strong>Variables:</strong> <code>{title}</code>, <code>{entry_type}</code>, <code>{context}</code>
                                </small>
                            </div>
                        </div>
                        
                        <!-- Note Prompt Editor -->
                        <div id="promptEditor_note" class="prompt-editor-section" style="display: none;">
                            <div class="mb-3">
                                <label for="promptNote" class="form-label">
                                    <i class="fas fa-sticky-note me-1"></i>Note Generation Prompt:
                                </label>
                                <textarea class="form-control font-monospace" id="promptNote" rows="8" 
                                          placeholder="Prompt used when generating notes">{{ params.prompt_note if params.prompt_note else 'Task: Generate content for a {note_type} note.\n\nEntry Title: {title}\nEntry Type: {entry_type}\nNote Type: {note_type}\n\nGuidelines:\n- Create relevant and useful content appropriate for a {note_type} note\n- Make it specific to the entry\n- Keep the tone and format appropriate for the note type\n- Be concise but informative' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> Controls how AI generates note content<br>
                                    <strong>Used in:</strong> "Generate with AI" button in note composer<br>
                                    <strong>Variables:</strong> <code>{title}</code>, <code>{entry_type}</code>, <code>{note_type}</code>, <code>{context}</code>
                                </small>
                            </div>
                        </div>
                        
                        <!-- SQL Prompt Editor -->
                        <div id="promptEditor_sql" class="prompt-editor-section" style="display: none;">
                            <div class="mb-3">
                                <label for="promptSql" class="form-label">
                                    <i class="fas fa-database me-1"></i>SQL Query Generation Prompt:
                                </label>
                                <textarea class="form-control font-monospace" id="promptSql" rows="8" 
                                          placeholder="Prompt used when generating SQL queries">{{ params.prompt_sql if params.prompt_sql else 'Task: Generate a SQL query based on this description: "{description}"\n\nRequirements:\n- Generate valid SQL syntax\n- Use appropriate SELECT, WHERE, JOIN, GROUP BY, ORDER BY clauses as needed\n- Include comments for complex parts\n- Optimize for readability\n- Return only the SQL query, properly formatted' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> Controls how AI generates SQL queries from natural language<br>
                                    <strong>Used in:</strong> SQL query generation in dashboard search<br>
                                    <strong>Variables:</strong> <code>{description}</code>, <code>{table_info}</code>
                                </small>
                            </div>
                        </div>
                        
                        <!-- Theme Prompt Editor -->
                        <div id="promptEditor_theme" class="prompt-editor-section" style="display: none;">
                            <div class="mb-3">
                                <label for="promptTheme" class="form-label">
                                    <i class="fas fa-palette me-1"></i>Theme Generation Prompt:
                                </label>
                                <textarea class="form-control font-monospace" id="promptTheme" rows="8" 
                                          placeholder="Prompt used when generating themes">{{ params.prompt_theme if params.prompt_theme else 'You are a theme generation system. Your ONLY job is to generate theme color JSON based on user requests.\n\nYou must ALWAYS respond with ONLY valid JSON in the exact format specified.\n\nUser request: "{user_message}"\n\nGenerate a complete theme with colors for both light and dark modes.' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> Controls how AI generates color themes<br>
                                    <strong>Used in:</strong> Theme generation in appearance settings<br>
                                    <strong>Variables:</strong> <code>{user_message}</code>, <code>{conversation_context}</code>, <code>{current_theme_info}</code>
                                </small>
                            </div>
                        </div>
                        
                        <!-- Chat Prompt Editor -->
                        <div id="promptEditor_chat" class="prompt-editor-section" style="display: none;">
                            <div class="mb-3">
                                <label for="promptChat" class="form-label">
                                    <i class="fas fa-comments me-1"></i>Entry Chat Assistant Prompt:
                                </label>
                                <textarea class="form-control font-monospace" id="promptChat" rows="8" 
                                          placeholder="Prompt used when chatting about entries">{{ params.prompt_chat if params.prompt_chat else 'You are an AI assistant helping with {project_desc}.\n\nCurrent Date/Time: {current_datetime}\n\nYou are discussing Entry: {title} (Type: {entry_type}, Status: {status})\n\nProvide helpful, contextual responses based on the entry details and notes available.' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> Controls how AI responds in entry-specific conversations<br>
                                    <strong>Used in:</strong> Chat interface within entry details<br>
                                    <strong>Variables:</strong> <code>{project_desc}</code>, <code>{current_datetime}</code>, <code>{title}</code>, <code>{entry_type}</code>, <code>{status}</code>, and many more entry-specific variables
                                </small>
                            </div>
                        </div>
                        
                        <!-- Diagram Prompt Editor -->
                        <div id="promptEditor_diagram" class="prompt-editor-section" style="display: none;">
                            <div class="mb-3">
                                <label for="promptDiagram" class="form-label">
                                    <i class="fas fa-project-diagram me-1"></i>Diagram Generation Prompt:
                                </label>
                                <textarea class="form-control font-monospace" id="promptDiagram" rows="10" 
                                          placeholder="Prompt used when generating Draw.io diagrams">{{ params.prompt_diagram if params.prompt_diagram else 'You are an expert at creating Draw.io diagrams using mxGraph XML format for educational and documentation purposes.\n\nContext: You are helping users create technical diagrams for project documentation, learning materials, and system design.\n\nYour Task: Generate valid mxGraph XML based on user requests. Be creative but ensure:\n1. All cell IDs are unique\n2. Proper parent-child relationships\n3. Reasonable positioning and sizing\n4. Appropriate colors and styles\n5. Clear, readable labels' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> Controls how AI generates Draw.io diagram XML<br>
                                    <strong>Used in:</strong> Diagram generation in Draw.io sections<br>
                                    <strong>Variables:</strong> None (user request is passed directly)<br>
                                    <strong>Note:</strong> This prompt includes extensive XML structure guidance
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="promptDiagramRules" class="form-label">
                                    <i class="fas fa-ruler me-1"></i>Diagram Structure Rules:
                                </label>
                                <textarea class="form-control font-monospace" id="promptDiagramRules" rows="12" 
                                          placeholder="Additional rules for diagram structure (applied when examples are available)">{{ params.prompt_diagram_rules if params.prompt_diagram_rules else '' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> Provides specific structural rules for diagram generation<br>
                                    <strong>Used in:</strong> Diagram discussion and generation when examples are provided<br>
                                    <strong>Variables:</strong> None<br>
                                    <strong>Note:</strong> These rules are appended after example diagrams to guide structural patterns (e.g., wire routing, connection points, color conventions). Edit this to customize how AI interprets and replicates diagram structures.
                                </small>
                            </div>
                        </div>

                        <!-- Summary Prompt Editor -->
                        <div id="promptEditor_summary" class="prompt-editor-section" style="display: none;">
                            <div class="mb-3">
                                <label for="promptSummary" class="form-label">
                                    <i class="fas fa-chart-line me-1"></i>Dashboard Summary Prompt:
                                </label>
                                <textarea class="form-control font-monospace" id="promptSummary" rows="15" 
                                          placeholder="Prompt used when generating dashboard AI summaries">{{ params.prompt_summary if params.prompt_summary else 'You are analyzing a project management dashboard. Provide an insightful, actionable summary.\n\n**Dataset Overview:**\n- Collection: "{search_name}"\n- Total Items: {total_entries}\n- Entry Type: {entry_type}\n\n**Current State Breakdown:**\n{state_distribution}\n\n**Age Analysis (Top 10 Oldest):**\n{age_data}\n\n**Recent Entries (Sample):**\n{entry_samples}\n\n**Sensor Monitoring:**\n{sensor_insights}\n\n**Recent Activity Notes:**\n{note_samples}\n\n**Please provide a well-structured summary with:**\n\n1. **üìä Overview & Status** - Current state of the collection\n2. **‚è±Ô∏è Timeline Insights** - Items that may need attention\n3. **üî¨ Sensor Analysis** - Trends and anomalies if available\n4. **‚ö†Ô∏è Action Items** - Specific recommendations\n5. **‚úÖ Progress Highlights** - Recent milestones\n\nFormat using markdown with emojis for readability. Keep it concise (4-6 short paragraphs).' }}</textarea>
                                <small class="text-muted">
                                    <strong>Purpose:</strong> Controls how AI summarizes dashboard widget data<br>
                                    <strong>Used in:</strong> Dashboard AI Summary widgets<br>
                                    <strong>Variables:</strong> <code>{search_name}</code>, <code>{total_entries}</code>, <code>{entry_type}</code>, <code>{state_distribution}</code>, <code>{age_data}</code>, <code>{entry_samples}</code>, <code>{sensor_insights}</code>, <code>{note_samples}</code><br>
                                    <strong>Note:</strong> This prompt analyzes collections and provides actionable insights
                                </small>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> System prompts use template variables like <code>{title}</code>, <code>{entry_type}</code>, etc. These are automatically replaced with actual values when used. Modify carefully to maintain functionality.
                        </div>
                    </div>

                </div> <!-- End tab-content -->

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-purple me-2">
                                <i class="fas fa-save me-1"></i>Save AI Settings
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="testAiService()">
                                <i class="fas fa-check-circle me-1"></i>Test Connection
                            </button>
                        </div>
                    </div>
                </form>
                <div id="aiStatusMessage" class="mt-3 d-none"></div>
                
                <!-- AI Features Info -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6><i class="fas fa-magic me-2"></i>Available AI Features:</h6>
                    <ul class="mb-0">
                        <li><strong>Entry Descriptions:</strong> Generate and improve descriptions for entries</li>
                        <li><strong>SQL Assistance:</strong> Generate SQL queries and explanations in the SQL IDE</li>
                        <li><strong>Note Enhancement:</strong> Improve existing notes for clarity and structure</li>
                    </ul>
                </div>
            </div>
        </div>





        <!-- Git Integration Settings (token-based discovery) -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fab fa-git-alt me-2"></i>Git Integration
                </div>
                
                <!-- Enable/Disable Toggle -->
                <div class="mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="gitIntegrationEnabled">
                        <label class="form-check-label" for="gitIntegrationEnabled">
                            <strong>Enable Git Integration</strong>
                        </label>
                    </div>
                    <small class="text-muted">Track commits from GitHub or GitLab repositories</small>
                </div>
                
                <!-- Configuration Form (shown when enabled) -->
                <div id="gitConfigSection" style="display:none;">
                    <form id="gitSettingsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gitProvider" class="form-label">Git Provider</label>
                                    <select class="form-select" id="gitProvider">
                                        <option value="">-- Select Provider --</option>
                                        <option value="github">GitHub</option>
                                        <option value="gitlab">GitLab</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6" id="gitlabUrlSection" style="display:none;">
                                <div class="mb-3">
                                    <label for="gitlabUrl" class="form-label">GitLab URL</label>
                                    <input type="text" class="form-control" id="gitlabUrl" placeholder="https://gitlab.com">
                                    <small class="text-muted">For self-hosted instances</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="gitToken" class="form-label">Personal Access Token</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="gitToken" placeholder="Enter your personal access token">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleTokenVisibility">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        Token needs read access to repositories. 
                                        <a href="#" id="tokenHelpLink" target="_blank">How to create?</a>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary me-2" id="saveGitConfigBtn">
                                <i class="fas fa-save me-1"></i>Save Configuration
                            </button>
                            <button type="button" class="btn btn-secondary" id="discoverReposBtn" disabled>
                                <i class="fas fa-search me-1"></i>Discover Repositories
                            </button>
                        </div>
                        
                        <div id="discoveredRepos" class="mt-4" style="display:none;">
                            <h6 class="mb-3">Discovered Repositories</h6>
                            <div class="list-group" id="reposList" style="max-height: 400px; overflow-y: auto;"></div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-success" id="saveTrackedReposBtn">
                                    <i class="fas fa-save me-1"></i>Save Tracked Repositories
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Tracked Repositories Configuration -->
                    <div class="mt-4" id="trackedReposConfig" style="display: none;">
                        <h6 class="mb-3">Tracked Repositories Configuration</h6>
                        <div id="trackedReposList"></div>
                    </div>
                </div>
                
                <div id="gitSettingsStatus" class="mt-3 d-none"></div>
            </div>
        </div>

        <!-- Strava Integration Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fab fa-strava me-2"></i>Strava Integration
                </div>
                
                <form id="stravaSettingsForm">
                    <!-- Enable/Disable Toggle -->
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="stravaEnabled" 
                                   {% if params.strava_enabled == 'true' or params.strava_enabled == '1' %}checked{% endif %}>
                            <label class="form-check-label" for="stravaEnabled">
                                <strong>Enable Strava Integration</strong>
                            </label>
                        </div>
                        <small class="text-muted">Sync activities from Strava</small>
                    </div>
                    
                    <!-- Configuration Form (shown when enabled) -->
                    <div id="stravaConfigSection" style="display: {% if params.strava_enabled == 'true' or params.strava_enabled == '1' %}block{% else %}none{% endif %};">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stravaClientId" class="form-label">Client ID</label>
                                    <input type="text" class="form-control" id="stravaClientId" 
                                           value="{{ params.strava_client_id or '' }}" placeholder="Enter Strava Client ID">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stravaClientSecret" class="form-label">Client Secret</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="stravaClientSecret" 
                                               value="{{ params.strava_client_secret or '' }}" placeholder="Enter Strava Client Secret">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleStravaSecretVisibility">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Connection Status</label>
                                    {% if params.strava_access_token %}
                                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-check-circle me-2"></i>
                                                Connected as <strong>{{ params.strava_athlete_name or 'Athlete' }}</strong>
                                                {% if params.strava_last_sync_time %}
                                                    <br><small class="text-muted">Last synced: <span class="local-time" data-timestamp="{{ params.strava_last_sync_time }}"></span></small>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-primary btn-sm me-2" id="syncStravaBtn">
                                                    <i class="fas fa-sync me-1"></i>Sync Now
                                                </button>
                                                <!-- Disconnect is a separate action, keep it outside the main form submission or handle carefully -->
                                                <button type="button" class="btn btn-danger btn-sm" onclick="document.getElementById('disconnectStravaForm').submit();">Disconnect</button>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-secondary">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    Connect your Strava account to sync activities.
                                                </div>
                                                {% if params.strava_client_id and params.strava_client_secret %}
                                                    <a href="{{ url_for('strava_routes.strava_login') }}" class="btn btn-warning">
                                                        <i class="fab fa-strava me-2"></i>Connect with Strava
                                                    </a>
                                                {% else %}
                                                    <button type="button" class="btn btn-warning" disabled title="Please save Client ID and Secret first">
                                                        <i class="fab fa-strava me-2"></i>Connect with Strava
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced: Manual Token Entry (Hidden by default) -->
                        <div class="mb-3">
                            <button class="btn btn-link btn-sm p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#manualStravaToken" aria-expanded="false">
                                <i class="fas fa-cog me-1"></i>Advanced: Manual Token Configuration
                            </button>
                        </div>
                        
                        <div class="collapse" id="manualStravaToken">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="stravaRefreshToken" class="form-label">Refresh Token</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="stravaRefreshToken" 
                                                   value="{{ params.strava_refresh_token or '' }}" placeholder="Enter Strava Refresh Token">
                                            <button class="btn btn-outline-secondary" type="button" id="toggleStravaTokenVisibility">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">
                                            Used to obtain access tokens. 
                                            <a href="https://www.strava.com/settings/api" target="_blank">Get API Credentials</a>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Mapping Section -->
                        <div class="mt-4 border-top pt-3">
                            <h6><i class="fas fa-exchange-alt me-2"></i>Activity Type Mapping</h6>
                            <p class="text-muted small">Map Strava activity types to your system's Entry Types.</p>
                            
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless align-middle">
                                    <thead>
                                        <tr>
                                            <th style="width: 40%">Strava Activity</th>
                                            <th>Entry Type</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stravaMappingTable">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 mt-3">
                        <button type="submit" class="btn btn-primary" id="saveStravaConfigBtn">
                            <i class="fas fa-save me-1"></i>Save Strava Configuration
                        </button>
                    </div>
                </form>
                
                <!-- Hidden form for disconnect -->
                <form id="disconnectStravaForm" action="{{ url_for('strava_routes.strava_disconnect') }}" method="POST" style="display:none;"></form>
                
                <div id="stravaSettingsStatus" class="mt-3 d-none"></div>
            </div>
        </div>

        <!-- Label Printing Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-print me-2"></i>Label Printing Settings
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Label Settings</h5>
                        <div class="mb-3">
                            <label for="settingsPrinterType" class="form-label">Printer Type:</label>
                            <select class="form-select" id="settingsPrinterType">
                                <option value="8_labels">8 Labels (2x4) - A4 Sheet</option>
                                <option value="14_labels">14 Labels (2x7) - A4 Sheet</option>
                                <option value="niimbot_b1" selected>Niimbot B1</option>
                                <option value="niimbot_d110">Niimbot D110</option>
                            </select>
                        </div>
                        <div class="mb-3" id="labelSizeContainer">
                            <label for="settingsLabelSize" class="form-label">Configure Settings For Label Size:</label>
                            <select class="form-select" id="settingsLabelSize">
                                <!-- Populated dynamically based on printer type -->
                            </select>
                            <div class="form-text">Each label size can have its own font sizes, borders, and layout</div>
                        </div>
                        <div class="mb-3" id="labelRotationContainer">
                            <label for="settingsLabelRotation" class="form-label">Label Orientation:</label>
                            <select class="form-select" id="settingsLabelRotation">
                                <option value="0">Portrait (0¬∞)</option>
                                <option value="90">Landscape (90¬∞ Rotation)</option>
                            </select>
                            <div class="form-text">Configure separate settings for portrait and landscape orientations</div>
                        </div>
                        
                        <form id="labelSettingsForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Body Font Size (pt):</label>
                                    <input type="number" class="form-control label-setting" id="labelFontSize" 
                                           data-60x30mm="{{ params.label_60x30mm_font_size or '8' }}"
                                           data-50x14mm="{{ params.label_50x14mm_font_size or '7' }}"
                                           data-40x12mm="{{ params.label_40x12mm_font_size or '6' }}"
                                           data-30x15mm="{{ params.label_30x15mm_font_size or '7' }}"
                                           data-default="{{ params.label_font_size or '10' }}"
                                           value="{{ params.label_60x30mm_font_size or '8' }}" min="6" max="16" step="1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Title Font Size (pt):</label>
                                    <input type="number" class="form-control label-setting" id="labelTitleFontSize" 
                                           data-60x30mm="{{ params.label_60x30mm_title_font_size or '12' }}"
                                           data-50x14mm="{{ params.label_50x14mm_title_font_size or '10' }}"
                                           data-40x12mm="{{ params.label_40x12mm_title_font_size or '9' }}"
                                           data-30x15mm="{{ params.label_30x15mm_title_font_size or '10' }}"
                                           data-default="{{ params.label_title_font_size or '14' }}"
                                           value="{{ params.label_60x30mm_title_font_size or '12' }}" min="8" max="24" step="1">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Border Style:</label>
                                <select class="form-select label-setting" id="labelBorderStyle"
                                        data-60x30mm="{{ params.label_60x30mm_border_style or 'simple' }}"
                                        data-50x14mm="{{ params.label_50x14mm_border_style or 'none' }}"
                                        data-40x12mm="{{ params.label_40x12mm_border_style or 'none' }}"
                                        data-30x15mm="{{ params.label_30x15mm_border_style or 'simple' }}"
                                        data-default="{{ params.label_border_style or 'simple' }}">
                                    <option value="none">No Border</option>
                                    <option value="simple" selected>Simple Line</option>
                                    <option value="thick">Thick Line</option>
                                    <option value="double">Double Line</option>
                                    <option value="rounded">Rounded Corners</option>
                                    <option value="dashed">Dashed Line</option>
                                    <option value="dotted">Dotted Line</option>
                                    <option value="decorative">Decorative Corners</option>
                                    <option value="shadow">Drop Shadow</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input label-setting" type="checkbox" id="labelIncludeQr"
                                           data-60x30mm="{{ params.label_60x30mm_include_qr_code or 'true' }}"
                                           data-50x14mm="{{ params.label_50x14mm_include_qr_code or 'false' }}"
                                           data-40x12mm="{{ params.label_40x12mm_include_qr_code or 'false' }}"
                                           data-30x15mm="{{ params.label_30x15mm_include_qr_code or 'true' }}"
                                           data-default="{{ params.label_include_qr_code or 'true' }}"
                                           checked>
                                    <label class="form-check-label">
                                        Include QR Code on labels
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">QR Code Size:</label>
                                <select class="form-select label-setting" id="labelQrSize"
                                        data-60x30mm="{{ params.label_60x30mm_qr_size or 'medium' }}"
                                        data-50x14mm="{{ params.label_50x14mm_qr_size or 'small' }}"
                                        data-40x12mm="{{ params.label_40x12mm_qr_size or 'small' }}"
                                        data-30x15mm="{{ params.label_30x15mm_qr_size or 'small' }}"
                                        data-default="{{ params.label_qr_size or 'medium' }}">
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">QR Code Position:</label>
                                <select class="form-select label-setting" id="labelQrPosition"
                                        data-60x30mm="{{ params.label_60x30mm_qr_position or 'right' }}"
                                        data-50x14mm="{{ params.label_50x14mm_qr_position or 'right' }}"
                                        data-40x12mm="{{ params.label_40x12mm_qr_position or 'right' }}"
                                        data-30x15mm="{{ params.label_30x15mm_qr_position or 'right' }}"
                                        data-default="{{ params.label_qr_position or 'right' }}">
                                    <option value="right" selected>Right Side</option>
                                    <option value="left">Left Side</option>
                                    <option value="top-right">Top Right Corner</option>
                                    <option value="bottom-right">Bottom Right Corner</option>
                                    <option value="bottom-left">Bottom Left Corner</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="labelQrPrefix" class="form-label">QR Code Prefix (URL/Text):</label>
                                <input type="text" class="form-control" id="labelQrPrefix" value="{{ params.label_qr_code_prefix or 'https://example.com' }}" placeholder="https://example.com">
                                <div class="form-text">This prefix applies to all label sizes</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input label-setting" type="checkbox" id="labelIncludeLogo"
                                           data-60x30mm="{{ (params.label_60x30mm_include_logo or 'false') }}"
                                           data-50x14mm="{{ (params.label_50x14mm_include_logo or 'false') }}"
                                           data-40x12mm="{{ (params.label_40x12mm_include_logo or 'false') }}"
                                           data-30x15mm="{{ (params.label_30x15mm_include_logo or 'false') }}"
                                           data-default="{{ (params.label_include_logo or 'false') }}">
                                    <label class="form-check-label">
                                        Include Project Logo on labels
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Logo Position:</label>
                                <select class="form-select label-setting" id="labelLogoPosition"
                                        data-60x30mm="{{ params.label_60x30mm_logo_position or 'top-left' }}"
                                        data-50x14mm="{{ params.label_50x14mm_logo_position or 'top-left' }}"
                                        data-40x12mm="{{ params.label_40x12mm_logo_position or 'top-left' }}"
                                        data-30x15mm="{{ params.label_30x15mm_logo_position or 'top-left' }}"
                                        data-default="{{ params.label_logo_position or 'top-left' }}">
                                    <option value="top-left" selected>Top Left Corner</option>
                                    <option value="top-right">Top Right Corner</option>
                                    <option value="left">Left Side</option>
                                    <option value="bottom-left">Bottom Left Corner</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-save me-1"></i>Save Settings for 60mm √ó 30mm
                            </button>
                        </form>
                        <div id="labelStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Live Label Preview</h5>
                        <div class="mb-3">
                            <div class="alert alert-info small mb-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Previewing settings for: <strong id="previewCurrentSettings">60mm √ó 30mm - Portrait</strong>
                            </div>
                            <div id="labelPreviewContainer" style="border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; background: #f8f9fa; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                                <div class="text-center">
                                    <div class="spinner-border text-secondary" role="status">
                                        <span class="visually-hidden">Loading preview...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading preview...</p>
                                </div>
                            </div>
                            <div class="form-text mt-2">Preview updates automatically as you change settings</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduled Jobs Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-clock me-2"></i>Scheduled Jobs Settings
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="overdueSettingsForm">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="overdueCheckEnabled" {{ 'checked' if params.overdue_check_enabled == 'true' or params.overdue_check_enabled == '1' else '' }}>
                                    <label class="form-check-label" for="overdueCheckEnabled">
                                        Enable automatic overdue checking
                                    </label>
                                </div>
                                <small class="form-text text-muted">When enabled, the system will automatically check for entries with overdue intended end dates and create notifications.</small>
                            </div>
                            <div class="mb-3">
                                <label for="overdueCheckSchedule" class="form-label">Check Schedule:</label>
                                <select class="form-select" id="overdueCheckSchedule">
                                    <option value="0 9 * * *" {{ 'selected' if params.overdue_check_schedule == '0 9 * * *' else '' }}>Daily at 9:00 AM</option>
                                    <option value="0 8 * * *" {{ 'selected' if params.overdue_check_schedule == '0 8 * * *' else '' }}>Daily at 8:00 AM</option>
                                    <option value="0 10 * * *" {{ 'selected' if params.overdue_check_schedule == '0 10 * * *' else '' }}>Daily at 10:00 AM</option>
                                    <option value="0 0 * * *" {{ 'selected' if params.overdue_check_schedule == '0 0 * * *' else '' }}>Daily at midnight</option>
                                    <option value="0 */6 * * *" {{ 'selected' if params.overdue_check_schedule == '0 */6 * * *' else '' }}>Every 6 hours</option>
                                    <option value="0 */3 * * *" {{ 'selected' if params.overdue_check_schedule == '0 */3 * * *' else '' }}>Every 3 hours</option>
                                    <option value="0 * * * *" {{ 'selected' if params.overdue_check_schedule == '0 * * * *' else '' }}>Every hour</option>
                                    <option value="0 8 * * 1-5" {{ 'selected' if params.overdue_check_schedule == '0 8 * * 1-5' else '' }}>Weekdays at 8:00 AM</option>
                                </select>
                                <small class="form-text text-muted">Choose how often the system should check for overdue entries. The scheduled job will be managed automatically.</small>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary" id="testOverdueCheck">
                                    <i class="fas fa-play me-1"></i>Test Overdue Check Now
                                </button>
                                <small class="form-text text-muted d-block mt-1">Manually trigger an overdue check to test the functionality.</small>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-save me-1"></i>Save Scheduled Job Settings
                            </button>
                        </form>
                        <div id="overdueStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Scheduled Job Status</h5>
                        <div class="mb-3">
                            <div class="alert alert-secondary d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>Checking current status...</strong><br>
                                    <small>Loading job configuration</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Available Jobs:</strong>
                            <ul class="small text-muted mt-2">
                                <li><strong>Overdue Check:</strong> Monitors entries with overdue intended end dates</li>
                                <li><em>More scheduled jobs can be added in the future</em></li>
                            </ul>
                        </div>
                        <div class="preview-container">
                            <div>
                                <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Configure scheduled jobs to run automatically</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Logo Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-image me-2"></i>Project Logo
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="logoUploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="logoFile" class="form-label">Upload Project Logo:</label>
                                <input type="file" class="form-control" id="logoFile" accept="image/*">
                                <small class="form-text text-muted">Supported formats: PNG, JPG, JPEG, GIF. Recommended size: 150x150px or smaller.</small>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-upload me-1"></i>Upload Logo
                            </button>
                            {% if params.project_logo_path %}
                            <button type="button" class="btn btn-outline-danger ms-2" id="removeLogo">
                                <i class="fas fa-trash me-1"></i>Remove Logo
                            </button>
                            {% endif %}
                        </form>
                        <div id="logoStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Current Logo</h5>
                        <div class="preview-container" id="logoPreviewContainer">
                            {% if params.project_logo_path %}
                            <img src="{{ url_for('static', filename=params.project_logo_path) }}" alt="Project Logo" class="img-fluid logo-preview">
                            {% else %}
                            <div>
                                <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No logo uploaded</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strava Data Injection -->
        <script type="application/json" id="strava-entry-types-data">
            [
                { "id": "", "label": "-- Do Not Import --" }
                {% for et in entry_types %}
                ,{ "id": {{ et.id | tojson }}, "label": {{ et.singular_label | tojson }} }
                {% endfor %}
            ]
        </script>
        
        <script type="application/json" id="strava-mapping-data">
            {{ (params.get("strava_activity_mapping") or "{}") | safe }}
        </script>

        <!-- Strava Settings Handler -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log("Settings page script loaded");
                
                const stravaSettingsForm = document.getElementById('stravaSettingsForm');
                const stravaMappingTable = document.getElementById('stravaMappingTable');
                const commonStravaTypes = ['Run', 'Ride', 'Swim', 'Walk', 'Hike', 'Workout', 'WeightTraining', 'Yoga', 'VirtualRide', 'VirtualRun', 'AlpineSki', 'Snowboard'];
                
                // Load Data
                let entryTypes = [];
                let currentMapping = {};
                
                try {
                    const entryTypesEl = document.getElementById('strava-entry-types-data');
                    if (entryTypesEl) {
                        entryTypes = JSON.parse(entryTypesEl.textContent);
                    }
                    
                    const mappingEl = document.getElementById('strava-mapping-data');
                    if (mappingEl) {
                        let rawContent = mappingEl.textContent.trim();
                        if (!rawContent) rawContent = "{}";
                        
                        // Handle potential single quotes from Python dict string representation
                        // If the string starts with { and contains single quotes, it might be a Python dict string
                        if (rawContent.startsWith('{') && rawContent.includes("'")) {
                            // Replace single quotes with double quotes for valid JSON
                            // This is a simple heuristic and might need refinement for complex strings
                            rawContent = rawContent.replace(/'/g, '"');
                        }

                        // Try to parse
                        let parsed = JSON.parse(rawContent);
                        
                        // Handle double-encoded JSON string if necessary
                        if (typeof parsed === 'string') {
                            try {
                                parsed = JSON.parse(parsed);
                            } catch (e) {
                                console.warn("Mapping was a string but not valid JSON, using as is or empty");
                            }
                        }
                        currentMapping = parsed || {};
                    }
                    console.log("Loaded Strava config:", { entryTypes, currentMapping });
                } catch (e) {
                    console.error("Error loading Strava data:", e);
                }

                function renderMappingTable() {
                    if (!stravaMappingTable) return;
                    stravaMappingTable.innerHTML = '';
                    
                    // Default Row
                    renderMappingRow('Default (All Others)', 'default');
                    
                    // Specific Types
                    commonStravaTypes.forEach(type => {
                        renderMappingRow(type, type);
                    });
                }
                
                function renderMappingRow(label, key) {
                    const tr = document.createElement('tr');
                    
                    const tdLabel = document.createElement('td');
                    tdLabel.textContent = label;
                    if (key === 'default') tdLabel.innerHTML = '<strong>Default (All Others)</strong>';
                    
                    const tdSelect = document.createElement('td');
                    const select = document.createElement('select');
                    select.className = 'form-select form-select-sm strava-mapping-select';
                    select.dataset.stravaType = key;
                    
                    entryTypes.forEach(et => {
                        const option = document.createElement('option');
                        option.value = et.id;
                        option.textContent = et.label;
                        // Check for match (handling string/number differences)
                        if (currentMapping[key] == et.id) option.selected = true;
                        select.appendChild(option);
                    });
                    
                    tdSelect.appendChild(select);
                    tr.appendChild(tdLabel);
                    tr.appendChild(tdSelect);
                    stravaMappingTable.appendChild(tr);
                }
                
                if (stravaMappingTable) renderMappingTable();

                if (stravaSettingsForm) {
                    console.log("Strava form found, attaching listener");
                    
                    // Toggle visibility
                    const stravaEnabled = document.getElementById('stravaEnabled');
                    const stravaConfigSection = document.getElementById('stravaConfigSection');
                    
                    if (stravaEnabled && stravaConfigSection) {
                        stravaEnabled.addEventListener('change', function() {
                            stravaConfigSection.style.display = this.checked ? 'block' : 'none';
                        });
                    }

                    // Handle Form Submit
                    stravaSettingsForm.addEventListener('submit', async function(e) {
                        console.log("Strava form submitted");
                        e.preventDefault();
                        
                        // Show loading state
                        const saveBtn = document.getElementById('saveStravaConfigBtn');
                        const originalBtnText = saveBtn.innerHTML;
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
                        
                        try {
                            const enabled = document.getElementById('stravaEnabled').checked;
                            const clientId = document.getElementById('stravaClientId').value;
                            const clientSecret = document.getElementById('stravaClientSecret').value;
                            const refreshToken = document.getElementById('stravaRefreshToken').value;
                            
                            // Collect Mapping Data
                            const mapping = {};
                            document.querySelectorAll('.strava-mapping-select').forEach(select => {
                                if (select.value) {
                                    mapping[select.dataset.stravaType] = select.value;
                                }
                            });
                            console.log("Saving mapping:", mapping);
                            
                            const formData = {
                                strava_enabled: enabled ? '1' : '0',
                                strava_client_id: clientId,
                                strava_client_secret: clientSecret,
                                strava_refresh_token: refreshToken,
                                strava_activity_mapping: JSON.stringify(mapping)
                            };

                            const response = await fetch('/api/system_params', {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formData)
                            });
                            
                            if (response.ok) {
                                displayStatus('stravaSettingsStatus', '‚úÖ Strava settings saved successfully!', 'alert-success');
                            } else {
                                const error = await response.json();
                                displayStatus('stravaSettingsStatus', 'Failed to save: ' + (error.error || 'Unknown error'), 'alert-danger');
                            }
                        } catch (error) {
                            console.error('Error saving Strava settings:', error);
                            displayStatus('stravaSettingsStatus', 'Error saving Strava settings: ' + error.message, 'alert-danger');
                        } finally {
                            // Restore button state
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                    });
                } else {
                    console.error("Strava form not found!");
                }
            });
        </script>

    </div> <!-- End container -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/label_printing.js') }}"></script>
    
    <script>
        // Helper function to display status messages
        function displayStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.className = 'mt-3 alert ' + type;
                el.innerHTML = message;
                el.classList.remove('d-none');
                setTimeout(() => {
                    el.classList.add('d-none');
                }, 5000);
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Test AI Service
        async function testAiService() {
            const statusDiv = document.getElementById('aiStatusMessage');
            statusDiv.className = 'mt-3 alert alert-info';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing connection...';
            statusDiv.classList.remove('d-none');
            
            try {
                const response = await fetch('/api/ai/test_connection', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok && data.success) {
                    statusDiv.className = 'mt-3 alert alert-success';
                    statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Connection successful!';
                } else {
                    statusDiv.className = 'mt-3 alert alert-danger';
                    statusDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i>Connection failed: ' + (data.error || 'Unknown error');
                }
            } catch (error) {
                statusDiv.className = 'mt-3 alert alert-danger';
                statusDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i>Error: ' + error.message;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // --- Initialization from Server Params ---
            const params = {
                enable_sensors: "{{ params.enable_sensors }}",
                enable_sensor_master_control: "{{ params.enable_sensor_master_control }}",
                enable_kanban: "{{ params.enable_kanban }}",
                git_integration_enabled: "{{ params.git_integration_enabled }}",
                git_provider: "{{ params.git_provider }}",
                gitlab_url: "{{ params.gitlab_url }}",
                git_token: "{{ params.git_token }}"
            };

            // --- General Settings ---
            const sensorToggle = document.getElementById('enableSensorsToggle');
            const sensorLabel = document.getElementById('sensorToggleLabel');
            const sensorMasterContainer = document.getElementById('sensorMasterControlContainer');
            const sensorMasterToggle = document.getElementById('enableSensorMasterControlToggle');
            const sensorMasterLabel = document.getElementById('sensorMasterControlToggleLabel');
            const kanbanToggle = document.getElementById('enableKanbanToggle');
            const kanbanLabel = document.getElementById('kanbanToggleLabel');

            // Initialize Toggles
            if (sensorToggle) {
                sensorToggle.checked = (params.enable_sensors === 'true' || params.enable_sensors === '1');
                sensorLabel.textContent = sensorToggle.checked ? 'Enabled' : 'Disabled';
                if (sensorMasterContainer) sensorMasterContainer.style.display = sensorToggle.checked ? 'block' : 'none';
                
                sensorToggle.addEventListener('change', function() {
                    sensorLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                    if (sensorMasterContainer) sensorMasterContainer.style.display = this.checked ? 'block' : 'none';
                });
            }

            if (sensorMasterToggle) {
                sensorMasterToggle.checked = (params.enable_sensor_master_control === 'true' || params.enable_sensor_master_control === '1');
                sensorMasterLabel.textContent = sensorMasterToggle.checked ? 'Enabled' : 'Disabled';
                
                sensorMasterToggle.addEventListener('change', function() {
                    sensorMasterLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            if (kanbanToggle) {
                kanbanToggle.checked = (params.enable_kanban === 'true' || params.enable_kanban === '1');
                kanbanLabel.textContent = kanbanToggle.checked ? 'Enabled' : 'Disabled';
                
                kanbanToggle.addEventListener('change', function() {
                    kanbanLabel.textContent = this.checked ? 'Enabled' : 'Disabled';
                });
            }

            // General Settings Form Submit
            const generalForm = document.getElementById('generalSettingsForm');
            if (generalForm) {
                generalForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = {
                        project_name: document.getElementById('projectName').value,
                        project_subtitle: document.getElementById('projectSubtitle').value,
                        entry_singular_label: document.getElementById('entrySingularLabel').value,
                        entry_plural_label: document.getElementById('entryPluralLabel').value,
                        enable_sensors: sensorToggle && sensorToggle.checked ? '1' : '0',
                        enable_sensor_master_control: sensorMasterToggle && sensorMasterToggle.checked ? '1' : '0',
                        enable_kanban: kanbanToggle && kanbanToggle.checked ? '1' : '0'
                    };
                    
                    try {
                        const response = await fetch('/api/system_params', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        if (response.ok) {
                            displayStatus('generalStatusMessage', '‚úÖ General settings saved successfully!', 'alert-success');
                        } else {
                            displayStatus('generalStatusMessage', '‚ùå Failed to save settings.', 'alert-danger');
                        }
                    } catch (error) {
                        displayStatus('generalStatusMessage', '‚ùå Error: ' + error.message, 'alert-danger');
                    }
                });
            }

            // --- AI Settings ---
            window.switchAiServiceSettings = function() {
                const selector = document.getElementById('aiServiceSelector');
                if (!selector) return;
                const service = selector.value;
                document.querySelectorAll('.ai-service-settings').forEach(el => el.style.display = 'none');
                const target = document.getElementById(service + 'Settings');
                if (target) target.style.display = 'block';
            };
            
            window.switchPromptEditor = function() {
                const selector = document.getElementById('promptSelector');
                if (!selector) return;
                const prompt = selector.value;
                document.querySelectorAll('.prompt-editor-section').forEach(el => el.style.display = 'none');
                const target = document.getElementById('promptEditor_' + prompt);
                if (target) target.style.display = 'block';
            };

            // Initialize AI Views
            if (document.getElementById('aiServiceSelector')) switchAiServiceSettings();
            if (document.getElementById('promptSelector')) switchPromptEditor();
            
            // Update AI Status
            const aiStatus = document.getElementById('aiServiceStatus');
            if (aiStatus) {
                const hasKey = "{{ params.gemini_api_key }}" !== "";
                if (hasKey) {
                    aiStatus.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Active</span>';
                } else {
                    aiStatus.innerHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle me-1"></i>Not Configured</span>';
                }
            }

            // AI Form Submit
            const aiForm = document.getElementById('aiSettingsForm');
            if (aiForm) {
                aiForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {};
                    const elements = aiForm.elements;
                    for (let i = 0; i < elements.length; i++) {
                        const el = elements[i];
                        if (el.id) {
                            if (el.id === 'geminiApiKey') formData.gemini_api_key = el.value;
                            else if (el.id === 'geminiModelName') formData.gemini_model_name = el.value;
                            else if (el.id === 'groqApiKey') formData.groq_api_key = el.value;
                            else if (el.id === 'groqModelName') formData.groq_model_name = el.value;
                            else if (el.id === 'huggingfaceApiKey') formData.huggingface_api_key = el.value;
                            else if (el.id === 'huggingfaceModel') formData.huggingface_model = el.value;
                            else if (el.id === 'huggingfaceImageSize') formData.huggingface_image_size = el.value;
                            else if (el.id === 'geminiBasePrompt') formData.gemini_base_prompt = el.value;
                            else if (el.id === 'promptDescription') formData.prompt_description = el.value;
                            else if (el.id === 'promptNote') formData.prompt_note = el.value;
                            else if (el.id === 'promptSql') formData.prompt_sql = el.value;
                            else if (el.id === 'promptTheme') formData.prompt_theme = el.value;
                            else if (el.id === 'promptChat') formData.prompt_chat = el.value;
                            else if (el.id === 'promptDiagram') formData.prompt_diagram = el.value;
                            else if (el.id === 'promptDiagramRules') formData.prompt_diagram_rules = el.value;
                            else if (el.id === 'promptSummary') formData.prompt_summary = el.value;
                        }
                    }

                    try {
                        const response = await fetch('/api/system_params', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        if (response.ok) {
                            displayStatus('aiStatusMessage', '‚úÖ AI settings saved successfully!', 'alert-success');
                        } else {
                            displayStatus('aiStatusMessage', '‚ùå Failed to save AI settings.', 'alert-danger');
                        }
                    } catch (error) {
                        displayStatus('aiStatusMessage', '‚ùå Error: ' + error.message, 'alert-danger');
                    }
                });
            }

            // --- Git Integration ---
            const gitToggle = document.getElementById('gitIntegrationEnabled');
            const gitConfig = document.getElementById('gitConfigSection');
            const gitProvider = document.getElementById('gitProvider');
            const gitlabUrlSection = document.getElementById('gitlabUrlSection');
            
            if (gitToggle) {
                gitToggle.checked = (params.git_integration_enabled === 'true' || params.git_integration_enabled === '1');
                if (gitConfig) gitConfig.style.display = gitToggle.checked ? 'block' : 'none';
                
                gitToggle.addEventListener('change', function() {
                    if (gitConfig) gitConfig.style.display = this.checked ? 'block' : 'none';
                });
            }

            if (gitProvider) {
                gitProvider.value = params.git_provider || '';
                if (gitlabUrlSection) gitlabUrlSection.style.display = (params.git_provider === 'gitlab') ? 'block' : 'none';
                
                gitProvider.addEventListener('change', function() {
                    if (gitlabUrlSection) gitlabUrlSection.style.display = this.value === 'gitlab' ? 'block' : 'none';
                });
            }
            
            if (document.getElementById('gitlabUrl')) document.getElementById('gitlabUrl').value = params.gitlab_url || '';
            if (document.getElementById('gitToken')) document.getElementById('gitToken').value = params.git_token || '';

            const saveGitBtn = document.getElementById('saveGitConfigBtn');
            if (saveGitBtn) {
                saveGitBtn.addEventListener('click', async function() {
                    const data = {
                        git_integration_enabled: gitToggle.checked ? '1' : '0',
                        git_provider: gitProvider.value,
                        gitlab_url: document.getElementById('gitlabUrl').value,
                        git_token: document.getElementById('gitToken').value
                    };
                    
                    try {
                        const response = await fetch('/api/system_params', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        if (response.ok) {
                            displayStatus('gitSettingsStatus', '‚úÖ Git configuration saved!', 'alert-success');
                            const discoverBtn = document.getElementById('discoverReposBtn');
                            if (discoverBtn) discoverBtn.disabled = false;
                        } else {
                            displayStatus('gitSettingsStatus', '‚ùå Failed to save Git config.', 'alert-danger');
                        }
                    } catch (error) {
                        displayStatus('gitSettingsStatus', '‚ùå Error: ' + error.message, 'alert-danger');
                    }
                });
            }
            
            // --- Scheduled Jobs ---
            const overdueForm = document.getElementById('overdueSettingsForm');
            if (overdueForm) {
                overdueForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const enabled = document.getElementById('overdueCheckEnabled').checked;
                    const schedule = document.getElementById('overdueCheckSchedule').value;
                    
                    try {
                        const response = await fetch('/api/system_params', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                overdue_check_enabled: enabled ? '1' : '0',
                                overdue_check_schedule: schedule
                            })
                        });
                        if (response.ok) {
                            displayStatus('overdueStatusMessage', '‚úÖ Scheduled job settings saved!', 'alert-success');
                        } else {
                            displayStatus('overdueStatusMessage', '‚ùå Failed to save settings.', 'alert-danger');
                        }
                    } catch (error) {
                        displayStatus('overdueStatusMessage', '‚ùå Error: ' + error.message, 'alert-danger');
                    }
                });
            }
            
            const testOverdueBtn = document.getElementById('testOverdueCheck');
            if (testOverdueBtn) {
                testOverdueBtn.addEventListener('click', async function() {
                    try {
                        const response = await fetch('/api/jobs/run/overdue_check', { method: 'POST' });
                        const data = await response.json();
                        if (response.ok) {
                            displayStatus('overdueStatusMessage', '‚úÖ Job triggered successfully: ' + data.message, 'alert-success');
                        } else {
                            displayStatus('overdueStatusMessage', '‚ùå Job failed: ' + data.error, 'alert-danger');
                        }
                    } catch (error) {
                        displayStatus('overdueStatusMessage', '‚ùå Error: ' + error.message, 'alert-danger');
                    }
                });
            }

            // --- Project Logo ---
            const logoForm = document.getElementById('logoUploadForm');
            if (logoForm) {
                logoForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const fileInput = document.getElementById('logoFile');
                    if (!fileInput.files.length) {
                        displayStatus('logoStatusMessage', '‚ö†Ô∏è Please select a file first.', 'alert-warning');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('logo', fileInput.files[0]);
                    
                    try {
                        const response = await fetch('/api/system_params/logo', {
                            method: 'POST',
                            body: formData
                        });
                        if (response.ok) {
                            displayStatus('logoStatusMessage', '‚úÖ Logo uploaded successfully! Refreshing...', 'alert-success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            const data = await response.json();
                            displayStatus('logoStatusMessage', '‚ùå Upload failed: ' + data.error, 'alert-danger');
                        }
                    } catch (error) {
                        displayStatus('logoStatusMessage', '‚ùå Error: ' + error.message, 'alert-danger');
                    }
                });
            }
            
            const removeLogoBtn = document.getElementById('removeLogo');
            if (removeLogoBtn) {
                removeLogoBtn.addEventListener('click', async function() {
                    if (!confirm('Are you sure you want to remove the project logo?')) return;
                    
                    try {
                        const response = await fetch('/api/system_params/logo', { method: 'DELETE' });
                        if (response.ok) {
                            displayStatus('logoStatusMessage', '‚úÖ Logo removed. Refreshing...', 'alert-success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            displayStatus('logoStatusMessage', '‚ùå Failed to remove logo.', 'alert-danger');
                        }
                    } catch (error) {
                        displayStatus('logoStatusMessage', '‚ùå Error: ' + error.message, 'alert-danger');
                    }
                });
            }

            // --- Strava Sync ---
            const syncStravaBtn = document.getElementById('syncStravaBtn');
            if (syncStravaBtn) {
                syncStravaBtn.addEventListener('click', async function() {
                    const originalText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
                    
                    try {
                        const response = await fetch('/strava/sync', { method: 'POST' });
                        const data = await response.json();
                        
                        if (response.ok && data.status === 'success') {
                            alert('Sync Complete: ' + data.message);
                            location.reload();
                        } else if (data.status === 'skipped') {
                            alert('Sync Skipped: ' + data.message);
                        } else {
                            alert('Sync Failed: ' + data.message);
                        }
                    } catch (error) {
                        alert('Error syncing with Strava: ' + error.message);
                    } finally {
                        this.disabled = false;
                        this.innerHTML = originalText;
                    }
                });
            }
        });
    </script>
    <!-- About Modal -->