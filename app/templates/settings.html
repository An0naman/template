<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - System Parameters</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    
    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .container {
            margin-top: 30px;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid var(--bs-border-color);
        }
        .settings-section {
            margin-bottom: 2rem;
        }
        .section-card {
            background: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #6f42c1, #d63384);
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #6f42c1;
        }
        .form-control, .form-select {
            margin-bottom: 15px;
        }
        .preview-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bs-body-bg);
        }
        .logo-preview {
            max-width: 150px;
            max-height: 150px;
        }
        .btn-purple {
            background: linear-gradient(135deg, #6f42c1, #d63384);
            border: none;
            color: white;
        }
        .btn-purple:hover {
            background: linear-gradient(135deg, #5a359a, #b02a5b);
            color: white;
        }
        .bg-purple {
            background-color: #6f42c1 !important;
        }
        .text-purple {
            color: #6f42c1 !important;
        }
        .alert-purple {
            background-color: rgba(111, 66, 193, 0.1);
            border-color: rgba(111, 66, 193, 0.2);
            color: #6f42c1;
        }
        .alert-purple .fas {
            color: #6f42c1;
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-0">{{ project_name }} System Parameters</h1>
            </div>
            <div>
                                <a href="{{ url_for('maintenance.maintenance_module_page') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Settings
                </a>
            </div>
        </div>

        <!-- General Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-info-circle me-2"></i>General Settings
                </div>
                <form id="generalSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectName" class="form-label">Project Name:</label>
                                <input type="text" class="form-control" id="projectName" value="{{ params.project_name }}" placeholder="Enter project name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectSubtitle" class="form-label">Project Subtitle:</label>
                                <input type="text" class="form-control" id="projectSubtitle" value="{{ params.project_subtitle if params.project_subtitle else 'Management System' }}" placeholder="Enter project subtitle">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="entrySingularLabel" class="form-label">Entry Singular Label:</label>
                                <input type="text" class="form-control" id="entrySingularLabel" value="{{ params.entry_singular_label }}" placeholder="Entry">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="entryPluralLabel" class="form-label">Entry Plural Label:</label>
                                <input type="text" class="form-control" id="entryPluralLabel" value="{{ params.entry_plural_label }}" placeholder="Entries">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-purple">
                        <i class="fas fa-save me-1"></i>Save General Settings
                    </button>
                </form>
                <div id="generalStatusMessage" class="mt-3 d-none"></div>
            </div>
        </div>

        <!-- AI Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-brain me-2"></i>AI Integration Settings
                </div>
                <div class="mb-3">
                    <p class="text-muted">Configure Google Gemini AI for writing assistance with descriptions, notes, and SQL queries.</p>
                </div>
                <form id="aiSettingsForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="geminiApiKey" class="form-label">
                                    <i class="fas fa-key me-1"></i>Google Gemini API Key:
                                </label>
                                <input type="password" class="form-control" id="geminiApiKey" 
                                       value="{{ params.gemini_api_key if params.gemini_api_key else '' }}" 
                                       placeholder="Enter your Google Gemini API key">
                                <small class="text-muted">
                                    Get your API key from 
                                    <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-decoration-none">
                                        Google AI Studio <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">AI Service Status:</label>
                                <div id="aiServiceStatus" class="mt-2">
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Checking...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="geminiModelName" class="form-label">
                                    <i class="fas fa-brain me-1"></i>Gemini Model Name:
                                </label>
                                <input type="text" class="form-control" id="geminiModelName" 
                                       value="{{ params.gemini_model_name if params.gemini_model_name else 'gemini-1.5-flash' }}" 
                                       placeholder="gemini-1.5-flash">
                                <small class="text-muted">
                                    Current models: gemini-1.5-flash (fast), gemini-1.5-pro (advanced)
                                    <br><a href="https://ai.google.dev/gemini-api/docs/models/gemini" target="_blank" class="text-decoration-none">
                                        View available models <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Reserved for future AI settings -->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="geminiBasePrompt" class="form-label">
                                    <i class="fas fa-comment-alt me-1"></i>Base Prompt (Context):
                                </label>
                                <textarea class="form-control" id="geminiBasePrompt" rows="3" 
                                          placeholder="Provide context or instructions that will be included with every AI request">{{ params.gemini_base_prompt if params.gemini_base_prompt else 'You are a helpful assistant for a project management application. Please provide clear, concise, and well-structured responses.' }}</textarea>
                                <small class="text-muted">
                                    This text will be prepended to all AI requests to provide consistent context and instructions.
                                    <br>Example: "You are an expert in [your domain]. Always respond with practical, actionable advice."
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-purple me-2">
                                <i class="fas fa-save me-1"></i>Save AI Settings
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="testAiService()">
                                <i class="fas fa-check-circle me-1"></i>Test Connection
                            </button>
                        </div>
                    </div>
                </form>
                <div id="aiStatusMessage" class="mt-3 d-none"></div>
                
                <!-- AI Features Info -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6><i class="fas fa-magic me-2"></i>Available AI Features:</h6>
                    <ul class="mb-0">
                        <li><strong>Entry Descriptions:</strong> Generate and improve descriptions for entries</li>
                        <li><strong>SQL Assistance:</strong> Generate SQL queries and explanations in the SQL IDE</li>
                        <li><strong>Note Enhancement:</strong> Improve existing notes for clarity and structure</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Label Printing Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-print me-2"></i>Label Printing Settings
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Label Settings</h5>
                        <div class="mb-3">
                            <label for="settingsPrinterType" class="form-label">Printer Type:</label>
                            <select class="form-select" id="settingsPrinterType">
                                <option value="8_labels">8 Labels (2x4) - A4 Sheet</option>
                                <option value="14_labels">14 Labels (2x7) - A4 Sheet</option>
                                <option value="niimbot_b1" selected>Niimbot B1</option>
                                <option value="niimbot_d110">Niimbot D110</option>
                            </select>
                        </div>
                        <div class="mb-3" id="labelSizeContainer">
                            <label for="settingsLabelSize" class="form-label">Configure Settings For Label Size:</label>
                            <select class="form-select" id="settingsLabelSize">
                                <!-- Populated dynamically based on printer type -->
                            </select>
                            <div class="form-text">Each label size can have its own font sizes, borders, and layout</div>
                        </div>
                        <div class="mb-3" id="labelRotationContainer">
                            <label for="settingsLabelRotation" class="form-label">Label Orientation:</label>
                            <select class="form-select" id="settingsLabelRotation">
                                <option value="0">Portrait (0°)</option>
                                <option value="90">Landscape (90° Rotation)</option>
                            </select>
                            <div class="form-text">Configure separate settings for portrait and landscape orientations</div>
                        </div>
                        
                        <form id="labelSettingsForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Body Font Size (pt):</label>
                                    <input type="number" class="form-control label-setting" id="labelFontSize" 
                                           data-60x30mm="{{ params.label_60x30mm_font_size or '8' }}"
                                           data-50x14mm="{{ params.label_50x14mm_font_size or '7' }}"
                                           data-40x12mm="{{ params.label_40x12mm_font_size or '6' }}"
                                           data-30x15mm="{{ params.label_30x15mm_font_size or '7' }}"
                                           data-default="{{ params.label_font_size or '10' }}"
                                           value="{{ params.label_60x30mm_font_size or '8' }}" min="6" max="16" step="1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Title Font Size (pt):</label>
                                    <input type="number" class="form-control label-setting" id="labelTitleFontSize" 
                                           data-60x30mm="{{ params.label_60x30mm_title_font_size or '12' }}"
                                           data-50x14mm="{{ params.label_50x14mm_title_font_size or '10' }}"
                                           data-40x12mm="{{ params.label_40x12mm_title_font_size or '9' }}"
                                           data-30x15mm="{{ params.label_30x15mm_title_font_size or '10' }}"
                                           data-default="{{ params.label_title_font_size or '14' }}"
                                           value="{{ params.label_60x30mm_title_font_size or '12' }}" min="8" max="24" step="1">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Border Style:</label>
                                <select class="form-select label-setting" id="labelBorderStyle"
                                        data-60x30mm="{{ params.label_60x30mm_border_style or 'simple' }}"
                                        data-50x14mm="{{ params.label_50x14mm_border_style or 'none' }}"
                                        data-40x12mm="{{ params.label_40x12mm_border_style or 'none' }}"
                                        data-30x15mm="{{ params.label_30x15mm_border_style or 'simple' }}"
                                        data-default="{{ params.label_border_style or 'simple' }}">
                                    <option value="none">No Border</option>
                                    <option value="simple" selected>Simple Line</option>
                                    <option value="thick">Thick Line</option>
                                    <option value="double">Double Line</option>
                                    <option value="rounded">Rounded Corners</option>
                                    <option value="dashed">Dashed Line</option>
                                    <option value="dotted">Dotted Line</option>
                                    <option value="decorative">Decorative Corners</option>
                                    <option value="shadow">Drop Shadow</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input label-setting" type="checkbox" id="labelIncludeQr"
                                           data-60x30mm="{{ params.label_60x30mm_include_qr_code or 'true' }}"
                                           data-50x14mm="{{ params.label_50x14mm_include_qr_code or 'false' }}"
                                           data-40x12mm="{{ params.label_40x12mm_include_qr_code or 'false' }}"
                                           data-30x15mm="{{ params.label_30x15mm_include_qr_code or 'true' }}"
                                           data-default="{{ params.label_include_qr_code or 'true' }}"
                                           checked>
                                    <label class="form-check-label">
                                        Include QR Code on labels
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">QR Code Size:</label>
                                <select class="form-select label-setting" id="labelQrSize"
                                        data-60x30mm="{{ params.label_60x30mm_qr_size or 'medium' }}"
                                        data-50x14mm="{{ params.label_50x14mm_qr_size or 'small' }}"
                                        data-40x12mm="{{ params.label_40x12mm_qr_size or 'small' }}"
                                        data-30x15mm="{{ params.label_30x15mm_qr_size or 'small' }}"
                                        data-default="{{ params.label_qr_size or 'medium' }}">
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">QR Code Position:</label>
                                <select class="form-select label-setting" id="labelQrPosition"
                                        data-60x30mm="{{ params.label_60x30mm_qr_position or 'right' }}"
                                        data-50x14mm="{{ params.label_50x14mm_qr_position or 'right' }}"
                                        data-40x12mm="{{ params.label_40x12mm_qr_position or 'right' }}"
                                        data-30x15mm="{{ params.label_30x15mm_qr_position or 'right' }}"
                                        data-default="{{ params.label_qr_position or 'right' }}">
                                    <option value="right" selected>Right Side</option>
                                    <option value="left">Left Side</option>
                                    <option value="top-right">Top Right Corner</option>
                                    <option value="bottom-right">Bottom Right Corner</option>
                                    <option value="bottom-left">Bottom Left Corner</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="labelQrPrefix" class="form-label">QR Code Prefix (URL/Text):</label>
                                <input type="text" class="form-control" id="labelQrPrefix" value="{{ params.label_qr_code_prefix or 'https://example.com' }}" placeholder="https://example.com">
                                <div class="form-text">This prefix applies to all label sizes</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input label-setting" type="checkbox" id="labelIncludeLogo"
                                           data-60x30mm="{{ (params.label_60x30mm_include_logo or 'false') }}"
                                           data-50x14mm="{{ (params.label_50x14mm_include_logo or 'false') }}"
                                           data-40x12mm="{{ (params.label_40x12mm_include_logo or 'false') }}"
                                           data-30x15mm="{{ (params.label_30x15mm_include_logo or 'false') }}"
                                           data-default="{{ (params.label_include_logo or 'false') }}">
                                    <label class="form-check-label">
                                        Include Project Logo on labels
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Logo Position:</label>
                                <select class="form-select label-setting" id="labelLogoPosition"
                                        data-60x30mm="{{ params.label_60x30mm_logo_position or 'top-left' }}"
                                        data-50x14mm="{{ params.label_50x14mm_logo_position or 'top-left' }}"
                                        data-40x12mm="{{ params.label_40x12mm_logo_position or 'top-left' }}"
                                        data-30x15mm="{{ params.label_30x15mm_logo_position or 'top-left' }}"
                                        data-default="{{ params.label_logo_position or 'top-left' }}">
                                    <option value="top-left" selected>Top Left Corner</option>
                                    <option value="top-right">Top Right Corner</option>
                                    <option value="left">Left Side</option>
                                    <option value="bottom-left">Bottom Left Corner</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-save me-1"></i>Save Settings for 60mm × 30mm
                            </button>
                        </form>
                        <div id="labelStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Live Label Preview</h5>
                        <div class="mb-3">
                            <div class="alert alert-info small mb-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Previewing settings for: <strong id="previewCurrentSettings">60mm × 30mm - Portrait</strong>
                            </div>
                            <div id="labelPreviewContainer" style="border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; background: #f8f9fa; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                                <div class="text-center">
                                    <div class="spinner-border text-secondary" role="status">
                                        <span class="visually-hidden">Loading preview...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading preview...</p>
                                </div>
                            </div>
                            <div class="form-text mt-2">Preview updates automatically as you change settings</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduled Jobs Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-clock me-2"></i>Scheduled Jobs Settings
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="overdueSettingsForm">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="overdueCheckEnabled" {{ 'checked' if params.overdue_check_enabled == 'true' else '' }}>
                                    <label class="form-check-label" for="overdueCheckEnabled">
                                        Enable automatic overdue checking
                                    </label>
                                </div>
                                <small class="form-text text-muted">When enabled, the system will automatically check for entries with overdue intended end dates and create notifications.</small>
                            </div>
                            <div class="mb-3">
                                <label for="overdueCheckSchedule" class="form-label">Check Schedule:</label>
                                <select class="form-select" id="overdueCheckSchedule">
                                    <option value="0 9 * * *" {{ 'selected' if params.overdue_check_schedule == '0 9 * * *' else '' }}>Daily at 9:00 AM</option>
                                    <option value="0 8 * * *" {{ 'selected' if params.overdue_check_schedule == '0 8 * * *' else '' }}>Daily at 8:00 AM</option>
                                    <option value="0 10 * * *" {{ 'selected' if params.overdue_check_schedule == '0 10 * * *' else '' }}>Daily at 10:00 AM</option>
                                    <option value="0 0 * * *" {{ 'selected' if params.overdue_check_schedule == '0 0 * * *' else '' }}>Daily at midnight</option>
                                    <option value="0 */6 * * *" {{ 'selected' if params.overdue_check_schedule == '0 */6 * * *' else '' }}>Every 6 hours</option>
                                    <option value="0 */3 * * *" {{ 'selected' if params.overdue_check_schedule == '0 */3 * * *' else '' }}>Every 3 hours</option>
                                    <option value="0 * * * *" {{ 'selected' if params.overdue_check_schedule == '0 * * * *' else '' }}>Every hour</option>
                                    <option value="0 8 * * 1-5" {{ 'selected' if params.overdue_check_schedule == '0 8 * * 1-5' else '' }}>Weekdays at 8:00 AM</option>
                                </select>
                                <small class="form-text text-muted">Choose how often the system should check for overdue entries. The scheduled job will be managed automatically.</small>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary" id="testOverdueCheck">
                                    <i class="fas fa-play me-1"></i>Test Overdue Check Now
                                </button>
                                <small class="form-text text-muted d-block mt-1">Manually trigger an overdue check to test the functionality.</small>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-save me-1"></i>Save Scheduled Job Settings
                            </button>
                        </form>
                        <div id="overdueStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Scheduled Job Status</h5>
                        <div class="mb-3">
                            <div class="alert alert-secondary d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>Checking current status...</strong><br>
                                    <small>Loading job configuration</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Available Jobs:</strong>
                            <ul class="small text-muted mt-2">
                                <li><strong>Overdue Check:</strong> Monitors entries with overdue intended end dates</li>
                                <li><em>More scheduled jobs can be added in the future</em></li>
                            </ul>
                        </div>
                        <div class="preview-container">
                            <div>
                                <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Configure scheduled jobs to run automatically</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Logo Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-image me-2"></i>Project Logo
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="logoUploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="logoFile" class="form-label">Upload Project Logo:</label>
                                <input type="file" class="form-control" id="logoFile" accept="image/*">
                                <small class="form-text text-muted">Supported formats: PNG, JPG, JPEG, GIF. Recommended size: 150x150px or smaller.</small>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-upload me-1"></i>Upload Logo
                            </button>
                            {% if params.project_logo_path %}
                            <button type="button" class="btn btn-outline-danger ms-2" id="removeLogo">
                                <i class="fas fa-trash me-1"></i>Remove Logo
                            </button>
                            {% endif %}
                        </form>
                        <div id="logoStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Current Logo</h5>
                        <div class="preview-container" id="logoPreviewContainer">
                            {% if params.project_logo_path %}
                                <img src="{{ params.project_logo_path }}" alt="Project Logo" class="logo-preview">
                            {% else %}
                                <div>
                                    <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No logo uploaded</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // General Settings Form
        document.getElementById('generalSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                project_name: document.getElementById('projectName').value,
                project_subtitle: document.getElementById('projectSubtitle').value,
                entry_singular_label: document.getElementById('entrySingularLabel').value,
                entry_plural_label: document.getElementById('entryPluralLabel').value
            };
            
            try {
                displayStatus('generalStatusMessage', 'Saving settings...', 'alert-info');
                
                const response = await fetch('/api/system_params', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save settings');
                
                displayStatus('generalStatusMessage', 'Settings saved successfully!', 'alert-success');
                
                // Update page title and header
                document.title = `${formData.project_name} - Settings`;
                const headerElement = document.querySelector('h1');
                if (headerElement) {
                    headerElement.textContent = `${formData.project_name} System Parameters`;
                }
                
            } catch (error) {
                displayStatus('generalStatusMessage', 'Failed to save settings: ' + error.message, 'alert-danger');
            }
        });

        // Label size configurations for each printer type
        const printerLabelSizes = {
            '8_labels': [
                { value: 'static', label: '97.5mm × 65.5mm (Fixed Size)' }
            ],
            '14_labels': [
                { value: 'static', label: '97.5mm × 35.3mm (Fixed Size)' }
            ],
            'niimbot_b1': [
                { value: '30x12mm', label: '30mm × 12mm' },
                { value: '30x15mm', label: '30mm × 15mm' },
                { value: '40x20mm', label: '40mm × 20mm' },
                { value: '40x24mm', label: '40mm × 24mm' },
                { value: '60x30mm', label: '60mm × 30mm' },
                { value: 'default', label: 'Default (All Other Sizes)' }
            ],
            'niimbot_d110': [
                { value: '30x15mm', label: '30mm × 15mm' },
                { value: '40x12mm', label: '40mm × 12mm' },
                { value: '50x14mm', label: '50mm × 14mm' },
                { value: '75x12mm', label: '75mm × 12mm' },
                { value: 'default', label: 'Default (All Other Sizes)' }
            ]
        };

        // Update label sizes when printer type changes
        function updateLabelSizes() {
            const printerType = document.getElementById('settingsPrinterType').value;
            const labelSizeSelect = document.getElementById('settingsLabelSize');
            const labelSizeContainer = document.getElementById('labelSizeContainer');
            
            // Clear existing options
            labelSizeSelect.innerHTML = '';
            
            // For sheet labels (8 or 14), hide the size selector since they're static
            if (printerType === '8_labels' || printerType === '14_labels') {
                labelSizeContainer.style.display = 'none';
                // Add the static option and auto-select it
                const option = document.createElement('option');
                option.value = 'static';
                option.textContent = printerLabelSizes[printerType][0].label;
                labelSizeSelect.appendChild(option);
            } else {
                // Show size selector for Niimbot printers
                labelSizeContainer.style.display = 'block';
                
                // Populate with sizes for this printer
                const sizes = printerLabelSizes[printerType];
                sizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.value;
                    option.textContent = size.label;
                    labelSizeSelect.appendChild(option);
                });
            }
            
            // Trigger change event to load settings for first size
            labelSizeSelect.dispatchEvent(new Event('change'));
        }

        // Initialize label sizes and add event listener
        document.getElementById('settingsPrinterType').addEventListener('change', updateLabelSizes);
        
        // Initialize preview label type dropdown sizes on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize label sizes and preview on page load
            updateLabelSizes();
            setTimeout(() => {
                updateLabelPreview(); // Initial preview after settings are loaded
            }, 100);
        });

        // Store loaded settings in memory
        let labelSettings = {};

        // Function to load settings for current size + rotation
        function loadCurrentSettings() {
            const labelSize = document.getElementById('settingsLabelSize').value;
            const rotation = document.getElementById('settingsLabelRotation').value;
            const key = `${labelSize}_r${rotation}`;
            
            // If we have settings for this combo, load them
            if (labelSettings[key]) {
                const settings = labelSettings[key];
                document.getElementById('labelFontSize').value = settings.font_size;
                document.getElementById('labelTitleFontSize').value = settings.title_font_size;
                document.getElementById('labelBorderStyle').value = settings.border_style;
                document.getElementById('labelIncludeQr').checked = settings.include_qr_code === 'true';
                document.getElementById('labelQrSize').value = settings.qr_size;
                document.getElementById('labelQrPosition').value = settings.qr_position;
                document.getElementById('labelIncludeLogo').checked = settings.include_logo === 'true';
                document.getElementById('labelLogoPosition').value = settings.logo_position;
            } else {
                // Load from data attributes (initial load)
                const settings = document.querySelectorAll('.label-setting');
                settings.forEach(setting => {
                    const value = setting.getAttribute(`data-${labelSize}`);
                    if (setting.type === 'checkbox') {
                        setting.checked = value === 'true';
                    } else {
                        setting.value = value;
                    }
                });
            }
            
            // Update button text
            const sizeDisplay = labelSize === 'default' ? 'Default' : labelSize.replace('x', 'mm × ') + 'mm';
            const rotationDisplay = rotation === '0' ? 'Portrait' : 'Landscape';
            document.querySelector('#labelSettingsForm button[type="submit"]').innerHTML = 
                `<i class="fas fa-save me-1"></i>Save Settings for ${sizeDisplay} - ${rotationDisplay}`;
            
            // Update preview
            updateLabelPreview();
        }

        // Label Settings - Switch between label sizes or rotation
        document.getElementById('settingsLabelSize').addEventListener('change', loadCurrentSettings);
        document.getElementById('settingsLabelRotation').addEventListener('change', loadCurrentSettings);

        // Label Settings Form
        document.getElementById('labelSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const labelSize = document.getElementById('settingsLabelSize').value;
            const rotation = document.getElementById('settingsLabelRotation').value;
            const prefix = labelSize === 'default' ? 'label' : `label_${labelSize}`;
            const rotationSuffix = rotation === '90' ? '_r90' : '';
            
            const formData = {
                [`${prefix}${rotationSuffix}_font_size`]: document.getElementById('labelFontSize').value,
                [`${prefix}${rotationSuffix}_title_font_size`]: document.getElementById('labelTitleFontSize').value,
                [`${prefix}${rotationSuffix}_border_style`]: document.getElementById('labelBorderStyle').value,
                [`${prefix}${rotationSuffix}_include_qr_code`]: document.getElementById('labelIncludeQr').checked ? 'true' : 'false',
                [`${prefix}${rotationSuffix}_qr_size`]: document.getElementById('labelQrSize').value,
                [`${prefix}${rotationSuffix}_qr_position`]: document.getElementById('labelQrPosition').value,
                [`${prefix}${rotationSuffix}_include_logo`]: document.getElementById('labelIncludeLogo').checked ? 'true' : 'false',
                [`${prefix}${rotationSuffix}_logo_position`]: document.getElementById('labelLogoPosition').value,
                label_qr_code_prefix: document.getElementById('labelQrPrefix').value
            };
            
            try {
                const sizeDisplay = labelSize === 'default' ? 'default' : labelSize;
                const rotationDisplay = rotation === '0' ? 'Portrait' : 'Landscape';
                displayStatus('labelStatusMessage', `Saving ${sizeDisplay} (${rotationDisplay}) label settings...`, 'alert-info');
                
                const response = await fetch('/api/system_params', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save label settings');
                
                displayStatus('labelStatusMessage', `Settings for ${sizeDisplay} (${rotationDisplay}) saved successfully!`, 'alert-success');
                
                // Store settings in memory for this size + rotation combo
                const key = `${labelSize}_r${rotation}`;
                labelSettings[key] = {
                    font_size: document.getElementById('labelFontSize').value,
                    title_font_size: document.getElementById('labelTitleFontSize').value,
                    border_style: document.getElementById('labelBorderStyle').value,
                    include_qr_code: document.getElementById('labelIncludeQr').checked ? 'true' : 'false',
                    qr_size: document.getElementById('labelQrSize').value,
                    qr_position: document.getElementById('labelQrPosition').value,
                    include_logo: document.getElementById('labelIncludeLogo').checked ? 'true' : 'false',
                    logo_position: document.getElementById('labelLogoPosition').value
                };
                
                // Refresh preview after save
                updateLabelPreview();
                
            } catch (error) {
                displayStatus('labelStatusMessage', 'Failed to save label settings: ' + error.message, 'alert-danger');
            }
        });

        // Label Preview Functionality
        let previewTimeout = null;
        
        function updateLabelPreview() {
            const container = document.getElementById('labelPreviewContainer');
            // Use the settings dropdowns instead of separate preview dropdowns
            const printerType = document.getElementById('settingsPrinterType').value;
            const labelSize = document.getElementById('settingsLabelSize').value;
            const rotation = document.getElementById('settingsLabelRotation').value;
            
            // Update the preview info text
            const sizeDisplay = labelSize === 'default' ? 'Default' : 
                               labelSize === 'static' ? (printerType === '8_labels' ? '97.5mm × 65.5mm' : '97.5mm × 35.3mm') : 
                               labelSize;
            const rotationDisplay = rotation === '0' ? 'Portrait' : 'Landscape (90°)';
            document.getElementById('previewCurrentSettings').textContent = `${sizeDisplay} - ${rotationDisplay}`;
            
            // Determine label type from printer type and label size
            let labelType = printerType;
            
            // Get current form values
            const titleFontSize = parseInt(document.getElementById('labelTitleFontSize').value) || 14;
            const bodyFontSize = parseInt(document.getElementById('labelFontSize').value) || 10;
            const borderStyle = document.getElementById('labelBorderStyle').value;
            const includeQr = document.getElementById('labelIncludeQr').checked;
            const qrSize = document.getElementById('labelQrSize').value;
            const qrPosition = document.getElementById('labelQrPosition').value;
            const includeLogo = document.getElementById('labelIncludeLogo').checked;
            const logoPosition = document.getElementById('labelLogoPosition').value;
            
            // Create canvas for preview
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size based on label type
            let width, height;
            if (labelType.startsWith('niimbot_')) {
                // Niimbot label sizes (pixels at 203 DPI to match backend)
                // Calculate: mm * 203 DPI / 25.4 mm per inch
                // NOTE: Backend enforces max_width_px limits:
                //   B1: 384px max (48mm), D110: 240px max (30mm)
                const sizes = {
                    // B1 sizes (max 384px width)
                    '60x30mm': [Math.round(60 * 203 / 25.4), Math.round(30 * 203 / 25.4)],  // 480 x 240 -> clamped to 384x240
                    '40x24mm': [Math.round(40 * 203 / 25.4), Math.round(24 * 203 / 25.4)],  // 320 x 192
                    '40x20mm': [Math.round(40 * 203 / 25.4), Math.round(20 * 203 / 25.4)],  // 320 x 160
                    '30x15mm': [Math.round(30 * 203 / 25.4), Math.round(15 * 203 / 25.4)],  // 240 x 120
                    '30x12mm': [Math.round(30 * 203 / 25.4), Math.round(12 * 203 / 25.4)],  // 240 x 96
                    // D110 sizes (max 240px width - 30mm print head)
                    '75x12mm': [240, Math.round(12 * 203 / 25.4)],  // Would be 600px, clamped to 240
                    '50x14mm': [240, Math.round(14 * 203 / 25.4)],  // Would be 400px, clamped to 240
                    '40x12mm': [240, Math.round(12 * 203 / 25.4)],  // Would be 320px, clamped to 240
                };
                [width, height] = sizes[labelSize] || [384, 237];
                
                // If rotated, swap width and height
                if (rotation === '90') {
                    [width, height] = [height, width];
                }
            } else {
                // Sheet labels - use 300 DPI to match backend (mm * 300 / 25.4)
                const scale = 300 / 25.4; // ~11.8 pixels per mm at 300 DPI
                if (labelType === '8_labels') {
                    width = Math.round(97.5 * scale);   // 97.5mm → ~1150px
                    height = Math.round(65.5 * scale);  // 65.5mm → ~773px
                } else if (labelType === '14_labels') {
                    width = Math.round(97.5 * scale);   // 97.5mm → ~1150px
                    height = Math.round(35.3 * scale);  // 35.3mm → ~416px
                } else {
                    // Fallback for unknown sheet types
                    width = 300;
                    height = 150;
                }
                
                // If rotated, swap width and height
                if (rotation === '90') {
                    [width, height] = [height, width];
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // White background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);
            
            // Draw border
            ctx.strokeStyle = 'black';
            const margin = 10;
            if (borderStyle === 'simple') {
                ctx.lineWidth = 1;
                ctx.strokeRect(margin, margin, width - margin * 2, height - margin * 2);
            } else if (borderStyle === 'thick') {
                ctx.lineWidth = 3;
                ctx.strokeRect(margin, margin, width - margin * 2, height - margin * 2);
            } else if (borderStyle === 'double') {
                ctx.lineWidth = 1;
                ctx.strokeRect(margin, margin, width - margin * 2, height - margin * 2);
                ctx.strokeRect(margin + 3, margin + 3, width - (margin + 3) * 2, height - (margin + 3) * 2);
            } else if (borderStyle === 'rounded') {
                const radius = 5;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(margin + radius, margin);
                ctx.lineTo(width - margin - radius, margin);
                ctx.quadraticCurveTo(width - margin, margin, width - margin, margin + radius);
                ctx.lineTo(width - margin, height - margin - radius);
                ctx.quadraticCurveTo(width - margin, height - margin, width - margin - radius, height - margin);
                ctx.lineTo(margin + radius, height - margin);
                ctx.quadraticCurveTo(margin, height - margin, margin, height - margin - radius);
                ctx.lineTo(margin, margin + radius);
                ctx.quadraticCurveTo(margin, margin, margin + radius, margin);
                ctx.stroke();
            } else if (borderStyle === 'dashed') {
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 3]);
                ctx.strokeRect(margin, margin, width - margin * 2, height - margin * 2);
                ctx.setLineDash([]);
            } else if (borderStyle === 'dotted') {
                ctx.lineWidth = 1;
                ctx.setLineDash([2, 2]);
                ctx.strokeRect(margin, margin, width - margin * 2, height - margin * 2);
                ctx.setLineDash([]);
            } else if (borderStyle === 'decorative') {
                ctx.lineWidth = 1;
                // Main border
                ctx.strokeRect(margin, margin, width - margin * 2, height - margin * 2);
                // Corner decorations
                const cornerSize = 15;
                ctx.lineWidth = 2;
                // Top-left corner
                ctx.beginPath();
                ctx.moveTo(margin, margin + cornerSize);
                ctx.lineTo(margin, margin);
                ctx.lineTo(margin + cornerSize, margin);
                ctx.stroke();
                // Top-right corner
                ctx.beginPath();
                ctx.moveTo(width - margin - cornerSize, margin);
                ctx.lineTo(width - margin, margin);
                ctx.lineTo(width - margin, margin + cornerSize);
                ctx.stroke();
                // Bottom-right corner
                ctx.beginPath();
                ctx.moveTo(width - margin, height - margin - cornerSize);
                ctx.lineTo(width - margin, height - margin);
                ctx.lineTo(width - margin - cornerSize, height - margin);
                ctx.stroke();
                // Bottom-left corner
                ctx.beginPath();
                ctx.moveTo(margin + cornerSize, height - margin);
                ctx.lineTo(margin, height - margin);
                ctx.lineTo(margin, height - margin - cornerSize);
                ctx.stroke();
            } else if (borderStyle === 'shadow') {
                ctx.lineWidth = 1;
                // Shadow effect
                ctx.strokeStyle = '#ccc';
                ctx.strokeRect(margin + 2, margin + 2, width - margin * 2, height - margin * 2);
                ctx.strokeStyle = '#999';
                ctx.strokeRect(margin + 1, margin + 1, width - margin * 2, height - margin * 2);
                // Main border
                ctx.strokeStyle = 'black';
                ctx.strokeRect(margin, margin, width - margin * 2, height - margin * 2);
            }
            
            // Helper function to wrap text
            function wrapText(context, text, x, y, maxWidth, lineHeight) {
                const words = text.split(' ');
                let line = '';
                let lines = [];
                
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n] + ' ';
                    const metrics = context.measureText(testLine);
                    const testWidth = metrics.width;
                    
                    if (testWidth > maxWidth && n > 0) {
                        lines.push(line);
                        line = words[n] + ' ';
                    } else {
                        line = testLine;
                    }
                }
                lines.push(line);
                
                // Draw all lines
                for (let i = 0; i < lines.length; i++) {
                    context.fillText(lines[i], x, y + (i * lineHeight));
                }
                
                return lines.length * lineHeight; // Return total height used
            }
            
            // Calculate available text width and starting position (considering QR code and logo positions)
            // New approach: Only adjust text if elements actually overlap with text area
            let textMaxWidth = width - (margin * 2) - 10;
            let textStartX = margin + 5;
            let textStartY = margin + 5;
            let qrX = 0, qrY = 0, qrPixels = 0;
            let logoX = 0, logoY = 0, logoPixels = 0;
            
            // Pre-calculate QR position and size if enabled
            if (includeQr) {
                const qrSizes = { 'small': 50, 'medium': 70, 'large': 90 };
                qrPixels = Math.min(qrSizes[qrSize] || 70, Math.min(height * 0.5, width * 0.3));
                
                // Calculate QR position
                switch(qrPosition) {
                    case 'left':
                        qrX = margin + 5;
                        qrY = margin + ((height - margin * 2 - qrPixels) / 2);
                        break;
                    case 'top-left':
                        qrX = margin + 5;
                        qrY = margin + 5;
                        break;
                    case 'top-right':
                        qrX = width - qrPixels - margin - 5;
                        qrY = margin + 5;
                        break;
                    case 'bottom-right':
                        qrX = width - qrPixels - margin - 5;
                        qrY = height - qrPixels - margin - 5;
                        break;
                    case 'bottom-left':
                        qrX = margin + 5;
                        qrY = height - qrPixels - margin - 5;
                        break;
                    case 'center-right':
                    case 'right':
                    default:
                        qrX = width - qrPixels - margin - 5;
                        qrY = margin + ((height - margin * 2 - qrPixels) / 2);
                        break;
                }
            }
            
            // Pre-calculate logo position and size if enabled
            if (includeLogo) {
                logoPixels = Math.min(60, Math.min(height * 0.3, width * 0.2));
                
                // Calculate logo position
                switch(logoPosition) {
                    case 'top-left':
                        logoX = margin + 5;
                        logoY = margin + 5;
                        break;
                    case 'top-right':
                        logoX = width - logoPixels - margin - 5;
                        logoY = margin + 5;
                        break;
                    case 'left':
                        logoX = margin + 5;
                        logoY = margin + ((height - margin * 2 - logoPixels) / 2);
                        break;
                    case 'bottom-left':
                    default:
                        logoX = margin + 5;
                        logoY = height - logoPixels - margin - 5;
                        break;
                }
            }
            
            // Smart text area adjustment - only adjust if elements overlap with text area
            // Text area is roughly: top 60% of label, left to right with margins
            const textAreaTop = margin + 5;
            const textAreaBottom = height - margin - 30; // Leave room for date at bottom
            const textAreaLeft = margin + 5;
            const textAreaRight = width - margin - 5;
            
            // Check if QR overlaps with LEFT side of text area
            if (includeQr) {
                const qrRight = qrX + qrPixels;
                const qrBottom = qrY + qrPixels;
                
                // QR on left side overlapping text area
                if (qrX < textAreaLeft + 50 && qrY < textAreaBottom && qrBottom > textAreaTop) {
                    textStartX = Math.max(textStartX, qrRight + 10);
                    textMaxWidth = width - textStartX - margin - 5;
                }
                
                // QR on right side overlapping text area
                if (qrRight > textAreaRight - 50 && qrY < textAreaBottom && qrBottom > textAreaTop) {
                    textMaxWidth = qrX - textStartX - 10;
                }
            }
            
            // Check if logo overlaps with LEFT side of text area
            if (includeLogo) {
                const logoRight = logoX + logoPixels;
                const logoBottom = logoY + logoPixels;
                
                // Logo on left side overlapping text area
                if (logoX < textAreaLeft + 50 && logoY < textAreaBottom && logoBottom > textAreaTop) {
                    const logoEnd = logoRight + 10;
                    if (logoEnd > textStartX) {
                        textStartX = logoEnd;
                        textMaxWidth = width - textStartX - margin - 5;
                        
                        // If QR is also on right, further reduce width
                        if (includeQr) {
                            const qrRight = qrX + qrPixels;
                            if (qrRight > textAreaRight - 50) {
                                textMaxWidth = qrX - textStartX - 10;
                            }
                        }
                    }
                }
                
                // Logo on right side overlapping text area (rare but possible)
                if (logoRight > textAreaRight - 50 && logoY < textAreaBottom && logoBottom > textAreaTop) {
                    textMaxWidth = Math.min(textMaxWidth, logoX - textStartX - 10);
                }
            }
            
            // Draw title with wrapping
            // Scale font sizes based on label type (sheet labels are higher resolution)
            let scaledTitleFontSize, scaledBodyFontSize;
            if (labelType.startsWith('niimbot_')) {
                // Niimbot uses font sizes directly (203 DPI)
                scaledTitleFontSize = titleFontSize;
                scaledBodyFontSize = bodyFontSize;
            } else {
                // Sheet labels use 300 DPI, so scale fonts: 300/72 = 4.167
                scaledTitleFontSize = Math.round(titleFontSize * 300 / 72);
                scaledBodyFontSize = Math.round(bodyFontSize * 300 / 72);
            }
            
            ctx.fillStyle = 'black';
            ctx.font = `bold ${scaledTitleFontSize}px Arial`;
            let currentY = textStartY + scaledTitleFontSize;
            const titleHeight = wrapText(ctx, 'Sample Product Title', textStartX, currentY, textMaxWidth, scaledTitleFontSize + 4);
            currentY += titleHeight + 5;
            
            // Draw entry type and ID
            ctx.font = `${scaledBodyFontSize}px Arial`;
            ctx.fillStyle = '#555';
            const entryHeight = wrapText(ctx, 'Entry #123 - Type: Product', textStartX, currentY, textMaxWidth, scaledBodyFontSize + 4);
            currentY += entryHeight + 3;
            
            // Draw description with wrapping
            ctx.fillStyle = '#666';
            const descHeight = wrapText(ctx, 'Sample description text that wraps properly', textStartX, currentY, textMaxWidth, bodyFontSize + 4);
            currentY += descHeight + 3;
            
            // Draw logo placeholder if enabled
            if (includeLogo) {
                // Draw logo placeholder (position already calculated above)
                ctx.fillStyle = '#e8f5e9';
                ctx.fillRect(logoX, logoY, logoPixels, logoPixels);
                ctx.strokeStyle = '#4caf50';
                ctx.lineWidth = 2;
                ctx.strokeRect(logoX, logoY, logoPixels, logoPixels);
                
                ctx.fillStyle = '#4caf50';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('LOGO', logoX + logoPixels/2, logoY + logoPixels/2);
                ctx.textAlign = 'left';
            }
            
            // Draw QR code placeholder if enabled
            if (includeQr) {
                // Draw QR placeholder (position already calculated above)
                ctx.fillStyle = '#ddd';
                ctx.fillRect(qrX, qrY, qrPixels, qrPixels);
                ctx.strokeStyle = '#999';
                ctx.strokeRect(qrX, qrY, qrPixels, qrPixels);
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('QR', qrX + qrPixels/2, qrY + qrPixels/2);
                ctx.textAlign = 'left';
            }
            
            // Draw date at bottom - adaptive to logo and QR positions
            ctx.fillStyle = '#888';
            ctx.font = `${scaledBodyFontSize}px Arial`;
            
            // Default date position (bottom left)
            let dateX = margin + 5;
            let dateY = height - margin - 5;
            const dateWidth = ctx.measureText('2025-10-24').width;
            
            // Date bounds
            const dateBounds = {
                left: dateX,
                right: dateX + dateWidth,
                top: dateY - bodyFontSize,
                bottom: dateY
            };
            
            // Check if date overlaps with logo
            if (includeLogo) {
                const logoBounds = {
                    left: logoX,
                    right: logoX + logoPixels,
                    top: logoY,
                    bottom: logoY + logoPixels
                };
                
                // Check overlap
                if (!(dateBounds.right < logoBounds.left || dateBounds.left > logoBounds.right ||
                      dateBounds.bottom < logoBounds.top || dateBounds.top > logoBounds.bottom)) {
                    // Overlap detected - move date to avoid logo
                    if (logoPosition === 'bottom-left') {
                        dateX = logoX + logoPixels + 5; // Move date to right of logo
                    }
                }
            }
            
            // Check if date overlaps with QR code
            if (includeQr) {
                const qrBounds = {
                    left: qrX,
                    right: qrX + qrPixels,
                    top: qrY,
                    bottom: qrY + qrPixels
                };
                
                // Update date bounds with potentially adjusted X position
                dateBounds.left = dateX;
                dateBounds.right = dateX + dateWidth;
                
                // Check overlap
                if (!(dateBounds.right < qrBounds.left || dateBounds.left > qrBounds.right ||
                      dateBounds.bottom < qrBounds.top || dateBounds.top > qrBounds.bottom)) {
                    // Overlap detected - move date to avoid QR
                    if (qrPosition === 'bottom-left') {
                        dateX = qrX + qrPixels + 5; // Move date to right of QR
                    } else if (qrPosition === 'bottom-right') {
                        dateX = qrX - dateWidth - 5; // Move date to left of QR
                    }
                }
            }
            
            ctx.fillText('2025-10-24', dateX, dateY);
            
            // Display canvas (scale down if too large for preview area)
            container.innerHTML = '';
            const maxWidth = 500;  // Maximum preview width
            const maxHeight = 400; // Maximum preview height
            
            if (width > maxWidth || height > maxHeight) {
                // Scale down to fit
                const scale = Math.min(maxWidth / width, maxHeight / height);
                canvas.style.width = Math.round(width * scale) + 'px';
                canvas.style.height = Math.round(height * scale) + 'px';
            }
            
            container.appendChild(canvas);
            
            // Add orientation label if rotated
            if (rotation === '90') {
                const rotationLabel = document.createElement('div');
                rotationLabel.textContent = '📐 Landscape (90°)';
                rotationLabel.style.fontSize = '12px';
                rotationLabel.style.color = '#666';
                rotationLabel.style.marginTop = '10px';
                rotationLabel.style.textAlign = 'center';
                container.appendChild(rotationLabel);
            }
        }
        
        // Debounced preview update
        function schedulePreviewUpdate() {
            if (previewTimeout) {
                clearTimeout(previewTimeout);
            }
            previewTimeout = setTimeout(updateLabelPreview, 500);
        }
        
        // Add event listeners to all label settings inputs for live preview
        document.getElementById('labelFontSize').addEventListener('input', schedulePreviewUpdate);
        document.getElementById('labelTitleFontSize').addEventListener('input', schedulePreviewUpdate);
        document.getElementById('labelBorderStyle').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('labelIncludeQr').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('labelQrSize').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('labelQrPosition').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('labelIncludeLogo').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('labelLogoPosition').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('settingsLabelSize').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('settingsPrinterType').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('settingsLabelRotation').addEventListener('change', schedulePreviewUpdate);
        
        // Initial preview load
        updateLabelPreview();

        // AI Settings Form
        document.getElementById('aiSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                gemini_api_key: document.getElementById('geminiApiKey').value,
                gemini_model_name: document.getElementById('geminiModelName').value,
                gemini_base_prompt: document.getElementById('geminiBasePrompt').value
            };
            
            try {
                displayStatus('aiStatusMessage', 'Saving AI settings...', 'alert-info');
                
                const response = await fetch('/api/system_params', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save AI settings');
                
                displayStatus('aiStatusMessage', 'AI settings saved successfully!', 'alert-success');
                
                // Update AI service status after saving
                checkAiServiceStatus();
                
            } catch (error) {
                displayStatus('aiStatusMessage', 'Failed to save AI settings: ' + error.message, 'alert-danger');
            }
        });

        // Logo Upload Form
        document.getElementById('logoUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('logoFile');
            if (!fileInput.files[0]) {
                displayStatus('logoStatusMessage', 'Please select a logo file', 'alert-warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('logo', fileInput.files[0]);
            
            try {
                displayStatus('logoStatusMessage', 'Uploading logo...', 'alert-info');
                
                const response = await fetch('/api/upload_logo', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Failed to upload logo');
                
                const result = await response.json();
                displayStatus('logoStatusMessage', 'Logo uploaded successfully!', 'alert-success');
                
                // Update logo preview
                document.getElementById('logoPreviewContainer').innerHTML = 
                    `<img src="${result.logo_path}" alt="Project Logo" class="logo-preview">`;
                
                // Add remove button if it doesn't exist
                if (!document.getElementById('removeLogo')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-outline-danger ms-2';
                    removeBtn.id = 'removeLogo';
                    removeBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Remove Logo';
                    removeBtn.addEventListener('click', removeLogo);
                    
                    const submitButton = document.querySelector('#logoUploadForm button[type="submit"]');
                    if (submitButton && submitButton.parentNode) {
                        submitButton.parentNode.appendChild(removeBtn);
                    } else {
                        console.error('Could not find logo upload form submit button');
                    }
                }
                
                // Clear file input
                fileInput.value = '';
                
            } catch (error) {
                displayStatus('logoStatusMessage', 'Failed to upload logo: ' + error.message, 'alert-danger');
            }
        });

        // Remove Logo Function
        function removeLogo() {
            if (!confirm('Are you sure you want to remove the current logo?')) return;
            
            fetch('/api/system_params', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_logo_path: '' })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to remove logo');
                
                document.getElementById('logoPreviewContainer').innerHTML = 
                    `<div><i class="fas fa-image fa-3x text-muted mb-3"></i><p class="text-muted">No logo uploaded</p></div>`;
                
                const removeBtn = document.getElementById('removeLogo');
                if (removeBtn) removeBtn.remove();
                
                displayStatus('logoStatusMessage', 'Logo removed successfully!', 'alert-success');
            })
            .catch(error => {
                displayStatus('logoStatusMessage', 'Failed to remove logo: ' + error.message, 'alert-danger');
            });
        }

        // Attach remove logo event if button exists
        const removeLogoBtn = document.getElementById('removeLogo');
        if (removeLogoBtn) {
            removeLogoBtn.addEventListener('click', removeLogo);
        }

        // Overdue Settings Form
        document.getElementById('overdueSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const enabled = document.getElementById('overdueCheckEnabled').checked;
            const schedule = document.getElementById('overdueCheckSchedule').value;
            
            const formData = {
                overdue_check_enabled: enabled ? 'true' : 'false',
                overdue_check_schedule: schedule
            };
            
            try {
                displayStatus('overdueStatusMessage', 'Saving scheduled job settings...', 'alert-info');
                
                // Save settings to database
                const settingsResponse = await fetch('/api/system_params', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!settingsResponse.ok) throw new Error('Failed to save settings');
                
                // Automatically manage cron job
                const cronResponse = await fetch('/api/cron/overdue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: enabled,
                        schedule: schedule
                    })
                });
                
                const cronResult = await cronResponse.json();
                
                if (!cronResponse.ok) {
                    throw new Error('Settings saved but failed to manage scheduled job: ' + (cronResult.error || 'Unknown error'));
                }
                
                const status = enabled ? 'enabled and scheduled' : 'disabled';
                displayStatus('overdueStatusMessage', 
                    `Settings saved successfully! Overdue check job ${status} automatically.`, 
                    'alert-success');
                
                // Update the status display
                updateJobStatus(enabled, schedule, cronResult);
                
            } catch (error) {
                displayStatus('overdueStatusMessage', 'Error: ' + error.message, 'alert-danger');
            }
        });

        // Update job status display
        function updateJobStatus(enabled, schedule, cronResult = null) {
            // Find the specific overdue notification status container
            const overdueSection = document.querySelector('#overdueSettingsForm').closest('.section-card');
            const statusContainer = overdueSection.querySelector('.col-md-6:nth-child(2)');
            
            if (enabled) {
                // Show active job status
                statusContainer.innerHTML = `
                    <h5>Scheduled Job Status</h5>
                    <div class="mb-3">
                        <div class="alert alert-purple d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            <div>
                                <strong>Overdue Check: Active</strong><br>
                                <small>Schedule: ${schedule} (${getScheduleDescription(schedule)})</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>What happens automatically:</strong>
                        <ul class="small text-muted mt-2">
                            <li>System checks for entries with overdue intended end dates</li>
                            <li>High-priority notifications are created for overdue items</li>
                            <li>Only applies to entry types with "Show End Date fields" enabled</li>
                            <li>Duplicate notifications are prevented automatically</li>
                        </ul>
                    </div>
                    <div class="preview-container">
                        <div>
                            <i class="fas fa-cogs fa-3x text-purple mb-3"></i>
                            <p class="text-muted">Scheduled job is running automatically</p>
                        </div>
                    </div>
                `;
            } else {
                // Show inactive job status
                statusContainer.innerHTML = `
                    <h5>Scheduled Job Status</h5>
                    <div class="mb-3">
                        <div class="alert alert-secondary d-flex align-items-center">
                            <i class="fas fa-pause-circle me-2"></i>
                            <div>
                                <strong>Overdue Check: Inactive</strong><br>
                                <small>Enable above to start automatic checking</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>When enabled, the system will:</strong>
                        <ul class="small text-muted mt-2">
                            <li>Check for entries with overdue intended end dates</li>
                            <li>Create high-priority notifications for overdue items</li>
                            <li>Run according to your selected schedule</li>
                            <li>Apply only to entry types with end date fields enabled</li>
                        </ul>
                    </div>
                    <div class="preview-container">
                        <div>
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No scheduled jobs are currently active</p>
                        </div>
                    </div>
                `;
            }
        }

        // Get human-readable description of cron schedule
        function getScheduleDescription(schedule) {
            const scheduleMap = {
                '0 9 * * *': 'Daily at 9:00 AM',
                '0 8 * * *': 'Daily at 8:00 AM',
                '0 10 * * *': 'Daily at 10:00 AM',
                '0 0 * * *': 'Daily at midnight',
                '0 */6 * * *': 'Every 6 hours',
                '0 */3 * * *': 'Every 3 hours',
                '0 * * * *': 'Every hour',
                '0 8 * * 1-5': 'Weekdays at 8:00 AM'
            };
            return scheduleMap[schedule] || 'Custom schedule';
        }

        // Update display when schedule changes
        document.getElementById('overdueCheckSchedule').addEventListener('change', function() {
            const enabled = document.getElementById('overdueCheckEnabled').checked;
            updateJobStatus(enabled, this.value);
        });

        // Update display when enabled/disabled
        document.getElementById('overdueCheckEnabled').addEventListener('change', function() {
            const schedule = document.getElementById('overdueCheckSchedule').value;
            updateJobStatus(this.checked, schedule);
        });

        // Initialize page display
        document.addEventListener('DOMContentLoaded', function() {
            const enabled = document.getElementById('overdueCheckEnabled').checked;
            const schedule = document.getElementById('overdueCheckSchedule').value;
            updateJobStatus(enabled, schedule);
            
            // Load current cron status
            loadCurrentJobStatus();
        });

        // Load current job status from server
        async function loadCurrentJobStatus() {
            try {
                const response = await fetch('/api/cron/overdue/status');
                if (response.ok) {
                    const status = await response.json();
                    const enabled = document.getElementById('overdueCheckEnabled').checked;
                    const schedule = document.getElementById('overdueCheckSchedule').value;
                    
                    // Show warning if settings don't match actual cron job
                    if (enabled !== status.enabled) {
                        displayStatus('overdueStatusMessage', 
                            `Warning: Settings (${enabled ? 'enabled' : 'disabled'}) don't match actual job status (${status.enabled ? 'enabled' : 'disabled'}). Save settings to synchronize.`, 
                            'alert-warning');
                    }
                }
            } catch (error) {
                console.log('Could not load job status:', error.message);
            }
        }

        // Test Overdue Check Button
        document.getElementById('testOverdueCheck').addEventListener('click', async () => {
            try {
                displayStatus('overdueStatusMessage', 'Running overdue check...', 'alert-info');
                
                const response = await fetch('/api/check_overdue_end_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Failed to run overdue check');
                
                const result = await response.json();
                const message = result.notifications_created > 0 
                    ? `Overdue check completed! Created ${result.notifications_created} notification(s).`
                    : 'Overdue check completed. No overdue entries found.';
                
                displayStatus('overdueStatusMessage', message, 'alert-success');
                
            } catch (error) {
                displayStatus('overdueStatusMessage', 'Failed to run overdue check: ' + error.message, 'alert-danger');
            }
        });

        // Status message helper
        function displayStatus(elementId, message, alertClass) {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) {
                console.error(`Status element with ID '${elementId}' not found`);
                return;
            }
            statusElement.className = `alert ${alertClass}`;
            statusElement.textContent = message;
            statusElement.classList.remove('d-none');
            
            if (alertClass === 'alert-success') {
                setTimeout(() => {
                    statusElement.classList.add('d-none');
                }, 3000);
            }
        }

        // AI Service functions
        async function checkAiServiceStatus() {
            try {
                const response = await fetch('/api/ai/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('aiServiceStatus');
                if (data.available) {
                    statusElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Available</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>Not Configured</span>';
                }
            } catch (error) {
                const statusElement = document.getElementById('aiServiceStatus');
                statusElement.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Error</span>';
                console.error('Error checking AI service status:', error);
            }
        }

        async function testAiService() {
            try {
                displayStatus('aiStatusMessage', 'Testing AI connection...', 'alert-info');
                
                const response = await fetch('/api/ai/generate_description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: 'Test Entry',
                        entry_type: 'test',
                        context: 'This is a test to verify AI connectivity'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayStatus('aiStatusMessage', '✅ AI service is working correctly! Generated test description successfully.', 'alert-success');
                } else {
                    displayStatus('aiStatusMessage', '❌ AI service test failed: ' + (data.error || 'Unknown error'), 'alert-danger');
                }
                
                // Update status badge
                checkAiServiceStatus();
                
            } catch (error) {
                displayStatus('aiStatusMessage', '❌ Failed to test AI service: ' + error.message, 'alert-danger');
                console.error('Error testing AI service:', error);
            }
        }

        // Check AI service status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAiServiceStatus();
        });
    </script>
    <script src="{{ url_for('static', filename='global-theme-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>
</body>
</html>
